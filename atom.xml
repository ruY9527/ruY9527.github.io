<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>YangBao</title>
  
  
  <link href="https://ruy9527.github.io/atom.xml" rel="self"/>
  
  <link href="https://ruy9527.github.io/"/>
  <updated>2022-11-04T13:46:13.915Z</updated>
  <id>https://ruy9527.github.io/</id>
  
  <author>
    <name>YangBao</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>flinkæœ¬åœ°ç¼–è¯‘</title>
    <link href="https://ruy9527.github.io/2021/12/30/data_article/flink%E6%9C%AC%E5%9C%B0%E7%BC%96%E8%AF%91/"/>
    <id>https://ruy9527.github.io/2021/12/30/data_article/flink%E6%9C%AC%E5%9C%B0%E7%BC%96%E8%AF%91/</id>
    <published>2021-12-30T12:41:44.000Z</published>
    <updated>2022-11-04T13:46:13.915Z</updated>
    
    
    
    
    
  </entry>
  
  <entry>
    <title>æ•°æ®ç»å†(äºŒ)</title>
    <link href="https://ruy9527.github.io/2021/11/20/data_article/%E6%95%B0%E6%8D%AE%E7%BB%8F%E5%8E%86-%E4%BA%8C/"/>
    <id>https://ruy9527.github.io/2021/11/20/data_article/%E6%95%B0%E6%8D%AE%E7%BB%8F%E5%8E%86-%E4%BA%8C/</id>
    <published>2021-11-20T03:39:41.000Z</published>
    <updated>2022-11-04T13:46:13.916Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æ•°æ®å¼€å‘æµç¨‹"><a href="#æ•°æ®å¼€å‘æµç¨‹" class="headerlink" title="æ•°æ®å¼€å‘æµç¨‹"></a>æ•°æ®å¼€å‘æµç¨‹</h2><p>â€‹  å…¶å®æ•°æ®å¼€å‘ä¸­é‡è§çš„é—®é¢˜å’Œæˆ‘ä»¬åº”ç”¨å±‚é¢çš„é—®é¢˜å­˜åœ¨éƒ¨åˆ†çš„ç›¸ä¼¼ä¹‹å¤„ï¼Œä½†æ˜¯åœ¨è¿›è¡Œæ•°æ®é—®é¢˜æ’é”™çš„æ—¶å€™ï¼Œåˆå­˜åœ¨äº›è®¸çš„ä¸ç›¸ä¼¼ã€‚æ€»ä½“ä¸Šçš„æ„Ÿè§‰,å¾—å»åšè¿‡å’Œæ’æŸ¥è¿‡,è‡ªèº«æ‰èƒ½å¯¹é—®é¢˜ç†è§£åˆ°æ¯”è¾ƒæ¸…æ™°ã€‚</p><h2 id="ä»»åŠ¡è°ƒåº¦"><a href="#ä»»åŠ¡è°ƒåº¦" class="headerlink" title="ä»»åŠ¡è°ƒåº¦"></a>ä»»åŠ¡è°ƒåº¦</h2><p>â€‹ä»»åŠ¡è°ƒåº¦,è¿™ä¸ªæ˜¯æœ‰æ—¶åºçš„,ä¹Ÿæ˜¯å­˜åœ¨å…ˆåé¡ºåºçš„ã€‚ ä¸€èˆ¬æœ€æ™šçš„æ—¶é—´ç‚¹å°±æ˜¯æˆ‘ä»¬æ‹‰å–æœ€æ™šé‚£æ‰¹æ•°æ®çš„æ—¶é—´äº†ã€‚ </p><p>â€‹ç†æƒ³æƒ…å†µä¸‹(åŸºäºç¦»çº¿æ•°ä»“): æ¯”è¾ƒç†æƒ³çš„æƒ…å†µä¸‹,å°±æ˜¯æˆ‘ä»¬æœ€å¥½æ¯ä¸€å±‚çš„å¤„ç†æ—¶é—´é¢„ç®—éƒ½æ˜¯åœç•™åœ¨ä¸€ä¸ªå°æ—¶å·¦å³,ä½†æ˜¯å…·ä½“çš„æ—¶é—´é‡ç­‰æƒ…å†µï¼Œå¾—çœ‹æ•°æ®é‡å’Œå…·ä½“çš„ä¸šåŠ¡éœ€è¦äº†.</p><p>â€‹0ç‚¹1ç‚¹:  æ‰§è¡Œodsçš„æ•°æ®,å…·ä½“çš„è°ƒåº¦å‘¨æœŸå°±è·Ÿä½ ä¸šåŠ¡ä¸Šçš„æ•°æ®å˜åŒ–æˆ–è€…æ•°ä»“ä¸­çš„æ•°æ®éœ€è¦,æ¥è¿›è¡Œè°ƒåº¦å‘¨æœŸæ˜¯å¤©&#x2F;å‘¨&#x2F;æœˆç­‰æƒ…å†µçš„è°ƒåº¦å¤„ç†.</p><p>â€‹   1ç‚¹åˆ°2ç‚¹: æ‰§è¡Œdimæˆ–è€…dwdçš„æ•°æ®,è¿™ä¸ªç»„ç»‡ç»´åº¦çš„æ•°æ®,çœ‹æ˜¯å¦æœ‰å˜åŒ–çš„è°ƒæ•´(ä¸€èˆ¬å…¬å¸çš„äººå‘˜ç»„ç»‡æˆ–è€…é›†å›¢ä¸‹çš„é¢„å–,åŸå¸‚,é¡¹ç›®ä¹‹ç±»çš„ä¼šå­˜åœ¨æœ‰å˜åŒ–çš„è°ƒæ•´).</p><p>â€‹2ç‚¹åˆ°3ç‚¹:  dws å±‚çš„æ•°æ®å¤„ç†,ä¸€èˆ¬dwsçš„æ•°æ®å¯ä»¥æ˜¯ç”±dimå’Œdwdè¿›è¡Œè½»åº¦æ±‡æ€»è·å–å‡ºæ¥çš„.  å…¶å®åˆ°äº†è¿™å±‚çš„è¯,éœ€è¦çš„æŒ‡æ ‡å¯¹åº”çš„æœ€å°ç»´åº¦åŸºæœ¬å·²ç»å¯ä»¥çœ‹åˆ°æ•°æ®äº†ã€‚åªæ˜¯è¿™ä¸ªç»´åº¦çš„æ•°æ®,æ˜¯æœ€å°çš„æ—¶é—´ç»´åº¦å’Œç»„ç»‡ç»´åº¦æ±‡èšå‡ºæ¥çš„ã€‚</p><p>â€‹   3ç‚¹åˆ°4ç‚¹:  admå±‚çš„æ•°æ®æ±‡æ€»,ä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„æ•°ä»“æœ€ç»ˆç»™è¾“å‡ºå‡ºæ¥çš„å¤§å®½è¡¨æ•°æ®.</p><p>â€‹   æœ‰äº†å¤§å®½è¡¨å,çœ‹ä¸‹æ•°æ®è¿˜éœ€ä¸éœ€è¦åŒæ­¥åˆ°mmpè¿™ç±»çš„æ•°æ®åº“ä¸­,æ¥è¿›è¡Œä¸€ä¸ªé«˜æ•ˆç‡çš„æŸ¥è¯¢(æ¯”å¦‚clickhouse,driosç­‰).</p><h2 id="è¡¨çš„è®¾è®¡"><a href="#è¡¨çš„è®¾è®¡" class="headerlink" title="è¡¨çš„è®¾è®¡"></a>è¡¨çš„è®¾è®¡</h2><p>â€‹ è¡¨çš„è®¾è®¡ä¹Ÿæ˜¯å¾ˆå…³é”®çš„,ç›®å‰è™½ç„¶æˆ‘ä»¬çš„æ•°æ®è®¾è®¡æ¥æºäºä¸šåŠ¡éœ€æ±‚&#x2F;æŠ¥è¡¨éœ€æ±‚&#x2F;å•†ä¸šæŠ¥è¡¨éœ€æ±‚ç­‰åœºæ™¯,ä½†æ˜¯æ›´å¥½çš„è”ç³»èµ·å®é™…çš„è®¾è®¡ä¹Ÿå¾ˆé‡è¦çš„ã€‚</p><p>â€‹ ä¸¾ä¸ªä¾‹å­: æˆ‘ä»¬çš„ç»„ç»‡ç»´åº¦, å­˜åœ¨ ç»„ç»‡1  , ç»„ç»‡2 ï¼Œ ç»„ç»‡3 (è¿™ä¸‰è€…çš„å…³ç³»å°±æ˜¯æˆ‘ä»¬å¹³å¸¸çœ‹åˆ°çš„æ ‘çš„æ¦‚å¿µ,1æ˜¯2çš„ä¸Šçº§,2æ˜¯3çš„ä¸Šçº§),åŒæ—¶è¿˜å­˜åœ¨æ—¶é—´ç»´åº¦çš„(æœˆ,å­£åº¦,å¹´).  æ­¤æ—¶,æ¢³ç†å®ŒæŒ‡æ ‡çš„è®¡ç®—å£å¾„,æˆ‘ä»¬å‘ç°,1çš„æ•°æ®ç”±2æ±‡èš,2çš„æ•°æ®ç”±3è¿›è¡Œæ±‡èš, å¹´ç”±æœˆæ±‡èš,å­£åº¦ä¹Ÿæ˜¯æœˆæ±‡èšå‡ºæ¥çš„, äºæ˜¯æˆ‘ä»¬è®¾è®¡dwsæˆ–è€…admæœ€åæ±‡æ€»çš„è¡¨æ ·æ—¶å€™,å¯ä»¥å†—ä½™ ç»„ç»‡2å’Œç»„ç»‡1å¯¹åº”åˆ°ç»„ç»‡3,æ—¶é—´ç»´åº¦å†—ä½™æœ€å°çš„æœˆä»½ï¼Œäºæ˜¯åœ¨ç»„ç»‡è¿™ä¸ªç»´åº¦å°±å¯ä»¥æ¸…æ™°çš„çœ‹åˆ°ï¼Œæ ¹æ®ç»„ç»‡1å’Œç»„ç»‡2è¿›è¡Œsumå’Œgroupçš„æ—¶å€™,å°±è·å–åˆå¯¹åº”ç»„ç»‡çš„å€¼äº†(å†—ä½™ç»„ç»‡çš„å…³ç³»,èšåˆçš„æ—¶å€™å°±å¯ä»¥å‡å°‘å»éœ€è¦ä¸Šä¸‹çº§ä¹‹é—´çš„å…³ç³»äº†). </p><p>â€‹     å‰ç½®æ¡ä»¶:  æ•°æ®æ±‡èšçš„è®¡ç®—å£å¾„å¾—æ¸…æ™°å’Œæ˜ç™½,æ–¹æ¡ˆå¹¶ä¸èƒ½é€‚åº”æ‰€æœ‰çš„åœºæ™¯. æ¯”å¦‚è¿™é‡Œçš„ç»„ç»‡å¾—æ˜ç¡®æœ€å¤šå¤šå°‘å±‚,ä¸€èˆ¬ä¸€ä¸ªé›†å›¢æˆ–è€…ä¸€ä¸ªå…¬å¸,ä¸ä¼šå‡ºç°å¾ˆå¤šçº§å¾—æ¦‚å¿µ.</p><h2 id="æ•°æ®é‡å¤"><a href="#æ•°æ®é‡å¤" class="headerlink" title="æ•°æ®é‡å¤"></a>æ•°æ®é‡å¤</h2><p>â€‹æ•°æ®é‡å¤è¿™ä¸ªé—®é¢˜ä¹Ÿæ˜¯å¾ˆå¸¸è§çš„è¯,æ¯”å¦‚ä½ æ‹‰å–è¿‡æ¥çš„ç»„ç»‡æ€ä¹ˆé‡å¤äº†å‘€?  æˆ‘è¿™ä¸ªæŒ‡æ ‡çš„å­—æ®µæ€ä¹ˆåœ¨å¸†è½¯æŠ¥è¡¨ä¸Šä¹Ÿæ˜¯é‡å¤çš„äº†å•Š? æ¯”å¦‚æœ‰æ—¶å€™æˆ‘ä»¬ä¸ºäº†å»å†—ä½™ä¸€äº›å¤šä½™çš„å­—æ®µè¿›æ¥çš„æ—¶å€™,å¹¶æ²¡æœ‰å¾ˆæ˜ç™½è¯¥å­—æ®µå¯¹åº”çš„åœºæ™¯æˆ–è€…è¯´æ˜¯ä¸šåŠ¡å˜åŒ–çš„åœºæ™¯,å¯¼è‡´é‡å¤çš„é—®é¢˜</p><p>â€‹ä¸¾ä¸ªä¾‹å­:   æ›´æ–°æ—¶é—´å­—æ®µ, æˆ‘ä»¬èšåˆsumæ•°æ®çš„æ—¶å€™,å¯èƒ½ä¼šè€ƒè™‘åˆ°å†—ä½™è¯¥å­—æ®µè¿›æ¥,äºæ˜¯å¹¶æ²¡æœ‰è€ƒè™‘åˆ°æ—¶é—´å˜åŒ–å¯èƒ½ä¼šæœ‰ä¸åŒçš„æ—¥æœŸçš„æ—¶å€™çš„åœºæ™¯,groupå°±ä¼šå‡ºç°å¤šæ¡æ•°æ®çš„æƒ…å†µ</p><p>â€‹</p><p>â€‹ä»»åŠ¡é‡è·‘å¯¼è‡´çš„æ•°æ®é‡å¤é—®é¢˜:</p><p>â€‹ ä¸€èˆ¬hiveä¸­,æˆ‘ä»¬éƒ½ä¼šå¯¹è¡¨è¿›è¡Œåˆ†åŒºä¹‹ç±»çš„æ“ä½œ. æˆ‘ä»¬åœ¨æ’å…¥æ•°æ®ä¹‹å‰,ä¼šè¦†ç›–æ•°æ®çš„. ä»€ä¹ˆæ„æ€å‘¢? å°±æ˜¯insert overwrite ä¼šåœ¨æ’å…¥ä¹‹å‰,åˆ é™¤å¯¹åº”åˆ†åŒºçš„æ•°æ®,å†è¿›è¡Œæ•°æ®çš„æ’å…¥. ä½†æ˜¯æœ‰æ—¶å€™å†™æ¼æ‰äº†æˆ–è€…jobè·‘çš„æ—¶å€™å‡ºç°åŒæ—¶å¤šè·‘çš„æƒ…å†µ,å°±æœ‰å¯èƒ½å‡ºç°æ•°æ®é‡å¤çš„é—®é¢˜</p><h2 id="å®æ—¶æ•°æ®æ¥å…¥"><a href="#å®æ—¶æ•°æ®æ¥å…¥" class="headerlink" title="å®æ—¶æ•°æ®æ¥å…¥"></a>å®æ—¶æ•°æ®æ¥å…¥</h2><p>â€‹ flink cdc : å¾…ä½¿ç”¨</p><p>â€‹         canal:   æ­£å¸¸æƒ…å†µä¸‹,æˆ‘ä»¬ä¼šä½¿ç”¨canal+kafkaæ¥è¿›è¡Œä¸ç¨‹åºçš„ç»“æ„,æ„æ€å°±æ˜¯canalå‡è£…æˆmysqlçš„é‡èŠ‚ç‚¹,è·å–mysqlçš„binlogå˜åŒ–çš„æ•°æ®,ç„¶åå†å¯¹å…¶è¿›è¡Œè§£æ,å†™å…¥åˆ°kafkaä¸­. æ•°æ®åˆ°äº†kafka,åé¢çš„ç¨‹åºè¦æ€ä¹ˆæ¶ˆè´¹å°±æ€ä¹ˆæ¶ˆè´¹.</p><p>â€‹åé¢å¾…æ›´æ–°</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>â€‹ ä¸è®ºå»åšä»€ä¹ˆé™Œç”Ÿçš„é¢†åŸŸä¹Ÿå¥½,æˆ‘ä»¬ä¸€å®šè¦æœ‰è‡ªå·±çš„ç†è§£å’Œåˆ†ææŠ€å·§.   è¦æœ‰è‡ªå·±çš„éŸ§æ€§å’Œè€å¿ƒ,å»é¢å¯¹åœ¨ä½ ä¸çŸ¥é“çš„é¢†åŸŸä¸Šçš„é—®é¢˜å’Œéš¾ç‚¹. </p><p>â€‹ ä¿æŒå†·é™çš„æ€ç»´,æ˜¯é¢å¯¹æœªçŸ¥çš„åœºæ™¯å’Œéš¾é¢˜.</p><p>â€‹         ä¿æŒå¥½å¥‡å’ŒåšæŒçš„å¿ƒæ€å’Œè¡Œä¸º,å»æŒç»­å­¦ä¹ å’Œæˆé•¿.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;æ•°æ®å¼€å‘æµç¨‹&quot;&gt;&lt;a href=&quot;#æ•°æ®å¼€å‘æµç¨‹&quot; class=&quot;headerlink&quot; title=&quot;æ•°æ®å¼€å‘æµç¨‹&quot;&gt;&lt;/a&gt;æ•°æ®å¼€å‘æµç¨‹&lt;/h2&gt;&lt;p&gt;â€‹	  å…¶å®æ•°æ®å¼€å‘ä¸­é‡è§çš„é—®é¢˜å’Œæˆ‘ä»¬åº”ç”¨å±‚é¢çš„é—®é¢˜å­˜åœ¨éƒ¨åˆ†çš„ç›¸ä¼¼ä¹‹å¤„ï¼Œä½†æ˜¯åœ¨è¿›è¡Œæ•°æ®é—®é¢˜æ’é”™çš„æ—¶å€™ï¼Œåˆå­˜åœ¨</summary>
      
    
    
    
    <category term="å¤§æ•°æ®" scheme="https://ruy9527.github.io/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
    <category term="æ•°æ®æˆé•¿" scheme="https://ruy9527.github.io/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/%E6%95%B0%E6%8D%AE%E6%88%90%E9%95%BF/"/>
    
    
    <category term="å¤§æ•°æ®" scheme="https://ruy9527.github.io/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
    <category term="æ•°æ®æˆé•¿" scheme="https://ruy9527.github.io/tags/%E6%95%B0%E6%8D%AE%E6%88%90%E9%95%BF/"/>
    
  </entry>
  
  <entry>
    <title>æ•°æ®ç»å†(ä¸€)</title>
    <link href="https://ruy9527.github.io/2021/11/12/data_article/%E6%95%B0%E6%8D%AE%E7%BB%8F%E5%8E%86-%E4%B8%80/"/>
    <id>https://ruy9527.github.io/2021/11/12/data_article/%E6%95%B0%E6%8D%AE%E7%BB%8F%E5%8E%86-%E4%B8%80/</id>
    <published>2021-11-12T05:12:18.000Z</published>
    <updated>2022-11-04T13:46:13.916Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>â€‹ åœ¨å…¬å¸çš„æ•°æ®å¹³å°ä¸Š,è¿›è¡Œä¸€äº›ç®€å•çš„æŒ‡æ ‡å¼€å‘ä¹Ÿæœ‰ä¸€æ®µæ—¶é—´äº†,å¯¹äºæ˜¯å¦æœ‰é¢„æœŸçš„æˆé•¿çš„è¿˜æ˜¯å–å†³äºä¸ªäººçš„æ¬²æœ›ä»¥åŠè¡ŒåŠ¨,ä¸æ’é™¤æˆ‘æ˜¯è¡ŒåŠ¨çš„å·¨å©´.</p><p>â€‹     ä¹Ÿç®€å•çš„è®°å½•ä¸‹è‡ªå·±è¿™æ®µæ—¶é—´çš„ä¸€äº›æ€»ç»“è¯­å½•ä»¥åŠå¦‚æœæˆ‘ä¸‹æ¬¡è¿˜åœ¨æ•°æ®æ–¹é¢çš„é¡¹ç›®ä¸Šæ€ä¹ˆå¤„ç†?</p><h2 id="éœ€æ±‚å’Œè°ƒç ”"><a href="#éœ€æ±‚å’Œè°ƒç ”" class="headerlink" title="éœ€æ±‚å’Œè°ƒç ”"></a>éœ€æ±‚å’Œè°ƒç ”</h2><p>â€‹  ç”±äºç›®å‰çš„é¡¹ç›®éƒ½æ˜¯åœ¨ä¹™æ–¹çš„åœºæ™¯,æ‰€ä»¥éœ€è¦å»ä¸ç”²æ–¹è¿›è¡Œæ²Ÿé€šäº†è§£ä»–ä»¬çš„éœ€æ±‚ä»¥åŠç³»ç»Ÿ,å¹¶ä¸”åŒæ—¶è¿˜è¦å»æ¨åŠ¨ç›¸å…³éœ€æ±‚æŒ‡æ ‡çš„è¿›åº¦ã€‚è¿™é‡Œæ¶‰åŠåˆ°çš„ä¸œè¥¿å…¶å®å¾ˆå¤šã€‚</p><p>â€‹      éœ€æ±‚ä»¥åŠè°ƒç ”:    è¿™ä¸ªé˜¶æ®µä¸€å®šè¦å¥½å¥½æ¢³ç†è¯¥å¯¹è¡Œä¸šæˆ–è€…åŒæ ·ç±»ä¼¼çš„ç³»ç»Ÿ,è¿›è¡Œæ¢³ç†ï¼Œæœ€å¥½æ˜¯èƒ½æ˜ç™½ä¸šåŠ¡åœºæ™¯ã€‚ å°±ä¸¾ä¸ªä¾‹å­: è´¢åŠ¡ç³»ç»Ÿ,è¿™æ˜¯ç›®å‰å¤§å…¬å¸éƒ½ä¼šå…·å¤‡çš„å§,é‚£æ¢ä¸ªè§’åº¦å»æ€è€ƒçš„è¯,å¦‚æœæˆ‘åªæ™“å¾—äº†è´¢åŠ¡ç³»ç»Ÿçš„è¯ï¼Œé‚£æˆ‘æ˜¯ä¸æ˜¯åœ¨æ¢³ç†ç›¸å…³åœºæ™¯æˆ–è€…ç›¸å…³æŒ‡æ ‡çš„æƒ…å†µä¸‹ï¼Œæ˜¯ä¸æ˜¯å°±è½»æ¾å¾ˆå¤šäº†å‘¢ï¼Ÿ ç„¶ååœ¨æ•´ç†éœ€æ±‚å’Œè°ƒç ”é˜¶æ®µçš„è¯ï¼Œå¯¹åº”çš„å‘ä»¥åŠå®¢æˆ·çš„ä¸šåŠ¡ç—›ç‚¹å°±ä¼šå¾ˆæ¸…æ™°å’Œæ˜ç™½äº†ã€‚</p><p>â€‹     ä¹Ÿå°±æ˜¯è¯´å¥ç›´ç™½çš„è¯:  å¯¹åº”ä¸šåŠ¡åœºæ™¯å’Œéœ€æ±‚ç—›ç‚¹,ä¸è®ºæ˜¯ä¸æ˜¯ç«™åœ¨äº§å“çš„è§’åº¦æˆ–è€…å¼€å‘çš„è§’åº¦è§†è§’ï¼Œä¸€å®šè¦å¯¹å…¶è¿›è¡Œåƒé€ï¼Œè€Œä¸èƒ½æ¨¡ç³ŠäºŒå£ï¼Œç‰¹åˆ«æ˜¯åœ¨è°ƒç ”é˜¶æ®µï¼Œå¦‚æœä½ å­˜åœ¨å¾ˆå¤šä¸šåŠ¡åœºæ™¯ä¸æ˜¯å¾ˆæ¸…æ™°çš„æƒ…å†µ,å°±ä¼šéå¸¸å®¹æ˜“å‡ºç°ä½ åœ¨æ¢³ç†éœ€æ±‚çš„æ—¶å€™,åƒä¸é€ä¸šåŠ¡ç—›ç‚¹,å¯¹åº”å®¢æˆ·éœ€è¦çš„çœŸæ˜¯ä¸œè¥¿å¾ˆéš¾æŠŠæ¡ï¼Œç”šè‡³è¯´ï¼Œä½ å¯èƒ½å°±æŠŠæ¡ä¸ä½ã€‚</p><h2 id="æŒ‡æ ‡æ¢³ç†"><a href="#æŒ‡æ ‡æ¢³ç†" class="headerlink" title="æŒ‡æ ‡æ¢³ç†"></a>æŒ‡æ ‡æ¢³ç†</h2><p>â€‹ æŒ‡æ ‡æ¢³ç†è¿™æ­¥å¾ˆå…³é”®çš„,æ ¹æ®ä½ ç›®å‰çš„éœ€æ±‚ç­‰åœºæ™¯è¿›è¡ŒæŒ‡æ ‡çš„æ¢³ç†,æ¢³ç†å‡ºæ¥çš„ç»“æœå°±æ˜¯ä½ æƒ³è¦çš„æˆ–è€…ä¸šåŠ¡æ–¹æƒ³è¦çš„.</p><p>â€‹ æŒ‡æ ‡æ¢³ç†è¿™ä¸ªæ­¥éª¤ä¸­,æˆ‘ä»¬ä¸€å®šè¦åƒé€æˆ–è€…ç†è§£é€ç›®å‰ä¸šåŠ¡æ–¹æˆ–è€…éœ€è¦æ¢³ç†çš„æŒ‡æ ‡çš„ç³»ç»Ÿé‡Œé¢çš„ä¸€å®šä¸šåŠ¡åœºæ™¯,è¿™ä¼šå…³ç³»åˆ°ä½ æ¥ä¸‹æ¥çš„å–æ•°ä»¥åŠæ•°æ®è¦æ€ä¹ˆèšåˆçš„æ“ä½œå’Œè®¾è®¡è¿™å—.</p><p>â€‹      ç»´åº¦æ¢³ç†:  æœ€åŸºæœ¬çš„ç»´åº¦æ¢³ç†,ä¹Ÿå°±æ˜¯ä¸šåŠ¡åœºæ™¯ä¸‹,éœ€è¦æ¢³ç†çš„ç»´åº¦æ˜¯æœ‰é‚£äº›åœºæ™¯çš„. æ¯”å¦‚:æ—¶é—´ç»´åº¦,æ±‡æ€»ç»´åº¦,ç»„ç»‡ç»´åº¦ç­‰.</p><p>â€‹      æ¯ç§ä¸åŒçš„ç»´åº¦,éƒ½ä¼šå¯¹ä½ çš„sqläº§ç”Ÿå¾ˆå¤§çš„å½±å“,æ¯”å¦‚ä½ çš„ç»„ç»‡ç»´åº¦æ˜¯ä¸€å±‚ä¸€å±‚çš„,é‚£ä½ åœ¨ç»„ç»‡ç»´åº¦è¿›è¡Œæ±‡æ€»çš„æ—¶å€™,ä½ æ˜¯ä¸æ˜¯è¿˜è¦è€ƒè™‘åˆ°æ—¶é—´çš„ç»´åº¦? æœˆåˆ°å­£åº¦?æœˆåˆ°å¹´ç­‰è¿™ç§æ—¶é—´ç»´åº¦çš„æ¦‚å¿µæ±‡æ€».</p><p>â€‹  åŸºäºä¸Šé¢,ä¸šåŠ¡éœ€æ±‚+æŒ‡æ ‡çš„æ¢³ç†,è¿™äº›éƒ½æ˜¨å®Œäº†çš„è¯,é‚£å…¶å®ä¸šåŠ¡è°ƒç ”å’ŒæŒ‡æ ‡æ¢³ç†è¦åšçš„äº‹æƒ…,å°±å·²ç»åšå®Œäº†ï¼Œäºæ˜¯å°±å¯ä»¥æ”¾å¼€äº†çš„å»è®¾è®¡æ¥å…¥æ•°æ®æºçš„æ—¶é—´ç»´åº¦ï¼Œsqlè¿›è¡Œæ±‡æ€»çš„é€»è¾‘æ“ä½œ.</p><p>â€‹       å…¶å®,ä½ çš„æŒ‡æ ‡æ¢³ç†åˆ°å¥½çš„è¯,ä½ å¼€å‘åçš„å·¥ä½œä¼šèˆ’æœå¾ˆå¤š</p><p>â€‹æŒ‡æ ‡æ–‡æ¡£:  è¿™é‡Œçš„è°ƒç ”,å¯¹åº”è¦è¾“å‡ºå‡ºæ¥çš„,ä½ æ¯ä¸ªæŒ‡æ ‡å¯¹åº”çš„æ—¶é—´ç»´åº¦æˆ–è€…æ˜¯å…¶ä»–çš„ç»´åº¦,åŒæ—¶ä¹Ÿè¦ä¸€å¹¶è¾“å‡ºå‡ºæ¥çš„æ˜¯:ä¸šåŠ¡å£å¾„å’Œè®¡ç®—å£å¾„</p><h2 id="æ•°æ®æ ¸ç®—-amp-æ•°æ®å­—å…¸è¾“å‡º"><a href="#æ•°æ®æ ¸ç®—-amp-æ•°æ®å­—å…¸è¾“å‡º" class="headerlink" title="æ•°æ®æ ¸ç®— &amp; æ•°æ®å­—å…¸è¾“å‡º"></a>æ•°æ®æ ¸ç®— &amp; æ•°æ®å­—å…¸è¾“å‡º</h2><p>â€‹ å†æ ¹æ®éœ€æ±‚æˆ–è€…ä¸šåŠ¡æ–¹æä¾›äº†ç›¸åº”çš„æŒ‡æ ‡ä¹‹å,é‚£ä¹ˆæˆ‘ä»¬ç´§æ¥ç€è¦å»åšçš„äº‹æƒ…å°±æ˜¯,é€šè¿‡æ•°æ®æºå»æŸ¥çœ‹,å»æŸ¥çœ‹æ•°æ®ä¹‹ç±»çš„ä¸œè¥¿æ˜¯å¦ç¬¦åˆé¢„æœŸã€‚ æ¯”å¦‚è´¢åŠ¡æŒ‡æ ‡:  ä¸åŒçš„è®°è´¦ç§‘ç›®ç¼–ç ,é‚£ä½ å°±è¦å»æ¢³ç†ä¸‹æ˜¯å¦æœ‰ç§‘ç›®ç¼–ç è¿™ä¸ªå­—å…¸è¡¨ã€‚</p><p>â€‹      ç„¶åä½ åœ¨æ ¸ç®—æ•°æ®çš„åŒæ—¶ï¼Œè¿˜è¦å»è¾“å‡ºä¸€ä¸ªæ¯”è¾ƒå…³é”®çš„æ–‡æ¡£.</p><p>â€‹ æ•°æ®å­—æ®µæ–‡æ¡£:   è¿™ä¸ªæ•°æ®å­—æ®µæ–‡æ¡£çš„è¯,å…¶å®å°±æ˜¯å·²ç»è®¾è®¡åˆ°æ•°ä»“æ–¹é¢çš„æ•°æ®ã€‚</p><p>â€‹ods &#x2F; dwd &#x2F; dws &#x2F; dim &#x2F; adm</p><p>â€‹    è®¾è®¡åˆ°è¿™äº”å±‚çš„æ•°ä»“å»ºæ¨¡çš„å­—å…¸è¡¨çš„è¾“å‡º,æ¯ä¸€å±‚çš„è¡¨æ€ä¹ˆæ¥å…¥,å…¨é‡è¿˜æ˜¯å¢é‡? è§¦å‘æ—¶é—´æ˜¯ä»€ä¹ˆæ—¶å€™(ä¹Ÿå°±æ˜¯è°ƒåº¦å‘¨æœŸ)ï¼Ÿå¦‚æœæ˜¯å¢é‡çš„è¯,ä¾èµ–çš„å¢é‡å­—æ®µæ˜¯ä»€ä¹ˆï¼Ÿè¿˜æ˜¯åˆ©ç”¨ç±»ä¼¼flink cdcè¿™ç±»çš„æ¡†æ¶æ¥è¿›è¡Œå®æ—¶æ•°æ®çš„æ¥å…¥?</p><p>â€‹è¿™ä¸ªæ–‡æ¡£è¾“å‡ºå,è¿˜è¦ä¸å®¢æˆ·è¿›è¡Œç¡®è®¤. </p><h2 id="å¼€å‘æ³¨æ„ç‚¹"><a href="#å¼€å‘æ³¨æ„ç‚¹" class="headerlink" title="å¼€å‘æ³¨æ„ç‚¹"></a>å¼€å‘æ³¨æ„ç‚¹</h2><p>â€‹ å…¨é‡: å¦‚æœæ•°æ®æ˜¯å…¨é‡æ¯å¤©æˆ–è€…æ¯æœˆæ‹‰å…¥è¿›æ¥çš„è¯,è¦æ¶‰åŠè€ƒè™‘çš„é—®é¢˜æ˜¯æ•°æ®é‡çš„å¤§å°(é¿å…æ•°æ®é‡å¤ªå¤§å½±å“åˆ°å¯èƒ½åœ¨å‡Œæ™¨è¿è¡Œçš„job).</p><p>â€‹         ä¼ªå¢é‡:  æ˜¯å¦æœ‰å¯ä¿¡çš„æ›´æ–°å­—æ®µ,æ¥è¿›è¡Œä¼ªå¢é‡çš„è·å–. æ¯”å¦‚æ›´æ–°æ—¶é—´, æˆ‘æ¯å¤©æˆ–è€…å¤šä¹…çš„æ—¶é—´èŒƒå›´å†…,æˆ‘å°±å»æ›´æ–°æ—¶é—´æ˜¯åœ¨è¿™ä¸ªèŒƒå›´çš„æ•°æ®.</p><p>â€‹         å®æ—¶å¢é‡: ç±»ä¼¼flick cdc æˆ–è€… canclå»ç›‘å¬mysqlçš„binlogè¿™æ ·çš„åŠŸèƒ½æ¥å®ç°å®æ—¶å¢é‡çš„åŠŸèƒ½.</p><h2 id="å¼€å‘è§„èŒƒ"><a href="#å¼€å‘è§„èŒƒ" class="headerlink" title="å¼€å‘è§„èŒƒ"></a>å¼€å‘è§„èŒƒ</h2><p>â€‹è¿™ä¸ªåœ°æ–¹å…¶å®å¯¹åº”çš„å°±æ˜¯æ— è§„çŸ©ä¸æ–¹åœ†, ä¹Ÿå°±æ˜¯å¼€å‘ä¹‹å‰è¦å®šä¹‰å¥½è§„çŸ©,è¿™æ ·ä¸ä»…ä»…å¯¹ç¨‹åºå¾ˆæœ‰ç›Š,å¯¹åé¢æ¥çš„åŒäº‹æˆ–è€…éšæ—¶çœ‹ä½ ç¨‹åºçš„æ¶‰åŠç­‰æ–¹æ¡ˆçš„æ—¶å€™,ä¹Ÿæ˜¯ä¸€ç›®äº†ç„¶çš„.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;ç®€ä»‹&quot;&gt;&lt;a href=&quot;#ç®€ä»‹&quot; class=&quot;headerlink&quot; title=&quot;ç®€ä»‹&quot;&gt;&lt;/a&gt;ç®€ä»‹&lt;/h2&gt;&lt;p&gt;â€‹	 åœ¨å…¬å¸çš„æ•°æ®å¹³å°ä¸Š,è¿›è¡Œä¸€äº›ç®€å•çš„æŒ‡æ ‡å¼€å‘ä¹Ÿæœ‰ä¸€æ®µæ—¶é—´äº†,å¯¹äºæ˜¯å¦æœ‰é¢„æœŸçš„æˆé•¿çš„è¿˜æ˜¯å–å†³äºä¸ªäººçš„æ¬²æœ›ä»¥åŠè¡ŒåŠ¨,ä¸æ’é™¤æˆ‘æ˜¯è¡ŒåŠ¨çš„å·¨å©´.&lt;</summary>
      
    
    
    
    <category term="å¤§æ•°æ®" scheme="https://ruy9527.github.io/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
    <category term="æ•°æ®æˆé•¿" scheme="https://ruy9527.github.io/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/%E6%95%B0%E6%8D%AE%E6%88%90%E9%95%BF/"/>
    
    
    <category term="å¤§æ•°æ®" scheme="https://ruy9527.github.io/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
    <category term="æ•°æ®æˆé•¿" scheme="https://ruy9527.github.io/tags/%E6%95%B0%E6%8D%AE%E6%88%90%E9%95%BF/"/>
    
  </entry>
  
  <entry>
    <title>mybatisä¸springbootæ•´åˆé˜…è¯»</title>
    <link href="https://ruy9527.github.io/2021/11/04/mybatis/mybatis%E4%B8%8Espringboot%E6%95%B4%E5%90%88%E9%98%85%E8%AF%BB/"/>
    <id>https://ruy9527.github.io/2021/11/04/mybatis/mybatis%E4%B8%8Espringboot%E6%95%B4%E5%90%88%E9%98%85%E8%AF%BB/</id>
    <published>2021-11-03T16:29:43.000Z</published>
    <updated>2022-11-04T13:46:13.917Z</updated>
    
    <content type="html"><![CDATA[<h4 id="å‰æ"><a href="#å‰æ" class="headerlink" title="å‰æ"></a>å‰æ</h4><p> MyBatis ä¸ SpringBoot æ•´åˆæ“ä½œ. åœ¨è¿™æ¬¡æ•´åˆçš„è¿‡ç¨‹ä¸­,å†æ¬¡æ˜ç™½è‡ªå·±æ¯«æ— ç–‘é—®çš„æ˜¯ä¸€ä¸ªæ¯”è¾ƒæ‰‹æ®‹çš„åŒå­¦äº†.</p><p> è¿™é‡Œæˆ‘ä»¬æ˜¯åŸºäº sql è¯­å¥å†™åœ¨ xml é‡Œé¢è¿›è¡Œæ•´åˆçš„æ“ä½œ.</p><h4 id="å…¥é—¨"><a href="#å…¥é—¨" class="headerlink" title="å…¥é—¨"></a>å…¥é—¨</h4><p> è¿™é‡Œè¯´ä¸‹åˆ›å»ºä¸€ä¸ª å…¥é—¨ é¡¹ç›®çš„å¤§è‡´æµç¨‹.</p><p> å…ˆåˆ›å»ºä¸€ä¸ª SpringBoot é¡¹ç›® , å¼•å…¥ä¾èµ– : <a href="https://github.com/baoyang23/mybtatis-analysis/blob/master/mybatis-spring-boot-hello/pom.xml">https://github.com/baoyang23/mybtatis-analysis/blob/master/mybatis-spring-boot-hello/pom.xml</a></p><p> åˆ›å»º MyBatis çš„é…ç½®æ–‡ä»¶ä¿¡æ¯ : <a href="https://github.com/baoyang23/mybtatis-analysis/blob/master/mybatis-spring-boot-hello/src/main/resources/mybatis-config.xml">https://github.com/baoyang23/mybtatis-analysis/blob/master/mybatis-spring-boot-hello/src/main/resources/mybatis-config.xml</a></p><p> åˆ›å»ºæŸ¥è¯¢çš„ sql è¯­å¥ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„ mapper æ–‡ä»¶ : <a href="https://github.com/baoyang23/mybtatis-analysis/tree/master/mybatis-spring-boot-hello/src/main/resources/mapper">https://github.com/baoyang23/mybtatis-analysis/tree/master/mybatis-spring-boot-hello/src/main/resources/mapper</a></p><p> application.properties : <a href="https://github.com/baoyang23/mybtatis-analysis/blob/master/mybatis-spring-boot-hello/src/main/resources/application.properties">https://github.com/baoyang23/mybtatis-analysis/blob/master/mybatis-spring-boot-hello/src/main/resources/application.properties</a></p><p> æ‰«æ mapper æ¥å£ : @MapperScan(basePackages &#x3D; {â€œcom.iyang.mybatis.springboot.hello.mapperâ€}) <a href="https://github.com/baoyang23/mybtatis-analysis/blob/master/mybatis-spring-boot-hello/src/main/java/com/iyang/mybatis/springboot/hello/MybatisSpringBootHelloApplication.java">https://github.com/baoyang23/mybtatis-analysis/blob/master/mybatis-spring-boot-hello/src/main/java/com/iyang/mybatis/springboot/hello/MybatisSpringBootHelloApplication.java</a></p><p>è¿™é‡Œæ˜¯æ²¡æœ‰å¼•å…¥ web ä¾èµ–çš„ , ç›´æ¥å¯åŠ¨ main æ–¹æ³• , ç„¶åå°±å¯ä»¥çœ‹åˆ°æˆ‘ä»¬æŸ¥è¯¢å‡ºæ¥çš„ç»“æœäº†.</p><p>å¦‚æœä½ ç†Ÿæ‚‰ SpringBoot æºç çš„è¯ï¼Œå°±ä¼šæ™“å¾—æœ‰ä¸€ä¸ªè‡ªåŠ¨è£…é…çš„æ“ä½œ.</p><p>å¦‚æœä¸ç†Ÿæ‚‰çš„è¯ï¼Œé‚£ä¹ˆå°±åªèƒ½é€šè¿‡ @MapperScan(basePackages &#x3D; {â€œcom.iyang.mybatis.springboot.hello.mapperâ€}) å»çœ‹ , è¿™æ ·æœ‰äº›æ˜¯ä¾èµ–è‡ªåŠ¨è£…é…ï¼ˆspring.factoriesï¼‰ ä¸­çš„é…ç½®åŠ è½½çš„, æ‰€ä»¥è¿™é‡Œå»ºè®®åœ¨çœ‹ä¹‹å‰ï¼Œå¦‚æœæ˜¯æœ‰ä¸€ç‚¹ SpringBoot æ‰©å±•çš„çŸ¥è¯†äº†è§£æ˜¯å¾ˆå¥½çš„ã€‚å¦‚æœæ²¡æœ‰æ€ä¹ˆåŠå‘¢ï¼Ÿæ²¡æœ‰å°±æ¥çœ‹æˆ‘æ¥ä¸‹æ¥çš„å†…å®¹ã€‚</p><p>å…¶å®è¿™ä¸ªåœ°æ–¹ä½ ä»”ç»†æƒ³ä¸‹ï¼Œåœ¨ MyBatis ä¸ Spring æ•´åˆçš„æ—¶å€™ï¼Œé€šè¿‡ xml çš„æ–¹å¼ç»™ MyBatis çš„bean å·²ç» mybatis-spring ä¸­è‡ªå·±å†™çš„æ‰«æç±»ï¼Œæœ€åå°†æ‰«æå‡ºæ¥çš„ bd åœ¨è¿˜æ²¡åˆå§‹åŒ–ä¹‹å‰ï¼Œå°†bd çš„beanClass æ›¿æ¢ä¸ºæˆ‘ä»¬çš„ä»£ç†ç±».</p><p>é‚£ä¹ˆï¼ŒSpringBoot ä¸ MyBatis æ•´åˆçš„æ—¶å€™ï¼Œæœ€åè¦åšçš„äº‹æƒ…æ˜¯ä¸æ˜¯ä¹Ÿæ˜¯å°† MyBatis çš„ä¿¡æ¯æ³¨å…¥åˆ° SpringBoot æ¥å‘¢ï¼Ÿåªä¸è¿‡ï¼ŒSpringBoot å°±ä¸åƒ Spring ä¸€æ ·äº†ï¼Œè¿˜å°† bean çš„ä¿¡æ¯é…ç½®åˆ° xml æ–‡ä»¶ä¸­.</p><p>äºæ˜¯ï¼Œæ¥ä¸‹æ¥è·Ÿæˆ‘çš„é˜…è¯»&amp;åˆ†ææ¥ä¸€æ­¥ä¸€æ­¥çš„å¾€ä¸‹çœ‹.</p><h4 id="æ–¹æ³•åˆ†æ"><a href="#æ–¹æ³•åˆ†æ" class="headerlink" title="æ–¹æ³•åˆ†æ"></a>æ–¹æ³•åˆ†æ</h4><p> <strong>å…³æ³¨ç‚¹ä¸€</strong> : è¿™é‡Œæˆ‘ä»¬ç‚¹å…¥åˆ° org.mybatis.spring.annotation.MapperScan æ³¨è§£é‡Œé¢æ¥ï¼Œå¯ä»¥çœ‹åˆ°æœ‰ä¸€ä¸ª @Import(MapperScannerRegistrar.class) , äºæ˜¯æˆ‘ä»¬é¡ºæ‰‹è·Ÿè¿›æ¥ : org.mybatis.spring.annotation.MapperScannerRegistrar , ä»åå­—ä¸Šæ¥ï¼Œè¿™ä¸ªç±»å°±åšäº†ä¸€ä¸ªæ‰«æmapperå¹¶ä¸”å°†mapperæ³¨å…¥åˆ°Springå®¹å™¨ä¸­æ¥çš„äº‹æƒ….</p><p> <strong>å…³æ³¨ç‚¹äºŒ</strong> : æˆ‘ä»¬ä»å¼•å…¥è¿›æ¥çš„ä¾èµ–æ¥çœ‹, mybatis-spring-boot-starter-2.1.2.jar è·Ÿè¿›åˆ° è¿™ä¸ªåŒ…æ¥ï¼Œå¯ä»¥çœ‹åˆ°è¿™ä¸ªåŒ…ä¹Ÿæ˜¯å¼•å…¥ä¸€äº›è¿›æ¥. mybatis&#x2F;mybatis-spring&#x2F;spring-boot-starter-jdbc è¿™ä¸‰ä¸ªä¾èµ–æˆ‘ä»¬åº”è¯¥ä¸æ˜¯å¾ˆé™Œç”Ÿçš„ï¼Œmybatis-spring-boot-autoconfigureä¸»è¦æ¥çœ‹è¿™ä¸ªã€‚ spring.factories çš„ä½œç”¨å¤§å®¶å¯ä»¥å»äº†è§£ä¸‹ï¼ŒSpringBootå¾ˆå¤š EnableAutoConfiguration çš„é…ç½®éƒ½æ˜¯æ”¾å…¥åœ¨è¿™ä¸ªé‡Œé¢çš„ï¼Œåœ¨å¯åŠ¨çš„æ—¶å€™ï¼Œä¼šå»ä¸€å±‚ä¸€å±‚çš„å»è¯»å– spring.factories æ–‡ä»¶çš„å†…å®¹ã€‚ è¿™é‡Œæˆ‘ä»¬ä¸»è¦æ¥çœ‹ : org.mybatis.spring.boot.autoconfigure.MybatisAutoConfiguration è¿™ä¸ªç±»çš†å¯.</p><p> MyBatis åœ¨ properties ä¸­çš„é…ç½®æ–‡ä»¶è¯»å– : org.mybatis.spring.boot.autoconfigure.MybatisProperties</p><p>å¯ä»¥çœ‹åˆ°è¯¥ç±»ä¸Šæ˜¯æœ‰: @ConfigurationProperties(prefix &#x3D; MybatisProperties.MYBATIS_PREFIX)</p><p>äºæ˜¯æˆ‘ä»¬ä¸€ä¸‹å­å°±å¤šäº†äºŒä¸ªå…³æ³¨ç‚¹, è¿™é‡Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨ä¹‹å‰çš„ ç¬¨æ–¹æ³•ï¼Œ å½“ä½ å¯¹æ•´åˆæµç¨‹æ‰§è¡Œä¸æ˜¯å¾ˆç†Ÿæ‚‰çš„è¯ï¼Œå¯ä»¥åœ¨è¿™äºŒä¸ªå…³æ³¨ç‚¹çš„é‡å†™æ–¹æ³•ä¸Šéƒ½æ‰“ç®—æ–­ç‚¹ï¼Œçœ‹ä¸‹å…¶æ‰§è¡Œé¡ºåºæ˜¯æ€ä¹ˆæ‰§è¡Œçš„. å¼„æ¸…æ¥šäº†æ‰§è¡Œæµç¨‹,å°±å¯ä»¥è·Ÿç€æµç¨‹æ¥ä¸€æ­¥ä¸€æ­¥çš„åˆ†æ. ä»æˆ‘ä»¬æ‰“ä¸Š debug å¼€å§‹ï¼Œå¾€ä¸‹çš„æ‰§è¡Œæµç¨‹å°±æ˜¯ä¸€æ­¥ä¸€æ­¥æ¥çš„ï¼Œé‚£ä¹ˆå°±è·Ÿç€æˆ‘ä»¬debug çš„æ–¹æ³•æ¥ä¸€æ­¥ä¸€æ­¥çš„åˆ†æ.</p><p>org.mybatis.spring.annotation.MapperScannerRegistrar#registerBeanDefinitions() â€”&gt; org.mybatis.spring.boot.autoconfigure.MybatisAutoConfiguration#MybatisAutoConfiguration â€”&gt; org.mybatis.spring.boot.autoconfigure.MybatisAutoConfiguration#afterPropertiesSet â€”-&gt; org.mybatis.spring.boot.autoconfigure.MybatisAutoConfiguration#sqlSessionFactory â€”&gt; org.mybatis.spring.boot.autoconfigure.MybatisAutoConfiguration#sqlSessionTemplate() â€”-&gt;</p><p><strong>org.mybatis.spring.annotation.MapperScannerRegistrar#registerBeanDefinitions() æ–¹æ³•</strong> :</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * &#123;@inheritDoc&#125;</span><br><span class="line"> */</span><br><span class="line">@Override</span><br><span class="line">public void registerBeanDefinitions(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry) &#123;</span><br><span class="line">/***</span><br><span class="line">*  è¿™é‡Œæ˜¯è·å–å‡ºäº†æ³¨è§£é‡Œé¢å±æ€§çš„å€¼. </span><br><span class="line">*/   </span><br><span class="line">  AnnotationAttributes mapperScanAttrs = </span><br><span class="line">  AnnotationAttributes.fromMap(importingClassMetadata.getAnnotationAttributes(MapperScan.class.getName()));</span><br><span class="line"></span><br><span class="line">// èƒ½è·å–åˆ°æœ‰æ³¨è§£,ä¸æ˜¯null,å°±ä¼šèµ°åˆ°ä¸‹é¢çš„ä»£ç ä¸­æ¥.    </span><br><span class="line">  if (mapperScanAttrs != null) &#123;</span><br><span class="line">    registerBeanDefinitions(importingClassMetadata, mapperScanAttrs, registry,</span><br><span class="line">        generateBaseBeanName(importingClassMetadata, 0));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line">* </span><br><span class="line">*/</span><br><span class="line">  void registerBeanDefinitions(AnnotationMetadata annoMeta, AnnotationAttributes annoAttrs,</span><br><span class="line">      BeanDefinitionRegistry registry, String beanName) &#123;</span><br><span class="line"></span><br><span class="line">// åˆ©ç”¨ BeanDefinitionBuilder æ„é€ è€…,ä¼ å…¥äº†ä¸€ä¸ª MapperScannerConfigurer.class</span><br><span class="line">// è¿™é‡Œçš„ builderé‡Œé¢æ˜¯æœ‰ä¸€ä¸ª bd çš„,é‡Œé¢çš„beanClasså°±æ˜¯ MapperScannerConfigurer      </span><br><span class="line">    BeanDefinitionBuilder builder = BeanDefinitionBuilder.genericBeanDefinition(MapperScannerConfigurer.class);</span><br><span class="line">    builder.addPropertyValue(&quot;processPropertyPlaceHolders&quot;, true);</span><br><span class="line"></span><br><span class="line">// è¿™é‡Œè·å– @MapperScan æ³¨è§£çš„å±æ€§, å¦‚æœå±æ€§æ˜¯æœ‰å€¼çš„è¯,å°±ä¼šè®¾ç½®åˆ° builder ä¸­æ¥. </span><br><span class="line">    Class&lt;? extends Annotation&gt; annotationClass = annoAttrs.getClass(&quot;annotationClass&quot;);</span><br><span class="line">    if (!Annotation.class.equals(annotationClass)) &#123;</span><br><span class="line">      builder.addPropertyValue(&quot;annotationClass&quot;, annotationClass);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Class&lt;?&gt; markerInterface = annoAttrs.getClass(&quot;markerInterface&quot;);</span><br><span class="line">    if (!Class.class.equals(markerInterface)) &#123;</span><br><span class="line">      builder.addPropertyValue(&quot;markerInterface&quot;, markerInterface);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Class&lt;? extends BeanNameGenerator&gt; generatorClass = annoAttrs.getClass(&quot;nameGenerator&quot;);</span><br><span class="line">    if (!BeanNameGenerator.class.equals(generatorClass)) &#123;</span><br><span class="line">      builder.addPropertyValue(&quot;nameGenerator&quot;, BeanUtils.instantiateClass(generatorClass));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Class&lt;? extends MapperFactoryBean&gt; mapperFactoryBeanClass = annoAttrs.getClass(&quot;factoryBean&quot;);</span><br><span class="line">    if (!MapperFactoryBean.class.equals(mapperFactoryBeanClass)) &#123;</span><br><span class="line">      builder.addPropertyValue(&quot;mapperFactoryBeanClass&quot;, mapperFactoryBeanClass);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String sqlSessionTemplateRef = annoAttrs.getString(&quot;sqlSessionTemplateRef&quot;);</span><br><span class="line">    if (StringUtils.hasText(sqlSessionTemplateRef)) &#123;</span><br><span class="line">      builder.addPropertyValue(&quot;sqlSessionTemplateBeanName&quot;, annoAttrs.getString(&quot;sqlSessionTemplateRef&quot;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String sqlSessionFactoryRef = annoAttrs.getString(&quot;sqlSessionFactoryRef&quot;);</span><br><span class="line">    if (StringUtils.hasText(sqlSessionFactoryRef)) &#123;</span><br><span class="line">      builder.addPropertyValue(&quot;sqlSessionFactoryBeanName&quot;, annoAttrs.getString(&quot;sqlSessionFactoryRef&quot;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// ä¸‹é¢æ˜¯æ ¹æ® value/basePackages/basePackageClasses æ¥è·å–åŒ…çš„ä¿¡æ¯,</span><br><span class="line">// è¿™é‡Œä¹Ÿå°±è¯´, æˆ‘ä»¬å¯ä»¥è·Ÿç€è¿™ä¸‰ä¸ªå±æ€§æ¥é…ç½®åŒ…ä¿¡æ¯.      </span><br><span class="line">    List&lt;String&gt; basePackages = new ArrayList&lt;&gt;();</span><br><span class="line">    basePackages.addAll(</span><br><span class="line">        Arrays.stream(annoAttrs.getStringArray(&quot;value&quot;)).filter(StringUtils::hasText).collect(Collectors.toList()));</span><br><span class="line"></span><br><span class="line">    basePackages.addAll(Arrays.stream(annoAttrs.getStringArray(&quot;basePackages&quot;)).filter(StringUtils::hasText)</span><br><span class="line">        .collect(Collectors.toList()));</span><br><span class="line"></span><br><span class="line">    basePackages.addAll(Arrays.stream(annoAttrs.getClassArray(&quot;basePackageClasses&quot;)).map(ClassUtils::getPackageName)</span><br><span class="line">        .collect(Collectors.toList()));</span><br><span class="line"></span><br><span class="line">// å¦‚æœæ²¡æœ‰è·å–åˆ°åŒ…çš„ä¿¡æ¯,é‚£å°±æ ¹æ®æ³¨è§£æ‰€åœ¨çš„è·¯å¾„æ¥è·å–é»˜è®¤çš„è·¯å¾„.      </span><br><span class="line">    if (basePackages.isEmpty()) &#123;</span><br><span class="line">      basePackages.add(getDefaultBasePackage(annoMeta));</span><br><span class="line">    &#125;</span><br><span class="line">// å¦‚æœæœ‰lazyInitializationå±æ€§çš„å€¼,å°±è®¾ç½®åˆ° builder ä¸­æ¥. </span><br><span class="line">    String lazyInitialization = annoAttrs.getString(&quot;lazyInitialization&quot;);</span><br><span class="line">    if (StringUtils.hasText(lazyInitialization)) &#123;</span><br><span class="line">      builder.addPropertyValue(&quot;lazyInitialization&quot;, lazyInitialization);</span><br><span class="line">    &#125;</span><br><span class="line">// æ·»åŠ åŒ…çš„å±æ€§</span><br><span class="line">    builder.addPropertyValue(&quot;basePackage&quot;, StringUtils.collectionToCommaDelimitedString(basePackages));</span><br><span class="line"></span><br><span class="line">//  getBeanDefinition() åœ¨è¿”å› bd ä¹‹å‰ï¼Œä¼šèµ°ä¸€ä¸ª validate æ–¹æ³•.</span><br><span class="line">// org.springframework.beans.factory.support.DefaultListableBeanFactory#registerBeanDefinition</span><br><span class="line">// èµ°è¿™ä¸ªæ–¹æ³•æ¥å°† bd ç»™æ³¨å…¥åˆ° Spring å®¹å™¨ä¸­æ¥.</span><br><span class="line">// è¿™é‡Œæ³¨å…¥è¿›å»çš„ beanName çš„å€¼æ˜¯ :  com.iyang.mybatis.springboot.hello.MybatisSpringBootHelloApplication#MapperScannerRegistrar#0</span><br><span class="line">// æ³¨å…¥è¿›å»çš„ bd çš„ beanClass : class org.mybatis.spring.mapper.MapperScannerConfigurer </span><br><span class="line">    registry.registerBeanDefinition(beanName, builder.getBeanDefinition());</span><br><span class="line"></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p><strong>è¿™é‡Œå¯ä»¥æ€»ç»“ä¸‹ registerBeanDefinitions æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å°±æ˜¯å°† @MapperScan çš„æ³¨è§£å±æ€§çš„å€¼ç»™åˆ° : BeanDefinitionBuilder builder, è¯¥builder é‡Œé¢æœ‰bd,bdçš„beanClassæ˜¯MapperScannerConfigurerï¼Œæœ€åå°†MapperScannerConfigureræ³¨å…¥åˆ° Spring å®¹å™¨ä¸­æ¥.</strong></p><hr><p><strong>MyBatisAutoConfiguration() æœ‰å‚æ„é€ å‡½æ•°</strong></p><p>è¿™é‡Œæˆ‘ä»¬åœ¨ MybatisAutoConfiguration æ„é€ å‡½æ•°ä¸Šæ‰“ä¸Šæ–­ç‚¹, å¯ä»¥æ ¹æ® æ–­ç‚¹æ¥åˆ†æï¼Œèµ°å®ŒğŸ‘†é¢çš„æ–¹æ³•ï¼Œç„¶åæˆ‘ä»¬ç‚¹å‡»èµ°åˆ°ä¸‹ä¸€ä¸ªæ–­ç‚¹æ¥ï¼Œå°±ä¼šèµ°åˆ° è¿™ä¸ª æœ‰å‚æ„é€ å‡½æ•°.</p><p>å¦‚æœå¥½å¥‡çš„è¯ï¼Œå¯ä»¥è·Ÿè¸ªdebug çš„å †æ ˆä¿¡æ¯ï¼Œæ˜¯æ€ä¹ˆèµ°åˆ°è¿™æ­¥æ¥çš„. èµ°åˆ°è¿™ä¸ªæ–¹æ³•æ¥ : finishBeanFactoryInitialization(beanFactory) è¿™æ˜¯æœ€åˆçš„å…¥å£.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public MybatisAutoConfiguration(MybatisProperties properties, ObjectProvider&lt;Interceptor[]&gt; interceptorsProvider,</span><br><span class="line">    ObjectProvider&lt;TypeHandler[]&gt; typeHandlersProvider, ObjectProvider&lt;LanguageDriver[]&gt; languageDriversProvider,</span><br><span class="line">    ResourceLoader resourceLoader, ObjectProvider&lt;DatabaseIdProvider&gt; databaseIdProvider,</span><br><span class="line">    ObjectProvider&lt;List&lt;ConfigurationCustomizer&gt;&gt; configurationCustomizersProvider) &#123;</span><br><span class="line">// è¿™é‡Œéƒ½æ˜¯èµ‹å€¼    </span><br><span class="line">  this.properties = properties;</span><br><span class="line">  this.interceptors = interceptorsProvider.getIfAvailable();</span><br><span class="line">  this.typeHandlers = typeHandlersProvider.getIfAvailable();</span><br><span class="line">  this.languageDrivers = languageDriversProvider.getIfAvailable();</span><br><span class="line">  this.resourceLoader = resourceLoader;</span><br><span class="line">  this.databaseIdProvider = databaseIdProvider.getIfAvailable();</span><br><span class="line">  this.configurationCustomizers = configurationCustomizersProvider.getIfAvailable();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>org.mybatis.spring.boot.autoconfigure.MybatisAutoConfiguration#afterPropertiesSet()æ–¹æ³•</strong></p><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°æ˜¯å¯¹é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨è¿›è¡Œæ£€éªŒ.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void afterPropertiesSet() &#123;</span><br><span class="line">  checkConfigFileExists();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// æ£€éªŒé…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨</span><br><span class="line">  private void checkConfigFileExists() &#123;</span><br><span class="line">    if (this.properties.isCheckConfigLocation() &amp;&amp; StringUtils.hasText(this.properties.getConfigLocation())) &#123;</span><br><span class="line">      Resource resource = this.resourceLoader.getResource(this.properties.getConfigLocation());</span><br><span class="line">      Assert.state(resource.exists(),</span><br><span class="line">          &quot;Cannot find config location: &quot; + resource + &quot; (please add config file or check your Mybatis configuration)&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p><strong>org.mybatis.spring.boot.autoconfigure.MybatisAutoConfiguration#sqlSessionFactory æ–¹æ³•</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">// è¿™é‡Œè¯´ä¸‹ @ConditionalOnMissingBean çš„ä½œç”¨,å½“beanä¸å­˜åœ¨çš„æ—¶å€™ï¼Œåˆ™å®ä¾‹åŒ–è¿™ä¸ªbean.</span><br><span class="line">// è¿™é‡Œä¼šä¼ å…¥ dataSource è¿›æ¥.</span><br><span class="line">@Bean</span><br><span class="line">@ConditionalOnMissingBean</span><br><span class="line">public SqlSessionFactory sqlSessionFactory(DataSource dataSource) throws Exception &#123;</span><br><span class="line">// åˆ›å»º sqlSessionBean å¯¹è±¡.    </span><br><span class="line">  SqlSessionFactoryBean factory = new SqlSessionFactoryBean();</span><br><span class="line">// è®¾ç½® dataSource &amp; SpringBootVFS.class      </span><br><span class="line">  factory.setDataSource(dataSource);</span><br><span class="line">  factory.setVfs(SpringBootVFS.class);</span><br><span class="line">// è·å–åˆ° MyBatis çš„é…ç½®æ–‡ä»¶å±æ€§,å¦‚æœæœ‰çš„è¯,å°±ä¼šè®¾ç½®åˆ° configLocationå±æ€§æ¥.    </span><br><span class="line">  if (StringUtils.hasText(this.properties.getConfigLocation())) &#123;</span><br><span class="line">    factory.setConfigLocation(this.resourceLoader.getResource(this.properties.getConfigLocation()));</span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line">// è¿™é‡Œä» properties ä¸­è·å– configuration,æ²¡æœ‰å€¼å°±ä¼šæ˜¯null.    </span><br><span class="line">  applyConfiguration(factory);</span><br><span class="line">  if (this.properties.getConfigurationProperties() != null) &#123;</span><br><span class="line">    factory.setConfigurationProperties(this.properties.getConfigurationProperties());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">// å¦‚æœæœ‰æ’ä»¶,å°±ä¼šè®¾ç½®æ’ä»¶.    </span><br><span class="line">  if (!ObjectUtils.isEmpty(this.interceptors)) &#123;</span><br><span class="line">    factory.setPlugins(this.interceptors);</span><br><span class="line">  &#125;</span><br><span class="line">  if (this.databaseIdProvider != null) &#123;</span><br><span class="line">    factory.setDatabaseIdProvider(this.databaseIdProvider);</span><br><span class="line">  &#125;</span><br><span class="line">// åŒ…çš„ååˆ«è®¾ç½®    </span><br><span class="line">  if (StringUtils.hasLength(this.properties.getTypeAliasesPackage())) &#123;</span><br><span class="line">    factory.setTypeAliasesPackage(this.properties.getTypeAliasesPackage());</span><br><span class="line">  &#125;</span><br><span class="line">  if (this.properties.getTypeAliasesSuperType() != null) &#123;</span><br><span class="line">    factory.setTypeAliasesSuperType(this.properties.getTypeAliasesSuperType());</span><br><span class="line">  &#125;</span><br><span class="line">  if (StringUtils.hasLength(this.properties.getTypeHandlersPackage())) &#123;</span><br><span class="line">    factory.setTypeHandlersPackage(this.properties.getTypeHandlersPackage());</span><br><span class="line">  &#125;</span><br><span class="line">  if (!ObjectUtils.isEmpty(this.typeHandlers)) &#123;</span><br><span class="line">    factory.setTypeHandlers(this.typeHandlers);</span><br><span class="line">  &#125;</span><br><span class="line">  if (!ObjectUtils.isEmpty(this.properties.resolveMapperLocations())) &#123;</span><br><span class="line">    factory.setMapperLocations(this.properties.resolveMapperLocations());</span><br><span class="line">  &#125;</span><br><span class="line">// è¿™é‡Œéƒ½æ˜¯é…ç½®å±æ€§çš„è®¾ç½®.    </span><br><span class="line"></span><br><span class="line">// è·å– propert å­—æ®µå±æ€§çš„åå­—.    </span><br><span class="line">  Set&lt;String&gt; factoryPropertyNames = Stream</span><br><span class="line">      .of(new BeanWrapperImpl(SqlSessionFactoryBean.class).getPropertyDescriptors()).map(PropertyDescriptor::getName)</span><br><span class="line">      .collect(Collectors.toSet());</span><br><span class="line">  Class&lt;? extends LanguageDriver&gt; defaultLanguageDriver = this.properties.getDefaultScriptingLanguageDriver();</span><br><span class="line">  if (factoryPropertyNames.contains(&quot;scriptingLanguageDrivers&quot;) &amp;&amp; !ObjectUtils.isEmpty(this.languageDrivers)) &#123;</span><br><span class="line">    // Need to mybatis-spring 2.0.2+</span><br><span class="line">    factory.setScriptingLanguageDrivers(this.languageDrivers);</span><br><span class="line">    if (defaultLanguageDriver == null &amp;&amp; this.languageDrivers.length == 1) &#123;</span><br><span class="line">      defaultLanguageDriver = this.languageDrivers[0].getClass();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">// è®¾ç½®é»˜è®¤çš„è„šæœ¬è¯­è¨€è§£æå™¨. è¿™é‡Œæ²¡æœ‰,è®¾ç½®çš„æ˜¯é»˜è®¤çš„null.    </span><br><span class="line">  if (factoryPropertyNames.contains(&quot;defaultScriptingLanguageDriver&quot;)) &#123;</span><br><span class="line">    // Need to mybatis-spring 2.0.2+</span><br><span class="line">    factory.setDefaultScriptingLanguageDriver(defaultLanguageDriver);</span><br><span class="line">  &#125;</span><br><span class="line">// org.mybatis.spring.SqlSessionFactoryBean#getObject,è¿™é‡Œèµ°åˆ°äº† SqlSessionBean.</span><br><span class="line">// è¿™ä¸ªSqlSessionFactoryBeanæ˜¯åœ¨æœ‰ä¹‹å‰ mybatiså’ŒSpring æ•´åˆåˆ†ææœ‰æè¿‡åˆ°çš„,å¯ä»¥å‚è€ƒgetObjectæ–¹æ³•: https://github.com/baoyang23/mybtatis-analysis/tree/master/mybatis-spring-hello    </span><br><span class="line">// è¿™é‡Œä¼šèµ° org.mybatis.spring.SqlSessionFactoryBean#getObject çš„ afterPropertiesSet æ–¹æ³•æ¥åˆ›å»ºä¸€ä¸ª SqlSessionFactory , è¿™é‡Œè¿”å›çš„ SqlSessionFactory å°±æ³¨å…¥åˆ° Spring å®¹å™¨ä¸­æ¥.    </span><br><span class="line">  return factory.getObject();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ‰€ä»¥è¿™ä¸ªæ–¹æ³• ï¼š å…ˆæ˜¯newäº†ä¸€ä¸ªSqlSessionFactoryBeanå¯¹è±¡ï¼Œå¦‚æœä½ ä»”ç»†çœ‹çš„è¯ï¼Œä½ ä¼šå‘ç°è¿™ä¸ªå¯¹è±¡åœ¨ä¹‹å‰ mybatis-spring æ•´åˆçš„æ—¶å€™ï¼Œæˆ‘ä»¬é€šè¿‡ xml é…ç½®æ–‡ä»¶é…ç½®è¿›æ¥çš„ï¼Œå¹¶ä¸”åŒæ—¶é€šè¿‡æ ‡ç­¾ç»™èµ‹å€¼äº†datasourceç­‰ä¿¡æ¯ï¼Œ è€Œè¿™é‡Œæ˜¯é€šè¿‡ä»£ç ï¼Œifç­‰åˆ¤æ–­ï¼Œæ¥å¯¹ SqlSessionFactoryBean çš„å±æ€§è¿›è¡Œsetå€¼çš„. æœ€åä¹Ÿæ˜¯åˆ›å»ºå‡ºä¸€ä¸ª SqlSessionFactory ç»™æ³¨å…¥åˆ° Spring å®¹å™¨ä¸­æ¥.</strong></p><hr><p><strong>org.mybatis.spring.boot.autoconfigure.MybatisAutoConfiguration#sqlSessionTemplate æ–¹æ³•</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">@Bean</span><br><span class="line">@ConditionalOnMissingBean</span><br><span class="line">public SqlSessionTemplate sqlSessionTemplate(SqlSessionFactory sqlSessionFactory) &#123;</span><br><span class="line">// è¿™é‡Œæ ¹æ® executorType æ˜¯å¦æœ‰å€¼æ¥åˆ¤æ–­è¦èµ°çš„æ„é€ å‡½æ•°æ–¹æ³•.    </span><br><span class="line">  ExecutorType executorType = this.properties.getExecutorType();</span><br><span class="line">  if (executorType != null) &#123;</span><br><span class="line">    return new SqlSessionTemplate(sqlSessionFactory, executorType);</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">// è¿™é‡Œé»˜è®¤çš„è·å–æ˜¯ SIMPLE è¿™ä¸ª ExecutorType.      </span><br><span class="line">    return new SqlSessionTemplate(sqlSessionFactory);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// org.mybatis.spring.SqlSessionTemplate#SqlSessionTemplate(org.apache.ibatis.session.SqlSessionFactory, org.apache.ibatis.session.ExecutorType, org.springframework.dao.support.PersistenceExceptionTranslator),æœ€åå¯ä»¥è·Ÿè¿›åˆ°è¿™ä¸ªæ–¹æ³•ä¸­æ¥.</span><br><span class="line"></span><br><span class="line">  public SqlSessionTemplate(SqlSessionFactory sqlSessionFactory, ExecutorType executorType,</span><br><span class="line">      PersistenceExceptionTranslator exceptionTranslator) &#123;</span><br><span class="line">// å¯¹sqlSessionFactory å’Œ executorType è¿›è¡Œæ ¡éªŒ</span><br><span class="line">    notNull(sqlSessionFactory, &quot;Property &#x27;sqlSessionFactory&#x27; is required&quot;);</span><br><span class="line">    notNull(executorType, &quot;Property &#x27;executorType&#x27; is required&quot;);</span><br><span class="line"></span><br><span class="line">    this.sqlSessionFactory = sqlSessionFactory;</span><br><span class="line">    this.executorType = executorType;</span><br><span class="line">    this.exceptionTranslator = exceptionTranslator;</span><br><span class="line">// è¿™é‡Œé€šè¿‡ JDK çš„ä»£ç æ¥ç”Ÿæˆäº†ä¸€ä¸ª sqlSessionProxy ä»£ç†çš„å¯¹è±¡.      </span><br><span class="line">    this.sqlSessionProxy = (SqlSession) newProxyInstance(SqlSessionFactory.class.getClassLoader(),</span><br><span class="line">        new Class[] &#123; SqlSession.class &#125;, new SqlSessionInterceptor());</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•æ˜¯å°† SqlSessionTemplate ç»™æ³¨å…¥åˆ° Spring å®¹å™¨ä¸­å•¦.</p><h4 id="ç–‘æƒ‘ç‚¹"><a href="#ç–‘æƒ‘ç‚¹" class="headerlink" title="ç–‘æƒ‘ç‚¹"></a>ç–‘æƒ‘ç‚¹</h4><p> å¤§å®¶æœ‰æ²¡æœ‰ç–‘æƒ‘æˆ‘ä»¬å®šä¹‰çš„ mapper æ¥å£ å¥½åƒä»è¿™ä¸ªæµç¨‹åˆ†æä¸‹æ¥ï¼Œå¹¶æ²¡æœ‰æåˆ° ï¼Œé‚£ä¹ˆæ˜¯åœ¨ä¸Šé¢æ—¶å€™è¢«æ³¨å…¥åˆ° Spring å®¹å™¨ä¸­æ¥çš„å‘¢ï¼Ÿ</p><p> registerBeanDefinitions() è¿™ä¸ªæ–¹æ³• , æ³¨å…¥äº†MapperScannerConfigurer åˆ° Spring å®¹å™¨ä¸­æ¥äº†ï¼Œå¯ä»¥å›é¡¾ä¸‹ä¹‹å‰ mybatis æ•´åˆ Spring çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ˜¯é€šè¿‡ xml é…ç½®äº†è¿™ä¸ªå¯¹è±¡æ³¨å…¥åˆ° spring å®¹å™¨ä¸­æ¥çš„ã€‚ é‚£ä¹ˆæ³¨å…¥è¿›æ¥çš„,å›è°ƒåˆ° org.mybatis.spring.mapper.MapperScannerConfigurer#postProcessBeanDefinitionRegistry è¿™ä¸ªæ–¹æ³•çš„æ—¶å€™ï¼Œå°±ä¼šå°†æ‰«æå¹¶ä¸”å°†æˆ‘ä»¬çš„mapperæ¥å£æ–‡ä»¶ï¼Œç»™æ³¨å…¥åˆ° Spring å®¹å™¨ä¸­æ¥çš„. ç„¶åæ‰«æçš„åŒ…ï¼Œæ˜¯æ ¹æ®@MapperScan è§£ææ³¨è§£çš„æ—¶å€™ï¼Œæ˜¯æœ‰å¯¹æ‰«æçš„åŒ…è¿›è¡Œè§£æçš„.</p><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p> å…¶å® SpringBoot æ•´åˆ MyBatis , æˆ‘ä»¬ä»äºŒä¸ªåˆ‡å…¥ç‚¹æ¥åˆ†ææ˜¯æ€ä¹ˆæ•´åˆè¿›æ¥çš„.<br>â€‹ ä¸€æ˜¯ @MapperScan æ³¨è§£ä¸­çš„ @Import(MapperScannerRegistrar.class) å°† MapperScannerRegistrar ç»™å¯¼å…¥åˆ° Spring å®¹å™¨ä¸­æ¥, ç„¶åMapperSacnnerRegistrar æ¥è®² org.mybatis.spring.mapper.MapperScannerConfigurer ç»™æ³¨å…¥åˆ° Springä¸­æ¥ï¼Œæ›¿æ¢äº†æˆ‘ä»¬ä¹‹å‰ç”¨ Spring æ•´åˆ Mybatis çš„æ—¶å€™ï¼Œé€šè¿‡xmlé…ç½®æ–‡ä»¶æ•´åˆè¿›æ¥.</p><p> äºŒæ˜¯åˆ©ç”¨ SpringBoot æä¾›çš„ spring-boot-autoconfigure + spring.factories() æ¥ é…ç½®è‡ªåŠ¨æ³¨å…¥, è¿™é‡Œæ³¨å…¥äº† MybatisAutoConfiguration é…ç½®ç±». ç„¶åæ³¨å…¥è¿›æ¥çš„ MyBatis é…ç½®ç±»åšäº†ä»€ä¹ˆäº‹æƒ…å‘¢ï¼Ÿ å¯ä»¥çœ‹åˆ°è¿™ä¸ªç±»ä¸­æ˜¯æœ‰åš: æ³¨å…¥äº† SqlSessionFactory. SqlSessionFactory åˆæ˜¯æ€ä¹ˆæ³¨å…¥è¿›æ¥çš„å‘¢ï¼Ÿ å¯ä»¥çœ‹åˆ° org.mybatis.spring.boot.autoconfigure.MybatisAutoConfiguration#sqlSessionFactory æ–¹æ³•æ˜¯æœ‰å…ˆåˆ›å»ºä¸€ä¸ª org.mybatis.spring.SqlSessionFactoryBean çš„ï¼Œ çœ‹åˆ° SqlSessionFactoryBean è¿™ä¸ªå¯¹è±¡ï¼Œæˆ‘ä»¬å°±ä¸éš¾æƒ³èµ· Spring + Mybatis é‡Œé¢çš„ beans.xml æ˜¯å°†è¯¥å¯¹è±¡æ³¨å…¥åˆ° Spring å®¹å™¨ä¸­æ¥. è¿™é‡Œæ˜¯ç›´æ¥newçš„ï¼Œç„¶åå°†ä¸€äº›é…ç½®å±æ€§å¹¶æ»¡è¶³æ¡ä»¶,ç»™setåˆ° SqlSessionFactoryBean ä¸­æ¥ï¼Œæœ€åè°ƒç”¨ org.mybatis.spring.SqlSessionFactoryBean#getObject æ–¹æ³•æ¥è·å– SqlSessionFactory.</p><p>spring.factories æ–‡ä»¶å†…å®¹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># Auto Configure</span><br><span class="line">org.springframework.boot.autoconfigure.EnableAutoConfiguration=\</span><br><span class="line">org.mybatis.spring.boot.autoconfigure.MybatisLanguageDriverAutoConfiguration,\</span><br><span class="line">org.mybatis.spring.boot.autoconfigure.MybatisAutoConfiguration</span><br></pre></td></tr></table></figure><p>æœ€åä»å†™çš„æ¡ˆä¾‹é‡Œé¢çœ‹, MyBatis æ•´åˆ SpringBoot å…¶å®éƒ½æ˜¯åœ¨ mybatis â€”&gt; MyBatis + Spring ç­‰ä¸€æ­¥ä¸€æ­¥æ¨å¯¼ä¸Šæ¥çš„ï¼Œæ‰€ä»¥è¿™é‡Œä¸éš¾ç†è§£ï¼Œå¥½çš„æŠ€æœ¯éƒ½æ˜¯åœ¨æœ‰éœ€è¦å’Œæ—¶é—´çš„æ²‰æ·€ä¸‹ä¸€æ­¥ä¸€æ­¥æˆé•¿èµ·æ¥çš„.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;å‰æ&quot;&gt;&lt;a href=&quot;#å‰æ&quot; class=&quot;headerlink&quot; title=&quot;å‰æ&quot;&gt;&lt;/a&gt;å‰æ&lt;/h4&gt;&lt;p&gt; MyBatis ä¸ SpringBoot æ•´åˆæ“ä½œ. åœ¨è¿™æ¬¡æ•´åˆçš„è¿‡ç¨‹ä¸­,å†æ¬¡æ˜ç™½è‡ªå·±æ¯«æ— ç–‘é—®çš„æ˜¯ä¸€ä¸ªæ¯”è¾ƒæ‰‹æ®‹çš„åŒå­¦äº†.&lt;/p&gt;
&lt;p&gt; </summary>
      
    
    
    
    <category term="javaæ¡†æ¶" scheme="https://ruy9527.github.io/categories/java%E6%A1%86%E6%9E%B6/"/>
    
    <category term="mybatis" scheme="https://ruy9527.github.io/categories/java%E6%A1%86%E6%9E%B6/mybatis/"/>
    
    
    <category term="javaæ¡†æ¶" scheme="https://ruy9527.github.io/tags/java%E6%A1%86%E6%9E%B6/"/>
    
    <category term="mybatis" scheme="https://ruy9527.github.io/tags/mybatis/"/>
    
  </entry>
  
  <entry>
    <title>mybatisä¸springæ•´åˆé˜…è¯»</title>
    <link href="https://ruy9527.github.io/2021/11/04/mybatis/mybatis%E4%B8%8Espring%E6%95%B4%E5%90%88%E9%98%85%E8%AF%BB/"/>
    <id>https://ruy9527.github.io/2021/11/04/mybatis/mybatis%E4%B8%8Espring%E6%95%B4%E5%90%88%E9%98%85%E8%AF%BB/</id>
    <published>2021-11-03T16:29:31.000Z</published>
    <updated>2022-11-04T13:46:13.918Z</updated>
    
    <content type="html"><![CDATA[<h4 id="é¢˜è®°"><a href="#é¢˜è®°" class="headerlink" title="é¢˜è®°"></a>é¢˜è®°</h4><p> MyBatis ä¸ Spring æ•´åˆæ“ä½œ. åœ¨æˆ‘ä»¬å…¥é—¨å­¦ä¹  SSM ç­‰ä¸œè¥¿çš„æ—¶å€™ï¼Œå°±å‘ç°äº†ä»»ä½•ä¸œè¥¿ï¼Œæœ€åéƒ½æ˜¯é€ƒä¸è¿‡ä¸Springæ•´åˆèµ·æ¥çš„é“è·¯. ç„¶åè¿™é‡Œçœ‹å®Œ MyBatis æ•´åˆå®Œ Spring ä¹‹åï¼Œé‚£ä¹ˆä¹‹åä¸€äº›å…¶ä»–çš„ç¬¬ä¸‰æ–¹ï¼Œæ¯”å¦‚axon&#x2F;redis&#x2F;apollo&#x2F;shiro ç­‰è¿™äº›ä¸œè¥¿ï¼Œå¦‚æœè¦æ•´åˆ Spring çš„æ—¶å€™ï¼Œæ˜¯ä¸æ˜¯ä¹Ÿæ˜¯ç›¸ä¼¼çš„æ•´åˆæ–¹å¼å‘¢ï¼Ÿ</p><p> è¿™ä¸ªéœ€è¦æˆ‘ä»¬çœ‹å®Œ MyBatis ä¸ Spring ä¹‹åï¼Œæ¢ç©¶å…¶æ•´åˆçš„æ“ä½œ.</p><h4 id="å…¥é—¨"><a href="#å…¥é—¨" class="headerlink" title="å…¥é—¨"></a>å…¥é—¨</h4><p> åˆ†å‡ ä¸ªæ­¥éª¤ï¼Œæ“ä½œä¸€æŠŠå³å¯,å¸¦ä½ å›åˆ°å“ªä¸ª SM æ—¶ä»£ï¼Œä¸è¿‡è¿™å›æ˜¯æ²¡æœ‰äº† tomcat çš„.</p><p> å…ˆæ”¾ä¸Šä¸€ä¸ªå®Œæˆçš„æ•´åˆåœ°å€ : <a href="https://github.com/baoyang23/mybtatis-analysis/tree/master/mybatis-spring-hello">https://github.com/baoyang23/mybtatis-analysis/tree/master/mybatis-spring-hello</a> å¦‚æœä¸è¦çœ‹ä¸‹é¢æµç¨‹çš„,ä¸€æ­¥è·³è¿‡å³å¯.</p><ol><li>å…ˆåˆ›å»ºä¸€ä¸ª maven é¡¹ç›®ï¼Œå¼•å…¥ä¾èµ–. ä¾èµ–å‚è€ƒåœ°å€ : <a href="https://github.com/baoyang23/mybtatis-analysis/blob/master/mybatis-spring-hello/pom.xml">https://github.com/baoyang23/mybtatis-analysis/blob/master/mybatis-spring-hello/pom.xml</a></li><li>dbé…ç½® : <a href="https://github.com/baoyang23/mybtatis-analysis/blob/master/mybatis-spring-hello/src/main/resources/db.properties">https://github.com/baoyang23/mybtatis-analysis/blob/master/mybatis-spring-hello/src/main/resources/db.properties</a></li><li>MyBatisé…ç½®: <a href="https://github.com/baoyang23/mybtatis-analysis/tree/master/mybatis-spring-hello/src/main/resources/mybatis">https://github.com/baoyang23/mybtatis-analysis/tree/master/mybatis-spring-hello/src/main/resources/mybatis</a></li><li>Spring é…ç½®: <a href="https://github.com/baoyang23/mybtatis-analysis/blob/master/mybatis-spring-hello/src/main/resources/spring-beans.xml">https://github.com/baoyang23/mybtatis-analysis/blob/master/mybatis-spring-hello/src/main/resources/spring-beans.xml</a></li><li>æœ€å,æ¥ä»½æˆ‘ä»¬ç†Ÿæ‚‰çš„ <a href="https://github.com/baoyang23/mybtatis-analysis/tree/master/mybatis-spring-hello/src/main/resources/sql">https://github.com/baoyang23/mybtatis-analysis/tree/master/mybatis-spring-hello/src/main/resources/sql</a> mapper.xml æ–‡ä»¶.</li><li>ä¸å¿˜è®°å†æ¥ä¸€ä»½ä»£ç  : <a href="https://github.com/baoyang23/mybtatis-analysis/tree/master/mybatis-spring-hello/src">https://github.com/baoyang23/mybtatis-analysis/tree/master/mybatis-spring-hello/src</a> è¿™äº›ç›´æ¥è·‘æµ‹è¯•ç±»å³å¯.</li></ol><p>è·Ÿç€è¿™ä¸Šé¢çš„å‡ ä¸ªæ­¥éª¤ï¼Œå°±å¯ä»¥æ­å»ºå®Œä¸€ä¸ªé¡¹ç›®. ç„¶åå–Šä¸Šæˆ‘ä»¬çš„ æ°¸å“¥ï¼Œ æ‰“ä¸Šä¼ è¯´ä¸­çš„ debug , ç–¯ç‹‚çš„è°ƒè¯•çœ‹æ¯æ­¥å¹²äº†ä»€ä¹ˆäº‹.</p><p>è¿™ä¸ªçš„æ—¶å€™ï¼Œå¯ä»¥è·‘ä¸‹æµ‹è¯•ç±»ï¼Œæ˜¯okçš„.</p><h4 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h4><p> è¿™é‡Œæˆ‘ä»¬é¦–å…ˆæƒ³åˆ°çš„æ˜¯æˆ‘ä»¬å¼•å…¥çš„ä¾èµ–,æ˜¯ä¸æ˜¯æœ‰ä¸ª mybatis-spring çš„ä¾èµ–. ä»è¿™ä¸ªä¾èµ–ï¼Œå¯ä»¥å¾ˆæ˜æ˜¾çš„çœ‹å‡ºæ¥ï¼Œå°±æ˜¯é€šè¿‡è¿™ä¸ªä¾èµ–ï¼Œå°† MyBatis å’Œ Spring æ•´åˆèµ·æ¥çš„ã€‚</p><p> ç„¶åå†æƒ³æƒ³ï¼Œæˆ‘ä»¬é™¤äº†è¿™ä¸ªä¾èµ–çš„è¯ï¼Œè¿˜å†å“ªé‡Œæœ‰ä½¿ç”¨åˆ°ä¸€äº› Spring å’Œ MyBatis çš„ä¸œè¥¿å‘¢ï¼Ÿ ç„¶åçœ‹åˆ° spring-beans.xml è¿™ä¸ªxmlé…ç½®, å¯ä»¥çœ‹åˆ° org.mybatis.spring.SqlSessionFactoryBean ç»™æ³¨å…¥åˆ° bean é‡Œé¢æ¥äº†.org.mybatis.spring.mapper.MapperScannerConfigurerä¹Ÿæ˜¯ç»™æ³¨å…¥åˆ° bean é‡Œé¢æ¥äº†. å¹¶ä¸”äºŒè€…éƒ½æœ‰é€šè¿‡æ¥è¿›è¡Œå±æ€§è®¾ç½®å€¼æ“ä½œ.</p><p> é‚£ä¹ˆ,æˆ‘ä»¬å°±åŸºäºè¿™äºŒä¸ªç±»çš„æºç å¼€å§‹é˜…è¯».</p><p> <strong>SqlSessionFactoryBean (org.mybatis.spring.SqlSessionFactoryBean)</strong></p><p>è¿™é‡Œ SqlSessionFactoryBean æ˜¯å®ç°äº†å¾ˆå¤šæ¥å£,è¿™äº›æ¥å£éƒ½æ˜¯Springçš„.</p><p>FactoryBean å·¥å‚bean,ç‚¹è¿›å»å¯ä»¥çœ‹åˆ°,å…¶æœ‰æ–¹æ³•getObject()&#x2F;getObjectTypeç­‰æ–¹æ³•è·å–beançš„,ç„¶ååŠ ä¸Šæ³›å‹,ä¹Ÿå°±æ˜¯è¿™é‡Œè·å–çš„ getObjectå°±æ˜¯æ³›å‹.</p><p>InitializingBean: afterPropertiesSet åˆå§‹åŒ– bean çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨è¯¥æ–¹æ³•.</p><p>ApplicationEvent: Springçš„äº‹ä»¶ä¼ æ’­æœºåˆ¶ï¼Œå°±æ˜¯ä½¿ç”¨çš„è¿™ç§æ–¹å¼.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">/**  å¯ä»¥çœ‹åˆ°è¿™ä¸ªç±»å®ç°äº† Spring è¿™ä¸ªå¤šæ¥å£,é‚£ä¹ˆå°±æœ‰ä¸ªé—®é¢˜,å®ç°äº†è¿™ä¹ˆå¤šæ¥å£çš„æ–¹æ³•,åˆ°åº•æ˜¯å“ªä¸ªæ–¹æ³•å…ˆæ‰§è¡Œçš„å‘¢ï¼Ÿ å¦‚æœä½ å¯¹Springæºç å¾ˆç†Ÿæ‚‰çš„è¯,æ˜¯æœ‰å¯èƒ½æ¸…æ¥šçš„,ä½†æ˜¯è¿˜æ˜¯ä¼šæœ‰ç‚¹ç»•çš„. </span><br><span class="line">è¿™é‡Œæˆ‘ä»¬ç»™ getObject/afterPropertiesSet/onApplicationEventè¿™ä¸‰ä¸ªæ–¹æ³•æ‰“ä¸Šæ–­ç‚¹æ¥è¿›è¡Œdebug,</span><br><span class="line">debugæ¯èµ°çš„ä¸€æ­¥,å°±æ˜¯æ‰§è¡Œçš„å…ˆåé¡ºåºã€‚å¦‚æœä¸æ˜¯ç‰¹åˆ«ç†Ÿæ‚‰æºç çš„æ‰§è¡Œé¡ºåº,è¿™ç§ç¬¨æ–¹æ³•å…¶å®ä¹Ÿæ˜¯å¯ä»¥çš„.</span><br><span class="line">*</span><br><span class="line">* æ‰€ä»¥è¿™é‡Œdebugçš„æ‰§è¡Œé¡ºåºæ˜¯ : afterPropertiesSet --&gt; getObject  ---&gt; onApplicationEvent</span><br><span class="line">* äºæ˜¯æˆ‘ä»¬å°±è·Ÿç€è¿™ä¸ªé¡ºåºæ¥é˜…è¯».</span><br><span class="line">* æ³¨æ„åœ¨è°ƒç”¨è¿™äº›æ–¹æ³•ä¹‹å‰,&lt;property&gt;æ ‡ç­¾çš„å€¼éƒ½æ˜¯å·²ç»èµ‹å€¼è¿›æ¥äº†çš„,æ˜¯é€šè¿‡åå°„èµ°çš„set æ–¹æ³•è¿›æ¥çš„.</span><br><span class="line">*/</span><br><span class="line">public class SqlSessionFactoryBean</span><br><span class="line">    implements FactoryBean&lt;SqlSessionFactory&gt;, InitializingBean, ApplicationListener&lt;ApplicationEvent&gt; &#123;&#125;</span><br><span class="line"></span><br><span class="line">// å®ç°FactoryBean æ–¹æ³•,è¿™é‡Œæ˜¯å®ç°äº†è¯¥æ¥å£çš„ä¸‰ä¸ªæ–¹æ³•. å…¶å®è¿™é‡Œçš„ isSingleæ˜¯å¯ä»¥ä¸ç”¨å®ç°çš„</span><br><span class="line">// å› ä¸ºæ¥å£æ˜¯ç”¨ default æ¥ä¿®é¥°çš„.</span><br><span class="line">  /**</span><br><span class="line">   * è¯¥æ–¹æ³•æ˜¯åˆ¤æ–­å¹¶ä¸”å†æ¬¡ç¡®è®¤ SqlSessionFactoryæ˜¯ä¸æ˜¯æœ‰äº†. å¦‚æœæ²¡æœ‰çš„è¯,å°±ä¼šè°ƒç”¨afterPropertiesæ¥åˆå§‹åŒ–.</span><br><span class="line">   * &#123;@inheritDoc&#125;</span><br><span class="line">   */</span><br><span class="line">  @Override</span><br><span class="line">  public SqlSessionFactory getObject() throws Exception &#123;</span><br><span class="line">    if (this.sqlSessionFactory == null) &#123;</span><br><span class="line">      afterPropertiesSet();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return this.sqlSessionFactory;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public Class&lt;? extends SqlSessionFactory&gt; getObjectType() &#123;</span><br><span class="line">    return this.sqlSessionFactory == null ? SqlSessionFactory.class : this.sqlSessionFactory.getClass();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public boolean isSingleton() &#123;</span><br><span class="line">    return true;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// InitializingBean å®ç°çš„æ–¹æ³•</span><br><span class="line">  @Override</span><br><span class="line">  public void afterPropertiesSet() throws Exception &#123;</span><br><span class="line">// å…ˆå¯¹ dataSource/sqlSessionFactoryBuilderè¿›è¡Œénullçš„åˆ¤æ–­.</span><br><span class="line">    notNull(dataSource, &quot;Property &#x27;dataSource&#x27; is required&quot;);</span><br><span class="line">    notNull(sqlSessionFactoryBuilder, &quot;Property &#x27;sqlSessionFactoryBuilder&#x27; is required&quot;);</span><br><span class="line">    state((configuration == null &amp;&amp; configLocation == null) || !(configuration != null &amp;&amp; configLocation != null),</span><br><span class="line">        &quot;Property &#x27;configuration&#x27; and &#x27;configLocation&#x27; can not specified with together&quot;);</span><br><span class="line">// è¿™é‡Œæ„å»ºå‡º ä¸€ä¸ª sqlSessionFactoryå·¥å‚æ¥,æƒ³æƒ³æˆ‘ä»¬æœ€åˆå†çœ‹å•ä¸ªMyBatisé¡¹ç›®çš„æ—¶å€™,æ˜¯ä¸æ˜¯ä¹Ÿæœ‰ä¸€ä¸ªè·å–SqlSessionFactroyçš„æ–¹æ³•,ç„¶åä»sqlSessionFactoryä¼šè¯ä¸­è·å–å‡ºSqlSessionæ¥.</span><br><span class="line">    this.sqlSessionFactory = buildSqlSessionFactory();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">// ApplicationListenerå®ç°æ–¹æ³•</span><br><span class="line">  /**</span><br><span class="line">   * failFast æ—¶ture å¹¶ä¸”ä¼ è¿‡æ¥çš„ eventæ˜¯ ContextRefreshedEventçš„è¯,å°±ä¼šè¿›æ¥.</span><br><span class="line">   *  è¿™é‡Œç›®å‰éƒ½æ˜¯è°ƒç”¨getæ–¹æ³•,æ²¡æœ‰å¾ˆä»”ç»†çœ‹å‡ºå…¶ä½œç”¨.</span><br><span class="line">   * &#123;@inheritDoc&#125;</span><br><span class="line">   */</span><br><span class="line">  @Override</span><br><span class="line">  public void onApplicationEvent(ApplicationEvent event) &#123;</span><br><span class="line">    if (failFast &amp;&amp; event instanceof ContextRefreshedEvent) &#123;</span><br><span class="line">      // fail-fast -&gt; check all statements are completed</span><br><span class="line">      this.sqlSessionFactory.getConfiguration().getMappedStatementNames();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p><strong>org.mybatis.spring.SqlSessionFactoryBean#buildSqlSessionFactory</strong></p><p>è¯¥æ–¹æ³•éœ€è¦å•ç‹¬æ‹¿å‡ºæ¥è¯´ä¸‹,å› ä¸ºå†…å®¹è¿˜æ˜¯æ¯”è¾ƒå¤šçš„.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Build a &#123;@code SqlSessionFactory&#125; instance.</span><br><span class="line"> *</span><br><span class="line"> * The default implementation uses the standard MyBatis &#123;@code XMLConfigBuilder&#125; API to build a</span><br><span class="line"> * &#123;@code SqlSessionFactory&#125; instance based on a Reader. Since 1.3.0, it can be specified a &#123;@link Configuration&#125;</span><br><span class="line"> * instance directly(without config file).</span><br><span class="line"> *</span><br><span class="line"> * @return SqlSessionFactory</span><br><span class="line"> * @throws Exception</span><br><span class="line"> *           if configuration is failed</span><br><span class="line"> */</span><br><span class="line">protected SqlSessionFactory buildSqlSessionFactory() throws Exception &#123;</span><br><span class="line"></span><br><span class="line">  final Configuration targetConfiguration;</span><br><span class="line"></span><br><span class="line">  XMLConfigBuilder xmlConfigBuilder = null;</span><br><span class="line">    </span><br><span class="line"> // è¿™é‡Œåˆ†ä¸ºconfiguration/ configLocation / éå‰äºŒè€…(å¯ä»¥ç†è§£ä¸ºé»˜è®¤çš„).</span><br><span class="line"> // ä¸‰ç§å¤„ç†æ–¹å¼.   </span><br><span class="line">  if (this.configuration != null) &#123;</span><br><span class="line">    targetConfiguration = this.configuration;</span><br><span class="line">    if (targetConfiguration.getVariables() == null) &#123;</span><br><span class="line">      targetConfiguration.setVariables(this.configurationProperties);</span><br><span class="line">    &#125; else if (this.configurationProperties != null) &#123;</span><br><span class="line">      targetConfiguration.getVariables().putAll(this.configurationProperties);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; else if (this.configLocation != null) &#123;</span><br><span class="line">// è¿™é‡Œå°±æ˜¯æˆ‘ä»¬é…ç½®çš„æƒ…å†µ </span><br><span class="line">// org.apache.ibatis.builder.xml.XMLConfigBuilder#XMLConfigBuilder(java.io.InputStream, java.lang.String, java.util.Properties),å¯ä»¥çœ‹åˆ°è¿™ä¸ªç†Ÿæ‚‰çš„æ“ä½œ,ä¹Ÿå°±æ˜¯æˆ‘ä»¬å•ä¸ªè§£æ MyBatisçš„æ—¶å€™æœ‰è¿›è¡Œåˆ†æè¿‡çš„.      </span><br><span class="line">    xmlConfigBuilder = new XMLConfigBuilder(this.configLocation.getInputStream(), null, this.configurationProperties);</span><br><span class="line">// è·å–å‡º configuration é…ç½®ä¿¡æ¯.      </span><br><span class="line">    targetConfiguration = xmlConfigBuilder.getConfiguration();</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    LOGGER.debug(</span><br><span class="line">        () -&gt; &quot;Property &#x27;configuration&#x27; or &#x27;configLocation&#x27; not specified, using default MyBatis Configuration&quot;);</span><br><span class="line">    targetConfiguration = new Configuration();</span><br><span class="line">    Optional.ofNullable(this.configurationProperties).ifPresent(targetConfiguration::setVariables);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// è¿™é‡Œé‡‡ç”¨ Optional,å¦‚æœobjectFactoryä¸æ˜¯nullçš„è¯,å°±ä¼šè°ƒç”¨targetConfigurationçš„ setObjectFactoryæ–¹æ³•.ä¸‹é¢è¿™äºŒä¸ªæ˜¯åŒç†.</span><br><span class="line">  Optional.ofNullable(this.objectFactory).ifPresent(targetConfiguration::setObjectFactory);</span><br><span class="line">  Optional.ofNullable(this.objectWrapperFactory).ifPresent(targetConfiguration::setObjectWrapperFactory);</span><br><span class="line">  Optional.ofNullable(this.vfs).ifPresent(targetConfiguration::setVfsImpl);</span><br><span class="line"></span><br><span class="line">// è¿™é‡Œå¦‚æœæœ‰é…ç½®typeAliasesPackageè¿™ä¸ªå‚æ•°çš„è¯,å°±ä¼šå¯¹è¯¥åŒ…ä¸‹è¿›è¡Œæ‰«æ,è¿›è¡Œä¸€ç³»åˆ—çš„è¿‡æ»¤,</span><br><span class="line">// å¦‚æœéƒ½æ»¡è¶³æ¡ä»¶çš„è¯,targetConfiguration.getTypeAliasRegistry()::registerAliaså°±ä¼šæ³¨å†Œåˆ°è¿™é‡Œ. </span><br><span class="line">  if (hasLength(this.typeAliasesPackage)) &#123;</span><br><span class="line">    scanClasses(this.typeAliasesPackage, this.typeAliasesSuperType).stream()</span><br><span class="line">        .filter(clazz -&gt; !clazz.isAnonymousClass()).filter(clazz -&gt; !clazz.isInterface())</span><br><span class="line">        .filter(clazz -&gt; !clazz.isMemberClass()).forEach(targetConfiguration.getTypeAliasRegistry()::registerAlias);</span><br><span class="line">  &#125;</span><br><span class="line">// æ˜¯å¦æœ‰typeAliasesè¿™ä¸ªå‚æ•°,å¦‚æœæœ‰çš„è¯,ä¹Ÿæ˜¯å¯ä»¥çœ‹åˆ°æ˜¯æ³¨å†Œåˆ°ä¸Šé¢å“ªä¸€æ­¥çš„é‡Œé¢æ¥.</span><br><span class="line">  if (!isEmpty(this.typeAliases)) &#123;</span><br><span class="line">    Stream.of(this.typeAliases).forEach(typeAlias -&gt; &#123;</span><br><span class="line">      targetConfiguration.getTypeAliasRegistry().registerAlias(typeAlias);</span><br><span class="line">      LOGGER.debug(() -&gt; &quot;Registered type alias: &#x27;&quot; + typeAlias + &quot;&#x27;&quot;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">//åˆ¤æ–­æ˜¯å¦æœ‰æ’ä»¶,å¦‚æœæœ‰æ’ä»¶çš„è¯,ä¹Ÿä¼šæ·»åŠ åˆ°configurationä¸­æ¥.    </span><br><span class="line">  if (!isEmpty(this.plugins)) &#123;</span><br><span class="line">    Stream.of(this.plugins).forEach(plugin -&gt; &#123;</span><br><span class="line">      targetConfiguration.addInterceptor(plugin);</span><br><span class="line">      LOGGER.debug(() -&gt; &quot;Registered plugin: &#x27;&quot; + plugin + &quot;&#x27;&quot;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (hasLength(this.typeHandlersPackage)) &#123;</span><br><span class="line">    scanClasses(this.typeHandlersPackage, TypeHandler.class).stream().filter(clazz -&gt; !clazz.isAnonymousClass())</span><br><span class="line">        .filter(clazz -&gt; !clazz.isInterface()).filter(clazz -&gt; !Modifier.isAbstract(clazz.getModifiers()))</span><br><span class="line">        .forEach(targetConfiguration.getTypeHandlerRegistry()::register);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (!isEmpty(this.typeHandlers)) &#123;</span><br><span class="line">    Stream.of(this.typeHandlers).forEach(typeHandler -&gt; &#123;</span><br><span class="line">      targetConfiguration.getTypeHandlerRegistry().register(typeHandler);</span><br><span class="line">      LOGGER.debug(() -&gt; &quot;Registered type handler: &#x27;&quot; + typeHandler + &quot;&#x27;&quot;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  targetConfiguration.setDefaultEnumTypeHandler(defaultEnumTypeHandler);</span><br><span class="line"></span><br><span class="line">  if (!isEmpty(this.scriptingLanguageDrivers)) &#123;</span><br><span class="line">    Stream.of(this.scriptingLanguageDrivers).forEach(languageDriver -&gt; &#123;</span><br><span class="line">      targetConfiguration.getLanguageRegistry().register(languageDriver);</span><br><span class="line">      LOGGER.debug(() -&gt; &quot;Registered scripting language driver: &#x27;&quot; + languageDriver + &quot;&#x27;&quot;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  Optional.ofNullable(this.defaultScriptingLanguageDriver)</span><br><span class="line">      .ifPresent(targetConfiguration::setDefaultScriptingLanguage);</span><br><span class="line"></span><br><span class="line">  if (this.databaseIdProvider != null) &#123;// fix #64 set databaseId before parse mapper xmls</span><br><span class="line">    try &#123;</span><br><span class="line">      targetConfiguration.setDatabaseId(this.databaseIdProvider.getDatabaseId(this.dataSource));</span><br><span class="line">    &#125; catch (SQLException e) &#123;</span><br><span class="line">      throw new NestedIOException(&quot;Failed getting a databaseId&quot;, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Optional.ofNullable(this.cache).ifPresent(targetConfiguration::addCache);</span><br><span class="line">// è¿™è¿™ä¹‹å‰,éƒ½æ˜¯å¯¹ä¸€äº›é…ç½®ä¿¡æ¯çš„è¯»å–,å¦‚æœæœ‰çš„è¯,å°±ä¼šè¿›è¡Œç›¸åº”çš„èµ‹å€¼ä¹‹ç±»çš„æ“ä½œ.</span><br><span class="line">    </span><br><span class="line">  if (xmlConfigBuilder != null) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">// æœ€åè¿™é‡Œçš„ parse è§£ææ–¹æ³•,æ˜¯å’Œå•ä¸ª Mybatisçš„è§£è¯»æ˜¯ä¸€æ ·çš„.        </span><br><span class="line">      xmlConfigBuilder.parse();</span><br><span class="line">      LOGGER.debug(() -&gt; &quot;Parsed configuration file: &#x27;&quot; + this.configLocation + &quot;&#x27;&quot;);</span><br><span class="line">    &#125; catch (Exception ex) &#123;</span><br><span class="line">      throw new NestedIOException(&quot;Failed to parse config resource: &quot; + this.configLocation, ex);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">      ErrorContext.instance().reset();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">//è¿™é‡Œå¯ä»¥çœ‹äº‹åŠ¡å·¥å‚,æ˜¯ä½¿ç”¨äº†mybatis-springåŒ…ä¸‹çš„.</span><br><span class="line">  targetConfiguration.setEnvironment(new Environment(this.environment,</span><br><span class="line">      this.transactionFactory == null ? new SpringManagedTransactionFactory() : this.transactionFactory,</span><br><span class="line">      this.dataSource));</span><br><span class="line"></span><br><span class="line">// è¿™é‡Œæ˜¯å¤„ç† mapper.xml æ–‡ä»¶çš„é…ç½®,å¦‚æœåœ¨è¿™é‡Œæ˜¯æœ‰é…ç½®çš„è¯,é‚£ä¹ˆä¹Ÿæ˜¯ä¼šè¢«è§£æåˆ°çš„.    </span><br><span class="line">  if (this.mapperLocations != null) &#123;</span><br><span class="line">    if (this.mapperLocations.length == 0) &#123;</span><br><span class="line">      LOGGER.warn(() -&gt; &quot;Property &#x27;mapperLocations&#x27; was specified but matching resources are not found.&quot;);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      for (Resource mapperLocation : this.mapperLocations) &#123;</span><br><span class="line">        if (mapperLocation == null) &#123;</span><br><span class="line">          continue;</span><br><span class="line">        &#125;</span><br><span class="line">        try &#123;</span><br><span class="line">          XMLMapperBuilder xmlMapperBuilder = new XMLMapperBuilder(mapperLocation.getInputStream(),</span><br><span class="line">              targetConfiguration, mapperLocation.toString(), targetConfiguration.getSqlFragments());</span><br><span class="line">          xmlMapperBuilder.parse();</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">          throw new NestedIOException(&quot;Failed to parse mapping resource: &#x27;&quot; + mapperLocation + &quot;&#x27;&quot;, e);</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">          ErrorContext.instance().reset();</span><br><span class="line">        &#125;</span><br><span class="line">        LOGGER.debug(() -&gt; &quot;Parsed mapper file: &#x27;&quot; + mapperLocation + &quot;&#x27;&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    LOGGER.debug(() -&gt; &quot;Property &#x27;mapperLocations&#x27; was not specified.&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">//org.apache.ibatis.session.defaults.DefaultSqlSessionFactory,æœ€ååˆ°è¿™é‡Œä¹Ÿæ˜¯newäº†ä¸€ä¸ªmybatisåŒ…ä¸‹çš„é»˜è®¤SqlSessionFactoryç±».</span><br><span class="line">  return this.sqlSessionFactoryBuilder.build(targetConfiguration);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¯¥æ–¹æ³•ç»™äººæ„Ÿè§‰, å…ˆæ˜¯åˆ¤æ–­ä¸€äº›é…ç½®ä¿¡æ¯æ˜¯ä¸æ˜¯æœ‰å€¼ï¼Œå¦‚æœæ˜¯æœ‰å€¼çš„è¯ï¼Œå°±ä¼šè¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚æœ€åè°ƒç”¨æˆ‘ä»¬åœ¨çœ‹å•ä¸ª mybatis çš„ parse è§£ææ–¹æ³•,æœ€ånewäº†ä¸€ä¸ªé»˜è®¤çš„sqlSessionFactoryå·¥å‚ç±»å‡ºæ¥.</p><p><strong>MapperScannerConfigurer(org.mybatis.spring.mapper.MapperScannerConfigurer)</strong></p><p>æ¥ç€çœ‹,spring-beans.xml é‡Œé¢çš„ç¬¬äºŒä¸ªé…ç½®.</p><p>å¯ä»¥çœ‹åˆ°è¯¥ç±»ï¼Œä¹Ÿæ˜¯å®ç°äº† spring çš„å¾ˆå¤šæ¥å£.</p><p>BeanDefinitionRegistryPostProcessor : æ³¨å†ŒBeanDefinitionåˆ°Springå®¹å™¨ä¸­æ¥.</p><p>ApplicationContextAware : è·å– ApplicationContext</p><p>BeanNameAware : è®¾ç½® beanNameåå­—.</p><p>è¿™é‡Œä¹Ÿå¯ä»¥æŒ‰ç…§ä¸Šé¢çš„ç¬¨æ–¹æ³•ï¼Œä¸€æ¬¡å¯¹é‡å†™çš„æ–¹æ³•æ‰“ä¸Šæ–­ç‚¹. ç„¶åå¼€å¯æˆ‘ä»¬çš„debugæ¥çœ‹çœ‹æ–¹æ³•çš„æ‰§è¡Œé¡ºåº.</p><p>å…¶æ‰§è¡Œé¡ºåº : setBeanName â€”&gt; setApplicationContext â€”&gt; afterPropertiesSet â€”&gt; postProcessBeanDefinitionRegistry , è·Ÿç€è¿™å››ä¸ªæ–¹æ³•æ‰§è¡Œçš„é¡ºåºæ¥çœ‹.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">public class MapperScannerConfigurer</span><br><span class="line">    implements BeanDefinitionRegistryPostProcessor, InitializingBean, ApplicationContextAware, BeanNameAware &#123; &#125;</span><br></pre></td></tr></table></figure><p>èµ‹å€¼ç»™ beanName å€¼. org.mybatis.spring.mapper.MapperScannerConfigurer#0</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void setBeanName(String name) &#123;</span><br><span class="line">  this.beanName = name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// ç„¶åè¿™é‡Œæ˜¯ç»™åˆ° ApplicationContext. è¿™ä¹Ÿå°±è¯´è¿™ä¸ªç±»ç°åœ¨æœ‰äº† ApplicationContext,å¯ä»¥æ ¹æ®contextæä¾›çš„apiæ¥è¿›è¡Œç›¸åº”çš„æ“ä½œ.</span><br><span class="line">  @Override</span><br><span class="line">  public void setApplicationContext(ApplicationContext applicationContext) &#123;</span><br><span class="line">    this.applicationContext = applicationContext;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">// æ£€éªŒé…ç½®åŒ…çš„å€¼ä¸èƒ½ä¸ºnull.</span><br><span class="line">  @Override</span><br><span class="line">  public void afterPropertiesSet() throws Exception &#123;</span><br><span class="line">    notNull(this.basePackage, &quot;Property &#x27;basePackage&#x27; is required&quot;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * &#123;@inheritDoc&#125;</span><br><span class="line">   * å¯ä»¥æ„Ÿå—åˆ°è¿™ä¸ªæ–¹æ³•, åœ¨æ‹¿åˆ°äº†BeanDefinitionRegistryçš„æƒ…å†µä¸‹,å¾€é‡Œé¢æ³¨å†Œbd.</span><br><span class="line">   * @since 1.0.2</span><br><span class="line">   */</span><br><span class="line">  @Override</span><br><span class="line">  public void postProcessBeanDefinitionRegistry(BeanDefinitionRegistry registry) &#123;</span><br><span class="line">    if (this.processPropertyPlaceHolders) &#123;</span><br><span class="line">      processPropertyPlaceHolders();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">// è¿™æ®µæ˜¯åˆ›å»ºäº†ä¸€ä¸ª ClassPathMapperScanner å¯¹è±¡,ç„¶åå¾€é‡Œé¢setå±æ€§.      </span><br><span class="line">    ClassPathMapperScanner scanner = new ClassPathMapperScanner(registry);</span><br><span class="line">    scanner.setAddToConfig(this.addToConfig);</span><br><span class="line">    scanner.setAnnotationClass(this.annotationClass);</span><br><span class="line">    scanner.setMarkerInterface(this.markerInterface);</span><br><span class="line">    scanner.setSqlSessionFactory(this.sqlSessionFactory);</span><br><span class="line">    scanner.setSqlSessionTemplate(this.sqlSessionTemplate);</span><br><span class="line">    scanner.setSqlSessionFactoryBeanName(this.sqlSessionFactoryBeanName);</span><br><span class="line">    scanner.setSqlSessionTemplateBeanName(this.sqlSessionTemplateBeanName);</span><br><span class="line">    scanner.setResourceLoader(this.applicationContext);</span><br><span class="line">    scanner.setBeanNameGenerator(this.nameGenerator);</span><br><span class="line">    scanner.setMapperFactoryBeanClass(this.mapperFactoryBeanClass);</span><br><span class="line">      </span><br><span class="line">    if (StringUtils.hasText(lazyInitialization)) &#123;</span><br><span class="line">      scanner.setLazyInitialization(Boolean.valueOf(lazyInitialization));</span><br><span class="line">    &#125;</span><br><span class="line">    if (StringUtils.hasText(defaultScope)) &#123;</span><br><span class="line">      scanner.setDefaultScope(defaultScope);</span><br><span class="line">    &#125;</span><br><span class="line">      </span><br><span class="line">// å¯¹registeré‡Œçš„ä¿¡æ¯è¿›è¡Œè¿‡æ»¤      </span><br><span class="line">    scanner.registerFilters();</span><br><span class="line">// org.springframework.context.annotation.ClassPathBeanDefinitionScanner#scan</span><br><span class="line">// è¿™é‡Œä¸»è¦çœ‹æ‰«æçš„æ–¹æ³•. æ ¹æ®,æ¥åˆ‡å‰²æˆ‘ä»¬å†™çš„ basePackage ä¿¡æ¯.æ‰«æç±»çš„ä¿¡æ¯,æœ€åè¿˜æ˜¯å€Ÿç”¨äº† org.springframework.context.annotation.ClassPathBeanDefinitionScanner#doScan æ¥è¿›è¡Œæ‰«æçš„. //  doScan(basePackages) æ˜¯å¯¹ xml è¿›è¡Œæ‰«æçš„.</span><br><span class="line">// AnnotationConfigUtils.registerAnnotationConfigProcessors(this.registry); æ˜¯å¯¹æ³¨è§£è¿›è¡Œæ‰«æçš„.</span><br><span class="line">// æœ€åè¿”å›æ³¨å†Œåˆ° Spring å®¹å™¨ä¸­çš„ bean ä¸ªæ•°</span><br><span class="line">// æ‰€ä»¥å¦‚æœæˆ‘ä»¬é…ç½®äº†ä¸‹é¢çš„æ ‡ç­¾,é‚£ä¹ˆåœ¨è¿™é‡Œéƒ½ä¼šè¢«æ‰«æåˆ°å¹¶ä¸”æ³¨å†Œåˆ°Springå®¹å™¨ä¸­.</span><br><span class="line">//     &lt;bean class=&quot;org.mybatis.spring.mapper.MapperScannerConfigurer&quot;&gt;</span><br><span class="line">//        &lt;property name=&quot;basePackage&quot; value=&quot;com.iyang.sm.mapper&quot; &gt;&lt;/property&gt;</span><br><span class="line">//    &lt;/bean&gt;</span><br><span class="line">// è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯:  org.mybatis.spring.mapper.ClassPathMapperScanner#processBeanDefinitions</span><br><span class="line">//   definition.setBeanClass(this.mapperFactoryBeanClass);  è¿™é‡Œçš„è¿™è¡Œä»£ç ,æ˜¯ç»™bdçš„beanClassç»™æ¢æˆäº† MapperFactoryBean.class , </span><br><span class="line">//  definition.getConstructorArgumentValues().addGenericArgumentValue(beanClassName);     // è¿™å¥ä»£ç ,å°† beanClassName ç»™åˆ° dbä¹‹å, ç„¶åå°±æ‰ç”¨ beanClassNameæ¥newä¸€ä¸ª MapperFactoryBean å¯¹è±¡æ¥, æ‰€ä»¥è¿™é‡Œå¹¶ä¸æ˜¯ä½¿ç”¨æ— å‚æ„é€ å‡½æ•°.</span><br><span class="line">// ä¹Ÿè®¸ä¼šé—®,æ€ä¹ˆè¯å®æ²¡æœ‰èµ°æ— å‚æ•°æ„é€ å‡½æ•°å‘¢ ? è€Œæ˜¯å»èµ°çš„ set æ–¹æ³•å‘¢ ? </span><br><span class="line">// å†ä¸èƒ½åŠ¨æºç çš„æƒ…å†µä¸‹, é¢å¯¹è¿™ç§æƒ…å†µæƒ…å†µæœ€å¥½çš„åŠæ³•å°±æ˜¯, åœ¨æ— å‚æ„é€ å‡½æ•°ä¸Šæ‰“ä¸Šæ–­ç‚¹.</span><br><span class="line">// å¦‚æœæ²¡èµ°åˆ°æ–­ç‚¹ä¸Š,é‚£å°±è¯´æ˜ä¸æ˜¯èµ°çš„æ— å‚æ„é€ å‡½æ•°æ¥åˆå§‹åŒ–çš„.      </span><br><span class="line">    scanner.scan(</span><br><span class="line">        StringUtils.tokenizeToStringArray(this.basePackage, ConfigurableApplicationContext.CONFIG_LOCATION_DELIMITERS));</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥åˆ°è¿™é‡Œ, å¯ä»¥çœ‹åˆ° MyBatis ä¸ Spring æ•´åˆçš„è¿‡ç¨‹å°±å·²ç»å®Œæˆäº†.</p><p>æˆ‘ä»¬è¿™é‡Œæ˜¯ä¸»è¦å¯¹ SqlSessionFactoryBean å’Œ MapperScannerConfigurer æ¥è¿›è¡Œåˆ†æçš„, å¯ä»¥å¾ˆæ˜æ˜¾çš„æ„Ÿè§‰åˆ°,æˆ‘ä»¬æ˜¯é…ç½®å¥½è¿™äºŒä¸ªbeanå,å°±å¯ä»¥ä½¿ç”¨äº†. ç€é‡çœ‹ç¬¬äºŒä¸ª, org.mybatis.spring.mapper.MapperScannerConfigurer è¿™ä¸ªbean,å°±æ˜¯åšäº†å¦‚ä½•å°† MyBatis çš„ mapperæ¥å£æ–‡ä»¶ç»™åŠ è½½åˆ° Spring ä¸­æ¥çš„. <strong>é‚£ä¹ˆè¿™é‡Œæˆ‘åœ¨æƒ³, å¦‚æœæœ‰å¤©æˆ‘è‡ªå·±å¼€å‘å‡ºä¸€ä¸ªå¥½ç”¨çš„æ¡†æ¶æ¥,è¦ä¸ Spring è¿›è¡Œæ•´åˆçš„è¯,æ˜¯ä¸æ˜¯ä¹Ÿè¿™æ ·æ•´åˆå°±å¯ä»¥äº†ï¼Ÿ</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- é…ç½®sqlSessionFactoryï¼ŒSqlSessionFactoryBeanæ˜¯ç”¨æ¥äº§ç”ŸsqlSessionFactoryçš„ --&gt;</span><br><span class="line">&lt;bean id=&quot;sqlSessionFactory&quot; class=&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;&gt;</span><br><span class="line">    &lt;!-- åŠ è½½mybatisçš„å…¨å±€é…ç½®æ–‡ä»¶ï¼Œæ”¾åœ¨classpathä¸‹çš„mybatisæ–‡ä»¶å¤¹ä¸­äº† --&gt;</span><br><span class="line">    &lt;property name=&quot;configLocation&quot; value=&quot;mybatis/SqlMapConfig.xml&quot; /&gt;</span><br><span class="line">    &lt;!-- åŠ è½½æ•°æ®æºï¼Œä½¿ç”¨ä¸Šé¢é…ç½®å¥½çš„æ•°æ®æº --&gt;</span><br><span class="line">    &lt;property name=&quot;dataSource&quot; ref=&quot;dataSource&quot; /&gt;</span><br><span class="line">&lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">&lt;!--  é…ç½®æ‰«æ MyBatis æ¥å£çš„åŒ… --&gt;</span><br><span class="line">&lt;bean class=&quot;org.mybatis.spring.mapper.MapperScannerConfigurer&quot;&gt;</span><br><span class="line">    &lt;property name=&quot;basePackage&quot; value=&quot;com.iyang.sm.mapper&quot; &gt;&lt;/property&gt;</span><br><span class="line">&lt;/bean&gt;</span><br></pre></td></tr></table></figure><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p> å¯ä»¥çœ‹åˆ° MyBatis ä¸ Spring æ•´åˆå, å¯¹äºè§£æ MyBatis çš„ mapper é…ç½®æ–‡ä»¶ç­‰ï¼Œéƒ½æ˜¯èµ°çš„ä¹‹å‰å•ä¸ª mybatis çš„é€»è¾‘, æ˜¯æ²¡æœ‰ä»€ä¹ˆå˜åŒ–çš„. ä¸»è¦çš„æ˜¯å°† , SqlSessionFactory å’Œ Mapper.class(æ¥å£ç±») ç»™æ³¨å…¥åˆ° Spring å®¹å™¨ä¸­.ç„¶åæ¥å£çš„è¯, æ˜¯æ€ä¹ˆä½¿ç”¨çš„ä»£ç†ç±»æ¥è¿›è¡Œå®ä¾‹åŒ–å®Œå, å°†å¯¹è±¡ç»™æ³¨å…¥åˆ° Spring å®¹å™¨ä¸­çš„å‘¢ ï¼Ÿ è¿™é‡Œçœ‹ org.mybatis.spring.mapper.MapperScannerConfigurer åšçš„äº‹æƒ…å°±æ˜ç™½äº†.</p><p> ä¸è¿‡åœ¨çœ‹ mybatis ä¸ Spring æ•´åˆçš„æ—¶å€™, è¿˜æ˜¯å»ºè®®è¦æœ‰å¯¹ BeanDefinitionRegistryPostProcessor &#x2F; InitializingBean &#x2F; ApplicationContextAware &#x2F; BeanNameAware æœ‰ä¸€å®šçš„äº†æ¥. å°±æ˜¯æœ‰äº†äº†è§£å, ä½ å°±ä¼šå¾ˆæ˜æ˜¾çš„æ„Ÿå—åˆ°ï¼Œ mybatis ä¸ºä»€ä¹ˆæ˜¯å®ç°è¿™ä¸ªæ¥å£ï¼Œå®ç°è¿™ä¸ªæ¥å£å¹¶ä¸”é‡å†™è¿™ä¸ªæ–¹æ³•ï¼Œåœ¨åé¢æ˜¯ä»€ä¹ˆæ—¶å€™è¢«è°ƒç”¨çš„. æ„æ€ä¹Ÿå°±æ˜¯ï¼Œä½ è‡³å°‘å¾—æ˜ç™½ç‚¹ Spring å¯¹å¤–æä¾›çš„ä¸€äº›æ‰©å±•ç‚¹ï¼Œæ‰èƒ½å¾ˆå¥½çš„ç†è§£è¿™äº›ä¸œè¥¿.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;é¢˜è®°&quot;&gt;&lt;a href=&quot;#é¢˜è®°&quot; class=&quot;headerlink&quot; title=&quot;é¢˜è®°&quot;&gt;&lt;/a&gt;é¢˜è®°&lt;/h4&gt;&lt;p&gt; MyBatis ä¸ Spring æ•´åˆæ“ä½œ. åœ¨æˆ‘ä»¬å…¥é—¨å­¦ä¹  SSM ç­‰ä¸œè¥¿çš„æ—¶å€™ï¼Œå°±å‘ç°äº†ä»»ä½•ä¸œè¥¿ï¼Œæœ€åéƒ½æ˜¯é€ƒä¸è¿‡ä¸Springæ•´åˆèµ·æ¥</summary>
      
    
    
    
    <category term="javaæ¡†æ¶" scheme="https://ruy9527.github.io/categories/java%E6%A1%86%E6%9E%B6/"/>
    
    <category term="mybatis" scheme="https://ruy9527.github.io/categories/java%E6%A1%86%E6%9E%B6/mybatis/"/>
    
    
    <category term="javaæ¡†æ¶" scheme="https://ruy9527.github.io/tags/java%E6%A1%86%E6%9E%B6/"/>
    
    <category term="mybatis" scheme="https://ruy9527.github.io/tags/mybatis/"/>
    
  </entry>
  
  <entry>
    <title>mybatiså·¥ä½œæµç¨‹é˜…è¯»</title>
    <link href="https://ruy9527.github.io/2021/11/04/mybatis/mybatis%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B%E9%98%85%E8%AF%BB/"/>
    <id>https://ruy9527.github.io/2021/11/04/mybatis/mybatis%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B%E9%98%85%E8%AF%BB/</id>
    <published>2021-11-03T16:29:16.000Z</published>
    <updated>2022-11-04T13:46:13.918Z</updated>
    
    <content type="html"><![CDATA[<h4 id="MyBatis-çš„å·¥ç¨‹æµç¨‹åˆ†æ"><a href="#MyBatis-çš„å·¥ç¨‹æµç¨‹åˆ†æ" class="headerlink" title="MyBatis çš„å·¥ç¨‹æµç¨‹åˆ†æ"></a>MyBatis çš„å·¥ç¨‹æµç¨‹åˆ†æ</h4><p> MyBatis æ˜¯æˆ‘ä»¬åœ¨å­¦ä¹ Javaæ¡†æ¶ï¼Œä¹Ÿå°±æ˜¯å­¦ä¹ å®ŒJavaWebçš„çŸ¥è¯†å,è¦å­¦ä¹ åˆ°çš„ä¸€ä¸ªORMçš„æ¡†æ¶. æˆ‘ä¹Ÿæ˜¯å­¦ä¹ &amp;ä½¿ç”¨è¿‡åï¼Œå†æ¬¡å¯¹æºç è¿›è¡Œé˜…è¯»çš„. æ‰€ä»¥è¿™ç¯‡æ–‡ç« è®°å½• MyBatis çš„ä¸€ä¸ª work flow.</p><p> å…ˆæ”¾ä¸Šé¡¹ç›®åœ°å€ : <a href="https://github.com/baoyang23/mybtatis-analysis/tree/master/mybatis-work-flow">https://github.com/baoyang23/mybtatis-analysis/tree/master/mybatis-work-flow</a></p><p> æœ‰å…´è¶£çš„åŒå­¦,å¯ä»¥cloneä¸‹æ¥çœ‹çœ‹.</p><h4 id="æ¡ˆä¾‹ä»£ç "><a href="#æ¡ˆä¾‹ä»£ç " class="headerlink" title="æ¡ˆä¾‹ä»£ç "></a>æ¡ˆä¾‹ä»£ç </h4><p>å…ˆæ”¾ä¸Šæ¡ˆåˆ—çš„ä»£ç , ç„¶åæˆ‘ä»¬å¯ä»¥æŒ¨ä¸ªçš„åˆ†æ.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">public class InitHelloMyBatis &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws IOException &#123;</span><br><span class="line">        // è¯»å–é…ç½®æ–‡ä»¶.</span><br><span class="line">        InputStream mybatisInputStream = Resources.getResourceAsStream(&quot;mybatis-config.xml&quot;);</span><br><span class="line">        // ä¼ å…¥è¯»å–é…ç½®æ–‡ä»¶çš„æµ,ä½¿ç”¨SqlSessionFactoryBuilderæ¥</span><br><span class="line">        // æ„å»º SqlSessionFactory.</span><br><span class="line">        SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(mybatisInputStream);</span><br><span class="line">        // ä» SqlSessionFactory ä¸­è·å–SqlSessionä¼šè¯.</span><br><span class="line">        SqlSession session = sqlSessionFactory.openSession();</span><br><span class="line"></span><br><span class="line">        // ä»ä¼šè¯ä¸­è·å– Mapper.</span><br><span class="line">        BlogMapper blogMapper = session.getMapper(BlogMapper.class);</span><br><span class="line">        </span><br><span class="line">        // è°ƒç”¨æŸ¥è¯¢æ–¹æ³•.</span><br><span class="line">        TbBlog tbBlog = blogMapper.selectBlog(1);</span><br><span class="line">        System.out.println(tbBlog);</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè¯´ä¸‹å¤§è‡´æµç¨‹ :</p><ul><li>ä½¿ç”¨ Resources æ¥è¯»å– mybatis-config.xmlé…ç½®æ–‡ä»¶, å¦‚æœè¯¥æ–‡ä»¶ä¸å­˜åœ¨æˆ–è€…è¯»å–å‡ºæ¥ InputStream æ˜¯ null çš„è¯,ç¨‹åºå°±ä¼šæŠ›å‡º IOException çš„é”™è¯¯æ¥.</li><li>è¯»å–é…ç½®æ²¡æœ‰é—®é¢˜,æ¥åˆ° new SqlSessionFactoryBuilder().build(io) æ¥æ„å»ºå‡ºä¸€ä¸ª SqlSessionFactory æ¥, è¿™é‡Œæ„å»ºå‡ºæ¥çš„ SqlSessionFactory è‚¯å®šæ˜¯æœ‰å·²ç»è®²é…ç½®æ–‡ä»¶ç»™å…¨éƒ¨åŠ è½½è¿›å»äº†çš„.</li><li>SqlSessionFactory.openSession() ä» SqlSessionFactory ä¸­è·å–ä¸€æ¬¡ä¼šè¯, ç„¶åå¯ä»¥ä»ä¼šè¯ä¸­è·å–å‡ºæ¥å£(BlogMapper)æ¥,è¿™é‡Œæ˜¯ä¸æ˜¯æœ‰ç‚¹å¥½å¥‡,æ˜æ˜è¿™å°±æ˜¯ä¸€ä¸ªæ¥å£,ä¹Ÿæ²¡æœ‰å®ç°ç±»,æ€ä¹ˆå°±å¯ä»¥getå‡ºä¸€ä¸ªæ¥å£å¯¹è±¡æ¥?è·å–å‡ºæ¥å£æ¥,ç„¶åå°±å¯ä»¥è°ƒç”¨æ¥å£ä¸­çš„æ–¹æ³•, æ ¹æ®idæŸ¥è¯¢å‡ºæ•°æ®æ¥.</li></ul><p>å¯ä»¥çœ‹åˆ°,æ ¹æ®ä»å®˜ç½‘å†™çš„ä¸€ä¸ªåˆ—å­,ä»è¡¨é¢æ¥çœ‹,ä»£ç é‡å¹¶ä¸æ˜¯å¾ˆå¤š. æ‰€ä»¥æ¥ä¸‹æ¥ç‚¹å»æºç ,å»è·Ÿè¿›æºç ä¸­çš„æ¯ä¸ªæ–¹æ³•,åˆ°åº•åšäº†äº›ä»€ä¹ˆäº‹æƒ….</p><p><strong>è¯»å–é…ç½®æ–‡ä»¶</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">InputStream mybatisInputStream = Resources.getResourceAsStream(&quot;mybatis-config.xml&quot;);</span><br></pre></td></tr></table></figure><p>org.apache.ibatis.io.Resources (Class).</p><p>å¯ä»¥çœ‹åˆ°MyBatisæºç è¿˜å†™äº†ä¸€ä¸ª ClassLoaderçš„åŒ…è£…ç±»ï¼Œé€šè¿‡ClassLoaderWrapperåŒ…è£…ç±»æ¥è®²é…ç½®æ–‡ä»¶è½¬åŒ–ä¸ºInputSream.</p><p>å¦‚æœè¿”å›çš„InputStreamæ˜¯nullï¼Œå°±ä¼šæŠ›å‡ºIOExceptionæ¥.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Returns a resource on the classpath as a Stream object</span><br><span class="line"> *</span><br><span class="line"> * @param loader   The classloader used to fetch the resource</span><br><span class="line"> * @param resource The resource to find</span><br><span class="line"> * @return The resource</span><br><span class="line"> * @throws java.io.IOException If the resource cannot be found or read</span><br><span class="line"> */</span><br><span class="line">private static ClassLoaderWrapper classLoaderWrapper = new ClassLoaderWrapper();</span><br><span class="line"></span><br><span class="line">public static InputStream getResourceAsStream(ClassLoader loader, String resource) throws IOException &#123;</span><br><span class="line">  // åˆ©ç”¨ ClasssLoaderWrapper.  </span><br><span class="line">  InputStream in = classLoaderWrapper.getResourceAsStream(resource, loader);</span><br><span class="line">  if (in == null) &#123;</span><br><span class="line">    throw new IOException(&quot;Could not find resource &quot; + resource);</span><br><span class="line">  &#125;</span><br><span class="line">  return in;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>äºæ˜¯æˆ‘ä»¬æ¥ç€çœ‹ ClassLoaderWrapper æ˜¯æ€ä¹ˆ è¯»å–é…ç½®æ–‡ä»¶ &amp; è½¬åŒ–ä¸º InputStream æµçš„.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">// è¿™é‡Œè¿”å›çš„æ˜¯ ClassLoaderçš„æ•°ç»„,å¦‚æœå¯¹ClassLoaderä¸æ˜¯å¾ˆäº†è§£çš„è¯,å¯ä»¥å…ˆå»ç™¾åº¦äº†è§£ä¸‹.</span><br><span class="line">ClassLoader[] getClassLoaders(ClassLoader classLoader) &#123;</span><br><span class="line">  return new ClassLoader[]&#123;</span><br><span class="line">      // ä¼ é€’è¿›æ¥çš„ </span><br><span class="line">      classLoader,</span><br><span class="line">      // é»˜è®¤çš„ ClassLoader</span><br><span class="line">      defaultClassLoader,</span><br><span class="line">      // æ ¹æ®å½“å‰çº¿ç¨‹è·å–å‡ºæ¥çš„</span><br><span class="line">      Thread.currentThread().getContextClassLoader(),</span><br><span class="line">      // æ ¹æ®å½“å‰ Class è·å–å‡ºæ¥çš„.</span><br><span class="line">      getClass().getClassLoader(),</span><br><span class="line">      // ç³»ç»Ÿçš„ClassLoader.</span><br><span class="line">      systemClassLoader&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// è·å–åˆ°äº† classLoaderçš„æ•°ç»„,ç„¶åå¯¹å…¶è¿›è¡Œè¿­ä»£.</span><br><span class="line">// ä¹Ÿå°±æ˜¯ä½¿ç”¨ ClassLoaderçš„  getResourceAsStream æ–¹æ³•,æ¥è®² mybatis-config.xml</span><br><span class="line">// é…ç½®æ–‡ä»¶è½¬åŒ–ä¸º InputStream.</span><br><span class="line">// æœ€åå¦‚æœè·å–åˆ°InputStreaméƒ½æ˜¯nullçš„è¯,é‚£ä¹ˆè¿”å›çš„ä¹Ÿå°±æ˜¯nulläº†.</span><br><span class="line">// æ ¹æ®ä¸Šé¢çš„è¯´æ³•,è¿”å›çš„å¦‚æœæ˜¯nullçš„è¯,å°±ä¼šå‡º IOExceptionæ¥.</span><br><span class="line">InputStream getResourceAsStream(String resource, ClassLoader[] classLoader) &#123;</span><br><span class="line">    for (ClassLoader cl : classLoader) &#123;</span><br><span class="line">      if (null != cl) &#123;</span><br><span class="line"></span><br><span class="line">        // try to find the resource as passed</span><br><span class="line">        InputStream returnValue = cl.getResourceAsStream(resource);</span><br><span class="line"></span><br><span class="line">        // now, some class loaders want this leading &quot;/&quot;, so we&#x27;ll add it and try again if we didn&#x27;t find the resource</span><br><span class="line">        if (null == returnValue) &#123;</span><br><span class="line">          returnValue = cl.getResourceAsStream(&quot;/&quot; + resource);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (null != returnValue) &#123;</span><br><span class="line">          return returnValue;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return null;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p><strong>è‡³æ­¤,MyBatisè¯»å– mybatis-config.xml é…ç½®æ–‡ä»¶ä¹Ÿå°±æ˜¯è§£æå®Œæ¯•,å¯ä»¥çœ‹åˆ°é‡‡ç”¨äº†è‡ªå·±å†™çš„ ClassLoaderWrapperæ¥æ“ä½œçš„, ä¼ é€’ä¸€ç§ ClassLoaderè¿›æ¥,å…¶é»˜è®¤çš„&amp;ç³»ç»Ÿ&amp;çº¿ç¨‹çš„,åŠ ä¸€èµ·ä¹Ÿæ˜¯æœ‰å››ç§. æœ€åæŒ¨ä¸ªè¿›æ¥è¿­ä»£ï¼Œæ»¡è¶³æ¡ä»¶çš„ä¼šè¯»å–æ–‡ä»¶è½¬åŒ–ä¸ºInputStream,å¦‚æœéƒ½æ˜¯nullçš„è¯,ä¹Ÿä¼šè¿”å›null.</strong></p><hr><p><strong>è·å–SqlSessionFactory &amp; è§£æé…ç½®æ–‡ä»¶</strong></p><p>new SqlSessionFactoryBuilder() ä¹Ÿæ˜¯newäº†ä¸€ä¸ª SqlSessionFactoryBuild,ä¸ªäººç†è§£ SqlSessionFactoryBuilder å°±æ˜¯ä¸“ç¨‹ç”¨æ¥æ„å»ºå‡º SqlSessionFactory æ¥çš„,æ¯•ç«Ÿå…¶åé¢æœ‰ä¸€ä¸ª build æ–¹æ³•.</p><p>Problem ? è¿™é‡Œæœ‰ä¸ªé—®é¢˜,ä¸ºä»€ä¹ˆä¸å°† SqlSessionFactoryBuilder çš„build æ–¹æ³•,ä¿®æ”¹ä¸ºé™æ€çš„ ? å¦‚æœä¿®æ”¹ä¸ºé™æ€çš„è¯ï¼Œé‚£å°±ä¸ç”¨newäº†,å°±å¯ä»¥ç›´æ¥ SqlSessionFactoryBuilder.build(mybatisInputStream);</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SqlSessionFactory sqlSessionFactory = new                     SqlSessionFactoryBuilder().build(mybatisInputStream);</span><br></pre></td></tr></table></figure><p><strong>SqlSessionFactory</strong></p><p>æ¥ç€æˆ‘ä»¬æ¥åˆ° SqlSessionFactory çš„ build æ–¹æ³•.</p><p>è¿™é‡Œåœ¨ finnaly ä¸­, å¯ä»¥çœ‹åˆ° ErrorContext åˆ©ç”¨äº† ThreadLocal , åˆšå¥½è¿™å‘¨å‡ºäº† ThreadLocal çš„è§†é¢‘.</p><p>è§†é¢‘åœ°å€ : <a href="https://www.bilibili.com/video/BV1Ga4y1W72w">https://www.bilibili.com/video/BV1Ga4y1W72w</a></p><p>æœ‰å…´è¶£&amp;ä¹äºå­¦ä¹ &amp;åˆ†äº«çš„,å¯ä»¥å…±åŒè¿›æ­¥.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public SqlSessionFactory build(InputStream inputStream, String environment, Properties properties) &#123;</span><br><span class="line">  try &#123;</span><br><span class="line">    // åˆ©ç”¨ä¼ å…¥è¿›æ¥çš„å‚æ•°,newå‡ºæ¥äº†ä¸€ä¸ª XMLConfigBuilder.</span><br><span class="line">    XMLConfigBuilder parser = new XMLConfigBuilder(inputStream, environment, properties);</span><br><span class="line">    return build(parser.parse());</span><br><span class="line">  &#125; catch (Exception e) &#123;</span><br><span class="line">    throw ExceptionFactory.wrapException(&quot;Error building SqlSession.&quot;, e);</span><br><span class="line">  &#125; finally &#123;</span><br><span class="line">    // è¿™é‡Œå¯¹ ThreadLocal ä¸­è¿›è¡Œ remove() æ“ä½œ   </span><br><span class="line">    ErrorContext.instance().reset();</span><br><span class="line">    try &#123;</span><br><span class="line">      // å…³é—­æµ.  </span><br><span class="line">      inputStream.close();</span><br><span class="line">    &#125; catch (IOException e) &#123;</span><br><span class="line">      // Intentionally ignore. Prefer previous error.</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>new XmlConfigBuilder() æ–¹æ³•:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line">public XMLConfigBuilder(InputStream inputStream, String environment, Properties props) &#123;</span><br><span class="line">  // å…ˆnewä¸€ä¸ªXMLMapperEntityResolver,å†newä¸€ä¸ªXPathParser,ç„¶åå°±èµ°åˆ°ä¸‹é¢çš„æ„é€ å‡½æ•°.</span><br><span class="line">  this(new XPathParser(inputStream, true, props, new XMLMapperEntityResolver()), environment, props);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// æœ€åè¿˜æ˜¯èµ°åˆ°è¿™ä¸ªæ„é€ æ–¹æ³•ä¸­æ¥.</span><br><span class="line">private XMLConfigBuilder(XPathParser parser, String environment, Properties props) &#123;</span><br><span class="line">  super(new Configuration());</span><br><span class="line">  ErrorContext.instance().resource(&quot;SQL Mapper Configuration&quot;);</span><br><span class="line">  this.configuration.setVariables(props);</span><br><span class="line">  this.parsed = false;</span><br><span class="line">  this.environment = environment;</span><br><span class="line">  this.parser = parser;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">----------------------------------------</span><br><span class="line">// new XPathParserä»£ç :</span><br><span class="line">    </span><br><span class="line">  public XPathParser(InputStream inputStream, boolean validation, Properties variables, EntityResolver entityResolver) &#123;</span><br><span class="line">    // æ™®é€šçš„æ„é€ æ–¹æ³•.</span><br><span class="line">    // å¯¹ XPathParserçš„validation/entityResolver/variables/xpath</span><br><span class="line">    // çš„å±æ€§è¿›è¡Œèµ‹å€¼æ“ä½œ.</span><br><span class="line">    commonConstructor(validation, variables, entityResolver);</span><br><span class="line">    this.document = createDocument(new InputSource(inputStream));</span><br><span class="line">  &#125;    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// createDocument æ–¹æ³•</span><br><span class="line">  private Document createDocument(InputSource inputSource) &#123;</span><br><span class="line">    // important: this must only be called AFTER common constructor</span><br><span class="line">    try &#123;</span><br><span class="line">      // è¿™é‡Œé€šè¿‡debugçœ‹,è¿”å›çš„å¯¹è±¡æ˜¯DocumentBuilderFactoryImpl</span><br><span class="line">      // ä¹Ÿå°±æ˜¯å…¶å®ç°ç±».  </span><br><span class="line">      DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();</span><br><span class="line">     // å¯¹ factory çš„ features(HashMap) æ·»åŠ å€¼,   </span><br><span class="line">      factory.setFeature(XMLConstants.FEATURE_SECURE_PROCESSING, true);</span><br><span class="line">     // å¯¹ factory çš„ validating è¿›è¡Œèµ‹å€¼  </span><br><span class="line">      factory.setValidating(validation);</span><br><span class="line"> // è¿™ä¸‹é¢éƒ½æ˜¯å¯¹ factoryçš„å±æ€§è¿›è¡Œèµ‹å€¼æ“ä½œ.</span><br><span class="line">      factory.setNamespaceAware(false);</span><br><span class="line">      factory.setIgnoringComments(true);</span><br><span class="line">      factory.setIgnoringElementContentWhitespace(false);</span><br><span class="line">      factory.setCoalescing(false);</span><br><span class="line">      factory.setExpandEntityReferences(true);</span><br><span class="line"></span><br><span class="line">      // å¯ä»¥çœ‹åˆ° return new DocumentBuilderImpl</span><br><span class="line">      // æœ€åè¿”å›çš„ä¹Ÿæ˜¯å…¶å®ç°ç±». </span><br><span class="line">      DocumentBuilder builder = factory.newDocumentBuilder();</span><br><span class="line">      builder.setEntityResolver(entityResolver);</span><br><span class="line">      // è®¾ç½®é”™è¯¯çš„handler,å¯ä»¥çœ‹åˆ°ErrorHandleræ˜¯æ¥å£,è¿™é‡Œæ˜¯åŒ¿åå®ç°çš„</span><br><span class="line">      // ä¹Ÿå°±æ˜¯ç›´æ¥newäº†æ¥å£,ç„¶åé‡å†™å…¶æ–¹æ³•.  </span><br><span class="line">      builder.setErrorHandler(new ErrorHandler() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void error(SAXParseException exception) throws SAXException &#123;</span><br><span class="line">          throw exception;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void fatalError(SAXParseException exception) throws SAXException &#123;</span><br><span class="line">          throw exception;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void warning(SAXParseException exception) throws SAXException &#123;</span><br><span class="line">          // NOP</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">      //   DocumentBuilderImpl çš„ parse è§£ææ–¹æ³•</span><br><span class="line">      return builder.parse(inputSource);</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">      throw new BuilderException(&quot;Error creating document instance.  Cause: &quot; + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">-------------</span><br><span class="line">//   builder.parse(inputSource)</span><br><span class="line"></span><br><span class="line">    public Document parse(InputSource is) throws SAXException, IOException &#123;</span><br><span class="line">        if (is == null) &#123;</span><br><span class="line">            throw new IllegalArgumentException(</span><br><span class="line">                DOMMessageFormatter.formatMessage(DOMMessageFormatter.DOM_DOMAIN,</span><br><span class="line">                &quot;jaxp-null-input-source&quot;, null));</span><br><span class="line">        &#125;</span><br><span class="line">    // fSchemaValidator æ˜¯ null ,è·³è¿‡.</span><br><span class="line">        if (fSchemaValidator != null) &#123;</span><br><span class="line">            if (fSchemaValidationManager != null) &#123;</span><br><span class="line">                fSchemaValidationManager.reset();</span><br><span class="line">                fUnparsedEntityHandler.reset();</span><br><span class="line">            &#125;</span><br><span class="line">            resetSchemaValidator();</span><br><span class="line">        &#125;</span><br><span class="line">  // ä½¿ç”¨ xml çš„ç›¸å…³ç±»å¯¹ is è¿›è¡Œè§£æ  </span><br><span class="line">        domParser.parse(is);</span><br><span class="line"> //  ?   </span><br><span class="line">        Document doc = domParser.getDocument();</span><br><span class="line"> // ? è¿™äº›è§£æ Document çš„åœ°æ–¹.....   </span><br><span class="line">        domParser.dropDocumentReferences();</span><br><span class="line">        return doc;</span><br><span class="line">    &#125;    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">---------------</span><br><span class="line">// æœ€åçœ‹åˆ° this æ„é€ å‡½æ•°.</span><br><span class="line"></span><br><span class="line">  private XMLConfigBuilder(XPathParser parser, String environment, Properties props) &#123;</span><br><span class="line">    /** new Configuration() ä¸­,TypeAliasRegistry typeAliasRegistryä¸­çš„ typeAliases,</span><br><span class="line">    *   åœ¨åˆå§‹åŒ–è¿™ä¸ªå¯¹è±¡çš„æ—¶å€™,å°±é»˜è®¤è®¾ç½®äº†ä¸€äº›åˆ«åé…ç½®.</span><br><span class="line">    *   åˆå§‹åŒ–çš„æ—¶å€™,è¿˜æœ‰å¯¹ LanguageDriverRegistry çš„ LANGUAGE_DRIVER_MAP èµ‹å€¼.</span><br><span class="line">    *  çˆ¶ç±» :  BaseBuilderæŠ½è±¡ç±».</span><br><span class="line">    *  ç„¶åè°ƒç”¨superæ–¹æ³•,å°†configurationèµ‹å€¼çˆ¶ç±»çš„configuration</span><br><span class="line">    *  åŒæ—¶å°† configurationçš„typeAliasRegistryå’ŒtypeHandlerRegistryä¹Ÿèµ‹å€¼</span><br><span class="line">    *  ç»™å½“å‰çš„è¿™ä¸ªå¯¹è±¡.</span><br><span class="line">    *   </span><br><span class="line">    */</span><br><span class="line">    super(new Configuration());</span><br><span class="line">    // instance() æ–¹æ³•æ˜¯å¾€ ThreadLocalé‡Œé¢å»setäº†ä¸€ä¸ªErrorContext</span><br><span class="line">    // æœ€åä¼šåœ¨finnalyä¸­è¿›è¡Œremoveæ‰.</span><br><span class="line">    ErrorContext.instance().resource(&quot;SQL Mapper Configuration&quot;);</span><br><span class="line">    // å°† props èµ‹å€¼åˆ° configuration çš„ variable å‚æ•°.</span><br><span class="line">    this.configuration.setVariables(props);</span><br><span class="line">    // è¡¨ç¤ºè¿˜æ²¡æœ‰è¢«è§£æ</span><br><span class="line">    this.parsed = false;</span><br><span class="line">    this.environment = environment;</span><br><span class="line">    this.parser = parser;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œ,å°±å¯ä»¥çœ‹åˆ° thisæ„é€ æ–¹æ³•ä»¥åŠå…¶ä¹‹å‰è¿˜æœ‰newå¯¹è±¡çš„æ–¹æ³•,éƒ½å·²ç»èµ°å®Œäº†. è¿™ä¸Šé¢çš„æ–¹æ³•,åŸºæœ¬éƒ½æ˜¯å†ä¸ºåé¢çš„è§£æxmlæ–‡ä»¶åšå‡†å¤‡, å¹¶ä¸”è¿˜æœ‰ä¸€äº›åˆå§‹åŒ–æ•°æ®çš„èµ‹å€¼æ“ä½œ.</p><p><strong>Note</strong> : æ³¨æ„è¿™é‡Œçš„ BaseBuilderæ˜¯æŠ½è±¡ç±»,å…¶å®ç°ç±»æ˜¯æœ‰å¥½å‡ ä¸ªçš„. è¿™ç§å†™æ³•,å…¶å®æ˜¯å°†å­ç±»çš„ä¸€äº›commonçš„æ–¹æ³•,å†™å…¥åˆ° BaseBuilderçˆ¶ç±»ä¸­,ç„¶åä¸åŒçš„æ–¹æ³•,éœ€è¦å­ç±»è‡ªå·±å»é‡å†™è¿™ä¸ªæ–¹æ³•å®ç°è‡ªå·±çš„ä¸šåŠ¡é€»è¾‘. å½“ç„¶ä¸€äº›å‚æ•°ä¹Ÿæ˜¯å¯ä»¥æ”¾åœ¨æŠ½è±¡ç±»ä¸­.</p><p><strong>build(parser.parse())</strong> : è§£æä»£ç .</p><p>parser.parse() æ–¹æ³• :</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">public Configuration parse() &#123;</span><br><span class="line">  // ç”¨ parsed æ¥æ§åˆ¶æ˜¯å¦è§£æè¿‡,å¦‚æœå·²ç»è§£æè¿‡äº†,é‚£å°±æŠ›å‡ºå¼‚å¸¸.  </span><br><span class="line">  if (parsed) &#123;</span><br><span class="line">    throw new BuilderException(&quot;Each XMLConfigBuilder can only be used once.&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">  parsed = true;</span><br><span class="line">  //   </span><br><span class="line">  parseConfiguration(parser.evalNode(&quot;/configuration&quot;));</span><br><span class="line">  return configuration;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">---------------------------------</span><br><span class="line">// parseConfiguration</span><br><span class="line">// è¿™é‡Œ debug å¯ä»¥çœ‹åˆ° root æ˜¯ configuration çš„é…ç½®æ–‡ä»¶ä¿¡æ¯.   </span><br><span class="line">// è¿™é‡Œå¯ä»¥åˆæ­¥çœ‹åˆ°å®å¯¹ æˆ‘ä»¬çš„é…ç½®æ–‡ä»¶mybatis-config.xmlè¿›è¡Œè§£æ,å¹¶ä¸”åŠ è½½åˆ° configurationä¸­.</span><br><span class="line">// åé¢æˆ‘ä»¬è·Ÿç€å®˜ç½‘æ–‡æ¡£ä¸€æ­¥ä¸€æ­¥çš„é˜…è¯»,ä¼šæœ‰ä¸“é—¨å¯¹è§£æé…ç½®çš„æºç è¿›è¡Œåˆ†æ.    </span><br><span class="line">  private void parseConfiguration(XNode root) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">      //issue #117 read properties first</span><br><span class="line">      //   </span><br><span class="line">      propertiesElement(root.evalNode(&quot;properties&quot;));</span><br><span class="line">      Properties settings = settingsAsProperties(root.evalNode(&quot;settings&quot;));</span><br><span class="line">      loadCustomVfs(settings);</span><br><span class="line">      loadCustomLogImpl(settings);</span><br><span class="line">      typeAliasesElement(root.evalNode(&quot;typeAliases&quot;));</span><br><span class="line">      pluginElement(root.evalNode(&quot;plugins&quot;));</span><br><span class="line">      objectFactoryElement(root.evalNode(&quot;objectFactory&quot;));</span><br><span class="line">      objectWrapperFactoryElement(root.evalNode(&quot;objectWrapperFactory&quot;));</span><br><span class="line">      reflectorFactoryElement(root.evalNode(&quot;reflectorFactory&quot;));</span><br><span class="line">      settingsElement(settings);</span><br><span class="line">      // read it after objectFactory and objectWrapperFactory issue #631</span><br><span class="line">      environmentsElement(root.evalNode(&quot;environments&quot;));</span><br><span class="line">      databaseIdProviderElement(root.evalNode(&quot;databaseIdProvider&quot;));</span><br><span class="line">      typeHandlerElement(root.evalNode(&quot;typeHandlers&quot;));</span><br><span class="line">      mapperElement(root.evalNode(&quot;mappers&quot;));</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">      throw new BuilderException(&quot;Error parsing SQL Mapper Configuration. Cause: &quot; + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p><strong>build(parser.parse()) æ–¹æ³•</strong></p><p>è¿™é‡Œæ˜¯å¯¹ parser.parse() è°ƒç”¨ç©è¿”å›çš„ Configuration ä¼ å…¥åˆ°æ–°åˆ›å»ºçš„ DefaultSqlSessionFactory å¯¹è±¡ä¸­.</p><p>ä¹Ÿå°±æ˜¯è¯´,æˆ‘ä»¬æ‹¿åˆ°çš„ SqlSessionFactory æ˜¯ DefaultSqlSessionFactory.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public SqlSessionFactory build(Configuration config) &#123;</span><br><span class="line">  return new DefaultSqlSessionFactory(config);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è·å– SqlSession</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">SqlSession session = sqlSessionFactory.openSession();</span><br><span class="line"></span><br><span class="line">// org.apache.ibatis.session.defaults.DefaultSqlSessionFactory#openSessionFromDataSource</span><br><span class="line">// çœ‹åˆ°è¿™ä¸ªæ–¹æ³•,ç›´æ¥è·Ÿè¿›åˆ°è¿™ä¸ªæ–¹æ³•æ¥.</span><br><span class="line"></span><br><span class="line">  private SqlSession openSessionFromDataSource(ExecutorType execType, TransactionIsolationLevel level, boolean autoCommit) &#123;</span><br><span class="line">    Transaction tx = null;</span><br><span class="line">    try &#123;</span><br><span class="line">        </span><br><span class="line">// ä» configurationä¸­è·å–å‡ºenvironmentæ¥,è¿™é‡Œçš„ getEnvironmentå¯¹åº”çš„æ˜¯</span><br><span class="line">// æ ‡ç­¾çš„ &lt;environment&gt;  é‡Œé¢çš„å†…å®¹</span><br><span class="line">// org.apache.ibatis.mapping.Environment</span><br><span class="line">// å¯ä»¥çœ‹åˆ°è¿™ä¸ªå¯¹è±¡,idå¯¹åº”mybatis-config.xmlä¸­çš„environment id</span><br><span class="line">// datasource å¯¹åº”  environment &gt; dataSource å­—æ®µ.</span><br><span class="line">      final Environment environment = configuration.getEnvironment();</span><br><span class="line">// æ ¹æ®    environment æ¥è·å– TransactionFactory,ä¹Ÿå°±æ˜¯MyBatisçš„äº‹åŠ¡å·¥å‚.</span><br><span class="line">// debug æ˜¯å¯ä»¥çœ‹åˆ°  environment ä¸­æ˜¯æœ‰ä¸€ä¸ªJdbcTransactionFactoryçš„,</span><br><span class="line">// å¦‚æœæ²¡ç”¨çš„è¯,å°±ä¼šè‡ªå·±newä¸€ä¸ª ManagedTransactionFactory æ¥.        </span><br><span class="line">      final TransactionFactory transactionFactory = getTransactionFactoryFromEnvironment(environment);</span><br><span class="line"></span><br><span class="line">// åœ¨ JdbcTransactionFactory ä¸­newå‡ºäº†ä¸€ä¸ª JdbcTransaction</span><br><span class="line">// ä¹Ÿå°±æ˜¯newäº†ä¸€ä¸ªJDBCäº‹åŠ¡.</span><br><span class="line">// org.apache.ibatis.transaction.jdbc.JdbcTransaction,</span><br><span class="line">// å¯ä»¥çœ‹åˆ° JdbcTransaction ä¸­æœ‰commit / rollbackçš„æ–¹æ³•,</span><br><span class="line">// ä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªåœ°æ–¹å°±æ˜¯å¯¹äº‹åŠ¡è¿›è¡Œæ“ä½œçš„åœ°æ–¹        </span><br><span class="line">      tx = transactionFactory.newTransaction(environment.getDataSource(), level, autoCommit);</span><br><span class="line">// è¿™é‡Œæ˜¯è·å–æ˜¯æ‰§è¡Œå™¨,</span><br><span class="line">// å…·ä½“ä»£ç : org.apache.ibatis.session.Configuration#newExecutor(org.apache.ibatis.transaction.Transaction, org.apache.ibatis.session.ExecutorType)</span><br><span class="line">// è¿™é‡Œæœ‰ SIMPLE, REUSE, BATCH ,CachingExecutor è¿˜å¯ä»¥åœ¨ plugin ä¸­è‡ªå·±å®šä¹‰.</span><br><span class="line">//executor = (Executor) interceptorChain.pluginAll(executor); ä»è¿™è¡Œä»£ç å¯ä»¥çœ‹åˆ°,</span><br><span class="line">// å…¶å®è¿˜æ˜¯å¯ä»¥è‡ªå·±æ‰©å±•çš„.        </span><br><span class="line">//org.apache.ibatis.plugin.InterceptorChain        </span><br><span class="line">      final Executor executor = configuration.newExecutor(tx, execType);</span><br><span class="line">// æœ€å new å‡ºäº†ä¸€ä¸ªé»˜è®¤çš„ SqlSession ä¼šè¯.</span><br><span class="line">// è¯¥ä¼šè¯ä¸­å­˜æœ‰ configuration / executor ç­‰æ ¸å¿ƒä¸œè¥¿.        </span><br><span class="line">      return new DefaultSqlSession(configuration, executor, autoCommit);</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">      closeTransaction(tx); // may have fetched a connection so lets call close()</span><br><span class="line">      throw ExceptionFactory.wrapException(&quot;Error opening session.  Cause: &quot; + e, e);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">// æœ€åè¿˜æ˜¯ä¸å¿˜è®°å¯¹ä½¿ç”¨è¿‡çš„ThreadLocal è¿›è¡Œremove æ“ä½œ.        </span><br><span class="line">      ErrorContext.instance().reset();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>è‡³æ­¤, å¯ä»¥çœ‹åˆ° MyBatis ä»SqlSessionFactoryä¸­è·å–å‡ºæ¥SqlSessionä¼šè¯, ä¹Ÿå¯ä»¥ç†è§£ä¸ºå‡ ä¸ªæ­¥éª¤.</p><p>é¦–å…ˆè·å–äº‹åŠ¡å·¥å‚, ç„¶åå†ä»äº‹åŠ¡å·¥å‚ä¸­è·å–ä¸€ä¸ªäº‹åŠ¡æ¥, JdbcTransaction æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥çœ‹ä¸‹è¿™ä¸ªç±»,é‡Œé¢ä¹Ÿæ˜¯å°è£…äº†å†™ commit &#x2F; rollbackç­‰æ–¹æ³•. å†æ¥ç€è·å–å‡º æ‰§è¡Œå™¨(Executor),è¿™é‡Œä»ä»£ç å“ªé‡Œçœ‹,æ‰§è¡Œå™¨è¿˜æ˜¯æœ‰å‡ ç§ç±»å‹çš„,ä¹Ÿæ‰§è¡Œè‡ªå®šä¹‰. æœ€ånewäº†ä¸€ä¸ª DefaultSqlSession å›å».</p><p><strong>session.getMapper(BlogMapper.class);</strong></p><p>æ¥ç€çœ‹,ä¸Šä¸€æ­¥è¿”å›çš„session,æ˜¯æ€ä¹ˆè·å–åˆ°æˆ‘ä»¬å†™çš„Mapperæ¥å£æ–‡ä»¶(Mapperè¿™ç§æ–‡ä»¶,åœ¨è§£æé…ç½®æ–‡ä»¶çš„æ—¶å€™,å…¶å®å°±å·²ç»è§£æåˆ°MyBatisçš„configurationé‡Œé¢å»äº†).</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">@SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">public &lt;T&gt; T getMapper(Class&lt;T&gt; type, SqlSession sqlSession) &#123;</span><br><span class="line"> // knownMappers  ä¸­ key æ˜¯æˆ‘ä»¬å®šä¹‰æ¥å£çš„Class,valueæ˜¯MapperProxyFactory,</span><br><span class="line">// MapperProxyFactoryä¸­çš„mapperInterfaceä¸­å­˜æ”¾äº†æˆ‘ä»¬çš„æ¥å£class    </span><br><span class="line">  final MapperProxyFactory&lt;T&gt; mapperProxyFactory = (MapperProxyFactory&lt;T&gt;) knownMappers.get(type);</span><br><span class="line">    </span><br><span class="line">// å¦‚æœè·å–å‡ºæ¥çš„æ˜¯null,é‚£ä¹ˆMyBatiså°±è®¤ä¸ºä½ ä¼ å…¥è¿›æ¥çš„æ¥å£æ˜¯ä¸å­˜åœ¨çš„,å°±ä¼šæŠ›å‡ºå¼‚å¸¸æ¥.    </span><br><span class="line">  if (mapperProxyFactory == null) &#123;</span><br><span class="line">    throw new BindingException(&quot;Type &quot; + type + &quot; is not known to the MapperRegistry.&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">  try &#123;</span><br><span class="line">// æ»¡è¶³æ¡ä»¶çš„è¯,è°ƒç”¨newInstanceæ–¹æ³•,ä»æ–¹æ³•åå­—ä¸Šçœ‹,æ˜¯åˆ›å»ºä¸€ä¸ªinstanceçš„å®ä¾‹.      </span><br><span class="line">    return mapperProxyFactory.newInstance(sqlSession);</span><br><span class="line">  &#125; catch (Exception e) &#123;</span><br><span class="line">    throw new BindingException(&quot;Error getting mapper instance. Cause: &quot; + e, e);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-------------------------------------------</span><br><span class="line">// mapperProxyFactory.newInstance(sqlSession) ä»£ç </span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">  public T newInstance(SqlSession sqlSession) &#123;</span><br><span class="line">    // new äº†ä¸€ä¸ª MapperProxyå¯¹è±¡.</span><br><span class="line">    final MapperProxy&lt;T&gt; mapperProxy = new MapperProxy&lt;&gt;(sqlSession, mapperInterface, methodCache);</span><br><span class="line">    return newInstance(mapperProxy);</span><br><span class="line">  &#125;    </span><br><span class="line"></span><br><span class="line">// æœ€åå¯ä»¥çœ‹åˆ°ä½¿ç”¨ Proxy.newProxyInstanceæ–¹æ³•æ¥åˆ›å»ºçš„ä¸€ä¸ªå¯¹è±¡.</span><br><span class="line">  @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">  protected T newInstance(MapperProxy&lt;T&gt; mapperProxy) &#123;</span><br><span class="line">    return (T) Proxy.newProxyInstance(mapperInterface.getClassLoader(), new Class[] &#123; mapperInterface &#125;, mapperProxy);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-------</span><br><span class="line">// å¦‚æœä½ æ˜¯debugæ¨¡å¼çš„è¯,é‚£ä¹ˆä½ å¯ä»¥çœ‹åˆ°BlogMapperçš„å¯¹è±¡åœ°å€æ± åœ¨ debug ä¸­æ˜¾ç¤ºçš„å€¼.</span><br><span class="line">// org.apache.ibatis.binding.MapperProxy@ef9296d    </span><br><span class="line">BlogMapper blogMapper = session.getMapper(BlogMapper.class);</span><br></pre></td></tr></table></figure><p>ä»SqlSession ä¸­è·å– BlogMapperæˆ‘ä»¬å†™çš„mapperæµç¨‹, å…ˆä» knownMappers ä¸­æ ¹æ®keyè·å–å‡ºæ¥ä¹‹å‰åŠ è½½é…ç½®å·²ç»åŠ è½½å®Œæ¯•çš„ä¿¡æ¯,å¦‚æœæ²¡ç”¨çš„è¯,å°±ä¼šæŠ›å‡ºæ²¡æœ‰çš„å¼‚å¸¸. æœ€åä½¿ç”¨ Proxy.newProxyIntsanceæ¥ç”Ÿæˆçš„ä¸€ä¸ªç±»ä¼¼æ¥å£å®ç°ç±»çš„ä»£ç ,ä¸åŒçš„æ˜¯, åœ¨ new MapperProxy çš„æ—¶å€™,å°±å·²ç»å°†æ¥ä¸‹æ¥éœ€è¦çš„ä¿¡æ¯å…¨éƒ¨ä¼ å…¥è¿›å».</p><p><strong>blogMapper.selectBlog(1) æ–¹æ³•</strong></p><p>ç«Ÿç„¶ BlogMapperæ˜¯é€šè¿‡Proxy.newInstanceè·å–å‡ºæ¥çš„,é‚£å®ƒæ˜¯æ€ä¹ˆæŸ¥è¯¢çš„æ•°æ®åº“? åˆæ˜¯æ€ä¹ˆå°†å­—æ®µç»™æ˜ å°„åˆ° Objectä¸€ä¸€å¯¹åº”çš„å‘¢ ?</p><p>debugä¼šèµ°åˆ° MapperProxyçš„invokeæ–¹æ³•æ¥</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123;</span><br><span class="line">  try &#123;</span><br><span class="line">    if (Object.class.equals(method.getDeclaringClass())) &#123;</span><br><span class="line">      return method.invoke(this, args);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      return cachedInvoker(method).invoke(proxy, method, args, sqlSession);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; catch (Throwable t) &#123;</span><br><span class="line">    throw ExceptionUtil.unwrapThrowable(t);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">------------------</span><br><span class="line">// é€šè¿‡ invoke æ–¹æ³•, èµ° mapperMethodçš„executeæ–¹æ³•,æ¥åˆ°äº†è¿™é‡Œ.</span><br><span class="line">// switch æœ‰ INSERT/UPDATE/DELETE/SELECT/FLUSH,å¦‚æœè¿™å‡ ç§æ²¡æœ‰åŒ¹é…åˆ°çš„è¯,å°±ä¼šæŠ›å‡ºå¼‚å¸¸æ¥.    </span><br><span class="line">  public Object execute(SqlSession sqlSession, Object[] args) &#123;</span><br><span class="line">    Object result;</span><br><span class="line">    switch (command.getType()) &#123;</span><br><span class="line">            </span><br><span class="line">// ä¸éš¾çœ‹åˆ° INSERT/UPDATE/DELETEéƒ½æ˜¯å…ˆè°ƒç”¨ convertArgsToSqlCommandParam æ–¹æ³•,</span><br><span class="line">// ä¹Ÿå°±æ˜¯å…ˆå°†å‚æ•°è½¬åŒ–ä¸ºsql,ç„¶åå°†æ‰§è¡Œçš„ç»“æœ èµ‹å€¼ ç»™ result å‚æ•°.            </span><br><span class="line">      case INSERT: &#123;</span><br><span class="line">        Object param = method.convertArgsToSqlCommandParam(args);</span><br><span class="line">        result = rowCountResult(sqlSession.insert(command.getName(), param));</span><br><span class="line">        break;</span><br><span class="line">      &#125;</span><br><span class="line">      case UPDATE: &#123;</span><br><span class="line">        Object param = method.convertArgsToSqlCommandParam(args);</span><br><span class="line">        result = rowCountResult(sqlSession.update(command.getName(), param));</span><br><span class="line">        break;</span><br><span class="line">      &#125;</span><br><span class="line">      case DELETE: &#123;</span><br><span class="line">        Object param = method.convertArgsToSqlCommandParam(args);</span><br><span class="line">        result = rowCountResult(sqlSession.delete(command.getName(), param));</span><br><span class="line">        break;</span><br><span class="line">      &#125;</span><br><span class="line">// å¦‚æœæ˜¯ select è¯­å¥,å¯ä»¥æ ¹æ®è¿”å›å€¼æ¥åˆ†ç±»,å¦‚æœæ˜¯void&amp;&amp;method.hasResultHandler,å°±ä¼šè¿”å›null</span><br><span class="line">// å¤šä¸ª / Mapç±»å‹  /    Cursor ç±»å‹   /  æœ€åæŸ¥è¯¢ä¸€ä¸ª        </span><br><span class="line">      case SELECT:</span><br><span class="line">        if (method.returnsVoid() &amp;&amp; method.hasResultHandler()) &#123;</span><br><span class="line">          executeWithResultHandler(sqlSession, args);</span><br><span class="line">          result = null;</span><br><span class="line">        &#125; else if (method.returnsMany()) &#123;</span><br><span class="line">          result = executeForMany(sqlSession, args);</span><br><span class="line">        &#125; else if (method.returnsMap()) &#123;</span><br><span class="line">          result = executeForMap(sqlSession, args);</span><br><span class="line">        &#125; else if (method.returnsCursor()) &#123;</span><br><span class="line">          result = executeForCursor(sqlSession, args);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          Object param = method.convertArgsToSqlCommandParam(args);</span><br><span class="line">          result = sqlSession.selectOne(command.getName(), param);</span><br><span class="line">          if (method.returnsOptional()</span><br><span class="line">              &amp;&amp; (result == null || !method.getReturnType().equals(result.getClass()))) &#123;</span><br><span class="line">            result = Optional.ofNullable(result);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        break;</span><br><span class="line"> // åˆ·æ–°ä¼šè¯.           </span><br><span class="line">      case FLUSH:</span><br><span class="line">        result = sqlSession.flushStatements();</span><br><span class="line">        break;</span><br><span class="line">      default:</span><br><span class="line">        throw new BindingException(&quot;Unknown execution method for: &quot; + command.getName());</span><br><span class="line">    &#125;</span><br><span class="line">// å¦‚æœresult æ˜¯ null, æ–¹æ³•è¿”å›çš„ä¿®é¥°ç¬¦æ˜¯privateå¹¶ä¸” è¿”å›å€¼ä¸æ˜¯voidçš„è¯,å°±ä¼šæŠ›å‡ºå¼‚å¸¸.    </span><br><span class="line">    if (result == null &amp;&amp; method.getReturnType().isPrimitive() &amp;&amp; !method.returnsVoid()) &#123;</span><br><span class="line">      throw new BindingException(&quot;Mapper method &#x27;&quot; + command.getName()</span><br><span class="line">          + &quot; attempted to return null from a method with a primitive return type (&quot; + method.getReturnType() + &quot;).&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    return result;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°,å…ˆæ˜¯å¯¹ INSERT &#x2F; UPDATE &#x2F; DELETE &#x2F; SELECT è¿›è¡Œåˆ†ç±»å¤„ç†, ç„¶åå¯¹å†åˆ†åˆ«æ ¹æ®ä¸åŒçš„ç±»å‹è¿›è¡Œå¤„ç†. éƒ½æ˜¯å…ˆæœ‰è½¬åŒ–ä¸ºsql,ç„¶åå°†æ‰§è¡Œç»“æœèµ‹å€¼ç»™result.</p><p>è‡³äºé‡Œé¢è¯¦ç»†çš„æŸ¥è¯¢æ‰§è¡Œsql,è¿˜æœ‰åŠ¨æ€sql,æ¯æ¬¡ä¼šè¯ç¼“å­˜ç­‰,åé¢çœ‹åˆ°è¯¦ç»†çš„æƒ…å†µå†ä¸€ä¸€è¯´æ˜. è¿™é‡Œåªæ˜¯å¯¹MyBatisçš„åŸºæœ¬å·¥ä½œè¿›è¡Œäº†ä¸€ä¸ªæ¢³ç†. ç„¶ååé¢å†æ ¹æ®åŸºç¡€æ¢³ç†,å†æ¥æŒ¨ä¸ªå‡»ç¢ä»–ä»¬.</p><p>è‡³æ­¤, MyBatisçš„å…¥é—¨åˆ†ææµç¨‹æ˜¯ç»“æŸçš„. ç†è§£èµ·æ¥,åº”è¯¥è¿˜ä¸æ˜¯é‚£ä¹ˆéš¾.</p><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>æ ¹æ® com.iyang.mybatis.InitHelloMyBatis , ä¹Ÿå°±æ˜¯å…¥é—¨çš„demoæ¥æ¢³ç†ä¸‹æµç¨‹.</p><ol><li>è¯»å–é…ç½®æ–‡ä»¶,ä¹Ÿå°±æ˜¯å°†é…ç½®æ–‡ä»¶è¯»å–,è½¬åŒ–ä¸ºinptStreamæµ.</li><li>åˆ©ç”¨ SqlSessionFactoryBuilder æ¥ è§£ææµ, èµ·å†…éƒ¨åˆåˆ©ç”¨ BaseBuilder(å…¶åˆå¾ˆå¤šå®ç°ç±»,è¿™é‡Œç”¨çš„XMLConfigBuilder)ä¹Ÿè§£æxmlé…ç½®æ–‡ä»¶. Configuration configuration è¯¥ç±»ä¸­æ˜¯ä¿å­˜ç€xmlé…ç½®æ–‡ä»¶çš„å¾ˆå¤šä¿¡æ¯. ç„¶å DefaultSqlSessionFactory ä¸­æœ‰configurationå­—æ®µ,ä¹Ÿå°±æ˜¯å±æ€§.</li><li>ç„¶åä» DefaultSqlSessionFactory ä¸­è·å– SqlSessionæ¥, å¹¶ä¸”ä¹Ÿä¼šæ˜¯å¦å¼€å¯äº‹åŠ¡(å‚è€ƒ:org.apache.ibatis.transaction.jdbc.JdbcTransaction)ç±»,ç„¶åè·å– Executor,Executorä¹Ÿæ˜¯æœ‰å‡ ç§ç§ç±»çš„,ä¹Ÿå¯ä»¥è‡ªå·±è‡ªå®šä¹‰,æœ€åè¿”å›ä¸€ä¸ª DefaultSqlSession æ¥.</li><li>ç„¶åä» SqlSession ä¸­è·å–æˆ‘ä»¬çš„æ¥å£Mapper, æœ€åä¹Ÿæ˜¯åˆ©ç”¨ Proxy.newProxyInstance æ¥ç”Ÿæˆçš„æ¥å£,ä¹Ÿå°±æ˜¯ä»£ç†(è¿™é‡Œæ‰“å°å‡ºåœ°å€æ± æˆ–è€…debugçœ‹åœ°å€æ± ,å°±ä¼šå¾ˆæ˜æ˜¾çš„çœ‹åˆ°æ˜¯ä»£ç†å¯¹è±¡).</li><li>æœ€åèµ°æŸ¥è¯¢çš„æ–¹æ³•, ä¹Ÿå°±æ˜¯èµ°åˆ°äº† MapperProxy æ¥. å¯ä»¥çœ‹åˆ°MapperProxyé‡Œé¢æ˜¯æœ‰sqlSessionçš„,è€ŒSqlSessionæ˜¯æœ‰ Executor&#x2F;configuration&#x2F;autoCommitç­‰ä¿¡æ¯çš„, æœ‰äº†sqlSession,å°±å‰©ä¸‹æ‰§è¡Œsqlå’Œæ˜ å°„sqlæŸ¥è¯¢å‡ºæ¥çš„ç»“æœæ¥äº†(è¿™é‡Œæ˜¯ mapperMethod.execute(sqlSession, args) â€”&gt; org.apache.ibatis.binding.MapperMethod#execute èµ°åˆ°è¿™é‡Œæ¥äº†,è¿™é‡Œä¹‹åå°±ä¼šåˆ†ç±»è¿›è¡Œå¤„ç†,ç„¶åæ˜ å°„sqlè¯­å¥).</li><li>è‡³æ­¤,ä¸€ä¸ª MyBatis çš„ HelloWorldåˆ†ææµç¨‹æ˜¯å®Œæ¯•çš„.</li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;MyBatis-çš„å·¥ç¨‹æµç¨‹åˆ†æ&quot;&gt;&lt;a href=&quot;#MyBatis-çš„å·¥ç¨‹æµç¨‹åˆ†æ&quot; class=&quot;headerlink&quot; title=&quot;MyBatis çš„å·¥ç¨‹æµç¨‹åˆ†æ&quot;&gt;&lt;/a&gt;MyBatis çš„å·¥ç¨‹æµç¨‹åˆ†æ&lt;/h4&gt;&lt;p&gt; MyBatis æ˜¯æˆ‘ä»¬åœ¨å­¦ä¹ Jav</summary>
      
    
    
    
    <category term="javaæ¡†æ¶" scheme="https://ruy9527.github.io/categories/java%E6%A1%86%E6%9E%B6/"/>
    
    <category term="mybatis" scheme="https://ruy9527.github.io/categories/java%E6%A1%86%E6%9E%B6/mybatis/"/>
    
    
    <category term="javaæ¡†æ¶" scheme="https://ruy9527.github.io/tags/java%E6%A1%86%E6%9E%B6/"/>
    
    <category term="mybatis" scheme="https://ruy9527.github.io/tags/mybatis/"/>
    
  </entry>
  
  <entry>
    <title>mybatisä¸­mapperæ–‡ä»¶é˜…è¯»</title>
    <link href="https://ruy9527.github.io/2021/11/04/mybatis/mybatis%E4%B8%ADmapper%E6%96%87%E4%BB%B6%E9%98%85%E8%AF%BB/"/>
    <id>https://ruy9527.github.io/2021/11/04/mybatis/mybatis%E4%B8%ADmapper%E6%96%87%E4%BB%B6%E9%98%85%E8%AF%BB/</id>
    <published>2021-11-03T16:28:59.000Z</published>
    <updated>2022-11-04T13:46:13.918Z</updated>
    
    <content type="html"><![CDATA[<h4 id="é¢˜è®°"><a href="#é¢˜è®°" class="headerlink" title="é¢˜è®°"></a>é¢˜è®°</h4><p>MyBatisæ˜¯å¦‚ä½•å¯¹ Mapper æ–‡ä»¶ä¸­çš„sqlè¿›è¡Œå¤„ç†å‘¢ï¼Ÿ è™½ç„¶ä¸Šç¯‡è§£æ mybatis-config.xml æ˜¯æœ‰è¿›è¡Œè¯´æ˜çš„, ä½†æ˜¯åº”è¯¥æ‹¿å‡ºæ¥å•ç‹¬ä»”ç»†è§£æä¸‹. å› ä¸ºè¿™ä¸ªé‡Œé¢æ¶‰åŠåˆ°åŠ¨æ€sql, åŠ ä¸Šmapperæ–‡ä»¶è‡ªèº«ä¹Ÿæœ‰å¾ˆå¤šæ ‡ç­¾å†…å®¹,ç„¶åMyBatisæ˜¯æ€ä¹ˆè¯»å–å‡ºè¿™äº›å†…å®¹çš„å‘¢ï¼Ÿè¯»å–å‡ºæ¥å,åˆæ˜¯åšäº†æ€ä¹ˆæ ·çš„å¤„ç†, ç„¶åè¾¾åˆ°äº†sqlé‚£ç§æ‰§è¡Œæ•ˆæœçš„å‘¢ï¼Ÿ</p><p>æ„æ€ä¹Ÿå°±æ˜¯,Mapper + åŠ¨æ€sql , å†…å®¹è¿˜æ˜¯æœ‰ç‚¹å¤šçš„, å¹¶ä¸”ä¹Ÿå¾ˆé‡è¦, æ˜¯éå¸¸æœ‰å¿…è¦æ‹¿å‡ºæ¥å•ç‹¬çš„ä»”ç»†è®²è§£ä¸‹çš„.</p><h4 id="Target"><a href="#Target" class="headerlink" title="Target"></a>Target</h4><p>åœ¨ä¹‹å‰å¯¹æ ‡ç­¾çš„è¿›è¡Œè§£æçš„æ—¶å€™,æ˜¯æœ‰å¯¹ æ ‡ç­¾è¿›è¡Œä¸€ä¸ªåˆæ­¥çš„è§£æ. ç„¶åé‡Œé¢å…¶å®æ˜¯å¾ˆå¤šå†…å®¹è¿˜æ²¡å¡«è¡¥å¾ˆè¯¦ç»†,æ‰€ä»¥ç‰¹æ„è®°å½•ä¸‹å¯¹ è¯¦ç»†æ“ä½œçš„. é‚£ä¹ˆï¼Œä¸‹æ–‡å°±å¼€å§‹æ“ä½œå§.</p><p><strong>org.apache.ibatis.builder.xml.XMLMapperBuilder#parse</strong></p><p>ä¸»è¦æ¥çœ‹è¿™æ®µè§£æçš„ä»£ç  :</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">public void parse() &#123;</span><br><span class="line">    </span><br><span class="line">// åˆ©ç”¨ org.apache.ibatis.session.Configuration çš„ loadedResources</span><br><span class="line">// æ¥åˆ¤æ–­æ˜¯ä¸æ˜¯å·²ç»åŠ è½½è¿‡äº†çš„.    </span><br><span class="line">  if (!configuration.isResourceLoaded(resource)) &#123;</span><br><span class="line">    configurationElement(parser.evalNode(&quot;/mapper&quot;));</span><br><span class="line">// è¿™é‡Œæ·»åŠ åˆ° loadedResources ä¸­æ¥,ä¹Ÿå°±æ˜¯ç”¨æ¥æ§åˆ¶æ˜¯ä¸æ˜¯å·²ç»è§£æè¿‡äº†çš„.      </span><br><span class="line">    configuration.addLoadedResource(resource);</span><br><span class="line">    bindMapperForNamespace();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">// è¿™ä¸‰ä¸ªæ–¹æ³•ç»™æˆ‘ä¸€ç§å¥½åƒè§£æé‚£ç§æ²¡æœ‰è¿˜æ²¡è§£æå®Œçš„ ? è¿™ä¸ªåœ°æ–¹æœ‰å¾…å®Œå–„.    </span><br><span class="line">  parsePendingResultMaps();</span><br><span class="line">  parsePendingCacheRefs();</span><br><span class="line">  parsePendingStatements();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// configurationElement æ–¹æ³•,</span><br><span class="line">// å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ–¹æ³•ä¸­,å¾ˆå¤šæ ‡ç­¾(namespace/parameterMa/resultMap/sql)</span><br><span class="line">// è¿˜æœ‰ä¸‹é¢çš„select/insert/update/delete</span><br><span class="line">// è¿™äº›ç†Ÿæ‚‰çš„æ ‡ç­¾</span><br><span class="line">  private void configurationElement(XNode context) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">      String namespace = context.getStringAttribute(&quot;namespace&quot;);</span><br><span class="line">      if (namespace == null || namespace.equals(&quot;&quot;)) &#123;</span><br><span class="line">        throw new BuilderException(&quot;Mapper&#x27;s namespace cannot be empty&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">// å°† namespace èµ‹å€¼è¿›å»,ä¹Ÿå°±æ˜¯å½“å‰æ­£åœ¨è§£æçš„ namespace.        </span><br><span class="line">      builderAssistant.setCurrentNamespace(namespace);</span><br><span class="line">        </span><br><span class="line">// è¿™é‡Œæ˜¯å¯¹ç¼“å­˜æ ‡ç­¾è¿›è¡Œè§£æ.        </span><br><span class="line">      cacheRefElement(context.evalNode(&quot;cache-ref&quot;));</span><br><span class="line">      cacheElement(context.evalNode(&quot;cache&quot;));</span><br><span class="line"> </span><br><span class="line">// è§£æ parameterMapæ ‡ç­¾        </span><br><span class="line">      parameterMapElement(context.evalNodes(&quot;/mapper/parameterMap&quot;));</span><br><span class="line">        </span><br><span class="line">//         </span><br><span class="line">      resultMapElements(context.evalNodes(&quot;/mapper/resultMap&quot;));</span><br><span class="line">      sqlElement(context.evalNodes(&quot;/mapper/sql&quot;));</span><br><span class="line">      buildStatementFromContext(context.evalNodes(&quot;select|insert|update|delete&quot;));</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">      throw new BuilderException(&quot;Error parsing Mapper XML. The XML location is &#x27;&quot; + resource + &quot;&#x27;. Cause: &quot; + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p><strong>resultMapElements æ–¹æ³• :</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">// è¿™é‡Œçš„ list æ˜¯ xml æ–‡ä»¶ä¸­çš„æ‰€æœ‰ &lt;resultMap&gt; æ ‡ç­¾æ–‡ä»¶.</span><br><span class="line">private void resultMapElements(List&lt;XNode&gt; list) &#123;</span><br><span class="line">  for (XNode resultMapNode : list) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">//  æœ‰ç‚¹å¥½å¥‡,è¯¥æ–¹æ³•è¿”å›çš„ ResultMap è¿™è¾¹å¥½åƒå¹¶æ²¡æœ‰å‚æ•°,æœ‰ç‚¹å°´å°¬.</span><br><span class="line">//  ä¸è¿‡æ˜¯å·²ç»å­˜å‚¨åœ¨ org.apache.ibatis.session.Configuration#resultMaps ä¸­.       </span><br><span class="line">      resultMapElement(resultMapNode);</span><br><span class="line">    &#125; catch (IncompleteElementException e) &#123;</span><br><span class="line">      // ignore, it will be retried</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">----------</span><br><span class="line">// æœ€åè·Ÿè¿›åˆ°è¿™ä¸ªæ–¹æ³•ä¸­æ¥.</span><br><span class="line">  private ResultMap resultMapElement(XNode resultMapNode, List&lt;ResultMapping&gt; additionalResultMappings, Class&lt;?&gt; enclosingType) &#123;</span><br><span class="line">    ErrorContext.instance().activity(&quot;processing &quot; + resultMapNode.getValueBasedIdentifier());</span><br><span class="line"> </span><br><span class="line">// è·å–å‡º type , è¿™é‡Œæˆ‘ä»¬è·å–å‡ºæ¥çš„ type æ˜¯ TbBlog.    </span><br><span class="line">    String type = resultMapNode.getStringAttribute(&quot;type&quot;,</span><br><span class="line">        resultMapNode.getStringAttribute(&quot;ofType&quot;,</span><br><span class="line">            resultMapNode.getStringAttribute(&quot;resultType&quot;,</span><br><span class="line">                resultMapNode.getStringAttribute(&quot;javaType&quot;))));</span><br><span class="line">// å…ˆåˆ¤æ–­ org.apache.ibatis.type.TypeAliasRegistry#typeAliases ä¸­æœ‰æ²¡æœ‰,</span><br><span class="line">// å¦‚æœæ²¡æœ‰çš„è¯,å°±ä¼šè‡ªå·±newä¸€ä¸ªå‡ºæ¥.    </span><br><span class="line">    Class&lt;?&gt; typeClass = resolveClass(type);</span><br><span class="line">    if (typeClass == null) &#123;</span><br><span class="line">// TODO,å¦‚æœæ²¡æœ‰è¯?        </span><br><span class="line">      typeClass = inheritEnclosingType(resultMapNode, enclosingType);</span><br><span class="line">    &#125;</span><br><span class="line">    Discriminator discriminator = null;</span><br><span class="line">    List&lt;ResultMapping&gt; resultMappings = new ArrayList&lt;&gt;(additionalResultMappings);</span><br><span class="line">    </span><br><span class="line"> // è·å–è¯¥ &lt;resultMap&gt; ä¸‹çš„å­æ ‡ç­¾</span><br><span class="line">// é‚£ä¹ˆè¿™é‡Œä¹Ÿå°±æ˜¯è·å– &lt;id&gt; å’Œ &lt;result&gt; è¿™äºŒä¸ª.    </span><br><span class="line">    List&lt;XNode&gt; resultChildren = resultMapNode.getChildren();</span><br><span class="line">    for (XNode resultChild : resultChildren) &#123;</span><br><span class="line">// åˆ†ä¸º constructor / discriminator / å…¶ä»– è¿™ä¸‰ç±»æƒ…å†µ        </span><br><span class="line">      if (&quot;constructor&quot;.equals(resultChild.getName())) &#123;</span><br><span class="line">        processConstructorElement(resultChild, typeClass, resultMappings);</span><br><span class="line">      &#125; else if (&quot;discriminator&quot;.equals(resultChild.getName())) &#123;</span><br><span class="line">        discriminator = processDiscriminatorElement(resultChild, typeClass, resultMappings);</span><br><span class="line">      &#125; else &#123;</span><br><span class="line"> // éå‰äºŒè€…æƒ…å†µ.         </span><br><span class="line">        List&lt;ResultFlag&gt; flags = new ArrayList&lt;&gt;();</span><br><span class="line">        if (&quot;id&quot;.equals(resultChild.getName())) &#123;</span><br><span class="line">         // å¦‚æœæ ‡ç­¾æ˜¯idçš„è¯,å°±ä¼šç»™flagsæ·»åŠ ResultFlag.ID.</span><br><span class="line">          flags.add(ResultFlag.ID);</span><br><span class="line">        &#125;</span><br><span class="line">  //  å°†è¿”å›å›æ¥çš„ ResultMapping æ·»åŠ è¿›æ¥.       </span><br><span class="line">        resultMappings.add(buildResultMappingFromContext(resultChild, typeClass, flags));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">// è¿™é‡Œè·å–çš„æ˜¯ &lt;resultMap&gt; æ ‡ç­¾çš„ id å­—æ®µ.    </span><br><span class="line">    String id = resultMapNode.getStringAttribute(&quot;id&quot;,</span><br><span class="line">            resultMapNode.getValueBasedIdentifier());</span><br><span class="line">// è¿™é‡Œè¿˜å¯ä»¥ä½¿ç”¨ extends å±æ€§, ä¸æ˜¯çœ‹åˆ°è¿™é‡Œ, éƒ½å¥½å¥‡è¿˜æœ‰è¿™ç§æ ‡ç­¾.    </span><br><span class="line">    String extend = resultMapNode.getStringAttribute(&quot;extends&quot;);</span><br><span class="line">    Boolean autoMapping = resultMapNode.getBooleanAttribute(&quot;autoMapping&quot;);</span><br><span class="line">// è¿™é‡Œ new äº†ä¸€ä¸ª ResultMapResolver å¯¹è±¡.   </span><br><span class="line">    ResultMapResolver resultMapResolver = new ResultMapResolver(builderAssistant, id, typeClass, extend, discriminator, resultMappings, autoMapping);</span><br><span class="line">    try &#123;</span><br><span class="line">// è¿™é‡Œæœ€åå°±æ˜¯ new äº†ä¸€ä¸ª ResultMap å¯¹è±¡, è¯¥å¯¹è±¡çš„ id æ˜¯ namespace + æ–¹æ³•ID æ‹¼æ¥.</span><br><span class="line">// ç„¶åå°†è¯¥å¯¹è±¡ç»™æ·»åŠ åˆ°  org.apache.ibatis.session.Configuration#resultMaps ä¸­æ¥,</span><br><span class="line">// key å°±æ˜¯å…¶id, æœ€åå°±æ˜¯æ ¹æ® local / global æ¥åˆ†åˆ«è¿›è¡ŒäºŒç§æƒ…å†µæ£€æŸ¥.        </span><br><span class="line">      return resultMapResolver.resolve();</span><br><span class="line">    &#125; catch (IncompleteElementException  e) &#123;</span><br><span class="line">      configuration.addIncompleteResultMap(resultMapResolver);</span><br><span class="line">      throw e;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//  buildResultMappingFromContext æ–¹æ³•</span><br><span class="line">// è¯¥æ–¹æ³•æ˜¯å¯¹ resultMap ä¸­çš„å­—æ®µè¿›è¡Œè§£æ.</span><br><span class="line">  private ResultMapping buildResultMappingFromContext(XNode context, Class&lt;?&gt; resultType, List&lt;ResultFlag&gt; flags) &#123;</span><br><span class="line">    String property;</span><br><span class="line">    if (flags.contains(ResultFlag.CONSTRUCTOR)) &#123;</span><br><span class="line">      property = context.getStringAttribute(&quot;name&quot;);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      property = context.getStringAttribute(&quot;property&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    String column = context.getStringAttribute(&quot;column&quot;);</span><br><span class="line">    String javaType = context.getStringAttribute(&quot;javaType&quot;);</span><br><span class="line">    String jdbcType = context.getStringAttribute(&quot;jdbcType&quot;);</span><br><span class="line">    String nestedSelect = context.getStringAttribute(&quot;select&quot;);</span><br><span class="line">    String nestedResultMap = context.getStringAttribute(&quot;resultMap&quot;, () -&gt;</span><br><span class="line">      processNestedResultMappings(context, Collections.emptyList(), resultType));</span><br><span class="line">    String notNullColumn = context.getStringAttribute(&quot;notNullColumn&quot;);</span><br><span class="line">    String columnPrefix = context.getStringAttribute(&quot;columnPrefix&quot;);</span><br><span class="line">    String typeHandler = context.getStringAttribute(&quot;typeHandler&quot;);</span><br><span class="line">    String resultSet = context.getStringAttribute(&quot;resultSet&quot;);</span><br><span class="line">    String foreignColumn = context.getStringAttribute(&quot;foreignColumn&quot;);</span><br><span class="line">    boolean lazy = &quot;lazy&quot;.equals(context.getStringAttribute(&quot;fetchType&quot;, configuration.isLazyLoadingEnabled() ? &quot;lazy&quot; : &quot;eager&quot;));</span><br><span class="line">      </span><br><span class="line">// è·å– javaType , typeHandler , jdbcType ç­‰å¯¹è±¡.      </span><br><span class="line">    Class&lt;?&gt; javaTypeClass = resolveClass(javaType);</span><br><span class="line">    Class&lt;? extends TypeHandler&lt;?&gt;&gt; typeHandlerClass = resolveClass(typeHandler);</span><br><span class="line">    JdbcType jdbcTypeEnum = resolveJdbcType(jdbcType);</span><br><span class="line">// org.apache.ibatis.builder.MapperBuilderAssistant#buildResultMapping(java.lang.Class&lt;?&gt;, java.lang.String, java.lang.String, java.lang.Class&lt;?&gt;, org.apache.ibatis.type.JdbcType, java.lang.String, java.lang.String, java.lang.String, java.lang.String, java.lang.Class&lt;? extends org.apache.ibatis.type.TypeHandler&lt;?&gt;&gt;, java.util.List&lt;org.apache.ibatis.mapping.ResultFlag&gt;, java.lang.String, java.lang.String, boolean)</span><br><span class="line">// å¯ä»¥çœ‹åˆ°è¿™é‡Œä¼ é€’è¿›æ¥çš„å‚æ•°è¿˜æ˜¯å¾ˆå¤šçš„.</span><br><span class="line">// æœ€åè¿”å› ResultMapping å¯¹è±¡,ä¹Ÿå°±æ˜¯è¯´è¿™ä¹ˆå¤šå‚æ•°&amp;buildResultMappingæ–¹æ³•ä¸­çš„å‚æ•°,</span><br><span class="line">//éƒ½è®¾ç½®åˆ°è¯¥å¯¹è±¡ä¸­æ¥äº†.     </span><br><span class="line">    return builderAssistant.buildResultMapping(resultType, property, column, javaTypeClass, jdbcTypeEnum, nestedSelect, nestedResultMap, notNullColumn, columnPrefix, typeHandlerClass, flags, resultSet, foreignColumn, lazy);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p><strong>SqlElement æ–¹æ³•</strong></p><p>è¯¥æ–¹æ³•å¯ä»¥å¾ˆæ˜æ˜¾çš„æ„Ÿå—åˆ°æ˜¯å¯¹ æ ‡ç­¾è¿›è¡Œè§£æçš„.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">private void sqlElement(List&lt;XNode&gt; list) &#123;</span><br><span class="line"> // configuration è·å–å‡ºæ¥ dataBaseIdæ˜¯null,è·³è¿‡æ­¤æ–¹æ³•  </span><br><span class="line">  if (configuration.getDatabaseId() != null) &#123;</span><br><span class="line">    sqlElement(list, configuration.getDatabaseId());</span><br><span class="line">  &#125;</span><br><span class="line">//    </span><br><span class="line">  sqlElement(list, null);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// æœ‰ç‚¹å¥½å¥‡å†™ä»£ç é£æ ¼:  sqlElement(list,configuration.getDatabaseId());</span><br><span class="line">------------------------</span><br><span class="line"></span><br><span class="line">//  sqlElement æ–¹æ³•</span><br><span class="line">  private void sqlElement(List&lt;XNode&gt; list, String requiredDatabaseId) &#123;</span><br><span class="line">    for (XNode context : list) &#123;</span><br><span class="line">        </span><br><span class="line"> // è·å– databaseId å’Œ id è¿™äºŒä¸ªå±æ€§çš„å€¼.       </span><br><span class="line">      String databaseId = context.getStringAttribute(&quot;databaseId&quot;);</span><br><span class="line">      String id = context.getStringAttribute(&quot;id&quot;);</span><br><span class="line"> //  org.apache.ibatis.builder.MapperBuilderAssistant#applyCurrentNamespace   </span><br><span class="line"> // è¯¥æ–¹æ³•æœ€åè¿”å›çš„idçš„å€¼æ˜¯: namespace + id       </span><br><span class="line">      id = builderAssistant.applyCurrentNamespace(id, false);</span><br><span class="line">//sqlFragments ä¸åŒ…å«è¯¥idå°±è¿”å›true,ä¹Ÿå°±è¯´è¯¥Mapæ˜¯ç¡®å®šæ˜¯å¦å·²ç»è§£æè¿‡äº†çš„.         </span><br><span class="line">      if (databaseIdMatchesCurrent(id, databaseId, requiredDatabaseId)) &#123;</span><br><span class="line">// æ·»åŠ åˆ° org.apache.ibatis.builder.xml.XMLMapperBuilder#sqlFragments ä¸­æ¥.          </span><br><span class="line">        sqlFragments.put(id, context);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>æœ€å è§£æåçš„å€¼,æ˜¯ä½¿ç”¨ namespace + id å­˜æ”¾åœ¨ org.apache.ibatis.builder.xml.XMLMapperBuilder#sqlFragments çš„å±æ€§ä¸­çš„.</p><p><strong>buildStatementFromContext() æ–¹æ³• :</strong></p><p>è¿™é‡Œæ˜¯å¯¹ select &#x2F; insert &#x2F; update &#x2F; delete æ ‡ç­¾è¿›è¡Œè§£æ.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line">buildStatementFromContext(context.evalNodes(&quot;select|insert|update|delete&quot;));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// å¯ä»¥çœ‹åˆ° databaseId çš„è·å–ä¸ sql æ ‡ç­¾æ˜¯ä¸€æ ·çš„æ“ä½œ</span><br><span class="line">private void buildStatementFromContext(List&lt;XNode&gt; list) &#123;</span><br><span class="line">  if (configuration.getDatabaseId() != null) &#123;</span><br><span class="line">    buildStatementFromContext(list, configuration.getDatabaseId());</span><br><span class="line">  &#125;</span><br><span class="line">  buildStatementFromContext(list, null);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// æ‰€ä»¥æˆ‘ä»¬å¯ä»¥è·Ÿè¿›åˆ°è¿™ä¸ªæ–¹æ³•æ¥.</span><br><span class="line">  private void buildStatementFromContext(List&lt;XNode&gt; list, String requiredDatabaseId) &#123;</span><br><span class="line">    for (XNode context : list) &#123;</span><br><span class="line">// å…ˆ new äº†ä¸€ä¸ª XMLStatementBuilder å¯¹è±¡, ç´§æ¥ç€å°±è°ƒç”¨è¯¥å¯¹è±¡çš„ è§£æ æ–¹æ³•.        </span><br><span class="line">      final XMLStatementBuilder statementParser = new XMLStatementBuilder(configuration, builderAssistant, context, requiredDatabaseId);</span><br><span class="line">      try &#123;</span><br><span class="line">        statementParser.parseStatementNode();</span><br><span class="line">      &#125; catch (IncompleteElementException e) &#123;</span><br><span class="line">        configuration.addIncompleteStatement(statementParser);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// è§£ææ–¹æ³•</span><br><span class="line">  public void parseStatementNode() &#123;</span><br><span class="line">    String id = context.getStringAttribute(&quot;id&quot;);</span><br><span class="line">    String databaseId = context.getStringAttribute(&quot;databaseId&quot;);</span><br><span class="line">// ç”¨ namespace + id ç»„åˆä¸º id</span><br><span class="line">// org.apache.ibatis.session.Configuration#mappedStatements</span><br><span class="line">// æ¥ç€å°±æ˜¯åˆ¤æ–­åœ¨ mappedStatements ä¸­æ˜¯ä¸æ˜¯æœ‰è¯¥id,å¦‚æœä¸å­˜åœ¨å°±è¿”å›ture,</span><br><span class="line">// å­˜åœ¨å°±è¿”å›false,è¿™é‡Œä¹Ÿå°±ä¼šç›´æ¥returnå‡ºå»,ä¹Ÿå°±æ˜¯ä¸ä¼šå¾€åé¢æ‰§è¡Œäº†.      </span><br><span class="line">    if (!databaseIdMatchesCurrent(id, databaseId, this.requiredDatabaseId)) &#123;</span><br><span class="line">      return;</span><br><span class="line">    &#125;</span><br><span class="line">// è·å–æ ‡ç­¾åå­—,  select / insert/ update /delete.</span><br><span class="line">    String nodeName = context.getNode().getNodeName();</span><br><span class="line">// è½¬åŒ–ä¸ºå¤§å†™çš„ SELECT      </span><br><span class="line">    SqlCommandType sqlCommandType = SqlCommandType.valueOf(nodeName.toUpperCase(Locale.ENGLISH));</span><br><span class="line">    boolean isSelect = sqlCommandType == SqlCommandType.SELECT;</span><br><span class="line">// æ˜¯å¦åˆ·æ–° cache,ä¹Ÿå°±æ˜¯selectæ˜¯ä¸åˆ·æ–°çš„,é‚£ä¹ˆå…¶ä»–çš„å°±åº”è¯¥æ˜¯è¦åˆ·æ–°çš„.      </span><br><span class="line">    boolean flushCache = context.getBooleanAttribute(&quot;flushCache&quot;, !isSelect);</span><br><span class="line">// ä½¿ç”¨ä½¿ç”¨ cache,è¿™é‡Œåº”è¯¥æ˜¯ä¸€çº§ç¼“å­˜ï¼Œé»˜è®¤å¼€å¯çš„.      </span><br><span class="line">    boolean useCache = context.getBooleanAttribute(&quot;useCache&quot;, isSelect);</span><br><span class="line">// ç»“æœæ’åº, å¦‚æœæ²¡æœ‰é…ç½®çš„è¯,é»˜è®¤å°±æ˜¯false.      </span><br><span class="line">    boolean resultOrdered = context.getBooleanAttribute(&quot;resultOrdered&quot;, false);</span><br><span class="line"></span><br><span class="line">    // Include Fragments before parsing</span><br><span class="line">// åˆ›å»ºäº†ä¸€ä¸ª XMLIncludeTransformer å¯¹è±¡,è¯¥å¯¹è±¡åº”è¯¥æ˜¯è¿›è¡Œè½¬åŒ–çš„.      </span><br><span class="line">    XMLIncludeTransformer includeParser = new XMLIncludeTransformer(configuration, builderAssistant);</span><br><span class="line"> //  TODO ? è¯¥æ–¹æ³•æœ‰å¾…æ›´æ–°     </span><br><span class="line">    includeParser.applyIncludes(context.getNode());</span><br><span class="line"></span><br><span class="line">//è·å– parameterType å±æ€§,å¦‚æœæœ‰çš„è¯,ä¹Ÿä¼šè·å–å‡ºè¯¥å±æ€§å¯¹åº”çš„ Class.    </span><br><span class="line">    String parameterType = context.getStringAttribute(&quot;parameterType&quot;);</span><br><span class="line">    Class&lt;?&gt; parameterTypeClass = resolveClass(parameterType);</span><br><span class="line"></span><br><span class="line">// lang : null,è¿™é‡Œæ˜¯æ²¡æœ‰è®¾ç½®çš„.      </span><br><span class="line">    String lang = context.getStringAttribute(&quot;lang&quot;);</span><br><span class="line">    LanguageDriver langDriver = getLanguageDriver(lang);</span><br><span class="line"></span><br><span class="line">    // Parse selectKey after includes and remove them.</span><br><span class="line">// è¿™é‡Œå¯¹æ˜¯å¦æœ‰ selectKey è¿›è¡Œå¤„ç†.æˆ‘ä»¬è¿™é‡Œç›®å‰æ²¡æœ‰ä½¿ç”¨ selectKey</span><br><span class="line">    processSelectKeyNodes(id, parameterTypeClass, langDriver);</span><br><span class="line"></span><br><span class="line">    // Parse the SQL (pre: &lt;selectKey&gt; and &lt;include&gt; were parsed and removed)</span><br><span class="line">    KeyGenerator keyGenerator;</span><br><span class="line"> // selectBlog!selectKey     </span><br><span class="line">    String keyStatementId = id + SelectKeyGenerator.SELECT_KEY_SUFFIX;</span><br><span class="line">// è¿™é‡Œæ‹¼æ¥ä¸Š namespace :  com.iyang.mybatis.mapper.BlogMapper.selectBlog!selectKey      </span><br><span class="line">    keyStatementId = builderAssistant.applyCurrentNamespace(keyStatementId, true);</span><br><span class="line"></span><br><span class="line">// è¿™é‡Œæ˜¯åˆ¤æ–­æ˜¯å¦æœ‰ ä¸»é”®è‡ªåŠ¨ç”Ÿæˆ. è¿™é‡Œæ˜¯æŸ¥è¯¢è¯­å¥,åº”è¯¥æ˜¯æ²¡æœ‰çš„. </span><br><span class="line">    if (configuration.hasKeyGenerator(keyStatementId)) &#123;</span><br><span class="line">      keyGenerator = configuration.getKeyGenerator(keyStatementId);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      keyGenerator = context.getBooleanAttribute(&quot;useGeneratedKeys&quot;,</span><br><span class="line">          configuration.isUseGeneratedKeys() &amp;&amp; SqlCommandType.INSERT.equals(sqlCommandType))</span><br><span class="line">          ? Jdbc3KeyGenerator.INSTANCE : NoKeyGenerator.INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">// åˆ›å»ºä¸€ä¸ª XMLScriptBuilder å¯¹è±¡,ä½¿ç”¨è¯¥å¯¹è±¡çš„parseScriptNodeæ–¹æ³•æ¥è§£æ</span><br><span class="line">// org.apache.ibatis.scripting.xmltags.XMLScriptBuilder#parseScriptNode</span><br><span class="line">// è·å–å‡ºsql, æœ‰ä¸ª isDynamic å‚æ•°,æ¥åˆ¤æ–­æ˜¯ä¸æ˜¯åŠ¨æ€sqlè¯­å¥.</span><br><span class="line">// è¿™é‡Œä¸æ˜¯åŠ¨æ€sql,æœ€ånewäº†ä¸€ä¸ªRawSqlSource.</span><br><span class="line">// org.apache.ibatis.builder.SqlSourceBuilder#parse,æˆ‘ä»¬çš„#&#123;id&#125; æ›¿æ¢æˆ ? å°±æ˜¯åœ¨</span><br><span class="line">// è¿™é‡Œè¿›è¡Œæ›¿æ¢çš„.</span><br><span class="line">// å¦‚æœæ˜¯åŠ¨æ€ sql çš„è¯,å°±ä¼šåˆ›å»ºå‡º DynamicSqlSource è¯¥å¯¹è±¡æ¥.</span><br><span class="line">// å¯ä»¥çœ‹åˆ° SqlSource ä¸‹é¢æ˜¯æœ‰ å››ä¸ªå®ç°ç±»çš„.</span><br><span class="line">// è¿™é‡Œè¿”å›çš„ SqlSourceé‡Œé¢æœ‰sqlè¯­å¥çš„,å’Œè¿”å›ç±»å‹çš„.      </span><br><span class="line">    SqlSource sqlSource = langDriver.createSqlSource(configuration, context, parameterTypeClass);</span><br><span class="line"> </span><br><span class="line">// è·å–å±æ€§.      </span><br><span class="line">    StatementType statementType = StatementType.valueOf(context.getStringAttribute(&quot;statementType&quot;, StatementType.PREPARED.toString()));</span><br><span class="line">    Integer fetchSize = context.getIntAttribute(&quot;fetchSize&quot;);</span><br><span class="line">    Integer timeout = context.getIntAttribute(&quot;timeout&quot;);</span><br><span class="line">    String parameterMap = context.getStringAttribute(&quot;parameterMap&quot;);</span><br><span class="line">// è·å–è¿”å›ç±»å‹. è·å–å‡ºæ¥çš„ resultTypeClass æ˜¯ class com.iyang.mybatis.pojo.TbBlog      </span><br><span class="line">    String resultType = context.getStringAttribute(&quot;resultType&quot;);</span><br><span class="line">    Class&lt;?&gt; resultTypeClass = resolveClass(resultType);</span><br><span class="line">    String resultMap = context.getStringAttribute(&quot;resultMap&quot;);      </span><br><span class="line">    String resultSetType = context.getStringAttribute(&quot;resultSetType&quot;);</span><br><span class="line">    ResultSetType resultSetTypeEnum = resolveResultSetType(resultSetType);</span><br><span class="line">    if (resultSetTypeEnum == null) &#123;</span><br><span class="line">      resultSetTypeEnum = configuration.getDefaultResultSetType();</span><br><span class="line">    &#125;</span><br><span class="line">// è·å–å±æ€§çš„å€¼      </span><br><span class="line">    String keyProperty = context.getStringAttribute(&quot;keyProperty&quot;);</span><br><span class="line">    String keyColumn = context.getStringAttribute(&quot;keyColumn&quot;);</span><br><span class="line">    String resultSets = context.getStringAttribute(&quot;resultSets&quot;);</span><br><span class="line"></span><br><span class="line">// åˆ›å»ºä¸€ä¸ª MappedStatement.Builder å¯¹è±¡å‡ºæ¥.</span><br><span class="line">// å†é€šè¿‡ builder æ„å»ºå‡ºä¸€ä¸ª MappedStatement å¯¹è±¡æ¥.</span><br><span class="line">// æœ€åæ”¾å…¥åˆ° org.apache.ibatis.session.Configuration#mappedStatements ä¸­æ¥.      </span><br><span class="line">    builderAssistant.addMappedStatement(id, sqlSource, statementType, sqlCommandType,</span><br><span class="line">        fetchSize, timeout, parameterMap, parameterTypeClass, resultMap, resultTypeClass,</span><br><span class="line">        resultSetTypeEnum, flushCache, useCache, resultOrdered,</span><br><span class="line">        keyGenerator, keyProperty, keyColumn, databaseId, langDriver, resultSets);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  private void processSelectKeyNodes(String id, Class&lt;?&gt; parameterTypeClass, LanguageDriver langDriver) &#123;</span><br><span class="line">    List&lt;XNode&gt; selectKeyNodes = context.evalNodes(&quot;selectKey&quot;);</span><br><span class="line">    if (configuration.getDatabaseId() != null) &#123;</span><br><span class="line">      parseSelectKeyNodes(id, selectKeyNodes, parameterTypeClass, langDriver, configuration.getDatabaseId());</span><br><span class="line">    &#125;</span><br><span class="line">    parseSelectKeyNodes(id, selectKeyNodes, parameterTypeClass, langDriver, null);</span><br><span class="line">    removeSelectKeyNodes(selectKeyNodes);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>æ€»ç»“ä¸‹ MyBatis è§£æ Mapperçš„xml æ–‡ä»¶æµç¨‹ã€‚ å¯ä»¥æ„Ÿå—åˆ°,å¯¹äºMybatiså¤„ç†Mapper,å¯¹å…¶å­—æ®µå±æ€§éƒ½æ˜¯æŒ¨ä¸ªè§£æçš„,è¿˜æ˜¯ä¸‹äº†å¾ˆå¤§çš„åŠŸå¤«.</p><p>å…ˆæ˜¯æœ‰ä¸€ä¸ªé›†åˆæ¥æ§åˆ¶æ˜¯å¦å·²ç»è§£æè¿‡äº†,ç®—æ˜¯ä¸€ç§æ˜¯å¦è§£æçš„å¼€å…³é…ç½®. å¯ä»¥çœ‹åˆ°å…¶å…ˆåçš„è§£æé¡ºåº,</p><p>namespace â€“&gt; cache-ref â€“&gt; cache â€”&gt; mapper&#x2F;parameterMap â€”&gt; mapper&#x2F;resultMap â€”&gt; mapper&#x2F;sql â€”&gt; select&#x2F;insert&#x2F;update&#x2F;detele.</p><p>å½“è§£æè¿™äº›æ ‡ç­¾çš„æ—¶å€™, åˆä¼šå¯¹æ ‡ç­¾é‡Œé¢çš„å±æ€§è¿›è¡Œè§£æ. è¿™é‡Œ,ä¸»è¦çœ‹ä¸‹æˆ‘ä»¬å¹³å¸¸ä½¿ç”¨åˆ°æœ€å¤šçš„æ ‡ç­¾, MyBatis å¯¹è¿™äº›æ ‡ç­¾è§£æäº†å,å…¶åæœ‰æ˜¯æ€ä¹ˆåˆ©ç”¨çš„å‘¢ï¼Ÿå¯ä»¥çœ‹åˆ°ç›®å‰MyBatisæ˜¯å­˜æ”¾åœ¨ä¸€äº›configurationç­‰ç±»ä¿¡æ¯é‡Œé¢,é‚£ä¹ˆç­‰åˆ°çœŸæ­£å»æŸ¥è¯¢sqlè¯­å¥çš„æ—¶å€™, MyBatis åˆæ˜¯æ€ä¹ˆç”¨ä¸Šçš„å‘¢ï¼Ÿ è¿™é‡Œç›®å‰åªè®²äº†å¦‚ä½•è§£æ.</p><p>è§£æå®Œäº†ï¼Œæ²¡å¼‚å¸¸ï¼Œé‚£å°±æ˜¯è§£æéƒ½okäº†ï¼Œå‰©ä¸‹çš„å°±æ˜¯çœ‹å½“ MyBatis å»æŸ¥è¯¢çš„æ—¶å€™, æ˜¯æ€ä¹ˆåˆ©ç”¨ä¸Šè¿™äº›èµ„æºçš„å‘¢ï¼Ÿæ‰€ä»¥çœ‹æ¥ä¸‹æ¥çš„æ›´æ–°.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;é¢˜è®°&quot;&gt;&lt;a href=&quot;#é¢˜è®°&quot; class=&quot;headerlink&quot; title=&quot;é¢˜è®°&quot;&gt;&lt;/a&gt;é¢˜è®°&lt;/h4&gt;&lt;p&gt;MyBatisæ˜¯å¦‚ä½•å¯¹ Mapper æ–‡ä»¶ä¸­çš„sqlè¿›è¡Œå¤„ç†å‘¢ï¼Ÿ è™½ç„¶ä¸Šç¯‡è§£æ mybatis-config.xml æ˜¯æœ‰è¿›è¡Œè¯´æ˜çš„, ä½†æ˜¯</summary>
      
    
    
    
    <category term="javaæ¡†æ¶" scheme="https://ruy9527.github.io/categories/java%E6%A1%86%E6%9E%B6/"/>
    
    <category term="mybatis" scheme="https://ruy9527.github.io/categories/java%E6%A1%86%E6%9E%B6/mybatis/"/>
    
    
    <category term="javaæ¡†æ¶" scheme="https://ruy9527.github.io/tags/java%E6%A1%86%E6%9E%B6/"/>
    
    <category term="mybatis" scheme="https://ruy9527.github.io/tags/mybatis/"/>
    
  </entry>
  
  <entry>
    <title>mybatisæœ¬åœ°ç¼“å­˜é˜…è¯»</title>
    <link href="https://ruy9527.github.io/2021/11/04/mybatis/mybatis%E6%9C%AC%E5%9C%B0%E7%BC%93%E5%AD%98%E9%98%85%E8%AF%BB/"/>
    <id>https://ruy9527.github.io/2021/11/04/mybatis/mybatis%E6%9C%AC%E5%9C%B0%E7%BC%93%E5%AD%98%E9%98%85%E8%AF%BB/</id>
    <published>2021-11-03T16:28:33.000Z</published>
    <updated>2022-11-04T13:46:13.919Z</updated>
    
    <content type="html"><![CDATA[<h4 id="é¢˜è®°"><a href="#é¢˜è®°" class="headerlink" title="é¢˜è®°"></a>é¢˜è®°</h4><h4 id="ç¼“å­˜è¿™ä¸ªçŸ¥è¯†ç‚¹åœ¨è®¸å¤šåœ°æ–¹éƒ½æœ‰çš„ï¼Œåˆ©ç”¨åˆ°å¥½çš„è¯ï¼Œå¯¹ç³»ç»Ÿçš„å¾ˆå¤šåœ°æ–¹æŸ¥è¯¢æ˜¯æœ‰å¾ˆå¤§çš„æå‡çš„-å¯ä»¥çœ‹åˆ°-MyBatis-ä¹Ÿæ˜¯æœ‰-cache-çš„ï¼Œé‚£MyBatis-æ˜¯æ€ä¹ˆåˆ©ç”¨è¿™ä¸ªç¼“å­˜çš„å‘¢ï¼Ÿ-åœ¨-INSERT-x2F-UPDATE-x2F-DELETE-x2F-SELECTä¸­-æ˜¯ä¸æ˜¯åªæœ‰SELECTçš„æ—¶å€™ç”¨åˆ°äº†ç¼“å­˜ï¼Œå¦‚æœæ˜¯-INSERT-x2F-UPDATE-x2F-DELETE-æ˜¯å¦ä¼šå¯¹ç¼“å­˜æœ‰å½±å“ï¼Ÿ"><a href="#ç¼“å­˜è¿™ä¸ªçŸ¥è¯†ç‚¹åœ¨è®¸å¤šåœ°æ–¹éƒ½æœ‰çš„ï¼Œåˆ©ç”¨åˆ°å¥½çš„è¯ï¼Œå¯¹ç³»ç»Ÿçš„å¾ˆå¤šåœ°æ–¹æŸ¥è¯¢æ˜¯æœ‰å¾ˆå¤§çš„æå‡çš„-å¯ä»¥çœ‹åˆ°-MyBatis-ä¹Ÿæ˜¯æœ‰-cache-çš„ï¼Œé‚£MyBatis-æ˜¯æ€ä¹ˆåˆ©ç”¨è¿™ä¸ªç¼“å­˜çš„å‘¢ï¼Ÿ-åœ¨-INSERT-x2F-UPDATE-x2F-DELETE-x2F-SELECTä¸­-æ˜¯ä¸æ˜¯åªæœ‰SELECTçš„æ—¶å€™ç”¨åˆ°äº†ç¼“å­˜ï¼Œå¦‚æœæ˜¯-INSERT-x2F-UPDATE-x2F-DELETE-æ˜¯å¦ä¼šå¯¹ç¼“å­˜æœ‰å½±å“ï¼Ÿ" class="headerlink" title="ç¼“å­˜è¿™ä¸ªçŸ¥è¯†ç‚¹åœ¨è®¸å¤šåœ°æ–¹éƒ½æœ‰çš„ï¼Œåˆ©ç”¨åˆ°å¥½çš„è¯ï¼Œå¯¹ç³»ç»Ÿçš„å¾ˆå¤šåœ°æ–¹æŸ¥è¯¢æ˜¯æœ‰å¾ˆå¤§çš„æå‡çš„. å¯ä»¥çœ‹åˆ°,MyBatis ä¹Ÿæ˜¯æœ‰ cache çš„ï¼Œé‚£MyBatis æ˜¯æ€ä¹ˆåˆ©ç”¨è¿™ä¸ªç¼“å­˜çš„å‘¢ï¼Ÿ åœ¨ INSERT&#x2F;UPDATE&#x2F;DELETE&#x2F;SELECTä¸­,æ˜¯ä¸æ˜¯åªæœ‰SELECTçš„æ—¶å€™ç”¨åˆ°äº†ç¼“å­˜ï¼Œå¦‚æœæ˜¯ INSERT&#x2F;UPDATE&#x2F;DELETE æ˜¯å¦ä¼šå¯¹ç¼“å­˜æœ‰å½±å“ï¼Ÿ"></a>ç¼“å­˜è¿™ä¸ªçŸ¥è¯†ç‚¹åœ¨è®¸å¤šåœ°æ–¹éƒ½æœ‰çš„ï¼Œåˆ©ç”¨åˆ°å¥½çš„è¯ï¼Œå¯¹ç³»ç»Ÿçš„å¾ˆå¤šåœ°æ–¹æŸ¥è¯¢æ˜¯æœ‰å¾ˆå¤§çš„æå‡çš„. å¯ä»¥çœ‹åˆ°,MyBatis ä¹Ÿæ˜¯æœ‰ cache çš„ï¼Œé‚£MyBatis æ˜¯æ€ä¹ˆåˆ©ç”¨è¿™ä¸ªç¼“å­˜çš„å‘¢ï¼Ÿ åœ¨ INSERT&#x2F;UPDATE&#x2F;DELETE&#x2F;SELECTä¸­,æ˜¯ä¸æ˜¯åªæœ‰SELECTçš„æ—¶å€™ç”¨åˆ°äº†ç¼“å­˜ï¼Œå¦‚æœæ˜¯ INSERT&#x2F;UPDATE&#x2F;DELETE æ˜¯å¦ä¼šå¯¹ç¼“å­˜æœ‰å½±å“ï¼Ÿ</h4><p> å¯ä»¥çœ‹ç»“æœæ¥åˆ†æï¼Œç„¶åè·Ÿè¿›æºç æ¥ä»”ç»†åˆ†æ.</p><p> MyBatis æ˜¯åˆ†ä¸º ä¸€çº§ç¼“å­˜ å’Œ äºŒçº§ç¼“å­˜çš„. é‚£ä¹ˆï¼Œæˆ‘ä»¬å°±å…ˆä»ä¸€çº§ç¼“å­˜å¼€å§‹.</p><h4 id="ä¸€çº§ç¼“å­˜"><a href="#ä¸€çº§ç¼“å­˜" class="headerlink" title="ä¸€çº§ç¼“å­˜"></a>ä¸€çº§ç¼“å­˜</h4><p> æ¡ˆä¾‹ä»£ç  :</p><p> è¿™é‡Œæˆ‘ä»¬æ˜¯æ‰“å°çš„æŸ¥è¯¢sqlçš„è¯­å¥ï¼Œå†ç¬¬äºŒæ¬¡å†æŸ¥è¯¢çš„æ—¶å€™ï¼Œæ˜¯</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">InputStream mybatisInputStream = Resources.getResourceAsStream(&quot;mybatis-config.xml&quot;);</span><br><span class="line"></span><br><span class="line">SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(mybatisInputStream);</span><br><span class="line">SqlSession session = sqlSessionFactory.openSession();</span><br><span class="line">BlogMapper blogMapper = session.getMapper(BlogMapper.class);</span><br><span class="line">TbBlog tbBlog = blogMapper.selectBlog(1);</span><br><span class="line">System.out.println(blogMapper.selectBlog(1));</span><br><span class="line">System.out.println(tbBlog);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// ç»“æœå¯ä»¥çœ‹åˆ°,ç¬¬äºŒæ¬¡å¹¶æ²¡æœ‰å†æ‰“å°å‡º sql è¯­å¥æ¥.</span><br><span class="line">==&gt;  Preparing: select * from tb_blog where id = ? </span><br><span class="line">==&gt; Parameters: 1(Integer)</span><br><span class="line">&lt;==    Columns: id, name</span><br><span class="line">&lt;==        Row: 1, 6565</span><br><span class="line">&lt;==      Total: 1</span><br><span class="line">TbBlog&#123;id=1, name=&#x27;6565&#x27;&#125;</span><br><span class="line">TbBlog&#123;id=1, name=&#x27;6565&#x27;&#125;</span><br></pre></td></tr></table></figure><p>æ¡ˆä¾‹äºŒ : æˆ‘ä»¬å†ç¬¬äºŒæ¬¡æŸ¥è¯¢ä¹‹å‰ åŠ å…¥ ä¸€ä¸ªadd æ–¹æ³•</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">InputStream mybatisInputStream = Resources.getResourceAsStream(&quot;mybatis-config.xml&quot;);</span><br><span class="line"></span><br><span class="line">SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(mybatisInputStream);</span><br><span class="line">SqlSession session = sqlSessionFactory.openSession();</span><br><span class="line">BlogMapper blogMapper = session.getMapper(BlogMapper.class);</span><br><span class="line">TbBlog tbBlog = blogMapper.selectBlog(1);</span><br><span class="line"></span><br><span class="line">System.out.println(blogMapper.addBlog(&quot;GavinYang&quot;));</span><br><span class="line">System.out.println(blogMapper.selectBlog(1));</span><br><span class="line">System.out.println(tbBlog);</span><br><span class="line"></span><br><span class="line">// çœ‹ç»“æœ,å¯ä»¥çœ‹åˆ°å½“ä¸­é—´ç©¿æ’ä¸€ä¸ª insert çš„sqlè¯­å¥,é‚£ä¹ˆåœ¨ç¬¬äºŒæ¬¡æŸ¥è¯¢çš„æ—¶å€™,å°±ä¼šæ‰§è¡Œsqlè¯­å¥.</span><br><span class="line">// é‚£ä¹ˆä¹Ÿå°±è¯´ï¼Œè¿™ä¸ªæ—¶å€™ç¼“å­˜æ˜¯å¤±æ•ˆäº†.</span><br><span class="line">==&gt;  Preparing: select * from tb_blog where id = ? </span><br><span class="line">==&gt; Parameters: 1(Integer)</span><br><span class="line">&lt;==    Columns: id, name</span><br><span class="line">&lt;==        Row: 1, 6565</span><br><span class="line">&lt;==      Total: 1</span><br><span class="line">==&gt;  Preparing: insert into tb_blog (name) values(?) </span><br><span class="line">==&gt; Parameters: GavinYang(String)</span><br><span class="line">&lt;==    Updates: 1</span><br><span class="line">1</span><br><span class="line">==&gt;  Preparing: select * from tb_blog where id = ? </span><br><span class="line">==&gt; Parameters: 1(Integer)</span><br><span class="line">&lt;==    Columns: id, name</span><br><span class="line">&lt;==        Row: 1, 6565</span><br><span class="line">&lt;==      Total: 1</span><br><span class="line">TbBlog&#123;id=1, name=&#x27;6565&#x27;&#125;</span><br><span class="line">TbBlog&#123;id=1, name=&#x27;6565&#x27;&#125;</span><br></pre></td></tr></table></figure><p>æ¡ˆä¾‹ä¸‰ : ä½¿ç”¨äºŒä¸ª SqlSession æ¡ˆä¾‹</p><p>å¯ä»¥å¾ˆæ˜æ˜¾çš„çœ‹åˆ° , åœ¨ç¬¬äºŒæ¬¡çš„æ—¶å€™è¿˜å‡ºç°äº†è„æ•°æ®.</p><p>è¿™é‡Œä¹Ÿå¯ä»¥çœ‹åˆ°ä¸€çº§ç¼“å­˜æ˜¯åªåœ¨ SqlSession ä¸­å­˜åœ¨çš„,ä¹Ÿå°±æ˜¯æ•°æ®åº“ä¼šè¯å†…éƒ¨å…±äº«çš„.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">InputStream mybatisInputStream = Resources.getResourceAsStream(&quot;mybatis-config.xml&quot;);</span><br><span class="line">SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(mybatisInputStream);</span><br><span class="line"></span><br><span class="line">SqlSession openSession1 = sqlSessionFactory.openSession();</span><br><span class="line">SqlSession openSession2 = sqlSessionFactory.openSession();</span><br><span class="line">BlogMapper blogMapper1 = openSession1.getMapper(BlogMapper.class);</span><br><span class="line">BlogMapper blogMapper2 = openSession2.getMapper(BlogMapper.class);</span><br><span class="line"></span><br><span class="line">System.out.println(&quot;blogMapper1 è¯»å–æ•°æ® &quot; + blogMapper1.selectBlog(1));</span><br><span class="line">System.out.println(&quot;blogMapper2 è¯»å–æ•°æ®&quot; + blogMapper2.selectBlog(1));</span><br><span class="line"></span><br><span class="line">System.out.println(blogMapper1.updateHashCode(&quot;PeterWong&quot;));</span><br><span class="line"></span><br><span class="line">System.out.println(&quot;blogMapper1 è¯»å–æ•°æ® &quot; + blogMapper1.selectBlog(1));</span><br><span class="line">System.out.println(&quot;blogMapper2 è¯»å–æ•°æ®&quot; + blogMapper2.selectBlog(1));</span><br><span class="line"></span><br><span class="line">// ç„¶åæˆ‘ä»¬å¯ä»¥çœ‹åˆ° log æ‰“å°å‡ºæ¥çš„å†…å®¹</span><br><span class="line">==&gt;  Preparing: select * from tb_blog where id = ? </span><br><span class="line">==&gt; Parameters: 1(Integer)</span><br><span class="line">&lt;==    Columns: id, name</span><br><span class="line">&lt;==        Row: 1, 6565</span><br><span class="line">&lt;==      Total: 1</span><br><span class="line">blogMapper1 è¯»å–æ•°æ® TbBlog&#123;id=1, name=&#x27;6565&#x27;&#125;</span><br><span class="line">Created connection 433287555.</span><br><span class="line">Setting autocommit to false on JDBC Connection [com.mysql.jdbc.JDBC4Connection@19d37183]</span><br><span class="line">==&gt;  Preparing: select * from tb_blog where id = ? </span><br><span class="line">==&gt; Parameters: 1(Integer)</span><br><span class="line">&lt;==    Columns: id, name</span><br><span class="line">&lt;==        Row: 1, 6565</span><br><span class="line">&lt;==      Total: 1</span><br><span class="line">blogMapper2 è¯»å–æ•°æ®TbBlog&#123;id=1, name=&#x27;6565&#x27;&#125;</span><br><span class="line">==&gt;  Preparing: update tb_blog set name = ? where id = 1; </span><br><span class="line">==&gt; Parameters: PeterWong(String)</span><br><span class="line">&lt;==    Updates: 1</span><br><span class="line">1</span><br><span class="line">==&gt;  Preparing: select * from tb_blog where id = ? </span><br><span class="line">==&gt; Parameters: 1(Integer)</span><br><span class="line">&lt;==    Columns: id, name</span><br><span class="line">&lt;==        Row: 1, PeterWong</span><br><span class="line">&lt;==      Total: 1</span><br><span class="line">blogMapper1 è¯»å–æ•°æ® TbBlog&#123;id=1, name=&#x27;PeterWong&#x27;&#125;</span><br><span class="line">blogMapper2 è¯»å–æ•°æ®TbBlog&#123;id=1, name=&#x27;6565&#x27;&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬è¯´äº†ä¸‰é¢çš„è¿™ä¸‰ç§æƒ…å†µ, å…·ä½“çš„æ‰§è¡Œæµç¨‹å¯ä»¥æˆ‘ä»¬å¯ä»¥ç°åœ¨ æ¡ˆä¾‹ä¸€é‡Œé¢å¯¹ç¬¬äºŒæ¬¡ query è¿›è¡Œ debug åˆ†ææ“ä½œ. å½“æˆ‘ä»¬debugåˆ° org.apache.ibatis.executor.BaseExecutor#query(org.apache.ibatis.mapping.MappedStatement, java.lang.Object, org.apache.ibatis.session.RowBounds, org.apache.ibatis.session.ResultHandler, org.apache.ibatis.cache.CacheKey, org.apache.ibatis.mapping.BoundSql) çš„æ—¶å€™ï¼Œå¯ä»¥çœ‹åˆ° org.apache.ibatis.executor.BaseExecutor#localCache åªæœ‰ä¸€ä¸ª ç¼“å­˜çš„å€¼çš„ ï¼Œ æ ¹æ® getObject æ–¹æ³•å¯ä»¥è·Ÿè¿›åˆ° org.apache.ibatis.cache.impl.PerpetualCache#cache ä¸­æ¥,</p><p>ä¼ å…¥è¿›æ¥çš„ key å€¼æ˜¯ : -1896651191:1062027004:com.iyang.mybatis.mapper.BlogMapper.selectBlog:0:2147483647:select * from tb_blog where id &#x3D; ?:1:development ç„¶åä» cache ä¸­è·å–å‡ºå€¼æ¥, æ‰€ä»¥è¿™é‡Œå°±æ²¡æœ‰èµ° query çš„æŸ¥è¯¢è¯­å¥.</p><p>è¿™æ˜¯å‘½ä¸­ç¼“å­˜çš„æƒ…å†µ.</p><p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸‹, åœ¨ç¬¬äºŒæ¬¡ query ä¹‹å‰å¦‚æœæ‰§è¡Œäº†ä¸€ä¸ª add æ–¹æ³•ï¼Œä¸ºä»€ä¹ˆå°±å‘½ä¸­ä¸äº†äº†å‘¢ï¼Ÿ</p><p>è¿™é‡Œå¯ä»¥å¤§è‡´çŒœæµ‹ä¸‹ï¼Œåœ¨æ‰§è¡Œå®Œ add æ–¹æ³•åï¼Œæ˜¯ä¸æ˜¯ç»™ cache ç»™æ¸…é™¤æ‰äº†ï¼Œç„¶åå†å»æŸ¥è¯¢çš„æ—¶å€™ï¼Œå°±æŸ¥è¯¢ä¸åˆ°äº†.</p><p>äºæ˜¯æˆ‘ä»¬åœ¨ add æ–¹æ³•ä¸Šè¿›è¡Œ debug æŸ¥çœ‹ä¸‹ :</p><p>æœ€åæˆ‘ä»¬ debug è·Ÿè¿›åˆ°è¿™é‡Œ : org.apache.ibatis.executor.BaseExecutor#clearLocalCache å°±å¯ä»¥å‘ç°</p><p>è¿™é‡Œæ˜¯æœ‰äºŒä¸ª clear æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯æ¸…é™¤æ–¹æ³•.</p><p>localCache.clear() â€”-&gt; org.apache.ibatis.cache.impl.PerpetualCache#clear å¯¹åº”çš„å°±æ˜¯è¿™é‡Œçš„æ¸…æ¥šæ–¹æ³•ï¼Œç›´æ¥è°ƒç”¨ HashMap çš„clear æ–¹æ³•è¿›è¡Œæ¸…é™¤.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">localCache.clear();</span><br><span class="line">localOutputParameterCache.clear();</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥è¿™é‡Œå¯ä»¥çœ‹å‡ºåœ¨ç¬¬äºŒæ¬¡è°ƒç”¨ query ä¹‹å‰ï¼Œå¦‚æœæ˜¯æœ‰ insert&#x2F;update&#x2F;delete ç­‰æ–¹æ³•çš„è¯ï¼Œå°±ä¼šå»é‡ç½®è¿™äºŒä¸ªåœ°æ–¹çš„ç¼“å­˜çš„.</p><p>MyBatis çš„ä¸€çº§ç¼“å­˜çš„æ˜¯è·Ÿéš SqlSession çš„ï¼Œè¿™é‡Œæ˜¯å¯ä»¥æ ¹æ®ç®€å•çš„æ¡ˆä¾‹æ•ˆæœçœ‹å‡ºæ¥çš„.</p><p>ä¸€çº§ç¼“å­˜åªæ˜¯ä½¿ç”¨äº†ä¸€ä¸ª HashMap , æœ€åæ¸…é™¤ç¼“å­˜çš„æ—¶å€™ï¼Œä¹Ÿæ˜¯è°ƒç”¨ HashMap çš„clear æ–¹æ³•</p><p>æœ€åä»æ¡ˆä¾‹ä¸‰å¯ä»¥çœ‹å‡ºæ¥ï¼Œå½“å¤šä¸ª SqlSession çš„æ—¶å€™ï¼Œç”±äºå„è‡ªæœ‰å­˜æœ‰å„è‡ªçš„ç¼“å­˜ï¼Œæ‰€ä»¥æ˜¯å¾ˆå®¹æ˜“å¼•èµ·è„æ•°æ®çš„, å°†ç¼“å­˜çº§åˆ«è®¾ç½®ä¸º Statement.</p><h4 id="äºŒçº§ç¼“å­˜"><a href="#äºŒçº§ç¼“å­˜" class="headerlink" title="äºŒçº§ç¼“å­˜"></a>äºŒçº§ç¼“å­˜</h4><p> å¯ä»¥çœ‹åˆ°ä¸€çº§ç¼“å­˜çš„è¯ï¼Œæ˜¯å±€é™äº SqlSession . å¦‚æœè¦å¤šä¸ª sqlSession ä¹‹é—´å…±äº«ç¼“å­˜çš„è¯ï¼Œå°±éœ€è¦å¼€å¯äºŒçº§ç¼“å­˜. å¼€å¯çš„è¯,æˆ‘ä»¬åœ¨ MyBatis é…ç½®æ–‡ä»¶ä¸­åŠ ä¸Š:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;settings&gt;</span><br><span class="line">    &lt;setting name=&quot;logImpl&quot; value=&quot;STDOUT_LOGGING&quot;/&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- å¼€å¯äºŒçº§ç¼“å­˜ --&gt;</span><br><span class="line">    &lt;setting name=&quot;cacheEnabled&quot; value=&quot;true&quot;/&gt;</span><br><span class="line">&lt;/settings&gt;</span><br></pre></td></tr></table></figure><p> <strong>æ¡ˆä¾‹ä¸€ : æ˜¯å¦æäº¤äº‹åŠ¡</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String[] args) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">    InputStream mybatisInputStream = Resources.getResourceAsStream(&quot;mybatis-config.xml&quot;);</span><br><span class="line">    SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(mybatisInputStream);</span><br><span class="line">    SqlSession sqlSession1 = sqlSessionFactory.openSession(true);</span><br><span class="line">    SqlSession sqlSession2 = sqlSessionFactory.openSession(true);</span><br><span class="line"></span><br><span class="line">    BlogMapper blogMapper1 = sqlSession1.getMapper(BlogMapper.class);</span><br><span class="line">    BlogMapper blogMapper2 = sqlSession2.getMapper(BlogMapper.class);</span><br><span class="line"></span><br><span class="line">    System.out.println(&quot;blogMapper1 è·å–æ•°æ®&quot; + blogMapper1.selectBlog(1));</span><br><span class="line">    </span><br><span class="line">    // sqlSession1.commit();</span><br><span class="line">    </span><br><span class="line">    System.out.println(&quot;blogMapper2 è·å–æ•°æ®&quot; + blogMapper2.selectBlog(1));</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//   ----------------   trueç»“æœ   -----------------------</span><br><span class="line"></span><br><span class="line">Created connection 492079624.</span><br><span class="line">==&gt;  Preparing: select * from tb_blog where id = ? </span><br><span class="line">==&gt; Parameters: 1(Integer)</span><br><span class="line">&lt;==    Columns: id, name</span><br><span class="line">&lt;==        Row: 1, 6565</span><br><span class="line">&lt;==      Total: 1</span><br><span class="line">blogMapper1 è·å–æ•°æ®TbBlog&#123;id=1, name=&#x27;6565&#x27;&#125;</span><br><span class="line">Opening JDBC Connection</span><br><span class="line">    </span><br><span class="line">Created connection 433287555.</span><br><span class="line">==&gt;  Preparing: select * from tb_blog where id = ? </span><br><span class="line">==&gt; Parameters: 1(Integer)</span><br><span class="line">&lt;==    Columns: id, name</span><br><span class="line">&lt;==        Row: 1, 6565</span><br><span class="line">&lt;==      Total: 1</span><br><span class="line">blogMapper2 è·å–æ•°æ®TbBlog&#123;id=1, name=&#x27;6565&#x27;&#125;    </span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">// ------------   åŠ ä¸Šcommit()æ–¹æ³•ç»“æœ   ---------------</span><br><span class="line"></span><br><span class="line">Created connection 630074945.</span><br><span class="line">==&gt;  Preparing: select * from tb_blog where id = ? </span><br><span class="line">==&gt; Parameters: 1(Integer)</span><br><span class="line">&lt;==    Columns: id, name</span><br><span class="line">&lt;==        Row: 1, 6565</span><br><span class="line">&lt;==      Total: 1</span><br><span class="line">blogMapper1 è·å–æ•°æ®TbBlog&#123;id=1, name=&#x27;6565&#x27;&#125;</span><br><span class="line">Cache Hit Ratio [com.iyang.mybatis.mapper.BlogMapper]: 0.5</span><br><span class="line">blogMapper2 è·å–æ•°æ®TbBlog&#123;id=1, name=&#x27;6565&#x27;&#125;</span><br></pre></td></tr></table></figure><p> ä»è¿™é‡Œçœ‹, æ˜¯å¦æäº¤äº‹åŠ¡å¯ä»¥çœ‹å‡ºæ¥ï¼Œæ˜¯ä¼šå½±å“äºŒçº§ç¼“å­˜çš„.</p><p><strong>æ¡ˆä¾‹äºŒ : ä¸­é—´ç©¿æ’æ›´æ–°è¯­å¥</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String[] args)  throws Exception &#123;</span><br><span class="line"></span><br><span class="line">    InputStream mybatisInputStream = Resources.getResourceAsStream(&quot;mybatis-config.xml&quot;);</span><br><span class="line">    SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(mybatisInputStream);</span><br><span class="line">    SqlSession sqlSession1 = sqlSessionFactory.openSession(false);</span><br><span class="line">    SqlSession sqlSession2 = sqlSessionFactory.openSession(false);</span><br><span class="line">    SqlSession sqlSession3 = sqlSessionFactory.openSession(false);</span><br><span class="line"></span><br><span class="line">    BlogMapper blogMapper1 = sqlSession1.getMapper(BlogMapper.class);</span><br><span class="line">    BlogMapper blogMapper2 = sqlSession2.getMapper(BlogMapper.class);</span><br><span class="line">    BlogMapper blogMapper3 = sqlSession3.getMapper(BlogMapper.class);</span><br><span class="line"></span><br><span class="line">    System.out.println(&quot; blogMapper1 æŸ¥è¯¢å‡ºæ¥çš„æ•°æ® : &quot; + blogMapper1.selectBlog(1));</span><br><span class="line">    sqlSession1.commit();</span><br><span class="line"></span><br><span class="line">    System.out.println(&quot; blogMapper2 æŸ¥è¯¢å‡ºæ¥çš„ç»“æœ : &quot; + blogMapper2.selectBlog(1));</span><br><span class="line"></span><br><span class="line">    System.out.println(blogMapper3.updateHashCode(&quot;GavinYang&quot;));</span><br><span class="line">    sqlSession3.commit();</span><br><span class="line"></span><br><span class="line">    System.out.println(&quot; blogMapper2 æŸ¥è¯¢å‡ºæ¥çš„ç»“æœ : &quot; + blogMapper2.selectBlog(1));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//  ------------------  æ‰“å°ç»“æœ ------</span><br><span class="line"></span><br><span class="line">Created connection 630074945.</span><br><span class="line">Setting autocommit to false on JDBC Connection [com.mysql.jdbc.JDBC4Connection@258e2e41]</span><br><span class="line">==&gt;  Preparing: select * from tb_blog where id = ? </span><br><span class="line">==&gt; Parameters: 1(Integer)</span><br><span class="line">&lt;==    Columns: id, name</span><br><span class="line">&lt;==        Row: 1, 6565</span><br><span class="line">&lt;==      Total: 1</span><br><span class="line"> blogMapper1 æŸ¥è¯¢å‡ºæ¥çš„æ•°æ® : TbBlog&#123;id=1, name=&#x27;6565&#x27;&#125;</span><br><span class="line">Cache Hit Ratio [com.iyang.mybatis.mapper.BlogMapper]: 0.5</span><br><span class="line"> blogMapper2 æŸ¥è¯¢å‡ºæ¥çš„ç»“æœ : TbBlog&#123;id=1, name=&#x27;6565&#x27;&#125;</span><br><span class="line"></span><br><span class="line">Created connection 603443293.</span><br><span class="line">Setting autocommit to false on JDBC Connection [com.mysql.jdbc.JDBC4Connection@23f7d05d]</span><br><span class="line">==&gt;  Preparing: update tb_blog set name = ? where id = 1; </span><br><span class="line">==&gt; Parameters: GavinYang(String)</span><br><span class="line">&lt;==    Updates: 1</span><br><span class="line">1</span><br><span class="line">Committing JDBC Connection [com.mysql.jdbc.JDBC4Connection@23f7d05d]</span><br><span class="line">Cache Hit Ratio [com.iyang.mybatis.mapper.BlogMapper]: 0.3333333333333333</span><br><span class="line">Opening JDBC Connection</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">Created connection 707976812.</span><br><span class="line">Setting autocommit to false on JDBC Connection [com.mysql.jdbc.JDBC4Connection@2a32de6c]</span><br><span class="line">==&gt;  Preparing: select * from tb_blog where id = ? </span><br><span class="line">==&gt; Parameters: 1(Integer)</span><br><span class="line">&lt;==    Columns: id, name</span><br><span class="line">&lt;==        Row: 1, GavinYang</span><br><span class="line">&lt;==      Total: 1</span><br><span class="line"> blogMapper2 æŸ¥è¯¢å‡ºæ¥çš„ç»“æœ : TbBlog&#123;id=1, name=&#x27;GavinYang&#x27;&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ˜¯å¯ä»¥çœ‹åˆ°åœ¨æ›´æ–°ä¹‹åå¹¶ä¸” commit äº†äº‹åŠ¡ä¹‹åï¼Œåé¢ç´§è·Ÿçš„ sql æ˜¯å»æŸ¥è¯¢ æ•°æ®åº“äº†çš„. æ‰€ä»¥è¿™é‡Œæ˜¯å¯ä»¥çœ‹å‡ºæ¥ï¼Œupdateç­‰æ“ä½œæ˜¯ä¼šå» æ¸…ç©ºå¯¹åº”çš„ç¼“å­˜çš„ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬æ ¹æ® æ¡ˆä¾‹ä¸€ çš„æƒ…å†µæ¥åˆ†æï¼Œåœ¨å¼€å¯äº† äºŒçº§ç¼“å­˜ çš„æ—¶å€™ï¼Œæ˜¯ä»å“ªé‡Œè·å–å‡ºæ¥çš„æ•°æ®çš„å‘¢ï¼Ÿ</p><p>debug è·Ÿè¿›æ¥ : org.apache.ibatis.executor.CachingExecutor#query(org.apache.ibatis.mapping.MappedStatement, java.lang.Object, org.apache.ibatis.session.RowBounds, org.apache.ibatis.session.ResultHandler, org.apache.ibatis.cache.CacheKey, org.apache.ibatis.mapping.BoundSql)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public &lt;E&gt; List&lt;E&gt; query(MappedStatement ms, Object parameterObject, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql)</span><br><span class="line">    throws SQLException &#123;</span><br><span class="line">  Cache cache = ms.getCache();</span><br><span class="line">  if (cache != null) &#123;</span><br><span class="line">    flushCacheIfRequired(ms);</span><br><span class="line">    if (ms.isUseCache() &amp;&amp; resultHandler == null) &#123;</span><br><span class="line">      ensureNoOutParams(ms, boundSql);</span><br><span class="line">      @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">// debug åˆ°è¿™é‡Œï¼Œå¯ä»¥çœ‹åˆ°,å°±å·²ç»è¿”å›äº†æˆ‘ä»¬éœ€è¦çš„æ•°æ®.        </span><br><span class="line">      List&lt;E&gt; list = (List&lt;E&gt;) tcm.getObject(cache, key);</span><br><span class="line">      if (list == null) &#123;</span><br><span class="line">        list = delegate.query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);</span><br><span class="line">        tcm.putObject(cache, key, list); // issue #578 and #116</span><br><span class="line">      &#125;</span><br><span class="line">      return list;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return delegate.query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>org.apache.ibatis.executor.CachingExecutor#tcm è°ƒç”¨è¿™ä¸ªå¯¹è±¡çš„ getObject æ–¹æ³•è·å–åˆ°äº†æˆ‘ä»¬éœ€è¦çš„å€¼, è·Ÿè¿›æ¥åˆä» org.apache.ibatis.cache.decorators.TransactionalCache çš„ getObject è·å–å‡ºæˆ‘ä»¬çš„å€¼, æœ€åä» org.apache.ibatis.cache.decorators.TransactionalCache#delegate è·å–å‡ºå€¼, è¿”å›å›æ¥çš„.</p><p>org.apache.ibatis.cache.decorators.TransactionalCache#getObject</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Object getObject(Object key) &#123;</span><br><span class="line">  // issue #116</span><br><span class="line">// ä»ç¼“å­˜ä¸­è·å–å‡ºå€¼.    </span><br><span class="line">  Object object = delegate.getObject(key);</span><br><span class="line">  if (object == null) &#123;</span><br><span class="line">// å¦‚æœè·å–å‡ºæ¥æ˜¯null,ä¹Ÿå°±æ˜¯ç¼“å­˜ä¸­æ²¡æœ‰çš„è¯,org.apache.ibatis.cache.decorators.TransactionalCache#entriesMissedInCache å°±æ·»åŠ åˆ°è¿™ä¸ªé›†åˆä¸­æ¥.      </span><br><span class="line">    entriesMissedInCache.add(key);</span><br><span class="line">  &#125;</span><br><span class="line">  // issue #146</span><br><span class="line">// commit åéœ€è¦ clear çš„è¯ï¼Œå°±ä¼šè¿”å› null.</span><br><span class="line">// è¿™é‡Œæƒ³ä¸‹è¿™ä¸ªå˜é‡ä¼šä¸ä¼šå’Œæˆ‘é—¨æ¡ˆä¾‹äºŒä¸­çš„ update æ“ä½œæœ‰å…³ç³»å‘¢ï¼Ÿ</span><br><span class="line">// è¿™é‡Œå† updateåå† debug å‘ç°,  delegate ä¸­è·å–å‡ºæ¥çš„æ˜¯ null ,ä¹Ÿå°±æ˜¯ç¡®å®æ˜¯è·å–ä¸åˆ°ç¼“å­˜äº†</span><br><span class="line">// å’Œè¿™ä¸ªå‚æ•°æ²¡å…³ç³».    </span><br><span class="line">  if (clearOnCommit) &#123;</span><br><span class="line">    return null;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    return object;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>MyBatis äºŒçº§ç¼“å­˜ä¸é€‚åº”äºé…ç½®æ–‡ä»¶ä¸­å­˜åœ¨å¤šè¡¨æŸ¥è¯¢çš„æƒ…å†µ. ä¸€èˆ¬æˆ‘ä»¬æ˜¯å•è¡¨çš„ cache, ç”±äº mybatis çš„äºŒçº§ç¼“å­˜æ˜¯åŸºäº namespace çš„, å¤šè¡¨æŸ¥è¯¢è¯­å¥æ‰€åœ¨çš„ namespace æ— æ³•æ„Ÿåº”åˆ°å…¶ä»–çš„ namespace ä¸­çš„è¯­å¥å¯¹å¤šè¡¨ä¸­è®¾è®¡ä¿®æ”¹ï¼Œå°±ä¼šå¼•å‘è„æ•°æ®. è¿™ä¸ªæ—¶å€™ï¼Œå¯ä»¥é‡‡ç”¨ cache-ref æ¥åšå¤„ç†ï¼Œä½†æ˜¯è¿™æ ·çš„è¯,ç¼“å­˜çš„é¢—ç²’åº¦å°±å˜ç²—äº†.</p><p>æ‰§è¡Œæµç¨‹ : å¦‚æœå¼€å¯äº†äºŒçº§ç¼“å­˜çš„è¯ï¼Œ MyBatis ä¼šå…ˆèµ°äºŒçº§ç¼“å­˜ï¼Œå¦‚æœäºŒçº§ç¼“å­˜æ²¡æœ‰çš„è¯ï¼Œå°±ä¼šå»ä¸€çº§ç¼“å­˜çœ‹çœ‹ï¼Œå¦‚æœéƒ½æ²¡æœ‰çš„è¯ï¼Œå°±å»æŸ¥è¯¢æ•°æ®åº“.</p><p>äºŒçº§ç¼“å­˜ : ç”¨ org.apache.ibatis.executor.CachingExecutor è£…é¥°äº† org.apache.ibatis.executor.BaseExecutor çš„å­ç±», å§”æ‰˜å…·ä½“èŒè´£ç»™ delegate ä¹‹å‰ï¼Œå®ç°äº†äºŒçº§ç¼“å­˜çš„æŸ¥è¯¢å’Œå†™å…¥åŠŸèƒ½.</p><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>æœ€åçœ‹ ä¸€çº§ç¼“å­˜å’ŒäºŒçº§ç¼“å­˜ï¼Œéƒ½æ˜¯åˆ©ç”¨çš„ HashMap è¿™ç§æ¥åšåˆ°æœ¬åœ°ç¼“å­˜ï¼Œ åªæ˜¯äºŒçº§ç¼“å­˜çš„ä½œç”¨èŒƒå›´æ¯”èµ·ä¸€çº§ç¼“å­˜çš„è¯ï¼Œæ˜¯è¦å¤§çš„ï¼Œå¹¶ä¸”ä¹Ÿåˆ©ç”¨äº†ä¸€äº› è£…é¥°è€… ç­‰è®¾è®¡æ¨¡å¼æ¥è®¾è®¡äºŒçº§ç¼“å­˜çš„.</p><p>å¦‚æœæ˜¯éƒ¨ç½²çš„åˆ†å¸ƒå¼é¡¹ç›®çš„è¯ï¼Œé‚£ä¹ˆè¿˜æ˜¯ å¾—åˆ‡æ¢åˆ° redis è¿™ç§ç¼“å­˜æ¥äº†ï¼Œ æœ¬åœ°åˆ©ç”¨ HashMap è¿™ç§ç¼“å­˜æ»¡è¶³ä¸äº†çš„.</p><p>æ–‡çŒ®å‚è€ƒåœ°å€ : <a href="https://tech.meituan.com/2018/01/19/mybatis-cache.html">https://tech.meituan.com/2018/01/19/mybatis-cache.html</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;é¢˜è®°&quot;&gt;&lt;a href=&quot;#é¢˜è®°&quot; class=&quot;headerlink&quot; title=&quot;é¢˜è®°&quot;&gt;&lt;/a&gt;é¢˜è®°&lt;/h4&gt;&lt;h4 id=&quot;ç¼“å­˜è¿™ä¸ªçŸ¥è¯†ç‚¹åœ¨è®¸å¤šåœ°æ–¹éƒ½æœ‰çš„ï¼Œåˆ©ç”¨åˆ°å¥½çš„è¯ï¼Œå¯¹ç³»ç»Ÿçš„å¾ˆå¤šåœ°æ–¹æŸ¥è¯¢æ˜¯æœ‰å¾ˆå¤§çš„æå‡çš„-å¯ä»¥çœ‹åˆ°-MyBatis-ä¹Ÿæ˜¯æœ‰-cache-</summary>
      
    
    
    
    <category term="javaæ¡†æ¶" scheme="https://ruy9527.github.io/categories/java%E6%A1%86%E6%9E%B6/"/>
    
    <category term="mybatis" scheme="https://ruy9527.github.io/categories/java%E6%A1%86%E6%9E%B6/mybatis/"/>
    
    
    <category term="javaæ¡†æ¶" scheme="https://ruy9527.github.io/tags/java%E6%A1%86%E6%9E%B6/"/>
    
    <category term="mybatis" scheme="https://ruy9527.github.io/tags/mybatis/"/>
    
  </entry>
  
  <entry>
    <title>mybatisä¸­config-xmlä»£ç é˜…è¯»</title>
    <link href="https://ruy9527.github.io/2021/11/04/mybatis/mybatis%E4%B8%ADconfig-xml%E4%BB%A3%E7%A0%81%E9%98%85%E8%AF%BB/"/>
    <id>https://ruy9527.github.io/2021/11/04/mybatis/mybatis%E4%B8%ADconfig-xml%E4%BB%A3%E7%A0%81%E9%98%85%E8%AF%BB/</id>
    <published>2021-11-03T16:28:20.000Z</published>
    <updated>2022-11-04T13:46:13.918Z</updated>
    
    <content type="html"><![CDATA[<h4 id="é¢˜è®°"><a href="#é¢˜è®°" class="headerlink" title="é¢˜è®°"></a>é¢˜è®°</h4><p>å¯¹äºé…ç½®æ–‡ä»¶çš„è§£æ, è¿˜æ˜¯ç›¸å¯¹æ¯”è¾ƒå¥½ç†è§£çš„, å°±æ˜¯è¯»å–é…ç½®æ–‡ä»¶, ç„¶ååœ¨ä»£ç éœ€è¦çš„åœ°æ–¹ç»™ä½¿ç”¨åˆ°.</p><p>è¿™é‡Œ,å¯ä»¥æ‰©å±•ä¸‹, Spring &#x2F; SpringBoot ç­‰æ˜¯æ€ä¹ˆè¯»å–é…ç½®æ–‡ä»¶å‘¢ ? å¹¶ä¸”é…ç½®æ–‡ä»¶è¿˜æ˜¯æœ‰ xml &#x2F; properties&#x2F;yaml ç­‰æ ¼å¼çš„ ï¼Œ å…¶è¯»å–ä»£ç æ˜¯æ€ä¹ˆå†™çš„ ? ç„¶ååŸºäº é˜¿æ³¢ç½—(æºç¨‹å¼€æº) çš„é…ç½®ä¸­å¿ƒ , å…¶å®ç°é…ç½®åˆæ˜¯æ€ä¹ˆå®ç°çš„å‘¢ ? ç„¶åè¿™é‡Œï¼Œçœ‹äº† Mybatis è¯»å–é…ç½®æ–‡ä»¶, åç»­å†å‡º Spring é…ç½®æ–‡ä»¶çš„æ—¶å€™ï¼Œå¦‚æœäºŒè€…è¯»å–é…ç½®è¿›è¡Œå¯¹æ¯”, ä½ ä¸ªäººæ›´å€¾å‘ä½¿ç”¨ä»£ç å‘¢ ?</p><p>æ‰€ä»¥,è¿™é‡Œå°±å¼€å¯è¯»å– Mybatis æ˜¯å¦‚ä½•è§£æé…ç½®æ–‡ä»¶çš„æ“ä½œ.</p><h4 id="é…ç½®æ–‡ä»¶"><a href="#é…ç½®æ–‡ä»¶" class="headerlink" title="é…ç½®æ–‡ä»¶"></a>é…ç½®æ–‡ä»¶</h4><p>è¿™é‡Œçš„é…ç½®æ–‡ä»¶è§£è¯»,æ˜¯æ ¹æ® MyBatiså®˜ç½‘æ¥ä¸€æ­¥ä¸€æ­¥çš„è§£æé˜…è¯». å¦‚æœæœ‰å®˜ç½‘æ²¡æœ‰æ¶‰åŠåˆ°çš„,å‘ç°äº†ä¹Ÿä¼šåœ¨åç»­åŠ ä¸Šå»çš„. è§£æå¤šè¡Œä»£ç , æ‰èƒ½ç†è§£ ä½•ä¸ºä¼˜ç§€.</p><p><strong>æ ‡ç­¾ä¸€ : properties</strong></p><p>org.apache.ibatis.builder.xml.XMLConfigBuilder#parseConfiguration â€”&gt; propertiesElement(root.evalNode(â€œpropertiesâ€)) æ–¹æ³•ä¸­æ¥.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">// è¿™é‡Œä¼ å…¥è¿›æ¥çš„ XNode çš„å€¼,å°±æ˜¯æˆ‘ä»¬å†™çš„ properties æ ‡ç­¾.</span><br><span class="line">// å¯ä»¥çœ‹åˆ° XNodeçš„å±æ€§,nameæ ‡ç­¾çš„åå­—,attributeså°±æ˜¯key/valueå±æ€§</span><br><span class="line">// æ¯”å¦‚è¿™é‡Œ: key å°±æ˜¯ resource , value å°±æ˜¯ ./db.properties.</span><br><span class="line">private void propertiesElement(XNode context) throws Exception &#123;</span><br><span class="line">  if (context != null) &#123;</span><br><span class="line">// è¿™é‡Œè°ƒç”¨çš„node.getChildNodes(),å¦‚æœæœ‰ç‚¹è¯,ä¼šéå†æŒ¨ä¸ªè§£æ,æœ€åå°è£…æˆä¸ºkey/valueç»“æ„.      </span><br><span class="line">    Properties defaults = context.getChildrenAsProperties();</span><br><span class="line">// è·å– resource / url äºŒè€…çš„å€¼.      </span><br><span class="line">    String resource = context.getStringAttribute(&quot;resource&quot;);</span><br><span class="line">    String url = context.getStringAttribute(&quot;url&quot;);</span><br><span class="line">// å¦‚æœäºŒè€…éƒ½æ˜¯null,å°±ä¼šæŠ›å‡ºå¼‚å¸¸æ¥.      </span><br><span class="line">    if (resource != null &amp;&amp; url != null) &#123;</span><br><span class="line">      throw new BuilderException(&quot;The properties element cannot specify both a URL and a resource based property file reference.  Please specify one or the other.&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">      </span><br><span class="line"> // è¿™é‡Œå…ˆå¤„ç†resource,å†å¤„ç†url,ä¹Ÿå°±æ˜¯æœ‰å¯èƒ½urlä¼šè¦†ç›–æ‰resourceçš„å†…å®¹.</span><br><span class="line"> // äºŒè€…è¯»å–çš„æ–¹å¼ä¸ä¸€æ ·,å‰è€…æ˜¯æ ¹æ® resourceå¼€å§‹è¯»,urlæ˜¯æ ¹æ®ç»å¯¹è·¯å¾„å¼€å§‹è¯».</span><br><span class="line"> // æœ€å defaults é‡Œé¢æ”¾å…¥çš„å…¨éƒ¨æ˜¯ key/value å¯¹åº”çš„é”®å€¼å¯¹</span><br><span class="line"> // ä¹Ÿå°±æ˜¯db.propertiesä¸­çš„ key / value ç›¸å¯¹åº”ièµ·æ¥.     </span><br><span class="line">    if (resource != null) &#123;</span><br><span class="line">      defaults.putAll(Resources.getResourceAsProperties(resource));</span><br><span class="line">    &#125; else if (url != null) &#123;</span><br><span class="line">      defaults.putAll(Resources.getUrlAsProperties(url));</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">// è¿™é‡Œçœ‹çš„æ˜¯ xml é‡Œé¢æ˜¯ä¸æ˜¯ç›´æ¥æœ‰ porperties é…ç½®.     </span><br><span class="line">// å¦‚æœæœ‰çš„è¯,å°±ä¼šputAllè¿›å».      </span><br><span class="line">    Properties vars = configuration.getVariables();</span><br><span class="line">    if (vars != null) &#123;</span><br><span class="line">      defaults.putAll(vars);</span><br><span class="line">    &#125;</span><br><span class="line">// æœ€åå§ defaults,ä¹Ÿå°±æ˜¯propertiesç»™æ”¾å…¥åˆ° BaseBuilder å’Œ Confifurationä¸­å».      </span><br><span class="line">    parser.setVariables(defaults);</span><br><span class="line">    configuration.setVariables(defaults);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-----------------------------</span><br><span class="line">//  å¦‚ä½•è®© Properties vars = configuration.getVariables(); æœ‰å€¼å‘¢ ?</span><br><span class="line">//  å¦‚æœåªæ˜¯å•ä¸ªçš„ MyBatis é¡¹ç›®çš„è¯, å°±è‡ªå·±æ‰‹åŠ¨newä¸€ä¸ªpropertieså¯¹è±¡</span><br><span class="line">//  ç„¶åkeyè¾“å…¥è‡ªå·±è¦è¦†ç›–æ‰çš„keyå°±å¯ä»¥äº†</span><br><span class="line">        Properties dbConfigProperties = new Properties();</span><br><span class="line">        dbConfigProperties.setProperty(&quot;jdbc.password&quot;,&quot;GavinYang&quot;);</span><br><span class="line"></span><br><span class="line">        SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(mybatisInputStream,dbConfigProperties);</span><br></pre></td></tr></table></figure><p><strong>æ ‡ç­¾äºŒ : settings</strong></p><p>è¿™æ˜¯ MyBatiså¯¹ settings çš„æ“ä½œ.</p><p>å…·ä½“çš„ settings ä¸­æ¯é¡¹é…ç½®å‚è€ƒå®˜ç½‘é“¾æ¥ : <a href="https://mybatis.org/mybatis-3/configuration.html#properties">https://mybatis.org/mybatis-3/configuration.html#properties</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// è§£æ setting ---&gt; è½¬åŒ–ä¸º key /value</span><br><span class="line">Properties settings = settingsAsProperties(root.evalNode(&quot;settings&quot;));</span><br><span class="line">// </span><br><span class="line">loadCustomVfs(settings);</span><br><span class="line">loadCustomLogImpl(settings);</span><br></pre></td></tr></table></figure><p>settingsAsProperties æ–¹æ³•</p><p>å¯ä»¥çœ‹åˆ°, è¯¥æ–¹æ³•å°±æ˜¯è¿›è¡ŒåŠ è½½,è½¬åŒ–ä¸ºkey&#x2F;valueé”®å€¼å¯¹ç±»å‹, ç„¶åå¯¹å…¶keyæ£€éªŒæ˜¯å¦åœ¨</p><p>Configuration ä¸­éƒ½æœ‰ set æ–¹æ³•.</p><p>Notes : ä¸ºäº†éªŒè¯ä¸‹, æˆ‘ä»¬åŠ ä¸Šä¸€ä¸ªæ²¡æœ‰çš„æ ‡ç­¾, å¯ä»¥çœ‹åˆ°ä¸‹é¢çš„å¼‚å¸¸. æ‰€ä»¥æˆ‘ä»¬çœ‹åˆ°è¿™ç§å¼‚å¸¸çš„æ—¶å€™ï¼Œæ˜¯å¯ä»¥å»æ£€æŸ¥ä¸‹æ˜¯ä¸æ˜¯åå­—ä»€ä¹ˆæœ‰é—®é¢˜.</p><h3 id="Cause-org-apache-ibatis-builder-BuilderException-Error-parsing-SQL-Mapper-Configuration-Cause-org-apache-ibatis-builder-BuilderException-The-setting-nnnnn-is-not-known-Make-sure-you-spelled-it-correctly-case-sensitive"><a href="#Cause-org-apache-ibatis-builder-BuilderException-Error-parsing-SQL-Mapper-Configuration-Cause-org-apache-ibatis-builder-BuilderException-The-setting-nnnnn-is-not-known-Make-sure-you-spelled-it-correctly-case-sensitive" class="headerlink" title="Cause: org.apache.ibatis.builder.BuilderException: Error parsing SQL Mapper Configuration. Cause: org.apache.ibatis.builder.BuilderException: The setting nnnnn is not known. Make sure you spelled it correctly (case sensitive)."></a>Cause: org.apache.ibatis.builder.BuilderException: Error parsing SQL Mapper Configuration. Cause: org.apache.ibatis.builder.BuilderException: The setting nnnnn is not known. Make sure you spelled it correctly (case sensitive).</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">private Properties settingsAsProperties(XNode context) &#123;</span><br><span class="line">  if (context == null) &#123;</span><br><span class="line">    return new Properties();</span><br><span class="line">  &#125;</span><br><span class="line"> // å¯¹ settings ä¸‹çš„ setting è¿›è¡Œè§£æ å¹¶ä¸” è½¬åŒ–ä¸º key / value æ“ä½œ.   </span><br><span class="line">  Properties props = context.getChildrenAsProperties();</span><br><span class="line">  // Check that all settings are known to the configuration class</span><br><span class="line"> // å¯¹ Configuration è¿›è¡Œæ ¡éªŒ, ç¡®è®¤ä¸Šé¢çš„ props ä¸­çš„key åœ¨ Configuration</span><br><span class="line">// ä¸­æ˜¯éƒ½æœ‰set æ–¹æ³•çš„,ç›®æµ‹æ˜¯åé¢åå°„éœ€è¦ä½¿ç”¨åˆ°.    </span><br><span class="line">  MetaClass metaConfig = MetaClass.forClass(Configuration.class, localReflectorFactory);</span><br><span class="line">  for (Object key : props.keySet()) &#123;</span><br><span class="line">    if (!metaConfig.hasSetter(String.valueOf(key))) &#123;</span><br><span class="line">      throw new BuilderException(&quot;The setting &quot; + key + &quot; is not known.  Make sure you spelled it correctly (case sensitive).&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return props;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>loadCustomVfs(settings) æ–¹æ³•</p><p>è¯¥æ–¹æ³•,ä¸»è¦å°±æ˜¯è¯»å– vfsImpl å¯¹ç”¨çš„value,åˆ‡å‰²ä¸‹,ç„¶åç”¨ classForName æ¥è·å– class,</p><p>æœ€åèµ‹å€¼åˆ° configuration ä¸­å». è¿™é‡Œç®—æ˜¯å¯¹ vfs çš„ä¸€ç§è‡ªå®šä¹‰çš„æ‰©å±•,è™½ç„¶ç›®å‰è¿˜ä¸å¤ªæ¸…æ¥švfså…·ä½“ä½œç”¨.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">private void loadCustomVfs(Properties props) throws ClassNotFoundException &#123;</span><br><span class="line">  // è·å– vfsImpl çš„ value.  </span><br><span class="line">  String value = props.getProperty(&quot;vfsImpl&quot;);</span><br><span class="line">  if (value != null) &#123;</span><br><span class="line">   // æ ¹æ® , è¿›è¡Œåˆ‡å‰².   </span><br><span class="line">    String[] clazzes = value.split(&quot;,&quot;);</span><br><span class="line">    for (String clazz : clazzes) &#123;</span><br><span class="line">      if (!clazz.isEmpty()) &#123;</span><br><span class="line">        @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">        // åå°„,è·å–å‡º Class , æœ€åèµ‹å€¼åˆ° configuration ä¸­å».  </span><br><span class="line">        Class&lt;? extends VFS&gt; vfsImpl = (Class&lt;? extends VFS&gt;)Resources.classForName(clazz);</span><br><span class="line">        configuration.setVfsImpl(vfsImpl);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>loadCustomLogImpl(settings) æ–¹æ³•</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">private void loadCustomLogImpl(Properties props) &#123;</span><br><span class="line">  Class&lt;? extends Log&gt; logImpl = resolveClass(props.getProperty(&quot;logImpl&quot;));</span><br><span class="line">  // å°† log set åˆ° configuration ä¸­å».  </span><br><span class="line">  configuration.setLogImpl(logImpl);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-----------------------</span><br><span class="line">// resolve æœ€åå¦‚æœä¸æ˜¯ null çš„è¯,</span><br><span class="line">org.apache.ibatis.type.TypeAliasRegistry#resolveAlias</span><br><span class="line"></span><br><span class="line"> // å°±ä¼šèµ°åˆ°è¿™é‡Œ,è¿™é‡Œå¯ä»¥çœ‹å…ˆæ˜¯åœ¨ typeAliases(HashMap) ä¸­åˆ¤æ–­ä¸‹,å¦‚æœå­˜åœ¨å°±ç›´æ¥è·å–</span><br><span class="line">// å¦‚æœä¸å­˜åœ¨å°±ç”¨ Resources.ClassForNameæ¥æ“ä½œ</span><br><span class="line">// è¿™é‡Œçš„ HashMapå°±ç±»ä¼¼äº,è®°å½•ä¹‹å‰æ˜¯å¦å·²ç»åŠ è½½äº†æˆ–è€…é¢„çƒ­.</span><br><span class="line">// å¦‚æœæ˜¯ç”¨æ¥åšcacheçš„è¯, é‚£å°±åº”è¯¥æœ€åä¼šåœ¨ return ä¹‹å‰ç»§ç»­æŠŠå€¼ç»™æ”¾å…¥è¿›å».    </span><br><span class="line">  public &lt;T&gt; Class&lt;T&gt; resolveAlias(String string) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">      if (string == null) &#123;</span><br><span class="line">        return null;</span><br><span class="line">      &#125;</span><br><span class="line">      // issue #748</span><br><span class="line">      String key = string.toLowerCase(Locale.ENGLISH);</span><br><span class="line">      Class&lt;T&gt; value;</span><br><span class="line">      if (typeAliases.containsKey(key)) &#123;</span><br><span class="line">        value = (Class&lt;T&gt;) typeAliases.get(key);</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        value = (Class&lt;T&gt;) Resources.classForName(string);</span><br><span class="line">      &#125;</span><br><span class="line">      return value;</span><br><span class="line">    &#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">      throw new TypeException(&quot;Could not resolve type alias &#x27;&quot; + string + &quot;&#x27;.  Cause: &quot; + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">------------</span><br><span class="line">// å¦‚æœæˆ‘ä»¬åœ¨é…ç½®æ–‡ä»¶ä¸­æ²¡æœ‰å®šä¹‰çš„è¯,è¿™é‡Œé»˜è®¤æ˜¯null,ä¹Ÿå°±æ˜¯è¯´ä¸ä¼šsetè¿›å».    </span><br><span class="line">  public void setLogImpl(Class&lt;? extends Log&gt; logImpl) &#123;</span><br><span class="line">    if (logImpl != null) &#123;</span><br><span class="line">      this.logImpl = logImpl;</span><br><span class="line">      LogFactory.useCustomLogging(this.logImpl);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p><strong>æ ‡ç­¾ä¸‰ :</strong></p><p>å…³äºåˆ«åçš„é…ç½®.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">typeAliasesElement(root.evalNode(&quot;typeAliases&quot;));</span><br><span class="line">private void typeAliasesElement(XNode parent) &#123;</span><br><span class="line">  if (parent != null) &#123;</span><br><span class="line">   // å¯¹ typeAliases ä¸‹çš„å­æ ‡ç­¾è¿›è¡Œè¿­ä»£.</span><br><span class="line">   // åˆ†ä¸ºæ˜¯ package å’Œé package   </span><br><span class="line">    for (XNode child : parent.getChildren()) &#123;</span><br><span class="line">      if (&quot;package&quot;.equals(child.getName())) &#123;</span><br><span class="line">       // è·å–ä½ è¾“å…¥çš„åŒ…   </span><br><span class="line">        String typeAliasPackage = child.getStringAttribute(&quot;name&quot;);</span><br><span class="line">        configuration.getTypeAliasRegistry().registerAliases(typeAliasPackage);</span><br><span class="line">      &#125; else &#123;</span><br><span class="line"> // &lt;typeAlias type=&quot;com.iyang.mybatis.pojo.TbBlog&quot; alias=&quot;TbBlog&quot; /&gt;</span><br><span class="line"> // è¿™é‡Œå°±æ˜¯å¯¹è¿™ç§è¿›è¡Œè§£æçš„         </span><br><span class="line">        String alias = child.getStringAttribute(&quot;alias&quot;);</span><br><span class="line">        String type = child.getStringAttribute(&quot;type&quot;);</span><br><span class="line">        try &#123;</span><br><span class="line">          Class&lt;?&gt; clazz = Resources.classForName(type);</span><br><span class="line">   // å¦‚æœæ²¡å†™åˆ«å,å°±åªä¼ å…¥ clazz.         </span><br><span class="line">          if (alias == null) &#123;</span><br><span class="line">            typeAliasRegistry.registerAlias(clazz);</span><br><span class="line">          &#125; else &#123;</span><br><span class="line">   // å†™äº†åˆ«å,å°±åˆ«åå’Œclazzä¸€èµ·ä¼ å…¥è¿›æ¥.           </span><br><span class="line">            typeAliasRegistry.registerAlias(alias, clazz);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">          throw new BuilderException(&quot;Error registering typeAlias for &#x27;&quot; + alias + &quot;&#x27;. Cause: &quot; + e, e);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">----------------</span><br><span class="line">// è¿™é‡Œå¯ä»¥çœ‹åˆ°æ˜¯æ ¹æ® packageName æ¥ registerè¿›æ¥çš„.    </span><br><span class="line">  public void registerAliases(String packageName, Class&lt;?&gt; superType) &#123;</span><br><span class="line">    // new ä¸€ä¸ªè§£æå™¨å·¥å…·ç±»</span><br><span class="line">    ResolverUtil&lt;Class&lt;?&gt;&gt; resolverUtil = new ResolverUtil&lt;&gt;();</span><br><span class="line">    // è·å–åŒ…çš„path,ç„¶åè·å–è¯¥åŒ…ä¸‹çš„æ–‡ä»¶,å¦‚æœæ–‡ä»¶æ˜¯.classç»“å°¾çš„è¯</span><br><span class="line">    // æœ€ååœ¨ ResolverUtil ä¸­matchessæ˜¯æœ‰è¯¥åŒ…ä¸‹çš„å…¨åç§°.</span><br><span class="line">    resolverUtil.find(new ResolverUtil.IsA(superType), packageName);</span><br><span class="line">    // è¿™é‡Œè¿”å›çš„æ˜¯ä¸Šä¸€æ­¥è¯´çš„ matches</span><br><span class="line">    Set&lt;Class&lt;? extends Class&lt;?&gt;&gt;&gt; typeSet = resolverUtil.getClasses();</span><br><span class="line">    for (Class&lt;?&gt; type : typeSet) &#123;</span><br><span class="line">      // Ignore inner classes and interfaces (including package-info.java)</span><br><span class="line">      // Skip also inner classes. See issue #6</span><br><span class="line">      // å¦‚æœä¸æ˜¯æ¥å£,ä¸æ˜¯å†…éƒ¨ç±»ç­‰æ¡ä»¶çš„è¯,å°±èµ°  registerAlias æ–¹æ³•</span><br><span class="line">      if (!type.isAnonymousClass() &amp;&amp; !type.isInterface() &amp;&amp; !type.isMemberClass()) &#123;</span><br><span class="line"> // å…ˆè·å–ç±»åå­—,åˆ¤æ–­è¯¥ç±»ä¸Šæœ‰æ²¡æœ‰ @Alias æ³¨è§£,å¦‚æœæœ‰æ³¨è§£çš„è¯,å°±ç”¨æ³¨è§£çš„å€¼ä½œä¸ºç¼©å†™çš„.</span><br><span class="line"> // æœ€ååˆ¤æ–­æ˜¯ä¸æ˜¯null,æ˜¯nullå°±ä¼šæŠ›å‡ºå¼‚å¸¸æ¥.æœ€åå°†ä¸Šé¢è·å–å‡ºæ¥çš„ç¼©å†™åå­—,è½¬åŒ–ä¸ºå¤§å†™.</span><br><span class="line"> // å¦‚æœæ­¤æ—¶ typeAliases æ˜¯å·²ç»æœ‰äº†è¯¥å€¼çš„è¯,å°±ä¼šæŠ›å‡ºå¼‚å¸¸æ¥.å¦åˆ™å°±æ”¾å…¥åˆ°typeAliasesæ¥</span><br><span class="line"> // private final Map&lt;String, Class&lt;?&gt;&gt; typeAliases = new HashMap&lt;&gt;();</span><br><span class="line"> // å¯ä»¥çœ‹åˆ° typeAliases æ˜¯ä¸€ä¸ªHashMap,å¹¶ä¸”å…¶å­˜å‚¨çš„Key/Valueè¿˜æ˜¯è›®æ˜æ˜¾çš„.         </span><br><span class="line">        registerAlias(type);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p><strong>æ ‡ç­¾å››</strong></p><p>æ‰©å±•çš„ demo å¯ä»¥å‚è€ƒ MyBatiså®˜ç½‘ : <a href="https://mybatis.org/mybatis-3/configuration.html">https://mybatis.org/mybatis-3/configuration.html</a></p><p>ç„¶åçœ‹ MyBatis æ˜¯å¦‚ä½•å°†æ’ä»¶ç»™åˆ©ç”¨ä¸Šçš„å‘¢ ?</p><p>é¦–å…ˆåœ¨ mybatis-config.xml ä¸­é…ç½®å¥½æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„ plugin</p><p>è¿™é‡Œä»¥æˆ‘é…ç½®äº†äºŒä¸ªæ’ä»¶</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;plugins&gt;</span><br><span class="line">    &lt;plugin interceptor=&quot;com.iyang.mybatis.plugins.ExamplePlugin&quot;&gt;</span><br><span class="line">        &lt;property name=&quot;name&quot; value=&quot;GavinYang&quot;/&gt;</span><br><span class="line">        &lt;property name=&quot;age&quot; value=&quot;22&quot;/&gt;</span><br><span class="line">        &lt;property name=&quot;hobby&quot; value=&quot;lwf&quot;/&gt;</span><br><span class="line">    &lt;/plugin&gt;</span><br><span class="line"></span><br><span class="line">    &lt;plugin interceptor=&quot;com.iyang.mybatis.plugins.QuerySqlPlugin&quot;&gt;</span><br><span class="line"></span><br><span class="line">        &lt;property name=&quot;name&quot; value=&quot;GavinYang&quot;/&gt;</span><br><span class="line">    &lt;/plugin&gt;</span><br><span class="line">&lt;/plugins&gt;</span><br></pre></td></tr></table></figure><p>&#x2F;&#x2F; å¤„ç† plugin çš„ä»£ç </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">private void pluginElement(XNode parent) throws Exception &#123;</span><br><span class="line">  // è¿™é‡Œä¼ å…¥è¿›æ¥çš„å°±æ˜¯ &lt;plugins&gt;æ•´ä¸ªæ ‡ç­¾å†…å®¹.  </span><br><span class="line">  if (parent != null) &#123;</span><br><span class="line">   // è·å– &lt;plugins&gt; ä¸‹çš„ &lt;plugin&gt; é›†åˆ,è¿›è¡Œè¿­ä»£å¤„ç†.   </span><br><span class="line">    for (XNode child : parent.getChildren()) &#123;</span><br><span class="line">     // è·å–æ’ä»¶çš„ å…¨é™å®šåå­—.   </span><br><span class="line">      String interceptor = child.getStringAttribute(&quot;interceptor&quot;);</span><br><span class="line">     // è·å–æˆ‘ä»¬å®šä¹‰åœ¨ plugin ä¸‹çš„ properties.   </span><br><span class="line">      Properties properties = child.getChildrenAsProperties();</span><br><span class="line">// resolveClassæ˜¯æœ€åæ³¨å†Œåˆ°typeAliasRegistryæ¥.    </span><br><span class="line">// å®ä¾‹åŒ–,è¿™é‡Œå°±å¯ä»¥çœ‹åˆ°æˆ‘ä»¬åœ¨å®šä¹‰çš„Pluginä¸­,æ— å‚æ„é€ å‡½æ•°æ‰“å°å‡ºæ¥çš„å†…å®¹äº†.        </span><br><span class="line">      Interceptor interceptorInstance = (Interceptor) resolveClass(interceptor).getDeclaredConstructor().newInstance();</span><br><span class="line">// å°† properties èµ‹å€¼ç»™  interceptorInstance</span><br><span class="line">// ä¹Ÿå°±æ˜¯æ”¾å…¥åˆ° interceptorInstance æ¥.        </span><br><span class="line">      interceptorInstance.setProperties(properties);</span><br><span class="line">// org.apache.ibatis.plugin.InterceptorChain</span><br><span class="line">// è¿™æ˜¯æ˜¯å°†interceptorInstanceæ·»åŠ åˆ°InterceptorChainçš„interceptorsä¸­æ¥.        </span><br><span class="line">      configuration.addInterceptor(interceptorInstance);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° MyBatisåœ¨åŠ è½½pluginçš„æ—¶å€™,æ˜¯åˆ©ç”¨äº†åå°„æ¥newå‡ºä¸€ä¸ªå¯¹è±¡æ¥,å¹¶ä¸”æ³¨å†Œåˆ° typeAliasRegistry ä¸­æ¥. è¿™é‡Œä¸»è¦æ˜¯è§£æ plugin çš„é…ç½®, åé¢åœ¨æ‰§è¡Œsqlçš„æ—¶å€™,éƒ½æ˜¯å¦‚ä½•ä½¿ç”¨åˆ°è¿™äº› plugin çš„å‘¢ ? è‚¯å®šæ˜¯æœ‰ä¸€ä¸ªä»InterceptorChainä¸­è·å–interceptorsæ¥,ç„¶åè¿›è¡Œå¤„ç†.</p><p><strong>æ ‡ç­¾äº” : &lt; objectFactory &gt;</strong></p><p>objectFactory çš„å¤„ç†æ–¹å¼æ˜¯å’Œ æ ‡ç­¾å››ç›¸ä¼¼çš„,åªæ˜¯æœ€ååœ¨ä½¿ç”¨åœºæ™¯æ˜¯æœ‰ç‚¹ä¸åŒçš„.</p><p>ä»£ç ä¸Šçš„æ“ä½œä¹Ÿæ˜¯ç±»ä¼¼çš„.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">private void objectFactoryElement(XNode context) throws Exception &#123;</span><br><span class="line">  if (context != null) &#123;</span><br><span class="line">    String type = context.getStringAttribute(&quot;type&quot;);</span><br><span class="line">    Properties properties = context.getChildrenAsProperties();</span><br><span class="line">    ObjectFactory factory = (ObjectFactory) resolveClass(type).getDeclaredConstructor().newInstance();</span><br><span class="line">    factory.setProperties(properties);</span><br><span class="line">    configuration.setObjectFactory(factory);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ ‡ç­¾äº” :</strong></p><p>è¯¥æ ‡ç­¾åœ¨ MyBatis å®˜ç½‘æ˜¯æ²¡æœ‰demo, æˆ‘æ˜¯æ ¹æ®ä»£ç æ¥é¡ºè—¤æ‘¸ç“œå†™çš„ä¸€ä¸ª.</p><p>å‚è€ƒ : org.apache.ibatis.reflection.wrapper.DefaultObjectWrapperFactory è¿™ä¸ªæºç ,æ¥æ¨¡ä»¿å†™çš„ä¸€ä¸ª.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">objectWrapperFactoryElement(root.evalNode(&quot;objectWrapperFactory&quot;));</span><br><span class="line">private void objectWrapperFactoryElement(XNode context) throws Exception &#123;</span><br><span class="line">  if (context != null) &#123;</span><br><span class="line">   // è·å– é…ç½®æ–‡ä»¶ä¸­çš„typeå€¼   </span><br><span class="line">    String type = context.getStringAttribute(&quot;type&quot;);</span><br><span class="line"> // å…ˆæ³¨å†Œåˆ°  typeAliasRegistry æ¥,ç„¶åå®ä¾‹åŒ–è¿™ä¸ªç±».</span><br><span class="line"> // æˆ‘ä»¬åœ¨è‡ªå·±å®šä¹‰çš„ç±»ä¸­,å†™ä¸€ä¸ªæ— å‚æ„é€ å‡½æ•°,å°±å¯ä»¥çœ‹åˆ°æˆ‘ä»¬æ‰“å°çš„å†…å®¹äº†.     </span><br><span class="line">    ObjectWrapperFactory factory = (ObjectWrapperFactory) resolveClass(type).getDeclaredConstructor().newInstance();</span><br><span class="line">// æœ€åèµ‹å€¼åˆ° confifuration ä¸­æ¥.      </span><br><span class="line">    configuration.setObjectWrapperFactory(factory);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ ‡ç­¾å…­ : &lt; reflectorFactory &gt;</strong></p><p>å¤„ç†æ–¹å¼å’Œä¸Šé¢ç±»ä¼¼.</p><p>è¿™é‡Œæˆ‘ä»¬è‡ªå·±å†™ä¸€ä¸ª com.iyang.mybatis.factory.GavinReflectorFactory æ¥ç»§æ‰¿DefaultReflectorFactory,åœ¨æ— å‚æ•°æ„é€ å‡½æ•°ä¸­æ‰“å°ä¸‹å†…å®¹, ç„¶ådebugè·Ÿè¿›.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">private void reflectorFactoryElement(XNode context) throws Exception &#123;</span><br><span class="line">  if (context != null) &#123;</span><br><span class="line">    String type = context.getStringAttribute(&quot;type&quot;);</span><br><span class="line">    ReflectorFactory factory = (ReflectorFactory) resolveClass(type).getDeclaredConstructor().newInstance();</span><br><span class="line">    configuration.setReflectorFactory(factory);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ ‡ç­¾ä¸ƒ :</strong></p><p>environments æ ‡ç­¾éƒ½æ˜¯æ”¾å…¥ä¸€äº› db çš„é…ç½®ä¿¡æ¯ç­‰.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">&lt;environments default=&quot;development&quot;&gt;</span><br><span class="line">    &lt;environment id=&quot;development&quot;&gt;</span><br><span class="line">        &lt;!-- äº‹åŠ¡ --&gt;</span><br><span class="line">        &lt;transactionManager type=&quot;JDBC&quot;/&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- DB è¿æ¥é…ç½® --&gt;</span><br><span class="line">        &lt;dataSource type=&quot;POOLED&quot;&gt;</span><br><span class="line">            &lt;property name=&quot;driver&quot; value=&quot;$&#123;jdbc.driver&#125;&quot; /&gt;</span><br><span class="line">            &lt;property name=&quot;url&quot; value=&quot;$&#123;jdbc.url&#125;&quot; /&gt;</span><br><span class="line">            &lt;property name=&quot;username&quot; value = &quot;$&#123;jdbc.username&#125;&quot; /&gt;</span><br><span class="line">            &lt;property name=&quot;password&quot; value=&quot;$&#123;jdbc.password&#125;&quot; /&gt;</span><br><span class="line">        &lt;/dataSource&gt;</span><br><span class="line">    &lt;/environment&gt;</span><br><span class="line">&lt;/environments&gt;</span><br><span class="line">private void environmentsElement(XNode context) throws Exception &#123;</span><br><span class="line">  if (context != null) &#123;</span><br><span class="line">    if (environment == null) &#123;</span><br><span class="line">// è·å– default å¯¹åº”å­—æ®µçš„å€¼         </span><br><span class="line">      environment = context.getStringAttribute(&quot;default&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">// è¿™é‡Œçš„ getChildren è·å–çš„æ˜¯ &lt;environments&gt; --&gt; &lt;environment&gt;ä¸‹çš„å­æ ‡ç­¾      </span><br><span class="line">    for (XNode child : context.getChildren()) &#123;</span><br><span class="line">      String id = child.getStringAttribute(&quot;id&quot;);</span><br><span class="line">// ç¡®ä¿ id å’Œ  ä¸Šä¸€æ­¥çš„environment çš„å€¼æ˜¯ç›¸åŒçš„,å°±ä¼šè¿”å›true.      </span><br><span class="line">      if (isSpecifiedEnvironment(id)) &#123;</span><br><span class="line">/**</span><br><span class="line">*  è·å–å‡º transactionManager å¯¹åº”çš„æ ‡ç­¾.</span><br><span class="line">*  ç„¶åæ ¹æ® JBDC(é…ç½®æ–‡ä»¶ä¸­çš„å€¼),ç„¶åä» typeAliasRegistryä¸­è·å–å‡ºæ¥ï¼Œ</span><br><span class="line">*  è°ƒç”¨åå°„æ¥ å®ä¾‹åŒ– è¿™ä¸ªå¯¹è±¡. </span><br><span class="line">*  æœ€åè¿˜æ˜¯å¯ä»¥é…ç½® properties,ä¼šè¢«setåˆ°txFactoryä¸­å»çš„.</span><br><span class="line">*  ä½†æ˜¯ JdbcTransactionFactory å¥½åƒæ²¡æœ‰é‡å†™ setProperties æ–¹æ³•.</span><br><span class="line">*/          </span><br><span class="line">        TransactionFactory txFactory = transactionManagerElement(child.evalNode(&quot;transactionManager&quot;));</span><br><span class="line">// å…ˆè·å–  dataSource å­—æ®µ</span><br><span class="line">/**</span><br><span class="line">*  å…ˆè·å–typeçš„å€¼,ç„¶åå†è·å– propertiesçš„æ ‡ç­¾å­—æ®µå€¼.</span><br><span class="line">*  æ ¹æ®æˆ‘ä»¬çš„é…ç½® : org.apache.ibatis.datasource.pooled.PooledDataSourceFactory,åº”è¯¥ä¼šè·å–å‡ºè¿™ä¸ªå¯¹è±¡.è¯¥å¯¹è±¡å…¶å†…éƒ¨æ˜¯æœ‰ä¸€ä¸ª,org.apache.ibatis.datasource.pooled.PooledDataSourceçš„,é‡Œé¢æœ‰éƒ¨åˆ†é»˜è®¤å€¼çš„.</span><br><span class="line">*æœ€åå°†  properties è°ƒç”¨ org.apache.ibatis.datasource.unpooled.UnpooledDataSourceFactory#setPropertiesæ–¹æ³•,</span><br><span class="line">æœ€åæ˜¯å°† properties é‡Œé¢çš„key/value éƒ½è®¾ç½®åˆ° MetaObject metaDataSource = SystemMetaObject.forObject(dataSource);æ¥äº†.</span><br><span class="line">*/</span><br><span class="line">        DataSourceFactory dsFactory = dataSourceElement(child.evalNode(&quot;dataSource&quot;));</span><br><span class="line">// ä»  PooledDataSourceFactory ä¸­è·å– datasource å±æ€§.         </span><br><span class="line">        DataSource dataSource = dsFactory.getDataSource();</span><br><span class="line">// è¿™é‡Œé‡‡ç”¨é“¾å¼ç¼–ç¨‹,ä¹Ÿå°±æ˜¯å°†id/txFactory/dataSource éƒ½ç»™setåˆ° Environment.Builderæ¥äº†.         </span><br><span class="line">        Environment.Builder environmentBuilder = new Environment.Builder(id)</span><br><span class="line">            .transactionFactory(txFactory)</span><br><span class="line">            .dataSource(dataSource);</span><br><span class="line">  //    environmentBuilder.build() ä¹Ÿå°±æ˜¯new äº†ä¸€ä¸ª Environment </span><br><span class="line">  // æœ€å èµ‹å€¼åˆ° configuration ä¸­æ¥äº†.        </span><br><span class="line">        configuration.setEnvironment(environmentBuilder.build());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è§£æ environments ,åˆ©ç”¨ typeAliasRegistry ä¸­å·²ç»æ³¨å†Œå¥½äº†çš„ä¿¡æ¯,ç„¶åæ ¹æ®åå­—ç¼©å†™(æ¯”å¦‚JDBC)è¿™ç§,æ¥è·å–classå¯¹è±¡, ç”¨ åå°„æ¥ new ä¸€æ³¢å¯¹è±¡å‡ºæ¥,çœŸæ˜¯ç¾æ»‹æ»‹. æ¥ç€å°±æ˜¯è§£æ äº‹åŠ¡&#x2F;JDBCè¿æ¥é…ç½®ä¿¡æ¯ç­‰, æœ€åå°†ä¿¡æ¯ä¿å­˜åˆ° DataSource ä¸­æ¥. åæ‰‹å†æ¥ä¸€æ³¢ é“¾å¼ç¼–ç¨‹ æ¥newå¯¹è±¡å‡ºæ¥, æœ€åå°±æ˜¯ä¸€ä¸ª Environment å¯¹è±¡å‡ºæ¥,ç»™set åˆ° configuration ä¸­æ¥.</p><p><strong>æ ‡ç­¾å…«</strong></p><p>åˆ°è¿™é‡Œ,å¯ä»¥çœ‹åˆ°å¯¹xmlçš„è§£ææ“ä½œ. å…ˆè§£æ æ ‡ç­¾ çš„å€¼å‡ºæ¥,ç„¶åæ ¹æ®å€¼è¿›è¡Œåˆ†ç±»å¤„ç†æˆ–è€…æ ¹æ®è‡ªå·±çš„éœ€æ±‚æ¥è¿›è¡Œå¤„ç†.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">private void typeHandlerElement(XNode parent) &#123;</span><br><span class="line">  if (parent != null) &#123;</span><br><span class="line">    for (XNode child : parent.getChildren()) &#123;</span><br><span class="line">      // å¦‚æœå­æ ‡ç­¾æ˜¯ package   </span><br><span class="line">      if (&quot;package&quot;.equals(child.getName())) &#123;</span><br><span class="line">       // è·å–å‡º name å¯¹åº”çš„å€¼.   </span><br><span class="line">        String typeHandlerPackage = child.getStringAttribute(&quot;name&quot;);</span><br><span class="line">      // æ³¨å†Œåˆ°   typeHandlerRegistry ä¸­æ¥.  </span><br><span class="line">        typeHandlerRegistry.register(typeHandlerPackage);</span><br><span class="line">      &#125; else &#123;</span><br><span class="line"> // è¿™é‡Œè·å–å‡ºä¸‰ç§å€¼æ¥,   javaType/jdbcType/  handler    </span><br><span class="line">        String javaTypeName = child.getStringAttribute(&quot;javaType&quot;);</span><br><span class="line">        String jdbcTypeName = child.getStringAttribute(&quot;jdbcType&quot;);</span><br><span class="line">        String handlerTypeName = child.getStringAttribute(&quot;handler&quot;);</span><br><span class="line">        Class&lt;?&gt; javaTypeClass = resolveClass(javaTypeName);</span><br><span class="line">        JdbcType jdbcType = resolveJdbcType(jdbcTypeName);</span><br><span class="line">        Class&lt;?&gt; typeHandlerClass = resolveClass(handlerTypeName);</span><br><span class="line">  // åˆ†ä¸º  javaTypeClass æ˜¯ä¸æ˜¯ null çš„æƒ…å†µ       </span><br><span class="line">        if (javaTypeClass != null) &#123;</span><br><span class="line">         // åŸºäº javaTypeClass æ˜¯ä¸æ˜¯ nullçš„æƒ…å†µ,å†åˆ¤æ–­ jdbcType æ˜¯ä¸æ˜¯null  </span><br><span class="line">          if (jdbcType == null) &#123;</span><br><span class="line">            typeHandlerRegistry.register(javaTypeClass, typeHandlerClass);</span><br><span class="line">          &#125; else &#123;</span><br><span class="line">            typeHandlerRegistry.register(javaTypeClass, jdbcType, typeHandlerClass);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">// è¿™æ˜¯æ ¹æ®   handlerTypeName æ³¨å†Œåˆ° typeHandlerRegistry ä¸­æ¥.           </span><br><span class="line">          typeHandlerRegistry.register(typeHandlerClass);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ ‡ç­¾ä¹ :</strong></p><p>è¯¥æ ‡ç­¾æ˜¯å¯¹æˆ‘ä»¬å¯¹åº”çš„å¯¹è±¡,å…¶sqlè¯­å¥å­˜æ”¾çš„åœ°å€. ä¹Ÿå°±æ˜¯é‡Œé¢æ”¾å…¥çš„æ˜¯äºmapperæ¥å£å¯¹åº”çš„æ–¹æ³•,æŸ¥è¯¢çš„sqlè¯­å¥.</p><p>æ¥ä¸‹æ¥çœ‹ä¸‹ MyBatis æ˜¯å¯¹ mappers æ ‡ç­¾çš„å†…å®¹è¿›è¡Œäº†è¯´æ˜è§£æå’Œå¤„ç†.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">mapperElement</span><span class="params">(XNode parent)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">  <span class="keyword">if</span> (parent != <span class="literal">null</span>) &#123;</span><br><span class="line">      </span><br><span class="line"> <span class="comment">// getChildren è·å–çš„æ˜¯ mappers ä¸‹çš„ mapper æ ‡ç­¾</span></span><br><span class="line">    <span class="keyword">for</span> (XNode child : parent.getChildren()) &#123;</span><br><span class="line"><span class="comment">// å¦‚æœé…ç½®çš„æ˜¯ package.        </span></span><br><span class="line">      <span class="keyword">if</span> (<span class="string">&quot;package&quot;</span>.equals(child.getName())) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">mapperPackage</span> <span class="operator">=</span> child.getStringAttribute(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">        configuration.addMappers(mapperPackage);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// è·å–å‡º    resource/url/class è¿™ä¸‰ç±»çš„å€¼.       </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">resource</span> <span class="operator">=</span> child.getStringAttribute(<span class="string">&quot;resource&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> child.getStringAttribute(<span class="string">&quot;url&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">mapperClass</span> <span class="operator">=</span> child.getStringAttribute(<span class="string">&quot;class&quot;</span>);</span><br><span class="line"> <span class="comment">// å¯¹ resource å¤„ç†         </span></span><br><span class="line">        <span class="keyword">if</span> (resource != <span class="literal">null</span> &amp;&amp; url == <span class="literal">null</span> &amp;&amp; mapperClass == <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="comment">// å°† resource èµ‹å€¼ç»™ ErrorContext ä¸­  </span></span><br><span class="line">          ErrorContext.instance().resource(resource);</span><br><span class="line">     <span class="comment">// è¯»å–æ–‡ä»¶.       </span></span><br><span class="line">          <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> Resources.getResourceAsStream(resource);</span><br><span class="line"><span class="comment">// ä½¿ç”¨ XMLMapperBuilder æ¥å¯¹è§£æxmlå†…å®¹.            </span></span><br><span class="line">          <span class="type">XMLMapperBuilder</span> <span class="variable">mapperParser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XMLMapperBuilder</span>(inputStream, configuration, resource, configuration.getSqlFragments());</span><br><span class="line">          mapperParser.parse();</span><br><span class="line"><span class="comment">// url å¤„ç†            </span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (resource == <span class="literal">null</span> &amp;&amp; url != <span class="literal">null</span> &amp;&amp; mapperClass == <span class="literal">null</span>) &#123;</span><br><span class="line">          ErrorContext.instance().resource(url);</span><br><span class="line">          <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> Resources.getUrlAsStream(url);</span><br><span class="line">          <span class="type">XMLMapperBuilder</span> <span class="variable">mapperParser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XMLMapperBuilder</span>(inputStream, configuration, url, configuration.getSqlFragments());</span><br><span class="line">          mapperParser.parse();</span><br><span class="line"><span class="comment">// mapperClass å¤„ç†            </span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (resource == <span class="literal">null</span> &amp;&amp; url == <span class="literal">null</span> &amp;&amp; mapperClass != <span class="literal">null</span>) &#123;</span><br><span class="line">          Class&lt;?&gt; mapperInterface = Resources.classForName(mapperClass);</span><br><span class="line">          configuration.addMapper(mapperInterface);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BuilderException</span>(<span class="string">&quot;A mapper element may only specify a url, resource or class, but not more than one.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-----------------------</span><br><span class="line"><span class="comment">// è¿™é‡Œæˆ‘ä»¬è·Ÿè¿› mapperParser.parse() æ–¹æ³•æ¥</span></span><br><span class="line"><span class="comment">// org.apache.ibatis.builder.xml.XMLMapperBuilder</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">parse</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">// åˆ¤æ–­ configuration çš„ loadedResources æ˜¯å¦å«æœ‰è¯¥å€¼,å¦‚æœä¸å«æœ‰çš„è¯,å°±ä¼šå»è§£æ.  </span></span><br><span class="line">    <span class="keyword">if</span> (!configuration.isResourceLoaded(resource)) &#123;</span><br><span class="line"><span class="comment">// å¯¹mapper æ ‡ç­¾è¿›è¡Œè§£æ        </span></span><br><span class="line">      configurationElement(parser.evalNode(<span class="string">&quot;/mapper&quot;</span>));</span><br><span class="line">      configuration.addLoadedResource(resource);</span><br><span class="line">      bindMapperForNamespace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    parsePendingResultMaps();</span><br><span class="line">    parsePendingCacheRefs();</span><br><span class="line">    parsePendingStatements();</span><br><span class="line">  &#125;    </span><br><span class="line"></span><br><span class="line">-----------------------------------</span><br><span class="line"><span class="comment">//   configurationElement æ–¹æ³•</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">configurationElement</span><span class="params">(XNode context)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"> <span class="comment">// è·å– namespace       </span></span><br><span class="line">      <span class="type">String</span> <span class="variable">namespace</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;namespace&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> (namespace == <span class="literal">null</span> || namespace.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BuilderException</span>(<span class="string">&quot;Mapper&#x27;s namespace cannot be empty&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line"><span class="comment">//  MapperBuilderAssistant å°† namespace ç»‘å®šåˆ°è¯¥ç±»çš„å‚æ•°ä¸­æ¥.        </span></span><br><span class="line">      builderAssistant.setCurrentNamespace(namespace);</span><br><span class="line">  </span><br><span class="line">   <span class="comment">// è¿™é‡Œçš„ cache-ref / cache éƒ½æ˜¯æš‚æ—¶æ²¡æœ‰é…ç½®çš„.     </span></span><br><span class="line">      cacheRefElement(context.evalNode(<span class="string">&quot;cache-ref&quot;</span>));</span><br><span class="line">      cacheElement(context.evalNode(<span class="string">&quot;cache&quot;</span>));</span><br><span class="line">        </span><br><span class="line"> <span class="comment">//  /mapper/parameterMap ä¹Ÿæ˜¯æš‚æ—¶æ²¡æœ‰é…ç½®çš„  </span></span><br><span class="line">      parameterMapElement(context.evalNodes(<span class="string">&quot;/mapper/parameterMap&quot;</span>));</span><br><span class="line">        </span><br><span class="line"><span class="comment">// resultMap æ˜¯å¯¹å¯¹è±¡å­—æ®µçš„æ˜ å°„</span></span><br><span class="line"><span class="comment">// mapper/sql æ˜¯å¯¹ä¸€äº›å…¬ç”¨çš„sqlè¿›è¡ŒæŠ½å–</span></span><br><span class="line"><span class="comment">// äºŒè€…æš‚æ—¶éƒ½æ²¡æœ‰é…ç½®        </span></span><br><span class="line">      resultMapElements(context.evalNodes(<span class="string">&quot;/mapper/resultMap&quot;</span>));</span><br><span class="line">      sqlElement(context.evalNodes(<span class="string">&quot;/mapper/sql&quot;</span>));</span><br><span class="line"><span class="comment">// è·å– select / insert / update / delete ç­‰ æ ‡ç­¾.        </span></span><br><span class="line">      buildStatementFromContext(context.evalNodes(<span class="string">&quot;select|insert|update|delete&quot;</span>));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BuilderException</span>(<span class="string">&quot;Error parsing Mapper XML. The XML location is &#x27;&quot;</span> + resource + <span class="string">&quot;&#x27;. Cause: &quot;</span> + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;    </span><br><span class="line"></span><br><span class="line"><span class="comment">// å¾€ä¸‹è·Ÿæ–¹æ³•</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">buildStatementFromContext</span><span class="params">(List&lt;XNode&gt; list, String requiredDatabaseId)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (XNode context : list) &#123;</span><br><span class="line">      <span class="keyword">final</span> <span class="type">XMLStatementBuilder</span> <span class="variable">statementParser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XMLStatementBuilder</span>(configuration, builderAssistant, context, requiredDatabaseId);</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        statementParser.parseStatementNode();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IncompleteElementException e) &#123;</span><br><span class="line">        configuration.addIncompleteStatement(statementParser);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;é¢˜è®°&quot;&gt;&lt;a href=&quot;#é¢˜è®°&quot; class=&quot;headerlink&quot; title=&quot;é¢˜è®°&quot;&gt;&lt;/a&gt;é¢˜è®°&lt;/h4&gt;&lt;p&gt;å¯¹äºé…ç½®æ–‡ä»¶çš„è§£æ, è¿˜æ˜¯ç›¸å¯¹æ¯”è¾ƒå¥½ç†è§£çš„, å°±æ˜¯è¯»å–é…ç½®æ–‡ä»¶, ç„¶ååœ¨ä»£ç éœ€è¦çš„åœ°æ–¹ç»™ä½¿ç”¨åˆ°.&lt;/p&gt;
&lt;p&gt;è¿™é‡Œ,å¯ä»¥æ‰©å±•ä¸‹, Spri</summary>
      
    
    
    
    <category term="javaæ¡†æ¶" scheme="https://ruy9527.github.io/categories/java%E6%A1%86%E6%9E%B6/"/>
    
    <category term="mybatis" scheme="https://ruy9527.github.io/categories/java%E6%A1%86%E6%9E%B6/mybatis/"/>
    
    
    <category term="javaæ¡†æ¶" scheme="https://ruy9527.github.io/tags/java%E6%A1%86%E6%9E%B6/"/>
    
    <category term="mybatis" scheme="https://ruy9527.github.io/tags/mybatis/"/>
    
  </entry>
  
  <entry>
    <title>SpringBootåŠ¨æ€æ·»åŠ æ¥å£</title>
    <link href="https://ruy9527.github.io/2021/11/04/spring/SpringBoot%E5%8A%A8%E6%80%81%E6%B7%BB%E5%8A%A0%E6%8E%A5%E5%8F%A3/"/>
    <id>https://ruy9527.github.io/2021/11/04/spring/SpringBoot%E5%8A%A8%E6%80%81%E6%B7%BB%E5%8A%A0%E6%8E%A5%E5%8F%A3/</id>
    <published>2021-11-03T16:17:24.000Z</published>
    <updated>2022-11-04T13:46:13.919Z</updated>
    
    <content type="html"><![CDATA[<h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><p>æœ€è¿‘çœ‹äº†å…¬å¸çš„äº§å“,æœ‰ä¸€ä¸ªè¿™æ ·çš„åŠ¨æ€,å°±æ˜¯æ ¹æ®inputè¾“å…¥çš„å†…å®¹,è¿›è¡ŒåŠ¨æ€æ¥å£çš„æ·»åŠ .</p><p>æ¯”å¦‚ æˆ‘åœ¨æ²¡æœ‰æ·»åŠ ä¹‹å‰,è®¿é—® <a href="http://localhost:8080/test">http://localhost:8080/test</a> è¯¥åœ°å€æ˜¯404, äºæ˜¯é€šè¿‡inputçš„è¾“å…¥åˆ›å»º,å°±ç›¸å½“äºåŠ¨æ€æ·»åŠ äº†ä¸€ä¸ªæ¥å£,äºæ˜¯å°±å¯ä»¥è®¿é—®äº†.</p><p>å®ç°çš„æ–¹å¼æœ‰å¾ˆå¤šç§, å…·ä½“çš„æƒ³è¦çš„æ•ˆæœè‚¯å®šæ˜¯éœ€è¦æ ¹æ®è‡ªå·±çš„ä¸šåŠ¡è§’åº¦æ¥.</p><h2 id="å®ç°æ€è·¯"><a href="#å®ç°æ€è·¯" class="headerlink" title="å®ç°æ€è·¯"></a>å®ç°æ€è·¯</h2><p>è¿™é‡Œæ˜¯è¯´ä¸‹ä¸ªäººçš„å®ç°æ€è·¯ :</p><ul><li>æ–¹æ¡ˆä¸€ : å…ˆå®šä¹‰å¥½ç±»,ç„¶åä½¿ç”¨åå°„æ ¹æ®å®šä¹‰çš„ç±»,åˆ›å»ºå¥½ä¸€ä¸ªå¯¹è±¡å‡ºæ¥,ç„¶åå°†è¿™ä¸ªå¯¹è±¡ç»™æ³¨å…¥åˆ°Springå®¹å™¨ä¸­æ¥,è¿™é‡Œä¸ä»…ä»…æ˜¯æ³¨å…¥è¿›æ¥è¿™ä¹ˆç®€å•,è¿˜æ˜¯éœ€è¦ç»è¿‡ MVC(ä¹Ÿå°±æ˜¯Controllerç­‰æ³¨è§£çš„åŒ¹é…æ“ä½œ)æ¥å®ç°</li><li>æ–¹æ¡ˆäºŒ : åŸºäºè¯·æ±‚404çš„æ‹¦æˆªæ¥ç°å®. æ¯”å¦‚ä½ æ–°æ·»åŠ çš„æ¥å£è®¿é—®è‚¯å®šæ˜¯404,äºæ˜¯æˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªæ‹¦æˆª,ç„¶åè·å–å‡ºè¯·æ±‚çš„è·¯å¾„,æ ¹æ®æå‰å®šå¥½çš„ä¸€äº›è®¾ç½®,è¿›è¡Œé€»è¾‘çš„å¤„ç†.</li></ul><p>è¿™é‡Œè‚¯å®šè¿˜ä¼šæœ‰å¾ˆå¤šå¥½çš„å®ç°æ€è·¯,å¹¶ä¸”åŸºäºæ¯ä¸ªæ¡†æ¶éƒ½æ˜¯ä¸ä¸€æ ·çš„,è¿™é‡Œæ›´å¤šçš„æ˜¯åŸºäº SpringBootæ¡†æ¶æ¥å®ç°è¿™ä¸ªæ€è·¯çš„.</p><h2 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h2><h3 id="åŸºäºåå°„åˆ›å»ºbeanæ³¨å…¥ä»£ç å®ç°"><a href="#åŸºäºåå°„åˆ›å»ºbeanæ³¨å…¥ä»£ç å®ç°" class="headerlink" title="åŸºäºåå°„åˆ›å»ºbeanæ³¨å…¥ä»£ç å®ç°"></a>åŸºäºåå°„åˆ›å»ºbeanæ³¨å…¥ä»£ç å®ç°</h3><p>å®šä¹‰ä¸€ä¸ªç±»çš„æ¨¡æ¿</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">String</span> <span class="variable">templateValue</span> <span class="operator">=</span> <span class="string">&quot;import org.springframework.web.bind.annotation.GetMapping;\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;import org.springframework.web.bind.annotation.RequestMapping;\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;import org.springframework.web.bind.annotation.RestController;\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;@RestController\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;@RequestMapping(\&quot;/test\&quot;)\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;public class TestController &#123;\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;    @GetMapping(\&quot;/test\&quot;)\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;    public String test()&#123;\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;        return \&quot;æµ‹è¯•Testæ¥å£\&quot;;\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;    &#125;\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;&#125;&quot;</span>;</span><br></pre></td></tr></table></figure><p>æä¾›ä¸€ä¸ªæ¥å£æ¥åå°„åˆ›å»ºå¯¹è±¡å¹¶ä¸”æ³¨å…¥åˆ°springå®¹å™¨ä¸­æ¥:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/create&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createTemplate</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        Map&lt;String, <span class="type">byte</span>[]&gt; bytecode = DynamicLoader.compile(<span class="string">&quot;TestController.java&quot;</span>, templateValue);</span><br><span class="line">        <span class="type">MemoryClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MemoryClassLoader</span>(bytecode);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> classLoader.loadClass(<span class="string">&quot;TestController&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> clazz.newInstance();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ³¨å…¥ bean å®¹å™¨çš„ä»£ç  : å®¹å™¨ä¸­æ˜¯å­˜åœ¨è¿™ä¸ª bean å¯¹è±¡çš„,ä½†æ˜¯Controllerå´æ²¡æœ‰è®¿é—®åˆ°.</span></span><br><span class="line">        <span class="type">BeanDefinitionBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> BeanDefinitionBuilder.genericBeanDefinition(object.getClass());</span><br><span class="line">        <span class="type">ConfigurableApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> springUtils.getContext();</span><br><span class="line">        <span class="type">DefaultListableBeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> (DefaultListableBeanFactory) context.getBeanFactory();</span><br><span class="line">        beanFactory.registerBeanDefinition(<span class="string">&quot;testController&quot;</span>,builder.getBeanDefinition());</span><br><span class="line"></span><br><span class="line">        <span class="type">RequestMappingHandlerMapping</span> <span class="variable">mappingHandlerMapping</span> <span class="operator">=</span> context.getBean(RequestMappingHandlerMapping.class);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">oj</span> <span class="operator">=</span> context.getBean(<span class="string">&quot;testController&quot;</span>);</span><br><span class="line">        Map&lt;Method, RequestMappingInfo&gt; methods = MethodIntrospector.selectMethods(oj.getClass(),(MethodIntrospector.MetadataLookup&lt;RequestMappingInfo&gt;) method -&gt;&#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                <span class="type">RequestMapping</span> <span class="variable">requestMapping</span> <span class="operator">=</span> AnnotatedElementUtils.findMergedAnnotation(method, RequestMapping.class);</span><br><span class="line">                RequestMappingInfo.<span class="type">Builder</span> <span class="variable">mappping</span> <span class="operator">=</span> RequestMappingInfo.paths(requestMapping.path())</span><br><span class="line">                                  .methods(requestMapping.method())</span><br><span class="line">                                  .params(requestMapping.params())</span><br><span class="line">                                  .headers(requestMapping.headers())</span><br><span class="line">                                  .consumes(requestMapping.consumes())</span><br><span class="line">                                  .produces(requestMapping.produces())</span><br><span class="line">                                  .mappingName(requestMapping.name());</span><br><span class="line">                <span class="keyword">return</span> mappping.build();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">Method</span> <span class="variable">rmhmMethod</span> <span class="operator">=</span> mappingHandlerMapping.getClass()</span><br><span class="line">                            .getDeclaredMethod(<span class="string">&quot;registerHandlerMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Method.class, Object.class&#125;);</span><br><span class="line"></span><br><span class="line">        rmhmMethod.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        methods.forEach((method,mapping) -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                rmhmMethod.invoke(mappingHandlerMapping,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;oj,method,mapping&#125; );</span><br><span class="line">            &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>Springå·¥å…·ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringUtils</span> <span class="keyword">implements</span> <span class="title class_">ApplicationContextAware</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ApplicationContext context;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        context = applicationContext;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ConfigurableApplicationContext <span class="title function_">getContext</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (ConfigurableApplicationContext)context;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setContext</span><span class="params">(ApplicationContext context)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.context = context;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ°æ­¤,å°±å¯ä»¥åŠ¨æ€çš„åˆ›å»ºå‡ºä¸€ä¸ªæ¥å£æ¥äº†ã€‚</p><p>å½“ç„¶äº†,è¿™é‡Œçš„ä»£ç éƒ½æ˜¯å†™å›ºå®šåœ¨ä»£ç é‡Œé¢çš„,å¯ä»¥æä¾› template æˆ–è€… é€šè¿‡é¡µé¢å®šä¹‰ç»™æ·»åŠ è¿›æ¥, ç„¶åè°ƒç”¨ åå°„&#x2F;æ³¨å…¥åˆ°Springå®¹å™¨ä¸­ç­‰æ“ä½œå³å¯.</p><h3 id="åŸºäº-404-æ‹¦æˆªè¯·æ±‚"><a href="#åŸºäº-404-æ‹¦æˆªè¯·æ±‚" class="headerlink" title="åŸºäº 404 æ‹¦æˆªè¯·æ±‚"></a>åŸºäº 404 æ‹¦æˆªè¯·æ±‚</h3><p>è¿™æ˜¯ SpringBoot æœ¬æ¥å°±æœ‰çš„ 404 æ‹¦æˆªå®ç°, å¦‚æœä¸åšä»€ä¹ˆå¤„ç†çš„è¯,é‚£ä¹ˆè¿›å…¥åˆ°è¿™é‡Œæ¥çš„urlåœ°å€å°±ä¼šæ˜¯&#x2F;error,æ˜¯æ— æ³•æ»¡è¶³å®ç°çš„.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SelfErrorController</span> <span class="keyword">implements</span> <span class="title class_">ErrorController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">ERROR_PATH</span> <span class="operator">=</span> <span class="string">&quot;/error&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Supports the HTML Error View</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(value = ERROR_PATH)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">errorHtml</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">statusCode</span> <span class="operator">=</span> (Integer) request.getAttribute(<span class="string">&quot;javax.servlet.error.status_code&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">requestURI</span> <span class="operator">=</span> request.getRequestURI();</span><br><span class="line">        log.info(<span class="string">&quot;åœ¨SelfErrorControllerä¸­è¯·æ±‚çš„è·¯å¾„ : &#123;&#125; &quot;</span> ,requestURI);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ‹¿åˆ°è·¯å¾„åå°±å¯ä»¥æ‰§è¡Œç›¸åº”çš„ä»£ç é€»è¾‘.</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">realUrlName</span> <span class="operator">=</span> request.getAttribute(<span class="string">&quot;realName&quot;</span>).toString();</span><br><span class="line">        log.info(<span class="string">&quot;åœ¨SelfErrorControllerä¸­çœŸå®å­˜åœ¨çš„è¯·æ±‚è·¯å¾„æ˜¯ : --&gt; &#123;&#125; &quot;</span> , realUrlName);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(statusCode == <span class="number">401</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span>  <span class="string">&quot;&#123; \&quot;code\&quot;: \&quot;401\&quot;&#125;&quot;</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(statusCode == <span class="number">404</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&#123; \&quot;code\&quot;: \&quot;404\&quot;&#125;&quot;</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(statusCode == <span class="number">403</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&#123; \&quot;code\&quot;: \&quot;403\&quot;&#125;&quot;</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&#123; \&quot;code\&quot;: \&quot;500\&quot;&#125;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getErrorPath</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› ä¸ºä¸Šé¢æ— æ³•æ»¡è¶³çš„å‰æä¸‹,æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ‹¦æˆªæ¥é…ç½®åŸæ¥çš„è·¯å¾„.</p><p>é…ç½®ç±»:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyWebAppConfigurer</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;</span><br><span class="line">        registry.addInterceptor(<span class="keyword">new</span> <span class="title class_">SelfInterceptor</span>()).addPathPatterns(<span class="string">&quot;/**&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è‡ªå®šä¹‰æ‹¦æˆªå™¨:</p><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°å°†åŸæœ‰çš„è·¯å¾„ç»™setå­—æ®µrealNameäº†.</p><p>æ‰€ä»¥åœ¨ä¸Šé¢çš„erroræ¥å£,æˆ‘ä»¬è°ƒç”¨è¿™ä¸ªrealNameå­—æ®µå°±å¯ä»¥è·å–åˆ°äº†åŸæœ‰çš„è·¯å¾„.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SelfInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span><br><span class="line"><span class="params">                             Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// å‰ç½®æ‹¦æˆªå™¨</span></span><br><span class="line">        log.info(<span class="string">&quot;å‰ç½®æ‹¦æˆªå™¨è°ƒç”¨ : com.iyang.hello.boot.config.SelfInterceptor.preHandle ä¸­æ¥.&quot;</span> );</span><br><span class="line">        <span class="type">String</span> <span class="variable">requestURI</span> <span class="operator">=</span> request.getRequestURI();</span><br><span class="line">        log.info(<span class="string">&quot;åœ¨preHandleæ–¹æ³•ä¸­æ•æ‰åˆ°çš„è¯·æ±‚è·¯å¾„ : ---&gt; &#123;&#125; &quot;</span> , requestURI);</span><br><span class="line">        <span class="comment">// handler æ˜¯ ResourceHttpRequestHandler</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span><br><span class="line"><span class="params">                           Object handler, ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">requestURI</span> <span class="operator">=</span> request.getRequestURI();</span><br><span class="line">        request.setAttribute(<span class="string">&quot;realName&quot;</span>,requestURI);</span><br><span class="line">        <span class="keyword">if</span>(response.getStatus() == <span class="number">404</span>)&#123;</span><br><span class="line">            log.info(<span class="string">&quot;çŠ¶æ€æ˜¯404æ­£å¸¸æ“ä½œ&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">&quot;è¯·æ±‚çš„urlè·¯å¾„æ˜¯ ---&gt; &#123;&#125; &quot;</span> , requestURI);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span><br><span class="line"><span class="params">                                Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è¯¥æŠ€èƒ½çœ‹åˆ°æ¯”è¾ƒæœ‰æ„æ€,å…·ä½“çš„å®ç°å’Œè®¾è®¡æ€è·¯å…¶å®æ˜¯æœ‰å¾ˆå¤šç§çš„,å…·ä½“å¾—çœ‹é¡¹ç›®çš„ä¸šåŠ¡æ˜¯ä¸æ˜¯éœ€è¦ä½¿ç”¨.</p><p>å¹¶ä¸”å®ç°çš„æ€è·¯å¹¶ä¸æ˜¯åªæœ‰è¿™ä¸€ç§,è‚¯å®šæ˜¯è¿˜æœ‰å¾ˆå¤šç§çš„.</p><p>é€‚åˆè‡ªå·±çš„ä¸šåŠ¡æ˜¯æœ€å¥½çš„.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h2&gt;&lt;p&gt;æœ€è¿‘çœ‹äº†å…¬å¸çš„äº§å“,æœ‰ä¸€ä¸ªè¿™æ ·çš„åŠ¨æ€,å°±æ˜¯æ ¹æ®inputè¾“å…¥çš„å†…å®¹,è¿›è¡ŒåŠ¨æ€æ¥å£çš„æ·»åŠ .&lt;/p&gt;
&lt;p&gt;æ¯”å¦‚ æˆ‘åœ¨æ²¡æœ‰æ·»åŠ ä¹‹å‰,è®¿é—® &lt;a </summary>
      
    
    
    
    <category term="java" scheme="https://ruy9527.github.io/categories/java/"/>
    
    <category term="springBoot" scheme="https://ruy9527.github.io/categories/java/springBoot/"/>
    
    
    <category term="java" scheme="https://ruy9527.github.io/tags/java/"/>
    
    <category term="springBoot" scheme="https://ruy9527.github.io/tags/springBoot/"/>
    
  </entry>
  
  <entry>
    <title>springçš„refreshæ–¹æ³•é˜…è¯»</title>
    <link href="https://ruy9527.github.io/2021/11/04/spring/spring%E7%9A%84refresh%E6%96%B9%E6%B3%95%E9%98%85%E8%AF%BB/"/>
    <id>https://ruy9527.github.io/2021/11/04/spring/spring%E7%9A%84refresh%E6%96%B9%E6%B3%95%E9%98%85%E8%AF%BB/</id>
    <published>2021-11-03T16:17:10.000Z</published>
    <updated>2022-11-04T13:46:13.920Z</updated>
    
    <content type="html"><![CDATA[<h4 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h4><p>è¿™é‡Œæ˜¯ç›¸å¯¹ä¸Šä¸€æ¬¡å†æ¬¡çš„é˜…è¯»å’Œè®°å½•,æ¯”ä¸Šæ¬¡æœ‰äº†æ›´æ·±å…¥çš„ç†è§£.</p><p>è¿™é‡Œæ˜¯å†æ¬¡æ•´ç†çš„é˜…è¯» Spring çš„æºç , ç›¸å¯¹æ¯”ä¸Šæ¬¡çš„é˜…è¯»ï¼Œæˆ‘å¸Œæœ›è¿™æ¬¡å¯ä»¥æ›´æ¸…æ™°&amp;æ›´æ·±åˆ»çš„ç†è§£Spring,ä¹Ÿä¸ä»…ä»…ä¼šä»ä¸€ä¸ªæ¡ˆä¾‹æ¥è¿›è¡Œåˆ†æï¼Œä¼šç»“åˆå¤šæ–¹é¢çš„çŸ¥è¯†æ¥è¿›è¡Œæ•´ç†åˆ†æ.</p><p> è¿™é‡Œæ”¾ä¸Šä¹‹å‰é˜…è¯»çš„æ¯”ä¾‹ : <a href="https://github.com/baoyang23/source-notes/tree/master/java/spring_bean">https://github.com/baoyang23/source-notes/tree/master/java/spring_bean</a></p><p> è¯¥ç›®å½•ä¸‹é¢æœ‰ : bean&#x2F;get&#x2F;extend ä¸‰ä¸ªä¸»è¦åœ°æ–¹çš„åˆ†æ.</p><p> æ­¤æ¨¡å—è¿˜æ˜¯è®²è¿° æ•´ä½“çš„ flow,åé¢ä¼šå¯¹å•ä¸ªè¿›è¡Œåˆ†æ&amp;Springæä¾›æ€ä¹ˆæ ·çš„æ‰©å±•æ–¹å¼æ¥è¿›è¡Œå¢å¼ºæ‰©å±•ç­‰.</p><p>æ¡ˆä¾‹å…¥é—¨æ“ä½œçš„è¯,å¯ä»¥å‚è€ƒä¹‹å‰çš„åšå®¢.</p><h4 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h4><p> è¿™é‡Œæˆ‘ä»¬å…ˆä¸å¿™è¿™å…¶ä»–ç±»å‹çš„beanåˆ†æ, å°±å¯¹æˆ‘ä»¬ä½œä¸º config çš„ bean è¿›è¡Œåˆ†æ. å…ˆå•ä¸ªåˆ†æå®¹æ˜“ç†è§£äº›.</p><p> å…¥å£ç±» :</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InitWorkFlowSpring</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">AnnotationConfigApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(YangBeanScannerConfig.class);</span><br><span class="line">        <span class="type">YangBeanScannerConfig</span> <span class="variable">yangBeanScannerConfig</span> <span class="operator">=</span> context.getBean(YangBeanScannerConfig.class);</span><br><span class="line">        yangBeanScannerConfig.say();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> é…ç½®ç±»:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ComponentScan(basePackages = &quot;com.iyang.spring&quot;)</span></span><br><span class="line"><span class="meta">@Description(value = &quot;This is GavinYang DemoWorld.&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">YangBeanScannerConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">YangBeanScannerConfig</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;é…ç½®æ‰«æåˆå§‹åŒ–æ‰“å°&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">say</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;æˆ‘æ˜¯ä»Springå®¹å™¨ä¸­è·å–å‡ºæ¥çš„&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œå½“æˆ‘ä»¬å¯åŠ¨ main æ–¹æ³•çš„æ—¶å€™ï¼Œæ˜¯å¯ä»¥çœ‹åˆ° YangBeanScannerConfig ä¸­æ„é€ å‡½æ•°æ‰“å°çš„å†…å®¹å’Œè°ƒç”¨sayæ–¹æ³•æ‰“å°å‡ºæ¥çš„å†…å®¹.</p><p>åŸºäºè¿™ä¸ªåŸºç¡€ä¸Š,æˆ‘ä»¬debugä¸€å±‚ä¸€å±‚çš„èµ°è¿›å»çœ‹,Springåšäº†ä»€ä¹ˆäº‹æƒ….</p><p>å…ˆè¿›å…¥åˆ°æˆ‘ä»¬newå‡ºæ¥çš„AnnotationConfigApplicationContextä¸­æ¥</p><p>è°ƒç”¨è‡ªèº«çš„æ— å‚æ„é€ å‡½æ•°</p><p>è°ƒç”¨ register æ³¨å†Œæ–¹æ³•</p><p>æœ€åè°ƒç”¨ä¸€ä¸ª refresh, refresh æ–¹æ³•ä¸­æ˜¯åšäº†å¾ˆå¤šäº‹çš„.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">AnnotationConfigApplicationContext</span><span class="params">(Class&lt;?&gt;... componentClasses)</span> &#123;</span><br><span class="line">   <span class="built_in">this</span>();</span><br><span class="line">   register(componentClasses);</span><br><span class="line">   refresh();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆæœ‰äº†å…¥å£ï¼Œæˆ‘ä»¬å°±æ ¹æ®è¿™äº›æ–¹æ³•æ¥ä¸€ä¸ªä¸€ä¸ªçš„åˆ†æ.</p><h4 id="this-æ–¹æ³•-â€”-gt-org-springframework-context-annotation-AnnotationConfigApplicationContext-AnnotationConfigApplicationContext"><a href="#this-æ–¹æ³•-â€”-gt-org-springframework-context-annotation-AnnotationConfigApplicationContext-AnnotationConfigApplicationContext" class="headerlink" title="this() æ–¹æ³• â€”&gt; org.springframework.context.annotation.AnnotationConfigApplicationContext#AnnotationConfigApplicationContext()"></a>this() æ–¹æ³• â€”&gt; org.springframework.context.annotation.AnnotationConfigApplicationContext#AnnotationConfigApplicationContext()</h4><p>å…ˆæ¥çœ‹ this æ–¹æ³•åšäº†ä»€ä¹ˆäº‹æƒ….</p><p>åˆ›å»ºäº†äºŒä¸ªå¯¹è±¡ï¼Œåˆ†åˆ«æ˜¯ æ³¨è§£bdè¯»å–&#x2F;ç±»è·¯å£dbæ‰«æ.</p><p>æ¯”å¦‚æœ‰æ„æ€çš„æ˜¯,ä¼ å…¥this(AnnotationConfigApplicationContext), ç„¶åè¿”å›æ¥çš„reader&#x2F;scanneråˆå±äºthis.ä¹Ÿæ˜¯ç›¸äº’ä¹‹é—´å„è‡ªéƒ½æŒæœ‰å„è‡ªçš„å¼•ç”¨.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">AnnotationConfigApplicationContext</span><span class="params">()</span> &#123;</span><br><span class="line">   <span class="built_in">this</span>.reader = <span class="keyword">new</span> <span class="title class_">AnnotatedBeanDefinitionReader</span>(<span class="built_in">this</span>);</span><br><span class="line">   <span class="built_in">this</span>.scanner = <span class="keyword">new</span> <span class="title class_">ClassPathBeanDefinitionScanner</span>(<span class="built_in">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="new-AnnotatedBeanDefinitionReader"><a href="#new-AnnotatedBeanDefinitionReader" class="headerlink" title="new AnnotatedBeanDefinitionReader"></a>new AnnotatedBeanDefinitionReader</h5><p>æ¥ï¼Œçœ‹ä¸‹newä¸€ä¸ªå¯¹è±¡åšäº†ä»€ä¹ˆäº‹æƒ….</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">AnnotatedBeanDefinitionReader</span><span class="params">(BeanDefinitionRegistry registry)</span> &#123;</span><br><span class="line"><span class="comment">// è¿™é‡Œçš„ getOrCreateEnvironment æ–¹æ³•ä¸­,AnnotationConfigApplicationContextæ˜¯EnvironmentCapableçš„å­ç±»,</span></span><br><span class="line"><span class="comment">// æ‰€ä»¥Environmentä¹Ÿæ˜¯ä»AnnotationConfigApplicationContextä¸­è·å–å‡ºæ¥çš„.    </span></span><br><span class="line">   <span class="built_in">this</span>(registry, getOrCreateEnvironment(registry));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">--------------</span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span> <span class="title function_">AnnotatedBeanDefinitionReader</span><span class="params">(BeanDefinitionRegistry registry, Environment environment)</span> &#123;</span><br><span class="line"> <span class="comment">// æ£€éªŒ registry/environmentéƒ½ä¸èƒ½ä¸ºnull.   </span></span><br><span class="line">Assert.notNull(registry, <span class="string">&quot;BeanDefinitionRegistry must not be null&quot;</span>);</span><br><span class="line">Assert.notNull(environment, <span class="string">&quot;Environment must not be null&quot;</span>);</span><br><span class="line"><span class="built_in">this</span>.registry = registry;</span><br><span class="line"><span class="comment">// è¿™é‡Œå°† registry/environment ç»™ä¼ å…¥æ„é€ åˆ° org.springframework.context.annotation.ConditionEvaluator ä¸­æ¥.</span></span><br><span class="line"><span class="comment">// ConditionEvaluatoråˆå€ŸåŠ©org.springframework.context.annotation.ConditionEvaluator.ConditionContextImpl#ConditionContextImpl æ¥å­˜å‚¨è¿™äº›ä¿¡æ¯,æ‰€ä»¥è¿™é‡Œæœ€åçš„ä¿¡æ¯æ˜¯åœ¨ConditionContextImplä¸­æ¥äº†.    </span></span><br><span class="line"><span class="built_in">this</span>.conditionEvaluator = <span class="keyword">new</span> <span class="title class_">ConditionEvaluator</span>(registry, environment, <span class="literal">null</span>);</span><br><span class="line"><span class="comment">// org.springframework.context.annotation.AnnotationConfigUtils#registerAnnotationConfigProcessors(org.springframework.beans.factory.support.BeanDefinitionRegistry, java.lang.Object)</span></span><br><span class="line"><span class="comment">// ä»è¯¥æ–¹æ³•çš„åå­—ä¸Šçœ‹,æ˜¯å¯¹æ³¨å†Œæ³¨è§£é…ç½®è¿›è¡Œå¤„ç†.    </span></span><br><span class="line">AnnotationConfigUtils.registerAnnotationConfigProcessors(<span class="built_in">this</span>.registry);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="org-springframework-context-annotation-AnnotationConfigUtils-registerAnnotationConfigProcessors-org-springframework-beans-factory-support-BeanDefinitionRegistry-java-lang-Object-åˆ†æ"><a href="#org-springframework-context-annotation-AnnotationConfigUtils-registerAnnotationConfigProcessors-org-springframework-beans-factory-support-BeanDefinitionRegistry-java-lang-Object-åˆ†æ" class="headerlink" title="org.springframework.context.annotation.AnnotationConfigUtils#registerAnnotationConfigProcessors(org.springframework.beans.factory.support.BeanDefinitionRegistry, java.lang.Object) åˆ†æ"></a>org.springframework.context.annotation.AnnotationConfigUtils#registerAnnotationConfigProcessors(org.springframework.beans.factory.support.BeanDefinitionRegistry, java.lang.Object) åˆ†æ</h6><p>è¿™é‡Œæ ¹æ®æˆ‘ä»¬çš„æ¡ˆåˆ—ï¼Œä¼ å…¥è¿›æ¥çš„sourceæ˜¯null.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Set&lt;BeanDefinitionHolder&gt; <span class="title function_">registerAnnotationConfigProcessors</span><span class="params">(</span></span><br><span class="line"><span class="params">      BeanDefinitionRegistry registry, <span class="meta">@Nullable</span> Object source)</span> &#123;</span><br><span class="line"><span class="comment">// æ ¹æ® registry çš„ç±»å‹æ¥è·å– DefaultListableBeanFactory.</span></span><br><span class="line"><span class="comment">// è¿™é‡Œçš„registryå±äºGenericApplicationContext,è°ƒç”¨å…¶getDefaultListableBeanFactoryæ¥è·å–.    </span></span><br><span class="line">   <span class="type">DefaultListableBeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> unwrapDefaultListableBeanFactory(registry);</span><br><span class="line">   <span class="keyword">if</span> (beanFactory != <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="comment">// beanFactory.getDependencyComparator() è¿”å›çš„æ˜¯null,æ»¡è¶³æ¡ä»¶.       </span></span><br><span class="line">      <span class="keyword">if</span> (!(beanFactory.getDependencyComparator() <span class="keyword">instanceof</span> AnnotationAwareOrderComparator)) &#123;</span><br><span class="line"><span class="comment">// è®¾ç½® AnnotationAwareOrderComparator åˆ°beanFactoryä¸­æ¥          </span></span><br><span class="line">         beanFactory.setDependencyComparator(AnnotationAwareOrderComparator.INSTANCE);</span><br><span class="line">      &#125;</span><br><span class="line"><span class="comment">// getæ–¹æ³•è·å–å‡ºæ¥çš„æ˜¯SimpleAutowireCandidateResolver,       </span></span><br><span class="line">      <span class="keyword">if</span> (!(beanFactory.getAutowireCandidateResolver() <span class="keyword">instanceof</span> ContextAnnotationAutowireCandidateResolver)) &#123;</span><br><span class="line"><span class="comment">// è®¾ç½®ContextAnnotationAutowireCandidateResolveråˆ°beanFactoryä¸­æ¥.          </span></span><br><span class="line">         beanFactory.setAutowireCandidateResolver(<span class="keyword">new</span> <span class="title class_">ContextAnnotationAutowireCandidateResolver</span>());</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   Set&lt;BeanDefinitionHolder&gt; beanDefs = <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>&lt;&gt;(<span class="number">8</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯ä»¥çœ‹åˆ°æ¯ä¸ªéƒ½æœ‰ internal æ¥ç‰¹æ„è¡¨æ˜å†…éƒ¨çš„æ„æ€.    </span></span><br><span class="line"><span class="comment">// org.springframework.context.annotation.internalConfigurationAnnotationProcessor ---&gt;  ConfigurationClassPostProcessor</span></span><br><span class="line"><span class="comment">// org.springframework.context.annotation.internalAutowiredAnnotationProcessor  --&gt; AutowiredAnnotationBeanPostProcessor</span></span><br><span class="line"><span class="comment">// org.springframework.context.annotation.internalCommonAnnotationProcessor   ---&gt; CommonAnnotationBeanPostProcessor </span></span><br><span class="line"><span class="comment">// org.springframework.context.annotation.internalPersistenceAnnotationProcessor  ---&gt; PersistenceAnnotationBeanPostProcessor</span></span><br><span class="line"><span class="comment">// org.springframework.context.event.internalEventListenerProcessor   ---&gt; EventListenerMethodProcessor</span></span><br><span class="line"><span class="comment">// org.springframework.context.event.internalEventListenerFactory  --- &gt; DefaultEventListenerFactory</span></span><br><span class="line">   <span class="keyword">if</span> (!registry.containsBeanDefinition(CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME)) &#123;</span><br><span class="line">      <span class="type">RootBeanDefinition</span> <span class="variable">def</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RootBeanDefinition</span>(ConfigurationClassPostProcessor.class);</span><br><span class="line">      def.setSource(source);</span><br><span class="line">      beanDefs.add(registerPostProcessor(registry, def, CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (!registry.containsBeanDefinition(AUTOWIRED_ANNOTATION_PROCESSOR_BEAN_NAME)) &#123;</span><br><span class="line">      <span class="type">RootBeanDefinition</span> <span class="variable">def</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RootBeanDefinition</span>(AutowiredAnnotationBeanPostProcessor.class);</span><br><span class="line">      def.setSource(source);</span><br><span class="line">      beanDefs.add(registerPostProcessor(registry, def, AUTOWIRED_ANNOTATION_PROCESSOR_BEAN_NAME));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Check for JSR-250 support, and if present add the CommonAnnotationBeanPostProcessor.</span></span><br><span class="line">   <span class="keyword">if</span> (jsr250Present &amp;&amp; !registry.containsBeanDefinition(COMMON_ANNOTATION_PROCESSOR_BEAN_NAME)) &#123;</span><br><span class="line">      <span class="type">RootBeanDefinition</span> <span class="variable">def</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RootBeanDefinition</span>(CommonAnnotationBeanPostProcessor.class);</span><br><span class="line">      def.setSource(source);</span><br><span class="line">      beanDefs.add(registerPostProcessor(registry, def, COMMON_ANNOTATION_PROCESSOR_BEAN_NAME));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Check for JPA support, and if present add the PersistenceAnnotationBeanPostProcessor.</span></span><br><span class="line">   <span class="keyword">if</span> (jpaPresent &amp;&amp; !registry.containsBeanDefinition(PERSISTENCE_ANNOTATION_PROCESSOR_BEAN_NAME)) &#123;</span><br><span class="line">      <span class="type">RootBeanDefinition</span> <span class="variable">def</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RootBeanDefinition</span>();</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         def.setBeanClass(ClassUtils.forName(PERSISTENCE_ANNOTATION_PROCESSOR_CLASS_NAME,</span><br><span class="line">               AnnotationConfigUtils.class.getClassLoader()));</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (ClassNotFoundException ex) &#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(</span><br><span class="line">               <span class="string">&quot;Cannot load optional framework class: &quot;</span> + PERSISTENCE_ANNOTATION_PROCESSOR_CLASS_NAME, ex);</span><br><span class="line">      &#125;</span><br><span class="line">      def.setSource(source);</span><br><span class="line">      beanDefs.add(registerPostProcessor(registry, def, PERSISTENCE_ANNOTATION_PROCESSOR_BEAN_NAME));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (!registry.containsBeanDefinition(EVENT_LISTENER_PROCESSOR_BEAN_NAME)) &#123;</span><br><span class="line">      <span class="type">RootBeanDefinition</span> <span class="variable">def</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RootBeanDefinition</span>(EventListenerMethodProcessor.class);</span><br><span class="line">      def.setSource(source);</span><br><span class="line">      beanDefs.add(registerPostProcessor(registry, def, EVENT_LISTENER_PROCESSOR_BEAN_NAME));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (!registry.containsBeanDefinition(EVENT_LISTENER_FACTORY_BEAN_NAME)) &#123;</span><br><span class="line">      <span class="type">RootBeanDefinition</span> <span class="variable">def</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RootBeanDefinition</span>(DefaultEventListenerFactory.class);</span><br><span class="line">      def.setSource(source);</span><br><span class="line">      beanDefs.add(registerPostProcessor(registry, def, EVENT_LISTENER_FACTORY_BEAN_NAME));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> beanDefs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œéƒ½æ˜¯å…ˆåˆ¤æ–­è¿™äº›å†…éƒ¨çš„bean,æ˜¯ä¸æ˜¯å·²ç»åœ¨ registry ä¸­å·²ç»å­˜åœ¨äº†,å¦‚æœæ²¡æœ‰å­˜åœ¨çš„è¯ï¼Œå°±ä¼šåˆ©ç”¨ç±»ä¿¡æ¯æ¥æ„é€ å‡ºä¸€ä¸ªRootBeanDefinitionæ¥,æ¥ç€å°±æ˜¯è°ƒç”¨ registerPostProcessor æ–¹æ³•ç»™æ³¨å†Œåˆ° registry ä¸­æ¥.</p><p>æœ€åè¿”å›ä¸€ä¸ªæ³¨å†Œè¿‡çš„ bean çš„ Set é›†åˆå›å».</p><p>æ€»ç»“ä¸‹è¿™é‡Œå°±æ˜¯ä¸ºäº†ç»™springå®¹å™¨ä¸­æ³¨å†Œä¸€äº›å†…éƒ¨çš„ bean è¿›å». è¿™äº›æ³¨å†Œè¿›å»çš„bean,éƒ½æ˜¯åœ¨åé¢åˆå§‹åŒ–bean&amp;è§£æbeanç­‰æƒ…å†µæœ‰ä½¿ç”¨åˆ°çš„.</p><h5 id="new-ClassPathBeanDefinitionScanner-æ–¹æ³•"><a href="#new-ClassPathBeanDefinitionScanner-æ–¹æ³•" class="headerlink" title="new ClassPathBeanDefinitionScanner() æ–¹æ³•"></a>new ClassPathBeanDefinitionScanner() æ–¹æ³•</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ClassPathBeanDefinitionScanner</span><span class="params">(BeanDefinitionRegistry registry, <span class="type">boolean</span> useDefaultFilters)</span> &#123;</span><br><span class="line">   <span class="built_in">this</span>(registry, useDefaultFilters, getOrCreateEnvironment(registry));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-----------------------------------------------------</span><br><span class="line"><span class="comment">// æœ€åèµ°åˆ° org.springframework.context.annotation.ClassPathBeanDefinitionScanner#ClassPathBeanDefinitionScanner(org.springframework.beans.factory.support.BeanDefinitionRegistry, boolean, org.springframework.core.env.Environment, org.springframework.core.io.ResourceLoader) æ„é€ å‡½æ•°æ¥.    </span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">ClassPathBeanDefinitionScanner</span><span class="params">(BeanDefinitionRegistry registry, <span class="type">boolean</span> useDefaultFilters,</span></span><br><span class="line"><span class="params">Environment environment, <span class="meta">@Nullable</span> ResourceLoader resourceLoader)</span> &#123;</span><br><span class="line"></span><br><span class="line">Assert.notNull(registry, <span class="string">&quot;BeanDefinitionRegistry must not be null&quot;</span>);</span><br><span class="line"><span class="comment">// èµ‹å€¼ registry æ¥.    </span></span><br><span class="line"><span class="built_in">this</span>.registry = registry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (useDefaultFilters) &#123;</span><br><span class="line"><span class="comment">// æ·»åŠ  filter åˆ° includeFilters ä¸­æ¥.</span></span><br><span class="line"><span class="comment">// AnnotationTypeFilter(Component.class)</span></span><br><span class="line"><span class="comment">// AnnotationTypeFilter(((Class&lt;? extends Annotation&gt;) ClassUtils.forName(&quot;javax.annotation.ManagedBean&quot;, cl)     </span></span><br><span class="line"><span class="comment">// ç­‰ä¿¡æ¯è¿›æ¥      </span></span><br><span class="line">registerDefaultFilters();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// org.springframework.context.annotation.ClassPathScanningCandidateComponentProvider#setEnvironment</span></span><br><span class="line"><span class="comment">// è®¾ç½® enviornmentåˆ°çˆ¶ç±»ä¸­æ¥.    </span></span><br><span class="line">setEnvironment(environment);</span><br><span class="line"><span class="comment">// è¿™é‡Œä¹Ÿæ˜¯è¿™æ˜¯åˆ°çˆ¶ç±»æ¥äº†.</span></span><br><span class="line"><span class="comment">// è¿”å›çš„resourcePatternResolveræ˜¯AnnotationConfigApplicationContext.</span></span><br><span class="line"><span class="comment">// metadataReaderFactory æ˜¯ CachingMetadataReaderFactory å¯¹è±¡æ¥.</span></span><br><span class="line"><span class="comment">// componentsIndex æ˜¯ null.    </span></span><br><span class="line">setResourceLoader(resourceLoader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•å¯ä»¥çœ‹åˆ°,æ·»åŠ äº†ä¸‰ä¸ª filter åˆ° includeFilters ä¸­æ¥.</p><p>è®¾ç½®environment &#x2F; resource åˆ° å…¶çˆ¶ç±»org.springframework.context.annotation.ClassPathScanningCandidateComponentProvider ä¸­æ¥.</p><p>ä¹Ÿå°±æ˜¯setXXXæ–¹æ³•æ˜¯è°ƒç”¨çš„çˆ¶ç±».</p><h4 id="register-componentClasses-æ–¹æ³•"><a href="#register-componentClasses-æ–¹æ³•" class="headerlink" title="register(componentClasses) æ–¹æ³•"></a>register(componentClasses) æ–¹æ³•</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">register</span><span class="params">(Class&lt;?&gt;... componentClasses)</span> &#123;</span><br><span class="line">   <span class="comment">//  æ£€éªŒä¼ å…¥è¿›æ¥çš„ comonpentClassesæ˜¯ä¸€å®šè¦æœ‰å€¼çš„. </span></span><br><span class="line">   Assert.notEmpty(componentClasses, <span class="string">&quot;At least one component class must be specified&quot;</span>);</span><br><span class="line">   <span class="built_in">this</span>.reader.register(componentClasses);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-------------------------</span><br><span class="line"><span class="comment">// è¿™é‡Œä»åå­—ä¸Šå°±å¯ä»¥å¾ˆå®¹æ˜“çœ‹å‡ºæ˜¯æ³¨å†Œ bean çš„    </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">register</span><span class="params">(Class&lt;?&gt;... componentClasses)</span> &#123;</span><br><span class="line"><span class="keyword">for</span> (Class&lt;?&gt; componentClass : componentClasses) &#123;</span><br><span class="line">registerBean(componentClass);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-----------------------------</span><br><span class="line"><span class="keyword">private</span> &lt;T&gt; <span class="keyword">void</span> <span class="title function_">doRegisterBean</span><span class="params">(Class&lt;T&gt; beanClass, <span class="meta">@Nullable</span> String name,</span></span><br><span class="line"><span class="params"><span class="meta">@Nullable</span> Class&lt;? extends Annotation&gt;[] qualifiers, <span class="meta">@Nullable</span> Supplier&lt;T&gt; supplier,</span></span><br><span class="line"><span class="params"><span class="meta">@Nullable</span> BeanDefinitionCustomizer[] customizers)</span> &#123;</span><br><span class="line"><span class="comment">// new ä¸€ä¸ª bd å‡ºæ¥.</span></span><br><span class="line"><span class="type">AnnotatedGenericBeanDefinition</span> <span class="variable">abd</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotatedGenericBeanDefinition</span>(beanClass);</span><br><span class="line"><span class="comment">// è¿™é‡Œæ²¡æœ‰ @Conditional æ³¨è§£å’Œ metadata æ˜¯ null å°±ä¼šç›´æ¥è¿”å› false æ¥.    </span></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">this</span>.conditionEvaluator.shouldSkip(abd.getMetadata())) &#123;</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">abd.setInstanceSupplier(supplier);</span><br><span class="line"> </span><br><span class="line"><span class="comment">// åœ¨å¯¹è±¡ä¸Šè·å– @Scope æ³¨è§£,è¿™é‡Œæ²¡æœ‰,æ‰€ä»¥å°±ä¸ä¼šå¾€ä¸‹èµ°.</span></span><br><span class="line"><span class="comment">// è¿™é‡Œè¿”å›çš„ ScopeMetadataåº”è¯¥æ˜¯é»˜è®¤çš„,scopeNameæ˜¯singleton,scopedProxyModeæ˜¯No/1    </span></span><br><span class="line"><span class="type">ScopeMetadata</span> <span class="variable">scopeMetadata</span> <span class="operator">=</span> <span class="built_in">this</span>.scopeMetadataResolver.resolveScopeMetadata(abd);</span><br><span class="line">abd.setScope(scopeMetadata.getScopeName());</span><br><span class="line"><span class="comment">// è·å– beanName æ¥    </span></span><br><span class="line"><span class="type">String</span> <span class="variable">beanName</span> <span class="operator">=</span> (name != <span class="literal">null</span> ? name : <span class="built_in">this</span>.beanNameGenerator.generateBeanName(abd, <span class="built_in">this</span>.registry));</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯¹ä¸€äº›æ³¨è§£çš„å¤„ç†.</span></span><br><span class="line"><span class="comment">// @Lazy , @Primary , @DependsOn , @Role , @Description å¦‚æœæœ‰è¿™äº›æ³¨è§£çš„è¯,å°±ä¼šè¿›è¡Œå¤„ç†.</span></span><br><span class="line"><span class="comment">// æ ¹æ®æ³¨è§£çš„åå­—,æ¥è°ƒç”¨ç›¸åº”çš„setæ–¹æ³•.    </span></span><br><span class="line">AnnotationConfigUtils.processCommonDefinitionAnnotations(abd);</span><br><span class="line">    </span><br><span class="line"> <span class="comment">// è¿™é‡Œæ˜¯å¯¹æ˜¯å¦æœ‰ @Primary / @Lazy /   @Qualifier æ³¨è§£è¿›è¡Œåˆ¤æ–­.</span></span><br><span class="line"><span class="keyword">if</span> (qualifiers != <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="keyword">for</span> (Class&lt;? <span class="keyword">extends</span> <span class="title class_">Annotation</span>&gt; qualifier : qualifiers) &#123;</span><br><span class="line"><span class="keyword">if</span> (Primary.class == qualifier) &#123;</span><br><span class="line">abd.setPrimary(<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (Lazy.class == qualifier) &#123;</span><br><span class="line">abd.setLazyInit(<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">abd.addQualifier(<span class="keyword">new</span> <span class="title class_">AutowireCandidateQualifier</span>(qualifier));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//è¿™é‡Œ BeanDefinitionCustomizer[] customizers æ•°ç»„å¦‚æœæœ‰å€¼çš„è¯,</span></span><br><span class="line"><span class="comment">// ä¼šè°ƒç”¨ customizer çš„ customize æ–¹æ³•ä¼ å…¥ bd.</span></span><br><span class="line"><span class="comment">// TODO , è¿™é‡Œç”±äºæ²¡æœ‰å…·ä½“çš„å€¼,ä¹Ÿä¸æ˜¯å¾ˆæ¸…æ¥šåšäº†ä»€ä¹ˆäº‹æƒ….    </span></span><br><span class="line"><span class="keyword">if</span> (customizers != <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="keyword">for</span> (BeanDefinitionCustomizer customizer : customizers) &#123;</span><br><span class="line">customizer.customize(abd);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”¨ bd å’Œ beançš„åå­—ï¼Œåˆ›å»ºå‡ºä¸€ä¸ª bd çš„æŒæœ‰è€….    </span></span><br><span class="line"><span class="type">BeanDefinitionHolder</span> <span class="variable">definitionHolder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanDefinitionHolder</span>(abd, beanName);</span><br><span class="line"><span class="comment">// è¿™é‡Œç”±äºä¼ å…¥è¿›æ¥çš„ scopeMetadataçš„å€¼æ˜¯NO,æ‰€ä»¥å°±ç›´æ¥è¿”å›bdHolderçš„æŒæœ‰è€…äº†.</span></span><br><span class="line"><span class="comment">// å¯ä»¥çœ‹åˆ°è¿”å›ä¸‹é¢çš„ä»£ç ,æ˜¯æ»¡è¶³ä¸€ä¸ªå¢å¼ºç±»çš„æ¦‚å¿µçš„.    </span></span><br><span class="line">definitionHolder = AnnotationConfigUtils.applyScopedProxyMode(scopeMetadata, definitionHolder, <span class="built_in">this</span>.registry); </span><br><span class="line"><span class="comment">// org.springframework.beans.factory.support.DefaultListableBeanFactory#registerBeanDefinition</span></span><br><span class="line"><span class="comment">//èµ°åˆ°beanFactoryä¸­çš„registerBeanDefinitionæ–¹æ³•æ¥,å…ˆæ˜¯å¯¹bdè¿›è¡Œæ ¡éªŒ,ç„¶ååˆ©ç”¨org.springframework.beans.factory.support.DefaultListableBeanFactory#beanDefinitionMap+beaNameæ¥åˆ¤æ–­æ˜¯ä¸æ˜¯å·²ç»åŒ…å«äº†è¯¥bean</span></span><br><span class="line"><span class="comment">// æ­¤æ—¶å¦‚æœä½ æ˜¯debugçš„è¯,ä½ ä¼šå‘ç°æœ‰äº”ä¸ªå†…ç½®çš„beanå·²ç»åœ¨è¯¥beanDefinitionMapä¸­äº†.è¿™ä¹Ÿæ˜¯å¯¹åº”äº†AnnotatedBeanDefinitionReaderä¸­å¤„ç†çš„å†…ç½®çš„bean.</span></span><br><span class="line"><span class="comment">//å¦‚æœbeanDefinitionMapä¸­æ²¡æœ‰çš„è¯,å°±åˆ†ä¸ºæ˜¯ä¸æ˜¯å·²ç»å¼€å§‹åˆ›å»ºbeanäº†.</span></span><br><span class="line"><span class="comment">//å¦‚æœæ²¡æœ‰å·²ç»å¼€å§‹åˆ›å»ºäº†,å°±æ·»åŠ åˆ°beanDefinitionMapä¸­æ¥,beanNameä¹Ÿä¼šæ·»åŠ åˆ°beanDefinitionNames,å…¶å®è¿™é‡Œæœ‰ä¸ªé—®é¢˜, beanDefinitionMapçš„keyé›†åˆå°±å·²ç»æ˜¯beanNameé›†åˆäº†,ä¸ºä»€ä¹ˆè¿˜å•ç‹¬ä½¿ç”¨ä¸€ä¸ªé›†åˆæ¥ç»´æŠ¤å‘¢ï¼Ÿ</span></span><br><span class="line"><span class="comment">// è¿™æ ·è¿™ä¸ªbeançš„ä¿¡æ¯å’Œbdå°±æ”¾å…¥åˆ° BeanFactoryä¸­æ¥äº†.    </span></span><br><span class="line"><span class="comment">// å¦‚æœæœ‰åˆ«åçš„æ³¨è§£æˆ–è€…é…ç½®çš„è¯,å°±ä¼šèµ°åˆ°registry.registerAlias(beanName, alias);æ¥è¿›è¡Œåˆ«åçš„æ³¨å†Œ. </span></span><br><span class="line">BeanDefinitionReaderUtils.registerBeanDefinition(definitionHolder, <span class="built_in">this</span>.registry);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¯ä»¥æ€»ç»“ä¸‹çœ‹åˆ° register æ–¹æ³•å°±æ˜¯å¯¹æˆ‘ä»¬çš„é…ç½®ç±»è¿›è¡Œæ‰«æ, ç„¶åå¯¹æ˜¯å¦æœ‰ä¸€äº›æ³¨è§£è¿›è¡Œåˆ¤æ–­ç­‰. æœ€åä½¿ç”¨ BeanDefinitionReaderUtils å·¥å…·ç±»çš„æ–¹æ³•å°† bd ç»™ æ³¨å†Œåˆ° Spring å®¹å™¨ä¸­æ¥, æ³¨æ„è¿™æ—¶å€™æ˜¯æ²¡æœ‰å®ä¾‹åŒ–æˆ‘ä»¬çš„ YangBeanScannerConfig,åªæ˜¯å°è£…æˆ bd + beanName ç»™æ³¨å†Œåˆ° BeanFactory çš„ beanDefinitionMap ä¸­æ¥äº†.</p><h4 id="refresh-æ–¹æ³•"><a href="#refresh-æ–¹æ³•" class="headerlink" title="refresh() æ–¹æ³•"></a>refresh() æ–¹æ³•</h4><p> æ›´æ–°æ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ°è¿™ä¸ªæ–¹æ³•å†…éƒ¨æ˜¯èµ°äº†å¾ˆå¤šæ–¹æ³•,å…¶é€»è¾‘ä¹Ÿæ˜¯æ¯”è¾ƒç»•çš„. ä¸è¿‡æ²¡äº‹ï¼Œæˆ‘ä»¬ä¸€ä¸ªä¸€ä¸ªæ–¹æ³•çš„æ¥çœ‹.</p><p>org.springframework.context.support.AbstractApplicationContext#refresh()</p><p>å¯ä»¥çœ‹åˆ°å…¶å†…éƒ¨çš„æ¯ä¸ªæ–¹æ³•ä¸Šé¢éƒ½æ˜¯æœ‰ä¸€è¡Œæ³¨é‡Šçš„.</p><p>äºæ˜¯æˆ‘ä»¬æŒ¨ä¸ªæ–¹æ³•æ¥debugè¿›æ¥åˆ†æ.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ©ç”¨ Object æ¥å½“é”å¯¹è±¡,é¿å…å¤šä¸ªçº¿ç¨‹åŒæ—¶è°ƒç”¨åˆ° refresh æ–¹æ³•æ¥.</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">startupShutdownMonitor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException &#123;</span><br><span class="line">   <span class="keyword">synchronized</span> (<span class="built_in">this</span>.startupShutdownMonitor) &#123;</span><br><span class="line">      <span class="comment">// Prepare this context for refreshing.</span></span><br><span class="line">  </span><br><span class="line">      prepareRefresh();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Tell the subclass to refresh the internal bean factory.</span></span><br><span class="line">      <span class="type">ConfigurableListableBeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> obtainFreshBeanFactory();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Prepare the bean factory for use in this context.</span></span><br><span class="line">      prepareBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="comment">// Allows post-processing of the bean factory in context subclasses.</span></span><br><span class="line">         postProcessBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Invoke factory processors registered as beans in the context.</span></span><br><span class="line">         invokeBeanFactoryPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Register bean processors that intercept bean creation.</span></span><br><span class="line">         registerBeanPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Initialize message source for this context.</span></span><br><span class="line">         initMessageSource();</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Initialize event multicaster for this context.</span></span><br><span class="line">         initApplicationEventMulticaster();</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Initialize other special beans in specific context subclasses.</span></span><br><span class="line">         onRefresh();</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Check for listener beans and register them.</span></span><br><span class="line">         registerListeners();</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Instantiate all remaining (non-lazy-init) singletons.</span></span><br><span class="line">         finishBeanFactoryInitialization(beanFactory);</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Last step: publish corresponding event.</span></span><br><span class="line">         finishRefresh();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">         <span class="keyword">if</span> (logger.isWarnEnabled()) &#123;</span><br><span class="line">            logger.warn(<span class="string">&quot;Exception encountered during context initialization - &quot;</span> +</span><br><span class="line">                  <span class="string">&quot;cancelling refresh attempt: &quot;</span> + ex);</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Destroy already created singletons to avoid dangling resources.</span></span><br><span class="line">         destroyBeans();</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Reset &#x27;active&#x27; flag.</span></span><br><span class="line">         cancelRefresh(ex);</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Propagate exception to caller.</span></span><br><span class="line">         <span class="keyword">throw</span> ex;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">finally</span> &#123;</span><br><span class="line">         <span class="comment">// Reset common introspection caches in Spring&#x27;s core, since we</span></span><br><span class="line">         <span class="comment">// might not ever need metadata for singleton beans anymore...</span></span><br><span class="line">         resetCommonCaches();</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="prepareRefresh-æ–¹æ³•"><a href="#prepareRefresh-æ–¹æ³•" class="headerlink" title="prepareRefresh() æ–¹æ³•"></a>prepareRefresh() æ–¹æ³•</h5><p>ä»æ³¨é‡Šæ¥çœ‹, è®¾ç½®startupæ•°æ® &amp; æ ‡è¯†activeæ¥è¡¨ç¤ºçŠ¶æ€,åŒæ—¶ä¹Ÿä¼šåˆå§‹åŒ–ä¸€äº›èµ„æº.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Prepare this context for refreshing, setting its startup date and</span></span><br><span class="line"><span class="comment"> * active flag as well as performing any initialization of property sources.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">prepareRefresh</span><span class="params">()</span> &#123;</span><br><span class="line">   <span class="comment">// Switch to active.</span></span><br><span class="line">   <span class="built_in">this</span>.startupDate = System.currentTimeMillis();</span><br><span class="line"><span class="comment">// å¯¹çŠ¶æ€æ ‡è¯†çš„è®¾ç½®.    </span></span><br><span class="line">   <span class="built_in">this</span>.closed.set(<span class="literal">false</span>);</span><br><span class="line">   <span class="built_in">this</span>.active.set(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">      <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">         logger.trace(<span class="string">&quot;Refreshing &quot;</span> + <span class="built_in">this</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">         logger.debug(<span class="string">&quot;Refreshing &quot;</span> + getDisplayName());</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Initialize any placeholder property sources in the context environment.</span></span><br><span class="line"><span class="comment">// è¿™é‡Œæš‚æ—¶æ²¡æœ‰å®ç°æ¥åšäº‹æƒ….    </span></span><br><span class="line">   initPropertySources();</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Validate that all properties marked as required are resolvable:</span></span><br><span class="line">   <span class="comment">// see ConfigurablePropertyResolver#setRequiredProperties</span></span><br><span class="line"><span class="comment">// org.springframework.core.env.AbstractEnvironment#validateRequiredProperties</span></span><br><span class="line"><span class="comment">// å¯¹ org.springframework.core.env.AbstractPropertyResolver#requiredProperties è¿›è¡Œæ£€éªŒ,å¦‚æœæ£€éªŒåˆ°æœ‰é—®é¢˜çš„è¯,å°±ä¼šæŠ›å‡ºå¼‚å¸¸æ¥.</span></span><br><span class="line"><span class="comment">// è¿™é‡Œæ˜¯å¯¹ properties è¿›è¡Œæ£€éªŒ.    </span></span><br><span class="line">   getEnvironment().validateRequiredProperties();</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Store pre-refresh ApplicationListeners...</span></span><br><span class="line"><span class="comment">// earlyApplicationListenersæ˜¯nullçš„è¯,åˆ©ç”¨applicationListenersæ¥åˆå§‹åŒ–.   </span></span><br><span class="line">   <span class="keyword">if</span> (<span class="built_in">this</span>.earlyApplicationListeners == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="built_in">this</span>.earlyApplicationListeners = <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>&lt;&gt;(<span class="built_in">this</span>.applicationListeners);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// å¦‚æœå·²ç»å­˜åœ¨å€¼äº†,å°±å¯¹  applicationListeners æ¸…ç©ºï¼Œç„¶åå…¨éƒ¨æ·»åŠ applicationListenersæ¥.     </span></span><br><span class="line">      <span class="comment">// Reset local application listeners to pre-refresh state.</span></span><br><span class="line">      <span class="built_in">this</span>.applicationListeners.clear();</span><br><span class="line">      <span class="built_in">this</span>.applicationListeners.addAll(<span class="built_in">this</span>.earlyApplicationListeners);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Allow for the collection of early ApplicationEvents,</span></span><br><span class="line">   <span class="comment">// to be published once the multicaster is available...</span></span><br><span class="line">   <span class="built_in">this</span>.earlyApplicationEvents = <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>&lt;&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¯¥æ–¹æ³•çš„è¯,å¯¹çŠ¶æ€æ ‡è¯†è¿›è¡Œè®¾ç½®. æ¥ç€åœ° propertySources èµ„æºæ¥è¿›è¡Œåˆå§‹åŒ–, äºæ˜¯å°±å¯¹propertyæ¥è¿›è¡Œæ£€éªŒ. æ¥ä¸‹æ¥æ˜¯å¯¹ earlyApplicationListeners&#x2F;earlyApplicationEventsæ ¹æ®æ¡ä»¶æ¥åˆå§‹åŒ–æ“ä½œ.</p><h5 id="obtainFreshBeanFactroy"><a href="#obtainFreshBeanFactroy" class="headerlink" title="obtainFreshBeanFactroy()"></a>obtainFreshBeanFactroy()</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">protected ConfigurableListableBeanFactory obtainFreshBeanFactory() &#123;</span><br><span class="line">   refreshBeanFactory();</span><br><span class="line">   return getBeanFactory();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">---------------------------</span><br><span class="line">org.springframework.context.support.GenericApplicationContext#refreshBeanFactory</span><br><span class="line">  </span><br><span class="line">// çœ‹åˆ° compareAndSet æœ‰ç‚¹cas çš„å‘³é“.    </span><br><span class="line">protected final void refreshBeanFactory() throws IllegalStateException &#123;    </span><br><span class="line">if (!this.refreshed.compareAndSet(false, true)) &#123;</span><br><span class="line">throw new IllegalStateException(</span><br><span class="line">&quot;GenericApplicationContext does not support multiple refresh attempts: just call &#x27;refresh&#x27; once&quot;);</span><br><span class="line">&#125;</span><br><span class="line">// private String id = ObjectUtils.identityToString(this);</span><br><span class="line">// è¿™é‡Œè·å–å‡ºæ¥çš„idåœ¨è¿™ä¸ªç±»è¢«newæˆ–è€…å­ç±»è°ƒç”¨çˆ¶ç±»çš„super()æ„é€ æ–¹æ³•çš„æ—¶å€™,å°±å·²ç»è¢«åˆå§‹åŒ–å€¼äº†çš„.    </span><br><span class="line">this.beanFactory.setSerializationId(getId());</span><br><span class="line">&#125;    </span><br><span class="line">    </span><br><span class="line">-----------------</span><br><span class="line">org.springframework.context.support.GenericApplicationContext#getBeanFactory</span><br><span class="line"></span><br><span class="line">// è¿™é‡Œå°±ç›´æ¥è¿”å›äº† DefaultListableBeanFactory.   </span><br><span class="line">@Override</span><br><span class="line">public final ConfigurableListableBeanFactory getBeanFactory() &#123;</span><br><span class="line">return this.beanFactory;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥æ–¹æ³• è®¾ç½®äº†ä¸€ä¸ª SerializationId åˆ° beanFactory ä¸­æ¥. æœ€åä¹Ÿæ˜¯è¿”å›äº†ä¸€ä¸ª DefaultListableBeanFactory æ¥.</p><h5 id="prepareBeanFactory-æ–¹æ³•"><a href="#prepareBeanFactory-æ–¹æ³•" class="headerlink" title="prepareBeanFactory() æ–¹æ³•"></a>prepareBeanFactory() æ–¹æ³•</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Configure the factory&#x27;s standard context characteristics,</span></span><br><span class="line"><span class="comment"> * such as the context&#x27;s ClassLoader and post-processors.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> beanFactory the BeanFactory to configure</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">prepareBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> &#123;</span><br><span class="line">   <span class="comment">// Tell the internal bean factory to use the context&#x27;s class loader etc.</span></span><br><span class="line"><span class="comment">// org.springframework.core.io.DefaultResourceLoader#getClassLoader   </span></span><br><span class="line"><span class="comment">// è®¾ç½® class åŠ è½½å™¨&amp;èµ‹å€¼è¿›å».    </span></span><br><span class="line">   beanFactory.setBeanClassLoader(getClassLoader());</span><br><span class="line"><span class="comment">// å°† beanClassLoaderæ”¾å…¥SpelParserConfigurationä¸­æ¥,SpelExpressionParserä¸­æœ‰å«æœ‰SpelParserConfigurationä½œä¸ºconfiguration,StandardBeanExpressionResolverå±æ€§åˆå«æœ‰SpelExpressionParser. è¿™ä¹Ÿå°±å¯ä»¥ç†è§£ä¸ºbeanClassLoaderæœ€åæ˜¯æ”¾å…¥åˆ°SpelParserConfigurationæ¥.</span></span><br><span class="line">   beanFactory.setBeanExpressionResolver(<span class="keyword">new</span> <span class="title class_">StandardBeanExpressionResolver</span>(beanFactory.getBeanClassLoader()));</span><br><span class="line">    </span><br><span class="line"><span class="comment">// ä¼ å…¥applicationContextå’Œenvironmentåˆ°ResourceEditorRegistrarå¯¹è±¡æ¥.</span></span><br><span class="line"><span class="comment">//ç„¶åæ·»åŠ åˆ°beanFactoryä¸­æ¥.    </span></span><br><span class="line">   beanFactory.addPropertyEditorRegistrar(<span class="keyword">new</span> <span class="title class_">ResourceEditorRegistrar</span>(<span class="built_in">this</span>, getEnvironment()));</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Configure the bean factory with context callbacks.</span></span><br><span class="line"><span class="comment">// æ·»åŠ ApplicationContextAwareProcessoråç½®å¤„ç†å™¨åˆ°org.springframework.beans.factory.support.AbstractBeanFactory#beanPostProcessorsä¸­æ¥.</span></span><br><span class="line"><span class="comment">// åœ¨æ·»åŠ åç½®å¤„ç†å™¨åˆ°Springå®¹å™¨ä¹‹å‰,ä¼šåˆ¤æ–­è¿™ä¸ªåç½®å¤„ç†èµ·æ˜¯ä¸æ˜¯InstantiationAwareBeanPostProcessor/DestructionAwareBeanPostProcessor è¿™äºŒç§æƒ…å†µ.</span></span><br><span class="line"><span class="comment">// æœ€åæ·»åŠ åˆ° beanPostProcessors ä¸­æ¥.    </span></span><br><span class="line">   beanFactory.addBeanPostProcessor(<span class="keyword">new</span> <span class="title class_">ApplicationContextAwareProcessor</span>(<span class="built_in">this</span>));</span><br><span class="line"><span class="comment">// ç„¶åè¿™é‡Œå¿½ç•¥äº†å…­ç§æƒ…å†µçš„æ¥å£. ä¸ºä»€ä¹ˆè¦å¿½ç•¥å‘¢? çœ‹ä¸€ä¸ªåœ°æ–¹.</span></span><br><span class="line"><span class="comment">// org.springframework.context.support.ApplicationContextAwareProcessor#postProcessBeforeInitialization &amp;  org.springframework.context.support.ApplicationContextAwareProcessor#invokeAwareInterfaces ç»“åˆè¿™äºŒä¸ªæ–¹æ³•æ¥çœ‹,æ˜¯å·²ç»å¯¹è¿™å…­ç§æƒ…å†µçš„æ¥å£åšäº†å¤„ç†çš„.    </span></span><br><span class="line">   beanFactory.ignoreDependencyInterface(EnvironmentAware.class);</span><br><span class="line">   beanFactory.ignoreDependencyInterface(EmbeddedValueResolverAware.class);</span><br><span class="line">   beanFactory.ignoreDependencyInterface(ResourceLoaderAware.class);</span><br><span class="line">   beanFactory.ignoreDependencyInterface(ApplicationEventPublisherAware.class);</span><br><span class="line">   beanFactory.ignoreDependencyInterface(MessageSourceAware.class);</span><br><span class="line">   beanFactory.ignoreDependencyInterface(ApplicationContextAware.class);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// BeanFactory interface not registered as resolvable type in a plain factory.</span></span><br><span class="line">   <span class="comment">// MessageSource registered (and found for autowiring) as a bean.</span></span><br><span class="line"><span class="comment">// private final Map&lt;Class&lt;?&gt;, Object&gt; resolvableDependencies = new ConcurrentHashMap&lt;&gt;(16);    </span></span><br><span class="line"><span class="comment">// org.springframework.beans.factory.support.DefaultListableBeanFactory#resolvableDependencies,è¿™é‡Œå°† BeanFactory.classå’ŒbeanFactoryç»™æ·»åŠ åˆ° resolvableDependenciesä¸­æ¥äº†,è¿™é‡Œå¯ä»¥çœ‹åˆ°resolvableDependenciesçš„keyæ˜¯ä¸€ä¸ªClassç±»å‹.</span></span><br><span class="line">   beanFactory.registerResolvableDependency(BeanFactory.class, beanFactory);</span><br><span class="line">   beanFactory.registerResolvableDependency(ResourceLoader.class, <span class="built_in">this</span>);</span><br><span class="line">   beanFactory.registerResolvableDependency(ApplicationEventPublisher.class, <span class="built_in">this</span>);</span><br><span class="line">   beanFactory.registerResolvableDependency(ApplicationContext.class, <span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Register early post-processor for detecting inner beans as ApplicationListeners.</span></span><br><span class="line"><span class="comment">// è¿™é‡Œåˆæ·»åŠ äº†ä¸€ä¸ªåç½®å¤„ç†å™¨.</span></span><br><span class="line"><span class="comment">// ä¼ å…¥ä¸€ä¸ª ApplicationContext ç»™åç½®å¤„ç†å™¨,ç„¶åæ·»åŠ åˆ°BeanFactoryä¸­æ¥.</span></span><br><span class="line"><span class="comment">// org.springframework.beans.factory.support.AbstractBeanFactory#beanPostProcessors,ä¹Ÿå³æ˜¯æ·»åŠ åˆ°ä¸“é—¨å­˜æ”¾ åç½®å¤„ç†å™¨çš„é›†åˆä¸­æ¥äº†.    </span></span><br><span class="line">   beanFactory.addBeanPostProcessor(<span class="keyword">new</span> <span class="title class_">ApplicationListenerDetector</span>(<span class="built_in">this</span>));</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Detect a LoadTimeWeaver and prepare for weaving, if found.</span></span><br><span class="line"><span class="comment">// beanFactoryå¦‚æœæœ‰loadTimeWeaver,é‚£ä¹ˆå°±æ·»åŠ  LoadTimeWeaverAwareProcessor åç½®å¤„ç†å™¨è¿›æ¥   </span></span><br><span class="line">   <span class="keyword">if</span> (beanFactory.containsBean(LOAD_TIME_WEAVER_BEAN_NAME)) &#123;</span><br><span class="line">      beanFactory.addBeanPostProcessor(<span class="keyword">new</span> <span class="title class_">LoadTimeWeaverAwareProcessor</span>(beanFactory));</span><br><span class="line">      <span class="comment">// Set a temporary ClassLoader for type matching.</span></span><br><span class="line">      beanFactory.setTempClassLoader(<span class="keyword">new</span> <span class="title class_">ContextTypeMatchClassLoader</span>(beanFactory.getBeanClassLoader()));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Register default environment beans.</span></span><br><span class="line"><span class="comment">// ä¸åŒ…å«environment/systemProperties/systemEnvironmentï¼Œå°±ä¼šæ·»åŠ åˆ°org.springframework.beans.factory.support.DefaultSingletonBeanRegistry#singletonObjectsä¸­æ¥.    </span></span><br><span class="line">   <span class="keyword">if</span> (!beanFactory.containsLocalBean(ENVIRONMENT_BEAN_NAME)) &#123;</span><br><span class="line">      beanFactory.registerSingleton(ENVIRONMENT_BEAN_NAME, getEnvironment());</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (!beanFactory.containsLocalBean(SYSTEM_PROPERTIES_BEAN_NAME)) &#123;</span><br><span class="line">      beanFactory.registerSingleton(SYSTEM_PROPERTIES_BEAN_NAME, getEnvironment().getSystemProperties());</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (!beanFactory.containsLocalBean(SYSTEM_ENVIRONMENT_BEAN_NAME)) &#123;</span><br><span class="line">      beanFactory.registerSingleton(SYSTEM_ENVIRONMENT_BEAN_NAME, getEnvironment().getSystemEnvironment());</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°,prepareBeanFactory ä¸­åšäº†è¿™äº›äº‹æƒ… : æ·»åŠ äº† beanClassLoader,æ·»åŠ äº†äºŒä¸ªåç½®å¤„ç†å™¨,ç„¶åæ³¨å†Œäº†å››ä¸ª BeanFactory&#x2F;ResourceLoader&#x2F;ApplicationEventPublisher&#x2F;ApplicationContext åˆ°DefaultListableBeanFactory#resolvableDependenciesä¸­æ¥äº†.</p><p>æœ€ååˆ¤æ–­beanFactoryæ˜¯ä¸æ˜¯ä¸åŒ…å«ä¸€äº›å…³äºç¯å¢ƒçš„bean,å¦‚æœæ˜¯çš„è¯,é‚£å°±è°ƒç”¨registerSingletonæ–¹æ³•ç»™æ³¨å†Œè¿›æ¥.</p><p>è¿˜æ˜¯å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œéƒ½æ˜¯åœ¨ä¸ºç¯å¢ƒåšå‡†å¤‡å·¥ä½œ.</p><h5 id="postProcessBeanFactory-æ–¹æ³•"><a href="#postProcessBeanFactory-æ–¹æ³•" class="headerlink" title="postProcessBeanFactory() æ–¹æ³•"></a>postProcessBeanFactory() æ–¹æ³•</h5><p>ç•¥ç•¥ç•¥, è¯¥æ–¹æ³•æš‚æ— å®ç°ç±»æ¥æäº‹æƒ…â€¦..</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Modify the application context&#x27;s internal bean factory after its standard</span></span><br><span class="line"><span class="comment"> * initialization. All bean definitions will have been loaded, but no beans</span></span><br><span class="line"><span class="comment"> * will have been instantiated yet. This allows for registering special</span></span><br><span class="line"><span class="comment"> * BeanPostProcessors etc in certain ApplicationContext implementations.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> beanFactory the bean factory used by the application context</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="invokeBeanFactoryPostProcessors-æ–¹æ³•"><a href="#invokeBeanFactoryPostProcessors-æ–¹æ³•" class="headerlink" title="invokeBeanFactoryPostProcessors æ–¹æ³•"></a>invokeBeanFactoryPostProcessors æ–¹æ³•</h5><p>è¿™äº›æ˜¯å¯¹beanFactoryPostProcessorsè¿›è¡Œå¤„ç†. æ˜¯å€Ÿç”¨äº† PostProcessorRegistrationDelegate.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Instantiate and invoke all registered BeanFactoryPostProcessor beans,</span></span><br><span class="line"><span class="comment"> * respecting explicit order if given.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;Must be called before singleton instantiation.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">invokeBeanFactoryPostProcessors</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> &#123;</span><br><span class="line"><span class="comment">// getBeanFactoryPostProcessors() è·å–å‡ºæ¥çš„æ˜¯ç©ºé›†åˆ.    </span></span><br><span class="line">   PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors(beanFactory, getBeanFactoryPostProcessors());</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Detect a LoadTimeWeaver and prepare for weaving, if found in the meantime</span></span><br><span class="line">   <span class="comment">// (e.g. through an @Bean method registered by ConfigurationClassPostProcessor)</span></span><br><span class="line">   <span class="keyword">if</span> (beanFactory.getTempClassLoader() == <span class="literal">null</span> &amp;&amp; beanFactory.containsBean(LOAD_TIME_WEAVER_BEAN_NAME)) &#123;</span><br><span class="line">      beanFactory.addBeanPostProcessor(<span class="keyword">new</span> <span class="title class_">LoadTimeWeaverAwareProcessor</span>(beanFactory));</span><br><span class="line">      beanFactory.setTempClassLoader(<span class="keyword">new</span> <span class="title class_">ContextTypeMatchClassLoader</span>(beanFactory.getBeanClassLoader()));</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="org-springframework-context-support-PostProcessorRegistrationDelegate-invokeBeanFactoryPostProcessors-org-springframework-beans-factory-config-ConfigurableListableBeanFactory-java-util-List-lt-org-springframework-beans-factory-config-BeanFactoryPostProcessor-gt"><a href="#org-springframework-context-support-PostProcessorRegistrationDelegate-invokeBeanFactoryPostProcessors-org-springframework-beans-factory-config-ConfigurableListableBeanFactory-java-util-List-lt-org-springframework-beans-factory-config-BeanFactoryPostProcessor-gt" class="headerlink" title="org.springframework.context.support.PostProcessorRegistrationDelegate#invokeBeanFactoryPostProcessors(org.springframework.beans.factory.config.ConfigurableListableBeanFactory, java.util.List&lt;org.springframework.beans.factory.config.BeanFactoryPostProcessor&gt;)"></a>org.springframework.context.support.PostProcessorRegistrationDelegate#invokeBeanFactoryPostProcessors(org.springframework.beans.factory.config.ConfigurableListableBeanFactory, java.util.List&lt;org.springframework.beans.factory.config.BeanFactoryPostProcessor&gt;)</h6><p>è¯¥æ–¹æ³•ä»ä»£ç ä¸Šæ¥çœ‹,è¿˜æ˜¯åšäº†è›®å¤šçš„äº‹æƒ….</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">invokeBeanFactoryPostProcessors</span><span class="params">(</span></span><br><span class="line"><span class="params">      ConfigurableListableBeanFactory beanFactory, List&lt;BeanFactoryPostProcessor&gt; beanFactoryPostProcessors)</span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Invoke BeanDefinitionRegistryPostProcessors first, if any.</span></span><br><span class="line">   Set&lt;String&gt; processedBeans = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿™é‡Œæ˜¯æ»¡è¶³æ¡ä»¶çš„    </span></span><br><span class="line">   <span class="keyword">if</span> (beanFactory <span class="keyword">instanceof</span> BeanDefinitionRegistry) &#123;</span><br><span class="line">      <span class="type">BeanDefinitionRegistry</span> <span class="variable">registry</span> <span class="operator">=</span> (BeanDefinitionRegistry) beanFactory;</span><br><span class="line">      List&lt;BeanFactoryPostProcessor&gt; regularPostProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">      List&lt;BeanDefinitionRegistryPostProcessor&gt; registryProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯¹ beanFactoryçš„åç½®å¤„ç†å™¨è¿›è¡Œè¿­ä»£å¤„ç†æ“ä½œ.       </span></span><br><span class="line">      <span class="keyword">for</span> (BeanFactoryPostProcessor postProcessor : beanFactoryPostProcessors) &#123;</span><br><span class="line">         <span class="keyword">if</span> (postProcessor <span class="keyword">instanceof</span> BeanDefinitionRegistryPostProcessor) &#123;</span><br><span class="line">            <span class="type">BeanDefinitionRegistryPostProcessor</span> <span class="variable">registryProcessor</span> <span class="operator">=</span></span><br><span class="line">                  (BeanDefinitionRegistryPostProcessor) postProcessor;</span><br><span class="line">            registryProcessor.postProcessBeanDefinitionRegistry(registry);</span><br><span class="line">            registryProcessors.add(registryProcessor);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">else</span> &#123;</span><br><span class="line">            regularPostProcessors.add(postProcessor);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Do not initialize FactoryBeans here: We need to leave all regular beans</span></span><br><span class="line">      <span class="comment">// uninitialized to let the bean factory post-processors apply to them!</span></span><br><span class="line">      <span class="comment">// Separate between BeanDefinitionRegistryPostProcessors that implement</span></span><br><span class="line">      <span class="comment">// PriorityOrdered, Ordered, and the rest.</span></span><br><span class="line">      List&lt;BeanDefinitionRegistryPostProcessor&gt; currentRegistryProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// First, invoke the BeanDefinitionRegistryPostProcessors that implement PriorityOrdered.</span></span><br><span class="line"><span class="comment">// æ ¹æ® BeanDefinitionRegistryPostProcessor.class æ¥è·å–beanNamesæ•°ç»„,</span></span><br><span class="line"><span class="comment">// org.springframework.context.annotation.internalConfigurationAnnotationProcessor è¿™é‡Œæ˜¯è·å–åˆ°äº†ä¸€ä¸ªå†…ç½®çš„BeanFactroyPostProcessor.      </span></span><br><span class="line">      String[] postProcessorNames =</span><br><span class="line">            beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">      <span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line"> <span class="comment">// åˆ¤æ–­æ˜¯ä¸æ˜¯æœ‰PriorityOrdered,         </span></span><br><span class="line">         <span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;</span><br><span class="line"> <span class="comment">// è¿™é‡Œçš„getBeanå°±å·²ç»å¯¹beanè¿›è¡Œåˆå§‹åŒ–ï¼Œæ˜¯çœŸæ­£çš„èµ°åå°„æ„é€ å‡½æ•°æ‹¿å‡ºæ¥çš„å®ä¾‹å¯¹è±¡.</span></span><br><span class="line"> <span class="comment">// getBeanéœ€è¦ä»”ç»†åˆ†æä¸‹ï¼Œå› ä¸ºå…¶å†…éƒ¨åœ¨ createBeanæ˜¯èµ°äº†å¾ˆå¤šåç½®å¤„ç†èµ·æ¥è¿›è¡Œå¢å¼ºçš„. </span></span><br><span class="line"><span class="comment">// ConfigurationClassPostProcessor ç»™æ·»åŠ è¿›æ¥.             </span></span><br><span class="line">            currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));</span><br><span class="line"><span class="comment">// beanName æ·»åŠ åˆ° processedBeansé›†åˆä¸­æ¥äº†.             </span></span><br><span class="line">            processedBeans.add(ppName);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line"><span class="comment">// å¯¹é›†åˆè¿›è¡Œæ’åº,ä»beanFactoryä¸­è·å–å‡ºdependencyComparatoræ¥,å¦‚æœæ²¡æœ‰çš„è¯,å°±ç”¨OrderComparator.INSTANCEé»˜è®¤çš„</span></span><br><span class="line">      sortPostProcessors(currentRegistryProcessors, beanFactory);</span><br><span class="line"><span class="comment">// å…¨éƒ¨æ·»åŠ åˆ° registryProcessors ä¸­æ¥.       </span></span><br><span class="line">      registryProcessors.addAll(currentRegistryProcessors);</span><br><span class="line"><span class="comment">// org.springframework.context.annotation.ConfigurationClassPostProcessor#postProcessBeanDefinitionRegistry</span></span><br><span class="line"><span class="comment">//è¿™é‡Œæ˜¯è¿›å…¥åˆ°ConfigurationClassPostProcessorä¸­æ¥äº†,å¯ä»¥çœ‹åˆ°å…¶æ¥å£ BeanDefinitionRegistryPostProcessor,æ˜¯é‡å†™äº†æ¥å£çš„æ–¹æ³•. </span></span><br><span class="line"><span class="comment">// ConfigurationClassPostProcessor#postProcessBeanDefinitionRegistry åšäº†ä»€ä¹ˆäº‹æƒ…å‘¢?</span></span><br><span class="line"><span class="comment">// ç”¨System.identityHashCode(registry);è®¡ç®—å‡ºregistryIdæ¥,å¦‚æœåœ¨org.springframework.context.annotation.ConfigurationClassPostProcessor#registriesPostProcessed/factoriesPostProcessed(äºŒä¸ªé›†åˆ)ä¸­å·²ç»åŒ…å«äº†çš„è¯,å°±ä¼šæŠ›å‡ºå·²ç»è¢«è°ƒç”¨è¿‡çš„å¼‚å¸¸æ¥.å¦‚æœæ²¡æœ‰çš„è¯,å°±ä¼šæ·»åŠ åˆ°registriesPostProcessedä¸­æ¥</span></span><br><span class="line"><span class="comment">// ç»§ç»­çœ‹ org.springframework.context.annotation.ConfigurationClassPostProcessor#processConfigBeanDefinitions æ–¹æ³•,</span></span><br><span class="line"><span class="comment">//å…ˆä»registryä¸­è·å–beanNamesæ¥,è¿™å…¶ä¸­å°±æœ‰Springå†…ç½®çš„å’Œæˆ‘ä»¬è‡ªå·±å®šä¹‰çš„yangBeanScannerConfig</span></span><br><span class="line"><span class="comment">//å¯¹beanNamesè¿­ä»£å¤„ç†,æ¥ç€å°±ç”¨ConfigurationClassUtils.checkConfigurationClassCandidate(beanDef, this.metadataReaderFactory)æ¥åˆ¤æ–­è¦ä¸è¦æ·»åŠ åˆ°List&lt;BeanDefinitionHolder&gt; configCandidatesé›†åˆä¸­æ¥,æœ€åæ˜¯æˆ‘ä»¬å®šä¹‰çš„beanNameç»™æ·»åŠ è¿›æ¥äº†.</span></span><br><span class="line"><span class="comment">// å¯¹configCandidatesé›†åˆè¿›è¡Œæ’åº,</span></span><br><span class="line"><span class="comment">// åˆ›å»ºä¸€ä¸ªConfigurationClassParserå¯¹è±¡æ¥è§£ææ¯ä¸ª@Configurationæ³¨è§£ç±».è°ƒç”¨å…¶parseå’Œvalidateæ–¹æ³•,è§£æå®Œåå°±æ˜¯ä¸€ä¸ªConfigurationClassçš„Seté›†åˆ,æ¥ç€å°±æ˜¯newäº†ä¸€ä¸ªConfigurationClassBeanDefinitionReaderå¯¹è±¡æ¥,</span></span><br><span class="line"><span class="comment">// this.reader.loadBeanDefinitions(configClasses); è¿™è¡Œä»£ç æœ‰ç‚¹æ ¹æ®Configå»è§£æbeançš„æ„æ€.    </span></span><br><span class="line"><span class="comment">// å…·ä½“è¦ç­‰åˆ°åé¢æ·±åº¦è§£æå†åè¿‡æ¥å®šä½æ¯è¡Œä»£ç çš„æ„æ€.</span></span><br><span class="line"><span class="comment">// æœ€åå†æ¸…é™¤ä¸‹ç¼“å­˜.       </span></span><br><span class="line">      invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry);</span><br><span class="line"><span class="comment">// æ¸…ç©º currentRegistryProcessors é›†åˆ      </span></span><br><span class="line">      currentRegistryProcessors.clear();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Next, invoke the BeanDefinitionRegistryPostProcessors that implement Ordered.</span></span><br><span class="line">      postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">      <span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line"><span class="comment">// å¦‚æœprocessedBeansé›†åˆä¸­ä¸åŒ…å«å¹¶ä¸”typeæ˜¯Ordered.classæ‰æ»¡è¶³è¿›æ¥çš„æ¡ä»¶.          </span></span><br><span class="line">         <span class="keyword">if</span> (!processedBeans.contains(ppName) &amp;&amp; beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;</span><br><span class="line">            currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));</span><br><span class="line">            processedBeans.add(ppName);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line"><span class="comment">// æ‰€ä»¥è¿™é‡Œçš„currentRegistryProcessorsé›†åˆæ˜¯ç©ºé›†åˆ.       </span></span><br><span class="line">      sortPostProcessors(currentRegistryProcessors, beanFactory);</span><br><span class="line">      registryProcessors.addAll(currentRegistryProcessors);</span><br><span class="line">      invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry);</span><br><span class="line">      currentRegistryProcessors.clear();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Finally, invoke all other BeanDefinitionRegistryPostProcessors until no further ones appear.</span></span><br><span class="line"><span class="comment">// è¿™é‡Œç”¨ while å¾ªç¯æ¥æœ€åè§£æ,åˆ¤æ–­ä»getBeanNamesForTypeè·å–å‡ºæ¥çš„beanæ˜¯ä¸æ˜¯è¢«è§£æè¿‡äº†çš„. </span></span><br><span class="line"><span class="comment">// ä¹Ÿæ˜¯ç”¨ processedBeans é›†åˆæ¥è¿›è¡Œæ§åˆ¶çš„. </span></span><br><span class="line">      <span class="type">boolean</span> <span class="variable">reiterate</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">while</span> (reiterate) &#123;</span><br><span class="line">         reiterate = <span class="literal">false</span>;</span><br><span class="line">         postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">         <span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!processedBeans.contains(ppName)) &#123;</span><br><span class="line">               currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));</span><br><span class="line">               processedBeans.add(ppName);</span><br><span class="line">               reiterate = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         sortPostProcessors(currentRegistryProcessors, beanFactory);</span><br><span class="line">         registryProcessors.addAll(currentRegistryProcessors);</span><br><span class="line">         invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry);</span><br><span class="line">         currentRegistryProcessors.clear();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Now, invoke the postProcessBeanFactory callback of all processors handled so far.</span></span><br><span class="line"><span class="comment">// org.springframework.context.annotation.ConfigurationClassPostProcessor#postProcessBeanFactory,è¿™é‡Œæ˜¯èµ°åˆ°äº†postProcessBeanFactoryå›è°ƒæ–¹æ³•æ¥äº†.ç”¨org.springframework.context.annotation.ConfigurationClassPostProcessor#factoriesPostProcessedé›†åˆæ¥æ§åˆ¶æ˜¯å¦è§£æè¿‡äº†.ç”¨registriesPostProcessedé›†åˆæ¥åˆ¤æ–­ä¸Šæ¬¡æ˜¯å¦è¿›å…¥åˆ°postProcessBeanDefinitionRegistryæ–¹æ³•ä¸­æ¥. å¦‚æœæ²¡æœ‰çš„è¯,å°±ä¼šå†èµ°ä¸€è¾¹processConfigBeanDefinitions,å¯ä»¥çœ‹åˆ° postProcessBeanDefinitionRegistry æ–¹æ³•æœ€åä¹Ÿæ˜¯èµ°åˆ°äº†processConfigBeanDefinitionsä¸­æ¥äº†.</span></span><br><span class="line"><span class="comment">//org.springframework.context.annotation.ConfigurationClassPostProcessor#enhanceConfigurationClasses è¯¥æ–¹æ³•åˆ¤æ–­æ˜¯ä¸æ˜¯éœ€è¦ä»£ç†æ¥å¢å¼º,è¿™é‡Œæ˜¯æ²¡æœ‰çš„,æ‰€ä»¥å°±ç›´æ¥returnæ‰äº†.</span></span><br><span class="line"><span class="comment">// æœ€åæ·»åŠ ä¸€ä¸ª ImportAwareBeanPostProcessor åç½®å¤„ç†å™¨è¿›æ¥.       </span></span><br><span class="line">      invokeBeanFactoryPostProcessors(registryProcessors, beanFactory);</span><br><span class="line"><span class="comment">// è¿™é‡Œçš„regularPostProcessors é›†åˆæ˜¯empty.       </span></span><br><span class="line">      invokeBeanFactoryPostProcessors(regularPostProcessors, beanFactory);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// Invoke factory processors registered with the context instance.</span></span><br><span class="line">      invokeBeanFactoryPostProcessors(beanFactoryPostProcessors, beanFactory);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Do not initialize FactoryBeans here: We need to leave all regular beans</span></span><br><span class="line">   <span class="comment">// uninitialized to let the bean factory post-processors apply to them!</span></span><br><span class="line"> <span class="comment">// org.springframework.context.annotation.internalConfigurationAnnotationProcessorå’Œorg.springframework.context.event.internalEventListenerProcessorè¿™é‡Œè·å–å‡ºæ¥çš„æ˜¯äºŒä¸ª.   </span></span><br><span class="line">   String[] postProcessorNames =</span><br><span class="line">         beanFactory.getBeanNamesForType(BeanFactoryPostProcessor.class, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Separate between BeanFactoryPostProcessors that implement PriorityOrdered,</span></span><br><span class="line">   <span class="comment">// Ordered, and the rest.</span></span><br><span class="line">   List&lt;BeanFactoryPostProcessor&gt; priorityOrderedPostProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">   List&lt;String&gt; orderedPostProcessorNames = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">   List&lt;String&gt; nonOrderedPostProcessorNames = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">   <span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line"> <span class="comment">// è¿™é‡Œæ˜¯å¯¹ä¸Šé¢å·²ç»å¤„ç†è¿‡äº†çš„è¿›è¡Œè¿‡æ»¤å¤„ç†.      </span></span><br><span class="line">      <span class="keyword">if</span> (processedBeans.contains(ppName)) &#123;</span><br><span class="line">         <span class="comment">// skip - already processed in first phase above</span></span><br><span class="line">      &#125;</span><br><span class="line">       </span><br><span class="line"><span class="comment">// è¿™é‡Œåˆ†ä¸º PriorityOrdered&amp;Ordered&amp;éå‰äºŒè€…,åˆ†è¿™ä¸‰ç§æƒ…å†µåˆ†åˆ«æ”¾å…¥åˆ°ä¸‰ä¸ªä¸åŒçš„é›†åˆä¸­.</span></span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;</span><br><span class="line">         priorityOrderedPostProcessors.add(beanFactory.getBean(ppName, BeanFactoryPostProcessor.class));</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;</span><br><span class="line">         orderedPostProcessorNames.add(ppName);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">         nonOrderedPostProcessorNames.add(ppName);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿™é‡Œæ˜¯å¯ä»¥çœ‹åˆ°å…ˆæ˜¯å¯¹PriorityOrderedè¿›è¡Œå¤„ç†,å†å¯¹Orderedå¤„ç†,æœ€åå¯¹éå‰äºŒè€…è¿›è¡Œå¤„ç†.    </span></span><br><span class="line">   <span class="comment">// First, invoke the BeanFactoryPostProcessors that implement PriorityOrdered.</span></span><br><span class="line">   sortPostProcessors(priorityOrderedPostProcessors, beanFactory);</span><br><span class="line">   invokeBeanFactoryPostProcessors(priorityOrderedPostProcessors, beanFactory);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Next, invoke the BeanFactoryPostProcessors that implement Ordered.</span></span><br><span class="line">   List&lt;BeanFactoryPostProcessor&gt; orderedPostProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(orderedPostProcessorNames.size());</span><br><span class="line">   <span class="keyword">for</span> (String postProcessorName : orderedPostProcessorNames) &#123;</span><br><span class="line"> <span class="comment">// æ³¨æ„è¿™é‡Œæ˜¯è°ƒç”¨äº†getBeanæ–¹æ³•.      </span></span><br><span class="line">      orderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class));</span><br><span class="line">   &#125;</span><br><span class="line"><span class="comment">// æ’åº    </span></span><br><span class="line">   sortPostProcessors(orderedPostProcessors, beanFactory);</span><br><span class="line">   invokeBeanFactoryPostProcessors(orderedPostProcessors, beanFactory);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Finally, invoke all other BeanFactoryPostProcessors.</span></span><br><span class="line">   List&lt;BeanFactoryPostProcessor&gt; nonOrderedPostProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(nonOrderedPostProcessorNames.size());</span><br><span class="line">   <span class="keyword">for</span> (String postProcessorName : nonOrderedPostProcessorNames) &#123;</span><br><span class="line"> <span class="comment">// æ³¨æ„è¿™é‡Œä¹Ÿæ˜¯è°ƒç”¨äº† getBean æ–¹æ³•çš„.      </span></span><br><span class="line">      nonOrderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class));</span><br><span class="line">   &#125;</span><br><span class="line"><span class="comment">// org.springframework.context.event.EventListenerMethodProcessor#postProcessBeanFactory</span></span><br><span class="line"><span class="comment">// è¿™é‡Œç”±äºåªæœ‰ä¸€ä¸ªEventListenerMethodProcessorå¤„ç†å™¨,æ‰€ä»¥å¯¹åº”èµ·æ¥çš„èµ°åˆ°å…¶postProcessBeanFactoryæ–¹æ³•ä¸­æ¥.</span></span><br><span class="line"><span class="comment">// è¿™é‡Œä¹Ÿæ˜¯è°ƒç”¨ postProcessBeanFactory æ–¹æ³•çš„æ„æ€,ä¹Ÿå°±æ˜¯å›è°ƒæ–¹æ³•.    </span></span><br><span class="line">   invokeBeanFactoryPostProcessors(nonOrderedPostProcessors, beanFactory);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Clear cached merged bean definitions since the post-processors might have</span></span><br><span class="line">   <span class="comment">// modified the original metadata, e.g. replacing placeholders in values...</span></span><br><span class="line"><span class="comment">// org.springframework.beans.factory.support.DefaultListableBeanFactory#clearMetadataCache</span></span><br><span class="line"><span class="comment">// å¯¹ ä¸€äº›é›†åˆç­‰è¿›è¡Œæ¸…é™¤.    </span></span><br><span class="line">   beanFactory.clearMetadataCache();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è‡³æ­¤å°±å¯ä»¥çœ‹åˆ°,è¯¥æ–¹æ³•ä¸»è¦æ˜¯å¯¹BeanDefinitionRegistryPostProcessor.classå’ŒBeanFactoryPostProcessor.classæ¥è¿›è¡Œå¤„ç†.</p><p>BeanDefinitionRegistryPostProcessor åˆæ˜¯å…ˆå¤„ç†PriorityOrdered,ç„¶åä¼šå°†å¤„ç†è¿‡çš„æ”¾å…¥processedBeansé›†åˆä¸­åšä¸€ä¸ªæ€»çš„è®°å½•ï¼Œå†å¤„ç†éå†processedBeansé›†åˆè®°å½•ä¸­çš„å’Œæ˜¯Orderedçš„,æœ€åç”¨whileå¾ªç¯æ¥å†ç¡®è®¤ä¸€éæ˜¯ä¸æ˜¯æœ‰è¿˜æ²¡å¤„ç†çš„,è¿™ä¸ªæ—¶å€™æ§åˆ¶æ¡ä»¶ä¹Ÿæ˜¯é€šè¿‡ processedBeansæ¥æ§åˆ¶æ˜¯ä¸æ˜¯å¤„ç†è¿‡äº†çš„. è¿™é‡Œæ³¨æ„, å®ä¾‹åŒ–æ˜¯é€šè¿‡è°ƒç”¨ getBeanæ–¹æ³•æ¥å®ç°çš„,æ‰€ä»¥ä½ ä¼šå‘ç°å†è°ƒç”¨invokeBeanDefinitionRegistryPostProcessorsæ–¹æ³•ä¹‹å‰,éƒ½æ˜¯ä¼šæœ‰è°ƒç”¨getBeanæ–¹æ³•çš„.</p><p>BeanFactoryPostProcessor çš„å¤„ç†,è¿™é‡Œæ˜¯ä¸€æ¬¡è·å–å‡º,ç„¶ååˆ†ä¸º PriorityOrdered&#x2F;Ordered&#x2F;éå‰äºŒè€…ï¼Œåˆ†åˆ«æ”¾å…¥ä¸‰ä¸ªé›†åˆä¸­è¿›è¡Œå¤„ç†,å‰ææ˜¯éƒ½æ²¡å† processedBeans é›†åˆä¸­. è¿™é‡Œå¯ä»¥çœ‹åˆ°,å¦‚æœæ˜¯PriorityOrderedç±»å‹çš„è¯ï¼Œé‚£ä¹ˆåœ¨åˆ†ç±»çš„æ—¶å€™å°±å·²ç»è°ƒç”¨getBeanæ–¹æ³•æ¥å®ä¾‹åŒ–è¿™ä¸ªå¯¹è±¡äº†ï¼Œå…¶ä»–äºŒè€…éƒ½æ˜¯æœ€åè¿­ä»£éå†çš„æ—¶å€™è°ƒç”¨getBeanæ–¹æ³•çš„. æœ€åéƒ½æ˜¯sortPostProcessorsèµ°ä¸‹æ’åºï¼Œç„¶åè°ƒç”¨invokeBeanFactoryPostProcessorsæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•çš„æ„æ€ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨ é‡å†™çš„ postProcessBeanFactory çš„æ–¹æ³•.</p><h5 id="registerBeanPostProcessors-æ–¹æ³•"><a href="#registerBeanPostProcessors-æ–¹æ³•" class="headerlink" title="registerBeanPostProcessors æ–¹æ³•"></a>registerBeanPostProcessors æ–¹æ³•</h5><p>è¯¥æ–¹æ³•ä¼ å…¥ beanFactoryè¿›æ¥,ç„¶åç›´æ¥å€ŸåŠ© PostProcessorRegistrationDelegate æ¥å®ç°.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">registerBeanPostProcessors</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> &#123;</span><br><span class="line">   PostProcessorRegistrationDelegate.registerBeanPostProcessors(beanFactory, <span class="built_in">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="registerBeanPostProcessors-æ–¹æ³•-1"><a href="#registerBeanPostProcessors-æ–¹æ³•-1" class="headerlink" title="registerBeanPostProcessors æ–¹æ³•"></a>registerBeanPostProcessors æ–¹æ³•</h6><p>ä»åå­—ä¸Šä¸éš¾ç†è§£ï¼Œæ³¨å†Œ Beançš„åç½®å¤„ç†å™¨è¿›æ¥.</p><p>è¿™é‡Œä¼ å…¥è¿›æ¥çš„ beanFactory æ˜¯ DefaultListableBeanFactory , applicationContextæ˜¯AnnotationConfigApplicationContext</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">registerBeanPostProcessors</span><span class="params">(</span></span><br><span class="line"><span class="params">      ConfigurableListableBeanFactory beanFactory, AbstractApplicationContext applicationContext)</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–å‡º BeanPostProcessor çš„åå­—.</span></span><br><span class="line"><span class="comment">// org.springframework.context.annotation.internalAutowiredAnnotationProcessor</span></span><br><span class="line"><span class="comment">// org.springframework.context.annotation.internalCommonAnnotationProcessor</span></span><br><span class="line"><span class="comment">// è¿™é‡Œè·å–å‡ºæ¥çš„æ˜¯äºŒä¸ªå†…éƒ¨çš„åç½®å¤„ç†å™¨,å› ä¸ºæˆ‘è¿™é‡Œå¹¶æ²¡æœ‰æ‰©å±•,åªæ˜¯ç®€å•çš„è¿›è¡Œè¯´æ˜äº†ä¸‹,åé¢ä¼šè¯¦ç»†åˆ†æã€‚</span></span><br><span class="line"><span class="comment">// å°±æ˜¯è¿™è¡Œä»£ç è·å–çš„æ˜¯ä»€ä¹ˆ.    </span></span><br><span class="line">   String[] postProcessorNames = beanFactory.getBeanNamesForType(BeanPostProcessor.class, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Register BeanPostProcessorChecker that logs an info message when</span></span><br><span class="line">   <span class="comment">// a bean is created during BeanPostProcessor instantiation, i.e. when</span></span><br><span class="line">   <span class="comment">// a bean is not eligible for getting processed by all BeanPostProcessors.</span></span><br><span class="line"> <span class="comment">// 6   </span></span><br><span class="line">   <span class="type">int</span> <span class="variable">beanProcessorTargetCount</span> <span class="operator">=</span> beanFactory.getBeanPostProcessorCount() + <span class="number">1</span> + postProcessorNames.length;</span><br><span class="line"><span class="comment">// ä¼ å…¥beanFactoryå’Œä¸ªæ•°,åˆ›å»ºå‡ºä¸€ä¸ªæ£€æŸ¥beançš„åç½®å¤„ç†å™¨æ¥.</span></span><br><span class="line"><span class="comment">// org.springframework.context.support.PostProcessorRegistrationDelegate.BeanPostProcessorChecker</span></span><br><span class="line"><span class="comment">// æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥çœ‹åˆ°è¯¥åç½®å¤„ç†å™¨é‡å†™çš„æ–¹æ³•åšäº†ä»€ä¹ˆäº‹æƒ….</span></span><br><span class="line"><span class="comment">// æœ€åæ·»åŠ åˆ° beanFactory ä¸­æ¥.    </span></span><br><span class="line">   beanFactory.addBeanPostProcessor(<span class="keyword">new</span> <span class="title class_">BeanPostProcessorChecker</span>(beanFactory, beanProcessorTargetCount));</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Separate between BeanPostProcessors that implement PriorityOrdered,</span></span><br><span class="line">   <span class="comment">// Ordered, and the rest.</span></span><br><span class="line">   List&lt;BeanPostProcessor&gt; priorityOrderedPostProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">   List&lt;BeanPostProcessor&gt; internalPostProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">   List&lt;String&gt; orderedPostProcessorNames = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">   List&lt;String&gt; nonOrderedPostProcessorNames = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line"> <span class="comment">// å¯¹åç½®å¤„ç†å™¨è¿›è¡Œè¿­ä»£   </span></span><br><span class="line">   <span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line">      <span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;</span><br><span class="line">   <span class="comment">// æ³¨æ„è¿™é‡Œè°ƒç”¨ getBean æ–¹æ³•æ˜¯å·²ç»å®ä¾‹åŒ–è¿™ä¸ªåç½®å¤„ç†èµ·äº†.</span></span><br><span class="line"><span class="comment">// AutowiredAnnotationBeanPostProcessor</span></span><br><span class="line"><span class="comment">// CommonAnnotationBeanPostProcessor</span></span><br><span class="line"> <span class="comment">// è¿™é‡Œå®ä¾‹åŒ–çš„æ˜¯Springå†…ç½®çš„äºŒä¸ª         </span></span><br><span class="line">         <span class="type">BeanPostProcessor</span> <span class="variable">pp</span> <span class="operator">=</span> beanFactory.getBean(ppName, BeanPostProcessor.class);</span><br><span class="line">         priorityOrderedPostProcessors.add(pp);</span><br><span class="line">      <span class="comment">// å†…éƒ¨çš„äºŒä¸ªåç½®å¤„ç†å™¨éƒ½æ˜¯æœ‰å®ç°   MergedBeanDefinitionPostProcessor çš„. </span></span><br><span class="line">         <span class="keyword">if</span> (pp <span class="keyword">instanceof</span> MergedBeanDefinitionPostProcessor) &#123;</span><br><span class="line">            internalPostProcessors.add(pp);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;</span><br><span class="line">         orderedPostProcessorNames.add(ppName);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">         nonOrderedPostProcessorNames.add(ppName);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// First, register the BeanPostProcessors that implement PriorityOrdered.</span></span><br><span class="line"><span class="comment">// æ’åº    </span></span><br><span class="line">   sortPostProcessors(priorityOrderedPostProcessors, beanFactory);</span><br><span class="line"><span class="comment">// æ·»åŠ åˆ° org.springframework.beans.factory.support.AbstractBeanFactory#beanPostProcessors,ä¹Ÿå°±æ˜¯æ·»åŠ åˆ°Springçš„BanFactoryä¸­æ¥.    </span></span><br><span class="line">   registerBeanPostProcessors(beanFactory, priorityOrderedPostProcessors);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Next, register the BeanPostProcessors that implement Ordered.</span></span><br><span class="line"><span class="comment">// è¿™é‡Œæ˜¯å¯¹å®ç°äº† Ordered ç±»å‹çš„å¤„ç†ï¼Œå¾ˆæ˜¾ç„¶æˆ‘è¿™é‡Œæ˜¯æ²¡æœ‰çš„.    </span></span><br><span class="line">   List&lt;BeanPostProcessor&gt; orderedPostProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(orderedPostProcessorNames.size());</span><br><span class="line">   <span class="keyword">for</span> (String ppName : orderedPostProcessorNames) &#123;</span><br><span class="line">      <span class="type">BeanPostProcessor</span> <span class="variable">pp</span> <span class="operator">=</span> beanFactory.getBean(ppName, BeanPostProcessor.class);</span><br><span class="line">      orderedPostProcessors.add(pp);</span><br><span class="line">      <span class="keyword">if</span> (pp <span class="keyword">instanceof</span> MergedBeanDefinitionPostProcessor) &#123;</span><br><span class="line">         internalPostProcessors.add(pp);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   sortPostProcessors(orderedPostProcessors, beanFactory);</span><br><span class="line">   registerBeanPostProcessors(beanFactory, orderedPostProcessors);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Now, register all regular BeanPostProcessors.</span></span><br><span class="line"><span class="comment">// æœ€åæ˜¯å¯¹é PriorityOrderedå’ŒOrderedçš„å¤„ç†ï¼Œ    </span></span><br><span class="line">   List&lt;BeanPostProcessor&gt; nonOrderedPostProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(nonOrderedPostProcessorNames.size());</span><br><span class="line">   <span class="keyword">for</span> (String ppName : nonOrderedPostProcessorNames) &#123;</span><br><span class="line">      <span class="type">BeanPostProcessor</span> <span class="variable">pp</span> <span class="operator">=</span> beanFactory.getBean(ppName, BeanPostProcessor.class);</span><br><span class="line">      nonOrderedPostProcessors.add(pp);</span><br><span class="line">      <span class="keyword">if</span> (pp <span class="keyword">instanceof</span> MergedBeanDefinitionPostProcessor) &#123;</span><br><span class="line">         internalPostProcessors.add(pp);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   registerBeanPostProcessors(beanFactory, nonOrderedPostProcessors);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Finally, re-register all internal BeanPostProcessors.</span></span><br><span class="line"><span class="comment">// è¿™é‡Œå¯ä»¥çœ‹åˆ°,æœ€åå¯¹å†…éƒ¨çš„åç½®å¤„ç†å™¨åˆé‡æ–°æ³¨å†Œäº†ä¸€é.    </span></span><br><span class="line">   sortPostProcessors(internalPostProcessors, beanFactory);</span><br><span class="line">   registerBeanPostProcessors(beanFactory, internalPostProcessors);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Re-register post-processor for detecting inner beans as ApplicationListeners,</span></span><br><span class="line">   <span class="comment">// moving it to the end of the processor chain (for picking up proxies etc).</span></span><br><span class="line"><span class="comment">// ApplicationListenerDetector è¿™é‡Œä¹Ÿæ˜¯å¯¹  ApplicationListenerDetector ä¹Ÿæ˜¯é‡æ–°æ³¨å†Œä¸€é.   </span></span><br><span class="line">   beanFactory.addBeanPostProcessor(<span class="keyword">new</span> <span class="title class_">ApplicationListenerDetector</span>(applicationContext));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥æ–¹æ³• å€ŸåŠ© org.springframework.context.support.PostProcessorRegistrationDelegate#registerBeanPostProcessors(org.springframework.beans.factory.config.ConfigurableListableBeanFactory, org.springframework.context.support.AbstractApplicationContext) æ¥ï¼Œè·å–BeanPostProcessorçš„åç½®å¤„ç†å™¨,ä¹Ÿæ˜¯åˆ†ä¸º PriorityOrdered &#x2F; Ordered&#x2F; å‰äºŒè€…éƒ½æ²¡æœ‰ï¼Œåœ¨ PriorityOrdered åˆ†ç±»çš„æ—¶å€™ï¼Œå°±å·²ç»è°ƒç”¨äº† getBeanæ–¹æ³•æ¥è·å–å‡º bean å¯¹è±¡æ¥(è¿™é‡Œä¾ç„¶æ˜¯åˆ†ä¸ºäº†ä¸‰ä¸ªé›†åˆæ¥è£…æ•°æ®&amp;å¤„ç†). ç„¶åè°ƒç”¨getBeanæ–¹æ³•å,å°±è°ƒç”¨registerBeanPostProcessorsæ–¹æ³•ï¼Œå°†åç½®å¤„ç†å™¨ç»™æ³¨å†Œåˆ° Spring çš„BeanFactory ä¸­æ¥.</p><p>æœ€åè¿˜ä¼šæœ€å†…éƒ¨çš„ BeanPoståç½®å¤„ç†å™¨ &amp; ApplicationListenerDetector å†é‡æ–°æ³¨å†Œä¸€é.</p><p>å¯èƒ½ä¼šæ¯”è¾ƒå¥½å¥‡è¿™ä¸ªåç½®å¤„ç†å™¨æ˜¯å¹²ä»€ä¹ˆç”¨çš„ ï¼Ÿ åœ¨åé¢å®ä¾‹åŒ– bean çš„æ—¶å€™ï¼Œå°±å¯ä»¥çœ‹åˆ°æ˜¯æœ‰èµ°å¾ˆå¤šåç½®å¤„ç†å™¨çš„.</p><p>æ‰€ä»¥è¯¥æ–¹æ³•æ˜¯å¯¹ beanPostçš„åç½®å¤„ç†å™¨è¿›è¡Œå®ä¾‹åŒ–å¹¶ä¸”æ³¨å†Œåˆ° Spring çš„ BeanFactory ä¸­æ¥çš„.</p><h5 id="initMessageSource-æ–¹æ³•"><a href="#initMessageSource-æ–¹æ³•" class="headerlink" title="initMessageSource () æ–¹æ³•"></a>initMessageSource () æ–¹æ³•</h5><p>åˆå§‹åŒ– messageSource .</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Initialize the MessageSource.</span></span><br><span class="line"><span class="comment"> * Use parent&#x27;s if none defined in this context.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initMessageSource</span><span class="params">()</span> &#123;</span><br><span class="line"> <span class="comment">// è·å–å‡º beanFactory   </span></span><br><span class="line">   <span class="type">ConfigurableListableBeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> getBeanFactory();</span><br><span class="line"><span class="comment">// å¦‚æœ beanFactory åŒ…å«äº†åå­—æ˜¯messageSourceçš„æœ¬åœ°bean.    </span></span><br><span class="line">   <span class="keyword">if</span> (beanFactory.containsLocalBean(MESSAGE_SOURCE_BEAN_NAME)) &#123;</span><br><span class="line">  <span class="comment">// ä» beanFactory ä¸­è·å–å‡ºæ¥.     </span></span><br><span class="line">      <span class="built_in">this</span>.messageSource = beanFactory.getBean(MESSAGE_SOURCE_BEAN_NAME, MessageSource.class);</span><br><span class="line">      <span class="comment">// Make MessageSource aware of parent MessageSource.</span></span><br><span class="line"><span class="comment">// this.parentä¸æ˜¯nullå¹¶ä¸”   messageSourceæ˜¯   HierarchicalMessageSourceç±»å‹ </span></span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.parent != <span class="literal">null</span> &amp;&amp; <span class="built_in">this</span>.messageSource <span class="keyword">instanceof</span> HierarchicalMessageSource) &#123;</span><br><span class="line">  <span class="comment">// å¼ºè½¬,åˆ¤æ–­  getParentMessageSource æ˜¯ä¸æ˜¯null,å¦‚æœæ˜¯nullçš„è¯,å°±è°ƒç”¨ getInternalParentMessageSource() å°†è·å–å‡ºæ¥çš„å€¼ç»™setè¿›å».     </span></span><br><span class="line">         <span class="type">HierarchicalMessageSource</span> <span class="variable">hms</span> <span class="operator">=</span> (HierarchicalMessageSource) <span class="built_in">this</span>.messageSource;</span><br><span class="line">         <span class="keyword">if</span> (hms.getParentMessageSource() == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Only set parent context as parent MessageSource if no parent MessageSource</span></span><br><span class="line">            <span class="comment">// registered already.</span></span><br><span class="line">            hms.setParentMessageSource(getInternalParentMessageSource());</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">         logger.trace(<span class="string">&quot;Using MessageSource [&quot;</span> + <span class="built_in">this</span>.messageSource + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// è¿™é‡Œæ˜¯ä¸åŒ…å«çš„æƒ…å†µ.       </span></span><br><span class="line">      <span class="comment">// Use empty MessageSource to be able to accept getMessage calls.</span></span><br><span class="line">      <span class="type">DelegatingMessageSource</span> <span class="variable">dms</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DelegatingMessageSource</span>();</span><br><span class="line"><span class="comment">// getInternalParentMessageSource() è¿”å›çš„æ˜¯null       </span></span><br><span class="line">      dms.setParentMessageSource(getInternalParentMessageSource());</span><br><span class="line">      <span class="built_in">this</span>.messageSource = dms;</span><br><span class="line"><span class="comment">// æ³¨å†Œåˆ° beanFactory ä¸­æ¥       </span></span><br><span class="line">      beanFactory.registerSingleton(MESSAGE_SOURCE_BEAN_NAME, <span class="built_in">this</span>.messageSource);</span><br><span class="line">      <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">         logger.trace(<span class="string">&quot;No &#x27;&quot;</span> + MESSAGE_SOURCE_BEAN_NAME + <span class="string">&quot;&#x27; bean, using [&quot;</span> + <span class="built_in">this</span>.messageSource + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•å¯ä»¥çœ‹åˆ°æ˜¯å¯¹ messageSource çš„åˆå§‹åŒ–è¿›è¡Œæ“ä½œ.</p><h5 id="initApplicationEventMulticaster-æ–¹æ³•"><a href="#initApplicationEventMulticaster-æ–¹æ³•" class="headerlink" title="initApplicationEventMulticaster æ–¹æ³•"></a>initApplicationEventMulticaster æ–¹æ³•</h5><p>è¿™é‡Œå¦‚æœäº†è§£è¿‡ Spring çš„Event æœºåˆ¶çš„è¯,æ˜¯å¯ä»¥æ¯”è¾ƒæ¸…æ™°çš„æ„Ÿè§‰åˆ°,æ˜¯å¯¹ ApplicationEventMulticaster çš„åˆå§‹åŒ–.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Initialize the ApplicationEventMulticaster.</span></span><br><span class="line"><span class="comment"> * Uses SimpleApplicationEventMulticaster if none defined in the context.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> org.springframework.context.event.SimpleApplicationEventMulticaster</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initApplicationEventMulticaster</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">// è·å–å‡º beanFactory æ¥.  </span></span><br><span class="line">   <span class="type">ConfigurableListableBeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> getBeanFactory();</span><br><span class="line"><span class="comment">// åˆ¤æ–­ beanFactory æ˜¯å¦åŒ…å«  applicationEventMulticaster    </span></span><br><span class="line">   <span class="keyword">if</span> (beanFactory.containsLocalBean(APPLICATION_EVENT_MULTICASTER_BEAN_NAME)) &#123;</span><br><span class="line"><span class="comment">// å¦‚æœåŒ…å«çš„è¯ï¼Œå°±ç›´æ¥ä»beanFactroyä¸­è·å–å‡ºæ¥,å¹¶ä¸”èµ‹å€¼ç»™  applicationEventMulticaster  </span></span><br><span class="line">      <span class="built_in">this</span>.applicationEventMulticaster =</span><br><span class="line">            beanFactory.getBean(APPLICATION_EVENT_MULTICASTER_BEAN_NAME, ApplicationEventMulticaster.class);</span><br><span class="line">      <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">         logger.trace(<span class="string">&quot;Using ApplicationEventMulticaster [&quot;</span> + <span class="built_in">this</span>.applicationEventMulticaster + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line"> <span class="comment">// å¦‚æœä¸åŒ…å«çš„è¯,ä¼ å…¥beanFactoryæ¥ç€å°±æ˜¯newä¸€ä¸ªSimpleApplicationEventMulticasterå‡ºæ¥      </span></span><br><span class="line">      <span class="built_in">this</span>.applicationEventMulticaster = <span class="keyword">new</span> <span class="title class_">SimpleApplicationEventMulticaster</span>(beanFactory);</span><br><span class="line"><span class="comment">// ç„¶åæ³¨å†Œåˆ° beanFactory ä¸­æ¥.      </span></span><br><span class="line">      beanFactory.registerSingleton(APPLICATION_EVENT_MULTICASTER_BEAN_NAME, <span class="built_in">this</span>.applicationEventMulticaster);</span><br><span class="line">      <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">         logger.trace(<span class="string">&quot;No &#x27;&quot;</span> + APPLICATION_EVENT_MULTICASTER_BEAN_NAME + <span class="string">&quot;&#x27; bean, using &quot;</span> +</span><br><span class="line">               <span class="string">&quot;[&quot;</span> + <span class="built_in">this</span>.applicationEventMulticaster.getClass().getSimpleName() + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°, ä¸»è¦æ˜¯å¯¹ applicationEventMulticaster çš„åˆå§‹åŒ–.</p><p>å¦‚æœbeanFactoryæœ‰çš„è¯ï¼Œå°±ä»å…¶ä¸­æ‹¿ï¼Œå¦‚æœæ²¡æœ‰å°±è‡ªå·±newä¸€ä¸ª,æœ€åæ³¨å†Œåˆ°beanFactoryä¸­æ¥.</p><h5 id="onRefresh-æ–¹æ³•"><a href="#onRefresh-æ–¹æ³•" class="headerlink" title="onRefresh() æ–¹æ³•"></a>onRefresh() æ–¹æ³•</h5><p>è¿™é‡Œæ˜¯æ²¡æœ‰åšä»»ä½•äº‹æƒ…çš„ï¼Œå¦‚æœæ˜¯SpringBootçš„æºç çš„ï¼Œè¿™é‡Œå°±æ˜¯å¯åŠ¨tomcatçš„.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Template method which can be overridden to add context-specific refresh work.</span></span><br><span class="line"><span class="comment"> * Called on initialization of special beans, before instantiation of singletons.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;This implementation is empty.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> BeansException in case of errors</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #refresh()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onRefresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">   <span class="comment">// For subclasses: do nothing by default.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="registerListeners-æ–¹æ³•"><a href="#registerListeners-æ–¹æ³•" class="headerlink" title="registerListeners() æ–¹æ³•"></a>registerListeners() æ–¹æ³•</h5><p>ä»åå­—æ¥çœ‹,è¿™é‡Œæ˜¯æ³¨å†Œç›‘å¬å™¨çš„æ„æ€.</p><p>org.springframework.context.event.AbstractApplicationEventMulticaster.ListenerRetriever#applicationListeners è¿™é‡Œæ˜¯å­˜æ”¾ç›‘å¬å™¨çš„åœ°æ–¹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Add beans that implement ApplicationListener as listeners.</span></span><br><span class="line"><span class="comment"> * Doesn&#x27;t affect other listeners, which can be added without being beans.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">registerListeners</span><span class="params">()</span> &#123;</span><br><span class="line">   <span class="comment">// Register statically specified listeners first.</span></span><br><span class="line"><span class="comment">// getApplicationListeners() è·å–å‡ºæ¥çš„æ˜¯ç©ºé›†åˆ.    </span></span><br><span class="line">   <span class="keyword">for</span> (ApplicationListener&lt;?&gt; listener : getApplicationListeners()) &#123;</span><br><span class="line">      getApplicationEventMulticaster().addApplicationListener(listener);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Do not initialize FactoryBeans here: We need to leave all regular beans</span></span><br><span class="line">   <span class="comment">// uninitialized to let post-processors apply to them!</span></span><br><span class="line"><span class="comment">// æ ¹æ®ApplicationListeneræ¥è·å–å‡ºç›‘å¬å™¨ï¼Œè¿™ä¹Ÿä¹Ÿæ˜¯æ²¡æœ‰çš„.     </span></span><br><span class="line">   String[] listenerBeanNames = getBeanNamesForType(ApplicationListener.class, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">   <span class="keyword">for</span> (String listenerBeanName : listenerBeanNames) &#123;</span><br><span class="line">      getApplicationEventMulticaster().addApplicationListenerBean(listenerBeanName);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Publish early application events now that we finally have a multicaster...</span></span><br><span class="line"><span class="comment">// è¿™é‡Œä¹Ÿæ˜¯è·å–æ—©åˆå§‹çš„ ApplicationEvent.    </span></span><br><span class="line">   Set&lt;ApplicationEvent&gt; earlyEventsToProcess = <span class="built_in">this</span>.earlyApplicationEvents;</span><br><span class="line">   <span class="built_in">this</span>.earlyApplicationEvents = <span class="literal">null</span>;</span><br><span class="line">   <span class="keyword">if</span> (earlyEventsToProcess != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span> (ApplicationEvent earlyEvent : earlyEventsToProcess) &#123;</span><br><span class="line">         getApplicationEventMulticaster().multicastEvent(earlyEvent);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>org.springframework.context.event.SimpleApplicationEventMulticaster#multicastEvent(org.springframework.context.ApplicationEvent, org.springframework.core.ResolvableType) å¯ä»¥çœ‹ä¸‹è¿™ä¸ªæ–¹æ³•æˆ–è€…åç»­æˆ‘ä»¬å†è¯¦ç»†çš„çœ‹ï¼ŒSpringæ˜¯å¦‚ä½•å‘é€eventçš„ï¼Œä»¥åŠé‚£äº›ç›‘å¬å™¨æ˜¯æ€ä¹ˆè·å–åˆ° event çš„.</p><p>TODO : è¿™é‡Œåé¢æ˜¯æœ‰å¾…è¯¦ç»†çš„è®²è§£çš„.</p><h5 id="finishBeanFactoryInitialization-æ–¹æ³•"><a href="#finishBeanFactoryInitialization-æ–¹æ³•" class="headerlink" title="finishBeanFactoryInitialization() æ–¹æ³•"></a>finishBeanFactoryInitialization() æ–¹æ³•</h5><p>ä»åå­—ç†è§£ä¸Š,è¿™é‡Œæ˜¯å¯¹ beanFactoryçš„åˆå§‹åŒ–ç»“æŸ.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Finish the initialization of this context&#x27;s bean factory,</span></span><br><span class="line"><span class="comment"> * initializing all remaining singleton beans.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">finishBeanFactoryInitialization</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> &#123;</span><br><span class="line">   <span class="comment">// Initialize conversion service for this context.</span></span><br><span class="line"> <span class="comment">// å¦‚æœbeanFactroyåŒ…å«conversionServiceå¹¶ä¸”typeæ˜¯ConversionService.classçš„è¯ï¼Œ</span></span><br><span class="line">   <span class="keyword">if</span> (beanFactory.containsBean(CONVERSION_SERVICE_BEAN_NAME) &amp;&amp;</span><br><span class="line">         beanFactory.isTypeMatch(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class)) &#123;</span><br><span class="line"><span class="comment">// å°±ä¼šä»beanFactoryä¸­è·å–å‡ºå¯¹è±¡è®¾ç½®åˆ°beanFactoryçš„ConversionServiceæ¥.       </span></span><br><span class="line">      beanFactory.setConversionService(</span><br><span class="line">            beanFactory.getBean(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Register a default embedded value resolver if no bean post-processor</span></span><br><span class="line">   <span class="comment">// (such as a PropertyPlaceholderConfigurer bean) registered any before:</span></span><br><span class="line">   <span class="comment">// at this point, primarily for resolution in annotation attribute values.</span></span><br><span class="line">   <span class="keyword">if</span> (!beanFactory.hasEmbeddedValueResolver()) &#123;</span><br><span class="line"><span class="comment">//org.springframework.beans.factory.support.AbstractBeanFactory#addEmbeddedValueResolver //æ·»åŠ åˆ°org.springframework.beans.factory.support.AbstractBeanFactory#embeddedValueResolversä¸­æ¥.      </span></span><br><span class="line">      beanFactory.addEmbeddedValueResolver(strVal -&gt; getEnvironment().resolvePlaceholders(strVal));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Initialize LoadTimeWeaverAware beans early to allow for registering their transformers early.</span></span><br><span class="line"><span class="comment">// æ ¹æ®  LoadTimeWeaverAware.class æ¥è·å–ä¿¡æ¯.   </span></span><br><span class="line"><span class="comment">// å¾ˆæ˜æ˜¾è¿™é‡Œæˆ‘ä»¬æ˜¯æ²¡æœ‰é…ç½®çš„,æ‰€ä»¥ä¹Ÿå°±æ˜¯æ²¡æœ‰çš„.    </span></span><br><span class="line">   String[] weaverAwareNames = beanFactory.getBeanNamesForType(LoadTimeWeaverAware.class, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">   <span class="keyword">for</span> (String weaverAwareName : weaverAwareNames) &#123;</span><br><span class="line">      getBean(weaverAwareName);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Stop using the temporary ClassLoader for type matching.</span></span><br><span class="line">   beanFactory.setTempClassLoader(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Allow for caching all bean definition metadata, not expecting further changes.</span></span><br><span class="line"><span class="comment">//org.springframework.beans.factory.support.DefaultListableBeanFactory#freezeConfiguration</span></span><br><span class="line"><span class="comment">// è®¾ç½®configurationFrozenæ˜¯true,</span></span><br><span class="line"><span class="comment">// å°†beanDefinitionNamesé›†åˆè½¬å“ˆä¸ºStringç±»å‹çš„æ•°ç»„. StringUtils.toStringArray(this.beanDefinitionNames);ä½¿ç”¨è¿™ä¸ªæ–¹æ³•å³å¯.    </span></span><br><span class="line">   beanFactory.freezeConfiguration();</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Instantiate all remaining (non-lazy-init) singletons.</span></span><br><span class="line">   beanFactory.preInstantiateSingletons();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="preInstantiateSingletons-æ–¹æ³•"><a href="#preInstantiateSingletons-æ–¹æ³•" class="headerlink" title="preInstantiateSingletons æ–¹æ³•"></a>preInstantiateSingletons æ–¹æ³•</h6><p>è¿™é‡Œå°±æ˜¯å¯¹ å•ä¾‹æ±  é‡Œé¢çš„å¯¹è±¡è¿›è¡Œåˆå§‹åŒ–,å¯ä»¥çœ‹åˆ°æ˜¯æœ‰ getBean æ–¹æ³•çš„.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">preInstantiateSingletons</span><span class="params">()</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">   <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">      logger.trace(<span class="string">&quot;Pre-instantiating singletons in &quot;</span> + <span class="built_in">this</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Iterate over a copy to allow for init methods which in turn register new bean definitions.</span></span><br><span class="line">   <span class="comment">// While this may not be part of the regular factory bootstrap, it does otherwise work fine.</span></span><br><span class="line"><span class="comment">// è¿™é‡Œè·å–å‡ºæ¥çš„ beanNames æ˜¯æœ‰6ä¸ªçš„,å…¶ä¸­äº”ä¸ªæ˜¯åŒ…å«äº†å†…éƒ¨çš„</span></span><br><span class="line"><span class="comment">//org.springframework.context.annotation.internalConfigurationAnnotationProcessor</span></span><br><span class="line"><span class="comment">//org.springframework.context.annotation.internalAutowiredAnnotationProcessor</span></span><br><span class="line"><span class="comment">//org.springframework.context.annotation.internalCommonAnnotationProcessor</span></span><br><span class="line"><span class="comment">//org.springframework.context.event.internalEventListenerProcessor</span></span><br><span class="line"><span class="comment">//org.springframework.context.event.internalEventListenerFactory</span></span><br><span class="line"><span class="comment">//yangBeanScannerConfig    </span></span><br><span class="line">   List&lt;String&gt; beanNames = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(<span class="built_in">this</span>.beanDefinitionNames);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Trigger initialization of all non-lazy singleton beans...</span></span><br><span class="line">   <span class="keyword">for</span> (String beanName : beanNames) &#123;</span><br><span class="line">      <span class="type">RootBeanDefinition</span> <span class="variable">bd</span> <span class="operator">=</span> getMergedLocalBeanDefinition(beanName);</span><br><span class="line">       </span><br><span class="line">  <span class="comment">// bd ä¸æ˜¯æŠ½è±¡çš„&amp;æ˜¯å•ä¾‹çš„&amp;ä¸æ˜¯èµ–åŠ è½½çš„     </span></span><br><span class="line">      <span class="keyword">if</span> (!bd.isAbstract() &amp;&amp; bd.isSingleton() &amp;&amp; !bd.isLazyInit()) &#123;</span><br><span class="line">  <span class="comment">// åˆ¤æ–­æ˜¯ä¸æ˜¯ FactroyBean        </span></span><br><span class="line">         <span class="keyword">if</span> (isFactoryBean(beanName)) &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">bean</span> <span class="operator">=</span> getBean(FACTORY_BEAN_PREFIX + beanName);</span><br><span class="line">            <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> FactoryBean) &#123;</span><br><span class="line">               <span class="keyword">final</span> FactoryBean&lt;?&gt; factory = (FactoryBean&lt;?&gt;) bean;</span><br><span class="line">               <span class="type">boolean</span> isEagerInit;</span><br><span class="line">               <span class="keyword">if</span> (System.getSecurityManager() != <span class="literal">null</span> &amp;&amp; factory <span class="keyword">instanceof</span> SmartFactoryBean) &#123;</span><br><span class="line">                  isEagerInit = AccessController.doPrivileged((PrivilegedAction&lt;Boolean&gt;)</span><br><span class="line">                              ((SmartFactoryBean&lt;?&gt;) factory)::isEagerInit,</span><br><span class="line">                        getAccessControlContext());</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">else</span> &#123;</span><br><span class="line">                  isEagerInit = (factory <span class="keyword">instanceof</span> SmartFactoryBean &amp;&amp;</span><br><span class="line">                        ((SmartFactoryBean&lt;?&gt;) factory).isEagerInit());</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">if</span> (isEagerInit) &#123;</span><br><span class="line">                  getBean(beanName);</span><br><span class="line">               &#125;</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// è¿™é‡Œä¸æ˜¯ FactoryBean  </span></span><br><span class="line"><span class="comment">// å¯ä»¥çœ‹åˆ°å½“æˆ‘èµ°åˆ°yangBeanScannerConfig,æˆ‘ä»¬å®šä¹‰çš„ç±»çš„æ—¶å€™,èµ°å®Œè¿™ä¸ªæ–¹æ³•ï¼Œå°±å¯ä»¥çœ‹åˆ°com.iyang.spring.config.YangBeanScannerConfig#YangBeanScannerConfigä¸­æ‰“å°çš„è¯­å¥äº†,ä¹Ÿå°±æ˜¯è¯´èµ°å®Œè¿™é‡Œï¼Œæˆ‘ä»¬å®šä¹‰çš„beanå°±å·²ç»è¢«Springè¢«å®ä¾‹åŒ–äº†.             </span></span><br><span class="line">            getBean(beanName);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Trigger post-initialization callback for all applicable beans...</span></span><br><span class="line"><span class="comment">// è¿™é‡Œå†å¯¹ beanNames è¿›è¡Œè¿­ä»£,å¦‚æœæ˜¯ SmartInitializingSingleton çš„è¯ï¼Œå°±ä¼šå†è°ƒç”¨    afterSingletonsInstantiated æ–¹æ³•.</span></span><br><span class="line">   <span class="keyword">for</span> (String beanName : beanNames) &#123;</span><br><span class="line">      <span class="type">Object</span> <span class="variable">singletonInstance</span> <span class="operator">=</span> getSingleton(beanName);</span><br><span class="line">      <span class="keyword">if</span> (singletonInstance <span class="keyword">instanceof</span> SmartInitializingSingleton) &#123;</span><br><span class="line">         <span class="keyword">final</span> <span class="type">SmartInitializingSingleton</span> <span class="variable">smartSingleton</span> <span class="operator">=</span> (SmartInitializingSingleton) singletonInstance;</span><br><span class="line">         <span class="keyword">if</span> (System.getSecurityManager() != <span class="literal">null</span>) &#123;</span><br><span class="line">            AccessController.doPrivileged((PrivilegedAction&lt;Object&gt;) () -&gt; &#123;</span><br><span class="line">               smartSingleton.afterSingletonsInstantiated();</span><br><span class="line">               <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;, getAccessControlContext());</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">else</span> &#123;</span><br><span class="line">            smartSingleton.afterSingletonsInstantiated();</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥å¯¹æˆ‘ä»¬å®šä¹‰çš„ bean è¿›è¡Œå®ä¾‹åŒ–ï¼Œæœ€åæ˜¯è°ƒç”¨äº† getBean æ–¹æ³•ï¼Œ getBean æ–¹æ³•è¡¨é¢çœ‹ä¸Šå»æ˜¯è·å–ï¼Œå…¶å®å¦‚æœæ²¡æœ‰çš„è¯ï¼Œè°ƒç”¨çš„æ˜¯createBeanæ–¹æ³•, ä¹Ÿå°±æ˜¯ä¼šå®ä¾‹åŒ–æˆ‘ä»¬çš„beanã€‚å½“ç„¶å®ƒè‚¯å®šä¸ä¼šå¾ˆç®€å•çš„å»è°ƒç”¨åå°„å°±å®ä¾‹åŒ–å®Œä¸€ä¸ªæˆ‘ä»¬çš„bean,è‚¯å®šæ˜¯æœ‰ä¸€ç³»åˆ—çš„èµ°Springå†…ç½®çš„æˆ–è€…æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„åç½®å¤„ç†å™¨ç­‰æ“ä½œ.</p><p>getBean æ–¹æ³•éœ€è¦åé¢ä¸“é—¨é¢†å‡ºæ¥åˆ†æï¼Œä¸èƒ½ç®€å•çš„è¿‡ï¼Œè¿™é‡Œå¯¹ Spring å®¹å™¨è¿›è¡Œå¤§è‡´çš„flowè¿‡,æ‰€ä»¥è¿˜æ˜¯æ¯”è¾ƒè½»ææ·¡å†™çš„å†™è¿‡å».</p><h5 id="finishRefresh-æ–¹æ³•"><a href="#finishRefresh-æ–¹æ³•" class="headerlink" title="finishRefresh æ–¹æ³•"></a>finishRefresh æ–¹æ³•</h5><p>ä¸­æ–‡å¼çš„è‹±è¯­ : ç»“æŸåˆ·æ–°æ–¹æ³•.</p><p>æ˜¾ç¤ºæ¸…é™¤ç¼“å­˜,å†æ˜¯initäº†LifecycleProcessor,è°ƒç”¨å…¶onRefresh()æ–¹æ³•,æ¥è¿‘å°±æ˜¯å‘é€ä¸€ä¸ªContextRefreshedEventäº‹ä»¶å‡ºæ¥.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Finish the refresh of this context, invoking the LifecycleProcessor&#x27;s</span></span><br><span class="line"><span class="comment"> * onRefresh() method and publishing the</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> org.springframework.context.event.ContextRefreshedEvent&#125;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">finishRefresh</span><span class="params">()</span> &#123;</span><br><span class="line">   <span class="comment">// Clear context-level resource caches (such as ASM metadata from scanning).</span></span><br><span class="line"><span class="comment">//å¯¹org.springframework.core.io.DefaultResourceLoader#resourceCachesè¿›è¡Œæ¸…é™¤.    </span></span><br><span class="line">   clearResourceCaches();</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Initialize lifecycle processor for this context.</span></span><br><span class="line">   initLifecycleProcessor();</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Propagate refresh to lifecycle processor first.</span></span><br><span class="line"><span class="comment">//org.springframework.context.support.DefaultLifecycleProcessor</span></span><br><span class="line"><span class="comment">//org.springframework.context.support.DefaultLifecycleProcessor#startBeans</span></span><br><span class="line">    </span><br><span class="line">   getLifecycleProcessor().onRefresh();</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Publish the final event.</span></span><br><span class="line"><span class="comment">// æ¨é€Event,è¿™é‡Œçš„Eventæ˜¯ ContextRefreshedEvent.    </span></span><br><span class="line">   publishEvent(<span class="keyword">new</span> <span class="title class_">ContextRefreshedEvent</span>(<span class="built_in">this</span>));</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Participate in LiveBeansView MBean, if active.</span></span><br><span class="line"><span class="comment">//org.springframework.context.support.LiveBeansView#registerApplicationContext</span></span><br><span class="line"><span class="comment">//å…ˆæ ¹æ®key:spring.liveBeansView.mbeanDomainè·å–value,è¿™é‡Œè·å–å‡ºæ¥çš„æ˜¯null,</span></span><br><span class="line"><span class="comment">// æ‰€ä»¥ä¹Ÿå°±æ˜¯æ²¡æœ‰ä¸‹æ–‡äº†.    </span></span><br><span class="line">   LiveBeansView.registerApplicationContext(<span class="built_in">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="initLifecycleProcessor-æ–¹æ³•"><a href="#initLifecycleProcessor-æ–¹æ³•" class="headerlink" title="initLifecycleProcessor æ–¹æ³• ()"></a>initLifecycleProcessor æ–¹æ³• ()</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Initialize the LifecycleProcessor.</span><br><span class="line"> * Uses DefaultLifecycleProcessor if none defined in the context.</span><br><span class="line"> * @see org.springframework.context.support.DefaultLifecycleProcessor</span><br><span class="line"> */</span><br><span class="line">protected void initLifecycleProcessor() &#123;</span><br><span class="line">  // è·å–å‡º beanFactory æ¥.  </span><br><span class="line">   ConfigurableListableBeanFactory beanFactory = getBeanFactory();</span><br><span class="line">// åˆ¤æ–­beanFactoryä¸­æ˜¯å¦åŒ…å«lifecycleProcessor    </span><br><span class="line">   if (beanFactory.containsLocalBean(LIFECYCLE_PROCESSOR_BEAN_NAME)) &#123;</span><br><span class="line">// åŒ…å«çš„è¯,å°±ä¼šè·å–å‡ºæ¥,æŒ‡å‘this.lifecycleProcessor       </span><br><span class="line">      this.lifecycleProcessor =</span><br><span class="line">            beanFactory.getBean(LIFECYCLE_PROCESSOR_BEAN_NAME, LifecycleProcessor.class);</span><br><span class="line">      if (logger.isTraceEnabled()) &#123;</span><br><span class="line">         logger.trace(&quot;Using LifecycleProcessor [&quot; + this.lifecycleProcessor + &quot;]&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   else &#123;</span><br><span class="line">   // å¦‚æœä¸åŒ…å«çš„è¯ï¼Œå°±è‡ªå·±newä¸€ä¸ª,ç„¶åæ³¨å†Œåˆ°Springå®¹å™¨ä¸­æ¥.    </span><br><span class="line">      DefaultLifecycleProcessor defaultProcessor = new DefaultLifecycleProcessor();</span><br><span class="line">      defaultProcessor.setBeanFactory(beanFactory);</span><br><span class="line">      this.lifecycleProcessor = defaultProcessor;</span><br><span class="line">      beanFactory.registerSingleton(LIFECYCLE_PROCESSOR_BEAN_NAME, this.lifecycleProcessor);</span><br><span class="line">      if (logger.isTraceEnabled()) &#123;</span><br><span class="line">         logger.trace(&quot;No &#x27;&quot; + LIFECYCLE_PROCESSOR_BEAN_NAME + &quot;&#x27; bean, using &quot; +</span><br><span class="line">               &quot;[&quot; + this.lifecycleProcessor.getClass().getSimpleName() + &quot;]&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="publishEvent-æ–¹æ³•"><a href="#publishEvent-æ–¹æ³•" class="headerlink" title="publishEvent æ–¹æ³•"></a>publishEvent æ–¹æ³•</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Publish the given event to all listeners.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> event the event to publish (may be an &#123;<span class="doctag">@link</span> ApplicationEvent&#125;</span></span><br><span class="line"><span class="comment"> * or a payload object to be turned into a &#123;<span class="doctag">@link</span> PayloadApplicationEvent&#125;)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> eventType the resolved event type, if known</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 4.2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">publishEvent</span><span class="params">(Object event, <span class="meta">@Nullable</span> ResolvableType eventType)</span> &#123;</span><br><span class="line">   Assert.notNull(event, <span class="string">&quot;Event must not be null&quot;</span>);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Decorate event as an ApplicationEvent if necessary</span></span><br><span class="line">   ApplicationEvent applicationEvent;</span><br><span class="line">    </span><br><span class="line"><span class="comment">// å¯¹ä¼ å…¥è¿›æ¥çš„ event è¿›è¡Œç±»å‹çš„åˆ¤æ–­.    </span></span><br><span class="line">   <span class="keyword">if</span> (event <span class="keyword">instanceof</span> ApplicationEvent) &#123;</span><br><span class="line">      applicationEvent = (ApplicationEvent) event;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line">      applicationEvent = <span class="keyword">new</span> <span class="title class_">PayloadApplicationEvent</span>&lt;&gt;(<span class="built_in">this</span>, event);</span><br><span class="line">      <span class="keyword">if</span> (eventType == <span class="literal">null</span>) &#123;</span><br><span class="line">         eventType = ((PayloadApplicationEvent&lt;?&gt;) applicationEvent).getResolvableType();</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Multicast right now if possible - or lazily once the multicaster is initialized</span></span><br><span class="line">   <span class="keyword">if</span> (<span class="built_in">this</span>.earlyApplicationEvents != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="built_in">this</span>.earlyApplicationEvents.add(applicationEvent);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">//org.springframework.context.event.SimpleApplicationEventMulticaster#multicastEvent(org.springframework.context.ApplicationEvent, org.springframework.core.ResolvableType)</span></span><br><span class="line"><span class="comment">//èµ°åˆ°äº†è¿™é‡Œæ¥å‘é€eventçš„,       </span></span><br><span class="line">      getApplicationEventMulticaster().multicastEvent(applicationEvent, eventType);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Publish event via parent context as well...</span></span><br><span class="line"><span class="comment">// è¿™é‡Œçš„ parentæ˜¯null.    </span></span><br><span class="line">   <span class="keyword">if</span> (<span class="built_in">this</span>.parent != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.parent <span class="keyword">instanceof</span> AbstractApplicationContext) &#123;</span><br><span class="line">         ((AbstractApplicationContext) <span class="built_in">this</span>.parent).publishEvent(event, eventType);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="built_in">this</span>.parent.publishEvent(event);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ˜¯å‘é€ContextRefreshedEventäº‹ä»¶å‡ºæ¥.</p><h5 id="resetCommonCaches-æ–¹æ³•"><a href="#resetCommonCaches-æ–¹æ³•" class="headerlink" title="resetCommonCaches æ–¹æ³•()"></a>resetCommonCaches æ–¹æ³•()</h5><p>å¯ä»¥çœ‹åˆ° finally ä»£ç å—ä¸­æ˜¯ç–¯ç‹‚çš„æ¸…é™¤å„ç§ç¼“å­˜.</p><p>å¯ä»¥å¤§å®¶å¯ä»¥ç‚¹è¿›å»è¯¦ç»†çš„çœ‹ä¸‹ï¼Œå…·ä½“å°±ä¸ä»”ç»†æè¿°äº†.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Reset Spring&#x27;s common reflection metadata caches, in particular the</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> ReflectionUtils&#125;, &#123;<span class="doctag">@link</span> AnnotationUtils&#125;, &#123;<span class="doctag">@link</span> ResolvableType&#125;</span></span><br><span class="line"><span class="comment"> * and &#123;<span class="doctag">@link</span> CachedIntrospectionResults&#125; caches.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 4.2</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> ReflectionUtils#clearCache()</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> AnnotationUtils#clearCache()</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> ResolvableType#clearCache()</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> CachedIntrospectionResults#clearClassLoader(ClassLoader)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">resetCommonCaches</span><span class="params">()</span> &#123;</span><br><span class="line">   ReflectionUtils.clearCache();</span><br><span class="line">   AnnotationUtils.clearCache();</span><br><span class="line">   ResolvableType.clearCache();</span><br><span class="line">   CachedIntrospectionResults.clearClassLoader(getClassLoader());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>æœ€åæ€»ç»“ä¸‹,Springåœ¨åŠ è½½ bean &amp; å¤„ç†å†…ç½®çš„ä¸€äº›é…ç½® &amp; å†…éƒ¨å¤„ç†å™¨çš„æ—¶å€™,æ˜¯ä¸‹äº†å¾ˆå¤šçš„åŠŸå¤«ã€‚å¯ä»¥çœ‹ç€è¿™äº›æ–¹æ³•ä¸€æ­¥ä¸€æ­¥çš„åˆ†æä¸‹å»,ç†è§£èµ·æ¥ï¼Œä¸ªäººæ„Ÿè§‰è¿™é‡Œè¿˜ä¸æ˜¯ç‰¹åˆ«æ·±å…¥çš„è·Ÿè¿›å»äº†ä»£ç ï¼Œåªæ˜¯ä¸€ä¸ªç®€å•çš„å¤§æ¦‚æè¿°ï¼Œæ›´æ·±å…¥çš„çŸ¥è¯†éœ€è¦æ›´åŠ è¯¦ç»†çš„ç†è§£ç­‰äº†.</p><p>è¿™é‡Œåªæ˜¯ç®€å•çš„å¯¹è¿™ä¸ªæ•´ä¸ªflowæ¥è¿›è¡Œæè¿°ï¼Œè¿˜ä¸æ˜¯ç‰¹åˆ«æœ‰è¯¦ç»†çš„é‚£ç§.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h4&gt;&lt;p&gt;è¿™é‡Œæ˜¯ç›¸å¯¹ä¸Šä¸€æ¬¡å†æ¬¡çš„é˜…è¯»å’Œè®°å½•,æ¯”ä¸Šæ¬¡æœ‰äº†æ›´æ·±å…¥çš„ç†è§£.&lt;/p&gt;
&lt;p&gt;è¿™é‡Œæ˜¯å†æ¬¡æ•´ç†çš„é˜…è¯» Spring çš„æºç , ç›¸å¯¹æ¯”ä¸Šæ¬¡çš„é˜…è¯»ï¼Œæˆ‘</summary>
      
    
    
    
    <category term="java" scheme="https://ruy9527.github.io/categories/java/"/>
    
    <category term="spring" scheme="https://ruy9527.github.io/categories/java/spring/"/>
    
    
    <category term="java" scheme="https://ruy9527.github.io/tags/java/"/>
    
    <category term="spring" scheme="https://ruy9527.github.io/tags/spring/"/>
    
  </entry>
  
  <entry>
    <title>springåˆå§‹åŒ–(ä¸‰)</title>
    <link href="https://ruy9527.github.io/2021/11/04/spring/spring%E5%88%9D%E5%A7%8B%E5%8C%96-%E4%B8%89/"/>
    <id>https://ruy9527.github.io/2021/11/04/spring/spring%E5%88%9D%E5%A7%8B%E5%8C%96-%E4%B8%89/</id>
    <published>2021-11-03T16:16:33.000Z</published>
    <updated>2022-11-04T13:46:13.920Z</updated>
    
    <content type="html"><![CDATA[<h4 id="é¢˜è®°"><a href="#é¢˜è®°" class="headerlink" title="é¢˜è®°"></a>é¢˜è®°</h4><p> å‰é¢è®²åˆ°äº†è¿™ä¹ˆå¤šçš„ä»€ä¹ˆBeanPostProcessor,äº‹ä»¶ä»€ä¹ˆçš„. å¦‚æœä¸å†™å‡ ä¸‹ä»£ç è¿™é‡Œæ€•æ˜¯å¾ˆéš¾å¼„æ¸…æ¥šæ˜¯ä¸ªæ€ä¹ˆå›äº‹. æ‰€ä»¥åªæœ‰çœ‹åˆ°ä»£ç è·‘,å°±å¤§è‡´å¯ä»¥çœ‹åˆ°å…¶æ•ˆæœè¿˜æ˜¯å¾ˆæ˜æ˜¾çš„.</p><h4 id="BeanDefinitionRegistryPostProcessor"><a href="#BeanDefinitionRegistryPostProcessor" class="headerlink" title="BeanDefinitionRegistryPostProcessor"></a>BeanDefinitionRegistryPostProcessor</h4><p> å…ˆå†™ä¸€ä¸ªç±»ç®€å•å®ç°ä¸‹ BeanDefinitionRegistryPostProcessor è¿™ä¸ªæ¥å£ :</p><p> è¿è¡Œåçš„ç»“æœæ˜¯å¯ä»¥å¾ˆæ˜æ˜¾çš„çœ‹åˆ°æˆ‘ä»¬çš„æ‰“å°æ•°æ®è¾“å‡ºç»“æœçš„.</p><p> ç¨‹åºæ˜¯æ€ä¹ˆè¿è¡Œåˆ°è¿™ä¸ªåœ°æ–¹æ¥çš„å‘¢ï¼Ÿ</p><p>org.springframework.context.support.PostProcessorRegistrationDelegate#invokeBeanFactoryPostProcessors(org.springframework.beans.factory.config.ConfigurableListableBeanFactory, java.util.List&lt;org.springframework.beans.factory.config.BeanFactoryPostProcessor&gt;) èµ°åˆ°è¿™ä¸ªæ–¹æ³•çš„</p><p>beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.classâ€¦..),ä»è¿™ä¸ªç±»ä¸­è·å–å‡ºæ¥çš„postProcessorNames,å°±æœ‰åŒ…å«æˆ‘ä»¬çš„è‡ªå·±å®šä¹‰çš„ä¸€ä¸ª.</p><p>ç”±äºæˆ‘ä»¬è‡ªå·±æ‰©å±•çš„è¿™ä¸ªç±»,æ˜¯æ²¡æœ‰å®ç° PriorityOrdered&#x2F;Orderedçš„,æ‰€ä»¥å°±æ”¾åˆ°æœ€åæ¥å¤„ç†äº†.</p><p>ä¹Ÿå°±æ˜¯åœ¨è¿™ä¸ªæ–¹æ³•,while (reiterate) { â€¦ invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry);}</p><p>èµ°çš„è¿™ä¸ªæ–¹æ³•çš„æ—¶å€™,æ‰ä¼šå»èµ°åˆ°æˆ‘ä»¬å®šä¹‰çš„ç±»ã€‚</p><p>é‚£æ˜¯å› ä¸ºè¿™ä¸ªåœ°æ–¹ Springæ˜¯æœ‰å¤„ç†é¡ºåºçš„ã€‚ å…ˆå¤„ç† PriorityOrdered.class , å†å¤„ç† Ordered.class , æœ€åå¤„ç†æ—¢æ²¡æœ‰PriorityOrdered,ä¹Ÿæ²¡æœ‰Orderedçš„.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GavinYangRegistryPostProcessor</span> <span class="keyword">implements</span> <span class="title class_">BeanDefinitionRegistryPostProcessor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">GavinYangRegistryPostProcessor</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;GavinYangRegistryPostProcessor æ„é€ æ–¹æ³•æ‰§è¡Œ&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postProcessBeanDefinitionRegistry</span><span class="params">(BeanDefinitionRegistry registry)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;è°ƒç”¨åˆ° GavinYangRegistryPostProcessor#postProcessBeanDefinitionRegistryæ–¹æ³•&quot;</span>);</span><br><span class="line">        String[] beanDefinitionNames = registry.getBeanDefinitionNames();</span><br><span class="line">        <span class="type">String</span> <span class="variable">bdNamesString</span> <span class="operator">=</span> Arrays.toString(beanDefinitionNames);</span><br><span class="line">        System.out.println(<span class="string">&quot;GavinYangRegistryPostProcessor ç±»ä¸­&quot;</span> + bdNamesString);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="BeanFactoryPostProcessor"><a href="#BeanFactoryPostProcessor" class="headerlink" title="BeanFactoryPostProcessor"></a>BeanFactoryPostProcessor</h4><p> ç®€å•å®ç°ä¸€ä¸‹ BeanFactoryPostProcessor è¿™ä¸ªæ¥å£æ¥çœ‹ä¸€ä¸‹æ•ˆæœ.</p><p> å…ˆå†™ä¸€ä¸ªç±» : ç„¶åå®ç°ä¸€ä¸‹è¿™ä¸ªæ¥å£ BeanFactoryPostProcessor , æˆ‘ä»¬è¿™é‡Œå°±è·å–ä¸‹beanFactoryä¸­çš„æ‰€æœ‰beanDefinitionNamesçš„æ•°ç»„, ç„¶åæ‰“å°å‡ºæ¥çœ‹ä¸‹æ•ˆæœ. æ‰“å°ç»“æœä¹Ÿæ˜¯è´´åœ¨ä¸‹é¢çš„. æ¥ç€æˆ‘ä»¬çœ‹ä¸‹å…¶æºç æ˜¯ä¸€ä¸ªæ€ä¹ˆæ ·çš„èµ°å‘.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GavinYangBeanFactoryPostProcessor</span> <span class="keyword">implements</span> <span class="title class_">BeanFactoryPostProcessor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        String[] beanDefinitionNames = beanFactory.getBeanDefinitionNames();</span><br><span class="line">        System.out.println(Arrays.toString(beanDefinitionNames));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//[org.springframework.context.annotation.internalConfigurationAnnotationProcessor, org.springframework.context.annotation.internalAutowiredAnnotationProcessor, org.springframework.context.annotation.internalCommonAnnotationProcessor, org.springframework.context.event.internalEventListenerProcessor, org.springframework.context.event.internalEventListenerFactory, yangBeanOne, gavinYangBeanFactoryPostProcessor, yangBeanPostProcessor, gavinYangLifeImpl]</span></span><br></pre></td></tr></table></figure><p>ç›´æ¥çœ‹è¿™ä¸ªç±»çš„è¿™ä¸ªæ–¹æ³•ï¼Œæˆ‘è¿™é‡Œåªæˆªå–äº†ä¸€éƒ¨åˆ†ä»£ç ,ä¹Ÿå°±æ˜¯å’Œ BeanFactoryPostProcessor æœ‰å…³çš„ä»£ç .</p><p>å’Œå®ƒæ²¡å…³ç³»çš„ä»£ç ,è¿™é‡Œå°±æ²¡æœ‰å»æˆªå–äº†.</p><p>org.springframework.context.support.PostProcessorRegistrationDelegate#invokeBeanFactoryPostProcessors(org.springframework.beans.factory.config.ConfigurableListableBeanFactory, java.util.List&lt;org.springframework.beans.factory.config.BeanFactoryPostProcessor&gt;) .</p><p>çœ‹æºç çœ‹æ˜¯å¦‚ä½•è°ƒç”¨åˆ°è¿™ä¸ªæ–¹æ³•çš„,è¿˜æ˜¯æ¯”è¾ƒå¥½ç†è§£ã€‚å…ˆæ˜¯æ ¹æ® BeanFactoryPostProcessor.classè·å–å‡ºbeanNameçš„é›†åˆ,ç„¶åè€è§„çŸ©è¿›è¡Œä¸€äº›ç‰¹å®šçš„æ’åº,å½“ç„¶æˆ‘è¿™é‡Œä»€ä¹ˆéƒ½æ²¡åš,ä¹Ÿå°±æ˜¯æœ€åå¤„ç†å“¦ã€‚</p><p>ç„¶åè·Ÿåˆ°invokeBeanFactoryPostProcessors(nonOrderedPostProcessors, beanFactory);è¿™ä¸ªæ–¹æ³•é‡Œé¢,å¯ä»¥çœ‹åˆ°å®ƒè¿­ä»£è¿™ä¸ªé›†åˆçš„å…ƒç´ ,å½“ç„¶äº†,æˆ‘ä»¬åªéœ€è¦å…³æ³¨æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„å“ªä¸ªå°±å¯ä»¥äº†,ç„¶åå°±ä¼šèµ°å…¶postProcessBeanFactoryæ–¹æ³•,ä¹Ÿå°±æ˜¯èµ°åˆ°äº†æˆ‘ä»¬å®šä¹‰çš„ç±»çš„è¿™ä¸ªæ–¹æ³•ä¸Šæ¥äº†.</p><p>OKå•¦ã€‚å¤§è‡´æµç¨‹å°±æ˜¯è¿™ä¸ªæ ·å­çš„,è¿˜æ˜¯æ¯”è¾ƒå¥½ç†è§£çš„.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Do not initialize FactoryBeans here: We need to leave all regular beans</span></span><br><span class="line"><span class="comment">// uninitialized to let the bean factory post-processors apply to them!</span></span><br><span class="line"><span class="comment">// è¿™ä¸ªåœ°æ–¹è·å–å‡ºæ¥çš„æ•°ç»„é‡Œé¢çš„å€¼,å°±æœ‰æˆ‘ä»¬æƒ³çœ‹åˆ°çš„.</span></span><br><span class="line"><span class="comment">//org.springframework.context.annotation.internalConfigurationAnnotationProcessor</span></span><br><span class="line"><span class="comment">//org.springframework.context.event.internalEventListenerProcessor</span></span><br><span class="line"><span class="comment">//gavinYangBeanFactoryPostProcessor</span></span><br><span class="line"><span class="comment">//å½“çœ‹åˆ°ç¬¬ä¸‰ä¸ªæ˜¯ä¸æ˜¯éå¸¸çš„ç†Ÿæ‚‰.æ²¡é”™,è¿™å°±æ˜¯æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„.</span></span><br><span class="line">String[] postProcessorNames =</span><br><span class="line">      beanFactory.getBeanNamesForType(BeanFactoryPostProcessor.class, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Separate between BeanFactoryPostProcessors that implement PriorityOrdered,</span></span><br><span class="line"><span class="comment">// Ordered, and the rest.</span></span><br><span class="line">List&lt;BeanFactoryPostProcessor&gt; priorityOrderedPostProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">List&lt;String&gt; orderedPostProcessorNames = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">List&lt;String&gt; nonOrderedPostProcessorNames = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"><span class="comment">// ç„¶åå…ˆç»è¿‡ä¸€è½®æ’åº,å°±å¯ä»¥çœ‹åˆ° æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„å°±æ”¾å…¥åˆ°äº†nonOrderedPostProcessorNamesè¿™ä¸ªé›†åˆä¸­,</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line">   <span class="keyword">if</span> (processedBeans.contains(ppName)) &#123;</span><br><span class="line">      <span class="comment">// skip - already processed in first phase above</span></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> <span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;</span><br><span class="line">      priorityOrderedPostProcessors.add(beanFactory.getBean(ppName, BeanFactoryPostProcessor.class));</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> <span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;</span><br><span class="line">      orderedPostProcessorNames.add(ppName);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line">      nonOrderedPostProcessorNames.add(ppName);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// First, invoke the BeanFactoryPostProcessors that implement PriorityOrdered.</span></span><br><span class="line">sortPostProcessors(priorityOrderedPostProcessors, beanFactory);</span><br><span class="line">invokeBeanFactoryPostProcessors(priorityOrderedPostProcessors, beanFactory);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Next, invoke the BeanFactoryPostProcessors that implement Ordered.</span></span><br><span class="line">List&lt;BeanFactoryPostProcessor&gt; orderedPostProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(orderedPostProcessorNames.size());</span><br><span class="line"><span class="keyword">for</span> (String postProcessorName : orderedPostProcessorNames) &#123;</span><br><span class="line">   orderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class));</span><br><span class="line">&#125;</span><br><span class="line">sortPostProcessors(orderedPostProcessors, beanFactory);</span><br><span class="line">invokeBeanFactoryPostProcessors(orderedPostProcessors, beanFactory);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Finally, invoke all other BeanFactoryPostProcessors.</span></span><br><span class="line">List&lt;BeanFactoryPostProcessor&gt; nonOrderedPostProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(nonOrderedPostProcessorNames.size());</span><br><span class="line"><span class="keyword">for</span> (String postProcessorName : nonOrderedPostProcessorNames) &#123;</span><br><span class="line">   nonOrderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ç„¶åæˆ‘ä»¬ç›´æ¥çœ‹åˆ°å¤„ç†nonOrderedPostProcessorsè¿™ä¸ªé›†åˆçš„æ–¹æ³•,</span></span><br><span class="line"><span class="comment">//å› ä¸ºè¿™ä¸ªæ–¹æ³•ä¹Ÿä¼šèµ°åˆ°æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„ç±»ä¸­å»</span></span><br><span class="line"><span class="comment">//æ–¹æ³•é‡Œé¢å¯¹nonOrderedPostProcessorsè¿›è¡Œè¿­ä»£,ç„¶åä¸€æ¬¡è°ƒç”¨å…¶postProcessBeanFactoryæ–¹æ³•,åŒæ—¶ä¹Ÿä¼ å…¥äº†beanFactoryåˆ°é‡Œé¢å».</span></span><br><span class="line">invokeBeanFactoryPostProcessors(nonOrderedPostProcessors, beanFactory);</span><br></pre></td></tr></table></figure><h4 id="BeanPostProcessor"><a href="#BeanPostProcessor" class="headerlink" title="BeanPostProcessor"></a>BeanPostProcessor</h4><p>æˆ‘ä»¬å…ˆå†™ä¸€ä¸ª Bean. ç„¶åå¯ä»¥é‡Œé¢å†™ä¸€ä¸ªå±æ€§,æ–¹ä¾¿æ ‡è¯†.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">YangBeanOne</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ— å‚æ„é€ å‡½æ•°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">YangBeanOne</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;YangBeanOneæ— å‚æ•°æ„é€ å‡½æ•°&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬è‡ªå®šä¹‰ä¸€ä¸ªBeanPostProcessor,å…¶å®ç°äº†BeanPostProcessoræ¥å£.</p><p>å¯ä»¥çœ‹åˆ°çš„æ˜¯,æˆ‘ä»¬åœ¨ifä¸­åšäº†beanNameçš„åˆ¤æ–­,å¦‚æœæ˜¯çš„è¯,é‚£ä¹ˆæˆ‘ä»¬å°±ä¼šå¼ºè½¬,ç„¶åç»™nameå­—æ®µèµ‹å€¼ä¸ŠGavinYangçš„å€¼.</p><p>æˆ‘ä»¬ç»™æ–­ç‚¹æ‰“åˆ° ifè¿™é‡Œï¼Œç„¶åçœ‹è¿›æ¥çš„å †æ ˆä¿¡æ¯,å‘ç°å…¶æ˜¯åœ¨åˆå§‹åŒ–beanä¸­,ç„¶åè°ƒç”¨beanPostProcessorçš„postProcessAfterInitializationçš„æ–¹æ³•æ‰ä¼šèµ°åˆ°è¿™é‡Œ,ä¹Ÿå°±æ˜¯åœ¨doCreateBeanè¿™ä¸ªæ–¹æ³•é‡Œé¢.</p><p>ç„¶åè¿™ä¸ª YangBeanPostProcessor æ˜¯ä»€ä¹ˆæ—¶å€™ç»™æ·»åŠ åˆ° beanFactoryä¸­å»çš„å‘¢ï¼Ÿ</p><p>org.springframework.context.support.PostProcessorRegistrationDelegate#registerBeanPostProcessors(org.springframework.beans.factory.config.ConfigurableListableBeanFactory, org.springframework.context.support.AbstractApplicationContext)åœ¨è¿™ä¸ªæ–¹æ³•æ‰“ä¸Šæ–­ç‚¹,ç„¶åä½ ä¼šå‘ç°å…¶getå‡ºæ¥çš„postProcessorNamesæ•°ç»„,å°±æœ‰æˆ‘ä»¬çš„è¿™ä¸ªYangBeanPostProcessorï¼Œç„¶åèµ°registerBeanPostProcessorsæ–¹æ³•çš„æ—¶å€™,å°±ä¼šç»™æ·»åŠ åˆ°beanFactoryä¸­å».</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">YangBeanPostProcessor</span> <span class="keyword">implements</span> <span class="title class_">BeanPostProcessor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&quot;yangBeanOne&quot;</span>.equalsIgnoreCase(beanName))&#123;</span><br><span class="line">            ((YangBeanOne) bean).setName(<span class="string">&quot;GavinYang&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯åŠ¨ç±» :</p><p>è¿™å°±æ‰“å°å‡ºæ¥çš„ç»“æœå°±å¯ä»¥çœ‹åˆ°çš„æ˜¯GavinYang,ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬åˆå§‹åŒ–è¿™ä¸ªbeanä¹‹å,ç„¶åç»™å…¶nameå±æ€§èµ‹å€¼ä¸Šäº†GavinYangè¿™ä¸ªå€¼.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringStartMain</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">AnnotationConfigApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(<span class="string">&quot;com.iyang.spring&quot;</span>);</span><br><span class="line">        <span class="type">YangBeanOne</span> <span class="variable">yangBeanOne</span> <span class="operator">=</span> context.getBean(YangBeanOne.class);</span><br><span class="line">        System.out.println(yangBeanOne.getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Lifecycle-æ‰©å±•"><a href="#Lifecycle-æ‰©å±•" class="headerlink" title="Lifecycle æ‰©å±•"></a>Lifecycle æ‰©å±•</h4><p>Lifecycle æ‰©å±•è¦æ¯”èµ· BeanPostProcessorè¦å¥½ç†è§£å¾—å¤š,å› ä¸ºä½ åªç”¨å»å®ç°è¿™ä¸ªæ¥å£(SmartLifecycle),ç„¶ååœ¨org.springframework.context.support.AbstractApplicationContext#finishRefreshåˆ°è¿™ä¸ªæ–¹æ³•çš„æ—¶å€™,å°±ä¼šå»è°ƒç”¨å®ç°è¿™ä¸ªæ¥å£çš„å¯¹ç”¨çš„æ–¹æ³•.</p><p>è¿™é‡Œæˆ‘ä»¬è‡ªå·±å†™ä¸€ä¸ªç±»,ç„¶åå®ç° SmartLifecycle æ¥å£å³å¯ã€‚</p><p>å¯ä»¥çœ‹åˆ°ä¸‹é¢çš„æ‰“å°å‚æ•°.è¿˜æ˜¯å¾ˆæ¸…æ¥šçš„æ˜ç™½.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GavinYangLifeImpl</span> <span class="keyword">implements</span> <span class="title class_">SmartLifecycle</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getPhase</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Integer.MAX_VALUE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;è°ƒç”¨åˆ°äº†GavinYangLifeImpl.start()æ–¹æ³•&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">stop</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isRunning</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//YangBeanOneæ— å‚æ•°æ„é€ å‡½æ•°</span></span><br><span class="line"><span class="comment">//è°ƒç”¨åˆ°äº†GavinYangLifeImpl.start()æ–¹æ³•</span></span><br><span class="line"><span class="comment">//GavinYang</span></span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬å†çœ‹ä¸‹æºç ,ä¸ºä»€ä¹ˆè¦å®ç° SmartLifecycle è¿™ä¸ªæ¥å£å‘¢ï¼Ÿ</p><p>org.springframework.context.support.DefaultLifecycleProcessor</p><p>è¿™é‡Œæˆ‘ä»¬å…ˆçœ‹åˆ° phases ,ä¹Ÿå°±æ˜¯æœ€åº•ä¸‹çš„ä»£ç , è¿™ä¸ªé›†åˆæ˜¯æœ‰å€¼çš„æƒ…å†µä¸‹å…ˆæ’åº,ç„¶åå†è¿­ä»£,ç„¶åè°ƒç”¨åˆ° start()æ–¹æ³•, è¿™ä¸ªstartæ–¹æ³•æ˜¯ä¸æ˜¯åœ¨æˆ‘ä»¬çš„å®ç°ç±»ä¸­å¯ä»¥çœ‹åˆ°,æ˜¯ä¸æ˜¯éå¸¸çš„ç†Ÿæ‚‰æ„Ÿè§‰.</p><p>ç„¶åæˆ‘ä»¬åœ¨çœ‹ä¸‹,æ€ä¹ˆæ ·è®©è¿™ä¸ªé›†åˆèƒ½æœ‰å€¼å‘¢ï¼Ÿ</p><p>phases.put(phase, group); å¯ä»¥çœ‹åˆ° putæ–¹æ³•è¿™é‡Œ, autoStartupOnly æ˜¯false æˆ–è€…beanæ˜¯SmartLifecycleçš„å­ç±»,å¹¶ä¸”å…¶isAutoStartupæ–¹æ³•çš„æ˜¯true. ç‚¹åˆ°SmartLifecycleæºç ä¸­å»çœ‹,å¯ä»¥å‘ç°è¿™ä¸ªæ–¹æ³•é»˜è®¤æ˜¯è¿”å›çš„true.</p><p>æ¥ç€åœ¨è°ƒç”¨getPhaseæ–¹æ³•, è¯¥æ–¹æ³•ä¹Ÿå°±æ˜¯åˆ¤æ–­.æœ€æœ€å…³é”®çš„phasesé›†åˆæ¥äº†,å…ˆä»é‡Œé¢getå‡ºæ•°æ®,ç„¶ååˆ¤æ–­æ•°æ®æ˜¯ä¸æ˜¯null,å¦‚æœæ˜¯nullçš„è¯,å°±å…ˆnewä¸€ä¸ªGroupå‡ºæ¥,ç„¶åè°ƒç”¨phasesçš„putæ–¹æ³•,ä¹Ÿå°±æ˜¯æ”¾å…¥åˆ°è¿™ä¸ªé›†åˆä¸­å»äº†</p><p>æ‰€ä»¥è¿™é‡Œå°±æ˜¯æˆ‘ä»¬ä¸ºä»€ä¹ˆè¦å®ç° SmartLifecycle è¿™ä¸ªæ¥å£,å°±ä¼šæœ‰å¯åŠ¨çš„æ•ˆæœäº†çš„åŸå› .</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Internal helpers</span></span><br><span class="line"><span class="comment">// ä¼ å…¥è¿›æ¥çš„  autoStartupOnly å‚æ•°æ˜¯true.</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">startBeans</span><span class="params">(<span class="type">boolean</span> autoStartupOnly)</span> &#123;</span><br><span class="line">   Map&lt;String, Lifecycle&gt; lifecycleBeans = getLifecycleBeans();</span><br><span class="line">   Map&lt;Integer, LifecycleGroup&gt; phases = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">   lifecycleBeans.forEach((beanName, bean) -&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (!autoStartupOnly || (bean <span class="keyword">instanceof</span> SmartLifecycle &amp;&amp; ((SmartLifecycle) bean).isAutoStartup())) &#123;</span><br><span class="line">         <span class="type">int</span> <span class="variable">phase</span> <span class="operator">=</span> getPhase(bean);</span><br><span class="line">         <span class="type">LifecycleGroup</span> <span class="variable">group</span> <span class="operator">=</span> phases.get(phase);</span><br><span class="line">         <span class="keyword">if</span> (group == <span class="literal">null</span>) &#123;</span><br><span class="line">            group = <span class="keyword">new</span> <span class="title class_">LifecycleGroup</span>(phase, <span class="built_in">this</span>.timeoutPerShutdownPhase, lifecycleBeans, autoStartupOnly);</span><br><span class="line">            phases.put(phase, group);</span><br><span class="line">         &#125;</span><br><span class="line">         group.add(beanName, bean);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;);</span><br><span class="line">   <span class="keyword">if</span> (!phases.isEmpty()) &#123;</span><br><span class="line">      List&lt;Integer&gt; keys = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(phases.keySet());</span><br><span class="line">      Collections.sort(keys);</span><br><span class="line">      <span class="keyword">for</span> (Integer key : keys) &#123;</span><br><span class="line">         phases.get(key).start();</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬åŸºäºæ¥å£æ‰©å±•çš„,è¿˜æ˜¯å¾ˆå¥½ç†è§£çš„ã€‚ è·Ÿç€æºç ä¸­çš„åˆå§‹åŒ–ä¸€äº›ç±»,çœ‹å“ªä¸ªç±»æ˜¯æ€ä¹ˆå†™çš„ï¼Œç„¶åæˆ‘ä»¬è·Ÿç€å†™ä¸€ä¸ªã€‚ å‰ææ˜¯,ä½ è¦å¼„å¾—æ˜ç™½ Spring è¿™ä¸ªæ‰§è¡Œè¿‡ç¨‹çš„. ä¸ç„¶ä½ è·Ÿç€å†™,ä¸æ˜¯å¾ˆæ˜ç™½çš„è¯,å°±å¯èƒ½ä¸æ˜¯å¾ˆå®¹æ˜“çœ‹æ˜ç™½æˆ–è€…çœ‹æ‡‚ä½ è¿™ä¸ªæ•ˆæœçš„.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;é¢˜è®°&quot;&gt;&lt;a href=&quot;#é¢˜è®°&quot; class=&quot;headerlink&quot; title=&quot;é¢˜è®°&quot;&gt;&lt;/a&gt;é¢˜è®°&lt;/h4&gt;&lt;p&gt; å‰é¢è®²åˆ°äº†è¿™ä¹ˆå¤šçš„ä»€ä¹ˆBeanPostProcessor,äº‹ä»¶ä»€ä¹ˆçš„. å¦‚æœä¸å†™å‡ ä¸‹ä»£ç è¿™é‡Œæ€•æ˜¯å¾ˆéš¾å¼„æ¸…æ¥šæ˜¯ä¸ªæ€ä¹ˆå›äº‹. æ‰€ä»¥åªæœ‰çœ‹åˆ°ä»£ç </summary>
      
    
    
    
    <category term="java" scheme="https://ruy9527.github.io/categories/java/"/>
    
    <category term="spring" scheme="https://ruy9527.github.io/categories/java/spring/"/>
    
    
    <category term="java" scheme="https://ruy9527.github.io/tags/java/"/>
    
    <category term="spring" scheme="https://ruy9527.github.io/tags/spring/"/>
    
  </entry>
  
  <entry>
    <title>springåˆå§‹åŒ–(äºŒ)</title>
    <link href="https://ruy9527.github.io/2021/11/04/spring/spring%E5%88%9D%E5%A7%8B%E5%8C%96-%E4%BA%8C/"/>
    <id>https://ruy9527.github.io/2021/11/04/spring/spring%E5%88%9D%E5%A7%8B%E5%8C%96-%E4%BA%8C/</id>
    <published>2021-11-03T16:16:29.000Z</published>
    <updated>2022-11-04T13:46:13.920Z</updated>
    
    <content type="html"><![CDATA[<h4 id="é¢˜è®°"><a href="#é¢˜è®°" class="headerlink" title="é¢˜è®°"></a>é¢˜è®°</h4><p> æ˜¨å¤©è®°å½•äº†this()å’Œ register() è¿™äºŒä¸ªæ–¹æ³•, è¿™äºŒä¸ªæ–¹æ³•éƒ½æ˜¯ä¸ºåé¢çš„åšé“ºå«,ä¹Ÿå°±æ˜¯æå‰åˆå§‹åŒ–äº†ä¸€äº›ç¯å¢ƒå’Œè¯»å–classæ–‡ä»¶. refresh() è¿™ä¸ªæ–¹æ³•æ‰æ˜¯æœ€é‡è¦çš„,å…¶ä¸­åŒ…å«çš„å†…å®¹æ˜¯éå¸¸å¤šçš„. æ‰€ä»¥è¿™é‡Œæ…¢æ…¢è¿›è¡Œæ›´æ–°å…¶æ–¹æ³•çš„å†…å®¹.</p><h4 id="refresh-æ–¹æ³•"><a href="#refresh-æ–¹æ³•" class="headerlink" title="refresh æ–¹æ³•"></a>refresh æ–¹æ³•</h4><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°çš„æ˜¯, refresh()è¯¥æ–¹æ³•é‡Œé¢,åŸºæœ¬éƒ½æ˜¯èµ°äº†å¾ˆå¤šæ–¹æ³•çš„. æ‰€ä»¥æŒ¨ä¸ªçœ‹æ–¹æ³•,æœ‰äº›æ–¹æ³•æ˜¯ç•™ç»™å­ç±»çš„,ä¹Ÿå°±æ˜¯è¿›è¡Œæ‰©å±•çš„. ä»synchronizedè¿™ä¸ªå…³é”®å­—æ¥çœ‹,è¿™é‡Œåªå®¹è®¸ä¸€æ¬¡åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ¥æ‰§è¡Œè¿™ä¸ªæ–¹æ³•.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException &#123;</span><br><span class="line">   <span class="keyword">synchronized</span> (<span class="built_in">this</span>.startupShutdownMonitor) &#123;</span><br><span class="line">      <span class="comment">// Prepare this context for refreshing.</span></span><br><span class="line">      prepareRefresh();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Tell the subclass to refresh the internal bean factory.</span></span><br><span class="line"></span><br><span class="line">      <span class="type">ConfigurableListableBeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> obtainFreshBeanFactory();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Prepare the bean factory for use in this context.</span></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * org.springframework.beans.factory.support.DefaultListableBeanFactory</span></span><br><span class="line"><span class="comment">       *</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      prepareBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="comment">// Allows post-processing of the bean factory in context subclasses.</span></span><br><span class="line">         postProcessBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Invoke factory processors registered as beans in the context.</span></span><br><span class="line">         invokeBeanFactoryPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Register bean processors that intercept bean creation.</span></span><br><span class="line">         registerBeanPostProcessors(beanFactory);</span><br><span class="line">         <span class="comment">// Initialize message source for this context.</span></span><br><span class="line">         initMessageSource();</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Initialize event multicaster for this context.</span></span><br><span class="line">         initApplicationEventMulticaster();</span><br><span class="line">         <span class="comment">// Initialize other special beans in specific context subclasses.</span></span><br><span class="line">         onRefresh();</span><br><span class="line">         <span class="comment">// Check for listener beans and register them.</span></span><br><span class="line">         registerListeners();</span><br><span class="line">         <span class="comment">// Instantiate all remaining (non-lazy-init) singletons.</span></span><br><span class="line">         <span class="comment">/**</span></span><br><span class="line"><span class="comment">          */</span></span><br><span class="line">         finishBeanFactoryInitialization(beanFactory);</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Last step: publish corresponding event.</span></span><br><span class="line">         finishRefresh();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">         <span class="keyword">if</span> (logger.isWarnEnabled()) &#123;</span><br><span class="line">            logger.warn(<span class="string">&quot;Exception encountered during context initialization - &quot;</span> +</span><br><span class="line">                  <span class="string">&quot;cancelling refresh attempt: &quot;</span> + ex);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="comment">// Destroy already created singletons to avoid dangling resources.</span></span><br><span class="line">         destroyBeans();</span><br><span class="line">         <span class="comment">// Reset &#x27;active&#x27; flag.</span></span><br><span class="line">         cancelRefresh(ex);</span><br><span class="line">         <span class="comment">// Propagate exception to caller.</span></span><br><span class="line">         <span class="keyword">throw</span> ex;</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">         <span class="comment">// Reset common introspection caches in Spring&#x27;s core, since we</span></span><br><span class="line">         <span class="comment">// might not ever need metadata for singleton beans anymore...</span></span><br><span class="line">         resetCommonCaches();</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="refresh-prepareRefresh-æ–¹æ³•"><a href="#refresh-prepareRefresh-æ–¹æ³•" class="headerlink" title="refresh.prepareRefresh() æ–¹æ³•"></a>refresh.prepareRefresh() æ–¹æ³•</h4><p>prepareRefresh() æ–¹æ³•: å¯ä»¥çœ‹åˆ°è¯¥æ–¹æ³•å…ˆæ˜¯å¯¹closed&#x2F;activeå‚æ•°è¿›è¡Œè®¾ç½®,ç„¶åå¯¹Enviornmentè¿›è¡Œè°ƒç”¨æ£€éªŒæ–¹æ³•,æ¥ç€åˆ¤æ–­this.earlyApplicationListenersæ˜¯å¦æœ‰å€¼æ¥æ“ä½œthis.applicationListeners. æœ€ååˆå§‹åŒ–earlyApplicationEventsè¿™ä¸ªé›†åˆ. è¿™é‡Œå¤§æ¦‚è¿˜æ˜¯è¿›è¡Œä¸€äº›åˆå§‹åŒ–æ“ä½œ.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Prepare this context for refreshing, setting its startup date and</span></span><br><span class="line"><span class="comment"> * active flag as well as performing any initialization of property sources.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">prepareRefresh</span><span class="params">()</span> &#123;</span><br><span class="line">   <span class="comment">// Switch to active.</span></span><br><span class="line">   <span class="built_in">this</span>.startupDate = System.currentTimeMillis();</span><br><span class="line">  <span class="comment">// closedè®¾ç½®ä¸ºfalse,activeè®¾ç½®ä¸ºtrue.  </span></span><br><span class="line">   <span class="built_in">this</span>.closed.set(<span class="literal">false</span>);</span><br><span class="line">   <span class="built_in">this</span>.active.set(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// æ ¹æ®logçº§åˆ«æ¥è¿›è¡Œè¾“å‡º </span></span><br><span class="line">   <span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class="line">      logger.info(<span class="string">&quot;Refreshing &quot;</span> + <span class="built_in">this</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Initialize any placeholder property sources in the context environment.</span></span><br><span class="line">   <span class="comment">// ç›®å‰è¯¥æ–¹æ³•æ²¡æœ‰è°ƒç”¨;ç›®å‰æ²¡æœ‰åšä»»ä½•äº‹æƒ…. ç›®æµ‹æ˜¯åº”è¯¥ç•™ç»™å­ç±»ä¹‹ç±»çš„è¿›è¡Œæ‰©å±•çš„.</span></span><br><span class="line">   initPropertySources();</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Validate that all properties marked as required are resolvable:</span></span><br><span class="line">   <span class="comment">// see ConfigurablePropertyResolver#setRequiredProperties</span></span><br><span class="line"><span class="comment">//å…ˆè°ƒç”¨getEnvironment()è·å–this()æ–¹æ³•ä¸­åˆ›å»ºå‡ºæ¥çš„Environmentæ¥,ç„¶åèµ°validateRequiredPropertiesæ–¹æ³•æ¥è¿›è¡Œä¸€äº›æ£€éªŒ,</span></span><br><span class="line"><span class="comment">//org.springframework.core.env.AbstractPropertyResolver#validateRequiredProperties</span></span><br><span class="line"><span class="comment">//æœ€åæ˜¯èµ°åˆ°äº†è¿™ä¸ªæ–¹æ³•,å¦‚æœthis.requiredPropertiesä¸­æ˜¯æœ‰å€¼çš„è¯,é‚£ä¹ˆè¿™é‡Œå°±ä¼šæŠ›å‡ºä¸€ä¸ªå¼‚å¸¸æ¥    </span></span><br><span class="line">   getEnvironment().validateRequiredProperties();</span><br><span class="line">    </span><br><span class="line">   <span class="comment">// Store pre-refresh ApplicationListeners...</span></span><br><span class="line"><span class="comment">// è¿™é‡Œæ˜¯å¯¹ earlyApplicationListeners è¿›è¡Œåˆ¤æ–­,å¦‚æœæœ‰å€¼çš„è¯,å°±å…ˆä¼šclearæ‰,ç„¶åå†addAll</span></span><br><span class="line"><span class="comment">//å¦‚æœæ˜¯æ²¡æœ‰å€¼çš„è¯,å°±ä¼šnewä¸€ä¸ªé›†åˆ,ç„¶åèµ‹å€¼ç»™this.earlyApplicationListenerså‚æ•°   </span></span><br><span class="line">   <span class="keyword">if</span> (<span class="built_in">this</span>.earlyApplicationListeners == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="built_in">this</span>.earlyApplicationListeners = <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>&lt;&gt;(<span class="built_in">this</span>.applicationListeners);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// Reset local application listeners to pre-refresh state.</span></span><br><span class="line">      <span class="built_in">this</span>.applicationListeners.clear();</span><br><span class="line">      <span class="built_in">this</span>.applicationListeners.addAll(<span class="built_in">this</span>.earlyApplicationListeners);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Allow for the collection of early ApplicationEvents,</span></span><br><span class="line">   <span class="comment">// to be published once the multicaster is available...</span></span><br><span class="line"><span class="comment">// æœ€ååˆå§‹åŒ–ä¸€ä¸‹ this.earlyApplicationEvents è¿™ä¸ªå‚æ•°</span></span><br><span class="line">   <span class="built_in">this</span>.earlyApplicationEvents = <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>&lt;&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="refresh-obtainFreshBeanFactory-æ–¹æ³•"><a href="#refresh-obtainFreshBeanFactory-æ–¹æ³•" class="headerlink" title="refresh.obtainFreshBeanFactory()æ–¹æ³•"></a>refresh.obtainFreshBeanFactory()æ–¹æ³•</h4><p>è¿™ä¸ªæ–¹æ³•æ˜¯æœ‰æ–¹æ³•ä¸€ä¸ªBeanFactoryå›å»çš„.</p><p>è¯¥æ–¹æ³•å¯¹beanFactoryè¿›è¡ŒSerializationId,ç„¶åè·å–BeanFactory,æœ€åè¿”å›è¿™ä¸ªBeanFactory.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Tell the subclass to refresh the internal bean factory.</span></span><br><span class="line"><span class="comment"> *  å‘Šè¯‰å­ç±»åˆ·æ–°å†…éƒ¨Beanå·¥å‚</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the fresh BeanFactory instance</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #refreshBeanFactory()</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #getBeanFactory()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> ConfigurableListableBeanFactory <span class="title function_">obtainFreshBeanFactory</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="comment">//this.refreshed.compareAndSet(false, true)è¯¥æ–¹æ³•å¦‚æœè¿”å›çš„æ˜¯falseçš„è¯,å°±ä¼šæœ‰å¼‚å¸¸ç»™æŠ›å‡ºæ¥</span></span><br><span class="line"><span class="comment">//ä¸æ˜¯falseçš„è¯,æ¥ç€å°±æ˜¯å¯¹beanFactoryè®¾ç½®SerializationId    </span></span><br><span class="line">   refreshBeanFactory();</span><br><span class="line"><span class="comment">// org.springframework.context.support.GenericApplicationContext#getBeanFactory</span></span><br><span class="line"><span class="comment">//è¯¥æ–¹æ³•ç›´æ¥è¿”å›DefaultListableBeanFactory    </span></span><br><span class="line">   <span class="type">ConfigurableListableBeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> getBeanFactory();</span><br><span class="line">   <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">      logger.debug(<span class="string">&quot;Bean factory for &quot;</span> + getDisplayName() + <span class="string">&quot;: &quot;</span> + beanFactory);</span><br><span class="line">   &#125;</span><br><span class="line"><span class="comment">//è¿”å›è·å–çš„beanFactory.    </span></span><br><span class="line">   <span class="keyword">return</span> beanFactory;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="refresh-prepareBeanFactory-æ–¹æ³•"><a href="#refresh-prepareBeanFactory-æ–¹æ³•" class="headerlink" title="refresh.prepareBeanFactory() æ–¹æ³•"></a>refresh.prepareBeanFactory() æ–¹æ³•</h4><p>ä»è¿™ä¸ªæ–¹æ³•æ¥çœ‹,æ˜¯å¯¹BeanFactoryçš„å‡†å¤‡.</p><p>è¯¥æ–¹æ³•å¯ä»¥å…ˆæ˜¯å¯¹classLoader,expressionResolver,propertyEditorRegistraræ·»åŠ åˆ°beanFactoryä¸­å». ç„¶åæ·»åŠ ApplicationContextAwareProcessor(BeanPostProcessor)åˆ°BeanFactory,ç„¶åå¿½ç•¥åˆ°ä¸€äº›æ¥å£çš„æ³¨å…¥åˆ°beanFactoryä¸­å».</p><p>è®¾ç½® BeanFactory , ResourceLoader , ApplicationEventPublisher, ApplicationContextç­‰beanåˆ°BeanFactoryä¸­å».</p><p>æœ€åå°±æ˜¯ä¸€äº›environment,systemProperties,systemEnvironmentç­‰æ³¨å…¥åˆ°BeanFactoryä¸­å».</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Configure the factory&#x27;s standard context characteristics,</span></span><br><span class="line"><span class="comment"> * such as the context&#x27;s ClassLoader and post-processors.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> beanFactory the BeanFactory to configure</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">prepareBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> &#123;</span><br><span class="line">   <span class="comment">// Tell the internal bean factory to use the context&#x27;s class loader etc.</span></span><br><span class="line"><span class="comment">//ç»™beanFactoryè®¾ç½®classLoader(åŠ è½½bean) </span></span><br><span class="line">   beanFactory.setBeanClassLoader(getClassLoader());</span><br><span class="line"><span class="comment">//è¿™é‡Œæ ¹æ®classLoaderæ¥è·å–è§£æå™¨,ç„¶åsetåˆ°BeanFactoryä¸­å».(è§£æbeanå®šä¹‰çš„è¡¨è¾¾å¼)</span></span><br><span class="line">   beanFactory.setBeanExpressionResolver(<span class="keyword">new</span> <span class="title class_">StandardBeanExpressionResolver</span>(beanFactory.getBeanClassLoader()));</span><br><span class="line"><span class="comment">//å±æ€§ç¼–è¾‘æ³¨å†Œå™¨,setåˆ°BeanFactoryä¸­</span></span><br><span class="line">   beanFactory.addPropertyEditorRegistrar(<span class="keyword">new</span> <span class="title class_">ResourceEditorRegistrar</span>(<span class="built_in">this</span>, getEnvironment()));</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Configure the bean factory with context callbacks.</span></span><br><span class="line"><span class="comment">//æ·»åŠ ApplicationContextAwareProcessoråˆ°BeanFactoryä¸­.è¯¥ç±»æ˜¯æœ‰å®ç°BeanPostProcessorçš„</span></span><br><span class="line"><span class="comment">//BeanPostProcessoræ˜¯åœ¨beanåˆå§‹åŒ–å®Œå,è°ƒç”¨BeanPostProcessorè¿›è¡Œæ‰©å±•.</span></span><br><span class="line">   beanFactory.addBeanPostProcessor(<span class="keyword">new</span> <span class="title class_">ApplicationContextAwareProcessor</span>(<span class="built_in">this</span>));</span><br><span class="line"><span class="comment">//å¿½ç•¥æ‰EnvironmentAware/EmbeddedValueResolverAware....ApplicationContextAware</span></span><br><span class="line"><span class="comment">//è¿™å…­ä¸ªæ¥å£çš„æ³¨å…¥(ä¾èµ–). å› ä¸ºApplicationContextAwareProcessorä¸­æœ‰åšäº†è¿™äº›äº‹</span></span><br><span class="line">   beanFactory.ignoreDependencyInterface(EnvironmentAware.class);</span><br><span class="line">   beanFactory.ignoreDependencyInterface(EmbeddedValueResolverAware.class);</span><br><span class="line">   beanFactory.ignoreDependencyInterface(ResourceLoaderAware.class);</span><br><span class="line">   beanFactory.ignoreDependencyInterface(ApplicationEventPublisherAware.class);</span><br><span class="line">   beanFactory.ignoreDependencyInterface(MessageSourceAware.class);</span><br><span class="line">   beanFactory.ignoreDependencyInterface(ApplicationContextAware.class);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// BeanFactory interface not registered as resolvable type in a plain factory.</span></span><br><span class="line">   <span class="comment">// MessageSource registered (and found for autowiring) as a bean.</span></span><br><span class="line"><span class="comment">// BeanFactory,ResourceLoader,ApplicationEventPublisher,ApplicationContextè¿™å››ä¸ªæ¥å£</span></span><br><span class="line"><span class="comment">//å¯¹åº”çš„beanéƒ½setåˆ°beanFactoryä¸­å».    </span></span><br><span class="line">   beanFactory.registerResolvableDependency(BeanFactory.class, beanFactory);</span><br><span class="line">   beanFactory.registerResolvableDependency(ResourceLoader.class, <span class="built_in">this</span>);</span><br><span class="line">   beanFactory.registerResolvableDependency(ApplicationEventPublisher.class, <span class="built_in">this</span>);</span><br><span class="line">   beanFactory.registerResolvableDependency(ApplicationContext.class, <span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Register early post-processor for detecting inner beans as ApplicationListeners.</span></span><br><span class="line"><span class="comment">//æ·»åŠ ApplicationListenerDetector(BeanPostProcessor)åˆ°beanFactoryä¸­å».</span></span><br><span class="line">   beanFactory.addBeanPostProcessor(<span class="keyword">new</span> <span class="title class_">ApplicationListenerDetector</span>(<span class="built_in">this</span>));</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Detect a LoadTimeWeaver and prepare for weaving, if found.</span></span><br><span class="line">   <span class="keyword">if</span> (beanFactory.containsBean(LOAD_TIME_WEAVER_BEAN_NAME)) &#123;</span><br><span class="line">      beanFactory.addBeanPostProcessor(<span class="keyword">new</span> <span class="title class_">LoadTimeWeaverAwareProcessor</span>(beanFactory));</span><br><span class="line">      <span class="comment">// Set a temporary ClassLoader for type matching.</span></span><br><span class="line">      beanFactory.setTempClassLoader(<span class="keyword">new</span> <span class="title class_">ContextTypeMatchClassLoader</span>(beanFactory.getBeanClassLoader()));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Register default environment beans.</span></span><br><span class="line"><span class="comment">//å¦‚æœbeanFactoryä¸­æ²¡æœ‰ENVIRONMENT_BEAN_NAMEè¿™ä¸ªbeançš„è¯,å°±æ³¨å…¥ä¸€ä¸ªè¿›å»</span></span><br><span class="line">   <span class="keyword">if</span> (!beanFactory.containsLocalBean(ENVIRONMENT_BEAN_NAME)) &#123;</span><br><span class="line">      beanFactory.registerSingleton(ENVIRONMENT_BEAN_NAME, getEnvironment());</span><br><span class="line">   &#125;</span><br><span class="line"><span class="comment">// SYSTEM_PROPERTIES_BEAN_NAMEä¹Ÿæ˜¯ä¸€æ ·,æ³¨å…¥åˆ°beanFactoryä¸­å»</span></span><br><span class="line">   <span class="keyword">if</span> (!beanFactory.containsLocalBean(SYSTEM_PROPERTIES_BEAN_NAME)) &#123;</span><br><span class="line">      beanFactory.registerSingleton(SYSTEM_PROPERTIES_BEAN_NAME, getEnvironment().getSystemProperties());</span><br><span class="line">   &#125;</span><br><span class="line"><span class="comment">//SYSTEM_ENVIRONMENT_BEAN_NAMEåŒä¸Š    </span></span><br><span class="line">   <span class="keyword">if</span> (!beanFactory.containsLocalBean(SYSTEM_ENVIRONMENT_BEAN_NAME)) &#123;</span><br><span class="line">      beanFactory.registerSingleton(SYSTEM_ENVIRONMENT_BEAN_NAME, getEnvironment().getSystemEnvironment());</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="refresh-postProcessBeanFactory-æ–¹æ³•"><a href="#refresh-postProcessBeanFactory-æ–¹æ³•" class="headerlink" title="refresh.postProcessBeanFactory() æ–¹æ³•"></a>refresh.postProcessBeanFactory() æ–¹æ³•</h4><p>è¯¥æ–¹æ³•ç›®å‰åœ¨å•ä¸ª Springä¸­æ˜¯æ²¡æœ‰åšä»»ä½•äº‹æƒ…çš„ã€‚ ç­‰åˆ°çœ‹SpringBootæºç çš„æ—¶å€™,è¿™é‡Œå°±ä¼šæœ‰ä»£ç èµ°è¿›æ¥,æ˜¯è¿›è¡Œæ ¹æ®åŒ…æ¥æ‰«ææ¥è·å–classç­‰ä¿¡æ¯çš„. æ»¡è¶³æ¡ä»¶çš„class,å°±ä¼šå½“ä¸ºbdç»™æ³¨å†Œåˆ°beanFactoryä¸­å».</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Modify the application context&#x27;s internal bean factory after its standard</span></span><br><span class="line"><span class="comment"> * initialization. All bean definitions will have been loaded, but no beans</span></span><br><span class="line"><span class="comment"> * will have been instantiated yet. This allows for registering special</span></span><br><span class="line"><span class="comment"> * BeanPostProcessors etc in certain ApplicationContext implementations.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> beanFactory the bean factory used by the application context</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="refresh-invokeBeanFactoryPostProcessors-æ–¹æ³•"><a href="#refresh-invokeBeanFactoryPostProcessors-æ–¹æ³•" class="headerlink" title="refresh.invokeBeanFactoryPostProcessors() æ–¹æ³•"></a>refresh.invokeBeanFactoryPostProcessors() æ–¹æ³•</h4><p>å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ–¹æ³•,å€ŸåŠ©PostProcessorRegistrationDelegateæ¥å¯¹PostProcessorè¿›è¡Œå¤„ç†ã€‚</p><p>å…ˆæ˜¯å¯¹BeanDefinitionRegistryPostProcessorè¿›è¡Œä»beanFactoryä¸­è·å–å‡ºç›¸åº”çš„åå­—æ•°ç»„,ç„¶åè¿­ä»£è¿™ä¸ªæ•°ç»„,ç„¶åå¤„ç†PriorityOrderedâ€”&gt;Orderedâ€”&gt; æ²¡æœ‰,è¿™ä¸ªé¡ºåº,æœ€åè¿˜æœ‰ä¸€ä¸ªwhileå¾ªç¯è¿­ä»£æ¥æ£€æŸ¥BeanDefinitionRegistryPostProcessoræ˜¯å¦éƒ½å¤„ç†å®Œäº†.</p><p>å†æ¥ç€å°±æ˜¯å¤„ç†BeanFactoryPostProcessor,å¤„ç†æ–¹å¼æ˜¯å’ŒBeanDefinitionRegistryPostProcessorä¸€æ ·çš„,é¡ºåºä¹Ÿæ˜¯ä¸€æ ·çš„.</p><p>æœ€åå°±æ˜¯è°ƒç”¨beanFactory.clearMetadataCache()æ¸…é™¤.</p><p>å½“ç„¶,è¿™ä¸ªé‡Œé¢æœ‰äº›ä¸Šé¢ PostProcessorç­‰å¾…é˜…è¯»SpringBootçš„æ—¶å€™ç»™è¡¥ä¸Šæ¥,å› ä¸ºåˆ°æ—¶å€™SpringBootè¿™é‡Œä¼šæœ‰å¾ˆå¤šPostProcessor,è¿™é‡Œç›®å‰æ˜¯æ²¡æœ‰çš„.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Instantiate and invoke all registered BeanFactoryPostProcessor beans,</span></span><br><span class="line"><span class="comment"> * respecting explicit order if given.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;Must be called before singleton instantiation.</span></span><br><span class="line"><span class="comment">BeanFactoryPostProcessor: ç”¨æ¥ä¿®æ”¹Springå®¹å™¨ä¸­å·²ç»å­˜åœ¨çš„beanå®šä¹‰.</span></span><br><span class="line"><span class="comment">BeanDefinitionRegistryPostProcessor: æ˜¯BeanFactoryPostProcessorçš„å­ç±»,ä½œç”¨å’Œçˆ¶ç±»æ˜¯ä¸€æ ·çš„,ä¸åŒçš„æ˜¯,è¯¥ä½¿ç”¨çš„æ˜¯BeanDefinitionRegistryå¯¹beanè¿›è¡Œå¤„ç†</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">invokeBeanFactoryPostProcessors</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> &#123;</span><br><span class="line"><span class="comment">//org.springframework.context.support.AbstractApplicationContext#getBeanFactoryPostProcessors,ç”±äºè¿™é‡Œåªæ˜¯å¯åŠ¨äº†å•ä¸ªSpring,è¿”å›çš„é›†åˆæ˜¯æ²¡æœ‰å€¼çš„.</span></span><br><span class="line">   List&lt;BeanFactoryPostProcessor&gt; postProcessorsList = getBeanFactoryPostProcessors();</span><br><span class="line">   <span class="comment">//System.out.println(&quot;postProcessorsList value ---&gt; &quot; + postProcessorsList);</span></span><br><span class="line">   <span class="comment">// System.out.println(&quot;beanFactory  value 111111 ---&gt; &quot; + beanFactory);</span></span><br><span class="line"><span class="comment">//å€ŸåŠ©PostProcessorRegistrationDelegateæ¥å¤„ç†PostProcessors.</span></span><br><span class="line"><span class="comment">//å¯¹ä¼ å…¥postProcessorsListè¿›è¡Œè¿­ä»£,å¦‚æœPostProcessoræ˜¯BeanDefinitionRegistryPostProcessorçš„è¯,å°±ä¼šå¼ºè½¬ç„¶åè°ƒç”¨postProcessBeanDefinitionRegistryæ–¹æ³•(ä¼ å…¥å‚æ•°æ˜¯beanFacotry),æ·»åŠ åˆ°registryProcessorsé›†åˆä¸­.å¦‚æœä¸æ˜¯çš„è¯,å°±ä¼šæ·»åŠ åˆ°regularPostProcessorsé›†åˆä¸­.</span></span><br><span class="line"><span class="comment">//æ ¹æ®BeanDefinitionRegistryPostProcessor,ä»beanFactoryä¸­è·å–postProcessorNames,</span></span><br><span class="line"><span class="comment">//è¿›è¡Œè¿­ä»£,å¦‚æœæ˜¯æœ‰PriorityOrderedæ¥å£çš„å­ç±»çš„è¯,å°±ä¼šä»beanFactoryä¸­æ ¹æ®beanåå­—,ç±».classæ¥è·å–BeanDefinitionRegistryPostProcessor,å¹¶ä¸”æ·»åŠ åˆ°currentRegistryProcessorsé›†åˆä¸­,ppName(åå­—çš„å€¼)ä¹Ÿä¼šæ·»åŠ åˆ°processedBeansè¯¥é›†åˆä¸­</span></span><br><span class="line"><span class="comment">//å¯¹currentRegistryProcessorsè¿›è¡Œæ’åº,å…¨éƒ¨æ·»åŠ åˆ°registryProcessorsé›†åˆä¸­,invokeBeanDefinitionRegistryPostProcessors()è¯¥æ–¹æ³•æ˜¯è°ƒç”¨BeanDefinitionRegistryPostProcessorsçš„,è°ƒç”¨å®Œäº†ç„¶åæ¸…ç©ºcurrentRegistryProcessorsè¿™ä¸ªé›†åˆ.</span></span><br><span class="line"><span class="comment">//åŒæ ·æ–¹æ³•è·å–postProcessorNames,processedBeansé›†åˆä¸­ä¸åŒ…å«å¹¶ä¸”æ˜¯Orderedçš„å­ç±»,ç„¶åæ·»åŠ åˆ°currentRegistryProcessorsé›†åˆä¸­,ppNameä¹Ÿä¼šæ·»åŠ åˆ°processedBeansé›†åˆä¸­,åŒæ ·çš„æ’åºæ–¹å¼,æ·»åŠ åˆ°registryProcessorsä¸­,å†è°ƒç”¨invokeBeanDefinitionRegistryPostProcessors()æ–¹æ³•,currentRegistryProcessorsæ¸…ç©ºè¯¥é›†åˆ.</span></span><br><span class="line"><span class="comment">// ä¹Ÿå°±æ˜¯åˆ°è¿™é‡Œ,å¯ä»¥çœ‹å‡ºæ¥,å¤„ç†çš„é¡ºåº,å…ˆæ˜¯å¤„ç†PriorityOrdered,å†å¤„ç†Ordered.</span></span><br><span class="line"><span class="comment">// ç„¶åä½¿ç”¨ä¸€ä¸ªwhileå¾ªç¯,ç»§ç»­è·å–BeanDefinitionRegistryPostProcessorå¯¹åº”çš„postProcessorNames,è¿™ä¸ªåœ°æ–¹æ˜¯ä¸ºäº†é˜²æ­¢æœ‰äº›æ²¡æœ‰è°ƒç”¨åˆ°çš„,å¹¶ä¸”æ˜¯processedBeansé›†åˆä¸­ä¸åŒ…å«çš„,ç„¶åå°±ä¼šæ”¾å…¥åˆ°currentRegistryProcessorsè¿™ä¸ªé›†åˆä¸­,æ’åºcurrentRegistryProcessorsé›†åˆ,å…¨éƒ¨æ·»åŠ åˆ°registryProcessorsä¸­,è°ƒç”¨invokeBeanDefinitionRegistryPostProcessors,ä¹Ÿå°±æ˜¯è°ƒç”¨å…·ä½“çš„PostProcessors.</span></span><br><span class="line"><span class="comment">//invokeBeanFactoryPostProcessors(registryProcessors, beanFactory);</span></span><br><span class="line"><span class="comment">//invokeBeanFactoryPostProcessors(regularPostProcessors, beanFactory);</span></span><br><span class="line"><span class="comment">// ä¹‹å‰çš„äºŒä¸ªé›†åˆ,registryProcessorså’ŒregularPostProcessors,åœ¨è¿™é‡Œè¿˜æ˜¯ä¼šç»§ç»­è°ƒç”¨.</span></span><br><span class="line"><span class="comment">//ç„¶åæ ¹æ®BeanFactoryPostProcessor.classè·å–postProcessorNamesæ•°ç»„,ä¸ä¸Šé¢çš„ä¹Ÿæ˜¯åŒæ ·çš„æ–¹æ³•,</span></span><br><span class="line"><span class="comment">//å¯¹postProcessorNamesè¿›è¡Œè¿­ä»£,å¦‚æœæ˜¯processedBeans(ä¸Šé¢è£…çš„åå­—)å¦‚æœåŒ…å«äº†,å°±ä¼šè·³è¿‡.</span></span><br><span class="line"><span class="comment">/** å¦‚æœppName,ä¹Ÿå°±æ˜¯è¿­ä»£çš„å€¼,æ˜¯æœ‰PriorityOrderedçš„å­ç±»çš„è¯,å°±ä¼šä»èµ°beanFactory.getBean(ppName, BeanFactoryPostProcessor.class)è·å–å‡ºBeanFactoryPostProcessoræ”¾å…¥åˆ°priorityOrderedPostProcessorsé›†åˆä¸­.  å¦‚æœæ˜¯Orderedçš„å­ç±»,å°±å°†åå­—æ”¾å…¥åˆ°orderedPostProcessorNamesé›†åˆä¸­,å¦‚æœä¸Šé¢ä¸‰ç§éƒ½ä¸æ»¡è¶³çš„è¯,å°±ä¼šæ”¾å…¥åˆ°nonOrderedPostProcessorNamesé›†åˆä¸­.</span></span><br><span class="line"><span class="comment">ç„¶åå…ˆæ’åºpriorityOrderedPostProcessors,å†èµ°invokeBeanFactoryPostProcessors(priorityOrderedPostProcessors, beanFactory);</span></span><br><span class="line"><span class="comment">æ¥ç€è¿­ä»£orderedPostProcessorNamesé›†åˆ,ç„¶åä»beanFactoryä¸­è·å–BeanFactoryPostProcessor,å†å°±åšä¸priorityOrderedPostProcessorsä¸€æ ·çš„æ“ä½œ.</span></span><br><span class="line"><span class="comment">æœ€ååœ¨åšnonOrderedPostProcessorsè¿™ä¸ªé›†åˆçš„,æ“ä½œæ˜¯ä¸orderedPostProcessorNamesä¸€æ‘¸ä¸€æ ·çš„.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">æœ€ååœ¨è°ƒç”¨ä¸€ä¸ªbeanFactoryçš„clearMetadataCacheæ–¹æ³•.</span></span><br><span class="line"><span class="comment">å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ–¹æ³•æ˜¯å…ˆå¯¹BeanDefinitionRegistryPostProcessor.classè¿›è¡Œå¤„ç†,ç„¶åæ ¹æ®é¡ºåºPriorityOrdered--&gt;Ordered---&gt;æ²¡æœ‰, è¿™æ ·çš„é¡ºåºæ‰§è¡Œçš„.</span></span><br><span class="line"><span class="comment">ç„¶åå†å¤„ç†BeanFactoryPostProcessor.class,å¤„ç†æ–¹å¼æ˜¯å’ŒBeanDefinitionRegistryPostProcessor.classä¹Ÿæ˜¯ä¸€æ ·çš„,æ ¹æ®é¡ºåºæ¥è¿›è¡Œå¤„ç†.</span></span><br><span class="line"><span class="comment">*/</span>    </span><br><span class="line">   PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors(beanFactory, postProcessorsList);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Detect a LoadTimeWeaver and prepare for weaving, if found in the meantime</span></span><br><span class="line">   <span class="comment">// (e.g. through an @Bean method registered by ConfigurationClassPostProcessor)</span></span><br><span class="line"><span class="comment">// è·å–beanFactoryçš„tempClassLoaderåŠ è½½,å¹¶ä¸”beanFactoryæ˜¯åŒ…å«äº†loadTimeWeaverè¿™ä¸ªbeançš„,</span></span><br><span class="line"><span class="comment">//å°±ä¼šèµ°ifæ–¹æ³•,å¯ä»¥çœ‹åˆ°æ˜¯æ·»åŠ LoadTimeWeaverAwareProcessoråˆ°beanFactoryçš„postProcessorä¸­,</span></span><br><span class="line"><span class="comment">//ç„¶åæ·»åŠ ä¸€ä¸ªClassLoaderåˆ°beanFactoryä¸­   </span></span><br><span class="line">   <span class="keyword">if</span> (beanFactory.getTempClassLoader() == <span class="literal">null</span> &amp;&amp; beanFactory.containsBean(LOAD_TIME_WEAVER_BEAN_NAME)) &#123;</span><br><span class="line">      beanFactory.addBeanPostProcessor(<span class="keyword">new</span> <span class="title class_">LoadTimeWeaverAwareProcessor</span>(beanFactory));</span><br><span class="line">      beanFactory.setTempClassLoader(<span class="keyword">new</span> <span class="title class_">ContextTypeMatchClassLoader</span>(beanFactory.getBeanClassLoader()));</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="refresh-registerBeanPostProcessors-æ–¹æ³•"><a href="#refresh-registerBeanPostProcessors-æ–¹æ³•" class="headerlink" title="refresh.registerBeanPostProcessors() æ–¹æ³•"></a>refresh.registerBeanPostProcessors() æ–¹æ³•</h4><p>ä»”ç»†çœ‹ä¸­è¿™ä¸ªæ–¹æ³•,å…¶å®å’Œä¸Šä¸€ä¸ªæ–¹æ³•èµ°çš„é€»è¾‘å¥½åƒæ˜¯æœ‰ç‚¹ç±»ä¼¼çš„. ä¹Ÿæ˜¯å€ŸåŠ©PostProcessorRegistrationDelegateæ¥å®Œæˆå…¶é€»è¾‘çš„.</p><p>å…ˆæ˜¯ä»BeanFactoryä¸­è·å–BeanPostProcessorå¯¹ç”¨çš„postProcessorNamesæ•°ç»„ã€‚</p><p>ç„¶ååˆ†ä¸º PriorityOrdered â€“&gt; Ordered â€“&gt; æ—¢ä¸æ˜¯PriorityOrdered ,ä¹Ÿä¸æ˜¯Ordered â€“&gt; MergedBeanDefinitionPostProcessorå­ç±», è¿™æ ·çš„å…ˆåé¡ºåº,èµ°registerBeanPostProcessors,è¿™ä¸ªæ˜¯å°†PostProcessrosæ³¨å†Œåˆ°Springçš„beanFactoryä¸­(Springå®¹å™¨).</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Instantiate and register all BeanPostProcessor beans,</span></span><br><span class="line"><span class="comment"> * respecting explicit order if given.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;Must be called before any instantiation of application beans.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">registerBeanPostProcessors</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> &#123;</span><br><span class="line">   PostProcessorRegistrationDelegate.registerBeanPostProcessors(beanFactory, <span class="built_in">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-------------------</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">registerBeanPostProcessors</span><span class="params">(</span></span><br><span class="line"><span class="params">ConfigurableListableBeanFactory beanFactory, AbstractApplicationContext applicationContext)</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å…ˆæ˜¯æ ¹æ®BeanPostProcessorè·å–å‡ºpostProcessorNamesæ•°ç»„,è¿™ä¸ªæ ¹æ®å’Œä¸Šé¢çš„æ–¹æ³•å¾ˆç›¸ä¼¼.    </span></span><br><span class="line">String[] postProcessorNames = beanFactory.getBeanNamesForType(BeanPostProcessor.class,</span><br><span class="line"><span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Register BeanPostProcessorChecker that logs an info message when</span></span><br><span class="line"><span class="comment">// a bean is created during BeanPostProcessor instantiation, i.e. when</span></span><br><span class="line"><span class="comment">// a bean is not eligible for getting processed by all BeanPostProcessors.</span></span><br><span class="line"><span class="comment">//ç„¶åä»beanFactoryä¸­è·å–å‡ºä¸ªæ•° + postProcessorNamesæ•°ç»„é•¿åº¦å†åŠ ä¸Šä¸€ä¸ª1.     </span></span><br><span class="line"><span class="type">int</span> <span class="variable">beanProcessorTargetCount</span> <span class="operator">=</span> beanFactory.getBeanPostProcessorCount() + <span class="number">1</span> + postProcessorNames.length;</span><br><span class="line"><span class="comment">//æ·»åŠ ä¸€ä¸ªBeanPostProcessorCheckeråˆ°beanFactoryä¸­.ä»åå­—ä¸Šæ¥,è¿™ä¸ªPostProcessoråº”è¯¥æ˜¯è¿›è¡Œæ£€æŸ¥çš„æ“ä½œ.</span></span><br><span class="line">beanFactory.addBeanPostProcessor(<span class="keyword">new</span> <span class="title class_">BeanPostProcessorChecker</span>(beanFactory, beanProcessorTargetCount));</span><br><span class="line"></span><br><span class="line"><span class="comment">// Separate between BeanPostProcessors that implement PriorityOrdered,</span></span><br><span class="line"><span class="comment">// Ordered, and the rest.</span></span><br><span class="line">List&lt;BeanPostProcessor&gt; priorityOrderedPostProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">List&lt;BeanPostProcessor&gt; internalPostProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">List&lt;String&gt; orderedPostProcessorNames = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">List&lt;String&gt; nonOrderedPostProcessorNames = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯¹ postProcessorNames è¿›è¡Œéå†;åŒæ—¶ä½¿ç”¨ä¸åŒç±»å‹çš„é›†åˆæ¥å­˜å‚¨æ•°æ®</span></span><br><span class="line"><span class="comment">//ä¸»è¦æ˜¯æ ¹æ®æ˜¯å¦æ˜¯PriorityOrderedçš„å­ç±»,æ˜¯çš„è¯å°±ä¼šæ”¾å…¥åˆ°priorityOrderedPostProcessorsé›†åˆä¸­,æ¥ç€åœ¨åˆ¤æ–­æ˜¯å¦æ˜¯MergedBeanDefinitionPostProcessor,å¦‚æœæ˜¯çš„è¯,å°±ä¼šæ”¾å…¥åˆ°internalPostProcessorsé›†åˆä¸­</span></span><br><span class="line"><span class="comment">//æ˜¯ä¸æ˜¯orderdçš„å­ç±»,æ˜¯çš„è¯,å°±ä¼šæ”¾å…¥åˆ°orderedPostProcessorNamesé›†åˆä¸­,</span></span><br><span class="line"><span class="comment">//å¦‚æœä¸Šé¢äºŒè€…éƒ½ä¸çš„è¯,å°±ä¼šæ”¾å…¥åˆ°nonOrderedPostProcessorNamesé›†åˆä¸­  </span></span><br><span class="line"><span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line"><span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;</span><br><span class="line"><span class="type">BeanPostProcessor</span> <span class="variable">pp</span> <span class="operator">=</span> beanFactory.getBean(ppName, BeanPostProcessor.class);</span><br><span class="line">priorityOrderedPostProcessors.add(pp);</span><br><span class="line"><span class="keyword">if</span> (pp <span class="keyword">instanceof</span> MergedBeanDefinitionPostProcessor) &#123;</span><br><span class="line">internalPostProcessors.add(pp);</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;</span><br><span class="line">orderedPostProcessorNames.add(ppName);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">nonOrderedPostProcessorNames.add(ppName);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// First, register the BeanPostProcessors that implement PriorityOrdered.</span></span><br><span class="line"><span class="comment">//å…ˆå¤„ç†priorityOrderedPostProcessorsè¿™ä¸ªé›†åˆä¸­çš„æ•°æ®.å…ˆæ’åº,ç„¶åè°ƒç”¨registerBeanPostPtocessorsæ–¹æ³•.</span></span><br><span class="line">sortPostProcessors(priorityOrderedPostProcessors, beanFactory);</span><br><span class="line">registerBeanPostProcessors(beanFactory, priorityOrderedPostProcessors);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Next, register the BeanPostProcessors that implement Ordered.</span></span><br><span class="line"><span class="comment">//åœ¨å¤„ç†orderedPostProcessorNamesé›†åˆä¸­çš„æ•°æ®,å‘ç°å¦‚æœä¹Ÿæ˜¯MergedBeanDefinitionPostProcessoræˆ–è€…å…¶å­ç±»çš„è¯,ä¹Ÿå°±æ”¾å…¥åˆ°internalPostProcessorsé›†åˆä¸­,ä¹Ÿå°±æ˜¯è¿™é‡Œå…ˆä¸å¤„ç†.</span></span><br><span class="line">List&lt;BeanPostProcessor&gt; orderedPostProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"><span class="keyword">for</span> (String ppName : orderedPostProcessorNames) &#123;</span><br><span class="line"><span class="type">BeanPostProcessor</span> <span class="variable">pp</span> <span class="operator">=</span> beanFactory.getBean(ppName, BeanPostProcessor.class);</span><br><span class="line">orderedPostProcessors.add(pp);</span><br><span class="line"><span class="keyword">if</span> (pp <span class="keyword">instanceof</span> MergedBeanDefinitionPostProcessor) &#123;</span><br><span class="line">internalPostProcessors.add(pp);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//æ’åº,å¤„ç†ä¸Šé¢ä¸æ˜¯MergedBeanDefinitionPostProcessorçš„æˆ–å…¶å­ç±»,å¹¶ä¸”æ˜¯ orderedPostProcessorNamesé›†åˆä¸­çš„æ•°æ®</span></span><br><span class="line">sortPostProcessors(orderedPostProcessors, beanFactory);</span><br><span class="line">registerBeanPostProcessors(beanFactory, orderedPostProcessors);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Now, register all regular BeanPostProcessors.</span></span><br><span class="line"><span class="comment">//æœ€åå°±å¤„ç†æ—¢ä¸æ˜¯PriorityOrdered,ä¹Ÿä¸æ˜¯Orderedçš„,å¦‚æœä¹Ÿæ˜¯MergedBeanDefinitionPostProcessoræˆ–è€…å…¶å­ç±»çš„è¯,è¿™é‡Œä¹Ÿä¼šæ”¾å…¥åˆ°internalPostProcessorsé›†åˆä¸­ </span></span><br><span class="line">List&lt;BeanPostProcessor&gt; nonOrderedPostProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"><span class="keyword">for</span> (String ppName : nonOrderedPostProcessorNames) &#123;</span><br><span class="line"><span class="type">BeanPostProcessor</span> <span class="variable">pp</span> <span class="operator">=</span> beanFactory.getBean(ppName, BeanPostProcessor.class);</span><br><span class="line">nonOrderedPostProcessors.add(pp);</span><br><span class="line"><span class="keyword">if</span> (pp <span class="keyword">instanceof</span> MergedBeanDefinitionPostProcessor) &#123;</span><br><span class="line">internalPostProcessors.add(pp);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//è¿™é‡Œå…ˆå¤„ç†nonOrderedPostProcessorNamesä¸­çš„æ•°æ®å¹¶ä¸”ä¸æ˜¯ MergedBeanDefinitionPostProcessorçš„å­ç±».</span></span><br><span class="line">registerBeanPostProcessors(beanFactory, nonOrderedPostProcessors);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Finally, re-register all internal BeanPostProcessors.</span></span><br><span class="line"><span class="comment">//æœ€åæ’åºä¸‹ MergedBeanDefinitionPostProcessorå­ç±»çš„é›†åˆ,è°ƒç”¨registerBeanPostProcessorsæ–¹æ³•,æ³¨å†Œåˆ°BeanFactoryä¸­å».   </span></span><br><span class="line">sortPostProcessors(internalPostProcessors, beanFactory);</span><br><span class="line">registerBeanPostProcessors(beanFactory, internalPostProcessors);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Re-register post-processor for detecting inner beans as ApplicationListeners,</span></span><br><span class="line"><span class="comment">// moving it to the end of the processor chain (for picking up proxies etc).</span></span><br><span class="line"><span class="comment">//æœ€åæ·»åŠ ä¸€ä¸ªApplicationListenerDetectoråˆ°beanFactoryä¸­å»,å¹¶ä¸”ApplicationListenerDetectoræ˜¯æœ‰å®ç°MergedBeanDefinitionPostProcessoræ¥å£çš„.</span></span><br><span class="line">beanFactory.addBeanPostProcessor(<span class="keyword">new</span> <span class="title class_">ApplicationListenerDetector</span>(applicationContext));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="refersh-initMessageSource-æ–¹æ³•"><a href="#refersh-initMessageSource-æ–¹æ³•" class="headerlink" title="refersh.initMessageSource() æ–¹æ³•"></a>refersh.initMessageSource() æ–¹æ³•</h4><p>è¿™ä¸ªæ–¹æ³•ä¸»è¦æ˜¯å¯¹ MESSAGE_SOURCE_BEAN_NAME æ˜¯å¦åœ¨beanFactoryä¸­è¿›è¡Œåˆ¤æ–­.å¦‚æœå·²ç»åœ¨äº†çš„è¯,å°±ä¼šåˆ¤æ–­æ˜¯ä¸æ˜¯HierarchicalMessageSourceç±»å‹,ç»§ç»­åˆ¤æ–­å…¶ParentMessageSourceæ˜¯ä¸æ˜¯null,å¦‚æœæ˜¯nullçš„è¯,å°±ä¼šgetInternalParentMessageSourceè°ƒç”¨åˆå§‹åŒ–è·å–ä¸€äº›å€¼ç»™èµ‹å€¼è¿›å».</p><p>å¦‚æœbeanFactoryä¸­æ²¡æœ‰çš„è¯,å°±ä¼šå…ˆnewä¸€ä¸ª,ç„¶åä¹Ÿä¼šsetParentMessageSourceå€¼è¿›å»,æœ€åæ³¨å†Œåˆ°beanFactoryä¸­å».</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Initialize the MessageSource.</span></span><br><span class="line"><span class="comment"> * Use parent&#x27;s if none defined in this context.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initMessageSource</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">//å…ˆè·å–BeanFactory.  </span></span><br><span class="line">   <span class="type">ConfigurableListableBeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> getBeanFactory();</span><br><span class="line"><span class="comment">// beanFactoryä¸­åŒ…å«MESSAGE_SOURCE_BEAN_NAME</span></span><br><span class="line">   <span class="keyword">if</span> (beanFactory.containsLocalBean(MESSAGE_SOURCE_BEAN_NAME)) &#123;</span><br><span class="line"> <span class="comment">//è·å–å‡ºå‡ºæ¥çš„beanèµ‹å€¼ç»™this.messageSource      </span></span><br><span class="line">      <span class="built_in">this</span>.messageSource = beanFactory.getBean(MESSAGE_SOURCE_BEAN_NAME, MessageSource.class);</span><br><span class="line">      <span class="comment">// Make MessageSource aware of parent MessageSource.</span></span><br><span class="line"><span class="comment">//this.parentä¸æ˜¯nullå¹¶ä¸”beanæ˜¯HierarchicalMessageSource</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.parent != <span class="literal">null</span> &amp;&amp; <span class="built_in">this</span>.messageSource <span class="keyword">instanceof</span> HierarchicalMessageSource) &#123;</span><br><span class="line">        <span class="comment">//å¼ºè½¬  </span></span><br><span class="line">         <span class="type">HierarchicalMessageSource</span> <span class="variable">hms</span> <span class="operator">=</span> (HierarchicalMessageSource) <span class="built_in">this</span>.messageSource;</span><br><span class="line">  <span class="comment">// hmsè·å–å‡ºæ¥çš„parentMessageSourceæ˜¯nullæƒ…å†µä¸‹,getInternalParentMessageSource()è¿”å›çš„å€¼èµ‹å€¼ç»™hmsçš„ParentMessageSourceå±æ€§  </span></span><br><span class="line">         <span class="keyword">if</span> (hms.getParentMessageSource() == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Only set parent context as parent MessageSource if no parent MessageSource</span></span><br><span class="line">            <span class="comment">// registered already.</span></span><br><span class="line">            hms.setParentMessageSource(getInternalParentMessageSource());</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">         logger.debug(<span class="string">&quot;Using MessageSource [&quot;</span> + <span class="built_in">this</span>.messageSource + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"><span class="comment">// beanFactoryä¸­ä¸åŒ…å«MESSAGE_SOURCE_BEAN_NAME    </span></span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// Use empty MessageSource to be able to accept getMessage calls.</span></span><br><span class="line"><span class="comment">//è‡ªå·±newä¸€ä¸ªDelegatingMessageSource,dms    </span></span><br><span class="line">      <span class="type">DelegatingMessageSource</span> <span class="variable">dms</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DelegatingMessageSource</span>();</span><br><span class="line"><span class="comment">//è°ƒç”¨getInternalParentMessageSource()æ–¹æ³•çš„è¿”å›å€¼ç»™setè¿›å».  </span></span><br><span class="line">      dms.setParentMessageSource(getInternalParentMessageSource());</span><br><span class="line">      <span class="built_in">this</span>.messageSource = dms;</span><br><span class="line"><span class="comment">// æ³¨å…¥åˆ° beanFactroyä¸­å»       </span></span><br><span class="line">      beanFactory.registerSingleton(MESSAGE_SOURCE_BEAN_NAME, <span class="built_in">this</span>.messageSource);</span><br><span class="line"><span class="comment">// æ ¹æ®logçš„çº§åˆ«æ¥æ‰“å°.       </span></span><br><span class="line">      <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">         logger.debug(<span class="string">&quot;Unable to locate MessageSource with name &#x27;&quot;</span> + MESSAGE_SOURCE_BEAN_NAME +</span><br><span class="line">               <span class="string">&quot;&#x27;: using default [&quot;</span> + <span class="built_in">this</span>.messageSource + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="refresh-initApplicationEventMulticaster-æ–¹æ³•"><a href="#refresh-initApplicationEventMulticaster-æ–¹æ³•" class="headerlink" title="refresh.initApplicationEventMulticaster() æ–¹æ³•"></a>refresh.initApplicationEventMulticaster() æ–¹æ³•</h4><p>è¯¥æ–¹æ³•å¯ä»¥çœ‹åˆ°ä¹Ÿæ˜¯å¯¹APPLICATION_EVENT_MULTICASTER_BEAN_NAMEæ˜¯å¦åœ¨beançš„åˆ¤æ–­ï¼Œå¦‚æœæœ‰çš„è¯,å°±ä¼šgetå‡ºæ¥,æ²¡æœ‰çš„è¯,å°±ä¼šnewä¸€ä¸ªå‡ºæ¥,ç„¶åæ³¨å†Œåˆ°beanFactoryä¸­å».</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Initialize the ApplicationEventMulticaster.</span></span><br><span class="line"><span class="comment"> * Uses SimpleApplicationEventMulticaster if none defined in the context.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> org.springframework.context.event.SimpleApplicationEventMulticaster</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initApplicationEventMulticaster</span><span class="params">()</span> &#123;</span><br><span class="line"> <span class="comment">// å…ˆè·å–beanFactory   </span></span><br><span class="line">   <span class="type">ConfigurableListableBeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> getBeanFactory();</span><br><span class="line"> <span class="comment">//åˆ¤æ–­beanFactoryæ˜¯ä¸æ˜¯æœ‰APPLICATION_EVENT_MULTICASTER_BEAN_NAMEè¿™ä¸ªbean,</span></span><br><span class="line"> <span class="comment">//å¦‚æœæ˜¯æœ‰çš„è¯,å°±ä¼šè·å–å‡ºæ¥.ç„¶åè¿›è¡Œlogçš„çº§åˆ«,åˆ¤æ–­è¦ä¸è¦æ‰“å°</span></span><br><span class="line">   <span class="keyword">if</span> (beanFactory.containsLocalBean(APPLICATION_EVENT_MULTICASTER_BEAN_NAME)) &#123;</span><br><span class="line">      <span class="built_in">this</span>.applicationEventMulticaster =</span><br><span class="line">            beanFactory.getBean(APPLICATION_EVENT_MULTICASTER_BEAN_NAME, ApplicationEventMulticaster.class);</span><br><span class="line">      <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">         logger.debug(<span class="string">&quot;Using ApplicationEventMulticaster [&quot;</span> + <span class="built_in">this</span>.applicationEventMulticaster + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line"> <span class="comment">//å¦‚æœbeanFactoryæ˜¯ä¸åŒ…å«çš„è¯,é‚£ä¹ˆä¹…newä¸€ä¸ªSimpleApplicationEventMulticasterå‡ºæ¥,</span></span><br><span class="line"> <span class="comment">//ç„¶åæ³¨å†Œåˆ°beanFactoryä¸­å»,æœ€åæ ¹æ®logçš„çº§åˆ«æ¥åˆ¤æ–­æ‰“å°</span></span><br><span class="line">  </span><br><span class="line">      <span class="built_in">this</span>.applicationEventMulticaster = <span class="keyword">new</span> <span class="title class_">SimpleApplicationEventMulticaster</span>(beanFactory);</span><br><span class="line">      beanFactory.registerSingleton(APPLICATION_EVENT_MULTICASTER_BEAN_NAME, <span class="built_in">this</span>.applicationEventMulticaster);</span><br><span class="line">      <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">         logger.debug(<span class="string">&quot;Unable to locate ApplicationEventMulticaster with name &#x27;&quot;</span> +</span><br><span class="line">               APPLICATION_EVENT_MULTICASTER_BEAN_NAME +</span><br><span class="line">               <span class="string">&quot;&#x27;: using default [&quot;</span> + <span class="built_in">this</span>.applicationEventMulticaster + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="refresh-onRefresh-æ–¹æ³•"><a href="#refresh-onRefresh-æ–¹æ³•" class="headerlink" title="refresh.onRefresh() æ–¹æ³•"></a>refresh.onRefresh() æ–¹æ³•</h4><p>è¯¥æ–¹æ³•æ—¶ç•™ç»™å­ç±»çš„ã€‚ å¦‚æœæ˜¯SpringBootå¯åŠ¨çš„è¯,è¿™é‡Œå°±ä¼šå»new Tomcat,ç„¶åå¯åŠ¨webç›¸åº”çš„ç¯å¢ƒ.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Template method which can be overridden to add context-specific refresh work.</span></span><br><span class="line"><span class="comment"> * Called on initialization of special beans, before instantiation of singletons.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;This implementation is empty.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> BeansException in case of errors</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #refresh()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onRefresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">   <span class="comment">// For subclasses: do nothing by default.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="refresh-registerListeners-æ–¹æ³•"><a href="#refresh-registerListeners-æ–¹æ³•" class="headerlink" title="refresh.registerListeners() æ–¹æ³•"></a>refresh.registerListeners() æ–¹æ³•</h4><p>è¯¥æ–¹æ³•æ˜¯å…ˆè·å– ApplicationListeners,å¦‚æœæ˜¯æœ‰å€¼çš„è¯,å°±ä¼šæ·»åŠ åˆ°AbstractApplicationEventMulticasterçš„ListenerRetrieverçš„applicationListenersé›†åˆä¸­å».</p><p>æ ¹æ®ApplicationListener.classè·å–å¯¹åº”çš„beanä¿¡æ¯,ç„¶åè¿­ä»£,æœ€åä¼šæ·»åŠ åˆ°AbstractApplicationEventMulticasterçš„ListenerRetrieverçš„applicationListenerBeanså±æ€§ä¸­å»</p><p>æœ€åæ˜¯å¯¹this.earlyApplicationEventsä¸­çš„äº‹ä»¶è¿›è¡Œå‘å¸ƒ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Add beans that implement ApplicationListener as listeners.</span></span><br><span class="line"><span class="comment"> * Doesn&#x27;t affect other listeners, which can be added without being beans.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">registerListeners</span><span class="params">()</span> &#123;</span><br><span class="line">   <span class="comment">// Register statically specified listeners first.</span></span><br><span class="line"><span class="comment">//getApplicationListeners()è·å–AbstractApplicationContextä¸­çš„applicationListeners</span></span><br><span class="line"><span class="comment">//getApplicationEventMulticaster()æ–¹æ³•è·å–çš„applicationEventMulticaster,æ˜¯åœ¨</span></span><br><span class="line"><span class="comment">//initApplicationEventMulticasteræ–¹æ³•ä¸­æœ‰åˆå§‹åŒ–çš„.    </span></span><br><span class="line"><span class="comment">//org.springframework.context.event.AbstractApplicationEventMulticaster#addApplicationListener,æœ€åæ˜¯èµ°åˆ°äº†è¿™é‡Œ, </span></span><br><span class="line"><span class="comment">//this.defaultRetriever.applicationListeners.add(listener);æœ€ålisteneræ˜¯æ·»åŠ åˆ°</span></span><br><span class="line"><span class="comment">//å…¶å†…éƒ¨å†…ListenerRetrieverçš„applicationListenerså‚æ•°ä¸­å»äº†.    </span></span><br><span class="line">   <span class="keyword">for</span> (ApplicationListener&lt;?&gt; listener : getApplicationListeners()) &#123;</span><br><span class="line">      getApplicationEventMulticaster().addApplicationListener(listener);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Do not initialize FactoryBeans here: We need to leave all regular beans</span></span><br><span class="line">   <span class="comment">// uninitialized to let post-processors apply to them!</span></span><br><span class="line"><span class="comment">//æ ¹æ®ApplicationListenerè·å–ç›¸åº”çš„beanNamesæ•°ç»„,è¿™é‡Œå¯ä»¥çœ‹åˆ°å’Œä¹‹å‰è·å–PostProcessoræ˜¯ä¸€æ ·çš„</span></span><br><span class="line">   String[] listenerBeanNames = getBeanNamesForType(ApplicationListener.class, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line"><span class="comment">//ç„¶åè¿­ä»£, getApplicationListenerBeanæ˜¯èµ°åˆ°äº†</span></span><br><span class="line"><span class="comment">//org.springframework.context.event.AbstractApplicationEventMulticaster#addApplicationListenerBean,ä¹Ÿå°±æ˜¯æ·»åŠ åˆ°äº†å…¶å†…éƒ¨ç±»ListenerRetrieverçš„applicationListenerBeanså±æ€§é‡Œé¢    </span></span><br><span class="line">   <span class="keyword">for</span> (String listenerBeanName : listenerBeanNames) &#123;</span><br><span class="line">      getApplicationEventMulticaster().addApplicationListenerBean(listenerBeanName);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Publish early application events now that we finally have a multicaster...</span></span><br><span class="line"><span class="comment">//ä½¿ç”¨this.earlyApplicationEventsçš„é›†åˆçš„å€¼,èµ‹å€¼ç»™å˜é‡earlyEventsToProcess,</span></span><br><span class="line"><span class="comment">//ç„¶åç»™this.earlyApplicationEventsé‡ç½®ä¸ºnull   </span></span><br><span class="line">   Set&lt;ApplicationEvent&gt; earlyEventsToProcess = <span class="built_in">this</span>.earlyApplicationEvents;</span><br><span class="line">   <span class="built_in">this</span>.earlyApplicationEvents = <span class="literal">null</span>;</span><br><span class="line"> <span class="comment">//é›†åˆä¸æ˜¯nullå¹¶ä¸”æ˜¯æœ‰å€¼çš„è¯,   </span></span><br><span class="line">   <span class="keyword">if</span> (earlyEventsToProcess != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span> (ApplicationEvent earlyEvent : earlyEventsToProcess) &#123;</span><br><span class="line">  <span class="comment">//org.springframework.context.event.SimpleApplicationEventMulticaster#invokeListener,è¿™é‡Œæ˜¯èµ°åˆ°äº†è¿™é‡Œ,å¯ä»¥çœ‹åˆ°æ˜¯å¯¹è¿™ä¸ªäº‹ä»¶è¿›è¡Œå‘å¸ƒ.</span></span><br><span class="line"> <span class="comment">// ç„¶åä¼šæ ¹æ®ApplicationListenerå»èµ°onApplicationEventæ–¹æ³•         </span></span><br><span class="line">         getApplicationEventMulticaster().multicastEvent(earlyEvent);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="refresh-finishBeanFactoryInitialization-æ–¹æ³•"><a href="#refresh-finishBeanFactoryInitialization-æ–¹æ³•" class="headerlink" title="refresh.finishBeanFactoryInitialization() æ–¹æ³•"></a>refresh.finishBeanFactoryInitialization() æ–¹æ³•</h4><p>è¯¥æ–¹æ³•ä»åå­—ä¸Šæ¥,å°±æ˜¯ç»“æŸbeanFactoryçš„åˆå§‹åŒ–,ä¹Ÿå°±æ˜¯æˆ‘ä»¬å‰é¢å‡†å¤‡çš„bd,postProcessorç­‰ä¿¡æ¯,åœ¨è¿™é‡Œéƒ½ä¼šä½¿ç”¨åˆ°çš„.</p><p>å¯ä»¥çœ‹åˆ°è¯¥æ–¹æ³•å°±æ˜¯çœŸæ­£çš„å®ä¾‹åŒ–beançš„æ–¹æ³•ã€‚ å¤§è‡´å°±æ˜¯getBeanå¾€ä¸‹èµ°,getBeanå¦‚æœæ˜¯æ²¡æœ‰çš„è¯,å°±ä¼šèµ°createBean,ä¹Ÿå°±æ˜¯æ²¡æœ‰å°±å»åˆ›å»ºå˜›ï¼Œå°±æ˜¯è¿™ä¸ªæ„æ€ã€‚ç„¶åå…¶åˆ›å»ºçš„æ¡ä»¶,æ˜¯èµ°å„ç§beanPostProcessorsæ¥è¿›è¡Œæ‰©å±•bean.</p><p>beanFactory.preInstantiateSingletons() æ˜¯éœ€è¦å»é˜…è¯»å¾ˆå¤šéçš„. ä¸æ˜¯ä¸€éæˆ–è€…ç®€å•çš„å‡ éå°±okäº†çš„.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Finish the initialization of this context&#x27;s bean factory,</span></span><br><span class="line"><span class="comment"> * initializing all remaining singleton beans.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">finishBeanFactoryInitialization</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> &#123;</span><br><span class="line">   <span class="comment">// Initialize conversion service for this context.</span></span><br><span class="line"><span class="comment">//å¦‚æœbeanFactoryåŒ…å«CONVERSION_SERVICE_BEAN_NAME,å¹¶ä¸”è¯¥CONVERSION_SERVICE_BEAN_NAMEæ˜¯</span></span><br><span class="line"><span class="comment">//ConversionServiceçš„å­ç±»çš„è¯,ä¹…æ»¡è¶³æ¡ä»¶,ç„¶åå…ˆä»beanFactoryä¸­è·å–å‡ºbean,setç»™beanFactoryä¸­çš„conversionServiceå±æ€§    </span></span><br><span class="line">   <span class="keyword">if</span> (beanFactory.containsBean(CONVERSION_SERVICE_BEAN_NAME) &amp;&amp;</span><br><span class="line">         beanFactory.isTypeMatch(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class)) &#123;</span><br><span class="line">      beanFactory.setConversionService(</span><br><span class="line">            beanFactory.getBean(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Register a default embedded value resolver if no bean post-processor</span></span><br><span class="line">   <span class="comment">// (such as a PropertyPlaceholderConfigurer bean) registered any before:</span></span><br><span class="line">   <span class="comment">// at this point, primarily for resolution in annotation attribute values.</span></span><br><span class="line"><span class="comment">// beanFactoryä¸­æ²¡æœ‰EmbeddedValueResolver,ä¹Ÿå°±æ˜¯è¯¥æ–¹æ³•è¿”å›çš„æ˜¯false,ç„¶åå°±ä»environmentä¸­è·å–å‡ºæ¥ä¸€ä¸ªç»™addåˆ°beanFactoryä¸­å».    </span></span><br><span class="line">   <span class="keyword">if</span> (!beanFactory.hasEmbeddedValueResolver()) &#123;</span><br><span class="line">      beanFactory.addEmbeddedValueResolver(strVal -&gt; getEnvironment().resolvePlaceholders(strVal));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Initialize LoadTimeWeaverAware beans early to allow for registering their transformers early.</span></span><br><span class="line"><span class="comment">//æ ¹æ®LoadTimeWeaverAwareè·å–å‡ºå¯¹ç”¨çš„namesæ•°ç»„</span></span><br><span class="line">   String[] weaverAwareNames = beanFactory.getBeanNamesForType(LoadTimeWeaverAware.class,</span><br><span class="line">         <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç„¶åè¿­ä»£ä¸Šé¢è·å–å‡ºæ¥çš„æ•°ç»„,æŒ¨ä¸ªè°ƒç”¨getBeanæ–¹æ³•    </span></span><br><span class="line">   <span class="keyword">for</span> (String weaverAwareName : weaverAwareNames) &#123;      </span><br><span class="line">      getBean(weaverAwareName);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Stop using the temporary ClassLoader for type matching.</span></span><br><span class="line"><span class="comment">// tempClassLoader,tempçš„ClassLoaderè®¾ç½®ä¸ºnull    </span></span><br><span class="line">   beanFactory.setTempClassLoader(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Allow for caching all bean definition metadata, not expecting further changes.</span></span><br><span class="line"><span class="comment">//org.springframework.beans.factory.support.DefaultListableBeanFactory#freezeConfiguration,è¯¥æ–¹æ³•æ—¶èµ°çš„è¿™é‡Œ. å…¶ä¸­å¯ä»¥çœ‹åˆ°æ˜¯ç»™configurationFrozenè®¾ç½®ä¸ºtrue,ç„¶åbeanNameçš„é›†åˆè½¬åŒ–ä¸ºæ•°ç»„,å¹¶ä¸”èµ‹å€¼ç»™this.frozenBeanDefinitionNamesè¿™ä¸ªæ•°ç»„    </span></span><br><span class="line">   beanFactory.freezeConfiguration();</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Instantiate all remaining (non-lazy-init) singletons.</span></span><br><span class="line"><span class="comment">//è¿™é‡Œé¢åˆå§‹åŒ–bean,ç®€å•è¯´ä¸€ä¸‹é€»è¾‘. org.springframework.beans.factory.support.AbstractBeanFactory#getBean(java.lang.String)</span></span><br><span class="line"><span class="comment">//getBean() ---&gt; doGetBean() ---&gt;   createBean() ---&gt;  doCreateBean() </span></span><br><span class="line"><span class="comment">//ç„¶åå†createBeanå’ŒdoCreateBean()æ–¹æ³•ä¹‹ä¸­,ä¼šæ ¹æ®æ¡ä»¶ä¸Šé¢çš„,è·å–BeanPostProcessors,ç„¶ååˆ¤æ–­èµ°å“¦ä¸èµ°å…¶å„ç§BeanPostProceesorsæä¾›çš„æ–¹æ³•.æ»¡è¶³æ¡ä»¶å°±ä¼šèµ°,ä¸æ»¡è¶³ä¹Ÿå°±è‡ªç„¶ä¸ä¼šèµ°äº†.</span></span><br><span class="line"><span class="comment">//å½“ç„¶äº†è¿™ä¸ªæ–¹æ³•çš„å¤æ‚ç¨‹åº¦æ˜¯æ¯”è¾ƒé«˜çš„ï¼Œæ˜¯éœ€è¦å¥½å¥½ç†è§£çš„ã€‚ä¸æ˜¯è¿™ä¸ªç®€ç®€å•å•çš„å‡ å¥è¯,è¿˜éœ€è¦è‡ªå·±å»è¯».</span></span><br><span class="line"><span class="comment">//èµ·å¤§è‡´æ‰“ä»£ç èµ°å‘å°±æ˜¯è¿™æ ·,ç„¶åå…¶ä¸­ä¼šèµ°å¾ˆå¤šè°ƒç”¨beanæ‰©å±•çš„BeanPostProcessorsï¼Œè¿˜æœ‰å®ç°Init...æ¥å£åæä¾›çš„afterS...ç­‰æ–¹æ³•.    </span></span><br><span class="line">   beanFactory.preInstantiateSingletons();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id=""><a href="#" class="headerlink" title=""></a></h4><h4 id="refresh-finishRefresh-æ–¹æ³•"><a href="#refresh-finishRefresh-æ–¹æ³•" class="headerlink" title="refresh.finishRefresh() æ–¹æ³•"></a>refresh.finishRefresh() æ–¹æ³•</h4><p>å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ–¹æ³•æ˜¯æ¸…é™¤äº†èµ„æºç¼“å­˜, ç„¶å å®ç°Lifecycleæ¥å£çš„å­ç±»,è¿™é‡Œå°±ä¼šå¯åŠ¨å…¶startæ–¹æ³•</p><p>å‘é€ä¸€ä¸ªContextRefreshedEventäº‹ä»¶å‡ºå»</p><p>æœ€åå°†å½“å‰çš„ AbstractApplicationContext æ·»åŠ åˆ° LiveBeansViewçš„applicationContextsé›†åˆä¸­æ¥</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Finish the refresh of this context, invoking the LifecycleProcessor&#x27;s</span></span><br><span class="line"><span class="comment"> * onRefresh() method and publishing the</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> org.springframework.context.event.ContextRefreshedEvent&#125;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">finishRefresh</span><span class="params">()</span> &#123;</span><br><span class="line">   <span class="comment">// Clear context-level resource caches (such as ASM metadata from scanning).</span></span><br><span class="line">  <span class="comment">//æ¸…é™¤èµ„æºç¼“å­˜  </span></span><br><span class="line">   clearResourceCaches();</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Initialize lifecycle processor for this context.</span></span><br><span class="line"><span class="comment">// è¿™ä¸ªæ–¹æ³•å°±ä¼šè°ƒç”¨å®ç°äº† Lifecycle æ¥å£çš„å­ç±»,å¹¶ä¸”æ‰§è¡Œå…¶startæ–¹æ³•    </span></span><br><span class="line">   initLifecycleProcessor();</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Propagate refresh to lifecycle processor first.</span></span><br><span class="line">   getLifecycleProcessor().onRefresh();</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Publish the final event.</span></span><br><span class="line"> <span class="comment">//å‘é€ä¸€ä¸ªåˆ·æ–°ä¸Šä¸‹æ–‡çš„Eventå‡ºå»   </span></span><br><span class="line">   publishEvent(<span class="keyword">new</span> <span class="title class_">ContextRefreshedEvent</span>(<span class="built_in">this</span>));</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Participate in LiveBeansView MBean, if active.</span></span><br><span class="line"><span class="comment">//org.springframework.context.support.LiveBeansView#applicationContexts</span></span><br><span class="line"><span class="comment">//å°†AbstractApplicationContextæ·»åŠ åˆ°liveBeançš„applicationContextsé›†åˆä¸­    </span></span><br><span class="line">   LiveBeansView.registerApplicationContext(<span class="built_in">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="refresh-resetCommonCaches"><a href="#refresh-resetCommonCaches" class="headerlink" title="refresh.resetCommonCaches()"></a>refresh.resetCommonCaches()</h4><p>å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ–¹æ³•æ‰æ˜¯çœŸæ­£çš„æ¸…é™¤å„ç§é›†åˆç¼“å­˜å•¥çš„æ“ä½œ. æ˜¯åœ¨finallyä»£ç å¿«ä¸­,ä¹Ÿå°±æ˜¯è¯´æ˜¯å¿…é¡»è¦æ‰§è¡Œçš„ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Reset Spring&#x27;s common reflection metadata caches, in particular the</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> ReflectionUtils&#125;, &#123;<span class="doctag">@link</span> AnnotationUtils&#125;, &#123;<span class="doctag">@link</span> ResolvableType&#125;</span></span><br><span class="line"><span class="comment"> * and &#123;<span class="doctag">@link</span> CachedIntrospectionResults&#125; caches.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 4.2</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> ReflectionUtils#clearCache()</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> AnnotationUtils#clearCache()</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> ResolvableType#clearCache()</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> CachedIntrospectionResults#clearClassLoader(ClassLoader)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">resetCommonCaches</span><span class="params">()</span> &#123;</span><br><span class="line">   ReflectionUtils.clearCache();</span><br><span class="line">   AnnotationUtils.clearCache();</span><br><span class="line">   ResolvableType.clearCache();</span><br><span class="line">   CachedIntrospectionResults.clearClassLoader(getClassLoader());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;é¢˜è®°&quot;&gt;&lt;a href=&quot;#é¢˜è®°&quot; class=&quot;headerlink&quot; title=&quot;é¢˜è®°&quot;&gt;&lt;/a&gt;é¢˜è®°&lt;/h4&gt;&lt;p&gt; æ˜¨å¤©è®°å½•äº†this()å’Œ register() è¿™äºŒä¸ªæ–¹æ³•, è¿™äºŒä¸ªæ–¹æ³•éƒ½æ˜¯ä¸ºåé¢çš„åšé“ºå«,ä¹Ÿå°±æ˜¯æå‰åˆå§‹åŒ–äº†ä¸€äº›ç¯å¢ƒå’Œè¯»å–classæ–‡ä»¶</summary>
      
    
    
    
    <category term="java" scheme="https://ruy9527.github.io/categories/java/"/>
    
    <category term="spring" scheme="https://ruy9527.github.io/categories/java/spring/"/>
    
    
    <category term="java" scheme="https://ruy9527.github.io/tags/java/"/>
    
    <category term="spring" scheme="https://ruy9527.github.io/tags/spring/"/>
    
  </entry>
  
  <entry>
    <title>springåˆå§‹åŒ–(ä¸€)</title>
    <link href="https://ruy9527.github.io/2021/11/04/spring/spring%E5%88%9D%E5%A7%8B%E5%8C%96-%E4%B8%80/"/>
    <id>https://ruy9527.github.io/2021/11/04/spring/spring%E5%88%9D%E5%A7%8B%E5%8C%96-%E4%B8%80/</id>
    <published>2021-11-03T16:16:21.000Z</published>
    <updated>2022-11-04T13:46:13.919Z</updated>
    
    <content type="html"><![CDATA[<h4 id="é˜…è¯»æ–¹æ³•"><a href="#é˜…è¯»æ–¹æ³•" class="headerlink" title="é˜…è¯»æ–¹æ³•"></a>é˜…è¯»æ–¹æ³•</h4><p>æœ€ç®€å•çš„é˜…è¯»æ–¹æ³•,å°±æ˜¯åˆ›å»ºä¸€ä¸ªmavené¡¹ç›®,è®©å¼•å…¥Springçš„ä¾èµ–. ç„¶åå†™ä¸Šä¸€ä¸ªmainæ–¹æ³•,æ¥è¯»å–åŒ…ä¸‹çš„å†…å®¹,ç„¶åå†™ä¸€ä¸ªbean,å³å¯. è¿™ä¸ªbeanè¦åœ¨ä½ æ‰«æçš„åŒ…ä¸‹. äºæ˜¯æˆ‘ä»¬ç›´æ¥åœ¨newçš„åœ°æ–¹æ‰“ä¸Šæ–­ç‚¹è·Ÿè¿›å»å³å¯.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-context&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;<span class="number">5.2</span><span class="number">.0</span>.RELEASE&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;/dependencies&gt;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringStartMain</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">AnnotationConfigApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(<span class="string">&quot;com.iyang.spring&quot;</span>);</span><br><span class="line">        <span class="type">YangBeanOne</span> <span class="variable">yangBeanOne</span> <span class="operator">=</span> context.getBean(YangBeanOne.class);</span><br><span class="line">        System.out.println(yangBeanOne.getClass().toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿˜æœ‰ä¸€ç§å°±æ˜¯ä½ å»githubä¸Šcloneä¸€ä¸ªSpringçš„æºç ,ç„¶åå€’å…¥idea,å½“ç„¶ä½ éœ€è¦gradleç¯å¢ƒæ¥æ„å»º.ç„¶åæˆåŠŸçš„buildä¸€ä¸‹, å¦‚æœæˆåŠŸäº†çš„è¯,å°±åœ¨æºç çš„ç›®å½•åˆ›å»ºä¸€ä¸ªæ¨¡å—(xé¡¹ç›®),ç„¶ååƒä¸Šé¢ä¸€æ ·ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯,ä½ å¯ä»¥éšä¾¿ä¿®æ”¹æºç çš„ä»£ç , ä½ è§‰å¾—å®ƒçš„å“ªä¸ªåœ°æ–¹çš„ä»£ç å†™åˆ°ä¸å¤Ÿå¥½çš„è¯,ä¹Ÿæ˜¯å¯ä»¥å»ä¿®æ”¹çš„.</p><h4 id="Debugé˜…è¯»"><a href="#Debugé˜…è¯»" class="headerlink" title="Debugé˜…è¯»"></a>Debugé˜…è¯»</h4><p>å¼€å§‹debugè¿›è¡Œä»£ç çš„é˜…è¯» :</p><p>debugå°±ä¼šè¿›å…¥åˆ°è¿™ä¸ªæ„é€ å‡½æ•°ä¸­, è¿™é‡Œæˆ‘ä»¬å…ˆå¯¹ this() å’Œ scan(basePackages) è¿™äºŒä¸ªæ–¹æ³•è¿›è¡Œé˜…è¯», refresh()é‡Œé¢æ¶‰åŠåˆ°å†…å®¹æ¯”è¾ƒå¤š(BeanPostprocess,Aware,eventç­‰),ä¸æ˜¯ä¸€ä¸‹å­å°±èƒ½çœ‹æ˜ç™½çš„,æ˜¯éœ€è¦å¤§é‡çš„æ—¶é—´å»ä»”ç»†é˜…è¯»çš„.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Create a new AnnotationConfigApplicationContext, scanning for components</span></span><br><span class="line"><span class="comment"> * in the given packages, registering bean definitions for those components,</span></span><br><span class="line"><span class="comment"> * and automatically refreshing the context.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> basePackages the packages to scan for component classes</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">AnnotationConfigApplicationContext</span><span class="params">(String... basePackages)</span> &#123;</span><br><span class="line">   <span class="built_in">this</span>();</span><br><span class="line">   scan(basePackages);</span><br><span class="line">   refresh();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>this () æ–¹æ³•</p><p>å¯ä»¥çœ‹åˆ°thisæ–¹æ³•,åŸºæœ¬æ˜¯åœ¨åšä¸€äº›å¯¹ç¯å¢ƒåˆå§‹åŒ–çš„æ“ä½œ.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Create a new AnnotationConfigApplicationContext that needs to be populated</span></span><br><span class="line"><span class="comment"> * through &#123;<span class="doctag">@link</span> #register&#125; calls and then manually &#123;<span class="doctag">@linkplain</span> #refresh refreshed&#125;.</span></span><br><span class="line"><span class="comment"> åŒæ—¶è¿˜ä¼šèµ°åˆ° : org.springframework.context.support.GenericApplicationContext#GenericApplicationContext()è¿™ä¸ªæ–¹æ³•é‡Œé¢æ¥.  this.beanFactory = new DefaultListableBeanFactory(); å¯ä»¥çœ‹åˆ°è¿™é‡Œæ˜¯newäº†ä¸€ä¸ªbeanFactoryçš„,ä¹Ÿå°±æ˜¯æˆ‘ä»¬åé¢çš„refresh()æ–¹æ³•,å¯ä»¥çœ‹åˆ°DefaultListableBeanFactroyè¿™ä¸ªç±».</span></span><br><span class="line"><span class="comment"> å†å¾€çˆ¶ç±»èµ° : org.springframework.context.support.AbstractApplicationContext#AbstractApplicationContext()å°±ä¼šèµ°åˆ°è¿™ä¸ªç±»çš„è¿™ä¸ªæ–¹æ³•æ¥, this.resourcePatternResolver = getResourcePatternResolver(); è¿™é‡Œå¯ä»¥çœ‹åˆ°æ˜¯åˆå§‹åŒ–äº† resourcePatternResolver.å½“ç„¶äº†,è‚¯å®šè¿˜æœ‰ä¸€äº›newçš„å…¨å±€å˜é‡çš„åˆå§‹åŒ–ä¹Ÿä¼šè¿›è¡Œåˆå§‹åŒ–çš„.</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">AnnotationConfigApplicationContext</span><span class="params">()</span> &#123;</span><br><span class="line">   <span class="built_in">this</span>.reader = <span class="keyword">new</span> <span class="title class_">AnnotatedBeanDefinitionReader</span>(<span class="built_in">this</span>);</span><br><span class="line"><span class="comment">//è¿™ä¸ªæ–¹æ³•å¯¹registry,environmentå’ŒresourceLoaderè¿›è¡Œèµ‹å€¼,ç„¶åæ ¹æ®filteræ˜¯true,æ·»åŠ äº†ä¸‰ä¸ªfilterè¿‡æ»¤å™¨.å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ–¹æ³•è™½ç„¶å¸¦äº†scanneråå­—,ä½†æ˜¯çœ‹æ¯ä¸ªèµ°çš„æ–¹æ³•,å¥½åƒæ˜¯æ²¡æœ‰æ‰«æä»»ä½•ä¸œè¥¿,éƒ½æ˜¯å¯¹å…¨å±€å‚æ•°è¿›è¡Œèµ‹å€¼ç­‰æ“ä½œ.</span></span><br><span class="line">   <span class="built_in">this</span>.scanner = <span class="keyword">new</span> <span class="title class_">ClassPathBeanDefinitionScanner</span>(<span class="built_in">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">---------------------------------</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Create a new &#123;<span class="doctag">@code</span> AnnotatedBeanDefinitionReader&#125; for the given registry.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;If the registry is &#123;<span class="doctag">@link</span> EnvironmentCapable&#125;, e.g. is an &#123;<span class="doctag">@code</span> ApplicationContext&#125;,</span></span><br><span class="line"><span class="comment"> * the &#123;<span class="doctag">@link</span> Environment&#125; will be inherited, otherwise a new</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> StandardEnvironment&#125; will be created and used.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> registry the &#123;<span class="doctag">@code</span> BeanFactory&#125; to load bean definitions into,</span></span><br><span class="line"><span class="comment"> * in the form of a &#123;<span class="doctag">@code</span> BeanDefinitionRegistry&#125;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #AnnotatedBeanDefinitionReader(BeanDefinitionRegistry, Environment)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #setEnvironment(Environment)</span></span><br><span class="line"><span class="comment">è¿™é‡Œå¯ä»¥çœ‹åˆ°ä¼ å…¥è¿›æ¥çš„registryæ˜¯ this,ä¹Ÿå°±æ˜¯ä¼ å…¥äº†AnnotationConfigApplicationContextå®ƒè‡ªå·±. </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ–¹æ³•ä¸»è¦åšçš„äº‹æƒ…æ˜¯,åˆå§‹åŒ–Environment,ç„¶ånewä¸€ä¸ªConditionEvaluatorå¯¹è±¡,å…¶ä¿å­˜äº†äº”ä¸ªä¿¡æ¯. æœ€åå°±åˆ†åˆ«æ·»åŠ äº”ä¸ª Processoråˆ°beanFactroyçš„beanDefinitionMapä¸­æ¥.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">AnnotatedBeanDefinitionReader</span><span class="params">(BeanDefinitionRegistry registry)</span> &#123;</span><br><span class="line">        <span class="comment">// getOrCreateEnvironment()æ–¹æ³•,å…ˆå¯¹registryè¿›è¡Œénullçš„åˆ¤æ–­,å¦‚æœæ˜¯Nullçš„è¯,å°±ä¼šæŠ›å‡ºå¯¹åº”çš„å¼‚å¸¸.æœ€åæ˜¯new StandardEnvironment()äº†ä¸€ä¸ªå¯¹è±¡è¿”å›æ¥. registryæ˜¯æ»¡è¶³EnvironmentCapable</span></span><br><span class="line"><span class="comment">// this()æ–¹æ³•:å…ˆå¯¹ä¼ å…¥è¿›æ¥çš„registryå’Œenvironemntè¿›è¡Œénullçš„åˆ¤æ–­.this.registry = registry; ç´§ç€newäº†ä¸€ä¸ªConditionEvaluatorå¯¹è±¡,å…¶æ„é€ å‡½æ•°ä¸­,åˆå§‹åŒ–äº†registry,beanFactory,environment,resourceLoaderå’ŒclassLoaderè¿™äº”ä¸ªå‚æ•°,æ˜¯åœ¨å†…éƒ¨ç±»ConditionContextImplä¸­. æœ€åå¾€beanFactoryçš„beanDefinitionMapä¸­æ·»åŠ äº†äº”ä¸ªå€¼,åˆ†åˆ«æ˜¯:</span></span><br><span class="line"><span class="comment">//org.springframework.context.annotation.internalConfigurationAnnotationProcessor</span></span><br><span class="line"><span class="comment">//org.springframework.context.annotation.internalAutowiredAnnotationProcessor</span></span><br><span class="line"><span class="comment">//org.springframework.context.annotation.internalCommonAnnotationProcessor</span></span><br><span class="line"><span class="comment">//org.springframework.context.event.internalEventListenerProcessor</span></span><br><span class="line"><span class="comment">//org.springframework.context.event.internalEventListenerFactory  </span></span><br><span class="line"><span class="comment">//æ·»åŠ å®Œ,new AnnotatedBeanDefinitionReader()è¿™ä¸ªæ–¹æ³•å°±èµ°å®Œäº†.        </span></span><br><span class="line"><span class="built_in">this</span>(registry, getOrCreateEnvironment(registry));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">----------------------------------</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Create a new &#123;<span class="doctag">@code</span> ClassPathBeanDefinitionScanner&#125; for the given bean factory.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> registry the &#123;<span class="doctag">@code</span> BeanFactory&#125; to load bean definitions into, in the form</span></span><br><span class="line"><span class="comment"> * of a &#123;<span class="doctag">@code</span> BeanDefinitionRegistry&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">ClassPathBeanDefinitionScanner</span><span class="params">(BeanDefinitionRegistry registry)</span> &#123;</span><br><span class="line"><span class="built_in">this</span>(registry, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">ClassPathBeanDefinitionScanner</span><span class="params">(BeanDefinitionRegistry registry, <span class="type">boolean</span> useDefaultFilters)</span> &#123;</span><br><span class="line"><span class="comment">//è¿™é‡Œä¹Ÿæœ‰getOrCreateEnvironment()æ–¹æ³•æ¥è·å–ç¯å¢ƒ,åœ¨ä¸Šä¸€æ­¥å·²ç»åšäº†,æ‰€ä»¥è¿™æ­¥æ˜¯ç›´æ¥è·å–ä¸Šä¸€æ­¥çš„ç»“æœå³å¯.      </span></span><br><span class="line"><span class="built_in">this</span>(registry, useDefaultFilters, getOrCreateEnvironment(registry));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å…ˆå¯¹ä¼ å…¥è¿›æ¥çš„ registry è¿›è¡Œénullçš„åˆ¤æ–­,</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">ClassPathBeanDefinitionScanner</span><span class="params">(BeanDefinitionRegistry registry, <span class="type">boolean</span> useDefaultFilters,</span></span><br><span class="line"><span class="params">Environment environment, <span class="meta">@Nullable</span> ResourceLoader resourceLoader)</span> &#123;</span><br><span class="line"></span><br><span class="line">Assert.notNull(registry, <span class="string">&quot;BeanDefinitionRegistry must not be null&quot;</span>);</span><br><span class="line"><span class="built_in">this</span>.registry = registry;</span><br><span class="line"><span class="comment">// è¿™é‡Œä¼ å…¥çš„æ˜¯ture,ä¹Ÿå°±æ˜¯ä¼šèµ°åˆ°è¿™ä¸ªifé‡Œé¢æ¥.</span></span><br><span class="line"><span class="keyword">if</span> (useDefaultFilters) &#123;</span><br><span class="line"><span class="comment">//org.springframework.context.annotation.ClassPathScanningCandidateComponentProvider#registerDefaultFilters, å¾€includeFilters é›†åˆä¸­æ·»åŠ Filter,è¿™äº›æ·»åŠ çš„filter,ç‚¹è¿›å»çœ‹å³å¯.            </span></span><br><span class="line">registerDefaultFilters();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// this.environmentèµ‹ä¸Šä¼ å…¥è¿›æ¥çš„environmentå€¼.        </span></span><br><span class="line">setEnvironment(environment);</span><br><span class="line"><span class="comment">// org.springframework.core.io.support.ResourcePatternUtils#getResourcePatternResolverè¿›è¡Œåˆ¤æ–­,è¿™é‡Œç”±äºæ˜¯ResourcePatternResolver,æ‰€ä»¥åœ¨ç¬¬ä¸€ä¸ªifå°±è¿”å›äº†.</span></span><br><span class="line"><span class="comment">//æ¥ç€newä¸€ä¸ªCachingMetadataReaderFactory,ä¼ å…¥è¿›å»resourceLoader,newè¿™ä¸ªç±»çš„å†…éƒ¨ä¹Ÿæ˜¯å¯ä»¥çœ‹,å°±æ˜¯å¯¹å‚æ•°è¿›è¡Œèµ‹å€¼,å¹¶æ²¡æœ‰åšå…¶ä»–çš„ä»€ä¹ˆäº‹æƒ…äº†.      </span></span><br><span class="line"><span class="comment">//this.componentsIndex = CandidateComponentsIndexLoader.loadIndex(this.resourcePatternResolver.getClassLoader());è·å–å‡ºæ¥çš„å€¼Null.        </span></span><br><span class="line">setResourceLoader(resourceLoader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>scan(basePackages) æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¯¹ä¼ å…¥è¿›æ¥çš„å‚æ•°è¿›è¡Œä¸€ä¸ªæ ¡éªŒ.</span></span><br><span class="line"><span class="comment">//scannerä¹Ÿæ˜¯ä¸Šé¢é‚£æ­¥this.scanner = new ClassPathBeanDefinitionScanner(this)ç»™newå‡ºæ¥çš„.</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">scan</span><span class="params">(String... basePackages)</span> &#123;</span><br><span class="line">   Assert.notEmpty(basePackages, <span class="string">&quot;At least one base package must be specified&quot;</span>);</span><br><span class="line">   <span class="built_in">this</span>.scanner.scan(basePackages);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Perform a scan within the specified base packages.</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> basePackages the packages to check for annotated classes</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span> number of beans registered</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">scan</span><span class="params">(String... basePackages)</span> &#123;</span><br><span class="line"><span class="comment">// org.springframework.beans.factory.support.DefaultListableBeanFactory#getBeanDefinitionCount èµ°åˆ°è¿™æ­¥æ¥è·å–ä¸ªæ•°,è¿˜è®°å¾—new AnnotatedBeanDefinitionReader(this)è¿™ä¸ªæ–¹æ³•é‡Œé¢æ·»åŠ äº†äº”ä¸ªprocessorå—?æ‰€ä»¥è¿™é‡Œè·å–å‡ºæ¥çš„beanCountAtScanStartå¤§å°å°±æ˜¯5(é»˜è®¤å¯¹åˆå§‹åŒ–åšä»»ä½•æ”¹åŠ¨çš„æƒ…å†µä¸‹).</span></span><br><span class="line"><span class="type">int</span> <span class="variable">beanCountAtScanStart</span> <span class="operator">=</span> <span class="built_in">this</span>.registry.getBeanDefinitionCount();</span><br><span class="line"><span class="comment">//ä»åå­—ä¸Šçœ‹,è¿™ä¸ªæ–¹æ³•æ˜¯çœŸæ­£çš„åšæ‰«æçš„.å…¶å®Springä¸­,scanéƒ½ç®—ä¸åšäº‹çš„,doScanæ‰æ˜¯çœŸçš„åšäº‹çš„ã€‚åˆ°åé¢è¿˜æœ‰getBeanä¸æ˜¯åšäº‹çš„,doGetBeanæ‰æ˜¯åšäº‹çš„,createBeanä¹Ÿæ˜¯çš„. </span></span><br><span class="line"><span class="comment">//doScanåšçš„äº‹æƒ…å¯ä»¥çœ‹åˆ°,è¯»å–åŒ…ä¸‹çš„ç±»,ç„¶åæ ¹æ®filteræ¡ä»¶æ¥è¿‡æ»¤,æ»¡è¶³æ¡ä»¶çš„è¯,å°±ä¼šå°è£…æˆScannedGenericBeanDefinition,æœ€åæ˜¯ä¸€ä¸ªé›†åˆåŒ…è£…çš„è¯¥åŒ…ä¸‹å…¨éƒ¨æ»¡è¶³æ¡ä»¶çš„. ç„¶åå°±æ˜¯æ¥ç€å¯¹ sbdè¿›è¡Œæ³¨è§£çš„å¤„ç†,æ¯”å¦‚æœ‰äº›æ‰“å…¥äº†Lazyç­‰æ³¨è§£çš„,éƒ½è¦è¯»å–å‡ºæ¥,å­˜å…¥bdçš„ä¿¡æ¯ä¸­.æœ€åå†æ£€æŸ¥ä¸€édb,å¦‚æœæ²¡é—®é¢˜çš„è¯,å°±ä¼šæ ¹æ®beanNameå’Œbd,newä¸€ä¸ªBeanDefinitionHolderå‡ºæ¥,æœ€åæ³¨å†Œåˆ°beanFactoryä¸­å»,ä¹Ÿå°±æ˜¯æ”¾å…¥BeanFactoryçš„beanDeifitionMapä¸­å».    </span></span><br><span class="line">doScan(basePackages);</span><br><span class="line"><span class="comment">// Register annotation config processors, if necessary.</span></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">this</span>.includeAnnotationConfig) &#123;</span><br><span class="line"><span class="comment">// å…ˆè·å–å‡ºbeanFactory,å…ˆè°ƒç”¨beanFactoryçš„getDependencyComparatorå’ŒgetAutowireCandidateResolveræ–¹æ³•,å¦‚æœæ»¡è¶³æ¡ä»¶çš„è¯,å°±ä¼šæœ‰å¯¹åº”çš„setæ–¹æ³•.ç„¶åç´§æ¥ç€å°±æ˜¯åˆ¤æ–­beanFactoryä¸­æ˜¯å¦åŒ…å«ä¸€äº›bd,å¦‚æœæ˜¯ä¸åŒ…å«çš„è¯,è¿™é‡Œå°±ä¼šæ·»åŠ è¿›å». è¿™é‡Œåˆ¤æ–­çš„å€¼,å†æœ€åˆnew reader()çš„æ—¶å€™å·²ç»æœ‰æ·»åŠ åˆ°BeanFactoryçš„beanDifitionMapä¸­å».        </span></span><br><span class="line">AnnotationConfigUtils.registerAnnotationConfigProcessors(<span class="built_in">this</span>.registry);</span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">// è¿™é‡Œè¿”å›intå‚æ•°,ä½†æ˜¯ this.scanner.scan(basePackages); å¥½åƒå¹¶æ²¡æœ‰ä½¿ç”¨åˆ°è¿”å›å€¼.</span></span><br><span class="line"><span class="keyword">return</span> (<span class="built_in">this</span>.registry.getBeanDefinitionCount() - beanCountAtScanStart);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Perform a scan within the specified base packages,</span></span><br><span class="line"><span class="comment">* returning the registered bean definitions.</span></span><br><span class="line"><span class="comment">* &lt;p&gt;This method does &lt;i&gt;not&lt;/i&gt; register an annotation config processor</span></span><br><span class="line"><span class="comment">* but rather leaves this up to the caller.</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> basePackages the packages to check for annotated classes</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span> set of beans registered if any for tooling registration purposes (never &#123;<span class="doctag">@code</span> null&#125;)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> Set&lt;BeanDefinitionHolder&gt; <span class="title function_">doScan</span><span class="params">(String... basePackages)</span> &#123;</span><br><span class="line">    <span class="comment">// å…ˆæ˜¯å¯¹ä¼ å…¥è¿›æ¥çš„å‚æ•°è¿›è¡Œæ£€éªŒ.</span></span><br><span class="line">Assert.notEmpty(basePackages, <span class="string">&quot;At least one base package must be specified&quot;</span>);</span><br><span class="line">    <span class="comment">// å­˜BeanDefinitionHolderçš„é›†åˆ,ä¹Ÿæ˜¯æœ€åè¦è¿”å›çš„.</span></span><br><span class="line">Set&lt;BeanDefinitionHolder&gt; beanDefinitions = <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>&lt;&gt;();</span><br><span class="line"><span class="keyword">for</span> (String basePackage : basePackages) &#123;</span><br><span class="line"><span class="comment">//æ ¹æ®ä¼ å…¥è¿›å»çš„åŒ…åå­—,è¯»å–å‡ºåŒ…åå­—ä¸‹çš„æ‰€æœ‰æ–‡ä»¶,ç„¶åè¿­ä»£è¿™äº›æ–‡ä»¶,è¿™äº›æ–‡ä»¶è¦æœ‰èƒ½è¯»çš„æƒé™,å†èµ°isCandidateComponent(metadataReader)è¿™ä¸ªæ–¹æ³•,å…¶ä¸­å°±æœ‰ä½¿ç”¨ excludeFilterså’ŒincludeFilters,è¿™äºŒä¸ªfilteræ¥è¿‡æ»¤è¿›è¡Œä¸€äº›åˆ¤æ–­æ“ä½œ. è¿”å›ture,å°±ä¼šå¾€ä¸‹èµ°,newä¸€ä¸ªScannedGenericBeanDefinition,å…¶ä¸­beanClasså°±æ˜¯è¿™ä¸ªç±»çš„å…¨é™å®šåå­—.æ¯”å¦‚è¿™é‡Œ(com.iyang.spring.bean.YangBeanOne),æˆ‘ä»¬çš„æ˜¯è¿™ä¸ª.</span></span><br><span class="line"><span class="comment">//è¿™å°±æ˜¯è¿™ä¸ªæ–¹æ³•,æ‰«æ,ç„¶åæ ¹æ®ç‰¹å®šfilter,å¦‚æœæ˜¯æ»¡è¶³æ¡ä»¶çš„è¯,å°±ä¼šnewä¸€ä¸ªsbd,ç„¶åæ”¾å…¥Seté›†åˆä¸­,è¿”å›. </span></span><br><span class="line">Set&lt;BeanDefinition&gt; candidates = findCandidateComponents(basePackage);</span><br><span class="line">        </span><br><span class="line"><span class="keyword">for</span> (BeanDefinition candidate : candidates) &#123;</span><br><span class="line"><span class="comment">//org.springframework.context.annotation.AnnotationScopeMetadataResolver#resolveScopeMetadata,èµ°çš„è¿™ä¸ªæ–¹æ³•,å› AnnotationConfigUtils.attributesFor(...)æ–¹æ³•è¿”å›çš„æ˜¯null,æ‰€ä»¥è¿™ä¸ªé‡Œé¢å°±ä»…ä»…åªæ˜¯newäº†ä¸€ä¸ªScopeMetadataå¯¹è±¡è¿”å›äº†           </span></span><br><span class="line"><span class="type">ScopeMetadata</span> <span class="variable">scopeMetadata</span> <span class="operator">=</span> <span class="built_in">this</span>.scopeMetadataResolver.resolveScopeMetadata(candidate);</span><br><span class="line"><span class="comment">//scopeçš„å€¼æ˜¯singletone.è¿™ä¸å°±æ˜¯æˆ‘ä»¬ç†Ÿæ‚‰çš„å•ä¾‹å˜›.            </span></span><br><span class="line">candidate.setScope(scopeMetadata.getScopeName());</span><br><span class="line"><span class="comment">//è·å–å‡ºè¿™ä¸ªbeançš„åå­—            </span></span><br><span class="line"><span class="type">String</span> <span class="variable">beanName</span> <span class="operator">=</span> <span class="built_in">this</span>.beanNameGenerator.generateBeanName(candidate, <span class="built_in">this</span>.registry);</span><br><span class="line"><span class="comment">// dbæ˜¯ AbstractBeanDefinitionçš„è¯,è¿™é‡Œè‚¯å®šæ˜¯,ä»AbstractBeanDefinitionè¿™ä¸ªåå­—ä¸Šçœ‹,æ˜¯ä¸€ä¸ªæŠ½è±¡çš„ï¼Œä¹Ÿå°±æ˜¯åº”è¯¥æ˜¯çˆ¶ç±».            </span></span><br><span class="line"><span class="keyword">if</span> (candidate <span class="keyword">instanceof</span> AbstractBeanDefinition) &#123;</span><br><span class="line"><span class="comment">//beanDefinition.applyDefaults(this.beanDefinitionDefaults)è¯¥æ–¹æ³•æ˜¯å¯¹ä¸€äº›å‚æ•°è¿›è¡Œèµ‹å€¼æ“ä½œ. </span></span><br><span class="line"><span class="comment">//                </span></span><br><span class="line">postProcessBeanDefinition((AbstractBeanDefinition) candidate, beanName);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// bdæ˜¯AnnotatedBeanDefinitionæˆ–è€…å…¶å­ç±».            </span></span><br><span class="line"><span class="keyword">if</span> (candidate <span class="keyword">instanceof</span> AnnotatedBeanDefinition) &#123;</span><br><span class="line"><span class="comment">// è¯¥æ–¹æ˜¯å¯¹bdçš„Lazy.calss,Primary.class,DependsOn.class,Role.class,Description.classè¿™äº›æ³¨è§£è¿›è¡Œè·å–,å¦‚æœæœ‰çš„è¯,å°±ä¼šè°ƒç”¨bdå¯¹åº”çš„setæ–¹æ³•ç»™å€¼setè¿›å». å½“ç„¶æˆ‘ä»¬è¿™é‡Œçš„beanæ²¡æœ‰è¿™äº›å±æ€§.è¿™é‡Œå¯è‡ªè¡ŒåŠ å…¥ä¸€äº›æ³¨å…¥,ç„¶ådebugåˆ°è¿™ä¸ªåœ°æ–¹è¿›è¡Œçœ‹.</span></span><br><span class="line">                AnnotationConfigUtils.processCommonDefinitionAnnotations((AnnotatedBeanDefinition) candidate);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æ£€æŸ¥registryä¸­æ˜¯å¦å«æœ‰è¿™ä¸ªbeanName,å¦‚æœæ²¡åŒ…å«çš„è¯,å°±ç›´æ¥è¿”å›ture.            </span></span><br><span class="line"><span class="keyword">if</span> (checkCandidate(beanName, candidate)) &#123;</span><br><span class="line"><span class="comment">// ä¼ å…¥beanå’ŒbeanName, newä¸€ä¸ªbeançš„Holderå‡ºæ¥,ä¹Ÿå°±æ˜¯beançš„æŒæœ‰è€…çš„æ„æ€.å…¶å®ä¸ªäººè§‰å¾—è¿™é‡Œæ˜¯å¯¹beanè¿›è¡Œä¸€å±‚å°è£…,Holderæ›´æŠ½è±¡åœ°ç†è§£ç‚¹.                </span></span><br><span class="line"><span class="type">BeanDefinitionHolder</span> <span class="variable">definitionHolder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanDefinitionHolder</span>(candidate, beanName);</span><br><span class="line"><span class="comment">//scopeMetadataä¸­è·å–å‡ºgetScopedProxyMode,å¦‚æœæ˜¯Noçš„è¯,å°±ç›´æ¥è¿”å›definitionHolder         </span></span><br><span class="line">definitionHolder =</span><br><span class="line">AnnotationConfigUtils.applyScopedProxyMode(scopeMetadata, definitionHolder, <span class="built_in">this</span>.registry);</span><br><span class="line"><span class="comment">// æ·»åŠ åˆ°æœ€å¤–å±‚çš„é›†åˆä¸­                </span></span><br><span class="line">beanDefinitions.add(definitionHolder);</span><br><span class="line"><span class="comment">//org.springframework.beans.factory.support.DefaultListableBeanFactory#registerBeanDefinition,æœ€åèµ°åˆ°äº†è¿™é‡Œ,è¯¥æ–¹æ³•ä¼šå…ˆå¯¹ä¼ å…¥è¿›æ¥çš„å‚æ•°è¿›è¡Œénullçš„åˆ¤æ–­,å¦‚æœbdæ˜¯AbstractBeanDefinitionçš„è¯,å°±ä¼šå¼ºè½¬è°ƒç”¨å…¶validate()æ–¹æ³•,è¿›è¡Œæ£€éªŒ. åœ¨ä»this.beanDefinitionMapä¸­è·å–,æ ¹æ®beanName,ç¬¬ä¸€æ¬¡è‚¯å®šæ˜¯è·å–ä¸åˆ°çš„,èµ°åˆ°else.elseä¸­åœ¨åˆ¤æ–­hasBeanCreationStarted(),è¿™é‡Œè¿”å›çš„æ˜¯flase,ä¹Ÿå°±æ˜¯èµ°åˆ°äº†elseçš„elseä¸­å»äº†,æ ¹æ®beanNameå’Œbeanå­˜å…¥åˆ°this.beanDefinitionMapä¸­,ç„¶åbeanNameæ·»åŠ åˆ°beanDefinitionNamesé›†åˆä¸­.  è¿™å°±æ˜¯è¿™æ­¥æ ¹æ®beanNameå’Œbeanæ”¾å…¥beanFactoryçš„beanDefinitionMapé›†åˆä¸­.               </span></span><br><span class="line">registerBeanDefinition(definitionHolder, <span class="built_in">this</span>.registry);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> beanDefinitions;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><ul><li>this() æ–¹æ³• : è¯¥æ–¹æ³•ä¸­ä¸»è¦æ˜¯åˆå§‹åŒ–äº† this.reader å’Œ this.scannerè¿™ä¸ªå‚æ•°,å½“ç„¶äº†,å…¶ä¸­è¿˜æœ‰ä¸€äº›ç¯å¢ƒç­‰ä¿¡æ¯ çš„åˆå§‹åŒ–. this.readerçš„æ—¶å€™,æ˜¯æœ‰å¾€beanFactroyä¸­æ·»åŠ äº”ä¸ªé»˜è®¤è¦æ·»åŠ çš„bd,ä¹Ÿå°±æ˜¯æ·»åŠ åˆ°äº† BeanFactoryçš„BeanDefitionMapä¸­. this.scanner ä¹Ÿæ˜¯å¯¹ä¸€äº›ç¯å¢ƒç­‰ä¿¡æ¯åˆå§‹åŒ– , ç„¶åä¸‹æ¥æ¥çš„æ–¹æ³•å°±æ˜¯ä½¿ç”¨ this.scanneræ¥è¿›æ‰«æ class,ç„¶åæ»¡è¶³æ¡ä»¶çš„,å°±å°è£…æˆbd,æ³¨å†Œåˆ°beanFactoryä¸­å».</li><li>register() æ–¹æ³•é‡Œé¢è°ƒç”¨ this.reader.register(componentClasses); è¯¥æ–¹æ³•å°±æ˜¯è¯»å–åŒ…ä¸‹çš„classä¿¡æ¯,ç„¶åæ»¡è¶³æ¡ä»¶çš„å°±å°è£…æˆbd,åŒæ—¶è¿˜ä¼šå¯¹æ³¨è§£@Lazyç­‰ä¹Ÿä¼šè¯»å–,å¦‚æœæ˜¯æœ‰è¿™äº›æ³¨è§£çš„è¯,å°±ä¼šè°ƒç”¨bdå¯¹åº”çš„setæ–¹æ³•,ç»™èµ‹å€¼è¿›å»,æœ€åå°†bdç»™æ³¨å†Œåˆ°BeanFactoryçš„beanDefitionMapä¸­å»å³å¯.</li></ul><p>å¯ä»¥çœ‹åˆ° this() æ–¹æ³• å’Œ register()æ–¹æ³•,ä¸»è¦æ˜¯å¯¹ç¯å¢ƒçš„åˆå§‹åŒ–å’Œæ ¹æ®ä¼ å…¥è¿›æ¥çš„åŒ…åæ¥è¿›è¡Œæ‰«æè·å–classä¿¡æ¯,æ»¡è¶³æ¡ä»¶çš„classä¿¡æ¯å°±ä¼šè½¬åŒ–ä¸ºbd,ç„¶åæ³¨å†Œåˆ°beanFactoryä¸­å».</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;é˜…è¯»æ–¹æ³•&quot;&gt;&lt;a href=&quot;#é˜…è¯»æ–¹æ³•&quot; class=&quot;headerlink&quot; title=&quot;é˜…è¯»æ–¹æ³•&quot;&gt;&lt;/a&gt;é˜…è¯»æ–¹æ³•&lt;/h4&gt;&lt;p&gt;æœ€ç®€å•çš„é˜…è¯»æ–¹æ³•,å°±æ˜¯åˆ›å»ºä¸€ä¸ªmavené¡¹ç›®,è®©å¼•å…¥Springçš„ä¾èµ–. ç„¶åå†™ä¸Šä¸€ä¸ªmainæ–¹æ³•,æ¥è¯»å–åŒ…ä¸‹çš„å†…å®¹,ç„¶åå†™</summary>
      
    
    
    
    <category term="java" scheme="https://ruy9527.github.io/categories/java/"/>
    
    <category term="spring" scheme="https://ruy9527.github.io/categories/java/spring/"/>
    
    
    <category term="java" scheme="https://ruy9527.github.io/tags/java/"/>
    
    <category term="spring" scheme="https://ruy9527.github.io/tags/spring/"/>
    
  </entry>
  
  <entry>
    <title>ThreadLocalæºç é˜…è¯»</title>
    <link href="https://ruy9527.github.io/2021/11/04/java/ThreadLocal%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/"/>
    <id>https://ruy9527.github.io/2021/11/04/java/ThreadLocal%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/</id>
    <published>2021-11-03T16:15:45.000Z</published>
    <updated>2022-11-04T13:46:13.917Z</updated>
    
    <content type="html"><![CDATA[<p>ThreadLocal æ˜¯æ¥è¿™ä¸ªå…¬å¸æœ‰è¿‡ä½¿ç”¨ä¸€æ¬¡çš„æ„Ÿå—,æ‰€ä»¥å°±å­¦ä¹ é˜…è¯»ä¸‹æºç ã€‚ å…¶å®Thread è¿™ä¸ªé‡Œé¢,å°±æœ‰ä¸€ä¸ª Map(è¿™é‡Œæ˜¯ç”¨ThreadLocalå†…éƒ¨ç±»ä¸­å®ç°çš„) , é‡Œé¢çš„keyå°±æ˜¯ ThreadLocal, value å°±æ˜¯å­˜å‚¨çš„å€¼,æ‰€ä»¥ä¸€ä¸ªThreadæ˜¯æœ‰å¤šä¸ª ThreadLocalã€‚</p><hr><h4 id="å‚æ•°"><a href="#å‚æ•°" class="headerlink" title="å‚æ•°"></a>å‚æ•°</h4><p>å‚æ•°éƒ¨åˆ†</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">private final int threadLocalHashCode = nextHashCode();</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * The next hash code to be given out. Updated atomically. Starts at</span><br><span class="line"> * zero.</span><br><span class="line">   AtomicInteger æ˜¯ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„,å®ç°åŸç†æ˜¯é‡‡ç”¨äº†cas.</span><br><span class="line"> */</span><br><span class="line">private static AtomicInteger nextHashCode =</span><br><span class="line">    new AtomicInteger();</span><br></pre></td></tr></table></figure><h4 id="æ–¹æ³•"><a href="#æ–¹æ³•" class="headerlink" title="æ–¹æ³•"></a>æ–¹æ³•</h4><p>set èµ‹å€¼</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">*é¦–å…ˆè·å–å½“å‰çº¿ç¨‹.</span><br><span class="line">è°ƒç”¨ getMap æ–¹æ³•, ç›´æ¥è°ƒç”¨ t.trheadLocalsæ¥è·å– ThreadLocalMapã€‚(ThreadLocalMapè¿™é‡Œæ˜¯ThreadLocalå†…éƒ¨è‡ªå·±å®ç°çš„ç±»)</span><br><span class="line">å¦‚æœmapä¸æ˜¯nullçš„è¯,å°±è¿›è¡Œsetå€¼,è¿™é‡Œå¯ä»¥çœ‹åˆ° set çš„keyæ˜¯this,ä¹Ÿå°±æ˜¯ThreadLocalå®ƒè‡ªå·±.</span><br><span class="line">å¦åˆ™å°±æ˜¯è°ƒç”¨createMapæ–¹æ³•,èµ°è¿™ä¸ªæ–¹æ³•æ˜¯å¯ä»¥ç¡®è®¤ currentThreadä¸­çš„threadLocalsçš„å€¼æ˜¯null,æ‰€ä»¥ç›´æ¥newäº†ä¸€ä¸ªè¿›è¡Œèµ‹å€¼å³å¯.</span><br><span class="line">*/</span><br><span class="line">public void set(T value) &#123;</span><br><span class="line">    Thread t = Thread.currentThread();</span><br><span class="line">    ThreadLocalMap map = getMap(t);</span><br><span class="line">    if (map != null)</span><br><span class="line">        map.set(this, value);</span><br><span class="line">    else</span><br><span class="line">        createMap(t, value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ThreadLocalMap getMap(Thread t) &#123;</span><br><span class="line">        return t.threadLocals;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void createMap(Thread t, T firstValue) &#123;</span><br><span class="line">        t.threadLocals = new ThreadLocalMap(this, firstValue);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Get-æ–¹æ³•"><a href="#Get-æ–¹æ³•" class="headerlink" title="Get æ–¹æ³•"></a>Get æ–¹æ³•</h4><p>get æ–¹æ³•,è·å–å€¼.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">è¿™é‡Œå¯ä»¥çœ‹åˆ°,è·å–ThreadLocalMap,å¦‚æœThreadLocalMapçš„æ˜¯nullçš„è¯,å°±ä¼šèµ°setInitialValueæ–¹æ³•ã€‚</span><br><span class="line">å¦‚æœæœ‰å€¼çš„è¯,å°±ä¼šè¿›è¡Œè·å–å€¼å¹¶ä¸”è¿”å›.</span><br><span class="line">*/</span><br><span class="line">public T get() &#123;</span><br><span class="line">    Thread t = Thread.currentThread();</span><br><span class="line">    ThreadLocalMap map = getMap(t);</span><br><span class="line">    if (map != null) &#123;</span><br><span class="line">        ThreadLocalMap.Entry e = map.getEntry(this);</span><br><span class="line">        if (e != null) &#123;</span><br><span class="line">            @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">            T result = (T)e.value;</span><br><span class="line">            return result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return setInitialValue();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line">å¦‚æœè·å–å‡ºæ¥çš„ThreadLocalMap ä¸æ˜¯nullçš„è¯,å°±ä¼šè¿›è¡Œset,è¿™ä¸ªæ—¶å€™setè¿›å»çš„å€¼,valueå°±æ˜¯nulläº†.</span><br><span class="line">å¦‚æœè·å–å‡ºæ¥æ˜¯nulld</span><br><span class="line">*/</span><br><span class="line">private T setInitialValue() &#123;</span><br><span class="line">        T value = initialValue();</span><br><span class="line">        Thread t = Thread.currentThread();</span><br><span class="line">        ThreadLocalMap map = getMap(t);</span><br><span class="line">        if (map != null)</span><br><span class="line">            map.set(this, value);</span><br><span class="line">        else</span><br><span class="line">            createMap(t, value);</span><br><span class="line">        return value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">protected T initialValue() &#123;</span><br><span class="line">        return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="remove-æ–¹æ³•"><a href="#remove-æ–¹æ³•" class="headerlink" title="remove æ–¹æ³•"></a>remove æ–¹æ³•</h4><p>remove æ–¹æ³•å°±æ˜¯è·å–map,å¦‚æœmapä¸æ˜¯nullçš„è¯,å°±è°ƒç”¨m.remove(this)ï¼Œæ ¹æ®å½“å‰thisæ¥åˆ é™¤.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public void remove() &#123;</span><br><span class="line">    ThreadLocalMap m = getMap(Thread.currentThread());</span><br><span class="line">    if (m != null)</span><br><span class="line">        m.remove(this);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>ThreadLocalé‡Œé¢çš„æ–¹æ³•ä¹Ÿæ¯”è¾ƒå°‘,è¿˜æ˜¯æ¯”è¾ƒå¥½ç†è§£çš„ã€‚åªè¦å¼„æ¸…æ¥šThreadLocalå’ŒThreadæ˜¯æ€ä¹ˆåœ¨å­˜å‚¨çš„,å°±å¾ˆå¥½çš„ç†è§£äº†ã€‚</p><p>æ³¨æ„ : ä½¿ç”¨ThreadLocalä¸€å®šè¦è¿›è¡Œremove,å¦åˆ™å®¹æ˜“å‡ºç°å†…å­˜æ³„æ¼ï¼Œä»è€Œå¯¼è‡´å†…å­˜æº¢å‡ºã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;ThreadLocal æ˜¯æ¥è¿™ä¸ªå…¬å¸æœ‰è¿‡ä½¿ç”¨ä¸€æ¬¡çš„æ„Ÿå—,æ‰€ä»¥å°±å­¦ä¹ é˜…è¯»ä¸‹æºç ã€‚ å…¶å®Thread è¿™ä¸ªé‡Œé¢,å°±æœ‰ä¸€ä¸ª Map(è¿™é‡Œæ˜¯ç”¨ThreadLocalå†…éƒ¨ç±»ä¸­å®ç°çš„) , é‡Œé¢çš„keyå°±æ˜¯ ThreadLocal, value å°±æ˜¯å­˜å‚¨çš„å€¼,æ‰€ä»¥ä¸€ä¸ªThreadæ˜¯æœ‰å¤š</summary>
      
    
    
    
    <category term="java" scheme="https://ruy9527.github.io/categories/java/"/>
    
    <category term="javaçº¿ç¨‹" scheme="https://ruy9527.github.io/categories/java/java%E7%BA%BF%E7%A8%8B/"/>
    
    
    <category term="java" scheme="https://ruy9527.github.io/tags/java/"/>
    
    <category term="javaçº¿ç¨‹" scheme="https://ruy9527.github.io/tags/java%E7%BA%BF%E7%A8%8B/"/>
    
  </entry>
  
  <entry>
    <title>ReentrantLockæºç é˜…è¯»</title>
    <link href="https://ruy9527.github.io/2021/11/04/java/ReentrantLock%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/"/>
    <id>https://ruy9527.github.io/2021/11/04/java/ReentrantLock%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/</id>
    <published>2021-11-03T16:15:30.000Z</published>
    <updated>2022-11-04T13:46:13.917Z</updated>
    
    <content type="html"><![CDATA[<h4 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h4><p> ReetrantLock æ•ˆæœæ˜¯å’Œ synchronized æ˜¯ä¸€æ ·çš„,åªä¸è¿‡ synchronized æ˜¯å†…ç½®é”,ReetrantLockæ˜¯è¯­æ³•çº§åˆ«çš„é”, ç›¸å¯¹äºè€Œè¨€æ˜¯æ¯”synchronizedçµæ´»æ€§é«˜äº›. ä¸è¿‡ä»æˆ‘ç›®å‰å…¬å¸å†™ä»£ç è§’åº¦æ¥çœ‹,éƒ½æ˜¯ç›´æ¥ä½¿ç”¨ synchronized . ä½†æ˜¯ä¸å¦¨ç¢æˆ‘ä»¬æ¥çœ‹ ReetrantLock é‡Œé¢çš„ä»£ç å®ç°.</p><p> ä½¿ç”¨ä»£ç  : æœ‰lockæ–¹æ³•å°±ä¸€å®šè¦æœ‰ unlockæ–¹æ³•æ¥é‡Šæ”¾é”. ä¸€èˆ¬ä»£ç ä¸­è¿™æ ·å†™å³å¯.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public class ReentrantLockCaseMain &#123;</span><br><span class="line"></span><br><span class="line">    private ReentrantLock lock = new ReentrantLock();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public void lockUseCase()&#123;</span><br><span class="line"></span><br><span class="line">        lock.lock();</span><br><span class="line">        try &#123;</span><br><span class="line">            System.out.println(&quot;æ‰§è¡Œä¸šåŠ¡ä»£ç é€»è¾‘&quot;);</span><br><span class="line">        &#125;finally &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ä»£ç åˆ†æ"><a href="#ä»£ç åˆ†æ" class="headerlink" title="ä»£ç åˆ†æ"></a>ä»£ç åˆ†æ</h4><p> ReetrantLock ä¸­æ˜¯æ²¡æœ‰ä»€ä¹ˆå…¨å±€å‚æ•°,ç›¸æ¯”äºé›†åˆ,å°±æ²¡æœ‰é‚£ä¹ˆå¤šå…¨å±€å‚æ•°.ä½†æ˜¯æˆ‘ä»¬è¦çœ‹å…¶é‡Œé¢çš„å†…,è¿™é‡Œæœ‰ä¸‰ä¸ªç±», Sync , NonfairSync , FairSync. NonfairSyncå’ŒFairSync éƒ½æ˜¯æœ‰ç»§æ‰¿ Sync. å¯ä»¥çœ‹åˆ°NonfairSync æ˜¯éå…¬å¹³é” , FairSyncæ˜¯å…¬å¹³é”.</p><p> Sync åˆé›†æˆ AQS, ä½¿ç”¨ç‹¬å é”, é‡å†™äº† tryRelease æ–¹æ³•.</p><ul><li><p>æ„é€ å‡½æ•°: é»˜è®¤æ˜¯ä½¿ç”¨çš„éå…¬å¹³é”,å¦‚æœä¼ å…¥è¿›æ¥çš„æ˜¯trueå°±ä¼šä½¿ç”¨å…¬å¹³é”,å¦åˆ™å°±ä¼šä½¿ç”¨éå…¬å¹³é”.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> /**</span><br><span class="line"> * Creates an instance of &#123;@code ReentrantLock&#125;.</span><br><span class="line"> * This is equivalent to using &#123;@code ReentrantLock(false)&#125;.</span><br><span class="line"> */</span><br><span class="line">public ReentrantLock() &#123;</span><br><span class="line">    sync = new NonfairSync();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Creates an instance of &#123;@code ReentrantLock&#125; with the</span><br><span class="line"> * given fairness policy.</span><br><span class="line"> *</span><br><span class="line"> * @param fair &#123;@code true&#125; if this lock should use a fair ordering policy</span><br><span class="line"> */</span><br><span class="line">public ReentrantLock(boolean fair) &#123;</span><br><span class="line">    sync = fair ? new FairSync() : new NonfairSync();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>lock æ–¹æ³•: lockæ–¹æ³•æ˜¯åŠ é”çš„æ–¹æ³•</p><p>lockæ–¹æ³•æ˜¯è°ƒç”¨çš„ Sync çš„lockæ–¹æ³•, ç„¶åæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸Šé”çš„æ—¶å€™,èµ°çš„Sync,ç„¶åæ ¹æ®FairSync&#x2F;NonfairSyncå–èµ°å„è‡ªçš„åŠ é”æ–¹æ³•,æ‰€ä»¥è¯´å…¬å¹³é”å’Œéå…¬å¹³é”æ˜¯åŠ é”çš„æ–¹å¼æ˜¯ä¸ä¸€æ ·çš„.</p></li></ul><p>éå…¬å¹³é”è·å–é”çš„æ—¶å€™,ä¼šè·å–stateè¿™ä¸ªçŠ¶æ€æ ‡è¯†,ç„¶åå†å»èµ°å¯¹åº”çš„é€»è¾‘,è¿™é‡Œå¤šäº†æ¯”éå…¬å¹³é”å¤šäº†ä¸€ä¸ªä»é˜Ÿåˆ—ä¸­è·å–ä¿¡æ¯å’Œä¸èƒ½è·å–é”çš„çº¿ç¨‹å°±ä¼šè¢«æŒ‚èµ·è¿›å…¥é˜Ÿåˆ—ä¸­æ’é˜Ÿ.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line">public void lock() &#123;    sync.lock();&#125;</span><br><span class="line"></span><br><span class="line">// Sync </span><br><span class="line">abstract void lock();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">    * å…¬å¹³é”</span><br><span class="line">     * Sync object for fair locks</span><br><span class="line">     */</span><br><span class="line">tatic final class FairSync extends Sync &#123;</span><br><span class="line">        private static final long serialVersionUID = -3000897897090466540L;</span><br><span class="line"></span><br><span class="line">    /* </span><br><span class="line">    acquire(1) è°ƒç”¨åˆ°AQSä¸­,æœ€åè¿˜æ˜¯è°ƒç”¨åˆ°ä¸‹é¢çš„tryAcquireæ–¹æ³•.</span><br><span class="line">    é‚£äº›æ²¡æœ‰è·å–åˆ°é”çš„çº¿ç¨‹,å°±ä¼šæŒ‰ç…§é˜Ÿåˆ—çš„æ–¹å¼æ’é˜Ÿ,æ»¡è¶³å…ˆè¿›å…ˆå‡ºçš„æ•ˆæœçš„,ä¹Ÿå°±æ˜¯å…ˆæ¥çš„çº¿ç¨‹å…ˆæ‰§è¡Œ,</span><br><span class="line">    æœç„¶è¿™å°±å¾ˆå…¬å¹³</span><br><span class="line">    **/</span><br><span class="line">        final void lock() &#123;</span><br><span class="line">            acquire(1);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        /**</span><br><span class="line">         * Fair version of tryAcquire.  Don&#x27;t grant access unless</span><br><span class="line">         * recursive call or no waiters or is first.</span><br><span class="line">         */</span><br><span class="line">        protected final boolean tryAcquire(int acquires) &#123;</span><br><span class="line">            final Thread current = Thread.currentThread();</span><br><span class="line">            int c = getState();</span><br><span class="line">            if (c == 0) &#123;</span><br><span class="line">                /**</span><br><span class="line">                hasQueuedPredecessors() æ–¹æ³•,å…ˆåˆ¤æ–­å¤´ç»“ç‚¹å’Œå°¾ç»“ç‚¹æ˜¯ä¸ç›¸ç­‰çš„,å› ä¸ºç›¸ç­‰çš„è¯,å°±é‡å¤äº†,å°±æ˜¯åŒä¸€ä¸ª. ç„¶ååœ¨åˆ¤æ–­å¤´ç»“ç‚¹çš„ threadæ˜¯ä¸æ˜¯å½“å‰çº¿ç¨‹,å¦‚æœä¸æ˜¯å½“å‰çš„å‰ç¨‹çš„è¯,é‚£ä¹ˆå°±æ˜¯åœ¨è¿™ä¸ªçº¿ç¨‹é’±é¢è¿˜æœ‰ä¸€ä¸ªç­‰å¾…è·å–é”æ—¶é—´æ›´ä¹…çš„çº¿ç¨‹,äºæ˜¯å°±å…ˆæŠ›å¼ƒè¿™ä¸ªçº¿ç¨‹,å»æ‰§è¡Œé‚£ä¸ªç­‰å¾…æ›´ä¹…çš„çº¿ç¨‹.</span><br><span class="line">                </span><br><span class="line">                compareAndSetState å°±æ˜¯ç”¨casæ¥è·å–é”çš„ä»£ç ,å¦‚æœè·å–æˆåŠŸçš„è¯,å°±ä¼šèµ°setExclusiveOwnerThreadæ–¹æ³•,è¿™é‡Œsetè¿›å»çš„å€¼æ˜¯åœ¨é‡Šæ”¾é”çš„æ—¶å€™ä¼šç”¨åˆ°.</span><br><span class="line">                æœ€åè¿”å›true,è¯´æ˜è·å–é”æˆåŠŸäº†.</span><br><span class="line">                */</span><br><span class="line">                if (!hasQueuedPredecessors() &amp;&amp;</span><br><span class="line">                    compareAndSetState(0, acquires)) &#123;</span><br><span class="line">                    setExclusiveOwnerThread(current);</span><br><span class="line">                    return true;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            /**</span><br><span class="line">            è·å–ä»setExclusiveOwnerThreadé‡Œé¢çš„thread,æ¥åˆ¤æ–­æ˜¯å¦ä¸å½“å‰çº¿ç¨‹ç›¸ç­‰,å¦‚æœç›¸ç­‰çš„è¯,å°±è¯´æ˜é‡å…¥äº†.</span><br><span class="line">            */</span><br><span class="line">            else if (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">                int nextc = c + acquires;</span><br><span class="line">                if (nextc &lt; 0)</span><br><span class="line">                    throw new Error(&quot;Maximum lock count exceeded&quot;);</span><br><span class="line">                setState(nextc);</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;ä¹‹å‰</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public final boolean hasQueuedPredecessors() &#123;</span><br><span class="line">        // The correctness of this depends on head being initialized</span><br><span class="line">        // before tail and on head.next being accurate if the current</span><br><span class="line">        // thread is first in queue.</span><br><span class="line">        Node t = tail; // Read fields in reverse initialization order</span><br><span class="line">        Node h = head;</span><br><span class="line">        Node s;</span><br><span class="line">        return h != t &amp;&amp;</span><br><span class="line">            ((s = h.next) == null || s.thread != Thread.currentThread());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line">éå…¬å¹³é”:</span><br><span class="line">*/</span><br><span class="line">static final class NonfairSync extends Sync &#123;</span><br><span class="line">        private static final long serialVersionUID = 7316153563782823691L;</span><br><span class="line"></span><br><span class="line">        /**</span><br><span class="line">         * Performs lock.  Try immediate barge, backing up to normal</span><br><span class="line">         * acquire on failure.</span><br><span class="line">         å¯ä»¥çœ‹åˆ°éå…¬å¹³é”æ˜¯æ²¡æœ‰ä»é˜Ÿåˆ—ä¸­è·å–è¯´æ˜ç»“ç‚¹ä¿¡æ¯,è€Œæ˜¯ç›´æ¥è·å–é”çš„.</span><br><span class="line">         è·å–æˆåŠŸäº†å°±ä¼šèµ° setExclusiveOwnerThread æ–¹æ³•</span><br><span class="line">         */</span><br><span class="line">        final void lock() &#123;</span><br><span class="line">            if (compareAndSetState(0, 1))</span><br><span class="line">                setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">            else</span><br><span class="line">                acquire(1);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        protected final boolean tryAcquire(int acquires) &#123;</span><br><span class="line">            return nonfairTryAcquire(acquires);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line">Syncç±»ä¸­</span><br><span class="line">è¿™æ®µä»£ç çš„é€»è¾‘ä¹Ÿæ˜¯å’Œ å…¬å¹³é”åæ¥çš„å¤„ç†ä¸€æ ·çš„äº†. cå¦‚æœæ˜¯0çš„è¯,å°±ä¼šèµ°è·å–é”çš„ä»£ç ,å¦‚æœä¸æ˜¯0çš„è¯,å°±è¯´æ˜é‡å…¥äº†,æ‰€ä»¥å°±++</span><br><span class="line">*/</span><br><span class="line">final boolean nonfairTryAcquire(int acquires) &#123;</span><br><span class="line">            final Thread current = Thread.currentThread();</span><br><span class="line">            int c = getState();</span><br><span class="line">            if (c == 0) &#123;</span><br><span class="line">                if (compareAndSetState(0, acquires)) &#123;</span><br><span class="line">                    setExclusiveOwnerThread(current);</span><br><span class="line">                    return true;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            else if (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">                int nextc = c + acquires;</span><br><span class="line">                if (nextc &lt; 0) // overflow</span><br><span class="line">                    throw new Error(&quot;Maximum lock count exceeded&quot;);</span><br><span class="line">                setState(nextc);</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">            return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>unlockæ–¹æ³•: unlockæ˜¯é‡Šæ”¾é”çš„æ–¹æ³•. å¯ä»¥çœ‹åˆ°é‡Šæ”¾é”æ˜¯èµ°çš„ Syncçš„releaseæ–¹æ³•,æ‰€ä»¥ä¸ç®¡å…¬å¹³é”è¿˜æ˜¯éå…¬å¹³é”èµ·èµ°çš„é‡Šæ”¾é”æ–¹æ³•æ˜¯ä¸ä¸€æ ·çš„.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">public void unlock() &#123;    sync.release(1);&#125;  </span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line">Sync ä¸­æ–¹æ³•. </span><br><span class="line">*/</span><br><span class="line">public final boolean release(int arg) &#123;</span><br><span class="line">        // tryRelease()æ–¹æ³•è¿”å›trueçš„è¯,å°±è¯´æ˜é”éƒ½é‡Šæ”¾å®Œäº†.</span><br><span class="line">        </span><br><span class="line">        if (tryRelease(arg)) &#123;</span><br><span class="line">            Node h = head;</span><br><span class="line">            // æ¢å¤çº¿ç¨‹</span><br><span class="line">            if (h != null &amp;&amp; h.waitStatus != 0)</span><br><span class="line">                unparkSuccessor(h);</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">protected final boolean tryRelease(int releases) &#123;</span><br><span class="line">            // é‡Šæ”¾é”</span><br><span class="line">            int c = getState() - releases;</span><br><span class="line">            // å¦‚æœå½“å‰çº¿ç¨‹ä¸æ˜¯è‡ªå·±çš„è¯,å°±ä¼šæŠ›å‡ºå¼‚å¸¸.è¿™é‡Œå¯ä»¥ç†è§£ä¸º,ç‹¬å é”,è‚¯å®šæ˜¯è‡ªå·±.</span><br><span class="line">            // ä¹Ÿå°±æ˜¯è¯´,å¦‚æœä¸æ˜¯ç‹¬å é”çš„è¯,å°±ä¼šæŠ›å‡ºå¼‚å¸¸.</span><br><span class="line">            if (Thread.currentThread() != getExclusiveOwnerThread())</span><br><span class="line">                throw new IllegalMonitorStateException();</span><br><span class="line">            boolean free = false;</span><br><span class="line">            // å¦‚æœä½ è°ƒç”¨äº†ä¸€æ¬¡lockçš„è¯,é‚£ä¹ˆä¼šåŠ ä¸€,æ‰€ä»¥è¿™ä¸ªåœ°æ–¹è¦ç­‰è¿™ä¸ªlockæ–¹æ³•å…¨éƒ¨è¢«é‡Šæ”¾æ‰.</span><br><span class="line">    // ä¹Ÿå°±æ˜¯ç”±äºé‡å…¥é”çš„åŸå› .</span><br><span class="line">            if (c == 0) &#123;</span><br><span class="line">                free = true;</span><br><span class="line">                // é‡Šæ”¾å®Œäº†,å°±è®¾ç½®äº†null.  </span><br><span class="line">                // ç„¶åAbstractOwnableSynchronizerä¸­çš„threadæ ‡è®°ä¹Ÿå°±æ˜¯null,</span><br><span class="line">                // æ‰€ä»¥ä¸‹ä¸ªçº¿ç¨‹åˆ¤æ–­æ˜¯nullçš„è¯,å°±å¯ä»¥è·å–åˆ°æ‰§è¡Œæƒ,ä¹Ÿå°±æ˜¯è·å–åˆ°é”.</span><br><span class="line">                setExclusiveOwnerThread(null);</span><br><span class="line">            &#125;</span><br><span class="line">            setState(c);</span><br><span class="line">            return free;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>isLocked () æ–¹æ³•, åˆ¤æ–­è¿™ä¸ªçº¿ç¨‹æ˜¯ä¸æ˜¯è¢«é”äº†:</p><p>è°ƒç”¨Syncä¸­isLockæ–¹æ³•,å¦‚æœä¸æ˜¯0çš„è¯,å°±è¯´æ˜æ˜¯è¢«é”äº†,å¦‚æœæ˜¯0çš„è¯,å°±è¯´æ˜æ²¡æœ‰è¢«é”.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Queries if this lock is held by any thread. This method is</span></span><br><span class="line"><span class="comment">     * designed for use in monitoring of the system state,</span></span><br><span class="line"><span class="comment">     * not for synchronization control.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> true&#125; if any thread holds this lock and</span></span><br><span class="line"><span class="comment">     *         &#123;<span class="doctag">@code</span> false&#125; otherwise</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isLocked</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sync.isLocked();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">isLocked</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> getState() != <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>hasQueuedThreads() : æ˜¯å¦æœ‰çº¿ç¨‹åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­</p><p>hasQueuedThread(Thread thread) : çº¿ç¨‹æ˜¯å¦åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­</p><p>getQueueLength() : è·å–é˜Ÿåˆ—ä¸­çº¿ç¨‹ä¸ªæ•°</p><p>ç­‰è¿™äº›æ–¹æ³•éƒ½æ˜¯æ¯”è¾ƒå¥½ç†è§£çš„,å¯ä»¥è‡ªè¡Œç‚¹è¿›å»ä»”ç»†çœ‹ä¸‹.</p><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> Sync  /  NonfairSync  /  FairSync  è¿™ä¸ªä¸‰ä¸ªç±»å°±æ˜¯ ReetrantLockä¸­çš„ä¸‰ä¸ªç±»,éƒ½æ˜¯å›´ç»•è¿™è¿™ä¸‰ä¸ªç±»åœ¨åšæ–‡ç« .</span><br><span class="line"></span><br><span class="line">å…¬å¹³é”å’Œéå…¬å¹³é”çš„è·å–é”æ–¹å¼ä¸ä¸€æ ·,ä½†æ˜¯é‡Šæ”¾æ–¹å¼æ˜¯ä¸€æ ·çš„. å…¬å¹³é”è·å–é”çš„æ—¶å€™,å¦‚æœæœ‰çº¿ç¨‹æŒæœ‰äº†çš„è¯</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;ä»‹ç»&quot;&gt;&lt;a href=&quot;#ä»‹ç»&quot; class=&quot;headerlink&quot; title=&quot;ä»‹ç»&quot;&gt;&lt;/a&gt;ä»‹ç»&lt;/h4&gt;&lt;p&gt; ReetrantLock æ•ˆæœæ˜¯å’Œ synchronized æ˜¯ä¸€æ ·çš„,åªä¸è¿‡ synchronized æ˜¯å†…ç½®é”,ReetrantLoc</summary>
      
    
    
    
    <category term="java" scheme="https://ruy9527.github.io/categories/java/"/>
    
    <category term="javaçº¿ç¨‹" scheme="https://ruy9527.github.io/categories/java/java%E7%BA%BF%E7%A8%8B/"/>
    
    
    <category term="java" scheme="https://ruy9527.github.io/tags/java/"/>
    
    <category term="javaçº¿ç¨‹" scheme="https://ruy9527.github.io/tags/java%E7%BA%BF%E7%A8%8B/"/>
    
  </entry>
  
  <entry>
    <title>PriorityQueueæºç é˜…è¯»è®°å½•</title>
    <link href="https://ruy9527.github.io/2021/11/04/java/PriorityQueue%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E8%AE%B0%E5%BD%95/"/>
    <id>https://ruy9527.github.io/2021/11/04/java/PriorityQueue%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E8%AE%B0%E5%BD%95/</id>
    <published>2021-11-03T16:15:16.000Z</published>
    <updated>2022-11-04T13:46:13.917Z</updated>
    
    <content type="html"><![CDATA[<p>PriorityQueue : ä¸­æ–‡æ˜¯ä¼˜å…ˆé˜Ÿåˆ— , é˜Ÿåˆ—çš„ç‰¹ç‚¹å°±æ˜¯æ•°æ® å…ˆè¿›å…ˆå‡º, ä½†æ˜¯è¿™ä¸ªä¼˜å…ˆé˜Ÿåˆ—çš„ç‰¹åˆ«æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ é¦–å…ˆè‚¯å®šæ˜¯æœ‰é˜Ÿåˆ—çš„åŸºæœ¬ç‰¹ç‚¹ï¼Œä¹Ÿå°±æ˜¯æœ‰å…ˆè¿›å…ˆå‡ºã€‚ å¦‚æœæ˜¯å…ˆè¿›å…ˆå‡ºçš„è¯,é‚£ä¹ˆå°±å’Œæ™®é€šçš„æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿä¼˜å…ˆäºŒå­—åˆæ˜¯ä½“ç°åœ¨ä»€ä¹ˆåœ°æ–¹å‘¢ï¼Ÿ ä¼˜å…ˆçº§é˜Ÿåˆ—çš„å…ƒç´ æŒ‰ç…§å…¶è‡ªç„¶é¡ºåºè¿›è¡Œæ’åº, æˆ–è€…æ ¹æ® æ„é€ é˜Ÿåˆ—æ—¶æä¾›çš„ Comparator è¿›è¡Œæ’åº.</p><hr><h4 id="ç»“æ„"><a href="#ç»“æ„" class="headerlink" title="ç»“æ„"></a>ç»“æ„</h4><p> ç»“æ„å°±æ˜¯ PriorityQueueè¿™ä¸ªç±»çš„ å…¨å±€å˜é‡å‚æ•°, å› ä¸ºè¿™äº›å‚æ•°æ˜¯å­˜å‚¨æ•°æ®çš„, æ‰€ä»¥åªè¦ç†è§£äº†è¿™äº›å‚æ•°,å°±æ˜ç™½äº†è¿™ä¸ª PriorityQueueè¿™ä¸ªæ˜¯å¯¹æ•°æ®æ˜¯æ€ä¹ˆæ ·è¿›è¡Œå­˜å‚¨çš„, è¿˜æ˜¯æ¯”è¾ƒå¥½ç†è§£çš„.</p><p>è¿™é‡Œå¯ä»¥çœ‹åˆ° priorityQueueçš„æ•°æ®ç»“æ„è¿˜æ˜¯å¾ˆç®€å•çš„, ä¸€çœ¼æ‰«è¿‡å»æ²¡ä»€ä¹ˆéœ€è¦ç‰¹åˆ«çš„ç†è§£</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// å­˜å‚¨æ•°æ®çš„æ•°ç»„</span><br><span class="line">transient Object[] queue;</span><br><span class="line"></span><br><span class="line">// è®°å½• priorityQueueçš„é•¿åº¦</span><br><span class="line">private int size = 0;</span><br><span class="line"></span><br><span class="line">// è¿™ä¸ªå°±æ˜¯ä¹‹å‰è¯´æåˆ°çš„  å¯ä»¥æ ¹æ® Comparator è¿›è¡Œæ’åº</span><br><span class="line">private final Comparator&lt;? super E&gt; comparator;</span><br></pre></td></tr></table></figure><hr><h4 id="æ„é€ æ–¹æ³•"><a href="#æ„é€ æ–¹æ³•" class="headerlink" title="æ„é€ æ–¹æ³•"></a>æ„é€ æ–¹æ³•</h4><p> priorityQueueçš„æ„é€ æ–¹æ³•ç›¸å¯¹äºå…¶ä»–çš„é›†åˆçš„æ„é€ æ–¹æ³•å¯èƒ½æ˜¯æ¯”è¾ƒå¤šçš„.</p><p> è¿™é‡Œåˆ—ä¸¾å‡ºæ¥, å¯ä»¥çœ‹åˆ°æ„é€ æ–¹æ³•è¿˜æ˜¯æ¯”è¾ƒå¤šçš„.</p><p> å¯¹æ„é€ å‡½æ•°çš„åˆå§‹åŒ–èµ‹å€¼ç­‰æ“ä½œè¿˜æ˜¯å¾ˆå¥½ç†è§£çš„,å¹¶æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«éš¾ç†è§£çš„ã€‚ ä¸»è¦è¿˜æ˜¯å¯¹æ•°ç»„&#x2F;é•¿åº¦&#x2F;æˆ–è€…ä¼ å…¥è¿›æ¥çš„æ•°ç»„è¿›è¡Œèµ‹å€¼æ“ä½œ.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line">// 1   </span><br><span class="line">// è¿™é‡Œæ˜¯èµ°åˆ° 4 çš„æ„é€ æ–¹æ³•å»äº†</span><br><span class="line">public PriorityQueue() &#123;</span><br><span class="line">    this(DEFAULT_INITIAL_CAPACITY, null);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 2</span><br><span class="line">// è¿™é‡Œæ˜¯èµ°åˆ° 4 çš„æ„é€ æ–¹æ³•å»äº†</span><br><span class="line">public PriorityQueue(int initialCapacity) &#123;</span><br><span class="line">        this(initialCapacity, null);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 3</span><br><span class="line">// è¿™é‡Œæ˜¯èµ°åˆ° 4 çš„æ„é€ æ–¹æ³•å»äº†</span><br><span class="line">public PriorityQueue(Comparator&lt;? super E&gt; comparator) &#123;</span><br><span class="line">        this(DEFAULT_INITIAL_CAPACITY, comparator);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 4 </span><br><span class="line">/**  å¯ä»¥çœ‹åˆ°å‰é¢çš„ä¸‰ä¸ªéƒ½æ˜¯èµ°åˆ°äº†è¿™é‡Œæ¥äº†,</span><br><span class="line"> é•¿åº¦å¦‚æœæ˜¯å°äº1çš„è¯,å°±ä¼šæŠ¥é”™.  </span><br><span class="line">     this.queue çš„æ•°ç»„é•¿åº¦å°±æ˜¯ initialCapacity</span><br><span class="line">     comparator æ’åºæ–¹æ³•å°±æ˜¯ä¼ å…¥è¿›æ¥çš„</span><br><span class="line">*/</span><br><span class="line">public PriorityQueue(int initialCapacity,</span><br><span class="line">                         Comparator&lt;? super E&gt; comparator) &#123;</span><br><span class="line">        // Note: This restriction of at least one is not actually needed,</span><br><span class="line">        // but continues for 1.5 compatibility</span><br><span class="line">        if (initialCapacity &lt; 1)</span><br><span class="line">            throw new IllegalArgumentException();</span><br><span class="line">        this.queue = new Object[initialCapacity];</span><br><span class="line">        this.comparator = comparator;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 5</span><br><span class="line">/**  å¯¹ä¼ å…¥è¿›æ¥çš„é›†åˆè¿›è¡Œåˆ¤æ–­. åˆ†ä¸º   SortedSet  æˆ–è€…  PriorityQueue  æˆ–è€…å…¶ä»–</span><br><span class="line">     å¦‚æœæ˜¯ SortedSet çš„è¯, å¯¹ comparator çš„å€¼èµ‹å€¼ä¸º ä¼ å…¥è¿›æ¥é›†åˆçš„æ’åºæ–¹å¼,ç„¶åèµ° initElementsFromCollection() æ–¹æ³•, è¿™é‡Œåº”è¯¥æ˜¯å¯¹é›†åˆè¿›è¡Œèµ‹å€¼æ“ä½œ.</span><br><span class="line">     å¦‚æœæ˜¯ PriorityQueue , comparator å¤„ç†æ–¹å¼æ˜¯å’Œ SortedSetä¸€æ ·,ç„¶åèµ° initFromPriorityQueue æ–¹æ³•. </span><br><span class="line">     å¦åˆ™å°±ä¸ä¸Šé¢çš„äºŒç§, comparator å¤ç½®ä¸º null ,èµ° initFromCollection æ–¹æ³•.</span><br><span class="line">     è¿™é‡Œæ€»ç»“çš„è¯,å°±æ˜¯ä¼ å…¥è¿›æ¥ä¸åŒçš„é›†åˆ,èµ°çš„æ–¹æ³•ä¹Ÿæ˜¯ä¸ä¸€æ ·çš„,è¿™ä¸ªè¿˜æ˜¯å¾ˆå¥½ç†è§£çš„.</span><br><span class="line"></span><br><span class="line">*/</span><br><span class="line">public PriorityQueue(Collection&lt;? extends E&gt; c) &#123;</span><br><span class="line">        if (c instanceof SortedSet&lt;?&gt;) &#123;</span><br><span class="line">            SortedSet&lt;? extends E&gt; ss = (SortedSet&lt;? extends E&gt;) c;</span><br><span class="line">            this.comparator = (Comparator&lt;? super E&gt;) ss.comparator();</span><br><span class="line">            initElementsFromCollection(ss);</span><br><span class="line">        &#125;</span><br><span class="line">        else if (c instanceof PriorityQueue&lt;?&gt;) &#123;</span><br><span class="line">            PriorityQueue&lt;? extends E&gt; pq = (PriorityQueue&lt;? extends E&gt;) c;</span><br><span class="line">            this.comparator = (Comparator&lt;? super E&gt;) pq.comparator();</span><br><span class="line">            initFromPriorityQueue(pq);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            this.comparator = null;</span><br><span class="line">            initFromCollection(c);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 6  è¿™ä¸ªå¯¹åº”ä¸Šé¢çš„, å¦‚æœæ˜¯ä¼ å…¥è¿›æ¥ PriorityQueue çš„å¤„ç†æ–¹æ³•</span><br><span class="line">public PriorityQueue(PriorityQueue&lt;? extends E&gt; c) &#123;</span><br><span class="line">        this.comparator = (Comparator&lt;? super E&gt;) c.comparator();</span><br><span class="line">        initFromPriorityQueue(c);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 7  è¿™ä¸ªä¹Ÿæ˜¯å¯¹åº”ä¸Šé¢çš„ SortedSet å¤„ç†æ–¹æ³•</span><br><span class="line">public PriorityQueue(SortedSet&lt;? extends E&gt; c) &#123;</span><br><span class="line">        this.comparator = (Comparator&lt;? super E&gt;) c.comparator();</span><br><span class="line">        initElementsFromCollection(c);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">----------------------   åä¸½åˆ†å‰²çº¿   --------------------</span><br><span class="line">ä¸Šé¢çš„if else é‡Œé¢æåˆ°çš„èµ°ä¸åŒçš„æ–¹æ³•,è¿˜æ˜¯æœ‰å¿…è¦å–çœ‹çœ‹çš„. </span><br><span class="line">    </span><br><span class="line">/**</span><br><span class="line">  å¯¹ä¼ å…¥è¿›æ¥æ˜¯  PriorityQueue  è¿›è¡Œå¤„ç†, å…ˆåˆ¤æ–­ç¡®è®¤ classæ˜¯PriorityQueue ,æ˜¯çš„è¯,è°ƒç”¨toArray() å°†æ•°ç»„èµ‹å€¼ç»™ queue , å¹¶ä¸”é•¿åº¦ä¹Ÿè¿›è¡Œå¤ç½®ç»™size.</span><br><span class="line">  å¦åˆ™å°±èµ°  initFromCollection æ–¹æ³•, è¿™ä¸ª if else è¿˜æ˜¯æ¯”è¾ƒä¸¥è°¨çš„.è¿›è¡Œå¤šæ¬¡åˆ¤æ–­å¤„ç†</span><br><span class="line">*/    </span><br><span class="line">private void initFromPriorityQueue(PriorityQueue&lt;? extends E&gt; c) &#123;</span><br><span class="line">        if (c.getClass() == PriorityQueue.class) &#123;</span><br><span class="line">            this.queue = c.toArray();</span><br><span class="line">            this.size = c.size();</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            initFromCollection(c);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;    </span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line">   è¿™ä¸ªå¯¹ä¼ å…¥è¿›æ¥çš„é›†åˆ, å°†å€¼è½¬åŒ–ä¸º æ•°ç»„a (Object []), å¦‚æœ comparatorä¸æ˜¯nullçš„è¯,å°±ä¼šæ ¹æ®comparatoræ¥è¿›è¡Œæ’åº. ä¹Ÿå°±æ˜¯å¯¹aè¿›è¡Œæ’åº,å¹¶ä¸”è¿™ä¸ªçš„å€¼ä¸å¯ä»¥ä¸ºnullçš„,å¦‚æœå‡ºç°äº†nullçš„è¯,å°±ä¼šæœ‰ç©ºæŒ‡é’ˆçš„å¼‚å¸¸å‡ºç°.</span><br><span class="line">   ç„¶åå°†æ•°ç»„aèµ‹å€¼ç»™queue,é•¿åº¦ä¹Ÿæ˜¯è°ƒç”¨ a.length å¤ç½®ç»™size</span><br><span class="line">*/</span><br><span class="line">private void initElementsFromCollection(Collection&lt;? extends E&gt; c) &#123;</span><br><span class="line">        Object[] a = c.toArray();</span><br><span class="line">        // If c.toArray incorrectly doesn&#x27;t return Object[], copy it.</span><br><span class="line">        if (a.getClass() != Object[].class)</span><br><span class="line">            a = Arrays.copyOf(a, a.length, Object[].class);</span><br><span class="line">        int len = a.length;</span><br><span class="line">        if (len == 1 || this.comparator != null)</span><br><span class="line">            for (int i = 0; i &lt; len; i++)</span><br><span class="line">                if (a[i] == null)</span><br><span class="line">                    throw new NullPointerException();</span><br><span class="line">        this.queue = a;</span><br><span class="line">        this.size = a.length;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ–¹æ³•æ˜¯èµ°äº†  initElementsFromCollection è¿™ä¸ªæ–¹æ³•, ç„¶åå†èµ° headify æ–¹æ³•</span><br><span class="line">*/</span><br><span class="line">private void initFromCollection(Collection&lt;? extends E&gt; c) &#123;</span><br><span class="line">        initElementsFromCollection(c);</span><br><span class="line">        heapify();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h4 id="æ–¹æ³•"><a href="#æ–¹æ³•" class="headerlink" title="æ–¹æ³•"></a>æ–¹æ³•</h4><p> æ·»åŠ å…ƒç´ æ–¹æ³• ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">public boolean add(E e) &#123;</span><br><span class="line">    return offer(e);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line">è¿™é‡Œå¯ä»¥çœ‹åˆ°,å¦‚æœå€¼æ˜¯nullçš„è¯,å°±ä¼šæŠ›å‡ºNPEçš„å¼‚å¸¸.</span><br><span class="line">å¦‚æœsizeçš„å¤§å°æ¯” queueæ•°ç»„çš„é•¿åº¦è¿˜å¤§çš„è¯,å°±ä¼šè¿›è¡Œæ‰©å®¹.</span><br><span class="line">ç„¶åsizeé•¿åº¦+1,å¦‚ä½•iæ˜¯0çš„è¯,å°±è¯´æ˜æ˜¯ç¬¬ä¸€ä¸ªå…ƒç´ ,ä¸éœ€è¦ä»»ä½•æ‹å¯»å¤„ç†,ç›´æ¥èµ‹å€¼ç»™ç¬¬ä¸€ä¸ªå³å¯.</span><br><span class="line">å¦‚æœä¸æ˜¯ç¬¬ä¸€ä¸ªçš„è¯,å°±ä¼šèµ°siftUpæ–¹æ³•</span><br><span class="line">*/</span><br><span class="line">public boolean offer(E e) &#123;</span><br><span class="line">        if (e == null)</span><br><span class="line">            throw new NullPointerException();</span><br><span class="line">        modCount++;</span><br><span class="line">        int i = size;</span><br><span class="line">        if (i &gt;= queue.length)</span><br><span class="line">            grow(i + 1);</span><br><span class="line">        size = i + 1;</span><br><span class="line">        if (i == 0)</span><br><span class="line">            queue[0] = e;</span><br><span class="line">        else</span><br><span class="line">            siftUp(i, e);</span><br><span class="line">        return true;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line">å¦‚æœ comparatoræ˜¯nullçš„è¯,å°±èµ°  siftUpUsingComparator æ–¹æ³•.</span><br><span class="line">å¦åˆ™å°±ä¼šèµ° siftUpComparable æ–¹æ³•</span><br><span class="line">*/</span><br><span class="line">private void siftUp(int k, E x) &#123;</span><br><span class="line">        if (comparator != null)</span><br><span class="line">            siftUpUsingComparator(k, x);</span><br><span class="line">        else</span><br><span class="line">            siftUpComparable(k, x);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line">è¿™é‡Œå…ˆåˆ¤æ–­kæ˜¯å¤§äº0çš„,ä¹Ÿå°±æ˜¯ä¸æ˜¯ç¬¬ä¸€ä¸ªçš„æ„æ€.</span><br><span class="line">ç„¶åé€šè¿‡ (k - 1) &gt;&gt;&gt; 1 è®¡ç®—å‡ºæ¥ä¸‹æ ‡ä½ç½®,ä¸‹æ ‡æ˜¯parentçš„å€¼,è°ƒç”¨ comparator.compare(x,e)æ¥è¿›è¡Œæ¯”è¾ƒ,å¦‚æœæ˜¯å¤§äº0çš„è¯,å°±ä¸éœ€è¦åšä»»ä½•å¤„ç†ã€‚</span><br><span class="line">å¦åˆ™çš„è¯,å°±ä¼š queue[k] = e ; k = parent; æ¥è¿›è¡Œä¸‹æ ‡æ•°å€¼çš„æ›¿æ¢å¤„ç†.</span><br><span class="line">æœ€åqueue[k] = x çš„å€¼</span><br><span class="line">*/</span><br><span class="line">private void siftUpUsingComparator(int k, E x) &#123;</span><br><span class="line">        while (k &gt; 0) &#123;</span><br><span class="line">            int parent = (k - 1) &gt;&gt;&gt; 1;</span><br><span class="line">            Object e = queue[parent];</span><br><span class="line">            if (comparator.compare(x, (E) e) &gt;= 0)</span><br><span class="line">                break;</span><br><span class="line">            queue[k] = e;</span><br><span class="line">            k = parent;</span><br><span class="line">        &#125;</span><br><span class="line">        queue[k] = x;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line">è¿™ä¸ªæ–¹æ³•å…¶å®ä¹Ÿæ˜¯å’Œä¸Šé¢çš„å¤„ç†æ–¹å¼æ˜¯ç±»ä¼¼çš„,é€šè¿‡æ¯”è¾ƒå€¼æ¥è¿›è¡Œå¤„ç†.</span><br><span class="line">*/</span><br><span class="line">private void siftUpComparable(int k, E x) &#123;</span><br><span class="line">        Comparable&lt;? super E&gt; key = (Comparable&lt;? super E&gt;) x;</span><br><span class="line">        while (k &gt; 0) &#123;</span><br><span class="line">            int parent = (k - 1) &gt;&gt;&gt; 1;</span><br><span class="line">            Object e = queue[parent];</span><br><span class="line">            if (key.compareTo((E) e) &gt;= 0)</span><br><span class="line">                break;</span><br><span class="line">            queue[k] = e;</span><br><span class="line">            k = parent;</span><br><span class="line">        &#125;</span><br><span class="line">        queue[k] = key;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line">è¿™é‡Œé¡ºè·¯çœ‹ä¸‹ grow æ‰©å®¹æ–¹æ³•å§ã€‚ </span><br><span class="line">è‚¯å®šæ˜¯æ ¹æ® queueçš„é•¿åº¦æ¥è¿›è¡Œæ‰©å®¹,å¦‚æœå€¼å¤ªå°äº†çš„è¯,å°±ä¼šè¿›è¡Œ äºŒå€æ‰©å®¹.  å¦åˆ™çš„è¯,å°±æ˜¯1.5å€æ‰©å®¹.</span><br><span class="line">æœ€åè°ƒç”¨ Arrays.copyOf() æ¥è¿›è¡Œæ‰©å®¹æ•°ç»„æ“ä½œ</span><br><span class="line">è¿™ä¸ªæ‰©å®¹è¿˜æ˜¯æƒ³å¯¹æ¯”è¾ƒç®€å•çš„</span><br><span class="line">*/</span><br><span class="line">private void grow(int minCapacity) &#123;</span><br><span class="line">        int oldCapacity = queue.length;</span><br><span class="line">        // Double size if small; else grow by 50%</span><br><span class="line">        int newCapacity = oldCapacity + ((oldCapacity &lt; 64) ?</span><br><span class="line">                                         (oldCapacity + 2) :</span><br><span class="line">                                         (oldCapacity &gt;&gt; 1));</span><br><span class="line">        // overflow-conscious code</span><br><span class="line">        if (newCapacity - MAX_ARRAY_SIZE &gt; 0)</span><br><span class="line">            newCapacity = hugeCapacity(minCapacity);</span><br><span class="line">        queue = Arrays.copyOf(queue, newCapacity);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>peek æ–¹æ³•</p><p>è¿™é‡Œå¯ä»¥çœ‹æ¸…æ¥šçš„çœ‹åˆ°ï¼Œå‡ºé˜Ÿåˆ—æ–¹æ³•çš„å€¼,å°±æ˜¯é»˜è®¤çš„ç¬¬ä¸€ä¸ªå˜›ï¼Œè¿™ä¹ˆä¸€çœ¼çœ‹ä¸‹å»å°±æ˜¯å¾ˆæ¸…æ¥šæ˜äº†çš„.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public E peek() &#123;</span><br><span class="line">    return (size == 0) ? null : (E) queue[0];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>remove æ–¹æ³• :</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">åˆ é™¤å…ƒç´ çš„æ–¹æ³•ã€‚</span><br><span class="line">indexOf å¦‚æœè¿”å›çš„ä¸æ˜¯-1çš„è¯,å°±è¯´æ˜æ˜¯æœ‰å€¼å¾—,å°±ä¼šèµ°åˆ° removeAt æ–¹æ³•</span><br><span class="line">*/</span><br><span class="line">public boolean remove(Object o) &#123;</span><br><span class="line">    int i = indexOf(o);</span><br><span class="line">    if (i == -1)</span><br><span class="line">        return false;</span><br><span class="line">    else &#123;</span><br><span class="line">        removeAt(i);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line">indexOf è¿™ä¸ªæ–¹æ³•å°±æ˜¯åˆ¤æ–­åœ¨è¿™ä¸ªé›†åˆé‡Œé¢æœ‰æ²¡æœ‰ o è¿™ä¸ªå€¼, å¦‚æœæœ‰çš„è¯å°±ä¼šè¿”å›å¯¹åº”çš„ä¸‹æ ‡,å¦‚æœä¸å­˜åœ¨çš„è¯,å°±ä¼šè¿”å›-1çš„å€¼</span><br><span class="line">*/</span><br><span class="line">private int indexOf(Object o) &#123;</span><br><span class="line">        if (o != null) &#123;</span><br><span class="line">            for (int i = 0; i &lt; size; i++)</span><br><span class="line">                if (o.equals(queue[i]))</span><br><span class="line">                    return i;</span><br><span class="line">        &#125;</span><br><span class="line">        return -1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line">removeAt æ–¹æ³•å°±ä¼šå°†ä¼ å…¥è¿›æ¥çš„içš„ä¸‹æ ‡çš„å€¼é‡ç½®ä¸ºnull,è¿™æ˜¯æ»¡è¶³ i == --size çš„æƒ…å†µä¸‹.</span><br><span class="line">ç„¶åä¼šå°†è¦åˆ é™¤çš„ä¸‹æ ‡ i å’Œ å¯¹åº”çš„å€¼ moved ä¼ å…¥åˆ° siftDown è¿™ä¸ªæ–¹æ³•ä¸­.</span><br><span class="line">siftUp()æ˜¯åœ¨å‰é¢æœ‰è®²è§£åˆ°çš„.</span><br><span class="line">è¿™é‡Œè¿˜æ˜¯å¾ˆæ˜æ˜¾çš„çœ‹åˆ°, priorityQueueæ˜¯ä¸€ç›´åœ¨ç»´æŠ¤è¿™æ’åºçš„å…³ç³»ã€‚</span><br><span class="line">*/</span><br><span class="line">private E removeAt(int i) &#123;</span><br><span class="line">        // assert i &gt;= 0 &amp;&amp; i &lt; size;</span><br><span class="line">        modCount++;</span><br><span class="line">        int s = --size;</span><br><span class="line">        if (s == i) // removed last element</span><br><span class="line">            queue[i] = null;</span><br><span class="line">        else &#123;</span><br><span class="line">            E moved = (E) queue[s];</span><br><span class="line">            queue[s] = null;</span><br><span class="line">            siftDown(i, moved);</span><br><span class="line">            if (queue[i] == moved) &#123;</span><br><span class="line">                siftUp(i, moved);</span><br><span class="line">                if (queue[i] != moved)</span><br><span class="line">                    return moved;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return null;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line">æ ¹æ®comparatorèµ°ä¸åŒçš„æ–¹æ³•</span><br><span class="line">å¯ä»¥çœ‹åˆ°èµ°çš„äºŒä¸ªæ–¹æ³•ï¼Œå…¶ä¸­çš„åŒºåˆ«æ˜¯ comparator.compare å’Œ comparator.compareTo è°ƒç”¨çš„apiæ˜¯ä¸ä¸€æ ·çš„</span><br><span class="line">*/</span><br><span class="line">private void siftDown(int k, E x) &#123;</span><br><span class="line">        if (comparator != null)</span><br><span class="line">            siftDownUsingComparator(k, x);</span><br><span class="line">        else</span><br><span class="line">            siftDownComparable(k, x);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">private void siftDownUsingComparator(int k, E x) &#123;</span><br><span class="line">        int half = size &gt;&gt;&gt; 1;</span><br><span class="line">        while (k &lt; half) &#123;</span><br><span class="line">            int child = (k &lt;&lt; 1) + 1;</span><br><span class="line">            Object c = queue[child];</span><br><span class="line">            int right = child + 1;</span><br><span class="line">            if (right &lt; size &amp;&amp;</span><br><span class="line">                comparator.compare((E) c, (E) queue[right]) &gt; 0)</span><br><span class="line">                c = queue[child = right];</span><br><span class="line">            if (comparator.compare(x, (E) c) &lt;= 0)</span><br><span class="line">                break;</span><br><span class="line">            queue[k] = c;</span><br><span class="line">            k = child;</span><br><span class="line">        &#125;</span><br><span class="line">        queue[k] = x;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private void siftDownComparable(int k, E x) &#123;</span><br><span class="line">        Comparable&lt;? super E&gt; key = (Comparable&lt;? super E&gt;)x;</span><br><span class="line">        int half = size &gt;&gt;&gt; 1;        // loop while a non-leaf</span><br><span class="line">        while (k &lt; half) &#123;</span><br><span class="line">            int child = (k &lt;&lt; 1) + 1; // assume left child is least</span><br><span class="line">            Object c = queue[child];</span><br><span class="line">            int right = child + 1;</span><br><span class="line">            if (right &lt; size &amp;&amp;</span><br><span class="line">                ((Comparable&lt;? super E&gt;) c).compareTo((E) queue[right]) &gt; 0)</span><br><span class="line">                c = queue[child = right];</span><br><span class="line">            if (key.compareTo((E) c) &lt;= 0)</span><br><span class="line">                break;</span><br><span class="line">            queue[k] = c;</span><br><span class="line">            k = child;</span><br><span class="line">        &#125;</span><br><span class="line">        queue[k] = key;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p> PriorityQueue çš„å­˜å‚¨æ•°æ®ç»“æ„æ˜¯é‡‡ç”¨ä¸€ä¸ªæ•°æ®æ¥è¿›è¡Œå­˜å‚¨,ä¹Ÿå°±æ˜¯ä¸€ç›´åœ¨æ“ä½œè¿™ä¸ªæ•°ç»„ï¼Œåªæ˜¯æ¯æ¬¡éƒ½å¯¹æ•°æ®è¿›è¡Œäº†ç»´æŠ¤æ’åºçš„å…³ç³»ã€‚</p><p> PriorityQueue æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„é˜Ÿåˆ—ï¼Œè¿™é‡Œè¿˜æ˜¯æä¸€ä¸‹å§,å› ä¸ºæ·»åŠ å…ƒç´ å’Œåˆ é™¤å…ƒç´ çš„æ–¹æ³•éƒ½æ˜¯æ²¡æœ‰è¿›è¡ŒåŠ é”å¤„ç†ï¼Œå½“ç„¶äº†,å¦‚æœä¸ä½¿ç”¨ä½œä¸ºå…¨å±€å˜é‡çš„è¯ï¼Œè‡ªç„¶æ˜¯æ²¡æœ‰ä»»ä½•é—®é¢˜çš„,åœ¨å±€éƒ¨å˜é‡é‡Œé¢.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;PriorityQueue : ä¸­æ–‡æ˜¯ä¼˜å…ˆé˜Ÿåˆ— , é˜Ÿåˆ—çš„ç‰¹ç‚¹å°±æ˜¯æ•°æ® å…ˆè¿›å…ˆå‡º, ä½†æ˜¯è¿™ä¸ªä¼˜å…ˆé˜Ÿåˆ—çš„ç‰¹åˆ«æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ é¦–å…ˆè‚¯å®šæ˜¯æœ‰é˜Ÿåˆ—çš„åŸºæœ¬ç‰¹ç‚¹ï¼Œä¹Ÿå°±æ˜¯æœ‰å…ˆè¿›å…ˆå‡ºã€‚ å¦‚æœæ˜¯å…ˆè¿›å…ˆå‡ºçš„è¯,é‚£ä¹ˆå°±å’Œæ™®é€šçš„æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿä¼˜å…ˆäºŒå­—åˆæ˜¯ä½“ç°åœ¨ä»€ä¹ˆåœ°æ–¹å‘¢ï¼Ÿ ä¼˜å…ˆçº§é˜Ÿåˆ—çš„å…ƒç´ æŒ‰ç…§å…¶è‡ªç„¶é¡ºåº</summary>
      
    
    
    
    <category term="java" scheme="https://ruy9527.github.io/categories/java/"/>
    
    <category term="javaé›†åˆ" scheme="https://ruy9527.github.io/categories/java/java%E9%9B%86%E5%90%88/"/>
    
    
    <category term="java" scheme="https://ruy9527.github.io/tags/java/"/>
    
    <category term="javaé›†åˆ" scheme="https://ruy9527.github.io/tags/java%E9%9B%86%E5%90%88/"/>
    
  </entry>
  
  <entry>
    <title>springåˆ›å»ºbean_one</title>
    <link href="https://ruy9527.github.io/2021/11/04/spring/spring%E5%88%9B%E5%BB%BAbean-one/"/>
    <id>https://ruy9527.github.io/2021/11/04/spring/spring%E5%88%9B%E5%BB%BAbean-one/</id>
    <published>2021-11-03T16:14:45.000Z</published>
    <updated>2022-11-04T13:46:13.919Z</updated>
    
    <content type="html"><![CDATA[<h4 id="å‰æ"><a href="#å‰æ" class="headerlink" title="å‰æ"></a>å‰æ</h4><p>æˆ‘ä»¬åœ¨åˆ›å»º Spring Bean çš„æ—¶å€™ï¼Œæ˜¯å¯ä»¥é€šè¿‡å¾ˆå¤šç§æ–¹å¼æ¥åˆ›å»ºçš„. ä½†æ˜¯è¿™ä¹ˆå¤šç§æ–¹å¼,åˆæ˜¯æ€ä¹ˆåŠ è½½çš„ï¼Ÿæ˜¯ä¸æ˜¯åˆæœ‰é¡ºåºå‘¢ï¼Ÿ æ‰€ä»¥å¯¹ Spring çš„ Bean åˆ›å»ºè¿˜æ˜¯å¾ˆæœ‰å¿…è¦çš„.</p><h4 id="åˆ›å»ºæ–¹å¼"><a href="#åˆ›å»ºæ–¹å¼" class="headerlink" title="åˆ›å»ºæ–¹å¼"></a>åˆ›å»ºæ–¹å¼</h4><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡è‡ªå·±åˆ›å»º bd , ç„¶åè°ƒç”¨ registerBeanDefinition æ–¹æ³•ç»™æ³¨å†Œåˆ° Spring ä¸­æ¥.</p><p>é‚£ä¹ˆåˆ›å»ºbdçš„æ€ä¹ˆåˆ›å»ºçš„å‘¢ï¼Ÿå¯ä»¥çœ‹åˆ°ä¸‹é¢çš„äºŒç§åˆ›å»ºæ–¹å¼.</p><p>è¿™æ˜¯é€šè¿‡ bd æ¥çš„.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BeanDefinitionCreateAndRegister</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1 : é€šè¿‡ BeanDefinitionBuilder æ¥åˆ›å»º bd</span></span><br><span class="line">        <span class="type">BeanDefinitionBuilder</span> <span class="variable">beanDefinitionBuilder</span> <span class="operator">=</span> BeanDefinitionBuilder.genericBeanDefinition(Person.class);</span><br><span class="line">        beanDefinitionBuilder.addPropertyValue(<span class="string">&quot;id&quot;</span>,<span class="number">9527</span>).addPropertyValue(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;GavinYang&quot;</span>);</span><br><span class="line">        <span class="type">BeanDefinition</span> <span class="variable">beanDefinition</span> <span class="operator">=</span> beanDefinitionBuilder.getBeanDefinition();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2 : é€šè¿‡ new GenericBeanDefinition æ¥åˆ›å»º bd.</span></span><br><span class="line">        <span class="type">GenericBeanDefinition</span> <span class="variable">genericBeanDefinition</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GenericBeanDefinition</span>();</span><br><span class="line">        genericBeanDefinition.setBeanClass(Person.class);</span><br><span class="line">        <span class="type">MutablePropertyValues</span> <span class="variable">mutablePropertyValues</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MutablePropertyValues</span>();</span><br><span class="line">        mutablePropertyValues.add(<span class="string">&quot;id&quot;</span>,<span class="number">1</span>).add(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;Peterwong&quot;</span>);</span><br><span class="line">        genericBeanDefinition.setPropertyValues(mutablePropertyValues);</span><br><span class="line"></span><br><span class="line">        <span class="type">AnnotationConfigApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è¿™é‡Œæ˜¯ç»™ bd ç»™æ³¨å†Œåˆ° Spring å®¹å™¨é‡Œé¢æ¥.</span></span><br><span class="line">        <span class="comment">// context.registerBeanDefinition(&quot;person&quot;,beanDefinition);</span></span><br><span class="line">        context.registerBeanDefinition(<span class="string">&quot;peterwong&quot;</span>,genericBeanDefinition);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¦‚æœè¿™é‡Œä¸è°ƒç”¨ refresh æ˜¯ä¼šæœ‰é”™è¯¯çš„.</span></span><br><span class="line">        context.refresh();</span><br><span class="line"></span><br><span class="line">        <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> context.getBean(Person.class);</span><br><span class="line">        person.say();</span><br><span class="line">        System.out.println(person.toString());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡æˆ‘ä»¬å¸¸ç”¨çš„æ³¨è§£</p><p>è¿™é‡Œä¸»è¦æ˜¯ @Import&#x2F;@Bean&#x2F;@Component+@ComponentScan æ–¹å¼æ¥æ³¨å…¥å¯¹è±¡åˆ° Spring å®¹å™¨ä¸­æ¥.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Import(ImportBeanConfigMain.ImportConfig.class)</span></span><br><span class="line"><span class="meta">@ComponentScan(basePackages = &quot;com.iyang.bean.bd&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ImportBeanConfigMain</span> &#123;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span> <span class="title function_">ImportBeanConfigMain</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;ImportBeanConfigMain æ— å‚æ•°æ„é€ å‡½æ•°&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">AnnotationConfigApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>();</span><br><span class="line">        context.register(ImportBeanConfigMain.class);</span><br><span class="line">        context.refresh();</span><br><span class="line"></span><br><span class="line">        <span class="type">ImportConfig</span> <span class="variable">importConfig</span> <span class="operator">=</span> context.getBean(ImportConfig.class);</span><br><span class="line">        <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> context.getBean(Person.class);</span><br><span class="line">        <span class="type">AnnotConfig</span> <span class="variable">annotConfig</span> <span class="operator">=</span> context.getBean(AnnotConfig.class);</span><br><span class="line">        <span class="type">ExternalConfig</span> <span class="variable">externalConfig</span> <span class="operator">=</span> context.getBean(ExternalConfig.class);</span><br><span class="line"></span><br><span class="line">        System.out.println(importConfig);</span><br><span class="line">        System.out.println(person);</span><br><span class="line">        System.out.println(annotConfig);</span><br><span class="line">        System.out.println(externalConfig);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é€šè¿‡ <span class="doctag">@Import</span> å¯¼å…¥è¿›æ¥.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ImportConfig</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">importMe</span><span class="params">()</span>&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;è¿™æ˜¯å¯¼å…¥è‡ªå·±çš„æ–¹æ³•&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;ImportConfig çš„ toString æ–¹æ³•&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">ImportConfig</span><span class="params">()</span>&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;ImportConfigæ— å‚æ•°æ„é€ å‡½æ•°&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * ä½¿ç”¨ <span class="doctag">@Bean</span> æ³¨è§£ æ³¨å…¥ Bean è¿›æ¥.</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="keyword">public</span> Person <span class="title function_">importPerson</span><span class="params">()</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="number">9527</span>,<span class="string">&quot;GavinYang&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Component</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">AnnotConfig</span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">AnnotConfig</span><span class="params">()</span>&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;AnnotConfigæ— å‚æ•°æ„é€ å‡½æ•°&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;ä½¿ç”¨æ³¨è§£æ¥æ³¨å…¥beanè¿›æ¥.&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ExternalConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ExternalConfig</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;externalConfig æ— å‚æ„é€ å‡½æ•°&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;externalConfig æ‰“å° toString() æ–¹æ³•&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">----------------------------------------------</span><br><span class="line">ImportBeanConfigMain æ— å‚æ•°æ„é€ å‡½æ•°    </span><br><span class="line">externalConfig æ— å‚æ„é€ å‡½æ•°</span><br><span class="line">AnnotConfigæ— å‚æ•°æ„é€ å‡½æ•°</span><br><span class="line">ImportConfigæ— å‚æ•°æ„é€ å‡½æ•°</span><br><span class="line">person æœ‰å‚æ•°æ„é€ å‡½æ•°</span><br><span class="line">ImportConfig çš„ toString æ–¹æ³•</span><br><span class="line">Person&#123;id=<span class="number">9527</span>, name=<span class="string">&#x27;GavinYang&#x27;</span>&#125;</span><br><span class="line">ä½¿ç”¨æ³¨è§£æ¥æ³¨å…¥beanè¿›æ¥.</span><br><span class="line">externalConfig æ‰“å° toString() æ–¹æ³•</span><br><span class="line">    </span><br><span class="line"><span class="comment">// è¿™é‡Œå¯ä»¥çœ‹åˆ°newå‡ºæ¥çš„å¯¹è±¡æ‰“å°é¡ºåº.</span></span><br></pre></td></tr></table></figure><p>å¦‚æœæ˜¯åŸºäºåˆ›å»º bd çš„æ–¹å¼çš„è¯ï¼Œæ˜¯è¯´æ˜ä¸‹æ˜¯å¯ä»¥é€šè¿‡è¿™ç§æ–¹å¼æ¥å°†æˆ‘ä»¬è‡ªå·±åˆ›å»ºçš„å¯¹è±¡ç»™æ³¨å…¥åˆ°Springå®¹å™¨ä¸­æ¥.æˆ‘ä»¬ä¸»è¦æ¥åˆ†æç¬¬äºŒç§,æ˜¯åšäº†ä»€ä¹ˆäº‹æƒ….</p><h4 id="Import-x2F-Bean-x2F-Component-ComponentScan-åˆ†æ"><a href="#Import-x2F-Bean-x2F-Component-ComponentScan-åˆ†æ" class="headerlink" title="@Import&#x2F;@Bean&#x2F;@Component+@ComponentScan åˆ†æ"></a>@Import&#x2F;@Bean&#x2F;@Component+@ComponentScan åˆ†æ</h4><p>åœ¨åˆ†æä¹‹å‰ï¼Œæˆ‘ä»¬çœ‹ä¸‹æˆ‘ä»¬çš„ beanClass æ˜¯æ€ä¹ˆå…ˆæ³¨å†Œåˆ° Springä¸­æ¥çš„,ä¹Ÿå°±æ˜¯åœ¨org.springframework.beans.factory.support.DefaultListableBeanFactory#beanDefinitionMapå’Œorg.springframework.beans.factory.support.DefaultListableBeanFactory#beanDefinitionNamesä¸­,å¯ä»¥çœ‹åˆ°ä¸€ä¸ªæ˜¯Mapç±»å‹çš„,ä¸€ä¸ªæ˜¯é›†åˆç±»å‹çš„.</p><p>æˆ‘ä»¬æŠŠæ–­ç‚¹æ‰“åœ¨ org.springframework.beans.factory.support.DefaultListableBeanFactory#registerBeanDefinition è¿›æ¥çš„æ–¹æ³•ä¸Šå°±å¯ä»¥çœ‹åˆ°,ç„¶åçœ‹å †æ ˆä¿¡æ¯,å°±å¯ä»¥çœ‹åˆ°æ€ä¹ˆä¸€æ­¥ä¸€æ­¥ç»™æ·»åŠ è¿›æ¥çš„.</p><h5 id="æ³¨å†Œ-Spring-ä¸­æ¥èµ°çš„æ–¹æ³•"><a href="#æ³¨å†Œ-Spring-ä¸­æ¥èµ°çš„æ–¹æ³•" class="headerlink" title="æ³¨å†Œ Spring ä¸­æ¥èµ°çš„æ–¹æ³•"></a>æ³¨å†Œ Spring ä¸­æ¥èµ°çš„æ–¹æ³•</h5><p>è¿™é‡Œåªç”¨å…³æ³¨æˆ‘ä»¬è‡ªå·±è‡ªå·±å®šä¹‰çš„ï¼ŒSpringå†…éƒ¨çš„å°±ä¸éœ€è¦ç®¡äº†ã€‚</p><p><strong>ImportBeanConfigMain</strong></p><p>org.springframework.context.annotation.AnnotatedBeanDefinitionReader#registerBean(java.lang.Class&lt;?&gt;) â€”-&gt; org.springframework.beans.factory.support.BeanDefinitionReaderUtils#registerBeanDefinition â€”-&gt; org.springframework.context.support.GenericApplicationContext#registerBeanDefinition</p><p><strong>externalConfig</strong></p><p>org.springframework.context.support.AbstractApplicationContext#invokeBeanFactoryPostProcessors â€”-&gt;</p><p>org.springframework.context.support.PostProcessorRegistrationDelegate#invokeBeanDefinitionRegistryPostProcessors â€”â€“&gt; org.springframework.context.annotation.ConfigurationClassPostProcessor#processConfigBeanDefinitions â€”-&gt; org.springframework.context.annotation.ConfigurationClassParser#parse(org.springframework.core.type.AnnotationMetadata, java.lang.String) â€”&gt; org.springframework.context.annotation.ConfigurationClassParser#doProcessConfigurationClass â€”-&gt;</p><p>org.springframework.context.annotation.ClassPathBeanDefinitionScanner#doScan â€”&gt; org.springframework.context.annotation.ClassPathBeanDefinitionScanner#registerBeanDefinition</p><p><strong>importBeanConfigMain.AnnotConfig</strong></p><p>org.springframework.context.support.AbstractApplicationContext#invokeBeanFactoryPostProcessors â€”-&gt;org.springframework.context.support.PostProcessorRegistrationDelegate#invokeBeanFactoryPostProcessors(org.springframework.beans.factory.config.ConfigurableListableBeanFactory, java.util.List&lt;org.springframework.beans.factory.config.BeanFactoryPostProcessor&gt;) â€”-&gt; org.springframework.context.annotation.ConfigurationClassPostProcessor#postProcessBeanDefinitionRegistry â€”-&gt; org.springframework.context.annotation.ConfigurationClassPostProcessor#processConfigBeanDefinitions â€”&gt; org.springframework.context.annotation.ConfigurationClassParser#parse(org.springframework.core.type.AnnotationMetadata, java.lang.String) â€”&gt; org.springframework.context.annotation.ConfigurationClassParser#doProcessConfigurationClass â€”&gt; org.springframework.context.annotation.ClassPathBeanDefinitionScanner#doScan â€”&gt; org.springframework.context.annotation.ClassPathBeanDefinitionScanner#registerBeanDefinition</p><p><strong>com.iyang.bean.bd.ImportBeanConfigMain$ImportConfig</strong></p><p>org.springframework.context.support.AbstractApplicationContext#invokeBeanFactoryPostProcessors â€”&gt; org.springframework.context.support.PostProcessorRegistrationDelegate#invokeBeanDefinitionRegistryPostProcessors â€”&gt; org.springframework.context.annotation.ConfigurationClassPostProcessor#postProcessBeanDefinitionRegistry â€”-&gt; org.springframework.context.annotation.ConfigurationClassBeanDefinitionReader#loadBeanDefinitions â€”&gt; org.springframework.context.annotation.ConfigurationClassBeanDefinitionReader#registerBeanDefinitionForImportedConfigurationClass</p><p><strong>importPerson</strong></p><p>org.springframework.context.support.AbstractApplicationContext#invokeBeanFactoryPostProcessors â€”&gt; org.springframework.context.support.PostProcessorRegistrationDelegate#invokeBeanDefinitionRegistryPostProcessors â€”&gt; org.springframework.context.annotation.ConfigurationClassPostProcessor#postProcessBeanDefinitionRegistry â€”&gt; org.springframework.context.annotation.ConfigurationClassBeanDefinitionReader#loadBeanDefinitions â€”&gt; org.springframework.context.annotation.ConfigurationClassBeanDefinitionReader#loadBeanDefinitionsForBeanMethod</p><p>å¯ä»¥çœ‹åˆ°é™¤äº† ImportBeanConfigMain åœ¨æ‰«æçš„æ—¶å€™å°±è¢«æ³¨å†Œåˆ° spring å®¹å™¨é‡Œé¢æ¥ï¼Œåé¢çš„éƒ½æ˜¯èµ°çš„ AbstractApplicationContext#invokeBeanFactoryPostProcessors æ–¹æ³•ç»™æ³¨å†Œåˆ° Spring å®¹å™¨ä¸­æ¥äº†. æ˜¯ä¸æ˜¯åº”è¯¥è¯¦ç»†åˆ†æä¸‹ invokeBeanFactoryPostProcessors æ–¹æ³•åˆ°äº†åšäº†ä»€ä¹ˆæˆ–è€…è¯´ç”¨äº†ä»€ä¹ˆ,å°†æˆ‘ä»¬å®šä¹‰çš„å¯¹è±¡ç»™æ³¨å†Œåˆ° Spring å®¹å™¨ä¸­æ¥äº†å‘¢ï¼Ÿ</p><h5 id="invokeBeanFactoryPostProcessors-æ–¹æ³•è§£æ"><a href="#invokeBeanFactoryPostProcessors-æ–¹æ³•è§£æ" class="headerlink" title="invokeBeanFactoryPostProcessors æ–¹æ³•è§£æ"></a>invokeBeanFactoryPostProcessors æ–¹æ³•è§£æ</h5><p>ä»ä¸Šé¢æ¥çœ‹ï¼Œè¿™ä¸ªæ–¹æ³•å¹¶ä¸æ˜¯æˆ‘ä»¬æƒ³è±¡ä¸­é‚£ä¹ˆç®€å•çš„.</p><p>org.springframework.context.support.PostProcessorRegistrationDelegate#invokeBeanFactoryPostProcessors(org.springframework.beans.factory.config.ConfigurableListableBeanFactory, java.util.List&lt;org.springframework.beans.factory.config.BeanFactoryPostProcessor&gt;) å§”æ‰˜åˆ°è¿™é‡Œæ¥è¿›è¡Œè§£æçš„,æ‰€ä»¥æˆ‘ä»¬ç›´æ¥æ·±åº¦åˆ†æè¿™ä¸ªæ–¹æ³•å³å¯.</p><p>ä¸Šé¢å¯ä»¥çœ‹åˆ°éƒ½æ˜¯èµ°çš„ PostProcessorRegistrationDelegate è¿™ä¸ªç±»,ä½†æ˜¯æˆ‘ä»¬å¹¶æ²¡æœ‰åœ¨è¿™ä¸ªæ–¹æ³•ä¸­æ‰¾åˆ°è¿™ä¸ªç±».</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">invokeBeanFactoryPostProcessors</span><span class="params">(</span></span><br><span class="line"><span class="params">      ConfigurableListableBeanFactory beanFactory, List&lt;BeanFactoryPostProcessor&gt; beanFactoryPostProcessors)</span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Invoke BeanDefinitionRegistryPostProcessors first, if any.</span></span><br><span class="line">   Set&lt;String&gt; processedBeans = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (beanFactory <span class="keyword">instanceof</span> BeanDefinitionRegistry) &#123;</span><br><span class="line">      <span class="type">BeanDefinitionRegistry</span> <span class="variable">registry</span> <span class="operator">=</span> (BeanDefinitionRegistry) beanFactory;</span><br><span class="line">      List&lt;BeanFactoryPostProcessor&gt; regularPostProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">      List&lt;BeanDefinitionRegistryPostProcessor&gt; registryProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> (BeanFactoryPostProcessor postProcessor : beanFactoryPostProcessors) &#123;</span><br><span class="line">         <span class="keyword">if</span> (postProcessor <span class="keyword">instanceof</span> BeanDefinitionRegistryPostProcessor) &#123;</span><br><span class="line">            <span class="type">BeanDefinitionRegistryPostProcessor</span> <span class="variable">registryProcessor</span> <span class="operator">=</span></span><br><span class="line">                  (BeanDefinitionRegistryPostProcessor) postProcessor;</span><br><span class="line">            registryProcessor.postProcessBeanDefinitionRegistry(registry);</span><br><span class="line">            registryProcessors.add(registryProcessor);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">else</span> &#123;</span><br><span class="line">            regularPostProcessors.add(postProcessor);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Do not initialize FactoryBeans here: We need to leave all regular beans</span></span><br><span class="line">      <span class="comment">// uninitialized to let the bean factory post-processors apply to them!</span></span><br><span class="line">      <span class="comment">// Separate between BeanDefinitionRegistryPostProcessors that implement</span></span><br><span class="line">      <span class="comment">// PriorityOrdered, Ordered, and the rest.</span></span><br><span class="line">      List&lt;BeanDefinitionRegistryPostProcessor&gt; currentRegistryProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// First, invoke the BeanDefinitionRegistryPostProcessors that implement PriorityOrdered.</span></span><br><span class="line">      String[] postProcessorNames =</span><br><span class="line">            beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">      <span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line">         <span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;</span><br><span class="line">            currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));</span><br><span class="line">            processedBeans.add(ppName);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      sortPostProcessors(currentRegistryProcessors, beanFactory);</span><br><span class="line">      registryProcessors.addAll(currentRegistryProcessors);</span><br><span class="line"><span class="comment">// Note : æˆ‘ä»¬æ ¹æ® debug æ˜¯å¯ä»¥è·Ÿè¿›åˆ°è¿™é‡Œçš„, æˆ‘ä»¬ç›´æ¥åœ¨è¿™é‡Œæ‰“ä¸Šæ–­ç‚¹,å†æ¥ä»”ç»†çœ‹çœ‹è¿™ä¸ªæ–¹æ³•åšäº†ä»€ä¹ˆäº‹æƒ….   // currentRegistryProcessors : org.springframework.context.annotation.ConfigurationClassPostProcessor      </span></span><br><span class="line"><span class="comment">// registry :  DefaultableListFactory </span></span><br><span class="line"><span class="comment">// èµ°å®Œè¿™ä¸ªæ–¹æ³•,æˆ‘ä»¬çš„beanä¿¡æ¯éƒ½æ³¨å†Œåˆ° Spring çš„ DefaultLitableFactoryä¸­æ¥äº†.      </span></span><br><span class="line">      invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry);</span><br><span class="line">      currentRegistryProcessors.clear();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Next, invoke the BeanDefinitionRegistryPostProcessors that implement Ordered.</span></span><br><span class="line">      postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">      <span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line">         <span class="keyword">if</span> (!processedBeans.contains(ppName) &amp;&amp; beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;</span><br><span class="line">            currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));</span><br><span class="line">            processedBeans.add(ppName);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      sortPostProcessors(currentRegistryProcessors, beanFactory);</span><br><span class="line">      registryProcessors.addAll(currentRegistryProcessors);</span><br><span class="line">      invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry);</span><br><span class="line">      currentRegistryProcessors.clear();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Finally, invoke all other BeanDefinitionRegistryPostProcessors until no further ones appear.</span></span><br><span class="line">      <span class="type">boolean</span> <span class="variable">reiterate</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">while</span> (reiterate) &#123;</span><br><span class="line">         reiterate = <span class="literal">false</span>;</span><br><span class="line">         postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">         <span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!processedBeans.contains(ppName)) &#123;</span><br><span class="line">               currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));</span><br><span class="line">               processedBeans.add(ppName);</span><br><span class="line">               reiterate = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         sortPostProcessors(currentRegistryProcessors, beanFactory);</span><br><span class="line">         registryProcessors.addAll(currentRegistryProcessors);</span><br><span class="line">         invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry);</span><br><span class="line">         currentRegistryProcessors.clear();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Now, invoke the postProcessBeanFactory callback of all processors handled so far.</span></span><br><span class="line">      invokeBeanFactoryPostProcessors(registryProcessors, beanFactory);</span><br><span class="line">      invokeBeanFactoryPostProcessors(regularPostProcessors, beanFactory);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// Invoke factory processors registered with the context instance.</span></span><br><span class="line">      invokeBeanFactoryPostProcessors(beanFactoryPostProcessors, beanFactory);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Do not initialize FactoryBeans here: We need to leave all regular beans</span></span><br><span class="line">   <span class="comment">// uninitialized to let the bean factory post-processors apply to them!</span></span><br><span class="line">   String[] postProcessorNames =</span><br><span class="line">         beanFactory.getBeanNamesForType(BeanFactoryPostProcessor.class, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Separate between BeanFactoryPostProcessors that implement PriorityOrdered,</span></span><br><span class="line">   <span class="comment">// Ordered, and the rest.</span></span><br><span class="line">   List&lt;BeanFactoryPostProcessor&gt; priorityOrderedPostProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">   List&lt;String&gt; orderedPostProcessorNames = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">   List&lt;String&gt; nonOrderedPostProcessorNames = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">   <span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line">      <span class="keyword">if</span> (processedBeans.contains(ppName)) &#123;</span><br><span class="line">         <span class="comment">// skip - already processed in first phase above</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;</span><br><span class="line">         priorityOrderedPostProcessors.add(beanFactory.getBean(ppName, BeanFactoryPostProcessor.class));</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;</span><br><span class="line">         orderedPostProcessorNames.add(ppName);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">         nonOrderedPostProcessorNames.add(ppName);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// First, invoke the BeanFactoryPostProcessors that implement PriorityOrdered.</span></span><br><span class="line">   sortPostProcessors(priorityOrderedPostProcessors, beanFactory);</span><br><span class="line">   invokeBeanFactoryPostProcessors(priorityOrderedPostProcessors, beanFactory);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Next, invoke the BeanFactoryPostProcessors that implement Ordered.</span></span><br><span class="line">   List&lt;BeanFactoryPostProcessor&gt; orderedPostProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(orderedPostProcessorNames.size());</span><br><span class="line">   <span class="keyword">for</span> (String postProcessorName : orderedPostProcessorNames) &#123;</span><br><span class="line">      orderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class));</span><br><span class="line">   &#125;</span><br><span class="line">   sortPostProcessors(orderedPostProcessors, beanFactory);</span><br><span class="line">   invokeBeanFactoryPostProcessors(orderedPostProcessors, beanFactory);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Finally, invoke all other BeanFactoryPostProcessors.</span></span><br><span class="line">   List&lt;BeanFactoryPostProcessor&gt; nonOrderedPostProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(nonOrderedPostProcessorNames.size());</span><br><span class="line">   <span class="keyword">for</span> (String postProcessorName : nonOrderedPostProcessorNames) &#123;</span><br><span class="line">      nonOrderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class));</span><br><span class="line">   &#125;</span><br><span class="line">   invokeBeanFactoryPostProcessors(nonOrderedPostProcessors, beanFactory);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Clear cached merged bean definitions since the post-processors might have</span></span><br><span class="line">   <span class="comment">// modified the original metadata, e.g. replacing placeholders in values...</span></span><br><span class="line">   beanFactory.clearMetadataCache();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="org-springframework-context-annotation-ConfigurationClassPostProcessor-processConfigBeanDefinitions-æ–¹æ³•"><a href="#org-springframework-context-annotation-ConfigurationClassPostProcessor-processConfigBeanDefinitions-æ–¹æ³•" class="headerlink" title="org.springframework.context.annotation.ConfigurationClassPostProcessor#processConfigBeanDefinitions æ–¹æ³•"></a>org.springframework.context.annotation.ConfigurationClassPostProcessor#processConfigBeanDefinitions æ–¹æ³•</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Build and validate a configuration model based on the registry of</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> Configuration&#125; classes.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processConfigBeanDefinitions</span><span class="params">(BeanDefinitionRegistry registry)</span> &#123;</span><br><span class="line">   List&lt;BeanDefinitionHolder&gt; configCandidates = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">   String[] candidateNames = registry.getBeanDefinitionNames();</span><br><span class="line"></span><br><span class="line">   <span class="keyword">for</span> (String beanName : candidateNames) &#123;</span><br><span class="line">      <span class="type">BeanDefinition</span> <span class="variable">beanDef</span> <span class="operator">=</span> registry.getBeanDefinition(beanName);</span><br><span class="line">      <span class="keyword">if</span> (beanDef.getAttribute(ConfigurationClassUtils.CONFIGURATION_CLASS_ATTRIBUTE) != <span class="literal">null</span>) &#123;</span><br><span class="line">         <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(<span class="string">&quot;Bean definition has already been processed as a configuration class: &quot;</span> + beanDef);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line"><span class="comment">// å¯¹æ˜¯å¦æ»¡è¶³é…ç½®ç±»è¿›è¡Œæ£€æŸ¥, è¿™é‡Œæˆ‘ä»¬çš„beanæ˜¯importBeanConfigMain,æ»¡è¶³æ¡ä»¶çš„,å…·ä½“å¯ä»¥çœ‹ä¸‹é¢è¯¥æ–¹æ³•çš„åˆ†æ.ç„¶åä¼šæ„å»ºä¸€ä¸ª bdHolder,æ·»åŠ åˆ°é›†åˆä¸­æ¥.</span></span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (ConfigurationClassUtils.checkConfigurationClassCandidate(beanDef, <span class="built_in">this</span>.metadataReaderFactory)) &#123;</span><br><span class="line">         configCandidates.add(<span class="keyword">new</span> <span class="title class_">BeanDefinitionHolder</span>(beanDef, beanName));</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Return immediately if no @Configuration classes were found</span></span><br><span class="line">   <span class="keyword">if</span> (configCandidates.isEmpty()) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Sort by previously determined @Order value, if applicable</span></span><br><span class="line"><span class="comment">// è¿™é‡Œä¼šæ ¹æ® @Order æ¥è¿›è¡Œæ’åºä¸‹.</span></span><br><span class="line"><span class="comment">// ä» Integer.compare(i1, i2) æ¥åˆ†æï¼Œåº”è¯¥æ˜¯ä»å°åˆ°å¤§çš„æ’åº,ä¹Ÿå°±æ˜¯è¯´,è¶Šå°çš„è¯,ä¼˜å…ˆçº§å°±çº¦é«˜. </span></span><br><span class="line">   configCandidates.sort((bd1, bd2) -&gt; &#123;</span><br><span class="line">      <span class="type">int</span> <span class="variable">i1</span> <span class="operator">=</span> ConfigurationClassUtils.getOrder(bd1.getBeanDefinition());</span><br><span class="line">      <span class="type">int</span> <span class="variable">i2</span> <span class="operator">=</span> ConfigurationClassUtils.getOrder(bd2.getBeanDefinition());</span><br><span class="line">      <span class="keyword">return</span> Integer.compare(i1, i2);</span><br><span class="line">   &#125;);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Detect any custom bean name generation strategy supplied through the enclosing application context</span></span><br><span class="line">   <span class="type">SingletonBeanRegistry</span> <span class="variable">sbr</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">   <span class="keyword">if</span> (registry <span class="keyword">instanceof</span> SingletonBeanRegistry) &#123;</span><br><span class="line"><span class="comment">// æ»¡è¶³ç±»å‹æ¡ä»¶å¼ºè½¬ä¸‹.       </span></span><br><span class="line">      sbr = (SingletonBeanRegistry) registry;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">this</span>.localBeanNameGeneratorSet) &#123;</span><br><span class="line"><span class="comment">// è¿™é‡Œä¸åŒ…å«,æ‰€ä»¥è¿”å›çš„å°±æ˜¯null.</span></span><br><span class="line"><span class="comment">//org.springframework.beans.factory.support.DefaultSingletonBeanRegistry#getSingleton(java.lang.String, boolean)          </span></span><br><span class="line">         <span class="type">BeanNameGenerator</span> <span class="variable">generator</span> <span class="operator">=</span> (BeanNameGenerator) sbr.getSingleton(</span><br><span class="line">               AnnotationConfigUtils.CONFIGURATION_BEAN_NAME_GENERATOR);</span><br><span class="line">         <span class="keyword">if</span> (generator != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.componentScanBeanNameGenerator = generator;</span><br><span class="line">            <span class="built_in">this</span>.importBeanNameGenerator = generator;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"><span class="comment">// ç¡®ä¿environmentä¸æ˜¯null.</span></span><br><span class="line">   <span class="keyword">if</span> (<span class="built_in">this</span>.environment == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="built_in">this</span>.environment = <span class="keyword">new</span> <span class="title class_">StandardEnvironment</span>();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Parse each @Configuration class</span></span><br><span class="line"><span class="comment">// åˆ›å»ºä¸€ä¸ªè§£æ @Configuration çš„å¯¹è±¡.</span></span><br><span class="line"><span class="comment">// åœ¨åˆ›å»ºConfigurationClassParserçš„è¿™ä¸ªæœ‰å‚æ„é€ å‡½æ•°é‡Œé¢,æ˜¯å¯ä»¥çœ‹åˆ°åˆnewäº†äºŒä¸ªå¯¹è±¡çš„,ä¸€ä¸ªæ˜¯ComponentScanAnnotationParser,ä¸€ä¸ªæ˜¯ConditionEvaluator.</span></span><br><span class="line"><span class="comment">// ComponentScanAnnotationParser è¿™ä¸ªä»åå­—ä¸Šçœ‹,å¯ä»¥ç†è§£ä¸º@ComponentScanæ³¨è§£çš„è§£æ.  </span></span><br><span class="line">   <span class="type">ConfigurationClassParser</span> <span class="variable">parser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConfigurationClassParser</span>(</span><br><span class="line">         <span class="built_in">this</span>.metadataReaderFactory, <span class="built_in">this</span>.problemReporter, <span class="built_in">this</span>.environment,</span><br><span class="line">         <span class="built_in">this</span>.resourceLoader, <span class="built_in">this</span>.componentScanBeanNameGenerator, registry);</span><br><span class="line"></span><br><span class="line">   Set&lt;BeanDefinitionHolder&gt; candidates = <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>&lt;&gt;(configCandidates);</span><br><span class="line">   Set&lt;ConfigurationClass&gt; alreadyParsed = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;(configCandidates.size());</span><br><span class="line">   <span class="keyword">do</span> &#123;</span><br><span class="line"><span class="comment">// org.springframework.context.annotation.ConfigurationClassParser#processConfigurationClassè¿™é‡Œèµ°åˆ°è¿™é‡Œ,ä¸»è¦çœ‹è¿™ä¸ªæ–¹æ³•ä¸­çš„doProcessConfigurationClassæ–¹æ³•.       </span></span><br><span class="line">      parser.parse(candidates);</span><br><span class="line"><span class="comment">// è¿™é‡Œå¯¹æˆ‘ä»¬ä¸Šé¢è§£æå‡ºæ¥çš„beanè¿›è¡Œvaliate,å¦‚æœvalidateå¤±è´¥çš„è¯,é‚£ä¹ˆæœ€åæ˜¯ä¼šæŠ›å‡ºä¸€ä¸ªå¼‚å¸¸æ¥çš„.       </span></span><br><span class="line">      parser.validate();</span><br><span class="line"></span><br><span class="line"><span class="comment">// è£…æœ‰æˆ‘ä»¬è§£æå‡ºæ¥çš„beanä¿¡æ¯       </span></span><br><span class="line">      Set&lt;ConfigurationClass&gt; configClasses = <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>&lt;&gt;(parser.getConfigurationClasses());</span><br><span class="line"><span class="comment">// ç§»é™¤å·²ç»è§£æè¿‡äº†çš„.       </span></span><br><span class="line">      configClasses.removeAll(alreadyParsed);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Read the model and create bean definitions based on its content</span></span><br><span class="line"><span class="comment">//å¦‚æœthis.readeræ˜¯nullçš„è¯,å°±ä¼šnewä¸€ä¸ªConfigurationClassBeanDefinitionReaderå‡ºæ¥.       </span></span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.reader == <span class="literal">null</span>) &#123;</span><br><span class="line">         <span class="built_in">this</span>.reader = <span class="keyword">new</span> <span class="title class_">ConfigurationClassBeanDefinitionReader</span>(</span><br><span class="line">               registry, <span class="built_in">this</span>.sourceExtractor, <span class="built_in">this</span>.resourceLoader, <span class="built_in">this</span>.environment,</span><br><span class="line">               <span class="built_in">this</span>.importBeanNameGenerator, parser.getImportRegistry());</span><br><span class="line">      &#125;</span><br><span class="line"> <span class="comment">// è¿™é‡Œå¯¹æˆ‘ä»¬è·å–çš„ bean å†è¿›è¡Œä¸€ä¸ª load.      </span></span><br><span class="line">      <span class="built_in">this</span>.reader.loadBeanDefinitions(configClasses);</span><br><span class="line"><span class="comment">// è§£æè¿‡äº†çš„beanæ”¾å…¥åˆ° alreadyParsed ä¸­æ¥.       </span></span><br><span class="line">      alreadyParsed.addAll(configClasses);</span><br><span class="line"></span><br><span class="line">      candidates.clear();</span><br><span class="line"><span class="comment">// æ‰«æè·å–å‡ºæ¥çš„beanä¸ªæ•°å¤§äº åˆå§‹åŒ–ä¼ å…¥è¿›æ¥çš„ä¸ªæ•°.       </span></span><br><span class="line">      <span class="keyword">if</span> (registry.getBeanDefinitionCount() &gt; candidateNames.length) &#123;</span><br><span class="line">        <span class="comment">// è·å–å‡ºæ–°æ‰«æçš„beanä¿¡æ¯.  </span></span><br><span class="line">         String[] newCandidateNames = registry.getBeanDefinitionNames();</span><br><span class="line">        <span class="comment">// æ—§çš„beanä¿¡æ¯  </span></span><br><span class="line">         Set&lt;String&gt; oldCandidateNames = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;(Arrays.asList(candidateNames));</span><br><span class="line">        <span class="comment">// è¡¨ç¤ºå·²ç»æ³¨å†Œè¿‡äº†çš„  </span></span><br><span class="line">         Set&lt;String&gt; alreadyParsedClasses = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">       <span class="comment">// å°†å¤–é¢çš„ alreadyParsed ä¸­çš„å…ƒç´ çš„ metadataçš„classNameç»™æ”¾å…¥åˆ°alreadyParsedClassesé›†åˆä¸­æ¥.    </span></span><br><span class="line">         <span class="keyword">for</span> (ConfigurationClass configurationClass : alreadyParsed) &#123;</span><br><span class="line">            alreadyParsedClasses.add(configurationClass.getMetadata().getClassName());</span><br><span class="line">         &#125;</span><br><span class="line"> <span class="comment">// å¯¹newçš„é›†åˆä¸­å…ƒç´ è¿›è¡Œè¿­ä»£         </span></span><br><span class="line">         <span class="keyword">for</span> (String candidateName : newCandidateNames) &#123;</span><br><span class="line">       <span class="comment">// è€çš„é›†åˆä¸­ä¸åŒ…å«      </span></span><br><span class="line">            <span class="keyword">if</span> (!oldCandidateNames.contains(candidateName)) &#123;</span><br><span class="line">               <span class="type">BeanDefinition</span> <span class="variable">bd</span> <span class="operator">=</span> registry.getBeanDefinition(candidateName);</span><br><span class="line">                </span><br><span class="line">       <span class="comment">// alreadyParsedClasses ä¸­ä¸åŒ…å«å¹¶ä¸”æ£€éªŒå‡ºéœ€è¦é…ç½®çš„,æ¯”å¦‚æœ‰ä¸€äº›@Configurationç­‰ç‰¹æ®Šæ³¨è§£ï¼Œè¿™ä¸ªæ–¹æ³•åœ¨ä¹‹å‰æ˜¯æœ‰æåˆ°çš„.         </span></span><br><span class="line">               <span class="keyword">if</span> (ConfigurationClassUtils.checkConfigurationClassCandidate(bd, <span class="built_in">this</span>.metadataReaderFactory) &amp;&amp;</span><br><span class="line">                     !alreadyParsedClasses.contains(bd.getBeanClassName())) &#123;</span><br><span class="line">           <span class="comment">// æ»¡è¶³ä¸Šé¢è¿™äº›æ¡ä»¶å°±ä¼šæ”¾å…¥åˆ°candidatesé›†åˆä¸­æ¥.         </span></span><br><span class="line">                  candidates.add(<span class="keyword">new</span> <span class="title class_">BeanDefinitionHolder</span>(bd, candidateName));</span><br><span class="line">               &#125;</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         candidateNames = newCandidateNames;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"><span class="comment">// candidates æ˜¯ empty å°±è·³å‡ºwhileå¾ªç¯,å¦åˆ™å°±è®¤ä¸ºè¿˜æœ‰beanéœ€è¦è§£æ.    </span></span><br><span class="line">   <span class="keyword">while</span> (!candidates.isEmpty());</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Register the ImportRegistry as a bean in order to support ImportAware @Configuration classes</span></span><br><span class="line"><span class="comment">// org.springframework.context.annotation.ConfigurationClassPostProcessor.importRegistry sbrä¸åŒ…å«importRegistryçš„è¯,å°±ä¼šæ³¨å†Œä¸€ä¸ªè¿›å».   </span></span><br><span class="line">   <span class="keyword">if</span> (sbr != <span class="literal">null</span> &amp;&amp; !sbr.containsSingleton(IMPORT_REGISTRY_BEAN_NAME)) &#123;</span><br><span class="line">      sbr.registerSingleton(IMPORT_REGISTRY_BEAN_NAME, parser.getImportRegistry());</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (<span class="built_in">this</span>.metadataReaderFactory <span class="keyword">instanceof</span> CachingMetadataReaderFactory) &#123;</span><br><span class="line">      <span class="comment">// Clear cache in externally provided MetadataReaderFactory; this is a no-op</span></span><br><span class="line">      <span class="comment">// for a shared cache since it&#x27;ll be cleared by the ApplicationContext.</span></span><br><span class="line"> <span class="comment">// è¿™é‡Œæ˜¯æ¸…é™¤ç¼“å­˜,ä¹Ÿæ˜¯æ¸…é™¤ä¸€äº›é›†åˆ.      </span></span><br><span class="line">      ((CachingMetadataReaderFactory) <span class="built_in">this</span>.metadataReaderFactory).clearCache();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>èµ°å®Œè¿™ä¸ªæ–¹æ³•,å¦‚æœæ˜¯debugæ¨¡å¼çš„è¯,å°±å¯ä»¥åœ¨ registry(ä¹Ÿå°±æ˜¯DefaultListableBeanFactory)çš„ beanDefintionMapå’ŒbeanDefinitionNamesè¿™äºŒä¸ªé›†åˆä¸­æ˜¯å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„beanåå­—å·²ç»beanå¯¹åº”çš„classä¿¡æ¯çš„.</strong></p><h6 id="org-springframework-context-annotation-ConfigurationClassParser-doProcessConfigurationClassæ–¹æ³•"><a href="#org-springframework-context-annotation-ConfigurationClassParser-doProcessConfigurationClassæ–¹æ³•" class="headerlink" title="org.springframework.context.annotation.ConfigurationClassParser#doProcessConfigurationClassæ–¹æ³•"></a>org.springframework.context.annotation.ConfigurationClassParser#doProcessConfigurationClassæ–¹æ³•</h6><p>å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ–¹æ³•å°±æ˜¯å¯¹ configuration ç±»è¿›è¡Œå¤„ç†çš„.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Apply processing and build a complete &#123;<span class="doctag">@link</span> ConfigurationClass&#125; by reading the</span></span><br><span class="line"><span class="comment"> * annotations, members and methods from the source class. This method can be called</span></span><br><span class="line"><span class="comment"> * multiple times as relevant sources are discovered.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> configClass the configuration class being build</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> sourceClass a source class</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the superclass, or &#123;<span class="doctag">@code</span> null&#125; if none found or previously processed</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> SourceClass <span class="title function_">doProcessConfigurationClass</span><span class="params">(ConfigurationClass configClass, SourceClass sourceClass)</span></span><br><span class="line">      <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ¤æ–­æ˜¯ä¸æ˜¯æœ‰ @Component æ³¨è§£.  </span></span><br><span class="line">   <span class="keyword">if</span> (configClass.getMetadata().isAnnotated(Component.class.getName())) &#123;</span><br><span class="line">      <span class="comment">// Recursively process any member (nested) classes first</span></span><br><span class="line">      processMemberClasses(configClass, sourceClass);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Process any @PropertySource annotations</span></span><br><span class="line"><span class="comment">// æ¥ç€å†å¤„ç† @PropertySources æ³¨è§£. å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ³¨è§£è²Œä¼¼æ˜¯å’Œ Environment æœ‰å…³ç³».   </span></span><br><span class="line">   <span class="keyword">for</span> (AnnotationAttributes propertySource : AnnotationConfigUtils.attributesForRepeatable(</span><br><span class="line">         sourceClass.getMetadata(), PropertySources.class,</span><br><span class="line">         org.springframework.context.annotation.PropertySource.class)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.environment <span class="keyword">instanceof</span> ConfigurableEnvironment) &#123;</span><br><span class="line">         processPropertySource(propertySource);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">         logger.info(<span class="string">&quot;Ignoring @PropertySource annotation on [&quot;</span> + sourceClass.getMetadata().getClassName() +</span><br><span class="line">               <span class="string">&quot;]. Reason: Environment must implement ConfigurableEnvironment&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Process any @ComponentScan annotations</span></span><br><span class="line"><span class="comment">// è·å–@ComponentScan æ³¨è§£,æˆ‘ä»¬è¿™é‡Œæ˜¯æœ‰çš„.    </span></span><br><span class="line">   Set&lt;AnnotationAttributes&gt; componentScans = AnnotationConfigUtils.attributesForRepeatable(</span><br><span class="line">         sourceClass.getMetadata(), ComponentScans.class, ComponentScan.class);</span><br><span class="line">   <span class="keyword">if</span> (!componentScans.isEmpty() &amp;&amp;</span><br><span class="line">         !<span class="built_in">this</span>.conditionEvaluator.shouldSkip(sourceClass.getMetadata(), ConfigurationPhase.REGISTER_BEAN)) &#123;</span><br><span class="line">      <span class="keyword">for</span> (AnnotationAttributes componentScan : componentScans) &#123;</span><br><span class="line">         <span class="comment">// The config class is annotated with @ComponentScan -&gt; perform the scan immediately</span></span><br><span class="line">          </span><br><span class="line"><span class="comment">// org.springframework.context.annotation.ComponentScanAnnotationParser#parse</span></span><br><span class="line"><span class="comment">// parse æ–¹æ³•å†…éƒ¨æ˜¯ä½¿ç”¨ ClassPathBeanDefinitionScanner æ‰«æå™¨çš„,å¯¹resourcePattern/includeFilters/excludeFilters/lazyInit æ˜¯å¦æœ‰è¿›è¡Œå¤„ç†.</span></span><br><span class="line"><span class="comment">// è·å–æ³¨è§£ä¸Šçš„å±æ€§ basePackages/basePackageClassesçš„å€¼,æ·»åŠ ä¸€ä¸ªAbstractTypeHierarchyTraversingFilter,è¿™ä¸ªæ˜¯ExcludeFilter</span></span><br><span class="line"><span class="comment">//æœ€åæ¥org.springframework.context.annotation.ClassPathBeanDefinitionScanner#doScanåšæ‰«ææ“ä½œ.</span></span><br><span class="line"><span class="comment">//doScanåšäº†ä»€ä¹ˆäº‹æƒ…å‘¢? æ˜¾ç¤ºé€šè¿‡ä¼ å…¥è¿›æ¥çš„åŒ…,è°ƒç”¨findCandidateComponentsè·å–å‡ºbdçš„é›†åˆæ¥,ScopeMetadataè®¾ç½®ä¹Ÿæ˜¯é»˜è®¤çš„,ç”¨beanNameGeneratorç”Ÿæˆbeanå¯¹åº”çš„beanName</span></span><br><span class="line"><span class="comment">//å¦‚æœbdæ˜¯AbstractBeanDefinition,å†èµ°ä¸€ä¸‹postProcessBeanDefinitionæ–¹æ³•</span></span><br><span class="line"><span class="comment">//å¦‚æœbdæ˜¯AnnotatedBeanDefinition,ä¼šèµ°AnnotationConfigUtils.processCommonDefinitionAnnotations()æ–¹æ³•,ä¹Ÿæ˜¯å¯¹ä¸€äº›æ³¨è§£çš„å±æ€§è¿›è¡Œè®¾ç½®å€¼æ“ä½œ. èµ°ä¸ªcheckCandidatæ£€æŸ¥æ–¹æ³•,ç¡®ä¿bdå†registryä¸­ä¸å­˜åœ¨çš„,å¦‚æœå­˜åœ¨çš„è¯,é‚£å°±è¯´æ˜æ˜¯å·²ç»æ³¨å†Œè¿‡äº†çš„.     //å¦‚æœæ˜¯ä¸å­˜åœ¨çš„è¯,å°±ä¼šnewä¸€ä¸ªBeanDefinitionHolderæ¥,ç„¶åèµ°registerBeanDefinitionç»™æ³¨å†Œåˆ°Springå®¹å™¨ä¸­æ¥. æœ€åè¿”å›æ‰«æè·å–åˆ°çš„bdHolderé›†åˆæ¥.     </span></span><br><span class="line">         Set&lt;BeanDefinitionHolder&gt; scannedBeanDefinitions =</span><br><span class="line">               <span class="built_in">this</span>.componentScanParser.parse(componentScan, sourceClass.getMetadata().getClassName());</span><br><span class="line">         <span class="comment">// Check the set of scanned definitions for any further config classes and parse recursively if needed</span></span><br><span class="line">         <span class="keyword">for</span> (BeanDefinitionHolder holder : scannedBeanDefinitions) &#123;</span><br><span class="line">            <span class="type">BeanDefinition</span> <span class="variable">bdCand</span> <span class="operator">=</span> holder.getBeanDefinition().getOriginatingBeanDefinition();</span><br><span class="line">            <span class="keyword">if</span> (bdCand == <span class="literal">null</span>) &#123;</span><br><span class="line">               bdCand = holder.getBeanDefinition();</span><br><span class="line">            &#125;</span><br><span class="line"><span class="comment">// å¯ä»¥çœ‹åˆ°è¿™é‡Œ, æˆ‘ä»¬åœ¨æœ€åˆè¿›å…¥åˆ°processConfigBeanDefinitionsæ¥çš„æ—¶å€™,å…¶å®å°±å·²ç»æ˜¯è°ƒç”¨äº†è¿™ä¸ªæ–¹æ³•,é‚£ä¹ˆæˆ‘ä»¬è¿™é‡Œæ‰«æè·å–çš„beanåœ¨æ­¤è°ƒç”¨è¿™ä¸ªæ–¹æ³•. ä¹Ÿå°±æ˜¯ç¡®ä¿,æ‰«æè·å–çš„bean,ä¹Ÿæ˜¯æœ‰ä¸€äº›é…ç½®çš„æ³¨è§£å¹¶ä¸”ä¹Ÿæ˜¯éœ€è¦è§£æçš„.           </span></span><br><span class="line">            <span class="keyword">if</span> (ConfigurationClassUtils.checkConfigurationClassCandidate(bdCand, <span class="built_in">this</span>.metadataReaderFactory)) &#123;</span><br><span class="line"><span class="comment">// org.springframework.context.annotation.ConfigurationClassParser#processConfigurationClassè¿™é‡Œæœ€åä¹Ÿæ˜¯èµ°åˆ°è¿™é‡Œäº†.</span></span><br><span class="line"><span class="comment">// æœ€åˆæˆ‘ä»¬æ˜¯ä»parse.parse() è¿›æ¥çš„,ä¹Ÿæ˜¯èµ°çš„ConfigurationClassParser#processConfigurationClas,è¿™é‡Œåˆèµ°åˆ°äº†è¯¥æ–¹æ³•.</span></span><br><span class="line"><span class="comment">// ä¹Ÿå°±è¯´æˆ‘ä»¬æ˜¯è°ƒç”¨è¿™ä¸ªæ–¹æ³•,åªè¦æ»¡è¶³æ¡ä»¶çš„è¯,å°±ä¼šä¸€ç›´è°ƒç”¨è¿™ä¸ªæ–¹æ³•,ç›´åˆ°ä¸æ»¡è¶³æ¡ä»¶ä¸ºæ­¢.                </span></span><br><span class="line">               parse(bdCand.getBeanClassName(), holder.getBeanName());</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Process any @Import annotations</span></span><br><span class="line"><span class="comment">// è¿™é‡Œæ˜¯å¯¹ @Import æ³¨è§£è¿›è¡Œå¤„ç†. è¯¥æ–¹æ³•æ˜¯æœ‰åˆ©ç”¨ importStack æ¥æ§åˆ¶,</span></span><br><span class="line"><span class="comment">// å…¶å†…éƒ¨åˆåˆ†ä¸º @ImportSelector/@ImportBeanDefinitionRegistrar/æ— æ³¨è§£è¿™ä¸‰ç§æƒ…å†µ.</span></span><br><span class="line"><span class="comment">// è·å–å®Œ bean ä¿¡æ¯å,å°±åˆèµ°åˆ°äº†org.springframework.context.annotation.ConfigurationClassParser#processConfigurationClassæ–¹æ³•æ¥.</span></span><br><span class="line"><span class="comment">// æœ€åimportStack è°ƒç”¨ pop ç»™æ•°æ®ç»™å¼¹å‡ºæ¥.    </span></span><br><span class="line">   processImports(configClass, sourceClass, getImports(sourceClass), <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Process any @ImportResource annotations</span></span><br><span class="line"><span class="comment">// å¯¹@ImportResourceæ˜¯å¦æœ‰è¿›è¡Œåˆ¤æ–­.    </span></span><br><span class="line">   <span class="type">AnnotationAttributes</span> <span class="variable">importResource</span> <span class="operator">=</span></span><br><span class="line">         AnnotationConfigUtils.attributesFor(sourceClass.getMetadata(), ImportResource.class);</span><br><span class="line">   <span class="keyword">if</span> (importResource != <span class="literal">null</span>) &#123;</span><br><span class="line">      String[] resources = importResource.getStringArray(<span class="string">&quot;locations&quot;</span>);</span><br><span class="line">      Class&lt;? <span class="keyword">extends</span> <span class="title class_">BeanDefinitionReader</span>&gt; readerClass = importResource.getClass(<span class="string">&quot;reader&quot;</span>);</span><br><span class="line">      <span class="keyword">for</span> (String resource : resources) &#123;</span><br><span class="line">         <span class="type">String</span> <span class="variable">resolvedResource</span> <span class="operator">=</span> <span class="built_in">this</span>.environment.resolveRequiredPlaceholders(resource);</span><br><span class="line">         configClass.addImportedResource(resolvedResource, readerClass);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Process individual @Bean methods</span></span><br><span class="line"><span class="comment">// @Bean æ³¨è§£å¤„ç†.</span></span><br><span class="line"><span class="comment">//org.springframework.context.annotation.ConfigurationClassParser#retrieveBeanMethodMetadata , </span></span><br><span class="line"><span class="comment">// è¿™é‡Œå¯¹äºä¸»å…¥å£ç±»è¿›æ¥,æ˜¯æ²¡æœ‰è¿™ä¸ªé…ç½®çš„.    </span></span><br><span class="line">   Set&lt;MethodMetadata&gt; beanMethods = retrieveBeanMethodMetadata(sourceClass);</span><br><span class="line">   <span class="keyword">for</span> (MethodMetadata methodMetadata : beanMethods) &#123;</span><br><span class="line">      configClass.addBeanMethod(<span class="keyword">new</span> <span class="title class_">BeanMethod</span>(methodMetadata, configClass));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Process default methods on interfaces</span></span><br><span class="line"><span class="comment">// å¯¹æ¥å£çš„è¿›è¡Œå¤„ç†. è¿™é‡Œç›®å‰ä¹Ÿæ˜¯æ²¡æœ‰çš„.    </span></span><br><span class="line">   processInterfaces(configClass, sourceClass);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Process superclass, if any</span></span><br><span class="line"><span class="comment">// å…ˆæ˜¯åˆ¤æ–­æ˜¯ä¸æ˜¯æœ‰çˆ¶ç±».    </span></span><br><span class="line">   <span class="keyword">if</span> (sourceClass.getMetadata().hasSuperClass()) &#123;</span><br><span class="line"><span class="comment">// è·å–å‡ºçˆ¶ç±»ä¿¡æ¯       </span></span><br><span class="line">      <span class="type">String</span> <span class="variable">superclass</span> <span class="operator">=</span> sourceClass.getMetadata().getSuperClassName();</span><br><span class="line"><span class="comment">// çˆ¶ç±»ä¸æ˜¯null,ä¸æ˜¯javaå¼€å¤´å¹¶ä¸”knownSuperclassesä¸­ä¸å­˜åœ¨,å°±æ»¡æ»¡è¶³æ¡ä»¶.       </span></span><br><span class="line">      <span class="keyword">if</span> (superclass != <span class="literal">null</span> &amp;&amp; !superclass.startsWith(<span class="string">&quot;java&quot;</span>) &amp;&amp;</span><br><span class="line">            !<span class="built_in">this</span>.knownSuperclasses.containsKey(superclass)) &#123;</span><br><span class="line">         <span class="built_in">this</span>.knownSuperclasses.put(superclass, configClass);</span><br><span class="line">         <span class="comment">// Superclass found, return its annotation metadata and recurse</span></span><br><span class="line">         <span class="keyword">return</span> sourceClass.getSuperClass();</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// No superclass -&gt; processing is complete</span></span><br><span class="line">   <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è¿™é‡Œå¯ä»¥çœ‹åˆ° doProcessConfigurationClassæ–¹æ³•,æ˜¯ä¼ å…¥è¿›æ¥ä¸»ç±»å…¥å£è¿›è¡Œè§£æ, ç„¶åæ²¡æ»¡è¶³ä¸€ä¸ªæ¡ä»¶çš„bean,éƒ½ä¼šåœ¨èµ°ä¸€éè§£æçš„æ–¹æ³•,ç›´åˆ°éƒ½èµ°åˆ°æ²¡æ»¡è¶³æ¡ä»¶çš„.</strong></p><h6 id="org-springframework-context-annotation-ConfigurationClassUtils-checkConfigurationClassCandidateæ–¹æ³•"><a href="#org-springframework-context-annotation-ConfigurationClassUtils-checkConfigurationClassCandidateæ–¹æ³•" class="headerlink" title="org.springframework.context.annotation.ConfigurationClassUtils#checkConfigurationClassCandidateæ–¹æ³•"></a>org.springframework.context.annotation.ConfigurationClassUtils#checkConfigurationClassCandidateæ–¹æ³•</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Check whether the given bean definition is a candidate for a configuration class</span></span><br><span class="line"><span class="comment"> * (or a nested component class declared within a configuration/component class,</span></span><br><span class="line"><span class="comment"> * to be auto-registered as well), and mark it accordingly.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> beanDef the bean definition to check</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> metadataReaderFactory the current factory in use by the caller</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> whether the candidate qualifies as (any kind of) configuration class</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">checkConfigurationClassCandidate</span><span class="params">(</span></span><br><span class="line"><span class="params">      BeanDefinition beanDef, MetadataReaderFactory metadataReaderFactory)</span> &#123;</span><br><span class="line"><span class="comment">// å…ˆè·å– beanName å‡ºæ¥</span></span><br><span class="line">   <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> beanDef.getBeanClassName();</span><br><span class="line">   <span class="keyword">if</span> (className == <span class="literal">null</span> || beanDef.getFactoryMethodName() != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   AnnotationMetadata metadata;</span><br><span class="line"><span class="comment">// åˆ¤æ–­ bd æ˜¯ä¸æ˜¯AnnotatedBeanDefinition å¹¶ä¸” ç¡®è®¤ beanNameæ˜¯ä¸æ˜¯ä¸å‰é¢è·å–å‡ºæ¥çš„classsNameæ˜¯ä¸€æ ·çš„.    </span></span><br><span class="line">   <span class="keyword">if</span> (beanDef <span class="keyword">instanceof</span> AnnotatedBeanDefinition &amp;&amp;</span><br><span class="line">         className.equals(((AnnotatedBeanDefinition) beanDef).getMetadata().getClassName())) &#123;</span><br><span class="line">      <span class="comment">// Can reuse the pre-parsed metadata from the given BeanDefinition...</span></span><br><span class="line"><span class="comment">// è·å–ç±»ä¸Šçš„æ³¨è§£.æˆ‘ä»¬è¿™é‡Œè·å–å‡ºæ¥çš„æ˜¯ @Import å’Œ @ComponentScan       </span></span><br><span class="line">      metadata = ((AnnotatedBeanDefinition) beanDef).getMetadata();</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> <span class="keyword">if</span> (beanDef <span class="keyword">instanceof</span> AbstractBeanDefinition &amp;&amp; ((AbstractBeanDefinition) beanDef).hasBeanClass()) &#123;</span><br><span class="line">      <span class="comment">// Check already loaded Class if present...</span></span><br><span class="line">      <span class="comment">// since we possibly can&#x27;t even load the class file for this Class.</span></span><br><span class="line">      Class&lt;?&gt; beanClass = ((AbstractBeanDefinition) beanDef).getBeanClass();</span><br><span class="line">      <span class="keyword">if</span> (BeanFactoryPostProcessor.class.isAssignableFrom(beanClass) ||</span><br><span class="line">            BeanPostProcessor.class.isAssignableFrom(beanClass) ||</span><br><span class="line">            AopInfrastructureBean.class.isAssignableFrom(beanClass) ||</span><br><span class="line">            EventListenerFactory.class.isAssignableFrom(beanClass)) &#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      metadata = AnnotationMetadata.introspect(beanClass);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="type">MetadataReader</span> <span class="variable">metadataReader</span> <span class="operator">=</span> metadataReaderFactory.getMetadataReader(className);</span><br><span class="line">         metadata = metadataReader.getAnnotationMetadata();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">         <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(<span class="string">&quot;Could not find class file for introspecting configuration annotations: &quot;</span> +</span><br><span class="line">                  className, ex);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// è·å–@Configuration,æˆ‘ä»¬è¿™é‡Œæ²¡æœ‰,æ‰€ä»¥è·å–å‡ºæ¥çš„null.   </span></span><br><span class="line">   Map&lt;String, Object&gt; config = metadata.getAnnotationAttributes(Configuration.class.getName());</span><br><span class="line">   <span class="keyword">if</span> (config != <span class="literal">null</span> &amp;&amp; !Boolean.FALSE.equals(config.get(<span class="string">&quot;proxyBeanMethods&quot;</span>))) &#123;</span><br><span class="line">      beanDef.setAttribute(CONFIGURATION_CLASS_ATTRIBUTE, CONFIGURATION_CLASS_FULL);</span><br><span class="line">   &#125;</span><br><span class="line"><span class="comment">// æ³¨æ„è¿™é‡Œçš„ isConfigurationCandidateæ–¹æ³•,org.springframework.context.annotation.ConfigurationClassUtils#isConfigurationCandidate</span></span><br><span class="line"><span class="comment">// @Component/@ComponentScan/@Import/@ImportResource,åªè¦æœ‰å…¶ä¸­çš„ä¸€ç§çš„è¯ï¼Œé‚£ä¹ˆè¿”å›çš„å°±æ˜¯true. </span></span><br><span class="line">   <span class="keyword">else</span> <span class="keyword">if</span> (config != <span class="literal">null</span> || isConfigurationCandidate(metadata)) &#123;</span><br><span class="line"><span class="comment">// CONFIGURATION_CLASS_ATTRIBUTE å¯¹åº”çš„å€¼æ˜¯org.springframework.context.annotation.ConfigurationClassPostProcessor.configurationClass       </span></span><br><span class="line">      beanDef.setAttribute(CONFIGURATION_CLASS_ATTRIBUTE, CONFIGURATION_CLASS_LITE);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// It&#x27;s a full or lite configuration candidate... Let&#x27;s determine the order value, if any.</span></span><br><span class="line"><span class="comment">// è·å– order,å¦‚æœæœ‰çš„è¯,å°±ä¼šsetè¿›å».    </span></span><br><span class="line">   <span class="type">Integer</span> <span class="variable">order</span> <span class="operator">=</span> getOrder(metadata);</span><br><span class="line">   <span class="keyword">if</span> (order != <span class="literal">null</span>) &#123;</span><br><span class="line">      beanDef.setAttribute(ORDER_ATTRIBUTE, order);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ–¹æ³•æœ€ä¸»çš„å°±æ˜¯å¯¹ä¸€äº›ç±»ä¸Šæ˜¯å¦æœ‰æ³¨è§£è¿›è¡Œåˆ¤æ–­, å¦‚æœæ»¡è¶³ @Configuration&#x2F;@Component&#x2F;@ComponentScan&#x2F;@Import&#x2F;@ImportResource,é‚£ä¹ˆè¿”å›çš„å°±æ˜¯ä¼štrue,åŒæ—¶ä¹Ÿä¼šsetä¸€ä¸ªCONFIGURATION_CLASS_ATTRIBUTEå±æ€§åˆ°bdé‡Œé¢æ¥.</strong></p><h4 id="getBeanæ–¹æ³•åˆ†æ"><a href="#getBeanæ–¹æ³•åˆ†æ" class="headerlink" title="getBeanæ–¹æ³•åˆ†æ"></a>getBeanæ–¹æ³•åˆ†æ</h4><p> getBean ä¸ä»…ä»…æ˜¯è·å–beançš„æ•ˆæœ,æ›´æ˜¯åˆ›å»ºbeançš„ï¼Œå¯ä»¥çœ‹åˆ°getBeanæœ€åèµ°åˆ°äº†createBeanæ–¹æ³•æ¥.</p><p> org.springframework.beans.factory.support.DefaultListableBeanFactory#preInstantiateSingletons : è¿™é‡Œæˆ‘ä»¬ç›´æ¥å®šä½åˆ°è¿™ä¸ªæ–¹æ³•,æ¥çœ‹ä¸‹æ˜¯æ€ä¹ˆè°ƒç”¨çš„,è°ƒç”¨ä¹‹å‰&#x2F;å®ä¾‹åŒ–beanç­‰è¿‡ç¨‹,åˆåšäº†ä»€ä¹ˆäº‹æƒ…ï¼Ÿ</p><h5 id="preInstantiateSingletons-æ–¹æ³•"><a href="#preInstantiateSingletons-æ–¹æ³•" class="headerlink" title="preInstantiateSingletons æ–¹æ³•"></a>preInstantiateSingletons æ–¹æ³•</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">preInstantiateSingletons</span><span class="params">()</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">   <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">      logger.trace(<span class="string">&quot;Pre-instantiating singletons in &quot;</span> + <span class="built_in">this</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Iterate over a copy to allow for init methods which in turn register new bean definitions.</span></span><br><span class="line">   <span class="comment">// While this may not be part of the regular factory bootstrap, it does otherwise work fine.</span></span><br><span class="line"><span class="comment">// ä» beanDefinitionNames ä¸­è·å–å‡º beanNameçš„é›†åˆ.</span></span><br><span class="line"><span class="comment">// è¿™é‡Œè·å–å‡ºæ¥çš„ beanNameList ä¸ä»…ä»…æœ‰Springå†…éƒ¨çš„,è¿˜æœ‰æˆ‘ä»¬è‡ªå·±çš„.    </span></span><br><span class="line">   List&lt;String&gt; beanNames = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(<span class="built_in">this</span>.beanDefinitionNames);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Trigger initialization of all non-lazy singleton beans...</span></span><br><span class="line">   <span class="keyword">for</span> (String beanName : beanNames) &#123;</span><br><span class="line">      <span class="type">RootBeanDefinition</span> <span class="variable">bd</span> <span class="operator">=</span> getMergedLocalBeanDefinition(beanName);</span><br><span class="line"><span class="comment">// bdä¸æ˜¯æŠ½è±¡çš„,æ˜¯å•åˆ—çš„,ä¸æ˜¯èµ–åŠ è½½çš„,å°±è¿›å…¥åˆ°è¿™é‡Œæ¥.       </span></span><br><span class="line">      <span class="keyword">if</span> (!bd.isAbstract() &amp;&amp; bd.isSingleton() &amp;&amp; !bd.isLazyInit()) &#123;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ˜¯ä¸æ˜¯ FactoryBean      </span></span><br><span class="line">         <span class="keyword">if</span> (isFactoryBean(beanName)) &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">bean</span> <span class="operator">=</span> getBean(FACTORY_BEAN_PREFIX + beanName);</span><br><span class="line">            <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> FactoryBean) &#123;</span><br><span class="line">               <span class="keyword">final</span> FactoryBean&lt;?&gt; factory = (FactoryBean&lt;?&gt;) bean;</span><br><span class="line">               <span class="type">boolean</span> isEagerInit;</span><br><span class="line">               <span class="keyword">if</span> (System.getSecurityManager() != <span class="literal">null</span> &amp;&amp; factory <span class="keyword">instanceof</span> SmartFactoryBean) &#123;</span><br><span class="line">                  isEagerInit = AccessController.doPrivileged((PrivilegedAction&lt;Boolean&gt;)</span><br><span class="line">                              ((SmartFactoryBean&lt;?&gt;) factory)::isEagerInit,</span><br><span class="line">                        getAccessControlContext());</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">else</span> &#123;</span><br><span class="line">                  isEagerInit = (factory <span class="keyword">instanceof</span> SmartFactoryBean &amp;&amp;</span><br><span class="line">                        ((SmartFactoryBean&lt;?&gt;) factory).isEagerInit());</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">if</span> (isEagerInit) &#123;</span><br><span class="line">                  getBean(beanName);</span><br><span class="line">               &#125;</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// å¦‚æœä¸æ˜¯ FactroyBeançš„è¯,å°±ç›´æ¥èµ° getBeanæ–¹æ³•.       </span></span><br><span class="line">            getBean(beanName);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Trigger post-initialization callback for all applicable beans...</span></span><br><span class="line"><span class="comment">// æ ¹æ® beanNames æ¥è¿›è¡Œè¿­ä»£.    </span></span><br><span class="line">   <span class="keyword">for</span> (String beanName : beanNames) &#123;</span><br><span class="line">   <span class="comment">// æ ¹æ® beanName æ¥è·å–å¯¹è±¡.    </span></span><br><span class="line"><span class="comment">// org.springframework.beans.factory.support.DefaultSingletonBeanRegistry#getSingleton(java.lang.String, boolean)       </span></span><br><span class="line">      <span class="type">Object</span> <span class="variable">singletonInstance</span> <span class="operator">=</span> getSingleton(beanName);</span><br><span class="line">  <span class="comment">// æ»¡è¶³æ˜¯ SmartInitializingSingleton æ¥å£çš„å­ç±». æœ€åå°±éƒ½ä¼šè°ƒç”¨ afterSingletonsInstantiated æ–¹æ³•, è¿™ä¸ªä¹Ÿç®—æ˜¯beanè‡ªèº«å®ç°SmartInitializingSingletonæ¥å£æ¥åšçš„ä¸€ç§æ‰©å±•.  </span></span><br><span class="line">      <span class="keyword">if</span> (singletonInstance <span class="keyword">instanceof</span> SmartInitializingSingleton) &#123;</span><br><span class="line">         <span class="keyword">final</span> <span class="type">SmartInitializingSingleton</span> <span class="variable">smartSingleton</span> <span class="operator">=</span> (SmartInitializingSingleton) singletonInstance;</span><br><span class="line">         <span class="keyword">if</span> (System.getSecurityManager() != <span class="literal">null</span>) &#123;</span><br><span class="line">            AccessController.doPrivileged((PrivilegedAction&lt;Object&gt;) () -&gt; &#123;</span><br><span class="line">               smartSingleton.afterSingletonsInstantiated();</span><br><span class="line">               <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;, getAccessControlContext());</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">else</span> &#123;</span><br><span class="line">            smartSingleton.afterSingletonsInstantiated();</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° preInstanitateSingletonsæ–¹æ³•ï¼Œæ ¹æ®beanDefinitionNamesä¸­æ³¨å†Œè¿‡çš„beanNameé›†åˆ,è°ƒç”¨getBeanæ–¹æ³•æ¥åˆ›å»ºè¿™ä¸ªbean. å½“åˆ›å»ºå®Œæ‰€æœ‰çš„beanå,åˆ¤æ–­æ˜¯ä¸æ˜¯æœ‰å®ç° SmartInitializingSingleton æ¥å£çš„bean,å¦‚æœæœ‰çš„è¯, å°±ä¼šè°ƒç”¨è¿™ä¸ªbean çš„afterSingletonsInstantiatedæ–¹æ³•.</p><h6 id="doGetBean-æ–¹æ³•"><a href="#doGetBean-æ–¹æ³•" class="headerlink" title="doGetBean() æ–¹æ³•"></a>doGetBean() æ–¹æ³•</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Return an instance, which may be shared or independent, of the specified bean.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> name the name of the bean to retrieve</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> requiredType the required type of the bean to retrieve</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> args arguments to use when creating a bean instance using explicit arguments</span></span><br><span class="line"><span class="comment"> * (only applied when creating a new instance as opposed to retrieving an existing one)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> typeCheckOnly whether the instance is obtained for a type check,</span></span><br><span class="line"><span class="comment"> * not for actual use</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> an instance of the bean</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> BeansException if the bean could not be created</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line"><span class="keyword">protected</span> &lt;T&gt; T <span class="title function_">doGetBean</span><span class="params">(<span class="keyword">final</span> String name, <span class="meta">@Nullable</span> <span class="keyword">final</span> Class&lt;T&gt; requiredType,</span></span><br><span class="line"><span class="params">      <span class="meta">@Nullable</span> <span class="keyword">final</span> Object[] args, <span class="type">boolean</span> typeCheckOnly)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line"><span class="comment">// è·å–beanName</span></span><br><span class="line">   <span class="keyword">final</span> <span class="type">String</span> <span class="variable">beanName</span> <span class="operator">=</span> transformedBeanName(name);</span><br><span class="line">   Object bean;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Eagerly check singleton cache for manually registered singletons.</span></span><br><span class="line"> <span class="comment">//   è¿™é‡Œæ˜¯åˆ¤æ–­æ˜¯ä¸æ˜¯æ‰‹åŠ¨ç»™æ·»åŠ åˆ°å•ä¾‹æ± é‡Œé¢å»çš„.</span></span><br><span class="line">   <span class="type">Object</span> <span class="variable">sharedInstance</span> <span class="operator">=</span> getSingleton(beanName);</span><br><span class="line">   <span class="keyword">if</span> (sharedInstance != <span class="literal">null</span> &amp;&amp; args == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">         <span class="keyword">if</span> (isSingletonCurrentlyInCreation(beanName)) &#123;</span><br><span class="line">            logger.trace(<span class="string">&quot;Returning eagerly cached instance of singleton bean &#x27;&quot;</span> + beanName +</span><br><span class="line">                  <span class="string">&quot;&#x27; that is not fully initialized yet - a consequence of a circular reference&quot;</span>);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">else</span> &#123;</span><br><span class="line">            logger.trace(<span class="string">&quot;Returning cached instance of singleton bean &#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line"><span class="comment">// å¦‚æœæ˜¯ä»å•ä¾‹æ± é‡Œé¢è·å–å‡ºæ¥çš„,å°±èµ°è¿™ä¸ªæ–¹æ³•.    </span></span><br><span class="line">      bean = getObjectForBeanInstance(sharedInstance, name, beanName, <span class="literal">null</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// Fail if we&#x27;re already creating this bean instance:</span></span><br><span class="line">      <span class="comment">// We&#x27;re assumably within a circular reference.</span></span><br><span class="line">  <span class="comment">// åˆ¤æ–­è¿™ä¸ªbeanå½“å‰æ˜¯ä¸æ˜¯å·²ç»åœ¨æ³¨å†Œäº†,å¦‚æœæ˜¯çš„è¯,å°±ä¼šæŠ›å‡ºå¼‚å¸¸æ¥.  </span></span><br><span class="line"><span class="comment">//org.springframework.beans.factory.support.AbstractBeanFactory#prototypesCurrentlyInCreation,åˆ©ç”¨ThreadLocalæ¥è®°å½•å€¼,å¦‚æœbeanNameæ˜¯ç›¸åŒçš„è¯å°±ä¼šè¿”å›ture,å¦åˆ™å°±è¿”å›flase,è¿™é‡Œè¿”å›çš„æ˜¯false.       </span></span><br><span class="line">      <span class="keyword">if</span> (isPrototypeCurrentlyInCreation(beanName)) &#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanCurrentlyInCreationException</span>(beanName);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Check if bean definition exists in this factory.</span></span><br><span class="line"> <span class="comment">//  org.springframework.beans.factory.support.AbstractBeanFactory#getParentBeanFactoryè·å–çˆ¶å·¥å‚,è¿™é‡Œè¿”å›çš„æ˜¯null,ä¹Ÿå°±æ˜¯è¯´æ˜¯æ²¡æœ‰çš„.æ‰€ä»¥ä¸‹é¢çš„ifæ¡ä»¶ä¹Ÿå°±ä¸ä¼šè¿›å».     </span></span><br><span class="line">      <span class="type">BeanFactory</span> <span class="variable">parentBeanFactory</span> <span class="operator">=</span> getParentBeanFactory();</span><br><span class="line">      <span class="keyword">if</span> (parentBeanFactory != <span class="literal">null</span> &amp;&amp; !containsBeanDefinition(beanName)) &#123;</span><br><span class="line">         <span class="comment">// Not found -&gt; check parent.</span></span><br><span class="line">         <span class="type">String</span> <span class="variable">nameToLookup</span> <span class="operator">=</span> originalBeanName(name);</span><br><span class="line">         <span class="keyword">if</span> (parentBeanFactory <span class="keyword">instanceof</span> AbstractBeanFactory) &#123;</span><br><span class="line">            <span class="keyword">return</span> ((AbstractBeanFactory) parentBeanFactory).doGetBean(</span><br><span class="line">                  nameToLookup, requiredType, args, typeCheckOnly);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">else</span> <span class="keyword">if</span> (args != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Delegation to parent with explicit args.</span></span><br><span class="line">            <span class="keyword">return</span> (T) parentBeanFactory.getBean(nameToLookup, args);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">else</span> <span class="keyword">if</span> (requiredType != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// No args -&gt; delegate to standard getBean method.</span></span><br><span class="line">            <span class="keyword">return</span> parentBeanFactory.getBean(nameToLookup, requiredType);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (T) parentBeanFactory.getBean(nameToLookup);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// typeCheckOnly åœ¨æ­¤å¤„çš„å€¼æ˜¯ false.</span></span><br><span class="line"><span class="comment">//org.springframework.beans.factory.support.AbstractBeanFactory#alreadyCreated,åˆ©ç”¨Seté›†åˆæ¥æ ‡è®°æ˜¯å¦åˆ›å»º,å¯ä»¥çœ‹åˆ°å¾€alreadyCreatedä¸­æ·»åŠ å…ƒç´ è¿›å»çš„æ—¶å€™,è¿˜ä½¿ç”¨äº†synchronizedæ¥åŠ é”åˆ¤æ–­å¹¶ä¸”ä½¿ç”¨äº†åŒé‡if,å¯ä»¥çœ‹åˆ°æˆ‘ä»¬åœ¨æ¥è§¦å•ä¾‹æ¨¡å¼çš„æ—¶å€™ï¼Œä¹Ÿæ˜¯æœ‰ä½¿ç”¨  synchronized + åŒé‡ifçš„.      </span></span><br><span class="line">      <span class="keyword">if</span> (!typeCheckOnly) &#123;</span><br><span class="line">         markBeanAsCreated(beanName);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">// è·å–å‡º bd æ¥,org.springframework.beans.factory.support.AbstractBeanFactory#mergedBeanDefinitions,ä»è¿™ä¸ªConcurrentHashMapä¸­è·å–å‡ºæ¥,ä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªmergedBeanDefinitions Map ä¸­,keyå°±æ˜¯beanName,valueå°±æ˜¯å¯¹åº”çš„bd.          </span></span><br><span class="line">         <span class="keyword">final</span> <span class="type">RootBeanDefinition</span> <span class="variable">mbd</span> <span class="operator">=</span> getMergedLocalBeanDefinition(beanName);</span><br><span class="line">          </span><br><span class="line"><span class="comment">// å¯¹ bd è¿›è¡Œæ£€æŸ¥,å¦‚æœæ˜¯æŠ½è±¡çš„è¯,å°±ä¼šæŠ›å‡ºå¼‚å¸¸æ¥.          </span></span><br><span class="line">         checkMergedBeanDefinition(mbd, beanName, args);</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Guarantee initialization of beans that the current bean depends on.</span></span><br><span class="line"> <span class="comment">// è·å– @DependsOn æ³¨è§£.å¹¶ä¸”å¯¹ @Dependsè¿›è¡Œå¤„ç†.         </span></span><br><span class="line">         String[] dependsOn = mbd.getDependsOn();</span><br><span class="line">         <span class="keyword">if</span> (dependsOn != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (String dep : dependsOn) &#123;</span><br><span class="line">               <span class="keyword">if</span> (isDependent(beanName, dep)) &#123;</span><br><span class="line">                  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanCreationException</span>(mbd.getResourceDescription(), beanName,</span><br><span class="line">                        <span class="string">&quot;Circular depends-on relationship between &#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27; and &#x27;&quot;</span> + dep + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">               &#125;</span><br><span class="line">               registerDependentBean(dep, beanName);</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                  getBean(dep);</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">catch</span> (NoSuchBeanDefinitionException ex) &#123;</span><br><span class="line">                  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanCreationException</span>(mbd.getResourceDescription(), beanName,</span><br><span class="line">                        <span class="string">&quot;&#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27; depends on missing bean &#x27;&quot;</span> + dep + <span class="string">&quot;&#x27;&quot;</span>, ex);</span><br><span class="line">               &#125;</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Create bean instance.</span></span><br><span class="line"> <span class="comment">// ç¡®ä¿ bd æ˜¯å•ä¾‹çš„.     </span></span><br><span class="line">         <span class="keyword">if</span> (mbd.isSingleton()) &#123;</span><br><span class="line">            sharedInstance = getSingleton(beanName, () -&gt; &#123;</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                  <span class="keyword">return</span> createBean(beanName, mbd, args);</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">                  <span class="comment">// Explicitly remove instance from singleton cache: It might have been put there</span></span><br><span class="line">                  <span class="comment">// eagerly by the creation process, to allow for circular reference resolution.</span></span><br><span class="line">                  <span class="comment">// Also remove any beans that received a temporary reference to the bean.</span></span><br><span class="line">                  destroySingleton(beanName);</span><br><span class="line">                  <span class="keyword">throw</span> ex;</span><br><span class="line">               &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">             </span><br><span class="line"><span class="comment">// è·å–beanå®ä¾‹             </span></span><br><span class="line">            bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);</span><br><span class="line">         &#125;</span><br><span class="line"><span class="comment">// è¿™é‡Œæ˜¯å®ä¾‹åŒ–ä¸€ä¸ª å¤šåˆ—çš„ bean</span></span><br><span class="line">         <span class="keyword">else</span> <span class="keyword">if</span> (mbd.isPrototype()) &#123;</span><br><span class="line">            <span class="comment">// It&#x27;s a prototype -&gt; create a new instance.</span></span><br><span class="line">            <span class="type">Object</span> <span class="variable">prototypeInstance</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">               beforePrototypeCreation(beanName);</span><br><span class="line">               prototypeInstance = createBean(beanName, mbd, args);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">finally</span> &#123;</span><br><span class="line">               afterPrototypeCreation(beanName);</span><br><span class="line">            &#125;</span><br><span class="line">            bean = getObjectForBeanInstance(prototypeInstance, name, beanName, mbd);</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// è¿™é‡Œæ“ä½œçš„,ä¸ä»…å•åˆ—ä¹Ÿä¸æ˜¯å¤šåˆ—.</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">scopeName</span> <span class="operator">=</span> mbd.getScope();</span><br><span class="line">            <span class="keyword">final</span> <span class="type">Scope</span> <span class="variable">scope</span> <span class="operator">=</span> <span class="built_in">this</span>.scopes.get(scopeName);</span><br><span class="line">            <span class="keyword">if</span> (scope == <span class="literal">null</span>) &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;No Scope registered for scope name &#x27;&quot;</span> + scopeName + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">               <span class="type">Object</span> <span class="variable">scopedInstance</span> <span class="operator">=</span> scope.get(beanName, () -&gt; &#123;</span><br><span class="line">                  beforePrototypeCreation(beanName);</span><br><span class="line">                  <span class="keyword">try</span> &#123;</span><br><span class="line">                     <span class="keyword">return</span> createBean(beanName, mbd, args);</span><br><span class="line">                  &#125;</span><br><span class="line">                  <span class="keyword">finally</span> &#123;</span><br><span class="line">                     afterPrototypeCreation(beanName);</span><br><span class="line">                  &#125;</span><br><span class="line">               &#125;);</span><br><span class="line">               bean = getObjectForBeanInstance(scopedInstance, name, beanName, mbd);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (IllegalStateException ex) &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanCreationException</span>(beanName,</span><br><span class="line">                     <span class="string">&quot;Scope &#x27;&quot;</span> + scopeName + <span class="string">&quot;&#x27; is not active for the current thread; consider &quot;</span> +</span><br><span class="line">                     <span class="string">&quot;defining a scoped proxy for this bean if you intend to refer to it from a singleton&quot;</span>,</span><br><span class="line">                     ex);</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">         cleanupAfterBeanCreationFailure(beanName);</span><br><span class="line">         <span class="keyword">throw</span> ex;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Check if required type matches the type of the actual bean instance.</span></span><br><span class="line"> <span class="comment">// ä¸æ»¡è¶³æ¡ä»¶,æ‰€ä»¥æ²¡è¿›å…¥åˆ°è¿™é‡Œ.   </span></span><br><span class="line">   <span class="keyword">if</span> (requiredType != <span class="literal">null</span> &amp;&amp; !requiredType.isInstance(bean)) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="type">T</span> <span class="variable">convertedBean</span> <span class="operator">=</span> getTypeConverter().convertIfNecessary(bean, requiredType);</span><br><span class="line">         <span class="keyword">if</span> (convertedBean == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanNotOfRequiredTypeException</span>(name, requiredType, bean.getClass());</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">return</span> convertedBean;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (TypeMismatchException ex) &#123;</span><br><span class="line">         <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">            logger.trace(<span class="string">&quot;Failed to convert bean &#x27;&quot;</span> + name + <span class="string">&quot;&#x27; to required type &#x27;&quot;</span> +</span><br><span class="line">                  ClassUtils.getQualifiedName(requiredType) + <span class="string">&quot;&#x27;&quot;</span>, ex);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanNotOfRequiredTypeException</span>(name, requiredType, bean.getClass());</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç›´æ¥è¿”å›äº† bean ä¿¡æ¯.    </span></span><br><span class="line">   <span class="keyword">return</span> (T) bean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>doGetBeanæ–¹æ³• : å¯ä»¥çœ‹åˆ°è¯¥æ–¹æ³•ä¸»è¦æ˜¯å¯¹ bean åˆ†ä¸ºä¸‰ç§ç±»å‹æ¥è¿›è¡Œåˆå§‹åŒ– , åˆ†åˆ«æ˜¯ mbd.isSingleton&#x2F;mbd.isPrototype()&#x2F;éå‰äºŒè€… è¿™ä¸‰ç§æƒ…å†µ. åœ¨åˆ†è¿™ä¸‰ç§æƒ…å†µä¹‹å‰,è¿˜å¯¹@DependsOn æ³¨è§£æ¥è¿›è¡Œåˆ†æ,ä¹Ÿå°±è¯´å½“ä½ åˆå§‹åŒ–è¿™ä¸ªbeançš„æ—¶å€™,å¦‚æœå®ƒä¾èµ–äº†ä¸€ä¸ªå®å¤–çš„bean,å°±ä¼šå…ˆå»åˆå§‹åŒ–å®å¤–ä¸€ä¸ªbean,ä¹Ÿå°±æ˜¯è°ƒç”¨äº† getBean æ–¹æ³•, è€ŒgetBeanæ–¹æ³•å°±æ˜¯èµ°çš„ doGetBean() â€”&gt; createBean() ä¹Ÿå°±æ˜¯èµ°åˆ°äº†è‡ªèº«è¿™é‡Œ,æ˜¯ä¸€ç§é€’å½’è°ƒç”¨.</p><p>ç„¶åæˆ‘ä»¬è¿™é‡Œæ˜¯å•ä¾‹çš„,è‡ªç„¶å°±å¾€ä¸‹èµ°äº† createBean æ–¹æ³•.</p><h6 id="createBean-æ–¹æ³•"><a href="#createBean-æ–¹æ³•" class="headerlink" title="createBean() æ–¹æ³•"></a>createBean() æ–¹æ³•</h6><p>ä»åå­—æ¥çœ‹,è¿˜æ˜¯å¯ä»¥å¾ˆå¾ˆé—²çš„æ„Ÿå—åˆ°,æ˜¯åˆ›å»ºbeançš„æ–¹æ³•.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Central method of this class: creates a bean instance,</span></span><br><span class="line"><span class="comment"> * populates the bean instance, applies post-processors, etc.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #doCreateBean</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> Object <span class="title function_">createBean</span><span class="params">(String beanName, RootBeanDefinition mbd, <span class="meta">@Nullable</span> Object[] args)</span></span><br><span class="line">      <span class="keyword">throws</span> BeanCreationException &#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">      logger.trace(<span class="string">&quot;Creating instance of bean &#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="type">RootBeanDefinition</span> <span class="variable">mbdToUse</span> <span class="operator">=</span> mbd;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Make sure bean class is actually resolved at this point, and</span></span><br><span class="line">   <span class="comment">// clone the bean definition in case of a dynamically resolved Class</span></span><br><span class="line">   <span class="comment">// which cannot be stored in the shared merged bean definition.</span></span><br><span class="line"><span class="comment">// ç¡®å®šbeançš„class, å¦‚æœbdæœ‰beanClassçš„ä¿¡æ¯,å°±ä¼šç›´æ¥è¿”å›.    </span></span><br><span class="line">   Class&lt;?&gt; resolvedClass = resolveBeanClass(mbd, beanName);</span><br><span class="line"><span class="comment">//å¦‚æœè¿™é‡Œä»bdè·å–å‡ºæ¥çš„classæ˜¯æœ‰å€¼çš„,ç„¶åbdæ˜¯æ²¡æœ‰beanCalss,è·å–å‡ºæ¥çš„beanClassNameä¹Ÿæ˜¯nullçš„è¯,é‚£ä¹ˆè¿™é‡Œå°±ä¼šé‡æ–°æ¥æ„å»ºå‡ºä¸€ä¸ªbd,å¹¶ä¸”è®¾ç½®ä¸Š beanClassä¿¡æ¯.    </span></span><br><span class="line">   <span class="keyword">if</span> (resolvedClass != <span class="literal">null</span> &amp;&amp; !mbd.hasBeanClass() &amp;&amp; mbd.getBeanClassName() != <span class="literal">null</span>) &#123;</span><br><span class="line">      mbdToUse = <span class="keyword">new</span> <span class="title class_">RootBeanDefinition</span>(mbd);</span><br><span class="line">      mbdToUse.setBeanClass(resolvedClass);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Prepare method overrides.</span></span><br><span class="line"><span class="comment">// å‡†å¤‡é‡å†™çš„æ–¹æ³•ä¿¡æ¯,å…ˆåˆ¤æ–­æ˜¯ä¸æ˜¯æœ‰é‡å†™çš„æ–¹æ³•,    </span></span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">      mbdToUse.prepareMethodOverrides();</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (BeanDefinitionValidationException ex) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanDefinitionStoreException</span>(mbdToUse.getResourceDescription(),</span><br><span class="line">            beanName, <span class="string">&quot;Validation of method overrides failed&quot;</span>, ex);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">// è¿™æ˜¯ Spring ç³»ç»Ÿé»˜è®¤çš„åç½®å¤„ç†å™¨,æ˜¯æœ‰å…­ä¸ªçš„.       </span></span><br><span class="line"><span class="comment">// ApplicationContextAwareProcessor ,  ConfigurationClassPostProcessor$ImportAwareBeanPostProcessor , PostProcessorRegistrationDelegate$BeanPostProcessorCheck , CommonAnnotationBeanPostProcessor ,  AutowiredAnnotationBeanPostProcessor ,  ApplicationListenerDetector ,        </span></span><br><span class="line">       </span><br><span class="line">      <span class="comment">// Give BeanPostProcessors a chance to return a proxy instead of the target bean instance.</span></span><br><span class="line"><span class="comment">// Apply before-instantiation post-processors, resolving whether there is a before-instantiation shortcut for the specified bean. å¯ä»¥çœ‹åˆ°è¿™é‡Œæœ‰ä¸ªåº”ç”¨å®ä¾‹åŒ–å‰çš„å¤„ç†å™¨,</span></span><br><span class="line"><span class="comment">//org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#resolveBeforeInstantiation,å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ–¹æ³•é‡Œé¢,æ»¡è¶³æ¡ä»¶çš„è¯,ä¼šè°ƒç”¨applyBeanPostProcessorsBeforeInstantiation() / applyBeanPostProcessorsAfterInitialization() è¿™äºŒä¸ªæ–¹æ³•çš„.</span></span><br><span class="line"><span class="comment">// èµ°å®Œ applyBeanPostProcessorsBeforeInstantiation æ–¹æ³•,å¦‚æœå‰ç½®å¤„ç†å™¨èƒ½å¤Ÿè¿”å›beanå›æ¥å¹¶ä¸”ä¸æ˜¯nullçš„è¯,å°±ä¼šç»§ç»­èµ°applyBeanPostProcessorsAfterInitializationæ–¹æ³•.</span></span><br><span class="line"><span class="comment">// æˆ‘ä»¬è¿™é‡Œè¿”å›çš„ bean æ˜¯null,å¦‚æœä¸æ˜¯nullçš„è¯,å°±ä¼šç›´æ¥è¿”å›çš„.       </span></span><br><span class="line">      <span class="type">Object</span> <span class="variable">bean</span> <span class="operator">=</span> resolveBeforeInstantiation(beanName, mbdToUse);</span><br><span class="line">      <span class="keyword">if</span> (bean != <span class="literal">null</span>) &#123;</span><br><span class="line">         <span class="keyword">return</span> bean;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanCreationException</span>(mbdToUse.getResourceDescription(), beanName,</span><br><span class="line">            <span class="string">&quot;BeanPostProcessor before instantiation of bean failed&quot;</span>, ex);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸Šé¢çš„å‰ç½®å¤„ç†å™¨applyBeanPostProcessorsBeforeInstantiationè¿”å›çš„beanæ˜¯nullçš„è¯,å°±ä¼šæ¥ç€è¿™ä¸ªä¸‹é¢ç»§ç»­å¾€ä¸‹èµ°.  äºæ˜¯å°±æœ‰äº†èµ° doCreateBean æ–¹æ³•.   </span></span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="type">Object</span> <span class="variable">beanInstance</span> <span class="operator">=</span> doCreateBean(beanName, mbdToUse, args);</span><br><span class="line">      <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">         logger.trace(<span class="string">&quot;Finished creating instance of bean &#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line"> <span class="comment">// è¿”å› bean å¯¹è±¡å›å».      </span></span><br><span class="line">      <span class="keyword">return</span> beanInstance;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (BeanCreationException | ImplicitlyAppearedSingletonException ex) &#123;</span><br><span class="line">      <span class="comment">// A previously detected exception with proper bean creation context already,</span></span><br><span class="line">      <span class="comment">// or illegal singleton state to be communicated up to DefaultSingletonBeanRegistry.</span></span><br><span class="line">      <span class="keyword">throw</span> ex;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanCreationException</span>(</span><br><span class="line">            mbdToUse.getResourceDescription(), beanName, <span class="string">&quot;Unexpected exception during bean creation&quot;</span>, ex);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>createBean æ–¹æ³• : å¯ä»¥çœ‹åˆ°createBeanåœ¨åˆ›å»ºä¹‹å‰èµ°äº†å‰ç½®å¤„ç†å™¨,å¦‚æœå‰ç½®å¤„ç†å™¨è¿”å›çš„beanä¸æ˜¯null,é‚£ä¹ˆä¹Ÿå°±æ²¡æœ‰ä¸‹é¢çš„doCreateBeanä»€ä¹ˆäº‹æƒ…äº†. å¦‚æœè¿”å›çš„beanæ˜¯nullçš„è¯,é‚£ä¹ˆå°±ä¼šèµ°åˆ°ä¸‹é¢çš„doCreateBeanæ–¹æ³•,å¯ä»¥ç†è§£ä¸ºè¿™ä¸ªæ–¹æ³•æ‰æ˜¯çœŸæ­£è°ƒç”¨åå°„å»è·å– bean å¯¹è±¡å®ä¾‹çš„æ–¹æ³• , å¹¶ä¸”å…¶è¿”å›å€¼ beanInstance æ˜¯ç›´æ¥è¿”å›è¿”å›å»äº†,ä¹Ÿæ²¡æœ‰åšä»€ä¹ˆå…¶ä»–çš„å¤„ç†.</p><h6 id="doCreateBean-æ–¹æ³•"><a href="#doCreateBean-æ–¹æ³•" class="headerlink" title="doCreateBean() æ–¹æ³•"></a>doCreateBean() æ–¹æ³•</h6><p>å¯ä»¥æ„Ÿè§‰åˆ° doCreateBean å°±æ˜¯çœŸæ­£å®ä¾‹åŒ–beançš„æ–¹æ³•, æ˜¯ä¸æ˜¯Spring åŠ ä¸Šäº† do å¼€å¤´çš„æ–¹æ³•,æ‰æ˜¯çœŸæ­£å¹²æ´»çš„.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Actually create the specified bean. Pre-creation processing has already happened</span></span><br><span class="line"><span class="comment"> * at this point, e.g. checking &#123;<span class="doctag">@code</span> postProcessBeforeInstantiation&#125; callbacks.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;Differentiates between default bean instantiation, use of a</span></span><br><span class="line"><span class="comment"> * factory method, and autowiring a constructor.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> beanName the name of the bean</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mbd the merged bean definition for the bean</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> args explicit arguments to use for constructor or factory method invocation</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> a new instance of the bean</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> BeanCreationException if the bean could not be created</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #instantiateBean</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #instantiateUsingFactoryMethod</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #autowireConstructor</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> Object <span class="title function_">doCreateBean</span><span class="params">(<span class="keyword">final</span> String beanName, <span class="keyword">final</span> RootBeanDefinition mbd, <span class="keyword">final</span> <span class="meta">@Nullable</span> Object[] args)</span></span><br><span class="line">      <span class="keyword">throws</span> BeanCreationException &#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Instantiate the bean.</span></span><br><span class="line">   <span class="type">BeanWrapper</span> <span class="variable">instanceWrapper</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="comment">// ç¡®å®šæ˜¯å•ä¾‹,    </span></span><br><span class="line">   <span class="keyword">if</span> (mbd.isSingleton()) &#123;</span><br><span class="line"><span class="comment">// ä»org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#factoryBeanInstanceCacheç¼“å­˜ä¸­removeæ‰.       </span></span><br><span class="line">      instanceWrapper = <span class="built_in">this</span>.factoryBeanInstanceCache.remove(beanName);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (instanceWrapper == <span class="literal">null</span>) &#123;</span><br><span class="line"> <span class="comment">// åˆ›å»º bean çš„å®ä¾‹å¯¹è±¡.</span></span><br><span class="line"> <span class="comment">// å…ˆæ ¹æ® bd è·å–å‡º beanClass,æ ¹æ®beanClassè·å–å‡ºå¦‚æœæ˜¯nullå¹¶ä¸”ä¸æ˜¯publicå¹¶ä¸”æ— å‚æ•°æ„é€ å‡½æ•°ä¸æ˜¯publicçš„è¯,å°±ä¼šæŠ›å‡ºä¸€ä¸ªBeanCreationExceptionå¼‚å¸¸æ¥. </span></span><br><span class="line"><span class="comment">// ä»bdè·å–å‡ºå®ä¾‹æä¾›è€…ä¿¡æ¯,è¿™é‡Œè·å–å‡ºæ¥çš„æ˜¯Null,æ‰€ä»¥ä¹Ÿå°±ä¸ä¼šå¾€ä¸‹èµ°.</span></span><br><span class="line"><span class="comment">// è·å– mbd.getFactoryMethodName() æ“ä½œ</span></span><br><span class="line"><span class="comment">// ç”¨å˜é‡resolved/autowireNecessaryå¸ƒå°”ç±»å‹çš„æ¥æ§åˆ¶ä¸€äº›æµç¨‹,  ç”¨ä¼ å…¥è¿›æ¥çš„argså‚æ•°æ¥å†³å®šæ˜¯èµ°æ— å‚æ„é€ å‡½æ•°è¿˜æ˜¯åœ¨æœ‰å‚æ„é€ å‡½æ•°,å¦‚æœargsæ˜¯nullçš„è¯,å°±èµ°æ— å‚æ•°æ„é€ å‡½æ•°.</span></span><br><span class="line"><span class="comment">// org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#determineConstructorsFromBeanPostProcessors, è¯¥æ–¹æ³•æ˜¯è·å–å‡ºå…¨éƒ¨çš„ åç½®å¤„ç†å™¨,å¦‚æœåç½®å¤„ç†å™¨æ˜¯ç»§æ‰¿äº†SmartInstantiationAwareBeanPostProcessorçš„è¯,å°±ä¼šèµ°åˆ°åç½®å¤„ç†å™¨çš„determineCandidateConstructorsæ–¹æ³•æ¥,  æ ¹æ® Constructor&lt;?&gt;[] ctors = ibp.determineCandidateConstructors(beanClass, beanName) å¯ä»¥çœ‹åˆ°,æœ€åè¿”å›çš„æ˜¯ä¸€ä¸ªæ„é€ æ–¹æ³•,å¯ä»¥çœ‹åˆ°org.springframework.beans.factory.annotation.AutowiredAnnotationBeanPostProcessor#determineCandidateConstructorsè¿™ä¸ªåœ°æ–¹æ¥. è¿™é‡Œç›®æµ‹æ˜¯å¯¹@Autowiredæ³¨è§£æ³¨å…¥çš„å¯¹è±¡è¿›è¡Œæ“ä½œ.</span></span><br><span class="line"><span class="comment">//æœ€å,çœ‹åˆ°è¿™ä¸ªæ–¹æ³•:org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#instantiateBean   ----&gt;   org.springframework.beans.factory.support.SimpleInstantiationStrategy#instantiate(org.springframework.beans.factory.support.RootBeanDefinition, java.lang.String, org.springframework.beans.factory.BeanFactory) èµ°åˆ°è¿™é‡Œ, å…ˆåˆ¤æ–­æ²¡æœ‰é‡å†™çš„æ–¹æ³•,æ¥ç€åˆ¤æ–­å¦‚æœæ˜¯æ¥å£çš„è¯,å°±ä¼šæŠ›å‡ºå¼‚å¸¸æ¥,ç”¨constructorToUse = clazz.getDeclaredConstructor();è·å–å‡ºæ„é€ æ–¹æ³•,æœ€åç”¨BeanUtils.instantiateClass(constructorToUse)æ¥å®ä¾‹åŒ–å¯¹è±¡,å¯ä»¥çœ‹åˆ°è¿™è¡Œä»£ç èµ°å®Œ,æˆ‘ä»¬åœ¨æ— å‚æ„é€ å‡½æ•°ä¸­çš„è¾“å‡ºè¯­å¥å°±å¯ä»¥æ‰“å°å‡ºæ¥äº†.  å°†æˆ‘ä»¬å®ä¾‹åŒ–å‡ºæ¥çš„å¯¹è±¡beanInstanceç”¨BeanWrapperImplåŒ…è£…ä¸‹,æ‰€ä»¥è¿™é‡Œæœ€åè¿”å›çš„å°±æ˜¯   BeanWrapperImpl , æ˜¯å¯¹æˆ‘ä»¬çš„ç›®æ ‡å¯¹è±¡è¿›è¡Œä¸€å±‚åŒ…è£…è¿‡äº†çš„.     </span></span><br><span class="line">      instanceWrapper = createBeanInstance(beanName, mbd, args);</span><br><span class="line">   &#125;</span><br><span class="line">    </span><br><span class="line"><span class="comment">// ä»åŒ…è£…äº†beanInstanceçš„BeanWrapperImplä¸­è·å–å‡ºæ¥beanå’ŒbeanTypeæ¥,    </span></span><br><span class="line">   <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">bean</span> <span class="operator">=</span> instanceWrapper.getWrappedInstance();</span><br><span class="line">   Class&lt;?&gt; beanType = instanceWrapper.getWrappedClass();</span><br><span class="line">    </span><br><span class="line"><span class="comment">// èµ‹å€¼beanTypeç»™mbd.resolvedTargetType    </span></span><br><span class="line">   <span class="keyword">if</span> (beanType != NullBean.class) &#123;</span><br><span class="line">      mbd.resolvedTargetType = beanType;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Allow post-processors to modify the merged bean definition.</span></span><br><span class="line">   <span class="keyword">synchronized</span> (mbd.postProcessingLock) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!mbd.postProcessed) &#123;</span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line"> <span class="comment">// è¿™é‡Œåèµ°äº†ä¸€ä¸ªè°ƒç”¨åç½®å¤„ç†å™¨çš„æ–¹æ³•,æ˜¯MergedBeanDefinitionPostProcessoræ¥å£çš„å­ç±»,å°±ä¼šè°ƒç”¨åˆ°åç½®å¤„ç†å™¨çš„postProcessMergedBeanDefinitionæ–¹æ³•.ä»åå­—ä¸Šçœ‹,æ˜¯å¯¹bdè¿›è¡Œåˆå¹¶çš„å¤„ç†æ“ä½œ.            </span></span><br><span class="line">            applyMergedBeanDefinitionPostProcessors(mbd, beanType, beanName);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanCreationException</span>(mbd.getResourceDescription(), beanName,</span><br><span class="line">                  <span class="string">&quot;Post-processing of merged bean definition failed&quot;</span>, ex);</span><br><span class="line">         &#125;</span><br><span class="line">         mbd.postProcessed = <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Eagerly cache singletons to be able to resolve circular references</span></span><br><span class="line">   <span class="comment">// even when triggered by lifecycle interfaces like BeanFactoryAware.</span></span><br><span class="line"><span class="comment">//  bdæ˜¯å•ä¾‹çš„å¹¶ä¸”æ˜¯å¾ªç¯å¼•ç”¨çš„å¹¶ä¸”å•ä¾‹æ˜¯åˆ›å»ºçš„,å°±æ»¡è¶³è¿™ä¸ªæ¡ä»¶,è¿™é‡Œæ˜¯å¤„ç†å¾ªç¯ä¾èµ–é—®é¢˜?è¿˜æ˜¯ç”¨äºå®ç°BeanFactoryAwareè¿™ç§æ¥é¿å…å¾ªç¯ä¾èµ–?    </span></span><br><span class="line">   <span class="type">boolean</span> <span class="variable">earlySingletonExposure</span> <span class="operator">=</span> (mbd.isSingleton() &amp;&amp; <span class="built_in">this</span>.allowCircularReferences &amp;&amp;</span><br><span class="line">         isSingletonCurrentlyInCreation(beanName));</span><br><span class="line">   <span class="keyword">if</span> (earlySingletonExposure) &#123;</span><br><span class="line">      <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">         logger.trace(<span class="string">&quot;Eagerly caching bean &#x27;&quot;</span> + beanName +</span><br><span class="line">               <span class="string">&quot;&#x27; to allow for resolving potential circular references&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line"><span class="comment">//  æ·»åŠ åˆ° org.springframework.beans.factory.support.DefaultSingletonBeanRegistry#registeredSingletons ä¸­æ¥.       </span></span><br><span class="line">      addSingletonFactory(beanName, () -&gt; getEarlyBeanReference(beanName, mbd, bean));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Initialize the bean instance.</span></span><br><span class="line">   <span class="type">Object</span> <span class="variable">exposedObject</span> <span class="operator">=</span> bean;</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">// æ„å»ºbean,è¿™é‡Œèµ°äº† InstantiationAwareBeanPostProcessor æ¥å£çš„å®ç°ç±»çš„åç½®å¤„ç†å™¨,å¦‚æœæ»¡è¶³æ¡ä»¶å°±ä¼šèµ°å¤„ç†å™¨çš„postProcessAfterInstantiationæ–¹æ³•,è¯¥æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ªå¸ƒå°”ç±»å‹çš„å€¼,å¦‚æœæ˜¯falseçš„è¯,å°±ä¼šè·³å‡ºå¾ªç¯æ¥çš„.</span></span><br><span class="line"><span class="comment">// ä¸‹é¢è¿˜ä¼šèµ°ä¸€ä¸ªInstantiationAwareBeanPostProcessoræ¥å£çš„å­ç±»çš„åç½®å¤„ç†å™¨,æ»¡è¶³æ¡ä»¶å°±ä¼šèµ°åç½®å¤„ç†å™¨çš„postProcessPropertiesæ–¹æ³•,å¦‚æœè·å–å‡ºæ¥çš„PropertyValues pvsToUseæ˜¯nullçš„è¯,ä¼šç»§ç»­èµ°åç½®å¤„ç†å™¨çš„postProcessPropertyValuesæ–¹æ³•.       </span></span><br><span class="line">      populateBean(beanName, mbd, instanceWrapper);</span><br><span class="line"><span class="comment">//  è¿™é‡Œè°ƒç”¨æ¯ä¸ªåç½®å¤„ç†å™¨çš„ postProcessBeforeInitialization æ–¹æ³•,</span></span><br><span class="line"><span class="comment">// org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#invokeInitMethods è¯¥æ–¹æ³•å¯ä»¥çœ‹åˆ°(InitializingBean) bean).afterPropertiesSet();å¯¹äºafterPropertiesSetæ–¹æ³•è¿˜æ˜¯æœ‰ç‚¹ç†Ÿæ‚‰çš„.</span></span><br><span class="line"><span class="comment">//  æ¥ç€å°±æ˜¯è°ƒç”¨æ¯ä¸ªåç½®å¤„ç†å™¨çš„postProcessAfterInitializationæ–¹æ³•,       </span></span><br><span class="line">      exposedObject = initializeBean(beanName, exposedObject, mbd);</span><br><span class="line">       </span><br><span class="line"><span class="comment">// å¯ä»¥çœ‹åˆ°è¿™äºŒä¸ªæ–¹æ³•éƒ½æ˜¯åœ¨è°ƒç”¨åç½®å¤„ç†å™¨æ¥è¿›è¡Œæ‰©å±•.       </span></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">      <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> BeanCreationException &amp;&amp; beanName.equals(((BeanCreationException) ex).getBeanName())) &#123;</span><br><span class="line">         <span class="keyword">throw</span> (BeanCreationException) ex;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanCreationException</span>(</span><br><span class="line">               mbd.getResourceDescription(), beanName, <span class="string">&quot;Initialization of bean failed&quot;</span>, ex);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//  earlySingletonExposure is true.  </span></span><br><span class="line">   <span class="keyword">if</span> (earlySingletonExposure) &#123;</span><br><span class="line"><span class="comment">// ä»å•ä¾‹æ± ä¸­æ ¹æ® beanName æ¥è·å–å¯¹è±¡.       </span></span><br><span class="line">      <span class="type">Object</span> <span class="variable">earlySingletonReference</span> <span class="operator">=</span> getSingleton(beanName, <span class="literal">false</span>);</span><br><span class="line">       </span><br><span class="line"><span class="comment">// è·å–å‡ºæ¥çš„å¯¹è±¡ä¸æ˜¯nullçš„è¯,å°±ä¼šè¿›å…¥åˆ°è¿™é‡Œæ¥.       </span></span><br><span class="line">      <span class="keyword">if</span> (earlySingletonReference != <span class="literal">null</span>) &#123;</span><br><span class="line">         <span class="keyword">if</span> (exposedObject == bean) &#123;</span><br><span class="line">            exposedObject = earlySingletonReference;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">this</span>.allowRawInjectionDespiteWrapping &amp;&amp; hasDependentBean(beanName)) &#123;</span><br><span class="line">            String[] dependentBeans = getDependentBeans(beanName);</span><br><span class="line">            Set&lt;String&gt; actualDependentBeans = <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>&lt;&gt;(dependentBeans.length);</span><br><span class="line">            <span class="keyword">for</span> (String dependentBean : dependentBeans) &#123;</span><br><span class="line">               <span class="keyword">if</span> (!removeSingletonIfCreatedForTypeCheckOnly(dependentBean)) &#123;</span><br><span class="line">                  actualDependentBeans.add(dependentBean);</span><br><span class="line">               &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!actualDependentBeans.isEmpty()) &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanCurrentlyInCreationException</span>(beanName,</span><br><span class="line">                     <span class="string">&quot;Bean with name &#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27; has been injected into other beans [&quot;</span> +</span><br><span class="line">                     StringUtils.collectionToCommaDelimitedString(actualDependentBeans) +</span><br><span class="line">                     <span class="string">&quot;] in its raw version as part of a circular reference, but has eventually been &quot;</span> +</span><br><span class="line">                     <span class="string">&quot;wrapped. This means that said other beans do not use the final version of the &quot;</span> +</span><br><span class="line">                     <span class="string">&quot;bean. This is often the result of over-eager type matching - consider using &quot;</span> +</span><br><span class="line">                     <span class="string">&quot;&#x27;getBeanNamesOfType&#x27; with the &#x27;allowEagerInit&#x27; flag turned off, for example.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Register bean as disposable.</span></span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line"> <span class="comment">// å¦‚æœæœ‰å¿…è¦çš„è¯,æ³¨å†Œä»»æ„beanä¿¡æ¯.      </span></span><br><span class="line">      registerDisposableBeanIfNecessary(beanName, bean, mbd);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (BeanDefinitionValidationException ex) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanCreationException</span>(</span><br><span class="line">            mbd.getResourceDescription(), beanName, <span class="string">&quot;Invalid destruction signature&quot;</span>, ex);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> exposedObject;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>doCreateBean() æ–¹æ³• : è¯¥æ–¹æ³•æ‰æ˜¯æ­£åœ¨å»èµ°åå°„æ¥å®ä¾‹åŒ–beançš„. å¹¶ä¸”åœ¨å®ä¾‹åŒ–è¿™ä¸ªbeanä¹‹å‰å’Œä¹‹å,éƒ½æ˜¯æœ‰è°ƒç”¨è®¸å¤šåç½®å¤„ç†å™¨çš„,ä¹Ÿå°±æ˜¯è¿™ä¸ªbeanè¿›è¡Œä¸€äº›å¢å¼ºæˆ–è€…å…¶ä»–çš„å¤„ç†. ä»ç°åœ¨æ¥çœ‹,éƒ½æ˜¯Springå†…ç½®çš„å¤„ç†å™¨.æˆ‘ä»¬åé¢å¯ä»¥è·Ÿç€Springé‡Œé¢çš„å†™æ³•,æ¥åšç›¸åŒçš„æ‰©å±•å¤„ç†.</p><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p> å…¶å®å¯ä»¥çœ‹åˆ°,æˆ‘ä»¬é€šè¿‡è¿™ç§æ–¹å¼ç»™æˆ‘ä»¬å®šä¹‰çš„ bean ç»™æ³¨å…¥åˆ° Spring å®¹å™¨ä¸­, å…ˆæ˜¯é€šè¿‡æˆ‘ä»¬å®šä¹‰çš„ @ComponentScan(basePackages &#x3D; â€œcom.iyang.bean.bdâ€) æ¥æ‰«æï¼Œç„¶åå°†æ‰«æå¾—åˆ°çš„ä¿¡æ¯ç»™æ·»åŠ åˆ°Springçš„ä¿¡æ¯æ± é‡Œé¢,ä¹Ÿå°±æ˜¯æ·»åŠ åˆ°é›†åˆä¸­æ¥äº†. æœ€ååœ¨getBean æ–¹æ³•ä¸­, é€šè¿‡æ‰«æè·å–åˆ°çš„beanNamesé›†åˆè¿›è¡Œè¿­ä»£ï¼Œç„¶åæŒ¨ä¸ªè°ƒç”¨getBean()æ–¹æ³•æ¥å®ä¾‹åŒ–bean, getBean() æ–¹æ³•ä¸­åˆèµ°äº† doGetBean () â€”-&gt; createBean() â€”&gt; doCreateBean() æ–¹æ³•ï¼Œ ç„¶åæ¯ä¸ªæ–¹æ³•æœ‰å„è‡ªè¦åšçš„äº‹æƒ…ï¼Œå¹¶ä¸”ä¹Ÿä¼šèµ°ç›¸åº”çš„åç½®å¤„ç†å™¨.</p><p> æœ€åï¼Œè¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒè¯¦ç»†çš„getBeanåˆ†æï¼Œä½†æ˜¯è¿˜æœ‰æ›´æ·±å…¥çš„ , æ¯”å¦‚ : @Autowired &#x2F; @DependsOn &#x2F; å¾ªç¯ä¾èµ–ç­‰æ³¨å…¥ï¼Œéœ€è¦æ‰©å±•æ¥è®².</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;å‰æ&quot;&gt;&lt;a href=&quot;#å‰æ&quot; class=&quot;headerlink&quot; title=&quot;å‰æ&quot;&gt;&lt;/a&gt;å‰æ&lt;/h4&gt;&lt;p&gt;æˆ‘ä»¬åœ¨åˆ›å»º Spring Bean çš„æ—¶å€™ï¼Œæ˜¯å¯ä»¥é€šè¿‡å¾ˆå¤šç§æ–¹å¼æ¥åˆ›å»ºçš„. ä½†æ˜¯è¿™ä¹ˆå¤šç§æ–¹å¼,åˆæ˜¯æ€ä¹ˆåŠ è½½çš„ï¼Ÿæ˜¯ä¸æ˜¯åˆæœ‰é¡ºåºå‘¢ï¼Ÿ æ‰€ä»¥å¯¹ S</summary>
      
    
    
    
    <category term="java" scheme="https://ruy9527.github.io/categories/java/"/>
    
    <category term="spring" scheme="https://ruy9527.github.io/categories/java/spring/"/>
    
    
    <category term="java" scheme="https://ruy9527.github.io/tags/java/"/>
    
    <category term="spring" scheme="https://ruy9527.github.io/tags/spring/"/>
    
  </entry>
  
  <entry>
    <title>LinkedListæºç é˜…è¯»è®°å½•</title>
    <link href="https://ruy9527.github.io/2021/11/04/java/LinkedList%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E8%AE%B0%E5%BD%95/"/>
    <id>https://ruy9527.github.io/2021/11/04/java/LinkedList%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E8%AE%B0%E5%BD%95/</id>
    <published>2021-11-03T16:14:26.000Z</published>
    <updated>2022-11-04T13:46:13.917Z</updated>
    
    <content type="html"><![CDATA[<p>è™½ç„¶ä¸€èˆ¬éƒ½æ˜¯ä½¿ç”¨ArrayListé›†åˆæ¯”ä½¿ç”¨LinkedListé›†åˆè¦å¤š,ä½†æ˜¯è¿™å¹¶ä¸å¦¨ç¢æˆ‘ä»¬å¯¹LinkedListçš„æºç ç ”ç©¶å’Œå­¦ä¹ </p><h3 id="ç»“æ„"><a href="#ç»“æ„" class="headerlink" title="ç»“æ„"></a>ç»“æ„</h3><p>LinkedList æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨çš„ç»“æ„,è¿™ç‚¹å¯ä»¥ç›´æ¥çœ‹å…¶å†…éƒ¨å†…å°±å¯ä»¥éå¸¸æ˜æ˜¾çš„çœ‹å‡ºæ¥. é™æ€ç§æœ‰çš„å†…éƒ¨ç±»,åªæä¾›ä¸€ä¸ªæ„é€ å‡½æ•°.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">private static class Node&lt;E&gt; &#123;</span><br><span class="line">    E item;</span><br><span class="line">    Node&lt;E&gt; next;</span><br><span class="line">    Node&lt;E&gt; prev;</span><br><span class="line"></span><br><span class="line">    Node(Node&lt;E&gt; prev, E element, Node&lt;E&gt; next) &#123;</span><br><span class="line">        this.item = element;</span><br><span class="line">        this.next = next;</span><br><span class="line">        this.prev = prev;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬çœ‹ LinkedList è‡ªèº«çš„å˜é‡. size è‚¯å®šæ˜¯è®°å½•è¿™ä¸ªé“¾è¡¨çš„é•¿åº¦,ä¸ç„¶åˆ°æ—¶å€™node.next.nextâ€¦.è·å–é•¿åº¦å°±å¾ˆå¾—ä¸å¿å¤±äº†. ç„¶åè®°å½•äº†ä¸€ä¸ªå¤´èŠ‚ç‚¹å’Œå°¾èŠ‚ç‚¹ï¼Œä¸ªäººè®¤ä¸ºè¿™æ˜¯æ–¹ä¾¿éå†ã€‚ä»å¤´å¼€å§‹éå†å°±ä»firstèŠ‚ç‚¹è·å–,ä»å°¾éƒ¨å¼€å§‹éå†çš„è¯,å°±ä»lastå¼€å§‹è·å–.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">transient int size = 0;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Pointer to first node.</span><br><span class="line"> * Invariant: (first == null &amp;&amp; last == null) ||</span><br><span class="line"> *            (first.prev == null &amp;&amp; first.item != null)</span><br><span class="line"> */</span><br><span class="line">transient Node&lt;E&gt; first;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Pointer to last node.</span><br><span class="line"> * Invariant: (first == null &amp;&amp; last == null) ||</span><br><span class="line"> *            (last.next == null &amp;&amp; last.item != null)</span><br><span class="line"> */</span><br><span class="line">transient Node&lt;E&gt; last;</span><br></pre></td></tr></table></figure><hr><h3 id="æ–¹æ³•"><a href="#æ–¹æ³•" class="headerlink" title="æ–¹æ³•"></a>æ–¹æ³•</h3><ul><li><p>add æ–¹æ³•</p><p>addæ–¹æ³•è°ƒç”¨ä¸€ä¸ªlinkLastæ–¹æ³•,ç„¶åå°±è¿”å›trueäº†. ä¹Ÿå°±æ˜¯è¯´add(E e)å°±æ˜¯é»˜è®¤ä»å°¾éƒ¨å¼€å§‹æ’å…¥å…ƒç´ è¿›å».</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">public boolean add(E e) &#123;</span><br><span class="line">    linkLast(e);</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Links e as last element.</span><br><span class="line">       ç¿»è¯‘ : é“¾æ¥eä½œä¸ºæœ€åä¸€ä¸ªå…ƒç´ ã€‚</span><br><span class="line">       å…ˆå¯¹lastèµ‹å€¼ç»™ Node&lt;E&gt; l , ç„¶åè°ƒç”¨new Node&lt;&gt;(l,e,null);ä¼ å…¥è¿›å»çš„ä¸Šä¸ªèŠ‚ç‚¹,ä¹Ÿå°±æ˜¯l,ä¸Šæ¬¡ä¿å­˜çš„å°¾éƒ¨èŠ‚ç‚¹,ä¹Ÿå°±æ˜¯ä»å€’æ•°ç¬¬ä¸€å˜ä¸ºäº†å€’æ•°äºŒ,è¿™æ ·ç†è§£ã€‚ç„¶åæ­¤æ—¶çš„newNodeå°±æ˜¯å°¾èŠ‚ç‚¹äº†,ç„¶åèµ‹å€¼ç»™last,å› ä¸ºlastæ¯æ¬¡è®°å½•çš„éƒ½æ˜¯å°¾èŠ‚ç‚¹.</span><br><span class="line">       if else ä¸­æ˜¯å¯¹ä¹‹å‰çš„å°¾èŠ‚ç‚¹è¿›è¡Œåˆ¤æ–­,å¦‚æœæ˜¯nullçš„è¯,è¯´æ˜æ­¤æ—¶å°±æ˜¯æ·»åŠ çš„ç¬¬ä¸€ä¸ªå…ƒç´ ,firstä¹Ÿèµ‹å€¼ç»™newNode,å¦åˆ™çš„è¯,l.next å’Œ å°¾èŠ‚ç‚¹è¿›è¡Œå…³è”ã€‚</span><br><span class="line">       size é•¿åº¦åŠ ä¸€</span><br><span class="line">     */</span><br><span class="line">void linkLast(E e) &#123;</span><br><span class="line">        final Node&lt;E&gt; l = last;</span><br><span class="line">        final Node&lt;E&gt; newNode = new Node&lt;&gt;(l, e, null);</span><br><span class="line">        last = newNode;</span><br><span class="line">        if (l == null)</span><br><span class="line">            first = newNode;</span><br><span class="line">        else</span><br><span class="line">            l.next = newNode;</span><br><span class="line">        size++;</span><br><span class="line">        modCount++;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li></ul><p>æ ¹æ®ä¸‹æ ‡æ·»åŠ  add(int index,E element)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">1: æ£€æŸ¥ä¼ å…¥è¿›æ¥çš„ä¸‹æ ‡æ˜¯å¦è¶Šç•Œäº†,å¦‚æœä¸‹æ ‡è¶Šç•Œçš„è¯,å°±ä¼šæŠ›å‡º ä¸‹æ ‡è¶Šç•Œçš„å¼‚å¸¸</span><br><span class="line">2: æ ¹æ®ä¼ å…¥è¿›æ¥çš„ä¸‹æ ‡å€¼,åˆ¤æ–­æ˜¯å¦å’Œ size ç›¸ç­‰,å¦‚æœæ˜¯ç›¸ç­‰çš„è¯,å°±è¯´æ˜æ˜¯å°¾éƒ¨æ’å…¥,å°±ä¸éœ€è¦æŒ¨ä¸ªè¿­ä»£å»è·å–å¯¹åº”çš„ä¸‹æ ‡å€¼å¯¹åº”çš„èŠ‚ç‚¹.æ»¡è¶³æ¡ä»¶,å°±ä¼šè°ƒç”¨ä¸Šé¢è¯´åˆ°çš„ linkLastæ–¹æ³•</span><br><span class="line">3: ä¸æ»¡è¶³æ¡ä»¶2çš„è¯,å°±ä¼šèµ°lineBefore()æ–¹æ³•,å…¶ä¸­ä¹Ÿè°ƒç”¨åˆ°äº†.ä¼ å…¥ä¸‹æ ‡è°ƒç”¨nodeæ–¹æ³•.nodeä¼šè¿”å›å¯¹åº”ä¸‹æ ‡çš„å€¼,æ ¹æ®è¿”å›çš„èŠ‚ç‚¹å’Œå½“å‰çš„å€¼è°ƒç”¨lienkBeforeæ–¹æ³•.</span><br><span class="line">*/</span><br><span class="line">public void add(int index, E element) &#123;</span><br><span class="line">    checkPositionIndex(index);</span><br><span class="line"></span><br><span class="line">    if (index == size)</span><br><span class="line">        linkLast(element);</span><br><span class="line">    else</span><br><span class="line">        linkBefore(element, node(index));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private void checkPositionIndex(int index) &#123;</span><br><span class="line">        if (!isPositionIndex(index))</span><br><span class="line">            throw new IndexOutOfBoundsException(outOfBoundsMsg(index));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> private boolean isPositionIndex(int index) &#123;</span><br><span class="line">        return index &gt;= 0 &amp;&amp; index &lt;= size;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line">size &gt;&gt; 1 ; æ˜¯å¯¹ size è¿›è¡Œå»åŠ, æ¯”å¦‚ 6 &gt;&gt; 1 æ˜¯ 3ï¼Œ 5 &gt;&gt; 1 æ˜¯2</span><br><span class="line">å¦‚æœå°äºä¸€åŠçš„è¯,å°±ä¼šä»firstèŠ‚ç‚¹å¼€å§‹éå†,ä¹Ÿå°±æ˜¯ä»å¤´èŠ‚ç‚¹å¼€å§‹éå†,å¦åˆ™å°±æ˜¯ä»å°¾èŠ‚ç‚¹å¼€å§‹éå†.</span><br><span class="line">è¿™ä¸ªæ–¹æ³•å¯ä»¥çœ‹åˆ°,ä»å¤´å¼€å§‹éå†çš„è¯,å°±æ˜¯è°ƒç”¨çš„next,å¦‚æœå°¾éƒ¨éå†çš„è¯,è°ƒç”¨çš„å°±æ˜¯prevã€‚æ‰¾åˆ°å¯¹åº”ä¸‹æ ‡çš„èŠ‚ç‚¹å¹¶ä¸”è¿”å›å›å».</span><br><span class="line">*/</span><br><span class="line">Node&lt;E&gt; node(int index) &#123;</span><br><span class="line">        // assert isElementIndex(index);</span><br><span class="line"></span><br><span class="line">        if (index &lt; (size &gt;&gt; 1)) &#123;</span><br><span class="line">            Node&lt;E&gt; x = first;</span><br><span class="line">            for (int i = 0; i &lt; index; i++)</span><br><span class="line">                x = x.next;</span><br><span class="line">            return x;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            Node&lt;E&gt; x = last;</span><br><span class="line">            for (int i = size - 1; i &gt; index; i--)</span><br><span class="line">                x = x.prev;</span><br><span class="line">            return x;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line">è·å–èŠ‚ç‚¹çš„ä¸Šä¸ªèŠ‚ç‚¹èµ‹å€¼ç»™predï¼Œå…¶å®ç±»ä¼¼äºpredè¿™ç§,éƒ½æ˜¯ç”¨äºå˜é‡æ›¿æ¢åˆ›å»ºå‡ºæ¥çš„.</span><br><span class="line">ä¸Šä¸€ä¸ªèŠ‚ç‚¹,å½“å‰å€¼e,succèŠ‚ç‚¹æ¥newä¸€ä¸ªæ–°çš„èŠ‚ç‚¹å‡ºæ¥.</span><br><span class="line">succ.prev æŒ‡å‘å½“å‰newå‡ºæ¥çš„èŠ‚ç‚¹</span><br><span class="line">å¯¹predåˆ¤æ–­æ˜¯å¦æ˜¯null,å¦‚æœæ˜¯nullçš„è¯,å°±è¯´æ˜æ˜¯ç¬¬ä¸€ä¸ªå€¼,å¦åˆ™å°±æ˜¯èµ‹å€¼ä¸Špredä¸ªèŠ‚ç‚¹çš„next</span><br><span class="line">,size ++ å°±æ˜¯å¯¹é•¿åº¦ ++ </span><br><span class="line">*/</span><br><span class="line">void linkBefore(E e, Node&lt;E&gt; succ) &#123;</span><br><span class="line">        // assert succ != null;</span><br><span class="line">        final Node&lt;E&gt; pred = succ.prev;</span><br><span class="line">        final Node&lt;E&gt; newNode = new Node&lt;&gt;(pred, e, succ);</span><br><span class="line">        succ.prev = newNode;</span><br><span class="line">        if (pred == null)</span><br><span class="line">            first = newNode;</span><br><span class="line">        else</span><br><span class="line">            pred.next = newNode;</span><br><span class="line">        size++;</span><br><span class="line">        modCount++;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å¤´æ’å…¥ å’Œ å°¾æ’å…¥</p><p>å¤´æ’å…¥ï¼Œå°†å€¼æ’å…¥åˆ°å¤´éƒ¨</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public void addFirst(E e) &#123;</span><br><span class="line">    linkFirst(e);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line">å…ˆå°†first èµ‹å€¼ç»™ f ,  æ ¹æ®ä¼ å…¥è¿›æ¥çš„å€¼e å’Œ ä¸‹ä¸€ä¸ªèŠ‚ç‚¹f(å‰ä¸€ä¸ªå¤´èŠ‚ç‚¹),newä¸€ä¸ªæ–°çš„newNodeèŠ‚ç‚¹å‡ºæ¥,firstæŒ‡å‘newNode.å¦‚æœfæ˜¯nullçš„è¯å°±è¯´æ˜æ˜¯åˆå§‹åŒ–,å¦‚æœä¸æ˜¯nullçš„è¯,fçš„ä¸Šä¸€ä¸ªèŠ‚ç‚¹æŒ‡å‘newNode,åˆšåˆšç¨‹åºnewNodeå‡ºæ¥çš„.å°±å®Œæˆäº†å¤´èŠ‚ç‚¹çš„æ’å…¥</span><br><span class="line">*/</span><br><span class="line">private void linkFirst(E e) &#123;</span><br><span class="line">        final Node&lt;E&gt; f = first;</span><br><span class="line">        final Node&lt;E&gt; newNode = new Node&lt;&gt;(null, e, f);</span><br><span class="line">        first = newNode;</span><br><span class="line">        if (f == null)</span><br><span class="line">            last = newNode;</span><br><span class="line">        else</span><br><span class="line">            f.prev = newNode;</span><br><span class="line">        size++;</span><br><span class="line">        modCount++;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å°¾èŠ‚ç‚¹æ’å…¥;ä¸å¤´èŠ‚ç‚¹ç›¸ä¼¼ï¼Œä¹Ÿæ˜¯åˆ©ç”¨å˜é‡lastæ¥å®ç°å°¾éƒ¨æ’å…¥.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public void addLast(E e) &#123;</span><br><span class="line">    linkLast(e);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void linkLast(E e) &#123;</span><br><span class="line">        final Node&lt;E&gt; l = last;</span><br><span class="line">        final Node&lt;E&gt; newNode = new Node&lt;&gt;(l, e, null);</span><br><span class="line">        last = newNode;</span><br><span class="line">        if (l == null)</span><br><span class="line">            first = newNode;</span><br><span class="line">        else</span><br><span class="line">            l.next = newNode;</span><br><span class="line">        size++;</span><br><span class="line">        modCount++;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><ul><li><p>get æ–¹æ³•,è·å–å€¼æ–¹æ³•</p><p>æ ¹æ®ä¸‹æ ‡æ¥è·å–å‡ºå€¼ ,ç„¶åè°ƒç”¨nodeæ–¹æ³•è·å–å‡ºèŠ‚ç‚¹,node.itemå°±æ˜¯æˆ‘ä»¬éœ€è¦çš„å€¼,ç„¶åå¯¹å…¶è¿›è¡Œè¿”å›å³å¯.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public E get(int index) &#123;</span><br><span class="line">    checkElementIndex(index);</span><br><span class="line">    return node(index).item;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// å¦‚æœè¾“å…¥indexæ˜¯å°äº0å’Œå¤§äºsizeçš„è¯,å°±ä¼šçˆ†å‡ºä¸‹æ ‡è¶Šç•Œçš„é”™è¯¯.</span><br><span class="line">private void checkElementIndex(int index) &#123;</span><br><span class="line">        if (!isElementIndex(index))</span><br><span class="line">            throw new IndexOutOfBoundsException(outOfBoundsMsg(index));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>getFirst &#x2F; getLast å¯ä»¥çœ‹åˆ°firstå’Œ lastéƒ½æ˜¯ç›´æ¥ä»å®šä¹‰çš„å˜é‡ä¸­è·å–å‡ºå¯¹åº”çš„å€¼</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public E getFirst() &#123;</span><br><span class="line">    final Node&lt;E&gt; f = first;</span><br><span class="line">    if (f == null)</span><br><span class="line">        throw new NoSuchElementException();</span><br><span class="line">    return f.item;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    public E getLast() &#123;</span><br><span class="line">        final Node&lt;E&gt; l = last;</span><br><span class="line">        if (l == null)</span><br><span class="line">            throw new NoSuchElementException();</span><br><span class="line">        return l.item;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p> peek æ–¹æ³•;ä½¿ç”¨firstèŠ‚ç‚¹,å¦‚æœæ˜¯nullçš„è¯å°±ä¼šè¿”å›nullï¼Œå¦åˆ™å°±æ˜¯f.item. è¿™é‡Œæ˜¯æ²¡æœ‰åˆ é™¤firstå…ƒç´ ,pollæ˜¯å¼¹å‡ºå…ƒç´ å¹¶ä¸”åˆ é™¤.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public E peek() &#123;</span><br><span class="line">    final Node&lt;E&gt; f = first;</span><br><span class="line">    return (f == null) ? null : f.item;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> poll æ–¹æ³• : è¿™é‡Œä¸»è¦çœ‹unlinkFirstæ–¹æ³•.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> E <span class="title function_">poll</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> Node&lt;E&gt; f = first;</span><br><span class="line">    <span class="keyword">return</span> (f == <span class="literal">null</span>) ? <span class="literal">null</span> : unlinkFirst(f);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   å–å‡º f çš„item,èŠ‚ç‚¹å¯¹åº”çš„å€¼å’Œ fçš„nextä¸ªèŠ‚ç‚¹,å¦‚æœä¸‹ä¸ªèŠ‚ç‚¹æ˜¯nullçš„è¯,å°±è¯´æ˜æ˜¯æ²¡æœ‰å€¼çš„,å¦‚æœä¸ä¸ºnullçš„è¯ï¼Œè¯´å°†nextçš„ä¸Šä¸€ä¸ªèŠ‚ç‚¹prevæŒ‡å‘null,å› ä¸ºå¤´èŠ‚ç‚¹çš„prevå’Œå°¾èŠ‚ç‚¹çš„nextéƒ½æ˜¯nullæ¥è¿›è¡ŒåŒºåˆ†ã€‚</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">private</span> E <span class="title function_">unlinkFirst</span><span class="params">(Node&lt;E&gt; f)</span> &#123;</span><br><span class="line">        <span class="comment">// assert f == first &amp;&amp; f != null;</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">E</span> <span class="variable">element</span> <span class="operator">=</span> f.item;</span><br><span class="line">        <span class="keyword">final</span> Node&lt;E&gt; next = f.next;</span><br><span class="line">        f.item = <span class="literal">null</span>;</span><br><span class="line">        f.next = <span class="literal">null</span>; <span class="comment">// help GC</span></span><br><span class="line">        first = next;</span><br><span class="line">        <span class="keyword">if</span> (next == <span class="literal">null</span>)</span><br><span class="line">            last = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            next.prev = <span class="literal">null</span>;</span><br><span class="line">        size--;</span><br><span class="line">        modCount++;</span><br><span class="line">        <span class="keyword">return</span> element;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p> offer ç­‰æ–¹æ³•éƒ½æ˜¯å†…éƒ¨è°ƒç”¨äº†add &#x2F; addFirst &#x2F; addLastç­‰æ–¹æ³•.</p><ul><li><p>remove æ–¹æ³•</p><p>æ ¹æ®ä¸‹æ ‡è¿›æ¥removeæ–¹æ³•, node(index) ä¹Ÿæ˜¯åœ¨ä¸Šé¢è¿›è¡Œè®²åˆ°çš„,å°±æ˜¯æ ¹æ®ä¸‹æ ‡è·å–å¯¹åº”çš„nodeèŠ‚ç‚¹ä¿¡æ¯.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> E <span class="title function_">remove</span><span class="params">(<span class="type">int</span> index)</span> &#123;</span><br><span class="line">    checkElementIndex(index);</span><br><span class="line">    <span class="keyword">return</span> unlink(node(index));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">è¿™é‡Œè·å–å‡ºèŠ‚ç‚¹çš„ next å’Œ prevæ–¹æ³•.</span></span><br><span class="line"><span class="comment">è¯¥èŠ‚ç‚¹çš„ä¸Šä¸€ä¸ªèŠ‚ç‚¹(prev)çš„nextéœ€è¦æŒ‡å‘æŒ‡å‘è¯¥èŠ‚ç‚¹çš„ä¸‹ä¸ªèŠ‚ç‚¹(next),è¯¥èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹å’Œprevçš„æ“ä½œæ˜¯ç›¸åçš„,å› ä¸ºè¿™æ ·çš„è¯,å°±åˆ é™¤äº†è¯¥èŠ‚ç‚¹,å¹¶ä¸”ä¸Šä¸€ä¸ªèŠ‚ç‚¹å’Œä¸‹ä¸€ä¸ªèŠ‚ç‚¹å…³è”èµ·æ¥äº†.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"> E <span class="title function_">unlink</span><span class="params">(Node&lt;E&gt; x)</span> &#123;</span><br><span class="line">        <span class="comment">// assert x != null;</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">E</span> <span class="variable">element</span> <span class="operator">=</span> x.item;</span><br><span class="line">        <span class="keyword">final</span> Node&lt;E&gt; next = x.next;</span><br><span class="line">        <span class="keyword">final</span> Node&lt;E&gt; prev = x.prev;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (prev == <span class="literal">null</span>) &#123;</span><br><span class="line">            first = next;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            prev.next = next;</span><br><span class="line">            x.prev = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (next == <span class="literal">null</span>) &#123;</span><br><span class="line">            last = prev;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            next.prev = prev;</span><br><span class="line">            x.next = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        x.item = <span class="literal">null</span>;</span><br><span class="line">        size--;</span><br><span class="line">        modCount++;</span><br><span class="line">        <span class="keyword">return</span> element;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>remove(Object o) æ ¹æ®å€¼æ¥è¿›è¡Œåˆ é™¤.è¿™ä¸ªå¯ä»¥çœ‹å‡ºæ¥ï¼Œå¦‚æœæœ‰äºŒä¸ªç›¸åŒèŠ‚ç‚¹çš„å€¼,è°ƒç”¨ä¸€æ¬¡è¿™ä¸ªæ–¹æ³•æ˜¯åªå¯ä»¥åˆ é™¤ä¸€ä¸ª,è€Œä¸æ˜¯äºŒä¸ª.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">remove</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (o == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Node&lt;E&gt; x = first; x != <span class="literal">null</span>; x = x.next) &#123;</span><br><span class="line">            <span class="keyword">if</span> (x.item == <span class="literal">null</span>) &#123;</span><br><span class="line">                unlink(x);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (Node&lt;E&gt; x = first; x != <span class="literal">null</span>; x = x.next) &#123;</span><br><span class="line">            <span class="keyword">if</span> (o.equals(x.item)) &#123;</span><br><span class="line">                unlink(x);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>å¥½å•¦,ä»Šå¤©çš„çŸ¥è¯†å†…å®¹å°±æ›´æ–°åˆ°è¿™é‡Œ,è™½ç„¶æ–‡å­—æè¿°åˆ°å¾ˆéš¾ç†è§£,ä½†æ˜¯ä¸»è¦å»ç†è§£ Node èŠ‚ç‚¹çš„ åŒå‘æŒ‡å‘,å¹¶ä¸”æ¯æ¬¡æ·»åŠ èŠ‚ç‚¹å’Œåˆ é™¤æ·»åŠ ï¼Œéƒ½æ˜¯é Nodeçš„prevå’Œnextæ¥è¿›è¡ŒæŒ‡å‘. æ‰€ä»¥è¯´LinkedListæ˜¯åˆ é™¤å¿«ï¼ŒæŸ¥è¯¢æ…¢çš„åŸå› ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;è™½ç„¶ä¸€èˆ¬éƒ½æ˜¯ä½¿ç”¨ArrayListé›†åˆæ¯”ä½¿ç”¨LinkedListé›†åˆè¦å¤š,ä½†æ˜¯è¿™å¹¶ä¸å¦¨ç¢æˆ‘ä»¬å¯¹LinkedListçš„æºç ç ”ç©¶å’Œå­¦ä¹ &lt;/p&gt;
&lt;h3 id=&quot;ç»“æ„&quot;&gt;&lt;a href=&quot;#ç»“æ„&quot; class=&quot;headerlink&quot; title=&quot;ç»“æ„&quot;&gt;&lt;/a&gt;ç»“æ„&lt;/h3&gt;</summary>
      
    
    
    
    <category term="java" scheme="https://ruy9527.github.io/categories/java/"/>
    
    <category term="javaé›†åˆ" scheme="https://ruy9527.github.io/categories/java/java%E9%9B%86%E5%90%88/"/>
    
    
    <category term="java" scheme="https://ruy9527.github.io/tags/java/"/>
    
    <category term="javaé›†åˆ" scheme="https://ruy9527.github.io/tags/java%E9%9B%86%E5%90%88/"/>
    
  </entry>
  
  <entry>
    <title>HashMapæºç é˜…è¯»è®°å½•</title>
    <link href="https://ruy9527.github.io/2021/11/04/java/HashMap%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E8%AE%B0%E5%BD%95/"/>
    <id>https://ruy9527.github.io/2021/11/04/java/HashMap%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E8%AE%B0%E5%BD%95/</id>
    <published>2021-11-03T16:14:11.000Z</published>
    <updated>2022-11-04T13:46:13.916Z</updated>
    
    <content type="html"><![CDATA[<p>HashMap è¿™ç§Key,Value çš„å­˜å‚¨ç»“æ„,æ˜¯æˆ‘ä»¬åœ¨å†™ä»£ç ä¸­ç»å¸¸ä½¿ç”¨åˆ°çš„.å¯ä»¥è¯´ä½¿ç”¨æ˜¯éå¸¸é¢‘ç¹çš„,ä¸è¿‡ç°åœ¨ä½¿ç”¨JSONObjectä¹Ÿæ˜¯éå¸¸å¤šçš„,äºŒè€…éƒ½æ˜¯å®ç°äº†Mapæ¥å£ã€‚</p><p>æ‰€ä»¥çœ‹ä¸‹HashMapæºç æ˜¯éå¸¸æœ‰å¿…è¦çš„.</p><hr><h4 id="ç»“æ„"><a href="#ç»“æ„" class="headerlink" title="ç»“æ„"></a>ç»“æ„</h4><p>è¿™é‡Œæˆ‘ä»¬è¦çœ‹ä¸‹ HashMapçš„å†…éƒ¨ç±».</p><p>è¿™é‡Œçš„ Node èŠ‚ç‚¹å°±æ˜¯ HashMapå­˜æ”¾æ•°æ®çš„ç»“æ„. hash è®¡ç®—å‡ºæ¥çš„å“ˆå¸Œå€¼,keyå°±æ˜¯HashMapä¸­çš„key,valueå°±æ˜¯keyå¯¹åº”çš„valueçš„å€¼. è¿™ä¸ª next å°±æ˜¯ key ä¸ä¸€æ ·,è®¡ç®—å‡ºæ¥çš„hashå´æ˜¯ä¸€æ ·çš„,è¿™æ ·å°±æœ‰äº†hashå†²çª,æ‰€ä»¥å°±å°†èŠ‚ç‚¹å­˜æ”¾åœ¨nexté‡Œé¢äº†,ä»å°¾éƒ¨æ’å…¥è¿›å». java8 å,å¦‚æœnextçš„é•¿åº¦æ˜¯å¤§äº8çš„è¯,å°±ä¼šè½¬åŒ–äº†çº¢é»‘æ ‘æ¥å­˜å‚¨,é‚£æ ·è·å–å€¼çš„é€Ÿåº¦å˜å¿«äº†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Node</span>&lt;K,V&gt; <span class="keyword">implements</span> <span class="title class_">Map</span>.Entry&lt;K,V&gt; &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> hash;</span><br><span class="line">    <span class="keyword">final</span> K key;</span><br><span class="line">    V value;</span><br><span class="line">    Node&lt;K,V&gt; next;</span><br><span class="line"></span><br><span class="line">    Node(<span class="type">int</span> hash, K key, V value, Node&lt;K,V&gt; next) &#123;</span><br><span class="line">        <span class="built_in">this</span>.hash = hash;</span><br><span class="line">        <span class="built_in">this</span>.key = key;</span><br><span class="line">        <span class="built_in">this</span>.value = value;</span><br><span class="line">        <span class="built_in">this</span>.next = next;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> K <span class="title function_">getKey</span><span class="params">()</span>        &#123; <span class="keyword">return</span> key; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> V <span class="title function_">getValue</span><span class="params">()</span>      &#123; <span class="keyword">return</span> value; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String <span class="title function_">toString</span><span class="params">()</span> &#123; <span class="keyword">return</span> key + <span class="string">&quot;=&quot;</span> + value; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Objects.hashCode(key) ^ Objects.hashCode(value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> V <span class="title function_">setValue</span><span class="params">(V newValue)</span> &#123;</span><br><span class="line">        <span class="type">V</span> <span class="variable">oldValue</span> <span class="operator">=</span> value;</span><br><span class="line">        value = newValue;</span><br><span class="line">        <span class="keyword">return</span> oldValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (o == <span class="built_in">this</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (o <span class="keyword">instanceof</span> Map.Entry) &#123;</span><br><span class="line">            Map.Entry&lt;?,?&gt; e = (Map.Entry&lt;?,?&gt;)o;</span><br><span class="line">            <span class="keyword">if</span> (Objects.equals(key, e.getKey()) &amp;&amp;</span><br><span class="line">                Objects.equals(value, e.getValue()))</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>TreeNode è¿™ä¸ªå†…éƒ¨ç±»å°±æ˜¯è¡¨ç¤ºçº¢é»‘æ ‘çš„. TODO åç»­è¿›è¡Œæ›´æ–°.</p><p>å‚æ•°, å¯ä»¥çœ‹åˆ° HashMap æ˜¯ä½¿ç”¨äº†ä¸€ä¸ªæ•°ç»„æ¥è¿›è¡Œå­˜å‚¨ NodeèŠ‚ç‚¹.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">transient</span> Node&lt;K,V&gt;[] table;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">transient</span> <span class="type">int</span> size;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">DEFAULT_INITIAL_CAPACITY</span> <span class="operator">=</span> <span class="number">1</span> &lt;&lt; <span class="number">4</span>; <span class="comment">// aka 16</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MAXIMUM_CAPACITY</span> <span class="operator">=</span> <span class="number">1</span> &lt;&lt; <span class="number">30</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">float</span> <span class="variable">DEFAULT_LOAD_FACTOR</span> <span class="operator">=</span> <span class="number">0.75f</span>;</span><br></pre></td></tr></table></figure><hr><h4 id="æ–¹æ³•"><a href="#æ–¹æ³•" class="headerlink" title="æ–¹æ³•"></a>æ–¹æ³•</h4><p> æ„é€ å‡½æ•°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Constructs an empty &lt;tt&gt;HashMap&lt;/tt&gt; with the default initial capacity</span></span><br><span class="line"><span class="comment"> * (16) and the default load factor (0.75).</span></span><br><span class="line"><span class="comment"> å½“ä½¿ç”¨æ— å‚æ„é€ å‡½æ•°çš„æ—¶å€™,åªæ˜¯å¯¹ loadFactor è¿›è¡Œäº†èµ‹å€¼æ“ä½œ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">HashMap</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.loadFactor = DEFAULT_LOAD_FACTOR; <span class="comment">// all other fields defaulted</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¼ é€’ä¸€ä¸ªintç±»å‹çš„å‚æ•°æ—¶å€™,å°±ä¼šè®¡æ¯å¾€ä¸‹è°ƒç”¨æ„é€ å‡½æ•°</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">HashMap</span><span class="params">(<span class="type">int</span> initialCapacity)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(initialCapacity, DEFAULT_LOAD_FACTOR);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">å¯¹å€¼è¿›è¡Œåˆ¤æ–­,æ€•ä½ å¯èƒ½ä¼ å…¥è¿›æ¥ä¸€ä¸ªè´Ÿæ•°æ¥æµ‹è¯•ç©ç©å“ˆå“ˆå“ˆã€‚</span></span><br><span class="line"><span class="comment">æœ€åè°ƒç”¨åˆ°äº†tableSizeForæ–¹æ³•,å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ–¹æ³•æ˜¯å¯¹ä¼ å…¥è¿›æ¥çš„å‚æ•°,è¿›è¡Œä¸€è¿ä¸²çš„ä½è¿ç®—.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">HashMap</span><span class="params">(<span class="type">int</span> initialCapacity, <span class="type">float</span> loadFactor)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (initialCapacity &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Illegal initial capacity: &quot;</span> +</span><br><span class="line">                                               initialCapacity);</span><br><span class="line">        <span class="keyword">if</span> (initialCapacity &gt; MAXIMUM_CAPACITY)</span><br><span class="line">            initialCapacity = MAXIMUM_CAPACITY;</span><br><span class="line">        <span class="keyword">if</span> (loadFactor &lt;= <span class="number">0</span> || Float.isNaN(loadFactor))</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Illegal load factor: &quot;</span> +</span><br><span class="line">                                               loadFactor);</span><br><span class="line">        <span class="built_in">this</span>.loadFactor = loadFactor;</span><br><span class="line">        <span class="built_in">this</span>.threshold = tableSizeFor(initialCapacity);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">tableSizeFor</span><span class="params">(<span class="type">int</span> cap)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> cap - <span class="number">1</span>;</span><br><span class="line">        n |= n &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">        n |= n &gt;&gt;&gt; <span class="number">2</span>;</span><br><span class="line">        n |= n &gt;&gt;&gt; <span class="number">4</span>;</span><br><span class="line">        n |= n &gt;&gt;&gt; <span class="number">8</span>;</span><br><span class="line">        n |= n &gt;&gt;&gt; <span class="number">16</span>;</span><br><span class="line">        <span class="keyword">return</span> (n &lt; <span class="number">0</span>) ? <span class="number">1</span> : (n &gt;= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¼ å…¥ Map çš„å®ç°ç±»çš„è¯,å°±æ˜¯å¾€ä¸‹ç»§ç»­è°ƒç”¨ putMapEntriesæ–¹æ³•</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">HashMap</span><span class="params">(Map&lt;? extends K, ? extends V&gt; m)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.loadFactor = DEFAULT_LOAD_FACTOR;</span><br><span class="line">        putMapEntries(m, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">ä¼ å…¥ m.size()çš„é•¿åº¦,é•¿åº¦å¤§äº0å°±ä¼šèµ°é€»è¾‘ä»£ç .æœ€åå¯ä»¥çœ‹åˆ° è¿­ä»£äº†m,ç„¶åè°ƒç”¨putValæ¥å°†å€¼æ”¾å…¥Mapä¸­</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">putMapEntries</span><span class="params">(Map&lt;? extends K, ? extends V&gt; m, <span class="type">boolean</span> evict)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">s</span> <span class="operator">=</span> m.size();</span><br><span class="line">        <span class="keyword">if</span> (s &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (table == <span class="literal">null</span>) &#123; <span class="comment">// pre-size</span></span><br><span class="line">                <span class="type">float</span> <span class="variable">ft</span> <span class="operator">=</span> ((<span class="type">float</span>)s / loadFactor) + <span class="number">1.0F</span>;</span><br><span class="line">                <span class="type">int</span> <span class="variable">t</span> <span class="operator">=</span> ((ft &lt; (<span class="type">float</span>)MAXIMUM_CAPACITY) ?</span><br><span class="line">                         (<span class="type">int</span>)ft : MAXIMUM_CAPACITY);</span><br><span class="line">                <span class="keyword">if</span> (t &gt; threshold)</span><br><span class="line">                    threshold = tableSizeFor(t);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (s &gt; threshold)</span><br><span class="line">                resize();</span><br><span class="line">            <span class="keyword">for</span> (Map.Entry&lt;? <span class="keyword">extends</span> <span class="title class_">K</span>, ? <span class="keyword">extends</span> <span class="title class_">V</span>&gt; e : m.entrySet()) &#123;</span><br><span class="line">                <span class="type">K</span> <span class="variable">key</span> <span class="operator">=</span> e.getKey();</span><br><span class="line">                <span class="type">V</span> <span class="variable">value</span> <span class="operator">=</span> e.getValue();</span><br><span class="line">                putVal(hash(key), key, value, <span class="literal">false</span>, evict);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>put æ·»åŠ æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> V <span class="title function_">put</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> putVal(hash(key), key, value, <span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ¹æ®ä¼ å…¥è¿›æ¥çš„keyæ¥è®¡ç®—å¯¹åº”çš„hashå€¼</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">hash</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">        <span class="type">int</span> h;</span><br><span class="line">        <span class="keyword">return</span> (key == <span class="literal">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">putVal å°±æ˜¯ </span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">final</span> V <span class="title function_">putVal</span><span class="params">(<span class="type">int</span> hash, K key, V value, <span class="type">boolean</span> onlyIfAbsent,</span></span><br><span class="line"><span class="params">                   <span class="type">boolean</span> evict)</span> &#123;</span><br><span class="line">        <span class="comment">// å®šä¹‰ä¸€äº›å˜é‡</span></span><br><span class="line">        Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; <span class="type">int</span> n, i;</span><br><span class="line">    <span class="comment">// table èµ‹å€¼ç»™ tab å¹¶åˆ¤æ–­æ˜¯å¦ç­‰äºnull æˆ–è€… tabçš„é•¿åº¦æ˜¯å¦ç­‰äº0,å¦‚æœæ˜¯çš„è¯ï¼Œå°±ä¼šè°ƒç”¨resizeæ¥è¿›è¡Œæ‰©å®¹</span></span><br><span class="line">        <span class="keyword">if</span> ((tab = table) == <span class="literal">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">            n = (tab = resize()).length;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span> ((p = tab[i = (n - <span class="number">1</span>) &amp; hash]) == <span class="literal">null</span>)</span><br><span class="line">            tab[i] = newNode(hash, key, value, <span class="literal">null</span>);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            Node&lt;K,V&gt; e; K k;</span><br><span class="line">            <span class="keyword">if</span> (p.hash == hash &amp;&amp;</span><br><span class="line">                ((k = p.key) == key || (key != <span class="literal">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">                e = p;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (p <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">                e = ((TreeNode&lt;K,V&gt;)p).putTreeVal(<span class="built_in">this</span>, tab, hash, key, value);</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">binCount</span> <span class="operator">=</span> <span class="number">0</span>; ; ++binCount) &#123;</span><br><span class="line">                    <span class="keyword">if</span> ((e = p.next) == <span class="literal">null</span>) &#123;</span><br><span class="line">                        p.next = newNode(hash, key, value, <span class="literal">null</span>);</span><br><span class="line">                        <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span class="number">1</span>) <span class="comment">// -1 for 1st</span></span><br><span class="line">                            treeifyBin(tab, hash);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                        ((k = e.key) == key || (key != <span class="literal">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    p = e;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (e != <span class="literal">null</span>) &#123; <span class="comment">// existing mapping for key</span></span><br><span class="line">                <span class="type">V</span> <span class="variable">oldValue</span> <span class="operator">=</span> e.value;</span><br><span class="line">                <span class="keyword">if</span> (!onlyIfAbsent || oldValue == <span class="literal">null</span>)</span><br><span class="line">                    e.value = value;</span><br><span class="line">                afterNodeAccess(e);</span><br><span class="line">                <span class="keyword">return</span> oldValue;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ++modCount;</span><br><span class="line">        <span class="keyword">if</span> (++size &gt; threshold)</span><br><span class="line">            resize();</span><br><span class="line">        afterNodeInsertion(evict);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">æ‰©å®¹æ–¹æ³•</span></span><br><span class="line"><span class="comment">tableä½¿ç”¨ oldTabæ¥è¿›è¡Œå­˜å‚¨,æ‹¿å‡ºoldTabçš„é•¿åº¦(å¦‚æœoldTabæ˜¯nullçš„è¯,å¯¹åº”çš„é•¿åº¦å°±æ˜¯ä¸º0).</span></span><br><span class="line"><span class="comment">oldThr æ˜¯ è®°å½• threshold ä¹‹å‰çš„å€¼, newCap / newThrå°±æ˜¯éœ€è¦æ‰©å®¹ä½¿ç”¨åˆ°çš„å˜é‡å‘½å.</span></span><br><span class="line"><span class="comment">è¿™é‡Œåˆ†ä¸º </span></span><br><span class="line"><span class="comment">1 : oldCap æ˜¯å¤§äº0çš„ã€‚ å¦‚æœæ¯” MAXIMUM_CAPACITY è¿˜æ˜¯è¦å¤§çš„è¯,å°±è¯´æ˜é‡Œé¢å­˜å‚¨çš„å…ƒç´ æ˜¯å¤ªå¤šäº†,å°±ç›´æ¥è¿”å›oldTab.  è¿˜æœ‰ä¸€ç§å°±æ˜¯ newCapç­‰äºoldCapçš„1.5å€å¹¶ä¸”å°äºMAXIMUM_CAPACITYå’ŒoldCapæ˜¯å¤§äºé»˜è®¤16çš„,å°±ä¼šè¿›è¡Œ1.5å€çš„æ‰©å®¹</span></span><br><span class="line"><span class="comment">2 : oldThr å¤§äº 0, newCap(æ‰©å®¹æ–°é•¿åº¦) å°±æ˜¯ç­‰äº oldTheçš„å€¼.</span></span><br><span class="line"><span class="comment">3 : å¦åˆ™å°±æ˜¯éƒ½ä½¿ç”¨é»˜è®¤çš„å€¼å¤§å°</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">final</span> Node&lt;K,V&gt;[] resize() &#123;</span><br><span class="line">        Node&lt;K,V&gt;[] oldTab = table;</span><br><span class="line">        <span class="type">int</span> <span class="variable">oldCap</span> <span class="operator">=</span> (oldTab == <span class="literal">null</span>) ? <span class="number">0</span> : oldTab.length;</span><br><span class="line">        <span class="type">int</span> <span class="variable">oldThr</span> <span class="operator">=</span> threshold;</span><br><span class="line">        <span class="type">int</span> newCap, newThr = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (oldCap &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (oldCap &gt;= MAXIMUM_CAPACITY) &#123;</span><br><span class="line">                threshold = Integer.MAX_VALUE;</span><br><span class="line">                <span class="keyword">return</span> oldTab;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((newCap = oldCap &lt;&lt; <span class="number">1</span>) &lt; MAXIMUM_CAPACITY &amp;&amp;</span><br><span class="line">                     oldCap &gt;= DEFAULT_INITIAL_CAPACITY)</span><br><span class="line">                newThr = oldThr &lt;&lt; <span class="number">1</span>; <span class="comment">// double threshold</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (oldThr &gt; <span class="number">0</span>) <span class="comment">// initial capacity was placed in threshold</span></span><br><span class="line">            newCap = oldThr;</span><br><span class="line">        <span class="keyword">else</span> &#123;               <span class="comment">// zero initial threshold signifies using defaults</span></span><br><span class="line">            newCap = DEFAULT_INITIAL_CAPACITY;</span><br><span class="line">            newThr = (<span class="type">int</span>)(DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (newThr == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="type">float</span> <span class="variable">ft</span> <span class="operator">=</span> (<span class="type">float</span>)newCap * loadFactor;</span><br><span class="line">            newThr = (newCap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; (<span class="type">float</span>)MAXIMUM_CAPACITY ?</span><br><span class="line">                      (<span class="type">int</span>)ft : Integer.MAX_VALUE);</span><br><span class="line">        &#125;</span><br><span class="line">        threshold = newThr;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    ä½¿ç”¨æ‰©å®¹åçš„newCapæ¥åˆ›å»ºä¸€ä¸ªæ•°ç»„,oldTabä¸æ˜¯null,ç„¶åå°±éœ€è¦å°†è€çš„å€¼èµ‹å€¼åˆ°æ–°çš„newTabé‡Œé¢æ¥.</span></span><br><span class="line"><span class="comment">        ä½¿ç”¨ä¸‹æ ‡æ¥è¿›è¡Œè¿­ä»£,è·å–æ¯ä¸ªä¸‹æ ‡çš„NodeèŠ‚ç‚¹çš„å€¼,ç„¶oldTab[j]èµ‹å€¼ç»™eå,ç„¶åå°†oldTab[j]é‡ç½®ä¸ºnull.</span></span><br><span class="line"><span class="comment">        è¿™é‡Œé¢çš„è¿›è¡ŒNodeå¤åˆ¶æ˜¯æœ‰åˆ†ä¸ºä¸‹é¢å‡ ç§, Nodeçš„nextèŠ‚ç‚¹æ˜¯æ²¡æœ‰å€¼å¾—,nextä¸‹é¢æ˜¯ç”±å€¼,eèŠ‚ç‚¹è½¬åŒ–ä¸ºäº†çº¢é»‘æ ‘.</span></span><br><span class="line"><span class="comment">        1 : å¦‚æœe.nextæ˜¯null,ä¹Ÿå°±æ˜¯æ²¡æœ‰å€¼,newTab[e.hash &amp; (newCap - 1)] = eæ¥èµ‹å€¼.</span></span><br><span class="line"><span class="comment">        2 : å¦‚æœeæ˜¯TreeNodeçš„è¯,å°±ä¼šè°ƒç”¨((TreeNode&lt;K,V&gt;)e).split(this, newTab, j, oldCap)æ–¹æ³•.</span></span><br><span class="line"><span class="comment">        3 : ç„¶åå¯ä»¥çœ‹åˆ° do while å¾ªç¯é‡Œé¢, while é‡Œé¢çš„æ¡ä»¶æ˜¯ e.next != null æ‰ä¼šè¿›å»,ä¹Ÿå°±æ˜¯nextæ˜¯ç”±å€¼å¾—æƒ…å†µä¸‹æ‰ä¼šè¿›å…¥åˆ°è¿™é‡Œé¢æ¥.ç„¶åå¯ä»¥çœ‹åˆ°ä¸€äº›ç³»å–èŠ‚ç‚¹å•Š,èµ‹å€¼ç»™å˜é‡å•Š,ç„¶åèµ‹å€¼ç»™æ–°åˆ›å»ºçš„Nodeæ•°ç»„ä¸‹æ ‡ç„¶åå°†ä¹‹å‰çš„nodeèŠ‚ç‚¹é‡ç½®ä¸ºnullã€‚ è¿™é‡Œå°±éœ€è¦è¯»è€…å¯¹è¿™äº›ä»£ç æ¥æ…¢æ…¢æ¶ˆåŒ–äº†.ä»”ç»†æƒ³çœ‹,å°±æ˜¯å¯¹nodeèŠ‚ç‚¹çš„å–å€¼,èµ‹å€¼,é‡ç½®ç­‰æ“ä½œ.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">        <span class="meta">@SuppressWarnings(&#123;&quot;rawtypes&quot;,&quot;unchecked&quot;&#125;)</span></span><br><span class="line">        Node&lt;K,V&gt;[] newTab = (Node&lt;K,V&gt;[])<span class="keyword">new</span> <span class="title class_">Node</span>[newCap];</span><br><span class="line">        table = newTab;</span><br><span class="line">        <span class="keyword">if</span> (oldTab != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; oldCap; ++j) &#123;</span><br><span class="line">                Node&lt;K,V&gt; e;</span><br><span class="line">                <span class="keyword">if</span> ((e = oldTab[j]) != <span class="literal">null</span>) &#123;</span><br><span class="line">                    oldTab[j] = <span class="literal">null</span>;</span><br><span class="line">                    <span class="keyword">if</span> (e.next == <span class="literal">null</span>)</span><br><span class="line">                        newTab[e.hash &amp; (newCap - <span class="number">1</span>)] = e;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">                        ((TreeNode&lt;K,V&gt;)e).split(<span class="built_in">this</span>, newTab, j, oldCap);</span><br><span class="line">                    <span class="keyword">else</span> &#123; <span class="comment">// preserve order</span></span><br><span class="line">                        Node&lt;K,V&gt; loHead = <span class="literal">null</span>, loTail = <span class="literal">null</span>;</span><br><span class="line">                        Node&lt;K,V&gt; hiHead = <span class="literal">null</span>, hiTail = <span class="literal">null</span>;</span><br><span class="line">                        Node&lt;K,V&gt; next;</span><br><span class="line">                        <span class="keyword">do</span> &#123;</span><br><span class="line">                            next = e.next;</span><br><span class="line">                            <span class="keyword">if</span> ((e.hash &amp; oldCap) == <span class="number">0</span>) &#123;</span><br><span class="line">                                <span class="keyword">if</span> (loTail == <span class="literal">null</span>)</span><br><span class="line">                                    loHead = e;</span><br><span class="line">                                <span class="keyword">else</span></span><br><span class="line">                                    loTail.next = e;</span><br><span class="line">                                loTail = e;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">else</span> &#123;</span><br><span class="line">                                <span class="keyword">if</span> (hiTail == <span class="literal">null</span>)</span><br><span class="line">                                    hiHead = e;</span><br><span class="line">                                <span class="keyword">else</span></span><br><span class="line">                                    hiTail.next = e;</span><br><span class="line">                                hiTail = e;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">while</span> ((e = next) != <span class="literal">null</span>);</span><br><span class="line">                        <span class="keyword">if</span> (loTail != <span class="literal">null</span>) &#123;</span><br><span class="line">                            loTail.next = <span class="literal">null</span>;</span><br><span class="line">                            newTab[j] = loHead;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (hiTail != <span class="literal">null</span>) &#123;</span><br><span class="line">                            hiTail.next = <span class="literal">null</span>;</span><br><span class="line">                            newTab[j + oldCap] = hiHead;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> newTab;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>get æ–¹æ³•,æ˜¯é€šè¿‡keyæ¥è·å–å‡ºå¯¹åº”çš„value.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> V <span class="title function_">get</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    Node&lt;K,V&gt; e;</span><br><span class="line">    <span class="keyword">return</span> (e = getNode(hash(key), key)) == <span class="literal">null</span> ? <span class="literal">null</span> : e.value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¼ å…¥keyæ¥è®¡ç®—å‡ºå“ˆå¸Œå€¼</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">hash</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">        <span class="type">int</span> h;</span><br><span class="line">        <span class="keyword">return</span> (key == <span class="literal">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">å¦‚æœ tableä¸æ˜¯Null,å¹¶ä¸”é•¿åº¦æ˜¯å¤§äº0çš„,èƒ½å¤Ÿæ ¹æ® (n-1) &amp; hash å¾—å‡ºæ¥çš„ä¸‹æ ‡æ˜¯åœ¨tabé‡Œé¢èƒ½è·å–åˆ°å€¼å¾—,æ‰ä¼šè¿›å…¥é€»è¾‘ä»£ç ,å¦åˆ™å°±æ˜¯è¿”å›null.</span></span><br><span class="line"><span class="comment">å¦‚æœfirstçš„hashæ˜¯äºä¼ å…¥è¿›æ¥çš„hashç›¸åŒ,æ–Œä¸”ç»™keyçš„å€¼ä¹Ÿæ˜¯ç›¸åŒçš„è¯,å°±ä¼šè¿”å›firstèŠ‚ç‚¹.</span></span><br><span class="line"><span class="comment">æ‹¿nodeçš„nextèŠ‚ç‚¹,å¦‚æœæ˜¯TreeNodeçš„ç±»,å°±ä¼šèµ°TreeNodeå¯¹åº”çš„getTreeNodeæ–¹æ³•(é“¾è¡¨çš„é•¿åº¦å¤§äº8å°±ä¼šè½¬åŒ–ä¸ºçº¢é»‘æ ‘). å¦åˆ™çš„è¯å°±å°±è¿­ä»£è¿™ä¸ªNode,é€€å‡ºçš„æ¡ä»¶å°±æ˜¯ e.next == null,å°±è¯´è¯´æ˜ä¸‹é¢æ²¡æœ‰å¯¹åº”çš„èŠ‚ç‚¹äº†ã€‚</span></span><br><span class="line"><span class="comment">è¿™é‡Œæ‹¿å€¼å¾—é€»è¾‘,è¿˜æ˜¯æ¯”è¾ƒå®¹æ˜“ç†è§£å¾—ã€‚ å…ˆæ ¹æ®è®¡ç®—å‡ºæ¥å¾—hashå€¼,å»æ•°ç»„ä¸­æ˜¯å¦å¯ä»¥è·å–åˆ°å¯¹åº”å¾—å€¼,å¦‚æœæœ‰å°±å…ˆä¼šå¯¹firstè¿›è¡Œåˆ¤æ–­,æ˜¯å¦æ»¡è¶³æ¡ä»¶.å¦‚æœä¸æ»¡è¶³çš„è¯,å°±è¯´æ˜è¿™ä¸ªkeyçš„hashæ˜¯ç”±å†²çªçš„,ä¹Ÿå°±æ˜¯ç”±äºŒä¸ªä¸åŒçš„å€¼,è®¡ç®—å‡ºæ¥ç›¸åŒçš„hashå€¼,è¿™ä¸ªæ—¶å€™å°±ä¼šç”¨é“¾è¡¨(Node)æ¥è¿›è¡Œå­˜å‚¨,å¦‚æœé•¿åº¦æ˜¯å¤§äº8çš„è¯,å°±ä¼šè½¬åŒ–ä¸ºTreeNodeçš„çº¢é»‘æ ‘.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">final</span> Node&lt;K,V&gt; <span class="title function_">getNode</span><span class="params">(<span class="type">int</span> hash, Object key)</span> &#123;</span><br><span class="line">        Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; first, e; <span class="type">int</span> n; K k;</span><br><span class="line">        <span class="keyword">if</span> ((tab = table) != <span class="literal">null</span> &amp;&amp; (n = tab.length) &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">            (first = tab[(n - <span class="number">1</span>) &amp; hash]) != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (first.hash == hash &amp;&amp; <span class="comment">// always check first node</span></span><br><span class="line">                ((k = first.key) == key || (key != <span class="literal">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">                <span class="keyword">return</span> first;</span><br><span class="line">            <span class="keyword">if</span> ((e = first.next) != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (first <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">                    <span class="keyword">return</span> ((TreeNode&lt;K,V&gt;)first).getTreeNode(hash, key);</span><br><span class="line">                <span class="keyword">do</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                        ((k = e.key) == key || (key != <span class="literal">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">                        <span class="keyword">return</span> e;</span><br><span class="line">                &#125; <span class="keyword">while</span> ((e = e.next) != <span class="literal">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>isEmpty æ–¹æ³•,è¿™é‡Œå°±ç›´æ¥ä½¿ç”¨ size &#x3D;&#x3D; 0 æ¥è¿›è¡Œåˆ¤æ–­,å¦‚æœä½ çš„mapæ˜¯nullçš„è¯,ç›´æ¥è°ƒç”¨è¿™ä¸ªæ–¹æ³•å°±ä¼šå‡ºç°ç©ºæŒ‡é’ˆ.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isEmpty</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> size == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p> è¿™é‡Œåªæ˜¯é€‰ç”¨äº† put å’Œ getæ–¹æ³•æ¥è¿›è¡Œè®²è§£,å› ä¸ºè¿™äºŒä¸ªæ˜¯ç»å¸¸è°ƒç”¨çš„,æ‰€ä»¥å¾—æ˜ç™½æ˜¯ä¸€ä¸ªæ€ä¹ˆæ ·å¾—å¤§ä½“æµç¨‹èµ°å‘æ‰è¡Œ.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;HashMap è¿™ç§Key,Value çš„å­˜å‚¨ç»“æ„,æ˜¯æˆ‘ä»¬åœ¨å†™ä»£ç ä¸­ç»å¸¸ä½¿ç”¨åˆ°çš„.å¯ä»¥è¯´ä½¿ç”¨æ˜¯éå¸¸é¢‘ç¹çš„,ä¸è¿‡ç°åœ¨ä½¿ç”¨JSONObjectä¹Ÿæ˜¯éå¸¸å¤šçš„,äºŒè€…éƒ½æ˜¯å®ç°äº†Mapæ¥å£ã€‚&lt;/p&gt;
&lt;p&gt;æ‰€ä»¥çœ‹ä¸‹HashMapæºç æ˜¯éå¸¸æœ‰å¿…è¦çš„.&lt;/p&gt;
&lt;hr&gt;
&lt;h4 id=&quot;ç»“</summary>
      
    
    
    
    <category term="java" scheme="https://ruy9527.github.io/categories/java/"/>
    
    <category term="javaé›†åˆ" scheme="https://ruy9527.github.io/categories/java/java%E9%9B%86%E5%90%88/"/>
    
    
    <category term="java" scheme="https://ruy9527.github.io/tags/java/"/>
    
    <category term="javaé›†åˆ" scheme="https://ruy9527.github.io/tags/java%E9%9B%86%E5%90%88/"/>
    
  </entry>
  
</feed>
