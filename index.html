<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="/images/icons/xiaoxin_toouxiang.jpg?v=2.6.2" type="image/png" sizes="16x16"><link rel="icon" href="/images/icons/xiaoxin_toouxiang.jpg?v=2.6.2" type="image/png" sizes="32x32"><meta name="description" content="LuoHong Blog">
<meta property="og:type" content="website">
<meta property="og:title" content="LuoHong">
<meta property="og:url" content="https://ruy9527.github.io/index.html">
<meta property="og:site_name" content="LuoHong">
<meta property="og:description" content="LuoHong Blog">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="LuoHong">
<meta name="twitter:card" content="summary"><title>LuoHong</title><link ref="canonical" href="https://ruy9527.github.io/index.html"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.6.2"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  assistSearch: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":6},
  header: {"enable":true,"showOnPost":true,"scrollDownIcon":false},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"default","highlight":"light","wordWrap":true},
  reward: false,
  fancybox: false,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: false,
  pjax: undefined,
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"å¤åˆ¶","copySuccess":"å¤åˆ¶æˆåŠŸ","copyError":"å¤åˆ¶å¤±è´¥"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 5.4.0"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner"><nav class="header-nav header-nav--fixed"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">é¦–é¡µ</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">å½’æ¡£</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">åˆ†ç±»</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/tags/"><span class="header-nav-menu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-menu-item__text">æ ‡ç­¾</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/aboutme/"><span class="header-nav-menu-item__icon"><i class="fas fa-book"></i></span><span class="header-nav-menu-item__text">me</span></a></div></div><div class="header-nav-search"><span class="header-nav-search__icon"><i class="fas fa-search"></i></span><span class="header-nav-search__text">æœç´¢</span></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav><div class="header-banner"><div class="header-banner-info"><div class="header-banner-info__title">LuoHong</div><div class="header-banner-info__subtitle"></div></div></div></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content content-home" id="content"><section class="postlist"><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/11/04/mybatis/mybatis%E4%B8%8Espringboot%E6%95%B4%E5%90%88%E9%98%85%E8%AF%BB/">mybatisä¸springbootæ•´åˆé˜…è¯»</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">å‘è¡¨äº</span><span class="post-meta-item__value">2021-11-04</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">æ›´æ–°äº</span><span class="post-meta-item__value">2021-11-04</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">å­—æ•°ç»Ÿè®¡</span><span class="post-meta-item__value">3.2k</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="far fa-clock"></i></span><span class="post-meta-item__info">é˜…è¯»æ—¶é•¿</span><span class="post-meta-item__value">24åˆ†</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h4 id="å‰æ"   >
          <a href="#å‰æ" class="heading-link"><i class="fas fa-link"></i></a><a href="#å‰æ" class="headerlink" title="å‰æ"></a>å‰æ</h4>
      <p> MyBatis ä¸ SpringBoot æ•´åˆæ“ä½œ. åœ¨è¿™æ¬¡æ•´åˆçš„è¿‡ç¨‹ä¸­,å†æ¬¡æ˜ç™½è‡ªå·±æ¯«æ— ç–‘é—®çš„æ˜¯ä¸€ä¸ªæ¯”è¾ƒæ‰‹æ®‹çš„åŒå­¦äº†.</p>
<p> è¿™é‡Œæˆ‘ä»¬æ˜¯åŸºäº sql è¯­å¥å†™åœ¨ xml é‡Œé¢è¿›è¡Œæ•´åˆçš„æ“ä½œ.</p>

        <h4 id="å…¥é—¨"   >
          <a href="#å…¥é—¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#å…¥é—¨" class="headerlink" title="å…¥é—¨"></a>å…¥é—¨</h4>
      <p> è¿™é‡Œè¯´ä¸‹åˆ›å»ºä¸€ä¸ª å…¥é—¨ é¡¹ç›®çš„å¤§è‡´æµç¨‹.</p>
<p> å…ˆåˆ›å»ºä¸€ä¸ª SpringBoot é¡¹ç›® , å¼•å…¥ä¾èµ– : <span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/baoyang23/mybtatis-analysis/blob/master/mybatis-spring-boot-hello/pom.xml" >https://github.com/baoyang23/mybtatis-analysis/blob/master/mybatis-spring-boot-hello/pom.xml</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p> åˆ›å»º MyBatis çš„é…ç½®æ–‡ä»¶ä¿¡æ¯ : <span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/baoyang23/mybtatis-analysis/blob/master/mybatis-spring-boot-hello/src/main/resources/mybatis-config.xml" >https://github.com/baoyang23/mybtatis-analysis/blob/master/mybatis-spring-boot-hello/src/main/resources/mybatis-config.xml</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p> åˆ›å»ºæŸ¥è¯¢çš„ sql è¯­å¥ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„ mapper æ–‡ä»¶ : <span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/baoyang23/mybtatis-analysis/tree/master/mybatis-spring-boot-hello/src/main/resources/mapper" >https://github.com/baoyang23/mybtatis-analysis/tree/master/mybatis-spring-boot-hello/src/main/resources/mapper</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p> application.properties : <span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/baoyang23/mybtatis-analysis/blob/master/mybatis-spring-boot-hello/src/main/resources/application.properties" >https://github.com/baoyang23/mybtatis-analysis/blob/master/mybatis-spring-boot-hello/src/main/resources/application.properties</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p> æ‰«æ mapper æ¥å£ : @MapperScan(basePackages = {â€œcom.iyang.mybatis.springboot.hello.mapperâ€}) <span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/baoyang23/mybtatis-analysis/blob/master/mybatis-spring-boot-hello/src/main/java/com/iyang/mybatis/springboot/hello/MybatisSpringBootHelloApplication.java" >https://github.com/baoyang23/mybtatis-analysis/blob/master/mybatis-spring-boot-hello/src/main/java/com/iyang/mybatis/springboot/hello/MybatisSpringBootHelloApplication.java</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>è¿™é‡Œæ˜¯æ²¡æœ‰å¼•å…¥ web ä¾èµ–çš„ , ç›´æ¥å¯åŠ¨ main æ–¹æ³• , ç„¶åå°±å¯ä»¥çœ‹åˆ°æˆ‘ä»¬æŸ¥è¯¢å‡ºæ¥çš„ç»“æœäº†.</p>
<p>å¦‚æœä½ ç†Ÿæ‚‰ SpringBoot æºç çš„è¯ï¼Œå°±ä¼šæ™“å¾—æœ‰ä¸€ä¸ªè‡ªåŠ¨è£…é…çš„æ“ä½œ.</p>
<p>å¦‚æœä¸ç†Ÿæ‚‰çš„è¯ï¼Œé‚£ä¹ˆå°±åªèƒ½é€šè¿‡ @MapperScan(basePackages = {â€œcom.iyang.mybatis.springboot.hello.mapperâ€}) å»çœ‹ , è¿™æ ·æœ‰äº›æ˜¯ä¾èµ–è‡ªåŠ¨è£…é…ï¼ˆspring.factoriesï¼‰ ä¸­çš„é…ç½®åŠ è½½çš„, æ‰€ä»¥è¿™é‡Œå»ºè®®åœ¨çœ‹ä¹‹å‰ï¼Œå¦‚æœæ˜¯æœ‰ä¸€ç‚¹ SpringBoot æ‰©å±•çš„çŸ¥è¯†äº†è§£æ˜¯å¾ˆå¥½çš„ã€‚å¦‚æœæ²¡æœ‰æ€ä¹ˆåŠå‘¢ï¼Ÿæ²¡æœ‰å°±æ¥çœ‹æˆ‘æ¥ä¸‹æ¥çš„å†…å®¹ã€‚</p>
<p>å…¶å®è¿™ä¸ªåœ°æ–¹ä½ ä»”ç»†æƒ³ä¸‹ï¼Œåœ¨ MyBatis ä¸ Spring æ•´åˆçš„æ—¶å€™ï¼Œé€šè¿‡ xml çš„æ–¹å¼ç»™ MyBatis çš„bean å·²ç» mybatis-spring ä¸­è‡ªå·±å†™çš„æ‰«æç±»ï¼Œæœ€åå°†æ‰«æå‡ºæ¥çš„ bd åœ¨è¿˜æ²¡åˆå§‹åŒ–ä¹‹å‰ï¼Œå°†bd çš„beanClass æ›¿æ¢ä¸ºæˆ‘ä»¬çš„ä»£ç†ç±».</p>
<p>é‚£ä¹ˆï¼ŒSpringBoot ä¸ MyBatis æ•´åˆçš„æ—¶å€™ï¼Œæœ€åè¦åšçš„äº‹æƒ…æ˜¯ä¸æ˜¯ä¹Ÿæ˜¯å°† MyBatis çš„ä¿¡æ¯æ³¨å…¥åˆ° SpringBoot æ¥å‘¢ï¼Ÿåªä¸è¿‡ï¼ŒSpringBoot å°±ä¸åƒ Spring ä¸€æ ·äº†ï¼Œè¿˜å°† bean çš„ä¿¡æ¯é…ç½®åˆ° xml æ–‡ä»¶ä¸­.</p>
<p>äºæ˜¯ï¼Œæ¥ä¸‹æ¥è·Ÿæˆ‘çš„é˜…è¯»&amp;åˆ†ææ¥ä¸€æ­¥ä¸€æ­¥çš„å¾€ä¸‹çœ‹.</p>

        <h4 id="æ–¹æ³•åˆ†æ"   >
          <a href="#æ–¹æ³•åˆ†æ" class="heading-link"><i class="fas fa-link"></i></a><a href="#æ–¹æ³•åˆ†æ" class="headerlink" title="æ–¹æ³•åˆ†æ"></a>æ–¹æ³•åˆ†æ</h4>
      <p> <strong>å…³æ³¨ç‚¹ä¸€</strong> : è¿™é‡Œæˆ‘ä»¬ç‚¹å…¥åˆ° org.mybatis.spring.annotation.MapperScan æ³¨è§£é‡Œé¢æ¥ï¼Œå¯ä»¥çœ‹åˆ°æœ‰ä¸€ä¸ª @Import(MapperScannerRegistrar.class) , äºæ˜¯æˆ‘ä»¬é¡ºæ‰‹è·Ÿè¿›æ¥ : org.mybatis.spring.annotation.MapperScannerRegistrar , ä»åå­—ä¸Šæ¥ï¼Œè¿™ä¸ªç±»å°±åšäº†ä¸€ä¸ªæ‰«æmapperå¹¶ä¸”å°†mapperæ³¨å…¥åˆ°Springå®¹å™¨ä¸­æ¥çš„äº‹æƒ….</p>
<p> <strong>å…³æ³¨ç‚¹äºŒ</strong> : æˆ‘ä»¬ä»å¼•å…¥è¿›æ¥çš„ä¾èµ–æ¥çœ‹, mybatis-spring-boot-starter-2.1.2.jar è·Ÿè¿›åˆ° è¿™ä¸ªåŒ…æ¥ï¼Œå¯ä»¥çœ‹åˆ°è¿™ä¸ªåŒ…ä¹Ÿæ˜¯å¼•å…¥ä¸€äº›è¿›æ¥. mybatis/mybatis-spring/spring-boot-starter-jdbc è¿™ä¸‰ä¸ªä¾èµ–æˆ‘ä»¬åº”è¯¥ä¸æ˜¯å¾ˆé™Œç”Ÿçš„ï¼Œmybatis-spring-boot-autoconfigureä¸»è¦æ¥çœ‹è¿™ä¸ªã€‚ spring.factories çš„ä½œç”¨å¤§å®¶å¯ä»¥å»äº†è§£ä¸‹ï¼ŒSpringBootå¾ˆå¤š EnableAutoConfiguration çš„é…ç½®éƒ½æ˜¯æ”¾å…¥åœ¨è¿™ä¸ªé‡Œé¢çš„ï¼Œåœ¨å¯åŠ¨çš„æ—¶å€™ï¼Œä¼šå»ä¸€å±‚ä¸€å±‚çš„å»è¯»å– spring.factories æ–‡ä»¶çš„å†…å®¹ã€‚ è¿™é‡Œæˆ‘ä»¬ä¸»è¦æ¥çœ‹ : org.mybatis.spring.boot.autoconfigure.MybatisAutoConfiguration è¿™ä¸ªç±»çš†å¯.</p>
<p> MyBatis åœ¨ properties ä¸­çš„é…ç½®æ–‡ä»¶è¯»å– : org.mybatis.spring.boot.autoconfigure.MybatisProperties</p>
<p>å¯ä»¥çœ‹åˆ°è¯¥ç±»ä¸Šæ˜¯æœ‰: @ConfigurationProperties(prefix = MybatisProperties.MYBATIS_PREFIX)</p>
<p>äºæ˜¯æˆ‘ä»¬ä¸€ä¸‹å­å°±å¤šäº†äºŒä¸ªå…³æ³¨ç‚¹, è¿™é‡Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨ä¹‹å‰çš„ ç¬¨æ–¹æ³•ï¼Œ å½“ä½ å¯¹æ•´åˆæµç¨‹æ‰§è¡Œä¸æ˜¯å¾ˆç†Ÿæ‚‰çš„è¯ï¼Œå¯ä»¥åœ¨è¿™äºŒä¸ªå…³æ³¨ç‚¹çš„é‡å†™æ–¹æ³•ä¸Šéƒ½æ‰“ç®—æ–­ç‚¹ï¼Œçœ‹ä¸‹å…¶æ‰§è¡Œé¡ºåºæ˜¯æ€ä¹ˆæ‰§è¡Œçš„. å¼„æ¸…æ¥šäº†æ‰§è¡Œæµç¨‹,å°±å¯ä»¥è·Ÿç€æµç¨‹æ¥ä¸€æ­¥ä¸€æ­¥çš„åˆ†æ. ä»æˆ‘ä»¬æ‰“ä¸Š debug å¼€å§‹ï¼Œå¾€ä¸‹çš„æ‰§è¡Œæµç¨‹å°±æ˜¯ä¸€æ­¥ä¸€æ­¥æ¥çš„ï¼Œé‚£ä¹ˆå°±è·Ÿç€æˆ‘ä»¬debug çš„æ–¹æ³•æ¥ä¸€æ­¥ä¸€æ­¥çš„åˆ†æ.</p>
<p>org.mybatis.spring.annotation.MapperScannerRegistrar#registerBeanDefinitions() â€”&gt; org.mybatis.spring.boot.autoconfigure.MybatisAutoConfiguration#MybatisAutoConfiguration â€”&gt; org.mybatis.spring.boot.autoconfigure.MybatisAutoConfiguration#afterPropertiesSet â€”-&gt; org.mybatis.spring.boot.autoconfigure.MybatisAutoConfiguration#sqlSessionFactory â€”&gt; org.mybatis.spring.boot.autoconfigure.MybatisAutoConfiguration#sqlSessionTemplate() â€”-&gt;</p>
<p><strong>org.mybatis.spring.annotation.MapperScannerRegistrar#registerBeanDefinitions() æ–¹æ³•</strong> :</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * &#123;@inheritDoc&#125;</span><br><span class="line"> */</span><br><span class="line">@Override</span><br><span class="line">public void registerBeanDefinitions(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry) &#123;</span><br><span class="line">/***</span><br><span class="line">*  è¿™é‡Œæ˜¯è·å–å‡ºäº†æ³¨è§£é‡Œé¢å±æ€§çš„å€¼. </span><br><span class="line">*/   </span><br><span class="line">  AnnotationAttributes mapperScanAttrs = </span><br><span class="line">  AnnotationAttributes.fromMap(importingClassMetadata.getAnnotationAttributes(MapperScan.class.getName()));</span><br><span class="line"></span><br><span class="line">// èƒ½è·å–åˆ°æœ‰æ³¨è§£,ä¸æ˜¯null,å°±ä¼šèµ°åˆ°ä¸‹é¢çš„ä»£ç ä¸­æ¥.    </span><br><span class="line">  if (mapperScanAttrs != null) &#123;</span><br><span class="line">    registerBeanDefinitions(importingClassMetadata, mapperScanAttrs, registry,</span><br><span class="line">        generateBaseBeanName(importingClassMetadata, 0));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line">* </span><br><span class="line">*/</span><br><span class="line">  void registerBeanDefinitions(AnnotationMetadata annoMeta, AnnotationAttributes annoAttrs,</span><br><span class="line">      BeanDefinitionRegistry registry, String beanName) &#123;</span><br><span class="line"></span><br><span class="line">// åˆ©ç”¨ BeanDefinitionBuilder æ„é€ è€…,ä¼ å…¥äº†ä¸€ä¸ª MapperScannerConfigurer.class</span><br><span class="line">// è¿™é‡Œçš„ builderé‡Œé¢æ˜¯æœ‰ä¸€ä¸ª bd çš„,é‡Œé¢çš„beanClasså°±æ˜¯ MapperScannerConfigurer      </span><br><span class="line">    BeanDefinitionBuilder builder = BeanDefinitionBuilder.genericBeanDefinition(MapperScannerConfigurer.class);</span><br><span class="line">    builder.addPropertyValue(&quot;processPropertyPlaceHolders&quot;, true);</span><br><span class="line"></span><br><span class="line">// è¿™é‡Œè·å– @MapperScan æ³¨è§£çš„å±æ€§, å¦‚æœå±æ€§æ˜¯æœ‰å€¼çš„è¯,å°±ä¼šè®¾ç½®åˆ° builder ä¸­æ¥. </span><br><span class="line">    Class&lt;? extends Annotation&gt; annotationClass = annoAttrs.getClass(&quot;annotationClass&quot;);</span><br><span class="line">    if (!Annotation.class.equals(annotationClass)) &#123;</span><br><span class="line">      builder.addPropertyValue(&quot;annotationClass&quot;, annotationClass);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Class&lt;?&gt; markerInterface = annoAttrs.getClass(&quot;markerInterface&quot;);</span><br><span class="line">    if (!Class.class.equals(markerInterface)) &#123;</span><br><span class="line">      builder.addPropertyValue(&quot;markerInterface&quot;, markerInterface);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Class&lt;? extends BeanNameGenerator&gt; generatorClass = annoAttrs.getClass(&quot;nameGenerator&quot;);</span><br><span class="line">    if (!BeanNameGenerator.class.equals(generatorClass)) &#123;</span><br><span class="line">      builder.addPropertyValue(&quot;nameGenerator&quot;, BeanUtils.instantiateClass(generatorClass));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Class&lt;? extends MapperFactoryBean&gt; mapperFactoryBeanClass = annoAttrs.getClass(&quot;factoryBean&quot;);</span><br><span class="line">    if (!MapperFactoryBean.class.equals(mapperFactoryBeanClass)) &#123;</span><br><span class="line">      builder.addPropertyValue(&quot;mapperFactoryBeanClass&quot;, mapperFactoryBeanClass);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String sqlSessionTemplateRef = annoAttrs.getString(&quot;sqlSessionTemplateRef&quot;);</span><br><span class="line">    if (StringUtils.hasText(sqlSessionTemplateRef)) &#123;</span><br><span class="line">      builder.addPropertyValue(&quot;sqlSessionTemplateBeanName&quot;, annoAttrs.getString(&quot;sqlSessionTemplateRef&quot;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String sqlSessionFactoryRef = annoAttrs.getString(&quot;sqlSessionFactoryRef&quot;);</span><br><span class="line">    if (StringUtils.hasText(sqlSessionFactoryRef)) &#123;</span><br><span class="line">      builder.addPropertyValue(&quot;sqlSessionFactoryBeanName&quot;, annoAttrs.getString(&quot;sqlSessionFactoryRef&quot;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// ä¸‹é¢æ˜¯æ ¹æ® value/basePackages/basePackageClasses æ¥è·å–åŒ…çš„ä¿¡æ¯,</span><br><span class="line">// è¿™é‡Œä¹Ÿå°±è¯´, æˆ‘ä»¬å¯ä»¥è·Ÿç€è¿™ä¸‰ä¸ªå±æ€§æ¥é…ç½®åŒ…ä¿¡æ¯.      </span><br><span class="line">    List&lt;String&gt; basePackages = new ArrayList&lt;&gt;();</span><br><span class="line">    basePackages.addAll(</span><br><span class="line">        Arrays.stream(annoAttrs.getStringArray(&quot;value&quot;)).filter(StringUtils::hasText).collect(Collectors.toList()));</span><br><span class="line"></span><br><span class="line">    basePackages.addAll(Arrays.stream(annoAttrs.getStringArray(&quot;basePackages&quot;)).filter(StringUtils::hasText)</span><br><span class="line">        .collect(Collectors.toList()));</span><br><span class="line"></span><br><span class="line">    basePackages.addAll(Arrays.stream(annoAttrs.getClassArray(&quot;basePackageClasses&quot;)).map(ClassUtils::getPackageName)</span><br><span class="line">        .collect(Collectors.toList()));</span><br><span class="line"></span><br><span class="line">// å¦‚æœæ²¡æœ‰è·å–åˆ°åŒ…çš„ä¿¡æ¯,é‚£å°±æ ¹æ®æ³¨è§£æ‰€åœ¨çš„è·¯å¾„æ¥è·å–é»˜è®¤çš„è·¯å¾„.      </span><br><span class="line">    if (basePackages.isEmpty()) &#123;</span><br><span class="line">      basePackages.add(getDefaultBasePackage(annoMeta));</span><br><span class="line">    &#125;</span><br><span class="line">// å¦‚æœæœ‰lazyInitializationå±æ€§çš„å€¼,å°±è®¾ç½®åˆ° builder ä¸­æ¥. </span><br><span class="line">    String lazyInitialization = annoAttrs.getString(&quot;lazyInitialization&quot;);</span><br><span class="line">    if (StringUtils.hasText(lazyInitialization)) &#123;</span><br><span class="line">      builder.addPropertyValue(&quot;lazyInitialization&quot;, lazyInitialization);</span><br><span class="line">    &#125;</span><br><span class="line">// æ·»åŠ åŒ…çš„å±æ€§</span><br><span class="line">    builder.addPropertyValue(&quot;basePackage&quot;, StringUtils.collectionToCommaDelimitedString(basePackages));</span><br><span class="line"></span><br><span class="line">//  getBeanDefinition() åœ¨è¿”å› bd ä¹‹å‰ï¼Œä¼šèµ°ä¸€ä¸ª validate æ–¹æ³•.</span><br><span class="line">// org.springframework.beans.factory.support.DefaultListableBeanFactory#registerBeanDefinition</span><br><span class="line">// èµ°è¿™ä¸ªæ–¹æ³•æ¥å°† bd ç»™æ³¨å…¥åˆ° Spring å®¹å™¨ä¸­æ¥.</span><br><span class="line">// è¿™é‡Œæ³¨å…¥è¿›å»çš„ beanName çš„å€¼æ˜¯ :  com.iyang.mybatis.springboot.hello.MybatisSpringBootHelloApplication#MapperScannerRegistrar#0</span><br><span class="line">// æ³¨å…¥è¿›å»çš„ bd çš„ beanClass : class org.mybatis.spring.mapper.MapperScannerConfigurer </span><br><span class="line">    registry.registerBeanDefinition(beanName, builder.getBeanDefinition());</span><br><span class="line"></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></div></figure>

<p><strong>è¿™é‡Œå¯ä»¥æ€»ç»“ä¸‹ registerBeanDefinitions æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å°±æ˜¯å°† @MapperScan çš„æ³¨è§£å±æ€§çš„å€¼ç»™åˆ° : BeanDefinitionBuilder builder, è¯¥builder é‡Œé¢æœ‰bd,bdçš„beanClassæ˜¯MapperScannerConfigurerï¼Œæœ€åå°†MapperScannerConfigureræ³¨å…¥åˆ° Spring å®¹å™¨ä¸­æ¥.</strong></p>
<hr>
<p><strong>MyBatisAutoConfiguration() æœ‰å‚æ„é€ å‡½æ•°</strong></p>
<p>è¿™é‡Œæˆ‘ä»¬åœ¨ MybatisAutoConfiguration æ„é€ å‡½æ•°ä¸Šæ‰“ä¸Šæ–­ç‚¹, å¯ä»¥æ ¹æ® æ–­ç‚¹æ¥åˆ†æï¼Œèµ°å®ŒğŸ‘†é¢çš„æ–¹æ³•ï¼Œç„¶åæˆ‘ä»¬ç‚¹å‡»èµ°åˆ°ä¸‹ä¸€ä¸ªæ–­ç‚¹æ¥ï¼Œå°±ä¼šèµ°åˆ° è¿™ä¸ª æœ‰å‚æ„é€ å‡½æ•°.</p>
<p>å¦‚æœå¥½å¥‡çš„è¯ï¼Œå¯ä»¥è·Ÿè¸ªdebug çš„å †æ ˆä¿¡æ¯ï¼Œæ˜¯æ€ä¹ˆèµ°åˆ°è¿™æ­¥æ¥çš„. èµ°åˆ°è¿™ä¸ªæ–¹æ³•æ¥ : finishBeanFactoryInitialization(beanFactory) è¿™æ˜¯æœ€åˆçš„å…¥å£.</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public MybatisAutoConfiguration(MybatisProperties properties, ObjectProvider&lt;Interceptor[]&gt; interceptorsProvider,</span><br><span class="line">    ObjectProvider&lt;TypeHandler[]&gt; typeHandlersProvider, ObjectProvider&lt;LanguageDriver[]&gt; languageDriversProvider,</span><br><span class="line">    ResourceLoader resourceLoader, ObjectProvider&lt;DatabaseIdProvider&gt; databaseIdProvider,</span><br><span class="line">    ObjectProvider&lt;List&lt;ConfigurationCustomizer&gt;&gt; configurationCustomizersProvider) &#123;</span><br><span class="line">// è¿™é‡Œéƒ½æ˜¯èµ‹å€¼    </span><br><span class="line">  this.properties = properties;</span><br><span class="line">  this.interceptors = interceptorsProvider.getIfAvailable();</span><br><span class="line">  this.typeHandlers = typeHandlersProvider.getIfAvailable();</span><br><span class="line">  this.languageDrivers = languageDriversProvider.getIfAvailable();</span><br><span class="line">  this.resourceLoader = resourceLoader;</span><br><span class="line">  this.databaseIdProvider = databaseIdProvider.getIfAvailable();</span><br><span class="line">  this.configurationCustomizers = configurationCustomizersProvider.getIfAvailable();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p><strong>org.mybatis.spring.boot.autoconfigure.MybatisAutoConfiguration#afterPropertiesSet()æ–¹æ³•</strong></p>
<p>è¿™é‡Œå¯ä»¥çœ‹åˆ°æ˜¯å¯¹é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨è¿›è¡Œæ£€éªŒ.</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void afterPropertiesSet() &#123;</span><br><span class="line">  checkConfigFileExists();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// æ£€éªŒé…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨</span><br><span class="line">  private void checkConfigFileExists() &#123;</span><br><span class="line">    if (this.properties.isCheckConfigLocation() &amp;&amp; StringUtils.hasText(this.properties.getConfigLocation())) &#123;</span><br><span class="line">      Resource resource = this.resourceLoader.getResource(this.properties.getConfigLocation());</span><br><span class="line">      Assert.state(resource.exists(),</span><br><span class="line">          &quot;Cannot find config location: &quot; + resource + &quot; (please add config file or check your Mybatis configuration)&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></div></figure>

<p><strong>org.mybatis.spring.boot.autoconfigure.MybatisAutoConfiguration#sqlSessionFactory æ–¹æ³•</strong></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">// è¿™é‡Œè¯´ä¸‹ @ConditionalOnMissingBean çš„ä½œç”¨,å½“beanä¸å­˜åœ¨çš„æ—¶å€™ï¼Œåˆ™å®ä¾‹åŒ–è¿™ä¸ªbean.</span><br><span class="line">// è¿™é‡Œä¼šä¼ å…¥ dataSource è¿›æ¥.</span><br><span class="line">@Bean</span><br><span class="line">@ConditionalOnMissingBean</span><br><span class="line">public SqlSessionFactory sqlSessionFactory(DataSource dataSource) throws Exception &#123;</span><br><span class="line">// åˆ›å»º sqlSessionBean å¯¹è±¡.    </span><br><span class="line">  SqlSessionFactoryBean factory = new SqlSessionFactoryBean();</span><br><span class="line">// è®¾ç½® dataSource &amp; SpringBootVFS.class      </span><br><span class="line">  factory.setDataSource(dataSource);</span><br><span class="line">  factory.setVfs(SpringBootVFS.class);</span><br><span class="line">// è·å–åˆ° MyBatis çš„é…ç½®æ–‡ä»¶å±æ€§,å¦‚æœæœ‰çš„è¯,å°±ä¼šè®¾ç½®åˆ° configLocationå±æ€§æ¥.    </span><br><span class="line">  if (StringUtils.hasText(this.properties.getConfigLocation())) &#123;</span><br><span class="line">    factory.setConfigLocation(this.resourceLoader.getResource(this.properties.getConfigLocation()));</span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line">// è¿™é‡Œä» properties ä¸­è·å– configuration,æ²¡æœ‰å€¼å°±ä¼šæ˜¯null.    </span><br><span class="line">  applyConfiguration(factory);</span><br><span class="line">  if (this.properties.getConfigurationProperties() != null) &#123;</span><br><span class="line">    factory.setConfigurationProperties(this.properties.getConfigurationProperties());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">// å¦‚æœæœ‰æ’ä»¶,å°±ä¼šè®¾ç½®æ’ä»¶.    </span><br><span class="line">  if (!ObjectUtils.isEmpty(this.interceptors)) &#123;</span><br><span class="line">    factory.setPlugins(this.interceptors);</span><br><span class="line">  &#125;</span><br><span class="line">  if (this.databaseIdProvider != null) &#123;</span><br><span class="line">    factory.setDatabaseIdProvider(this.databaseIdProvider);</span><br><span class="line">  &#125;</span><br><span class="line">// åŒ…çš„ååˆ«è®¾ç½®    </span><br><span class="line">  if (StringUtils.hasLength(this.properties.getTypeAliasesPackage())) &#123;</span><br><span class="line">    factory.setTypeAliasesPackage(this.properties.getTypeAliasesPackage());</span><br><span class="line">  &#125;</span><br><span class="line">  if (this.properties.getTypeAliasesSuperType() != null) &#123;</span><br><span class="line">    factory.setTypeAliasesSuperType(this.properties.getTypeAliasesSuperType());</span><br><span class="line">  &#125;</span><br><span class="line">  if (StringUtils.hasLength(this.properties.getTypeHandlersPackage())) &#123;</span><br><span class="line">    factory.setTypeHandlersPackage(this.properties.getTypeHandlersPackage());</span><br><span class="line">  &#125;</span><br><span class="line">  if (!ObjectUtils.isEmpty(this.typeHandlers)) &#123;</span><br><span class="line">    factory.setTypeHandlers(this.typeHandlers);</span><br><span class="line">  &#125;</span><br><span class="line">  if (!ObjectUtils.isEmpty(this.properties.resolveMapperLocations())) &#123;</span><br><span class="line">    factory.setMapperLocations(this.properties.resolveMapperLocations());</span><br><span class="line">  &#125;</span><br><span class="line">// è¿™é‡Œéƒ½æ˜¯é…ç½®å±æ€§çš„è®¾ç½®.    </span><br><span class="line"></span><br><span class="line">// è·å– propert å­—æ®µå±æ€§çš„åå­—.    </span><br><span class="line">  Set&lt;String&gt; factoryPropertyNames = Stream</span><br><span class="line">      .of(new BeanWrapperImpl(SqlSessionFactoryBean.class).getPropertyDescriptors()).map(PropertyDescriptor::getName)</span><br><span class="line">      .collect(Collectors.toSet());</span><br><span class="line">  Class&lt;? extends LanguageDriver&gt; defaultLanguageDriver = this.properties.getDefaultScriptingLanguageDriver();</span><br><span class="line">  if (factoryPropertyNames.contains(&quot;scriptingLanguageDrivers&quot;) &amp;&amp; !ObjectUtils.isEmpty(this.languageDrivers)) &#123;</span><br><span class="line">    // Need to mybatis-spring 2.0.2+</span><br><span class="line">    factory.setScriptingLanguageDrivers(this.languageDrivers);</span><br><span class="line">    if (defaultLanguageDriver == null &amp;&amp; this.languageDrivers.length == 1) &#123;</span><br><span class="line">      defaultLanguageDriver = this.languageDrivers[0].getClass();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">// è®¾ç½®é»˜è®¤çš„è„šæœ¬è¯­è¨€è§£æå™¨. è¿™é‡Œæ²¡æœ‰,è®¾ç½®çš„æ˜¯é»˜è®¤çš„null.    </span><br><span class="line">  if (factoryPropertyNames.contains(&quot;defaultScriptingLanguageDriver&quot;)) &#123;</span><br><span class="line">    // Need to mybatis-spring 2.0.2+</span><br><span class="line">    factory.setDefaultScriptingLanguageDriver(defaultLanguageDriver);</span><br><span class="line">  &#125;</span><br><span class="line">// org.mybatis.spring.SqlSessionFactoryBean#getObject,è¿™é‡Œèµ°åˆ°äº† SqlSessionBean.</span><br><span class="line">// è¿™ä¸ªSqlSessionFactoryBeanæ˜¯åœ¨æœ‰ä¹‹å‰ mybatiså’ŒSpring æ•´åˆåˆ†ææœ‰æè¿‡åˆ°çš„,å¯ä»¥å‚è€ƒgetObjectæ–¹æ³•: https://github.com/baoyang23/mybtatis-analysis/tree/master/mybatis-spring-hello    </span><br><span class="line">// è¿™é‡Œä¼šèµ° org.mybatis.spring.SqlSessionFactoryBean#getObject çš„ afterPropertiesSet æ–¹æ³•æ¥åˆ›å»ºä¸€ä¸ª SqlSessionFactory , è¿™é‡Œè¿”å›çš„ SqlSessionFactory å°±æ³¨å…¥åˆ° Spring å®¹å™¨ä¸­æ¥.    </span><br><span class="line">  return factory.getObject();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p><strong>æ‰€ä»¥è¿™ä¸ªæ–¹æ³• ï¼š å…ˆæ˜¯newäº†ä¸€ä¸ªSqlSessionFactoryBeanå¯¹è±¡ï¼Œå¦‚æœä½ ä»”ç»†çœ‹çš„è¯ï¼Œä½ ä¼šå‘ç°è¿™ä¸ªå¯¹è±¡åœ¨ä¹‹å‰ mybatis-spring æ•´åˆçš„æ—¶å€™ï¼Œæˆ‘ä»¬é€šè¿‡ xml é…ç½®æ–‡ä»¶é…ç½®è¿›æ¥çš„ï¼Œå¹¶ä¸”åŒæ—¶é€šè¿‡æ ‡ç­¾ç»™èµ‹å€¼äº†datasourceç­‰ä¿¡æ¯ï¼Œ è€Œè¿™é‡Œæ˜¯é€šè¿‡ä»£ç ï¼Œifç­‰åˆ¤æ–­ï¼Œæ¥å¯¹ SqlSessionFactoryBean çš„å±æ€§è¿›è¡Œsetå€¼çš„. æœ€åä¹Ÿæ˜¯åˆ›å»ºå‡ºä¸€ä¸ª SqlSessionFactory ç»™æ³¨å…¥åˆ° Spring å®¹å™¨ä¸­æ¥.</strong></p>
<hr>
<p><strong>org.mybatis.spring.boot.autoconfigure.MybatisAutoConfiguration#sqlSessionTemplate æ–¹æ³•</strong></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">@Bean</span><br><span class="line">@ConditionalOnMissingBean</span><br><span class="line">public SqlSessionTemplate sqlSessionTemplate(SqlSessionFactory sqlSessionFactory) &#123;</span><br><span class="line">// è¿™é‡Œæ ¹æ® executorType æ˜¯å¦æœ‰å€¼æ¥åˆ¤æ–­è¦èµ°çš„æ„é€ å‡½æ•°æ–¹æ³•.    </span><br><span class="line">  ExecutorType executorType = this.properties.getExecutorType();</span><br><span class="line">  if (executorType != null) &#123;</span><br><span class="line">    return new SqlSessionTemplate(sqlSessionFactory, executorType);</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">// è¿™é‡Œé»˜è®¤çš„è·å–æ˜¯ SIMPLE è¿™ä¸ª ExecutorType.      </span><br><span class="line">    return new SqlSessionTemplate(sqlSessionFactory);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// org.mybatis.spring.SqlSessionTemplate#SqlSessionTemplate(org.apache.ibatis.session.SqlSessionFactory, org.apache.ibatis.session.ExecutorType, org.springframework.dao.support.PersistenceExceptionTranslator),æœ€åå¯ä»¥è·Ÿè¿›åˆ°è¿™ä¸ªæ–¹æ³•ä¸­æ¥.</span><br><span class="line"></span><br><span class="line">  public SqlSessionTemplate(SqlSessionFactory sqlSessionFactory, ExecutorType executorType,</span><br><span class="line">      PersistenceExceptionTranslator exceptionTranslator) &#123;</span><br><span class="line">// å¯¹sqlSessionFactory å’Œ executorType è¿›è¡Œæ ¡éªŒ</span><br><span class="line">    notNull(sqlSessionFactory, &quot;Property &#x27;sqlSessionFactory&#x27; is required&quot;);</span><br><span class="line">    notNull(executorType, &quot;Property &#x27;executorType&#x27; is required&quot;);</span><br><span class="line"></span><br><span class="line">    this.sqlSessionFactory = sqlSessionFactory;</span><br><span class="line">    this.executorType = executorType;</span><br><span class="line">    this.exceptionTranslator = exceptionTranslator;</span><br><span class="line">// è¿™é‡Œé€šè¿‡ JDK çš„ä»£ç æ¥ç”Ÿæˆäº†ä¸€ä¸ª sqlSessionProxy ä»£ç†çš„å¯¹è±¡.      </span><br><span class="line">    this.sqlSessionProxy = (SqlSession) newProxyInstance(SqlSessionFactory.class.getClassLoader(),</span><br><span class="line">        new Class[] &#123; SqlSession.class &#125;, new SqlSessionInterceptor());</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></div></figure>

<p>è¯¥æ–¹æ³•æ˜¯å°† SqlSessionTemplate ç»™æ³¨å…¥åˆ° Spring å®¹å™¨ä¸­å•¦.</p>

        <h4 id="ç–‘æƒ‘ç‚¹"   >
          <a href="#ç–‘æƒ‘ç‚¹" class="heading-link"><i class="fas fa-link"></i></a><a href="#ç–‘æƒ‘ç‚¹" class="headerlink" title="ç–‘æƒ‘ç‚¹"></a>ç–‘æƒ‘ç‚¹</h4>
      <p> å¤§å®¶æœ‰æ²¡æœ‰ç–‘æƒ‘æˆ‘ä»¬å®šä¹‰çš„ mapper æ¥å£ å¥½åƒä»è¿™ä¸ªæµç¨‹åˆ†æä¸‹æ¥ï¼Œå¹¶æ²¡æœ‰æåˆ° ï¼Œé‚£ä¹ˆæ˜¯åœ¨ä¸Šé¢æ—¶å€™è¢«æ³¨å…¥åˆ° Spring å®¹å™¨ä¸­æ¥çš„å‘¢ï¼Ÿ</p>
<p> registerBeanDefinitions() è¿™ä¸ªæ–¹æ³• , æ³¨å…¥äº†MapperScannerConfigurer åˆ° Spring å®¹å™¨ä¸­æ¥äº†ï¼Œå¯ä»¥å›é¡¾ä¸‹ä¹‹å‰ mybatis æ•´åˆ Spring çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ˜¯é€šè¿‡ xml é…ç½®äº†è¿™ä¸ªå¯¹è±¡æ³¨å…¥åˆ° spring å®¹å™¨ä¸­æ¥çš„ã€‚ é‚£ä¹ˆæ³¨å…¥è¿›æ¥çš„,å›è°ƒåˆ° org.mybatis.spring.mapper.MapperScannerConfigurer#postProcessBeanDefinitionRegistry è¿™ä¸ªæ–¹æ³•çš„æ—¶å€™ï¼Œå°±ä¼šå°†æ‰«æå¹¶ä¸”å°†æˆ‘ä»¬çš„mapperæ¥å£æ–‡ä»¶ï¼Œç»™æ³¨å…¥åˆ° Spring å®¹å™¨ä¸­æ¥çš„. ç„¶åæ‰«æçš„åŒ…ï¼Œæ˜¯æ ¹æ®@MapperScan è§£ææ³¨è§£çš„æ—¶å€™ï¼Œæ˜¯æœ‰å¯¹æ‰«æçš„åŒ…è¿›è¡Œè§£æçš„.</p>

        <h4 id="æ€»ç»“"   >
          <a href="#æ€»ç»“" class="heading-link"><i class="fas fa-link"></i></a><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4>
      <p> å…¶å® SpringBoot æ•´åˆ MyBatis , æˆ‘ä»¬ä»äºŒä¸ªåˆ‡å…¥ç‚¹æ¥åˆ†ææ˜¯æ€ä¹ˆæ•´åˆè¿›æ¥çš„.<br>â€‹ ä¸€æ˜¯ @MapperScan æ³¨è§£ä¸­çš„ @Import(MapperScannerRegistrar.class) å°† MapperScannerRegistrar ç»™å¯¼å…¥åˆ° Spring å®¹å™¨ä¸­æ¥, ç„¶åMapperSacnnerRegistrar æ¥è®² org.mybatis.spring.mapper.MapperScannerConfigurer ç»™æ³¨å…¥åˆ° Springä¸­æ¥ï¼Œæ›¿æ¢äº†æˆ‘ä»¬ä¹‹å‰ç”¨ Spring æ•´åˆ Mybatis çš„æ—¶å€™ï¼Œé€šè¿‡xmlé…ç½®æ–‡ä»¶æ•´åˆè¿›æ¥.</p>
<p> äºŒæ˜¯åˆ©ç”¨ SpringBoot æä¾›çš„ spring-boot-autoconfigure + spring.factories() æ¥ é…ç½®è‡ªåŠ¨æ³¨å…¥, è¿™é‡Œæ³¨å…¥äº† MybatisAutoConfiguration é…ç½®ç±». ç„¶åæ³¨å…¥è¿›æ¥çš„ MyBatis é…ç½®ç±»åšäº†ä»€ä¹ˆäº‹æƒ…å‘¢ï¼Ÿ å¯ä»¥çœ‹åˆ°è¿™ä¸ªç±»ä¸­æ˜¯æœ‰åš: æ³¨å…¥äº† SqlSessionFactory. SqlSessionFactory åˆæ˜¯æ€ä¹ˆæ³¨å…¥è¿›æ¥çš„å‘¢ï¼Ÿ å¯ä»¥çœ‹åˆ° org.mybatis.spring.boot.autoconfigure.MybatisAutoConfiguration#sqlSessionFactory æ–¹æ³•æ˜¯æœ‰å…ˆåˆ›å»ºä¸€ä¸ª org.mybatis.spring.SqlSessionFactoryBean çš„ï¼Œ çœ‹åˆ° SqlSessionFactoryBean è¿™ä¸ªå¯¹è±¡ï¼Œæˆ‘ä»¬å°±ä¸éš¾æƒ³èµ· Spring + Mybatis é‡Œé¢çš„ beans.xml æ˜¯å°†è¯¥å¯¹è±¡æ³¨å…¥åˆ° Spring å®¹å™¨ä¸­æ¥. è¿™é‡Œæ˜¯ç›´æ¥newçš„ï¼Œç„¶åå°†ä¸€äº›é…ç½®å±æ€§å¹¶æ»¡è¶³æ¡ä»¶,ç»™setåˆ° SqlSessionFactoryBean ä¸­æ¥ï¼Œæœ€åè°ƒç”¨ org.mybatis.spring.SqlSessionFactoryBean#getObject æ–¹æ³•æ¥è·å– SqlSessionFactory.</p>
<p>spring.factories æ–‡ä»¶å†…å®¹</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># Auto Configure</span><br><span class="line">org.springframework.boot.autoconfigure.EnableAutoConfiguration=\</span><br><span class="line">org.mybatis.spring.boot.autoconfigure.MybatisLanguageDriverAutoConfiguration,\</span><br><span class="line">org.mybatis.spring.boot.autoconfigure.MybatisAutoConfiguration</span><br></pre></td></tr></table></div></figure>

<p>æœ€åä»å†™çš„æ¡ˆä¾‹é‡Œé¢çœ‹, MyBatis æ•´åˆ SpringBoot å…¶å®éƒ½æ˜¯åœ¨ mybatis â€”&gt; MyBatis + Spring ç­‰ä¸€æ­¥ä¸€æ­¥æ¨å¯¼ä¸Šæ¥çš„ï¼Œæ‰€ä»¥è¿™é‡Œä¸éš¾ç†è§£ï¼Œå¥½çš„æŠ€æœ¯éƒ½æ˜¯åœ¨æœ‰éœ€è¦å’Œæ—¶é—´çš„æ²‰æ·€ä¸‹ä¸€æ­¥ä¸€æ­¥æˆé•¿èµ·æ¥çš„.</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/11/04/mybatis/mybatis%E4%B8%8Espring%E6%95%B4%E5%90%88%E9%98%85%E8%AF%BB/">mybatisä¸springæ•´åˆé˜…è¯»</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">å‘è¡¨äº</span><span class="post-meta-item__value">2021-11-04</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">æ›´æ–°äº</span><span class="post-meta-item__value">2021-11-04</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">å­—æ•°ç»Ÿè®¡</span><span class="post-meta-item__value">3.5k</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="far fa-clock"></i></span><span class="post-meta-item__info">é˜…è¯»æ—¶é•¿</span><span class="post-meta-item__value">28åˆ†</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h4 id="é¢˜è®°"   >
          <a href="#é¢˜è®°" class="heading-link"><i class="fas fa-link"></i></a><a href="#é¢˜è®°" class="headerlink" title="é¢˜è®°"></a>é¢˜è®°</h4>
      <p> MyBatis ä¸ Spring æ•´åˆæ“ä½œ. åœ¨æˆ‘ä»¬å…¥é—¨å­¦ä¹  SSM ç­‰ä¸œè¥¿çš„æ—¶å€™ï¼Œå°±å‘ç°äº†ä»»ä½•ä¸œè¥¿ï¼Œæœ€åéƒ½æ˜¯é€ƒä¸è¿‡ä¸Springæ•´åˆèµ·æ¥çš„é“è·¯. ç„¶åè¿™é‡Œçœ‹å®Œ MyBatis æ•´åˆå®Œ Spring ä¹‹åï¼Œé‚£ä¹ˆä¹‹åä¸€äº›å…¶ä»–çš„ç¬¬ä¸‰æ–¹ï¼Œæ¯”å¦‚axon/redis/apollo/shiro ç­‰è¿™äº›ä¸œè¥¿ï¼Œå¦‚æœè¦æ•´åˆ Spring çš„æ—¶å€™ï¼Œæ˜¯ä¸æ˜¯ä¹Ÿæ˜¯ç›¸ä¼¼çš„æ•´åˆæ–¹å¼å‘¢ï¼Ÿ</p>
<p> è¿™ä¸ªéœ€è¦æˆ‘ä»¬çœ‹å®Œ MyBatis ä¸ Spring ä¹‹åï¼Œæ¢ç©¶å…¶æ•´åˆçš„æ“ä½œ.</p>

        <h4 id="å…¥é—¨"   >
          <a href="#å…¥é—¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#å…¥é—¨" class="headerlink" title="å…¥é—¨"></a>å…¥é—¨</h4>
      <p> åˆ†å‡ ä¸ªæ­¥éª¤ï¼Œæ“ä½œä¸€æŠŠå³å¯,å¸¦ä½ å›åˆ°å“ªä¸ª SM æ—¶ä»£ï¼Œä¸è¿‡è¿™å›æ˜¯æ²¡æœ‰äº† tomcat çš„.</p>
<p> å…ˆæ”¾ä¸Šä¸€ä¸ªå®Œæˆçš„æ•´åˆåœ°å€ : <span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/baoyang23/mybtatis-analysis/tree/master/mybatis-spring-hello" >https://github.com/baoyang23/mybtatis-analysis/tree/master/mybatis-spring-hello</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> å¦‚æœä¸è¦çœ‹ä¸‹é¢æµç¨‹çš„,ä¸€æ­¥è·³è¿‡å³å¯.</p>
<ol>
<li>å…ˆåˆ›å»ºä¸€ä¸ª maven é¡¹ç›®ï¼Œå¼•å…¥ä¾èµ–. ä¾èµ–å‚è€ƒåœ°å€ : <span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/baoyang23/mybtatis-analysis/blob/master/mybatis-spring-hello/pom.xml" >https://github.com/baoyang23/mybtatis-analysis/blob/master/mybatis-spring-hello/pom.xml</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
<li>dbé…ç½® : <span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/baoyang23/mybtatis-analysis/blob/master/mybatis-spring-hello/src/main/resources/db.properties" >https://github.com/baoyang23/mybtatis-analysis/blob/master/mybatis-spring-hello/src/main/resources/db.properties</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
<li>MyBatisé…ç½®: <span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/baoyang23/mybtatis-analysis/tree/master/mybatis-spring-hello/src/main/resources/mybatis" >https://github.com/baoyang23/mybtatis-analysis/tree/master/mybatis-spring-hello/src/main/resources/mybatis</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
<li>Spring é…ç½®: <span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/baoyang23/mybtatis-analysis/blob/master/mybatis-spring-hello/src/main/resources/spring-beans.xml" >https://github.com/baoyang23/mybtatis-analysis/blob/master/mybatis-spring-hello/src/main/resources/spring-beans.xml</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
<li>æœ€å,æ¥ä»½æˆ‘ä»¬ç†Ÿæ‚‰çš„ <span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/baoyang23/mybtatis-analysis/tree/master/mybatis-spring-hello/src/main/resources/sql" >https://github.com/baoyang23/mybtatis-analysis/tree/master/mybatis-spring-hello/src/main/resources/sql</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> mapper.xml æ–‡ä»¶.</li>
<li>ä¸å¿˜è®°å†æ¥ä¸€ä»½ä»£ç  : <span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/baoyang23/mybtatis-analysis/tree/master/mybatis-spring-hello/src" >https://github.com/baoyang23/mybtatis-analysis/tree/master/mybatis-spring-hello/src</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> è¿™äº›ç›´æ¥è·‘æµ‹è¯•ç±»å³å¯.</li>
</ol>
<p>è·Ÿç€è¿™ä¸Šé¢çš„å‡ ä¸ªæ­¥éª¤ï¼Œå°±å¯ä»¥æ­å»ºå®Œä¸€ä¸ªé¡¹ç›®. ç„¶åå–Šä¸Šæˆ‘ä»¬çš„ æ°¸å“¥ï¼Œ æ‰“ä¸Šä¼ è¯´ä¸­çš„ debug , ç–¯ç‹‚çš„è°ƒè¯•çœ‹æ¯æ­¥å¹²äº†ä»€ä¹ˆäº‹.</p>
<p>è¿™ä¸ªçš„æ—¶å€™ï¼Œå¯ä»¥è·‘ä¸‹æµ‹è¯•ç±»ï¼Œæ˜¯okçš„.</p>

        <h4 id="åˆ†æ"   >
          <a href="#åˆ†æ" class="heading-link"><i class="fas fa-link"></i></a><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h4>
      <p> è¿™é‡Œæˆ‘ä»¬é¦–å…ˆæƒ³åˆ°çš„æ˜¯æˆ‘ä»¬å¼•å…¥çš„ä¾èµ–,æ˜¯ä¸æ˜¯æœ‰ä¸ª mybatis-spring çš„ä¾èµ–. ä»è¿™ä¸ªä¾èµ–ï¼Œå¯ä»¥å¾ˆæ˜æ˜¾çš„çœ‹å‡ºæ¥ï¼Œå°±æ˜¯é€šè¿‡è¿™ä¸ªä¾èµ–ï¼Œå°† MyBatis å’Œ Spring æ•´åˆèµ·æ¥çš„ã€‚</p>
<p> ç„¶åå†æƒ³æƒ³ï¼Œæˆ‘ä»¬é™¤äº†è¿™ä¸ªä¾èµ–çš„è¯ï¼Œè¿˜å†å“ªé‡Œæœ‰ä½¿ç”¨åˆ°ä¸€äº› Spring å’Œ MyBatis çš„ä¸œè¥¿å‘¢ï¼Ÿ ç„¶åçœ‹åˆ° spring-beans.xml è¿™ä¸ªxmlé…ç½®, å¯ä»¥çœ‹åˆ° org.mybatis.spring.SqlSessionFactoryBean ç»™æ³¨å…¥åˆ° bean é‡Œé¢æ¥äº†.org.mybatis.spring.mapper.MapperScannerConfigurerä¹Ÿæ˜¯ç»™æ³¨å…¥åˆ° bean é‡Œé¢æ¥äº†. å¹¶ä¸”äºŒè€…éƒ½æœ‰é€šè¿‡æ¥è¿›è¡Œå±æ€§è®¾ç½®å€¼æ“ä½œ.</p>
<p> é‚£ä¹ˆ,æˆ‘ä»¬å°±åŸºäºè¿™äºŒä¸ªç±»çš„æºç å¼€å§‹é˜…è¯».</p>
<p> <strong>SqlSessionFactoryBean (org.mybatis.spring.SqlSessionFactoryBean)</strong></p>
<p>è¿™é‡Œ SqlSessionFactoryBean æ˜¯å®ç°äº†å¾ˆå¤šæ¥å£,è¿™äº›æ¥å£éƒ½æ˜¯Springçš„.</p>
<p>FactoryBean å·¥å‚bean,ç‚¹è¿›å»å¯ä»¥çœ‹åˆ°,å…¶æœ‰æ–¹æ³•getObject()/getObjectTypeç­‰æ–¹æ³•è·å–beançš„,ç„¶ååŠ ä¸Šæ³›å‹,ä¹Ÿå°±æ˜¯è¿™é‡Œè·å–çš„ getObjectå°±æ˜¯æ³›å‹.</p>
<p>InitializingBean: afterPropertiesSet åˆå§‹åŒ– bean çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨è¯¥æ–¹æ³•.</p>
<p>ApplicationEvent: Springçš„äº‹ä»¶ä¼ æ’­æœºåˆ¶ï¼Œå°±æ˜¯ä½¿ç”¨çš„è¿™ç§æ–¹å¼.</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">/**  å¯ä»¥çœ‹åˆ°è¿™ä¸ªç±»å®ç°äº† Spring è¿™ä¸ªå¤šæ¥å£,é‚£ä¹ˆå°±æœ‰ä¸ªé—®é¢˜,å®ç°äº†è¿™ä¹ˆå¤šæ¥å£çš„æ–¹æ³•,åˆ°åº•æ˜¯å“ªä¸ªæ–¹æ³•å…ˆæ‰§è¡Œçš„å‘¢ï¼Ÿ å¦‚æœä½ å¯¹Springæºç å¾ˆç†Ÿæ‚‰çš„è¯,æ˜¯æœ‰å¯èƒ½æ¸…æ¥šçš„,ä½†æ˜¯è¿˜æ˜¯ä¼šæœ‰ç‚¹ç»•çš„. </span><br><span class="line">è¿™é‡Œæˆ‘ä»¬ç»™ getObject/afterPropertiesSet/onApplicationEventè¿™ä¸‰ä¸ªæ–¹æ³•æ‰“ä¸Šæ–­ç‚¹æ¥è¿›è¡Œdebug,</span><br><span class="line">debugæ¯èµ°çš„ä¸€æ­¥,å°±æ˜¯æ‰§è¡Œçš„å…ˆåé¡ºåºã€‚å¦‚æœä¸æ˜¯ç‰¹åˆ«ç†Ÿæ‚‰æºç çš„æ‰§è¡Œé¡ºåº,è¿™ç§ç¬¨æ–¹æ³•å…¶å®ä¹Ÿæ˜¯å¯ä»¥çš„.</span><br><span class="line">*</span><br><span class="line">* æ‰€ä»¥è¿™é‡Œdebugçš„æ‰§è¡Œé¡ºåºæ˜¯ : afterPropertiesSet --&gt; getObject  ---&gt; onApplicationEvent</span><br><span class="line">* äºæ˜¯æˆ‘ä»¬å°±è·Ÿç€è¿™ä¸ªé¡ºåºæ¥é˜…è¯».</span><br><span class="line">* æ³¨æ„åœ¨è°ƒç”¨è¿™äº›æ–¹æ³•ä¹‹å‰,&lt;property&gt;æ ‡ç­¾çš„å€¼éƒ½æ˜¯å·²ç»èµ‹å€¼è¿›æ¥äº†çš„,æ˜¯é€šè¿‡åå°„èµ°çš„set æ–¹æ³•è¿›æ¥çš„.</span><br><span class="line">*/</span><br><span class="line">public class SqlSessionFactoryBean</span><br><span class="line">    implements FactoryBean&lt;SqlSessionFactory&gt;, InitializingBean, ApplicationListener&lt;ApplicationEvent&gt; &#123;&#125;</span><br><span class="line"></span><br><span class="line">// å®ç°FactoryBean æ–¹æ³•,è¿™é‡Œæ˜¯å®ç°äº†è¯¥æ¥å£çš„ä¸‰ä¸ªæ–¹æ³•. å…¶å®è¿™é‡Œçš„ isSingleæ˜¯å¯ä»¥ä¸ç”¨å®ç°çš„</span><br><span class="line">// å› ä¸ºæ¥å£æ˜¯ç”¨ default æ¥ä¿®é¥°çš„.</span><br><span class="line">  /**</span><br><span class="line">   * è¯¥æ–¹æ³•æ˜¯åˆ¤æ–­å¹¶ä¸”å†æ¬¡ç¡®è®¤ SqlSessionFactoryæ˜¯ä¸æ˜¯æœ‰äº†. å¦‚æœæ²¡æœ‰çš„è¯,å°±ä¼šè°ƒç”¨afterPropertiesæ¥åˆå§‹åŒ–.</span><br><span class="line">   * &#123;@inheritDoc&#125;</span><br><span class="line">   */</span><br><span class="line">  @Override</span><br><span class="line">  public SqlSessionFactory getObject() throws Exception &#123;</span><br><span class="line">    if (this.sqlSessionFactory == null) &#123;</span><br><span class="line">      afterPropertiesSet();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return this.sqlSessionFactory;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public Class&lt;? extends SqlSessionFactory&gt; getObjectType() &#123;</span><br><span class="line">    return this.sqlSessionFactory == null ? SqlSessionFactory.class : this.sqlSessionFactory.getClass();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public boolean isSingleton() &#123;</span><br><span class="line">    return true;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// InitializingBean å®ç°çš„æ–¹æ³•</span><br><span class="line">  @Override</span><br><span class="line">  public void afterPropertiesSet() throws Exception &#123;</span><br><span class="line">// å…ˆå¯¹ dataSource/sqlSessionFactoryBuilderè¿›è¡Œénullçš„åˆ¤æ–­.</span><br><span class="line">    notNull(dataSource, &quot;Property &#x27;dataSource&#x27; is required&quot;);</span><br><span class="line">    notNull(sqlSessionFactoryBuilder, &quot;Property &#x27;sqlSessionFactoryBuilder&#x27; is required&quot;);</span><br><span class="line">    state((configuration == null &amp;&amp; configLocation == null) || !(configuration != null &amp;&amp; configLocation != null),</span><br><span class="line">        &quot;Property &#x27;configuration&#x27; and &#x27;configLocation&#x27; can not specified with together&quot;);</span><br><span class="line">// è¿™é‡Œæ„å»ºå‡º ä¸€ä¸ª sqlSessionFactoryå·¥å‚æ¥,æƒ³æƒ³æˆ‘ä»¬æœ€åˆå†çœ‹å•ä¸ªMyBatisé¡¹ç›®çš„æ—¶å€™,æ˜¯ä¸æ˜¯ä¹Ÿæœ‰ä¸€ä¸ªè·å–SqlSessionFactroyçš„æ–¹æ³•,ç„¶åä»sqlSessionFactoryä¼šè¯ä¸­è·å–å‡ºSqlSessionæ¥.</span><br><span class="line">    this.sqlSessionFactory = buildSqlSessionFactory();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">// ApplicationListenerå®ç°æ–¹æ³•</span><br><span class="line">  /**</span><br><span class="line">   * failFast æ—¶ture å¹¶ä¸”ä¼ è¿‡æ¥çš„ eventæ˜¯ ContextRefreshedEventçš„è¯,å°±ä¼šè¿›æ¥.</span><br><span class="line">   *  è¿™é‡Œç›®å‰éƒ½æ˜¯è°ƒç”¨getæ–¹æ³•,æ²¡æœ‰å¾ˆä»”ç»†çœ‹å‡ºå…¶ä½œç”¨.</span><br><span class="line">   * &#123;@inheritDoc&#125;</span><br><span class="line">   */</span><br><span class="line">  @Override</span><br><span class="line">  public void onApplicationEvent(ApplicationEvent event) &#123;</span><br><span class="line">    if (failFast &amp;&amp; event instanceof ContextRefreshedEvent) &#123;</span><br><span class="line">      // fail-fast -&gt; check all statements are completed</span><br><span class="line">      this.sqlSessionFactory.getConfiguration().getMappedStatementNames();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></div></figure>

<p><strong>org.mybatis.spring.SqlSessionFactoryBean#buildSqlSessionFactory</strong></p>
<p>è¯¥æ–¹æ³•éœ€è¦å•ç‹¬æ‹¿å‡ºæ¥è¯´ä¸‹,å› ä¸ºå†…å®¹è¿˜æ˜¯æ¯”è¾ƒå¤šçš„.</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Build a &#123;@code SqlSessionFactory&#125; instance.</span><br><span class="line"> *</span><br><span class="line"> * The default implementation uses the standard MyBatis &#123;@code XMLConfigBuilder&#125; API to build a</span><br><span class="line"> * &#123;@code SqlSessionFactory&#125; instance based on a Reader. Since 1.3.0, it can be specified a &#123;@link Configuration&#125;</span><br><span class="line"> * instance directly(without config file).</span><br><span class="line"> *</span><br><span class="line"> * @return SqlSessionFactory</span><br><span class="line"> * @throws Exception</span><br><span class="line"> *           if configuration is failed</span><br><span class="line"> */</span><br><span class="line">protected SqlSessionFactory buildSqlSessionFactory() throws Exception &#123;</span><br><span class="line"></span><br><span class="line">  final Configuration targetConfiguration;</span><br><span class="line"></span><br><span class="line">  XMLConfigBuilder xmlConfigBuilder = null;</span><br><span class="line">    </span><br><span class="line"> // è¿™é‡Œåˆ†ä¸ºconfiguration/ configLocation / éå‰äºŒè€…(å¯ä»¥ç†è§£ä¸ºé»˜è®¤çš„).</span><br><span class="line"> // ä¸‰ç§å¤„ç†æ–¹å¼.   </span><br><span class="line">  if (this.configuration != null) &#123;</span><br><span class="line">    targetConfiguration = this.configuration;</span><br><span class="line">    if (targetConfiguration.getVariables() == null) &#123;</span><br><span class="line">      targetConfiguration.setVariables(this.configurationProperties);</span><br><span class="line">    &#125; else if (this.configurationProperties != null) &#123;</span><br><span class="line">      targetConfiguration.getVariables().putAll(this.configurationProperties);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; else if (this.configLocation != null) &#123;</span><br><span class="line">// è¿™é‡Œå°±æ˜¯æˆ‘ä»¬é…ç½®çš„æƒ…å†µ </span><br><span class="line">// org.apache.ibatis.builder.xml.XMLConfigBuilder#XMLConfigBuilder(java.io.InputStream, java.lang.String, java.util.Properties),å¯ä»¥çœ‹åˆ°è¿™ä¸ªç†Ÿæ‚‰çš„æ“ä½œ,ä¹Ÿå°±æ˜¯æˆ‘ä»¬å•ä¸ªè§£æ MyBatisçš„æ—¶å€™æœ‰è¿›è¡Œåˆ†æè¿‡çš„.      </span><br><span class="line">    xmlConfigBuilder = new XMLConfigBuilder(this.configLocation.getInputStream(), null, this.configurationProperties);</span><br><span class="line">// è·å–å‡º configuration é…ç½®ä¿¡æ¯.      </span><br><span class="line">    targetConfiguration = xmlConfigBuilder.getConfiguration();</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    LOGGER.debug(</span><br><span class="line">        () -&gt; &quot;Property &#x27;configuration&#x27; or &#x27;configLocation&#x27; not specified, using default MyBatis Configuration&quot;);</span><br><span class="line">    targetConfiguration = new Configuration();</span><br><span class="line">    Optional.ofNullable(this.configurationProperties).ifPresent(targetConfiguration::setVariables);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// è¿™é‡Œé‡‡ç”¨ Optional,å¦‚æœobjectFactoryä¸æ˜¯nullçš„è¯,å°±ä¼šè°ƒç”¨targetConfigurationçš„ setObjectFactoryæ–¹æ³•.ä¸‹é¢è¿™äºŒä¸ªæ˜¯åŒç†.</span><br><span class="line">  Optional.ofNullable(this.objectFactory).ifPresent(targetConfiguration::setObjectFactory);</span><br><span class="line">  Optional.ofNullable(this.objectWrapperFactory).ifPresent(targetConfiguration::setObjectWrapperFactory);</span><br><span class="line">  Optional.ofNullable(this.vfs).ifPresent(targetConfiguration::setVfsImpl);</span><br><span class="line"></span><br><span class="line">// è¿™é‡Œå¦‚æœæœ‰é…ç½®typeAliasesPackageè¿™ä¸ªå‚æ•°çš„è¯,å°±ä¼šå¯¹è¯¥åŒ…ä¸‹è¿›è¡Œæ‰«æ,è¿›è¡Œä¸€ç³»åˆ—çš„è¿‡æ»¤,</span><br><span class="line">// å¦‚æœéƒ½æ»¡è¶³æ¡ä»¶çš„è¯,targetConfiguration.getTypeAliasRegistry()::registerAliaså°±ä¼šæ³¨å†Œåˆ°è¿™é‡Œ. </span><br><span class="line">  if (hasLength(this.typeAliasesPackage)) &#123;</span><br><span class="line">    scanClasses(this.typeAliasesPackage, this.typeAliasesSuperType).stream()</span><br><span class="line">        .filter(clazz -&gt; !clazz.isAnonymousClass()).filter(clazz -&gt; !clazz.isInterface())</span><br><span class="line">        .filter(clazz -&gt; !clazz.isMemberClass()).forEach(targetConfiguration.getTypeAliasRegistry()::registerAlias);</span><br><span class="line">  &#125;</span><br><span class="line">// æ˜¯å¦æœ‰typeAliasesè¿™ä¸ªå‚æ•°,å¦‚æœæœ‰çš„è¯,ä¹Ÿæ˜¯å¯ä»¥çœ‹åˆ°æ˜¯æ³¨å†Œåˆ°ä¸Šé¢å“ªä¸€æ­¥çš„é‡Œé¢æ¥.</span><br><span class="line">  if (!isEmpty(this.typeAliases)) &#123;</span><br><span class="line">    Stream.of(this.typeAliases).forEach(typeAlias -&gt; &#123;</span><br><span class="line">      targetConfiguration.getTypeAliasRegistry().registerAlias(typeAlias);</span><br><span class="line">      LOGGER.debug(() -&gt; &quot;Registered type alias: &#x27;&quot; + typeAlias + &quot;&#x27;&quot;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">//åˆ¤æ–­æ˜¯å¦æœ‰æ’ä»¶,å¦‚æœæœ‰æ’ä»¶çš„è¯,ä¹Ÿä¼šæ·»åŠ åˆ°configurationä¸­æ¥.    </span><br><span class="line">  if (!isEmpty(this.plugins)) &#123;</span><br><span class="line">    Stream.of(this.plugins).forEach(plugin -&gt; &#123;</span><br><span class="line">      targetConfiguration.addInterceptor(plugin);</span><br><span class="line">      LOGGER.debug(() -&gt; &quot;Registered plugin: &#x27;&quot; + plugin + &quot;&#x27;&quot;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (hasLength(this.typeHandlersPackage)) &#123;</span><br><span class="line">    scanClasses(this.typeHandlersPackage, TypeHandler.class).stream().filter(clazz -&gt; !clazz.isAnonymousClass())</span><br><span class="line">        .filter(clazz -&gt; !clazz.isInterface()).filter(clazz -&gt; !Modifier.isAbstract(clazz.getModifiers()))</span><br><span class="line">        .forEach(targetConfiguration.getTypeHandlerRegistry()::register);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (!isEmpty(this.typeHandlers)) &#123;</span><br><span class="line">    Stream.of(this.typeHandlers).forEach(typeHandler -&gt; &#123;</span><br><span class="line">      targetConfiguration.getTypeHandlerRegistry().register(typeHandler);</span><br><span class="line">      LOGGER.debug(() -&gt; &quot;Registered type handler: &#x27;&quot; + typeHandler + &quot;&#x27;&quot;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  targetConfiguration.setDefaultEnumTypeHandler(defaultEnumTypeHandler);</span><br><span class="line"></span><br><span class="line">  if (!isEmpty(this.scriptingLanguageDrivers)) &#123;</span><br><span class="line">    Stream.of(this.scriptingLanguageDrivers).forEach(languageDriver -&gt; &#123;</span><br><span class="line">      targetConfiguration.getLanguageRegistry().register(languageDriver);</span><br><span class="line">      LOGGER.debug(() -&gt; &quot;Registered scripting language driver: &#x27;&quot; + languageDriver + &quot;&#x27;&quot;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  Optional.ofNullable(this.defaultScriptingLanguageDriver)</span><br><span class="line">      .ifPresent(targetConfiguration::setDefaultScriptingLanguage);</span><br><span class="line"></span><br><span class="line">  if (this.databaseIdProvider != null) &#123;// fix #64 set databaseId before parse mapper xmls</span><br><span class="line">    try &#123;</span><br><span class="line">      targetConfiguration.setDatabaseId(this.databaseIdProvider.getDatabaseId(this.dataSource));</span><br><span class="line">    &#125; catch (SQLException e) &#123;</span><br><span class="line">      throw new NestedIOException(&quot;Failed getting a databaseId&quot;, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Optional.ofNullable(this.cache).ifPresent(targetConfiguration::addCache);</span><br><span class="line">// è¿™è¿™ä¹‹å‰,éƒ½æ˜¯å¯¹ä¸€äº›é…ç½®ä¿¡æ¯çš„è¯»å–,å¦‚æœæœ‰çš„è¯,å°±ä¼šè¿›è¡Œç›¸åº”çš„èµ‹å€¼ä¹‹ç±»çš„æ“ä½œ.</span><br><span class="line">    </span><br><span class="line">  if (xmlConfigBuilder != null) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">// æœ€åè¿™é‡Œçš„ parse è§£ææ–¹æ³•,æ˜¯å’Œå•ä¸ª Mybatisçš„è§£è¯»æ˜¯ä¸€æ ·çš„.        </span><br><span class="line">      xmlConfigBuilder.parse();</span><br><span class="line">      LOGGER.debug(() -&gt; &quot;Parsed configuration file: &#x27;&quot; + this.configLocation + &quot;&#x27;&quot;);</span><br><span class="line">    &#125; catch (Exception ex) &#123;</span><br><span class="line">      throw new NestedIOException(&quot;Failed to parse config resource: &quot; + this.configLocation, ex);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">      ErrorContext.instance().reset();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">//è¿™é‡Œå¯ä»¥çœ‹äº‹åŠ¡å·¥å‚,æ˜¯ä½¿ç”¨äº†mybatis-springåŒ…ä¸‹çš„.</span><br><span class="line">  targetConfiguration.setEnvironment(new Environment(this.environment,</span><br><span class="line">      this.transactionFactory == null ? new SpringManagedTransactionFactory() : this.transactionFactory,</span><br><span class="line">      this.dataSource));</span><br><span class="line"></span><br><span class="line">// è¿™é‡Œæ˜¯å¤„ç† mapper.xml æ–‡ä»¶çš„é…ç½®,å¦‚æœåœ¨è¿™é‡Œæ˜¯æœ‰é…ç½®çš„è¯,é‚£ä¹ˆä¹Ÿæ˜¯ä¼šè¢«è§£æåˆ°çš„.    </span><br><span class="line">  if (this.mapperLocations != null) &#123;</span><br><span class="line">    if (this.mapperLocations.length == 0) &#123;</span><br><span class="line">      LOGGER.warn(() -&gt; &quot;Property &#x27;mapperLocations&#x27; was specified but matching resources are not found.&quot;);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      for (Resource mapperLocation : this.mapperLocations) &#123;</span><br><span class="line">        if (mapperLocation == null) &#123;</span><br><span class="line">          continue;</span><br><span class="line">        &#125;</span><br><span class="line">        try &#123;</span><br><span class="line">          XMLMapperBuilder xmlMapperBuilder = new XMLMapperBuilder(mapperLocation.getInputStream(),</span><br><span class="line">              targetConfiguration, mapperLocation.toString(), targetConfiguration.getSqlFragments());</span><br><span class="line">          xmlMapperBuilder.parse();</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">          throw new NestedIOException(&quot;Failed to parse mapping resource: &#x27;&quot; + mapperLocation + &quot;&#x27;&quot;, e);</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">          ErrorContext.instance().reset();</span><br><span class="line">        &#125;</span><br><span class="line">        LOGGER.debug(() -&gt; &quot;Parsed mapper file: &#x27;&quot; + mapperLocation + &quot;&#x27;&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    LOGGER.debug(() -&gt; &quot;Property &#x27;mapperLocations&#x27; was not specified.&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">//org.apache.ibatis.session.defaults.DefaultSqlSessionFactory,æœ€ååˆ°è¿™é‡Œä¹Ÿæ˜¯newäº†ä¸€ä¸ªmybatisåŒ…ä¸‹çš„é»˜è®¤SqlSessionFactoryç±».</span><br><span class="line">  return this.sqlSessionFactoryBuilder.build(targetConfiguration);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>å¯ä»¥çœ‹åˆ°è¯¥æ–¹æ³•ç»™äººæ„Ÿè§‰, å…ˆæ˜¯åˆ¤æ–­ä¸€äº›é…ç½®ä¿¡æ¯æ˜¯ä¸æ˜¯æœ‰å€¼ï¼Œå¦‚æœæ˜¯æœ‰å€¼çš„è¯ï¼Œå°±ä¼šè¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚æœ€åè°ƒç”¨æˆ‘ä»¬åœ¨çœ‹å•ä¸ª mybatis çš„ parse è§£ææ–¹æ³•,æœ€ånewäº†ä¸€ä¸ªé»˜è®¤çš„sqlSessionFactoryå·¥å‚ç±»å‡ºæ¥.</p>
<p><strong>MapperScannerConfigurer(org.mybatis.spring.mapper.MapperScannerConfigurer)</strong></p>
<p>æ¥ç€çœ‹,spring-beans.xml é‡Œé¢çš„ç¬¬äºŒä¸ªé…ç½®.</p>
<p>å¯ä»¥çœ‹åˆ°è¯¥ç±»ï¼Œä¹Ÿæ˜¯å®ç°äº† spring çš„å¾ˆå¤šæ¥å£.</p>
<p>BeanDefinitionRegistryPostProcessor : æ³¨å†ŒBeanDefinitionåˆ°Springå®¹å™¨ä¸­æ¥.</p>
<p>ApplicationContextAware : è·å– ApplicationContext</p>
<p>BeanNameAware : è®¾ç½® beanNameåå­—.</p>
<p>è¿™é‡Œä¹Ÿå¯ä»¥æŒ‰ç…§ä¸Šé¢çš„ç¬¨æ–¹æ³•ï¼Œä¸€æ¬¡å¯¹é‡å†™çš„æ–¹æ³•æ‰“ä¸Šæ–­ç‚¹. ç„¶åå¼€å¯æˆ‘ä»¬çš„debugæ¥çœ‹çœ‹æ–¹æ³•çš„æ‰§è¡Œé¡ºåº.</p>
<p>å…¶æ‰§è¡Œé¡ºåº : setBeanName â€”&gt; setApplicationContext â€”&gt; afterPropertiesSet â€”&gt; postProcessBeanDefinitionRegistry , è·Ÿç€è¿™å››ä¸ªæ–¹æ³•æ‰§è¡Œçš„é¡ºåºæ¥çœ‹.</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">public class MapperScannerConfigurer</span><br><span class="line">    implements BeanDefinitionRegistryPostProcessor, InitializingBean, ApplicationContextAware, BeanNameAware &#123; &#125;</span><br></pre></td></tr></table></div></figure>

<p>èµ‹å€¼ç»™ beanName å€¼. org.mybatis.spring.mapper.MapperScannerConfigurer#0</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void setBeanName(String name) &#123;</span><br><span class="line">  this.beanName = name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// ç„¶åè¿™é‡Œæ˜¯ç»™åˆ° ApplicationContext. è¿™ä¹Ÿå°±è¯´è¿™ä¸ªç±»ç°åœ¨æœ‰äº† ApplicationContext,å¯ä»¥æ ¹æ®contextæä¾›çš„apiæ¥è¿›è¡Œç›¸åº”çš„æ“ä½œ.</span><br><span class="line">  @Override</span><br><span class="line">  public void setApplicationContext(ApplicationContext applicationContext) &#123;</span><br><span class="line">    this.applicationContext = applicationContext;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">// æ£€éªŒé…ç½®åŒ…çš„å€¼ä¸èƒ½ä¸ºnull.</span><br><span class="line">  @Override</span><br><span class="line">  public void afterPropertiesSet() throws Exception &#123;</span><br><span class="line">    notNull(this.basePackage, &quot;Property &#x27;basePackage&#x27; is required&quot;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * &#123;@inheritDoc&#125;</span><br><span class="line">   * å¯ä»¥æ„Ÿå—åˆ°è¿™ä¸ªæ–¹æ³•, åœ¨æ‹¿åˆ°äº†BeanDefinitionRegistryçš„æƒ…å†µä¸‹,å¾€é‡Œé¢æ³¨å†Œbd.</span><br><span class="line">   * @since 1.0.2</span><br><span class="line">   */</span><br><span class="line">  @Override</span><br><span class="line">  public void postProcessBeanDefinitionRegistry(BeanDefinitionRegistry registry) &#123;</span><br><span class="line">    if (this.processPropertyPlaceHolders) &#123;</span><br><span class="line">      processPropertyPlaceHolders();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">// è¿™æ®µæ˜¯åˆ›å»ºäº†ä¸€ä¸ª ClassPathMapperScanner å¯¹è±¡,ç„¶åå¾€é‡Œé¢setå±æ€§.      </span><br><span class="line">    ClassPathMapperScanner scanner = new ClassPathMapperScanner(registry);</span><br><span class="line">    scanner.setAddToConfig(this.addToConfig);</span><br><span class="line">    scanner.setAnnotationClass(this.annotationClass);</span><br><span class="line">    scanner.setMarkerInterface(this.markerInterface);</span><br><span class="line">    scanner.setSqlSessionFactory(this.sqlSessionFactory);</span><br><span class="line">    scanner.setSqlSessionTemplate(this.sqlSessionTemplate);</span><br><span class="line">    scanner.setSqlSessionFactoryBeanName(this.sqlSessionFactoryBeanName);</span><br><span class="line">    scanner.setSqlSessionTemplateBeanName(this.sqlSessionTemplateBeanName);</span><br><span class="line">    scanner.setResourceLoader(this.applicationContext);</span><br><span class="line">    scanner.setBeanNameGenerator(this.nameGenerator);</span><br><span class="line">    scanner.setMapperFactoryBeanClass(this.mapperFactoryBeanClass);</span><br><span class="line">      </span><br><span class="line">    if (StringUtils.hasText(lazyInitialization)) &#123;</span><br><span class="line">      scanner.setLazyInitialization(Boolean.valueOf(lazyInitialization));</span><br><span class="line">    &#125;</span><br><span class="line">    if (StringUtils.hasText(defaultScope)) &#123;</span><br><span class="line">      scanner.setDefaultScope(defaultScope);</span><br><span class="line">    &#125;</span><br><span class="line">      </span><br><span class="line">// å¯¹registeré‡Œçš„ä¿¡æ¯è¿›è¡Œè¿‡æ»¤      </span><br><span class="line">    scanner.registerFilters();</span><br><span class="line">// org.springframework.context.annotation.ClassPathBeanDefinitionScanner#scan</span><br><span class="line">// è¿™é‡Œä¸»è¦çœ‹æ‰«æçš„æ–¹æ³•. æ ¹æ®,æ¥åˆ‡å‰²æˆ‘ä»¬å†™çš„ basePackage ä¿¡æ¯.æ‰«æç±»çš„ä¿¡æ¯,æœ€åè¿˜æ˜¯å€Ÿç”¨äº† org.springframework.context.annotation.ClassPathBeanDefinitionScanner#doScan æ¥è¿›è¡Œæ‰«æçš„. //  doScan(basePackages) æ˜¯å¯¹ xml è¿›è¡Œæ‰«æçš„.</span><br><span class="line">// AnnotationConfigUtils.registerAnnotationConfigProcessors(this.registry); æ˜¯å¯¹æ³¨è§£è¿›è¡Œæ‰«æçš„.</span><br><span class="line">// æœ€åè¿”å›æ³¨å†Œåˆ° Spring å®¹å™¨ä¸­çš„ bean ä¸ªæ•°</span><br><span class="line">// æ‰€ä»¥å¦‚æœæˆ‘ä»¬é…ç½®äº†ä¸‹é¢çš„æ ‡ç­¾,é‚£ä¹ˆåœ¨è¿™é‡Œéƒ½ä¼šè¢«æ‰«æåˆ°å¹¶ä¸”æ³¨å†Œåˆ°Springå®¹å™¨ä¸­.</span><br><span class="line">//     &lt;bean class=&quot;org.mybatis.spring.mapper.MapperScannerConfigurer&quot;&gt;</span><br><span class="line">//        &lt;property name=&quot;basePackage&quot; value=&quot;com.iyang.sm.mapper&quot; &gt;&lt;/property&gt;</span><br><span class="line">//    &lt;/bean&gt;</span><br><span class="line">// è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯:  org.mybatis.spring.mapper.ClassPathMapperScanner#processBeanDefinitions</span><br><span class="line">//   definition.setBeanClass(this.mapperFactoryBeanClass);  è¿™é‡Œçš„è¿™è¡Œä»£ç ,æ˜¯ç»™bdçš„beanClassç»™æ¢æˆäº† MapperFactoryBean.class , </span><br><span class="line">//  definition.getConstructorArgumentValues().addGenericArgumentValue(beanClassName);     // è¿™å¥ä»£ç ,å°† beanClassName ç»™åˆ° dbä¹‹å, ç„¶åå°±æ‰ç”¨ beanClassNameæ¥newä¸€ä¸ª MapperFactoryBean å¯¹è±¡æ¥, æ‰€ä»¥è¿™é‡Œå¹¶ä¸æ˜¯ä½¿ç”¨æ— å‚æ„é€ å‡½æ•°.</span><br><span class="line">// ä¹Ÿè®¸ä¼šé—®,æ€ä¹ˆè¯å®æ²¡æœ‰èµ°æ— å‚æ•°æ„é€ å‡½æ•°å‘¢ ? è€Œæ˜¯å»èµ°çš„ set æ–¹æ³•å‘¢ ? </span><br><span class="line">// å†ä¸èƒ½åŠ¨æºç çš„æƒ…å†µä¸‹, é¢å¯¹è¿™ç§æƒ…å†µæƒ…å†µæœ€å¥½çš„åŠæ³•å°±æ˜¯, åœ¨æ— å‚æ„é€ å‡½æ•°ä¸Šæ‰“ä¸Šæ–­ç‚¹.</span><br><span class="line">// å¦‚æœæ²¡èµ°åˆ°æ–­ç‚¹ä¸Š,é‚£å°±è¯´æ˜ä¸æ˜¯èµ°çš„æ— å‚æ„é€ å‡½æ•°æ¥åˆå§‹åŒ–çš„.      </span><br><span class="line">    scanner.scan(</span><br><span class="line">        StringUtils.tokenizeToStringArray(this.basePackage, ConfigurableApplicationContext.CONFIG_LOCATION_DELIMITERS));</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></div></figure>

<p>æ‰€ä»¥åˆ°è¿™é‡Œ, å¯ä»¥çœ‹åˆ° MyBatis ä¸ Spring æ•´åˆçš„è¿‡ç¨‹å°±å·²ç»å®Œæˆäº†.</p>
<p>æˆ‘ä»¬è¿™é‡Œæ˜¯ä¸»è¦å¯¹ SqlSessionFactoryBean å’Œ MapperScannerConfigurer æ¥è¿›è¡Œåˆ†æçš„, å¯ä»¥å¾ˆæ˜æ˜¾çš„æ„Ÿè§‰åˆ°,æˆ‘ä»¬æ˜¯é…ç½®å¥½è¿™äºŒä¸ªbeanå,å°±å¯ä»¥ä½¿ç”¨äº†. ç€é‡çœ‹ç¬¬äºŒä¸ª, org.mybatis.spring.mapper.MapperScannerConfigurer è¿™ä¸ªbean,å°±æ˜¯åšäº†å¦‚ä½•å°† MyBatis çš„ mapperæ¥å£æ–‡ä»¶ç»™åŠ è½½åˆ° Spring ä¸­æ¥çš„. <strong>é‚£ä¹ˆè¿™é‡Œæˆ‘åœ¨æƒ³, å¦‚æœæœ‰å¤©æˆ‘è‡ªå·±å¼€å‘å‡ºä¸€ä¸ªå¥½ç”¨çš„æ¡†æ¶æ¥,è¦ä¸ Spring è¿›è¡Œæ•´åˆçš„è¯,æ˜¯ä¸æ˜¯ä¹Ÿè¿™æ ·æ•´åˆå°±å¯ä»¥äº†ï¼Ÿ</strong></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- é…ç½®sqlSessionFactoryï¼ŒSqlSessionFactoryBeanæ˜¯ç”¨æ¥äº§ç”ŸsqlSessionFactoryçš„ --&gt;</span><br><span class="line">&lt;bean id=&quot;sqlSessionFactory&quot; class=&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;&gt;</span><br><span class="line">    &lt;!-- åŠ è½½mybatisçš„å…¨å±€é…ç½®æ–‡ä»¶ï¼Œæ”¾åœ¨classpathä¸‹çš„mybatisæ–‡ä»¶å¤¹ä¸­äº† --&gt;</span><br><span class="line">    &lt;property name=&quot;configLocation&quot; value=&quot;mybatis/SqlMapConfig.xml&quot; /&gt;</span><br><span class="line">    &lt;!-- åŠ è½½æ•°æ®æºï¼Œä½¿ç”¨ä¸Šé¢é…ç½®å¥½çš„æ•°æ®æº --&gt;</span><br><span class="line">    &lt;property name=&quot;dataSource&quot; ref=&quot;dataSource&quot; /&gt;</span><br><span class="line">&lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">&lt;!--  é…ç½®æ‰«æ MyBatis æ¥å£çš„åŒ… --&gt;</span><br><span class="line">&lt;bean class=&quot;org.mybatis.spring.mapper.MapperScannerConfigurer&quot;&gt;</span><br><span class="line">    &lt;property name=&quot;basePackage&quot; value=&quot;com.iyang.sm.mapper&quot; &gt;&lt;/property&gt;</span><br><span class="line">&lt;/bean&gt;</span><br></pre></td></tr></table></div></figure>


        <h4 id="æ€»ç»“"   >
          <a href="#æ€»ç»“" class="heading-link"><i class="fas fa-link"></i></a><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4>
      <p> å¯ä»¥çœ‹åˆ° MyBatis ä¸ Spring æ•´åˆå, å¯¹äºè§£æ MyBatis çš„ mapper é…ç½®æ–‡ä»¶ç­‰ï¼Œéƒ½æ˜¯èµ°çš„ä¹‹å‰å•ä¸ª mybatis çš„é€»è¾‘, æ˜¯æ²¡æœ‰ä»€ä¹ˆå˜åŒ–çš„. ä¸»è¦çš„æ˜¯å°† , SqlSessionFactory å’Œ Mapper.class(æ¥å£ç±») ç»™æ³¨å…¥åˆ° Spring å®¹å™¨ä¸­.ç„¶åæ¥å£çš„è¯, æ˜¯æ€ä¹ˆä½¿ç”¨çš„ä»£ç†ç±»æ¥è¿›è¡Œå®ä¾‹åŒ–å®Œå, å°†å¯¹è±¡ç»™æ³¨å…¥åˆ° Spring å®¹å™¨ä¸­çš„å‘¢ ï¼Ÿ è¿™é‡Œçœ‹ org.mybatis.spring.mapper.MapperScannerConfigurer åšçš„äº‹æƒ…å°±æ˜ç™½äº†.</p>
<p> ä¸è¿‡åœ¨çœ‹ mybatis ä¸ Spring æ•´åˆçš„æ—¶å€™, è¿˜æ˜¯å»ºè®®è¦æœ‰å¯¹ BeanDefinitionRegistryPostProcessor / InitializingBean / ApplicationContextAware / BeanNameAware æœ‰ä¸€å®šçš„äº†æ¥. å°±æ˜¯æœ‰äº†äº†è§£å, ä½ å°±ä¼šå¾ˆæ˜æ˜¾çš„æ„Ÿå—åˆ°ï¼Œ mybatis ä¸ºä»€ä¹ˆæ˜¯å®ç°è¿™ä¸ªæ¥å£ï¼Œå®ç°è¿™ä¸ªæ¥å£å¹¶ä¸”é‡å†™è¿™ä¸ªæ–¹æ³•ï¼Œåœ¨åé¢æ˜¯ä»€ä¹ˆæ—¶å€™è¢«è°ƒç”¨çš„. æ„æ€ä¹Ÿå°±æ˜¯ï¼Œä½ è‡³å°‘å¾—æ˜ç™½ç‚¹ Spring å¯¹å¤–æä¾›çš„ä¸€äº›æ‰©å±•ç‚¹ï¼Œæ‰èƒ½å¾ˆå¥½çš„ç†è§£è¿™äº›ä¸œè¥¿.</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/11/04/mybatis/mybatis%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B%E9%98%85%E8%AF%BB/">mybatiså·¥ä½œæµç¨‹é˜…è¯»</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">å‘è¡¨äº</span><span class="post-meta-item__value">2021-11-04</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">æ›´æ–°äº</span><span class="post-meta-item__value">2021-11-04</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">å­—æ•°ç»Ÿè®¡</span><span class="post-meta-item__value">4.3k</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="far fa-clock"></i></span><span class="post-meta-item__info">é˜…è¯»æ—¶é•¿</span><span class="post-meta-item__value">33åˆ†</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h4 id="MyBatis-çš„å·¥ç¨‹æµç¨‹åˆ†æ"   >
          <a href="#MyBatis-çš„å·¥ç¨‹æµç¨‹åˆ†æ" class="heading-link"><i class="fas fa-link"></i></a><a href="#MyBatis-çš„å·¥ç¨‹æµç¨‹åˆ†æ" class="headerlink" title="MyBatis çš„å·¥ç¨‹æµç¨‹åˆ†æ"></a>MyBatis çš„å·¥ç¨‹æµç¨‹åˆ†æ</h4>
      <p> MyBatis æ˜¯æˆ‘ä»¬åœ¨å­¦ä¹ Javaæ¡†æ¶ï¼Œä¹Ÿå°±æ˜¯å­¦ä¹ å®ŒJavaWebçš„çŸ¥è¯†å,è¦å­¦ä¹ åˆ°çš„ä¸€ä¸ªORMçš„æ¡†æ¶. æˆ‘ä¹Ÿæ˜¯å­¦ä¹ &amp;ä½¿ç”¨è¿‡åï¼Œå†æ¬¡å¯¹æºç è¿›è¡Œé˜…è¯»çš„. æ‰€ä»¥è¿™ç¯‡æ–‡ç« è®°å½• MyBatis çš„ä¸€ä¸ª work flow.</p>
<p> å…ˆæ”¾ä¸Šé¡¹ç›®åœ°å€ : <span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/baoyang23/mybtatis-analysis/tree/master/mybatis-work-flow" >https://github.com/baoyang23/mybtatis-analysis/tree/master/mybatis-work-flow</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p> æœ‰å…´è¶£çš„åŒå­¦,å¯ä»¥cloneä¸‹æ¥çœ‹çœ‹.</p>

        <h4 id="æ¡ˆä¾‹ä»£ç "   >
          <a href="#æ¡ˆä¾‹ä»£ç " class="heading-link"><i class="fas fa-link"></i></a><a href="#æ¡ˆä¾‹ä»£ç " class="headerlink" title="æ¡ˆä¾‹ä»£ç "></a>æ¡ˆä¾‹ä»£ç </h4>
      <p>å…ˆæ”¾ä¸Šæ¡ˆåˆ—çš„ä»£ç , ç„¶åæˆ‘ä»¬å¯ä»¥æŒ¨ä¸ªçš„åˆ†æ.</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">public class InitHelloMyBatis &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws IOException &#123;</span><br><span class="line">        // è¯»å–é…ç½®æ–‡ä»¶.</span><br><span class="line">        InputStream mybatisInputStream = Resources.getResourceAsStream(&quot;mybatis-config.xml&quot;);</span><br><span class="line">        // ä¼ å…¥è¯»å–é…ç½®æ–‡ä»¶çš„æµ,ä½¿ç”¨SqlSessionFactoryBuilderæ¥</span><br><span class="line">        // æ„å»º SqlSessionFactory.</span><br><span class="line">        SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(mybatisInputStream);</span><br><span class="line">        // ä» SqlSessionFactory ä¸­è·å–SqlSessionä¼šè¯.</span><br><span class="line">        SqlSession session = sqlSessionFactory.openSession();</span><br><span class="line"></span><br><span class="line">        // ä»ä¼šè¯ä¸­è·å– Mapper.</span><br><span class="line">        BlogMapper blogMapper = session.getMapper(BlogMapper.class);</span><br><span class="line">        </span><br><span class="line">        // è°ƒç”¨æŸ¥è¯¢æ–¹æ³•.</span><br><span class="line">        TbBlog tbBlog = blogMapper.selectBlog(1);</span><br><span class="line">        System.out.println(tbBlog);</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>è¿™é‡Œè¯´ä¸‹å¤§è‡´æµç¨‹ :</p>
<ul>
<li>ä½¿ç”¨ Resources æ¥è¯»å– mybatis-config.xmlé…ç½®æ–‡ä»¶, å¦‚æœè¯¥æ–‡ä»¶ä¸å­˜åœ¨æˆ–è€…è¯»å–å‡ºæ¥ InputStream æ˜¯ null çš„è¯,ç¨‹åºå°±ä¼šæŠ›å‡º IOException çš„é”™è¯¯æ¥.</li>
<li>è¯»å–é…ç½®æ²¡æœ‰é—®é¢˜,æ¥åˆ° new SqlSessionFactoryBuilder().build(io) æ¥æ„å»ºå‡ºä¸€ä¸ª SqlSessionFactory æ¥, è¿™é‡Œæ„å»ºå‡ºæ¥çš„ SqlSessionFactory è‚¯å®šæ˜¯æœ‰å·²ç»è®²é…ç½®æ–‡ä»¶ç»™å…¨éƒ¨åŠ è½½è¿›å»äº†çš„.</li>
<li>SqlSessionFactory.openSession() ä» SqlSessionFactory ä¸­è·å–ä¸€æ¬¡ä¼šè¯, ç„¶åå¯ä»¥ä»ä¼šè¯ä¸­è·å–å‡ºæ¥å£(BlogMapper)æ¥,è¿™é‡Œæ˜¯ä¸æ˜¯æœ‰ç‚¹å¥½å¥‡,æ˜æ˜è¿™å°±æ˜¯ä¸€ä¸ªæ¥å£,ä¹Ÿæ²¡æœ‰å®ç°ç±»,æ€ä¹ˆå°±å¯ä»¥getå‡ºä¸€ä¸ªæ¥å£å¯¹è±¡æ¥?è·å–å‡ºæ¥å£æ¥,ç„¶åå°±å¯ä»¥è°ƒç”¨æ¥å£ä¸­çš„æ–¹æ³•, æ ¹æ®idæŸ¥è¯¢å‡ºæ•°æ®æ¥.</li>
</ul>
<p>å¯ä»¥çœ‹åˆ°,æ ¹æ®ä»å®˜ç½‘å†™çš„ä¸€ä¸ªåˆ—å­,ä»è¡¨é¢æ¥çœ‹,ä»£ç é‡å¹¶ä¸æ˜¯å¾ˆå¤š. æ‰€ä»¥æ¥ä¸‹æ¥ç‚¹å»æºç ,å»è·Ÿè¿›æºç ä¸­çš„æ¯ä¸ªæ–¹æ³•,åˆ°åº•åšäº†äº›ä»€ä¹ˆäº‹æƒ….</p>
<p><strong>è¯»å–é…ç½®æ–‡ä»¶</strong></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">InputStream mybatisInputStream = Resources.getResourceAsStream(&quot;mybatis-config.xml&quot;);</span><br></pre></td></tr></table></div></figure>

<p>org.apache.ibatis.io.Resources (Class).</p>
<p>å¯ä»¥çœ‹åˆ°MyBatisæºç è¿˜å†™äº†ä¸€ä¸ª ClassLoaderçš„åŒ…è£…ç±»ï¼Œé€šè¿‡ClassLoaderWrapperåŒ…è£…ç±»æ¥è®²é…ç½®æ–‡ä»¶è½¬åŒ–ä¸ºInputSream.</p>
<p>å¦‚æœè¿”å›çš„InputStreamæ˜¯nullï¼Œå°±ä¼šæŠ›å‡ºIOExceptionæ¥.</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Returns a resource on the classpath as a Stream object</span><br><span class="line"> *</span><br><span class="line"> * @param loader   The classloader used to fetch the resource</span><br><span class="line"> * @param resource The resource to find</span><br><span class="line"> * @return The resource</span><br><span class="line"> * @throws java.io.IOException If the resource cannot be found or read</span><br><span class="line"> */</span><br><span class="line">private static ClassLoaderWrapper classLoaderWrapper = new ClassLoaderWrapper();</span><br><span class="line"></span><br><span class="line">public static InputStream getResourceAsStream(ClassLoader loader, String resource) throws IOException &#123;</span><br><span class="line">  // åˆ©ç”¨ ClasssLoaderWrapper.  </span><br><span class="line">  InputStream in = classLoaderWrapper.getResourceAsStream(resource, loader);</span><br><span class="line">  if (in == null) &#123;</span><br><span class="line">    throw new IOException(&quot;Could not find resource &quot; + resource);</span><br><span class="line">  &#125;</span><br><span class="line">  return in;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>äºæ˜¯æˆ‘ä»¬æ¥ç€çœ‹ ClassLoaderWrapper æ˜¯æ€ä¹ˆ è¯»å–é…ç½®æ–‡ä»¶ &amp; è½¬åŒ–ä¸º InputStream æµçš„.</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">// è¿™é‡Œè¿”å›çš„æ˜¯ ClassLoaderçš„æ•°ç»„,å¦‚æœå¯¹ClassLoaderä¸æ˜¯å¾ˆäº†è§£çš„è¯,å¯ä»¥å…ˆå»ç™¾åº¦äº†è§£ä¸‹.</span><br><span class="line">ClassLoader[] getClassLoaders(ClassLoader classLoader) &#123;</span><br><span class="line">  return new ClassLoader[]&#123;</span><br><span class="line">      // ä¼ é€’è¿›æ¥çš„ </span><br><span class="line">      classLoader,</span><br><span class="line">      // é»˜è®¤çš„ ClassLoader</span><br><span class="line">      defaultClassLoader,</span><br><span class="line">      // æ ¹æ®å½“å‰çº¿ç¨‹è·å–å‡ºæ¥çš„</span><br><span class="line">      Thread.currentThread().getContextClassLoader(),</span><br><span class="line">      // æ ¹æ®å½“å‰ Class è·å–å‡ºæ¥çš„.</span><br><span class="line">      getClass().getClassLoader(),</span><br><span class="line">      // ç³»ç»Ÿçš„ClassLoader.</span><br><span class="line">      systemClassLoader&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// è·å–åˆ°äº† classLoaderçš„æ•°ç»„,ç„¶åå¯¹å…¶è¿›è¡Œè¿­ä»£.</span><br><span class="line">// ä¹Ÿå°±æ˜¯ä½¿ç”¨ ClassLoaderçš„  getResourceAsStream æ–¹æ³•,æ¥è®² mybatis-config.xml</span><br><span class="line">// é…ç½®æ–‡ä»¶è½¬åŒ–ä¸º InputStream.</span><br><span class="line">// æœ€åå¦‚æœè·å–åˆ°InputStreaméƒ½æ˜¯nullçš„è¯,é‚£ä¹ˆè¿”å›çš„ä¹Ÿå°±æ˜¯nulläº†.</span><br><span class="line">// æ ¹æ®ä¸Šé¢çš„è¯´æ³•,è¿”å›çš„å¦‚æœæ˜¯nullçš„è¯,å°±ä¼šå‡º IOExceptionæ¥.</span><br><span class="line">InputStream getResourceAsStream(String resource, ClassLoader[] classLoader) &#123;</span><br><span class="line">    for (ClassLoader cl : classLoader) &#123;</span><br><span class="line">      if (null != cl) &#123;</span><br><span class="line"></span><br><span class="line">        // try to find the resource as passed</span><br><span class="line">        InputStream returnValue = cl.getResourceAsStream(resource);</span><br><span class="line"></span><br><span class="line">        // now, some class loaders want this leading &quot;/&quot;, so we&#x27;ll add it and try again if we didn&#x27;t find the resource</span><br><span class="line">        if (null == returnValue) &#123;</span><br><span class="line">          returnValue = cl.getResourceAsStream(&quot;/&quot; + resource);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (null != returnValue) &#123;</span><br><span class="line">          return returnValue;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return null;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></div></figure>

<p><strong>è‡³æ­¤,MyBatisè¯»å– mybatis-config.xml é…ç½®æ–‡ä»¶ä¹Ÿå°±æ˜¯è§£æå®Œæ¯•,å¯ä»¥çœ‹åˆ°é‡‡ç”¨äº†è‡ªå·±å†™çš„ ClassLoaderWrapperæ¥æ“ä½œçš„, ä¼ é€’ä¸€ç§ ClassLoaderè¿›æ¥,å…¶é»˜è®¤çš„&amp;ç³»ç»Ÿ&amp;çº¿ç¨‹çš„,åŠ ä¸€èµ·ä¹Ÿæ˜¯æœ‰å››ç§. æœ€åæŒ¨ä¸ªè¿›æ¥è¿­ä»£ï¼Œæ»¡è¶³æ¡ä»¶çš„ä¼šè¯»å–æ–‡ä»¶è½¬åŒ–ä¸ºInputStream,å¦‚æœéƒ½æ˜¯nullçš„è¯,ä¹Ÿä¼šè¿”å›null.</strong></p>
<hr>
<p><strong>è·å–SqlSessionFactory &amp; è§£æé…ç½®æ–‡ä»¶</strong></p>
<p>new SqlSessionFactoryBuilder() ä¹Ÿæ˜¯newäº†ä¸€ä¸ª SqlSessionFactoryBuild,ä¸ªäººç†è§£ SqlSessionFactoryBuilder å°±æ˜¯ä¸“ç¨‹ç”¨æ¥æ„å»ºå‡º SqlSessionFactory æ¥çš„,æ¯•ç«Ÿå…¶åé¢æœ‰ä¸€ä¸ª build æ–¹æ³•.</p>
<p>Problem ? è¿™é‡Œæœ‰ä¸ªé—®é¢˜,ä¸ºä»€ä¹ˆä¸å°† SqlSessionFactoryBuilder çš„build æ–¹æ³•,ä¿®æ”¹ä¸ºé™æ€çš„ ? å¦‚æœä¿®æ”¹ä¸ºé™æ€çš„è¯ï¼Œé‚£å°±ä¸ç”¨newäº†,å°±å¯ä»¥ç›´æ¥ SqlSessionFactoryBuilder.build(mybatisInputStream);</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SqlSessionFactory sqlSessionFactory = new                     SqlSessionFactoryBuilder().build(mybatisInputStream);</span><br></pre></td></tr></table></div></figure>

<p><strong>SqlSessionFactory</strong></p>
<p>æ¥ç€æˆ‘ä»¬æ¥åˆ° SqlSessionFactory çš„ build æ–¹æ³•.</p>
<p>è¿™é‡Œåœ¨ finnaly ä¸­, å¯ä»¥çœ‹åˆ° ErrorContext åˆ©ç”¨äº† ThreadLocal , åˆšå¥½è¿™å‘¨å‡ºäº† ThreadLocal çš„è§†é¢‘.</p>
<p>è§†é¢‘åœ°å€ : <span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1Ga4y1W72w" >https://www.bilibili.com/video/BV1Ga4y1W72w</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>æœ‰å…´è¶£&amp;ä¹äºå­¦ä¹ &amp;åˆ†äº«çš„,å¯ä»¥å…±åŒè¿›æ­¥.</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public SqlSessionFactory build(InputStream inputStream, String environment, Properties properties) &#123;</span><br><span class="line">  try &#123;</span><br><span class="line">    // åˆ©ç”¨ä¼ å…¥è¿›æ¥çš„å‚æ•°,newå‡ºæ¥äº†ä¸€ä¸ª XMLConfigBuilder.</span><br><span class="line">    XMLConfigBuilder parser = new XMLConfigBuilder(inputStream, environment, properties);</span><br><span class="line">    return build(parser.parse());</span><br><span class="line">  &#125; catch (Exception e) &#123;</span><br><span class="line">    throw ExceptionFactory.wrapException(&quot;Error building SqlSession.&quot;, e);</span><br><span class="line">  &#125; finally &#123;</span><br><span class="line">    // è¿™é‡Œå¯¹ ThreadLocal ä¸­è¿›è¡Œ remove() æ“ä½œ   </span><br><span class="line">    ErrorContext.instance().reset();</span><br><span class="line">    try &#123;</span><br><span class="line">      // å…³é—­æµ.  </span><br><span class="line">      inputStream.close();</span><br><span class="line">    &#125; catch (IOException e) &#123;</span><br><span class="line">      // Intentionally ignore. Prefer previous error.</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>new XmlConfigBuilder() æ–¹æ³•:</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line">public XMLConfigBuilder(InputStream inputStream, String environment, Properties props) &#123;</span><br><span class="line">  // å…ˆnewä¸€ä¸ªXMLMapperEntityResolver,å†newä¸€ä¸ªXPathParser,ç„¶åå°±èµ°åˆ°ä¸‹é¢çš„æ„é€ å‡½æ•°.</span><br><span class="line">  this(new XPathParser(inputStream, true, props, new XMLMapperEntityResolver()), environment, props);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// æœ€åè¿˜æ˜¯èµ°åˆ°è¿™ä¸ªæ„é€ æ–¹æ³•ä¸­æ¥.</span><br><span class="line">private XMLConfigBuilder(XPathParser parser, String environment, Properties props) &#123;</span><br><span class="line">  super(new Configuration());</span><br><span class="line">  ErrorContext.instance().resource(&quot;SQL Mapper Configuration&quot;);</span><br><span class="line">  this.configuration.setVariables(props);</span><br><span class="line">  this.parsed = false;</span><br><span class="line">  this.environment = environment;</span><br><span class="line">  this.parser = parser;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">----------------------------------------</span><br><span class="line">// new XPathParserä»£ç :</span><br><span class="line">    </span><br><span class="line">  public XPathParser(InputStream inputStream, boolean validation, Properties variables, EntityResolver entityResolver) &#123;</span><br><span class="line">    // æ™®é€šçš„æ„é€ æ–¹æ³•.</span><br><span class="line">    // å¯¹ XPathParserçš„validation/entityResolver/variables/xpath</span><br><span class="line">    // çš„å±æ€§è¿›è¡Œèµ‹å€¼æ“ä½œ.</span><br><span class="line">    commonConstructor(validation, variables, entityResolver);</span><br><span class="line">    this.document = createDocument(new InputSource(inputStream));</span><br><span class="line">  &#125;    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// createDocument æ–¹æ³•</span><br><span class="line">  private Document createDocument(InputSource inputSource) &#123;</span><br><span class="line">    // important: this must only be called AFTER common constructor</span><br><span class="line">    try &#123;</span><br><span class="line">      // è¿™é‡Œé€šè¿‡debugçœ‹,è¿”å›çš„å¯¹è±¡æ˜¯DocumentBuilderFactoryImpl</span><br><span class="line">      // ä¹Ÿå°±æ˜¯å…¶å®ç°ç±».  </span><br><span class="line">      DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();</span><br><span class="line">     // å¯¹ factory çš„ features(HashMap) æ·»åŠ å€¼,   </span><br><span class="line">      factory.setFeature(XMLConstants.FEATURE_SECURE_PROCESSING, true);</span><br><span class="line">     // å¯¹ factory çš„ validating è¿›è¡Œèµ‹å€¼  </span><br><span class="line">      factory.setValidating(validation);</span><br><span class="line">	 // è¿™ä¸‹é¢éƒ½æ˜¯å¯¹ factoryçš„å±æ€§è¿›è¡Œèµ‹å€¼æ“ä½œ.	</span><br><span class="line">      factory.setNamespaceAware(false);</span><br><span class="line">      factory.setIgnoringComments(true);</span><br><span class="line">      factory.setIgnoringElementContentWhitespace(false);</span><br><span class="line">      factory.setCoalescing(false);</span><br><span class="line">      factory.setExpandEntityReferences(true);</span><br><span class="line">		</span><br><span class="line">      // å¯ä»¥çœ‹åˆ° return new DocumentBuilderImpl</span><br><span class="line">      // æœ€åè¿”å›çš„ä¹Ÿæ˜¯å…¶å®ç°ç±». </span><br><span class="line">      DocumentBuilder builder = factory.newDocumentBuilder();</span><br><span class="line">      builder.setEntityResolver(entityResolver);</span><br><span class="line">      // è®¾ç½®é”™è¯¯çš„handler,å¯ä»¥çœ‹åˆ°ErrorHandleræ˜¯æ¥å£,è¿™é‡Œæ˜¯åŒ¿åå®ç°çš„</span><br><span class="line">      // ä¹Ÿå°±æ˜¯ç›´æ¥newäº†æ¥å£,ç„¶åé‡å†™å…¶æ–¹æ³•.  </span><br><span class="line">      builder.setErrorHandler(new ErrorHandler() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void error(SAXParseException exception) throws SAXException &#123;</span><br><span class="line">          throw exception;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void fatalError(SAXParseException exception) throws SAXException &#123;</span><br><span class="line">          throw exception;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void warning(SAXParseException exception) throws SAXException &#123;</span><br><span class="line">          // NOP</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">      //   DocumentBuilderImpl çš„ parse è§£ææ–¹æ³•</span><br><span class="line">      return builder.parse(inputSource);</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">      throw new BuilderException(&quot;Error creating document instance.  Cause: &quot; + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">-------------</span><br><span class="line">//   builder.parse(inputSource)</span><br><span class="line"></span><br><span class="line">    public Document parse(InputSource is) throws SAXException, IOException &#123;</span><br><span class="line">        if (is == null) &#123;</span><br><span class="line">            throw new IllegalArgumentException(</span><br><span class="line">                DOMMessageFormatter.formatMessage(DOMMessageFormatter.DOM_DOMAIN,</span><br><span class="line">                &quot;jaxp-null-input-source&quot;, null));</span><br><span class="line">        &#125;</span><br><span class="line">    // fSchemaValidator æ˜¯ null ,è·³è¿‡.</span><br><span class="line">        if (fSchemaValidator != null) &#123;</span><br><span class="line">            if (fSchemaValidationManager != null) &#123;</span><br><span class="line">                fSchemaValidationManager.reset();</span><br><span class="line">                fUnparsedEntityHandler.reset();</span><br><span class="line">            &#125;</span><br><span class="line">            resetSchemaValidator();</span><br><span class="line">        &#125;</span><br><span class="line">  // ä½¿ç”¨ xml çš„ç›¸å…³ç±»å¯¹ is è¿›è¡Œè§£æ  </span><br><span class="line">        domParser.parse(is);</span><br><span class="line"> //  ?   </span><br><span class="line">        Document doc = domParser.getDocument();</span><br><span class="line"> // ? è¿™äº›è§£æ Document çš„åœ°æ–¹.....   </span><br><span class="line">        domParser.dropDocumentReferences();</span><br><span class="line">        return doc;</span><br><span class="line">    &#125;    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">---------------</span><br><span class="line">// æœ€åçœ‹åˆ° this æ„é€ å‡½æ•°.</span><br><span class="line"></span><br><span class="line">  private XMLConfigBuilder(XPathParser parser, String environment, Properties props) &#123;</span><br><span class="line">    /** new Configuration() ä¸­,TypeAliasRegistry typeAliasRegistryä¸­çš„ typeAliases,</span><br><span class="line">    *   åœ¨åˆå§‹åŒ–è¿™ä¸ªå¯¹è±¡çš„æ—¶å€™,å°±é»˜è®¤è®¾ç½®äº†ä¸€äº›åˆ«åé…ç½®.</span><br><span class="line">    *   åˆå§‹åŒ–çš„æ—¶å€™,è¿˜æœ‰å¯¹ LanguageDriverRegistry çš„ LANGUAGE_DRIVER_MAP èµ‹å€¼.</span><br><span class="line">    *  çˆ¶ç±» :  BaseBuilderæŠ½è±¡ç±».</span><br><span class="line">    *  ç„¶åè°ƒç”¨superæ–¹æ³•,å°†configurationèµ‹å€¼çˆ¶ç±»çš„configuration</span><br><span class="line">    *  åŒæ—¶å°† configurationçš„typeAliasRegistryå’ŒtypeHandlerRegistryä¹Ÿèµ‹å€¼</span><br><span class="line">    *  ç»™å½“å‰çš„è¿™ä¸ªå¯¹è±¡.</span><br><span class="line">    *   </span><br><span class="line">    */</span><br><span class="line">    super(new Configuration());</span><br><span class="line">    // instance() æ–¹æ³•æ˜¯å¾€ ThreadLocalé‡Œé¢å»setäº†ä¸€ä¸ªErrorContext</span><br><span class="line">    // æœ€åä¼šåœ¨finnalyä¸­è¿›è¡Œremoveæ‰.</span><br><span class="line">    ErrorContext.instance().resource(&quot;SQL Mapper Configuration&quot;);</span><br><span class="line">    // å°† props èµ‹å€¼åˆ° configuration çš„ variable å‚æ•°.</span><br><span class="line">    this.configuration.setVariables(props);</span><br><span class="line">    // è¡¨ç¤ºè¿˜æ²¡æœ‰è¢«è§£æ</span><br><span class="line">    this.parsed = false;</span><br><span class="line">    this.environment = environment;</span><br><span class="line">    this.parser = parser;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></div></figure>

<p>åˆ°è¿™é‡Œ,å°±å¯ä»¥çœ‹åˆ° thisæ„é€ æ–¹æ³•ä»¥åŠå…¶ä¹‹å‰è¿˜æœ‰newå¯¹è±¡çš„æ–¹æ³•,éƒ½å·²ç»èµ°å®Œäº†. è¿™ä¸Šé¢çš„æ–¹æ³•,åŸºæœ¬éƒ½æ˜¯å†ä¸ºåé¢çš„è§£æxmlæ–‡ä»¶åšå‡†å¤‡, å¹¶ä¸”è¿˜æœ‰ä¸€äº›åˆå§‹åŒ–æ•°æ®çš„èµ‹å€¼æ“ä½œ.</p>
<p><strong>Note</strong> : æ³¨æ„è¿™é‡Œçš„ BaseBuilderæ˜¯æŠ½è±¡ç±»,å…¶å®ç°ç±»æ˜¯æœ‰å¥½å‡ ä¸ªçš„. è¿™ç§å†™æ³•,å…¶å®æ˜¯å°†å­ç±»çš„ä¸€äº›commonçš„æ–¹æ³•,å†™å…¥åˆ° BaseBuilderçˆ¶ç±»ä¸­,ç„¶åä¸åŒçš„æ–¹æ³•,éœ€è¦å­ç±»è‡ªå·±å»é‡å†™è¿™ä¸ªæ–¹æ³•å®ç°è‡ªå·±çš„ä¸šåŠ¡é€»è¾‘. å½“ç„¶ä¸€äº›å‚æ•°ä¹Ÿæ˜¯å¯ä»¥æ”¾åœ¨æŠ½è±¡ç±»ä¸­.</p>
<p><strong>build(parser.parse())</strong> : è§£æä»£ç .</p>
<p>parser.parse() æ–¹æ³• :</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">public Configuration parse() &#123;</span><br><span class="line">  // ç”¨ parsed æ¥æ§åˆ¶æ˜¯å¦è§£æè¿‡,å¦‚æœå·²ç»è§£æè¿‡äº†,é‚£å°±æŠ›å‡ºå¼‚å¸¸.  </span><br><span class="line">  if (parsed) &#123;</span><br><span class="line">    throw new BuilderException(&quot;Each XMLConfigBuilder can only be used once.&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">  parsed = true;</span><br><span class="line">  //   </span><br><span class="line">  parseConfiguration(parser.evalNode(&quot;/configuration&quot;));</span><br><span class="line">  return configuration;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">---------------------------------</span><br><span class="line">// parseConfiguration</span><br><span class="line">// è¿™é‡Œ debug å¯ä»¥çœ‹åˆ° root æ˜¯ configuration çš„é…ç½®æ–‡ä»¶ä¿¡æ¯.   </span><br><span class="line">// è¿™é‡Œå¯ä»¥åˆæ­¥çœ‹åˆ°å®å¯¹ æˆ‘ä»¬çš„é…ç½®æ–‡ä»¶mybatis-config.xmlè¿›è¡Œè§£æ,å¹¶ä¸”åŠ è½½åˆ° configurationä¸­.</span><br><span class="line">// åé¢æˆ‘ä»¬è·Ÿç€å®˜ç½‘æ–‡æ¡£ä¸€æ­¥ä¸€æ­¥çš„é˜…è¯»,ä¼šæœ‰ä¸“é—¨å¯¹è§£æé…ç½®çš„æºç è¿›è¡Œåˆ†æ.    </span><br><span class="line">  private void parseConfiguration(XNode root) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">      //issue #117 read properties first</span><br><span class="line">      //   </span><br><span class="line">      propertiesElement(root.evalNode(&quot;properties&quot;));</span><br><span class="line">      Properties settings = settingsAsProperties(root.evalNode(&quot;settings&quot;));</span><br><span class="line">      loadCustomVfs(settings);</span><br><span class="line">      loadCustomLogImpl(settings);</span><br><span class="line">      typeAliasesElement(root.evalNode(&quot;typeAliases&quot;));</span><br><span class="line">      pluginElement(root.evalNode(&quot;plugins&quot;));</span><br><span class="line">      objectFactoryElement(root.evalNode(&quot;objectFactory&quot;));</span><br><span class="line">      objectWrapperFactoryElement(root.evalNode(&quot;objectWrapperFactory&quot;));</span><br><span class="line">      reflectorFactoryElement(root.evalNode(&quot;reflectorFactory&quot;));</span><br><span class="line">      settingsElement(settings);</span><br><span class="line">      // read it after objectFactory and objectWrapperFactory issue #631</span><br><span class="line">      environmentsElement(root.evalNode(&quot;environments&quot;));</span><br><span class="line">      databaseIdProviderElement(root.evalNode(&quot;databaseIdProvider&quot;));</span><br><span class="line">      typeHandlerElement(root.evalNode(&quot;typeHandlers&quot;));</span><br><span class="line">      mapperElement(root.evalNode(&quot;mappers&quot;));</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">      throw new BuilderException(&quot;Error parsing SQL Mapper Configuration. Cause: &quot; + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></div></figure>

<p><strong>build(parser.parse()) æ–¹æ³•</strong></p>
<p>è¿™é‡Œæ˜¯å¯¹ parser.parse() è°ƒç”¨ç©è¿”å›çš„ Configuration ä¼ å…¥åˆ°æ–°åˆ›å»ºçš„ DefaultSqlSessionFactory å¯¹è±¡ä¸­.</p>
<p>ä¹Ÿå°±æ˜¯è¯´,æˆ‘ä»¬æ‹¿åˆ°çš„ SqlSessionFactory æ˜¯ DefaultSqlSessionFactory.</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public SqlSessionFactory build(Configuration config) &#123;</span><br><span class="line">  return new DefaultSqlSessionFactory(config);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p><strong>è·å– SqlSession</strong></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">SqlSession session = sqlSessionFactory.openSession();</span><br><span class="line"></span><br><span class="line">// org.apache.ibatis.session.defaults.DefaultSqlSessionFactory#openSessionFromDataSource</span><br><span class="line">// çœ‹åˆ°è¿™ä¸ªæ–¹æ³•,ç›´æ¥è·Ÿè¿›åˆ°è¿™ä¸ªæ–¹æ³•æ¥.</span><br><span class="line"></span><br><span class="line">  private SqlSession openSessionFromDataSource(ExecutorType execType, TransactionIsolationLevel level, boolean autoCommit) &#123;</span><br><span class="line">    Transaction tx = null;</span><br><span class="line">    try &#123;</span><br><span class="line">        </span><br><span class="line">// ä» configurationä¸­è·å–å‡ºenvironmentæ¥,è¿™é‡Œçš„ getEnvironmentå¯¹åº”çš„æ˜¯</span><br><span class="line">// æ ‡ç­¾çš„ &lt;environment&gt;  é‡Œé¢çš„å†…å®¹</span><br><span class="line">// org.apache.ibatis.mapping.Environment</span><br><span class="line">// å¯ä»¥çœ‹åˆ°è¿™ä¸ªå¯¹è±¡,idå¯¹åº”mybatis-config.xmlä¸­çš„environment id</span><br><span class="line">// datasource å¯¹åº”  environment &gt; dataSource å­—æ®µ.</span><br><span class="line">      final Environment environment = configuration.getEnvironment();</span><br><span class="line">// æ ¹æ®    environment æ¥è·å– TransactionFactory,ä¹Ÿå°±æ˜¯MyBatisçš„äº‹åŠ¡å·¥å‚.</span><br><span class="line">// debug æ˜¯å¯ä»¥çœ‹åˆ°  environment ä¸­æ˜¯æœ‰ä¸€ä¸ªJdbcTransactionFactoryçš„,</span><br><span class="line">// å¦‚æœæ²¡ç”¨çš„è¯,å°±ä¼šè‡ªå·±newä¸€ä¸ª ManagedTransactionFactory æ¥.        </span><br><span class="line">      final TransactionFactory transactionFactory = getTransactionFactoryFromEnvironment(environment);</span><br><span class="line"></span><br><span class="line">// åœ¨ JdbcTransactionFactory ä¸­newå‡ºäº†ä¸€ä¸ª JdbcTransaction</span><br><span class="line">// ä¹Ÿå°±æ˜¯newäº†ä¸€ä¸ªJDBCäº‹åŠ¡.</span><br><span class="line">// org.apache.ibatis.transaction.jdbc.JdbcTransaction,</span><br><span class="line">// å¯ä»¥çœ‹åˆ° JdbcTransaction ä¸­æœ‰commit / rollbackçš„æ–¹æ³•,</span><br><span class="line">// ä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªåœ°æ–¹å°±æ˜¯å¯¹äº‹åŠ¡è¿›è¡Œæ“ä½œçš„åœ°æ–¹        </span><br><span class="line">      tx = transactionFactory.newTransaction(environment.getDataSource(), level, autoCommit);</span><br><span class="line">// è¿™é‡Œæ˜¯è·å–æ˜¯æ‰§è¡Œå™¨,</span><br><span class="line">// å…·ä½“ä»£ç : org.apache.ibatis.session.Configuration#newExecutor(org.apache.ibatis.transaction.Transaction, org.apache.ibatis.session.ExecutorType)</span><br><span class="line">// è¿™é‡Œæœ‰ SIMPLE, REUSE, BATCH ,CachingExecutor è¿˜å¯ä»¥åœ¨ plugin ä¸­è‡ªå·±å®šä¹‰.</span><br><span class="line">//executor = (Executor) interceptorChain.pluginAll(executor); ä»è¿™è¡Œä»£ç å¯ä»¥çœ‹åˆ°,</span><br><span class="line">// å…¶å®è¿˜æ˜¯å¯ä»¥è‡ªå·±æ‰©å±•çš„.        </span><br><span class="line">//org.apache.ibatis.plugin.InterceptorChain        </span><br><span class="line">      final Executor executor = configuration.newExecutor(tx, execType);</span><br><span class="line">// æœ€å new å‡ºäº†ä¸€ä¸ªé»˜è®¤çš„ SqlSession ä¼šè¯.</span><br><span class="line">// è¯¥ä¼šè¯ä¸­å­˜æœ‰ configuration / executor ç­‰æ ¸å¿ƒä¸œè¥¿.        </span><br><span class="line">      return new DefaultSqlSession(configuration, executor, autoCommit);</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">      closeTransaction(tx); // may have fetched a connection so lets call close()</span><br><span class="line">      throw ExceptionFactory.wrapException(&quot;Error opening session.  Cause: &quot; + e, e);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">// æœ€åè¿˜æ˜¯ä¸å¿˜è®°å¯¹ä½¿ç”¨è¿‡çš„ThreadLocal è¿›è¡Œremove æ“ä½œ.        </span><br><span class="line">      ErrorContext.instance().reset();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></div></figure>

<p>è‡³æ­¤, å¯ä»¥çœ‹åˆ° MyBatis ä»SqlSessionFactoryä¸­è·å–å‡ºæ¥SqlSessionä¼šè¯, ä¹Ÿå¯ä»¥ç†è§£ä¸ºå‡ ä¸ªæ­¥éª¤.</p>
<p>é¦–å…ˆè·å–äº‹åŠ¡å·¥å‚, ç„¶åå†ä»äº‹åŠ¡å·¥å‚ä¸­è·å–ä¸€ä¸ªäº‹åŠ¡æ¥, JdbcTransaction æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥çœ‹ä¸‹è¿™ä¸ªç±»,é‡Œé¢ä¹Ÿæ˜¯å°è£…äº†å†™ commit / rollbackç­‰æ–¹æ³•. å†æ¥ç€è·å–å‡º æ‰§è¡Œå™¨(Executor),è¿™é‡Œä»ä»£ç å“ªé‡Œçœ‹,æ‰§è¡Œå™¨è¿˜æ˜¯æœ‰å‡ ç§ç±»å‹çš„,ä¹Ÿæ‰§è¡Œè‡ªå®šä¹‰. æœ€ånewäº†ä¸€ä¸ª DefaultSqlSession å›å».</p>
<p><strong>session.getMapper(BlogMapper.class);</strong></p>
<p>æ¥ç€çœ‹,ä¸Šä¸€æ­¥è¿”å›çš„session,æ˜¯æ€ä¹ˆè·å–åˆ°æˆ‘ä»¬å†™çš„Mapperæ¥å£æ–‡ä»¶(Mapperè¿™ç§æ–‡ä»¶,åœ¨è§£æé…ç½®æ–‡ä»¶çš„æ—¶å€™,å…¶å®å°±å·²ç»è§£æåˆ°MyBatisçš„configurationé‡Œé¢å»äº†).</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">@SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">public &lt;T&gt; T getMapper(Class&lt;T&gt; type, SqlSession sqlSession) &#123;</span><br><span class="line"> // knownMappers  ä¸­ key æ˜¯æˆ‘ä»¬å®šä¹‰æ¥å£çš„Class,valueæ˜¯MapperProxyFactory,</span><br><span class="line">// MapperProxyFactoryä¸­çš„mapperInterfaceä¸­å­˜æ”¾äº†æˆ‘ä»¬çš„æ¥å£class    </span><br><span class="line">  final MapperProxyFactory&lt;T&gt; mapperProxyFactory = (MapperProxyFactory&lt;T&gt;) knownMappers.get(type);</span><br><span class="line">    </span><br><span class="line">// å¦‚æœè·å–å‡ºæ¥çš„æ˜¯null,é‚£ä¹ˆMyBatiså°±è®¤ä¸ºä½ ä¼ å…¥è¿›æ¥çš„æ¥å£æ˜¯ä¸å­˜åœ¨çš„,å°±ä¼šæŠ›å‡ºå¼‚å¸¸æ¥.    </span><br><span class="line">  if (mapperProxyFactory == null) &#123;</span><br><span class="line">    throw new BindingException(&quot;Type &quot; + type + &quot; is not known to the MapperRegistry.&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">  try &#123;</span><br><span class="line">// æ»¡è¶³æ¡ä»¶çš„è¯,è°ƒç”¨newInstanceæ–¹æ³•,ä»æ–¹æ³•åå­—ä¸Šçœ‹,æ˜¯åˆ›å»ºä¸€ä¸ªinstanceçš„å®ä¾‹.      </span><br><span class="line">    return mapperProxyFactory.newInstance(sqlSession);</span><br><span class="line">  &#125; catch (Exception e) &#123;</span><br><span class="line">    throw new BindingException(&quot;Error getting mapper instance. Cause: &quot; + e, e);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-------------------------------------------</span><br><span class="line">// mapperProxyFactory.newInstance(sqlSession) ä»£ç </span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">  public T newInstance(SqlSession sqlSession) &#123;</span><br><span class="line">    // new äº†ä¸€ä¸ª MapperProxyå¯¹è±¡.</span><br><span class="line">    final MapperProxy&lt;T&gt; mapperProxy = new MapperProxy&lt;&gt;(sqlSession, mapperInterface, methodCache);</span><br><span class="line">    return newInstance(mapperProxy);</span><br><span class="line">  &#125;    </span><br><span class="line"></span><br><span class="line">// æœ€åå¯ä»¥çœ‹åˆ°ä½¿ç”¨ Proxy.newProxyInstanceæ–¹æ³•æ¥åˆ›å»ºçš„ä¸€ä¸ªå¯¹è±¡.</span><br><span class="line">  @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">  protected T newInstance(MapperProxy&lt;T&gt; mapperProxy) &#123;</span><br><span class="line">    return (T) Proxy.newProxyInstance(mapperInterface.getClassLoader(), new Class[] &#123; mapperInterface &#125;, mapperProxy);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-------</span><br><span class="line">// å¦‚æœä½ æ˜¯debugæ¨¡å¼çš„è¯,é‚£ä¹ˆä½ å¯ä»¥çœ‹åˆ°BlogMapperçš„å¯¹è±¡åœ°å€æ± åœ¨ debug ä¸­æ˜¾ç¤ºçš„å€¼.</span><br><span class="line">// org.apache.ibatis.binding.MapperProxy@ef9296d    </span><br><span class="line">BlogMapper blogMapper = session.getMapper(BlogMapper.class);</span><br></pre></td></tr></table></div></figure>

<p>ä»SqlSession ä¸­è·å– BlogMapperæˆ‘ä»¬å†™çš„mapperæµç¨‹, å…ˆä» knownMappers ä¸­æ ¹æ®keyè·å–å‡ºæ¥ä¹‹å‰åŠ è½½é…ç½®å·²ç»åŠ è½½å®Œæ¯•çš„ä¿¡æ¯,å¦‚æœæ²¡ç”¨çš„è¯,å°±ä¼šæŠ›å‡ºæ²¡æœ‰çš„å¼‚å¸¸. æœ€åä½¿ç”¨ Proxy.newProxyIntsanceæ¥ç”Ÿæˆçš„ä¸€ä¸ªç±»ä¼¼æ¥å£å®ç°ç±»çš„ä»£ç ,ä¸åŒçš„æ˜¯, åœ¨ new MapperProxy çš„æ—¶å€™,å°±å·²ç»å°†æ¥ä¸‹æ¥éœ€è¦çš„ä¿¡æ¯å…¨éƒ¨ä¼ å…¥è¿›å».</p>
<p><strong>blogMapper.selectBlog(1) æ–¹æ³•</strong></p>
<p>ç«Ÿç„¶ BlogMapperæ˜¯é€šè¿‡Proxy.newInstanceè·å–å‡ºæ¥çš„,é‚£å®ƒæ˜¯æ€ä¹ˆæŸ¥è¯¢çš„æ•°æ®åº“? åˆæ˜¯æ€ä¹ˆå°†å­—æ®µç»™æ˜ å°„åˆ° Objectä¸€ä¸€å¯¹åº”çš„å‘¢ ?</p>
<p>debugä¼šèµ°åˆ° MapperProxyçš„invokeæ–¹æ³•æ¥</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123;</span><br><span class="line">  try &#123;</span><br><span class="line">    if (Object.class.equals(method.getDeclaringClass())) &#123;</span><br><span class="line">      return method.invoke(this, args);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      return cachedInvoker(method).invoke(proxy, method, args, sqlSession);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; catch (Throwable t) &#123;</span><br><span class="line">    throw ExceptionUtil.unwrapThrowable(t);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">------------------</span><br><span class="line">// é€šè¿‡ invoke æ–¹æ³•, èµ° mapperMethodçš„executeæ–¹æ³•,æ¥åˆ°äº†è¿™é‡Œ.</span><br><span class="line">// switch æœ‰ INSERT/UPDATE/DELETE/SELECT/FLUSH,å¦‚æœè¿™å‡ ç§æ²¡æœ‰åŒ¹é…åˆ°çš„è¯,å°±ä¼šæŠ›å‡ºå¼‚å¸¸æ¥.    </span><br><span class="line">  public Object execute(SqlSession sqlSession, Object[] args) &#123;</span><br><span class="line">    Object result;</span><br><span class="line">    switch (command.getType()) &#123;</span><br><span class="line">            </span><br><span class="line">// ä¸éš¾çœ‹åˆ° INSERT/UPDATE/DELETEéƒ½æ˜¯å…ˆè°ƒç”¨ convertArgsToSqlCommandParam æ–¹æ³•,</span><br><span class="line">// ä¹Ÿå°±æ˜¯å…ˆå°†å‚æ•°è½¬åŒ–ä¸ºsql,ç„¶åå°†æ‰§è¡Œçš„ç»“æœ èµ‹å€¼ ç»™ result å‚æ•°.            </span><br><span class="line">      case INSERT: &#123;</span><br><span class="line">        Object param = method.convertArgsToSqlCommandParam(args);</span><br><span class="line">        result = rowCountResult(sqlSession.insert(command.getName(), param));</span><br><span class="line">        break;</span><br><span class="line">      &#125;</span><br><span class="line">      case UPDATE: &#123;</span><br><span class="line">        Object param = method.convertArgsToSqlCommandParam(args);</span><br><span class="line">        result = rowCountResult(sqlSession.update(command.getName(), param));</span><br><span class="line">        break;</span><br><span class="line">      &#125;</span><br><span class="line">      case DELETE: &#123;</span><br><span class="line">        Object param = method.convertArgsToSqlCommandParam(args);</span><br><span class="line">        result = rowCountResult(sqlSession.delete(command.getName(), param));</span><br><span class="line">        break;</span><br><span class="line">      &#125;</span><br><span class="line">// å¦‚æœæ˜¯ select è¯­å¥,å¯ä»¥æ ¹æ®è¿”å›å€¼æ¥åˆ†ç±»,å¦‚æœæ˜¯void&amp;&amp;method.hasResultHandler,å°±ä¼šè¿”å›null</span><br><span class="line">// å¤šä¸ª / Mapç±»å‹  /    Cursor ç±»å‹   /  æœ€åæŸ¥è¯¢ä¸€ä¸ª        </span><br><span class="line">      case SELECT:</span><br><span class="line">        if (method.returnsVoid() &amp;&amp; method.hasResultHandler()) &#123;</span><br><span class="line">          executeWithResultHandler(sqlSession, args);</span><br><span class="line">          result = null;</span><br><span class="line">        &#125; else if (method.returnsMany()) &#123;</span><br><span class="line">          result = executeForMany(sqlSession, args);</span><br><span class="line">        &#125; else if (method.returnsMap()) &#123;</span><br><span class="line">          result = executeForMap(sqlSession, args);</span><br><span class="line">        &#125; else if (method.returnsCursor()) &#123;</span><br><span class="line">          result = executeForCursor(sqlSession, args);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          Object param = method.convertArgsToSqlCommandParam(args);</span><br><span class="line">          result = sqlSession.selectOne(command.getName(), param);</span><br><span class="line">          if (method.returnsOptional()</span><br><span class="line">              &amp;&amp; (result == null || !method.getReturnType().equals(result.getClass()))) &#123;</span><br><span class="line">            result = Optional.ofNullable(result);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        break;</span><br><span class="line"> // åˆ·æ–°ä¼šè¯.           </span><br><span class="line">      case FLUSH:</span><br><span class="line">        result = sqlSession.flushStatements();</span><br><span class="line">        break;</span><br><span class="line">      default:</span><br><span class="line">        throw new BindingException(&quot;Unknown execution method for: &quot; + command.getName());</span><br><span class="line">    &#125;</span><br><span class="line">// å¦‚æœresult æ˜¯ null, æ–¹æ³•è¿”å›çš„ä¿®é¥°ç¬¦æ˜¯privateå¹¶ä¸” è¿”å›å€¼ä¸æ˜¯voidçš„è¯,å°±ä¼šæŠ›å‡ºå¼‚å¸¸.    </span><br><span class="line">    if (result == null &amp;&amp; method.getReturnType().isPrimitive() &amp;&amp; !method.returnsVoid()) &#123;</span><br><span class="line">      throw new BindingException(&quot;Mapper method &#x27;&quot; + command.getName()</span><br><span class="line">          + &quot; attempted to return null from a method with a primitive return type (&quot; + method.getReturnType() + &quot;).&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    return result;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></div></figure>

<p>è¿™é‡Œå¯ä»¥çœ‹åˆ°,å…ˆæ˜¯å¯¹ INSERT / UPDATE / DELETE / SELECT è¿›è¡Œåˆ†ç±»å¤„ç†, ç„¶åå¯¹å†åˆ†åˆ«æ ¹æ®ä¸åŒçš„ç±»å‹è¿›è¡Œå¤„ç†. éƒ½æ˜¯å…ˆæœ‰è½¬åŒ–ä¸ºsql,ç„¶åå°†æ‰§è¡Œç»“æœèµ‹å€¼ç»™result.</p>
<p>è‡³äºé‡Œé¢è¯¦ç»†çš„æŸ¥è¯¢æ‰§è¡Œsql,è¿˜æœ‰åŠ¨æ€sql,æ¯æ¬¡ä¼šè¯ç¼“å­˜ç­‰,åé¢çœ‹åˆ°è¯¦ç»†çš„æƒ…å†µå†ä¸€ä¸€è¯´æ˜. è¿™é‡Œåªæ˜¯å¯¹MyBatisçš„åŸºæœ¬å·¥ä½œè¿›è¡Œäº†ä¸€ä¸ªæ¢³ç†. ç„¶ååé¢å†æ ¹æ®åŸºç¡€æ¢³ç†,å†æ¥æŒ¨ä¸ªå‡»ç¢ä»–ä»¬.</p>
<p>è‡³æ­¤, MyBatisçš„å…¥é—¨åˆ†ææµç¨‹æ˜¯ç»“æŸçš„. ç†è§£èµ·æ¥,åº”è¯¥è¿˜ä¸æ˜¯é‚£ä¹ˆéš¾.</p>

        <h4 id="æ€»ç»“"   >
          <a href="#æ€»ç»“" class="heading-link"><i class="fas fa-link"></i></a><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4>
      <p>æ ¹æ® com.iyang.mybatis.InitHelloMyBatis , ä¹Ÿå°±æ˜¯å…¥é—¨çš„demoæ¥æ¢³ç†ä¸‹æµç¨‹.</p>
<ol>
<li>è¯»å–é…ç½®æ–‡ä»¶,ä¹Ÿå°±æ˜¯å°†é…ç½®æ–‡ä»¶è¯»å–,è½¬åŒ–ä¸ºinptStreamæµ.</li>
<li>åˆ©ç”¨ SqlSessionFactoryBuilder æ¥ è§£ææµ, èµ·å†…éƒ¨åˆåˆ©ç”¨ BaseBuilder(å…¶åˆå¾ˆå¤šå®ç°ç±»,è¿™é‡Œç”¨çš„XMLConfigBuilder)ä¹Ÿè§£æxmlé…ç½®æ–‡ä»¶. Configuration configuration è¯¥ç±»ä¸­æ˜¯ä¿å­˜ç€xmlé…ç½®æ–‡ä»¶çš„å¾ˆå¤šä¿¡æ¯. ç„¶å DefaultSqlSessionFactory ä¸­æœ‰configurationå­—æ®µ,ä¹Ÿå°±æ˜¯å±æ€§.</li>
<li>ç„¶åä» DefaultSqlSessionFactory ä¸­è·å– SqlSessionæ¥, å¹¶ä¸”ä¹Ÿä¼šæ˜¯å¦å¼€å¯äº‹åŠ¡(å‚è€ƒ:org.apache.ibatis.transaction.jdbc.JdbcTransaction)ç±»,ç„¶åè·å– Executor,Executorä¹Ÿæ˜¯æœ‰å‡ ç§ç§ç±»çš„,ä¹Ÿå¯ä»¥è‡ªå·±è‡ªå®šä¹‰,æœ€åè¿”å›ä¸€ä¸ª DefaultSqlSession æ¥.</li>
<li>ç„¶åä» SqlSession ä¸­è·å–æˆ‘ä»¬çš„æ¥å£Mapper, æœ€åä¹Ÿæ˜¯åˆ©ç”¨ Proxy.newProxyInstance æ¥ç”Ÿæˆçš„æ¥å£,ä¹Ÿå°±æ˜¯ä»£ç†(è¿™é‡Œæ‰“å°å‡ºåœ°å€æ± æˆ–è€…debugçœ‹åœ°å€æ± ,å°±ä¼šå¾ˆæ˜æ˜¾çš„çœ‹åˆ°æ˜¯ä»£ç†å¯¹è±¡).</li>
<li>æœ€åèµ°æŸ¥è¯¢çš„æ–¹æ³•, ä¹Ÿå°±æ˜¯èµ°åˆ°äº† MapperProxy æ¥. å¯ä»¥çœ‹åˆ°MapperProxyé‡Œé¢æ˜¯æœ‰sqlSessionçš„,è€ŒSqlSessionæ˜¯æœ‰ Executor/configuration/autoCommitç­‰ä¿¡æ¯çš„, æœ‰äº†sqlSession,å°±å‰©ä¸‹æ‰§è¡Œsqlå’Œæ˜ å°„sqlæŸ¥è¯¢å‡ºæ¥çš„ç»“æœæ¥äº†(è¿™é‡Œæ˜¯ mapperMethod.execute(sqlSession, args) â€”&gt; org.apache.ibatis.binding.MapperMethod#execute èµ°åˆ°è¿™é‡Œæ¥äº†,è¿™é‡Œä¹‹åå°±ä¼šåˆ†ç±»è¿›è¡Œå¤„ç†,ç„¶åæ˜ å°„sqlè¯­å¥).</li>
<li>è‡³æ­¤,ä¸€ä¸ª MyBatis çš„ HelloWorldåˆ†ææµç¨‹æ˜¯å®Œæ¯•çš„.</li>
</ol>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/11/04/mybatis/mybatis%E4%B8%ADmapper%E6%96%87%E4%BB%B6%E9%98%85%E8%AF%BB/">mybatisä¸­mapperæ–‡ä»¶é˜…è¯»</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">å‘è¡¨äº</span><span class="post-meta-item__value">2021-11-04</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">æ›´æ–°äº</span><span class="post-meta-item__value">2021-11-04</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">å­—æ•°ç»Ÿè®¡</span><span class="post-meta-item__value">2.8k</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="far fa-clock"></i></span><span class="post-meta-item__info">é˜…è¯»æ—¶é•¿</span><span class="post-meta-item__value">24åˆ†</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h4 id="é¢˜è®°"   >
          <a href="#é¢˜è®°" class="heading-link"><i class="fas fa-link"></i></a><a href="#é¢˜è®°" class="headerlink" title="é¢˜è®°"></a>é¢˜è®°</h4>
      <p>MyBatisæ˜¯å¦‚ä½•å¯¹ Mapper æ–‡ä»¶ä¸­çš„sqlè¿›è¡Œå¤„ç†å‘¢ï¼Ÿ è™½ç„¶ä¸Šç¯‡è§£æ mybatis-config.xml æ˜¯æœ‰è¿›è¡Œè¯´æ˜çš„, ä½†æ˜¯åº”è¯¥æ‹¿å‡ºæ¥å•ç‹¬ä»”ç»†è§£æä¸‹. å› ä¸ºè¿™ä¸ªé‡Œé¢æ¶‰åŠåˆ°åŠ¨æ€sql, åŠ ä¸Šmapperæ–‡ä»¶è‡ªèº«ä¹Ÿæœ‰å¾ˆå¤šæ ‡ç­¾å†…å®¹,ç„¶åMyBatisæ˜¯æ€ä¹ˆè¯»å–å‡ºè¿™äº›å†…å®¹çš„å‘¢ï¼Ÿè¯»å–å‡ºæ¥å,åˆæ˜¯åšäº†æ€ä¹ˆæ ·çš„å¤„ç†, ç„¶åè¾¾åˆ°äº†sqlé‚£ç§æ‰§è¡Œæ•ˆæœçš„å‘¢ï¼Ÿ</p>
<p>æ„æ€ä¹Ÿå°±æ˜¯,Mapper + åŠ¨æ€sql , å†…å®¹è¿˜æ˜¯æœ‰ç‚¹å¤šçš„, å¹¶ä¸”ä¹Ÿå¾ˆé‡è¦, æ˜¯éå¸¸æœ‰å¿…è¦æ‹¿å‡ºæ¥å•ç‹¬çš„ä»”ç»†è®²è§£ä¸‹çš„.</p>

        <h4 id="Target"   >
          <a href="#Target" class="heading-link"><i class="fas fa-link"></i></a><a href="#Target" class="headerlink" title="Target"></a>Target</h4>
      <p>åœ¨ä¹‹å‰å¯¹æ ‡ç­¾çš„è¿›è¡Œè§£æçš„æ—¶å€™,æ˜¯æœ‰å¯¹ æ ‡ç­¾è¿›è¡Œä¸€ä¸ªåˆæ­¥çš„è§£æ. ç„¶åé‡Œé¢å…¶å®æ˜¯å¾ˆå¤šå†…å®¹è¿˜æ²¡å¡«è¡¥å¾ˆè¯¦ç»†,æ‰€ä»¥ç‰¹æ„è®°å½•ä¸‹å¯¹ è¯¦ç»†æ“ä½œçš„. é‚£ä¹ˆï¼Œä¸‹æ–‡å°±å¼€å§‹æ“ä½œå§.</p>
<p><strong>org.apache.ibatis.builder.xml.XMLMapperBuilder#parse</strong></p>
<p>ä¸»è¦æ¥çœ‹è¿™æ®µè§£æçš„ä»£ç  :</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">public void parse() &#123;</span><br><span class="line">    </span><br><span class="line">// åˆ©ç”¨ org.apache.ibatis.session.Configuration çš„ loadedResources</span><br><span class="line">// æ¥åˆ¤æ–­æ˜¯ä¸æ˜¯å·²ç»åŠ è½½è¿‡äº†çš„.    </span><br><span class="line">  if (!configuration.isResourceLoaded(resource)) &#123;</span><br><span class="line">    configurationElement(parser.evalNode(&quot;/mapper&quot;));</span><br><span class="line">// è¿™é‡Œæ·»åŠ åˆ° loadedResources ä¸­æ¥,ä¹Ÿå°±æ˜¯ç”¨æ¥æ§åˆ¶æ˜¯ä¸æ˜¯å·²ç»è§£æè¿‡äº†çš„.      </span><br><span class="line">    configuration.addLoadedResource(resource);</span><br><span class="line">    bindMapperForNamespace();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">// è¿™ä¸‰ä¸ªæ–¹æ³•ç»™æˆ‘ä¸€ç§å¥½åƒè§£æé‚£ç§æ²¡æœ‰è¿˜æ²¡è§£æå®Œçš„ ? è¿™ä¸ªåœ°æ–¹æœ‰å¾…å®Œå–„.    </span><br><span class="line">  parsePendingResultMaps();</span><br><span class="line">  parsePendingCacheRefs();</span><br><span class="line">  parsePendingStatements();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// configurationElement æ–¹æ³•,</span><br><span class="line">// å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ–¹æ³•ä¸­,å¾ˆå¤šæ ‡ç­¾(namespace/parameterMa/resultMap/sql)</span><br><span class="line">// è¿˜æœ‰ä¸‹é¢çš„select/insert/update/delete</span><br><span class="line">// è¿™äº›ç†Ÿæ‚‰çš„æ ‡ç­¾</span><br><span class="line">  private void configurationElement(XNode context) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">      String namespace = context.getStringAttribute(&quot;namespace&quot;);</span><br><span class="line">      if (namespace == null || namespace.equals(&quot;&quot;)) &#123;</span><br><span class="line">        throw new BuilderException(&quot;Mapper&#x27;s namespace cannot be empty&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">// å°† namespace èµ‹å€¼è¿›å»,ä¹Ÿå°±æ˜¯å½“å‰æ­£åœ¨è§£æçš„ namespace.        </span><br><span class="line">      builderAssistant.setCurrentNamespace(namespace);</span><br><span class="line">        </span><br><span class="line">// è¿™é‡Œæ˜¯å¯¹ç¼“å­˜æ ‡ç­¾è¿›è¡Œè§£æ.        </span><br><span class="line">      cacheRefElement(context.evalNode(&quot;cache-ref&quot;));</span><br><span class="line">      cacheElement(context.evalNode(&quot;cache&quot;));</span><br><span class="line"> </span><br><span class="line">// è§£æ parameterMapæ ‡ç­¾        </span><br><span class="line">      parameterMapElement(context.evalNodes(&quot;/mapper/parameterMap&quot;));</span><br><span class="line">        </span><br><span class="line">//         </span><br><span class="line">      resultMapElements(context.evalNodes(&quot;/mapper/resultMap&quot;));</span><br><span class="line">      sqlElement(context.evalNodes(&quot;/mapper/sql&quot;));</span><br><span class="line">      buildStatementFromContext(context.evalNodes(&quot;select|insert|update|delete&quot;));</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">      throw new BuilderException(&quot;Error parsing Mapper XML. The XML location is &#x27;&quot; + resource + &quot;&#x27;. Cause: &quot; + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></div></figure>

<p><strong>resultMapElements æ–¹æ³• :</strong></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">// è¿™é‡Œçš„ list æ˜¯ xml æ–‡ä»¶ä¸­çš„æ‰€æœ‰ &lt;resultMap&gt; æ ‡ç­¾æ–‡ä»¶.</span><br><span class="line">private void resultMapElements(List&lt;XNode&gt; list) &#123;</span><br><span class="line">  for (XNode resultMapNode : list) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">//  æœ‰ç‚¹å¥½å¥‡,è¯¥æ–¹æ³•è¿”å›çš„ ResultMap è¿™è¾¹å¥½åƒå¹¶æ²¡æœ‰å‚æ•°,æœ‰ç‚¹å°´å°¬.</span><br><span class="line">//  ä¸è¿‡æ˜¯å·²ç»å­˜å‚¨åœ¨ org.apache.ibatis.session.Configuration#resultMaps ä¸­.       </span><br><span class="line">      resultMapElement(resultMapNode);</span><br><span class="line">    &#125; catch (IncompleteElementException e) &#123;</span><br><span class="line">      // ignore, it will be retried</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">----------</span><br><span class="line">// æœ€åè·Ÿè¿›åˆ°è¿™ä¸ªæ–¹æ³•ä¸­æ¥.</span><br><span class="line">  private ResultMap resultMapElement(XNode resultMapNode, List&lt;ResultMapping&gt; additionalResultMappings, Class&lt;?&gt; enclosingType) &#123;</span><br><span class="line">    ErrorContext.instance().activity(&quot;processing &quot; + resultMapNode.getValueBasedIdentifier());</span><br><span class="line"> </span><br><span class="line">// è·å–å‡º type , è¿™é‡Œæˆ‘ä»¬è·å–å‡ºæ¥çš„ type æ˜¯ TbBlog.    </span><br><span class="line">    String type = resultMapNode.getStringAttribute(&quot;type&quot;,</span><br><span class="line">        resultMapNode.getStringAttribute(&quot;ofType&quot;,</span><br><span class="line">            resultMapNode.getStringAttribute(&quot;resultType&quot;,</span><br><span class="line">                resultMapNode.getStringAttribute(&quot;javaType&quot;))));</span><br><span class="line">// å…ˆåˆ¤æ–­ org.apache.ibatis.type.TypeAliasRegistry#typeAliases ä¸­æœ‰æ²¡æœ‰,</span><br><span class="line">// å¦‚æœæ²¡æœ‰çš„è¯,å°±ä¼šè‡ªå·±newä¸€ä¸ªå‡ºæ¥.    </span><br><span class="line">    Class&lt;?&gt; typeClass = resolveClass(type);</span><br><span class="line">    if (typeClass == null) &#123;</span><br><span class="line">// TODO,å¦‚æœæ²¡æœ‰è¯?        </span><br><span class="line">      typeClass = inheritEnclosingType(resultMapNode, enclosingType);</span><br><span class="line">    &#125;</span><br><span class="line">    Discriminator discriminator = null;</span><br><span class="line">    List&lt;ResultMapping&gt; resultMappings = new ArrayList&lt;&gt;(additionalResultMappings);</span><br><span class="line">    </span><br><span class="line"> // è·å–è¯¥ &lt;resultMap&gt; ä¸‹çš„å­æ ‡ç­¾</span><br><span class="line">// é‚£ä¹ˆè¿™é‡Œä¹Ÿå°±æ˜¯è·å– &lt;id&gt; å’Œ &lt;result&gt; è¿™äºŒä¸ª.    </span><br><span class="line">    List&lt;XNode&gt; resultChildren = resultMapNode.getChildren();</span><br><span class="line">    for (XNode resultChild : resultChildren) &#123;</span><br><span class="line">// åˆ†ä¸º constructor / discriminator / å…¶ä»– è¿™ä¸‰ç±»æƒ…å†µ        </span><br><span class="line">      if (&quot;constructor&quot;.equals(resultChild.getName())) &#123;</span><br><span class="line">        processConstructorElement(resultChild, typeClass, resultMappings);</span><br><span class="line">      &#125; else if (&quot;discriminator&quot;.equals(resultChild.getName())) &#123;</span><br><span class="line">        discriminator = processDiscriminatorElement(resultChild, typeClass, resultMappings);</span><br><span class="line">      &#125; else &#123;</span><br><span class="line"> // éå‰äºŒè€…æƒ…å†µ.         </span><br><span class="line">        List&lt;ResultFlag&gt; flags = new ArrayList&lt;&gt;();</span><br><span class="line">        if (&quot;id&quot;.equals(resultChild.getName())) &#123;</span><br><span class="line">         // å¦‚æœæ ‡ç­¾æ˜¯idçš„è¯,å°±ä¼šç»™flagsæ·»åŠ ResultFlag.ID.</span><br><span class="line">          flags.add(ResultFlag.ID);</span><br><span class="line">        &#125;</span><br><span class="line">  //  å°†è¿”å›å›æ¥çš„ ResultMapping æ·»åŠ è¿›æ¥.       </span><br><span class="line">        resultMappings.add(buildResultMappingFromContext(resultChild, typeClass, flags));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">// è¿™é‡Œè·å–çš„æ˜¯ &lt;resultMap&gt; æ ‡ç­¾çš„ id å­—æ®µ.    </span><br><span class="line">    String id = resultMapNode.getStringAttribute(&quot;id&quot;,</span><br><span class="line">            resultMapNode.getValueBasedIdentifier());</span><br><span class="line">// è¿™é‡Œè¿˜å¯ä»¥ä½¿ç”¨ extends å±æ€§, ä¸æ˜¯çœ‹åˆ°è¿™é‡Œ, éƒ½å¥½å¥‡è¿˜æœ‰è¿™ç§æ ‡ç­¾.    </span><br><span class="line">    String extend = resultMapNode.getStringAttribute(&quot;extends&quot;);</span><br><span class="line">    Boolean autoMapping = resultMapNode.getBooleanAttribute(&quot;autoMapping&quot;);</span><br><span class="line">// è¿™é‡Œ new äº†ä¸€ä¸ª ResultMapResolver å¯¹è±¡.   </span><br><span class="line">    ResultMapResolver resultMapResolver = new ResultMapResolver(builderAssistant, id, typeClass, extend, discriminator, resultMappings, autoMapping);</span><br><span class="line">    try &#123;</span><br><span class="line">// è¿™é‡Œæœ€åå°±æ˜¯ new äº†ä¸€ä¸ª ResultMap å¯¹è±¡, è¯¥å¯¹è±¡çš„ id æ˜¯ namespace + æ–¹æ³•ID æ‹¼æ¥.</span><br><span class="line">// ç„¶åå°†è¯¥å¯¹è±¡ç»™æ·»åŠ åˆ°  org.apache.ibatis.session.Configuration#resultMaps ä¸­æ¥,</span><br><span class="line">// key å°±æ˜¯å…¶id, æœ€åå°±æ˜¯æ ¹æ® local / global æ¥åˆ†åˆ«è¿›è¡ŒäºŒç§æƒ…å†µæ£€æŸ¥.        </span><br><span class="line">      return resultMapResolver.resolve();</span><br><span class="line">    &#125; catch (IncompleteElementException  e) &#123;</span><br><span class="line">      configuration.addIncompleteResultMap(resultMapResolver);</span><br><span class="line">      throw e;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//  buildResultMappingFromContext æ–¹æ³•</span><br><span class="line">// è¯¥æ–¹æ³•æ˜¯å¯¹ resultMap ä¸­çš„å­—æ®µè¿›è¡Œè§£æ.</span><br><span class="line">  private ResultMapping buildResultMappingFromContext(XNode context, Class&lt;?&gt; resultType, List&lt;ResultFlag&gt; flags) &#123;</span><br><span class="line">    String property;</span><br><span class="line">    if (flags.contains(ResultFlag.CONSTRUCTOR)) &#123;</span><br><span class="line">      property = context.getStringAttribute(&quot;name&quot;);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      property = context.getStringAttribute(&quot;property&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    String column = context.getStringAttribute(&quot;column&quot;);</span><br><span class="line">    String javaType = context.getStringAttribute(&quot;javaType&quot;);</span><br><span class="line">    String jdbcType = context.getStringAttribute(&quot;jdbcType&quot;);</span><br><span class="line">    String nestedSelect = context.getStringAttribute(&quot;select&quot;);</span><br><span class="line">    String nestedResultMap = context.getStringAttribute(&quot;resultMap&quot;, () -&gt;</span><br><span class="line">      processNestedResultMappings(context, Collections.emptyList(), resultType));</span><br><span class="line">    String notNullColumn = context.getStringAttribute(&quot;notNullColumn&quot;);</span><br><span class="line">    String columnPrefix = context.getStringAttribute(&quot;columnPrefix&quot;);</span><br><span class="line">    String typeHandler = context.getStringAttribute(&quot;typeHandler&quot;);</span><br><span class="line">    String resultSet = context.getStringAttribute(&quot;resultSet&quot;);</span><br><span class="line">    String foreignColumn = context.getStringAttribute(&quot;foreignColumn&quot;);</span><br><span class="line">    boolean lazy = &quot;lazy&quot;.equals(context.getStringAttribute(&quot;fetchType&quot;, configuration.isLazyLoadingEnabled() ? &quot;lazy&quot; : &quot;eager&quot;));</span><br><span class="line">      </span><br><span class="line">// è·å– javaType , typeHandler , jdbcType ç­‰å¯¹è±¡.      </span><br><span class="line">    Class&lt;?&gt; javaTypeClass = resolveClass(javaType);</span><br><span class="line">    Class&lt;? extends TypeHandler&lt;?&gt;&gt; typeHandlerClass = resolveClass(typeHandler);</span><br><span class="line">    JdbcType jdbcTypeEnum = resolveJdbcType(jdbcType);</span><br><span class="line">// org.apache.ibatis.builder.MapperBuilderAssistant#buildResultMapping(java.lang.Class&lt;?&gt;, java.lang.String, java.lang.String, java.lang.Class&lt;?&gt;, org.apache.ibatis.type.JdbcType, java.lang.String, java.lang.String, java.lang.String, java.lang.String, java.lang.Class&lt;? extends org.apache.ibatis.type.TypeHandler&lt;?&gt;&gt;, java.util.List&lt;org.apache.ibatis.mapping.ResultFlag&gt;, java.lang.String, java.lang.String, boolean)</span><br><span class="line">// å¯ä»¥çœ‹åˆ°è¿™é‡Œä¼ é€’è¿›æ¥çš„å‚æ•°è¿˜æ˜¯å¾ˆå¤šçš„.</span><br><span class="line">// æœ€åè¿”å› ResultMapping å¯¹è±¡,ä¹Ÿå°±æ˜¯è¯´è¿™ä¹ˆå¤šå‚æ•°&amp;buildResultMappingæ–¹æ³•ä¸­çš„å‚æ•°,</span><br><span class="line">//éƒ½è®¾ç½®åˆ°è¯¥å¯¹è±¡ä¸­æ¥äº†.     </span><br><span class="line">    return builderAssistant.buildResultMapping(resultType, property, column, javaTypeClass, jdbcTypeEnum, nestedSelect, nestedResultMap, notNullColumn, columnPrefix, typeHandlerClass, flags, resultSet, foreignColumn, lazy);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></div></figure>

<p><strong>SqlElement æ–¹æ³•</strong></p>
<p>è¯¥æ–¹æ³•å¯ä»¥å¾ˆæ˜æ˜¾çš„æ„Ÿå—åˆ°æ˜¯å¯¹ æ ‡ç­¾è¿›è¡Œè§£æçš„.</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">private void sqlElement(List&lt;XNode&gt; list) &#123;</span><br><span class="line"> // configuration è·å–å‡ºæ¥ dataBaseIdæ˜¯null,è·³è¿‡æ­¤æ–¹æ³•  </span><br><span class="line">  if (configuration.getDatabaseId() != null) &#123;</span><br><span class="line">    sqlElement(list, configuration.getDatabaseId());</span><br><span class="line">  &#125;</span><br><span class="line">//    </span><br><span class="line">  sqlElement(list, null);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// æœ‰ç‚¹å¥½å¥‡å†™ä»£ç é£æ ¼:  sqlElement(list,configuration.getDatabaseId());</span><br><span class="line">------------------------</span><br><span class="line"></span><br><span class="line">//  sqlElement æ–¹æ³•</span><br><span class="line">  private void sqlElement(List&lt;XNode&gt; list, String requiredDatabaseId) &#123;</span><br><span class="line">    for (XNode context : list) &#123;</span><br><span class="line">        </span><br><span class="line"> // è·å– databaseId å’Œ id è¿™äºŒä¸ªå±æ€§çš„å€¼.       </span><br><span class="line">      String databaseId = context.getStringAttribute(&quot;databaseId&quot;);</span><br><span class="line">      String id = context.getStringAttribute(&quot;id&quot;);</span><br><span class="line"> //  org.apache.ibatis.builder.MapperBuilderAssistant#applyCurrentNamespace   </span><br><span class="line"> // è¯¥æ–¹æ³•æœ€åè¿”å›çš„idçš„å€¼æ˜¯: namespace + id       </span><br><span class="line">      id = builderAssistant.applyCurrentNamespace(id, false);</span><br><span class="line">//sqlFragments ä¸åŒ…å«è¯¥idå°±è¿”å›true,ä¹Ÿå°±è¯´è¯¥Mapæ˜¯ç¡®å®šæ˜¯å¦å·²ç»è§£æè¿‡äº†çš„.         </span><br><span class="line">      if (databaseIdMatchesCurrent(id, databaseId, requiredDatabaseId)) &#123;</span><br><span class="line">// æ·»åŠ åˆ° org.apache.ibatis.builder.xml.XMLMapperBuilder#sqlFragments ä¸­æ¥.          </span><br><span class="line">        sqlFragments.put(id, context);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></div></figure>

<p>æœ€å è§£æåçš„å€¼,æ˜¯ä½¿ç”¨ namespace + id å­˜æ”¾åœ¨ org.apache.ibatis.builder.xml.XMLMapperBuilder#sqlFragments çš„å±æ€§ä¸­çš„.</p>
<p><strong>buildStatementFromContext() æ–¹æ³• :</strong></p>
<p>è¿™é‡Œæ˜¯å¯¹ select / insert / update / delete æ ‡ç­¾è¿›è¡Œè§£æ.</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line">buildStatementFromContext(context.evalNodes(&quot;select|insert|update|delete&quot;));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// å¯ä»¥çœ‹åˆ° databaseId çš„è·å–ä¸ sql æ ‡ç­¾æ˜¯ä¸€æ ·çš„æ“ä½œ</span><br><span class="line">private void buildStatementFromContext(List&lt;XNode&gt; list) &#123;</span><br><span class="line">  if (configuration.getDatabaseId() != null) &#123;</span><br><span class="line">    buildStatementFromContext(list, configuration.getDatabaseId());</span><br><span class="line">  &#125;</span><br><span class="line">  buildStatementFromContext(list, null);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// æ‰€ä»¥æˆ‘ä»¬å¯ä»¥è·Ÿè¿›åˆ°è¿™ä¸ªæ–¹æ³•æ¥.</span><br><span class="line">  private void buildStatementFromContext(List&lt;XNode&gt; list, String requiredDatabaseId) &#123;</span><br><span class="line">    for (XNode context : list) &#123;</span><br><span class="line">// å…ˆ new äº†ä¸€ä¸ª XMLStatementBuilder å¯¹è±¡, ç´§æ¥ç€å°±è°ƒç”¨è¯¥å¯¹è±¡çš„ è§£æ æ–¹æ³•.        </span><br><span class="line">      final XMLStatementBuilder statementParser = new XMLStatementBuilder(configuration, builderAssistant, context, requiredDatabaseId);</span><br><span class="line">      try &#123;</span><br><span class="line">        statementParser.parseStatementNode();</span><br><span class="line">      &#125; catch (IncompleteElementException e) &#123;</span><br><span class="line">        configuration.addIncompleteStatement(statementParser);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// è§£ææ–¹æ³•</span><br><span class="line">  public void parseStatementNode() &#123;</span><br><span class="line">    String id = context.getStringAttribute(&quot;id&quot;);</span><br><span class="line">    String databaseId = context.getStringAttribute(&quot;databaseId&quot;);</span><br><span class="line">// ç”¨ namespace + id ç»„åˆä¸º id</span><br><span class="line">// org.apache.ibatis.session.Configuration#mappedStatements</span><br><span class="line">// æ¥ç€å°±æ˜¯åˆ¤æ–­åœ¨ mappedStatements ä¸­æ˜¯ä¸æ˜¯æœ‰è¯¥id,å¦‚æœä¸å­˜åœ¨å°±è¿”å›ture,</span><br><span class="line">// å­˜åœ¨å°±è¿”å›false,è¿™é‡Œä¹Ÿå°±ä¼šç›´æ¥returnå‡ºå»,ä¹Ÿå°±æ˜¯ä¸ä¼šå¾€åé¢æ‰§è¡Œäº†.      </span><br><span class="line">    if (!databaseIdMatchesCurrent(id, databaseId, this.requiredDatabaseId)) &#123;</span><br><span class="line">      return;</span><br><span class="line">    &#125;</span><br><span class="line">// è·å–æ ‡ç­¾åå­—,  select / insert/ update /delete.</span><br><span class="line">    String nodeName = context.getNode().getNodeName();</span><br><span class="line">// è½¬åŒ–ä¸ºå¤§å†™çš„ SELECT      </span><br><span class="line">    SqlCommandType sqlCommandType = SqlCommandType.valueOf(nodeName.toUpperCase(Locale.ENGLISH));</span><br><span class="line">    boolean isSelect = sqlCommandType == SqlCommandType.SELECT;</span><br><span class="line">// æ˜¯å¦åˆ·æ–° cache,ä¹Ÿå°±æ˜¯selectæ˜¯ä¸åˆ·æ–°çš„,é‚£ä¹ˆå…¶ä»–çš„å°±åº”è¯¥æ˜¯è¦åˆ·æ–°çš„.      </span><br><span class="line">    boolean flushCache = context.getBooleanAttribute(&quot;flushCache&quot;, !isSelect);</span><br><span class="line">// ä½¿ç”¨ä½¿ç”¨ cache,è¿™é‡Œåº”è¯¥æ˜¯ä¸€çº§ç¼“å­˜ï¼Œé»˜è®¤å¼€å¯çš„.      </span><br><span class="line">    boolean useCache = context.getBooleanAttribute(&quot;useCache&quot;, isSelect);</span><br><span class="line">// ç»“æœæ’åº, å¦‚æœæ²¡æœ‰é…ç½®çš„è¯,é»˜è®¤å°±æ˜¯false.      </span><br><span class="line">    boolean resultOrdered = context.getBooleanAttribute(&quot;resultOrdered&quot;, false);</span><br><span class="line"></span><br><span class="line">    // Include Fragments before parsing</span><br><span class="line">// åˆ›å»ºäº†ä¸€ä¸ª XMLIncludeTransformer å¯¹è±¡,è¯¥å¯¹è±¡åº”è¯¥æ˜¯è¿›è¡Œè½¬åŒ–çš„.      </span><br><span class="line">    XMLIncludeTransformer includeParser = new XMLIncludeTransformer(configuration, builderAssistant);</span><br><span class="line"> //  TODO ? è¯¥æ–¹æ³•æœ‰å¾…æ›´æ–°     </span><br><span class="line">    includeParser.applyIncludes(context.getNode());</span><br><span class="line"></span><br><span class="line">//è·å– parameterType å±æ€§,å¦‚æœæœ‰çš„è¯,ä¹Ÿä¼šè·å–å‡ºè¯¥å±æ€§å¯¹åº”çš„ Class.    </span><br><span class="line">    String parameterType = context.getStringAttribute(&quot;parameterType&quot;);</span><br><span class="line">    Class&lt;?&gt; parameterTypeClass = resolveClass(parameterType);</span><br><span class="line"></span><br><span class="line">// lang : null,è¿™é‡Œæ˜¯æ²¡æœ‰è®¾ç½®çš„.      </span><br><span class="line">    String lang = context.getStringAttribute(&quot;lang&quot;);</span><br><span class="line">    LanguageDriver langDriver = getLanguageDriver(lang);</span><br><span class="line"></span><br><span class="line">    // Parse selectKey after includes and remove them.</span><br><span class="line">// è¿™é‡Œå¯¹æ˜¯å¦æœ‰ selectKey è¿›è¡Œå¤„ç†.æˆ‘ä»¬è¿™é‡Œç›®å‰æ²¡æœ‰ä½¿ç”¨ selectKey</span><br><span class="line">    processSelectKeyNodes(id, parameterTypeClass, langDriver);</span><br><span class="line"></span><br><span class="line">    // Parse the SQL (pre: &lt;selectKey&gt; and &lt;include&gt; were parsed and removed)</span><br><span class="line">    KeyGenerator keyGenerator;</span><br><span class="line"> // selectBlog!selectKey     </span><br><span class="line">    String keyStatementId = id + SelectKeyGenerator.SELECT_KEY_SUFFIX;</span><br><span class="line">// è¿™é‡Œæ‹¼æ¥ä¸Š namespace :  com.iyang.mybatis.mapper.BlogMapper.selectBlog!selectKey      </span><br><span class="line">    keyStatementId = builderAssistant.applyCurrentNamespace(keyStatementId, true);</span><br><span class="line"></span><br><span class="line">// è¿™é‡Œæ˜¯åˆ¤æ–­æ˜¯å¦æœ‰ ä¸»é”®è‡ªåŠ¨ç”Ÿæˆ. è¿™é‡Œæ˜¯æŸ¥è¯¢è¯­å¥,åº”è¯¥æ˜¯æ²¡æœ‰çš„. </span><br><span class="line">    if (configuration.hasKeyGenerator(keyStatementId)) &#123;</span><br><span class="line">      keyGenerator = configuration.getKeyGenerator(keyStatementId);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      keyGenerator = context.getBooleanAttribute(&quot;useGeneratedKeys&quot;,</span><br><span class="line">          configuration.isUseGeneratedKeys() &amp;&amp; SqlCommandType.INSERT.equals(sqlCommandType))</span><br><span class="line">          ? Jdbc3KeyGenerator.INSTANCE : NoKeyGenerator.INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">// åˆ›å»ºä¸€ä¸ª XMLScriptBuilder å¯¹è±¡,ä½¿ç”¨è¯¥å¯¹è±¡çš„parseScriptNodeæ–¹æ³•æ¥è§£æ</span><br><span class="line">// org.apache.ibatis.scripting.xmltags.XMLScriptBuilder#parseScriptNode</span><br><span class="line">// è·å–å‡ºsql, æœ‰ä¸ª isDynamic å‚æ•°,æ¥åˆ¤æ–­æ˜¯ä¸æ˜¯åŠ¨æ€sqlè¯­å¥.</span><br><span class="line">// è¿™é‡Œä¸æ˜¯åŠ¨æ€sql,æœ€ånewäº†ä¸€ä¸ªRawSqlSource.</span><br><span class="line">// org.apache.ibatis.builder.SqlSourceBuilder#parse,æˆ‘ä»¬çš„#&#123;id&#125; æ›¿æ¢æˆ ? å°±æ˜¯åœ¨</span><br><span class="line">// è¿™é‡Œè¿›è¡Œæ›¿æ¢çš„.</span><br><span class="line">// å¦‚æœæ˜¯åŠ¨æ€ sql çš„è¯,å°±ä¼šåˆ›å»ºå‡º DynamicSqlSource è¯¥å¯¹è±¡æ¥.</span><br><span class="line">// å¯ä»¥çœ‹åˆ° SqlSource ä¸‹é¢æ˜¯æœ‰ å››ä¸ªå®ç°ç±»çš„.</span><br><span class="line">// è¿™é‡Œè¿”å›çš„ SqlSourceé‡Œé¢æœ‰sqlè¯­å¥çš„,å’Œè¿”å›ç±»å‹çš„.      </span><br><span class="line">    SqlSource sqlSource = langDriver.createSqlSource(configuration, context, parameterTypeClass);</span><br><span class="line"> </span><br><span class="line">// è·å–å±æ€§.      </span><br><span class="line">    StatementType statementType = StatementType.valueOf(context.getStringAttribute(&quot;statementType&quot;, StatementType.PREPARED.toString()));</span><br><span class="line">    Integer fetchSize = context.getIntAttribute(&quot;fetchSize&quot;);</span><br><span class="line">    Integer timeout = context.getIntAttribute(&quot;timeout&quot;);</span><br><span class="line">    String parameterMap = context.getStringAttribute(&quot;parameterMap&quot;);</span><br><span class="line">// è·å–è¿”å›ç±»å‹. è·å–å‡ºæ¥çš„ resultTypeClass æ˜¯ class com.iyang.mybatis.pojo.TbBlog      </span><br><span class="line">    String resultType = context.getStringAttribute(&quot;resultType&quot;);</span><br><span class="line">    Class&lt;?&gt; resultTypeClass = resolveClass(resultType);</span><br><span class="line">    String resultMap = context.getStringAttribute(&quot;resultMap&quot;);      </span><br><span class="line">    String resultSetType = context.getStringAttribute(&quot;resultSetType&quot;);</span><br><span class="line">    ResultSetType resultSetTypeEnum = resolveResultSetType(resultSetType);</span><br><span class="line">    if (resultSetTypeEnum == null) &#123;</span><br><span class="line">      resultSetTypeEnum = configuration.getDefaultResultSetType();</span><br><span class="line">    &#125;</span><br><span class="line">// è·å–å±æ€§çš„å€¼      </span><br><span class="line">    String keyProperty = context.getStringAttribute(&quot;keyProperty&quot;);</span><br><span class="line">    String keyColumn = context.getStringAttribute(&quot;keyColumn&quot;);</span><br><span class="line">    String resultSets = context.getStringAttribute(&quot;resultSets&quot;);</span><br><span class="line"></span><br><span class="line">// åˆ›å»ºä¸€ä¸ª MappedStatement.Builder å¯¹è±¡å‡ºæ¥.</span><br><span class="line">// å†é€šè¿‡ builder æ„å»ºå‡ºä¸€ä¸ª MappedStatement å¯¹è±¡æ¥.</span><br><span class="line">// æœ€åæ”¾å…¥åˆ° org.apache.ibatis.session.Configuration#mappedStatements ä¸­æ¥.      </span><br><span class="line">    builderAssistant.addMappedStatement(id, sqlSource, statementType, sqlCommandType,</span><br><span class="line">        fetchSize, timeout, parameterMap, parameterTypeClass, resultMap, resultTypeClass,</span><br><span class="line">        resultSetTypeEnum, flushCache, useCache, resultOrdered,</span><br><span class="line">        keyGenerator, keyProperty, keyColumn, databaseId, langDriver, resultSets);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  private void processSelectKeyNodes(String id, Class&lt;?&gt; parameterTypeClass, LanguageDriver langDriver) &#123;</span><br><span class="line">    List&lt;XNode&gt; selectKeyNodes = context.evalNodes(&quot;selectKey&quot;);</span><br><span class="line">    if (configuration.getDatabaseId() != null) &#123;</span><br><span class="line">      parseSelectKeyNodes(id, selectKeyNodes, parameterTypeClass, langDriver, configuration.getDatabaseId());</span><br><span class="line">    &#125;</span><br><span class="line">    parseSelectKeyNodes(id, selectKeyNodes, parameterTypeClass, langDriver, null);</span><br><span class="line">    removeSelectKeyNodes(selectKeyNodes);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="æ€»ç»“"   >
          <a href="#æ€»ç»“" class="heading-link"><i class="fas fa-link"></i></a><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4>
      <p>æ€»ç»“ä¸‹ MyBatis è§£æ Mapperçš„xml æ–‡ä»¶æµç¨‹ã€‚ å¯ä»¥æ„Ÿå—åˆ°,å¯¹äºMybatiså¤„ç†Mapper,å¯¹å…¶å­—æ®µå±æ€§éƒ½æ˜¯æŒ¨ä¸ªè§£æçš„,è¿˜æ˜¯ä¸‹äº†å¾ˆå¤§çš„åŠŸå¤«.</p>
<p>å…ˆæ˜¯æœ‰ä¸€ä¸ªé›†åˆæ¥æ§åˆ¶æ˜¯å¦å·²ç»è§£æè¿‡äº†,ç®—æ˜¯ä¸€ç§æ˜¯å¦è§£æçš„å¼€å…³é…ç½®. å¯ä»¥çœ‹åˆ°å…¶å…ˆåçš„è§£æé¡ºåº,</p>
<p>namespace â€“&gt; cache-ref â€“&gt; cache â€”&gt; mapper/parameterMap â€”&gt; mapper/resultMap â€”&gt; mapper/sql â€”&gt; select/insert/update/detele.</p>
<p>å½“è§£æè¿™äº›æ ‡ç­¾çš„æ—¶å€™, åˆä¼šå¯¹æ ‡ç­¾é‡Œé¢çš„å±æ€§è¿›è¡Œè§£æ. è¿™é‡Œ,ä¸»è¦çœ‹ä¸‹æˆ‘ä»¬å¹³å¸¸ä½¿ç”¨åˆ°æœ€å¤šçš„æ ‡ç­¾, MyBatis å¯¹è¿™äº›æ ‡ç­¾è§£æäº†å,å…¶åæœ‰æ˜¯æ€ä¹ˆåˆ©ç”¨çš„å‘¢ï¼Ÿå¯ä»¥çœ‹åˆ°ç›®å‰MyBatisæ˜¯å­˜æ”¾åœ¨ä¸€äº›configurationç­‰ç±»ä¿¡æ¯é‡Œé¢,é‚£ä¹ˆç­‰åˆ°çœŸæ­£å»æŸ¥è¯¢sqlè¯­å¥çš„æ—¶å€™, MyBatis åˆæ˜¯æ€ä¹ˆç”¨ä¸Šçš„å‘¢ï¼Ÿ è¿™é‡Œç›®å‰åªè®²äº†å¦‚ä½•è§£æ.</p>
<p>è§£æå®Œäº†ï¼Œæ²¡å¼‚å¸¸ï¼Œé‚£å°±æ˜¯è§£æéƒ½okäº†ï¼Œå‰©ä¸‹çš„å°±æ˜¯çœ‹å½“ MyBatis å»æŸ¥è¯¢çš„æ—¶å€™, æ˜¯æ€ä¹ˆåˆ©ç”¨ä¸Šè¿™äº›èµ„æºçš„å‘¢ï¼Ÿæ‰€ä»¥çœ‹æ¥ä¸‹æ¥çš„æ›´æ–°.</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/11/04/mybatis/mybatis%E6%9C%AC%E5%9C%B0%E7%BC%93%E5%AD%98%E9%98%85%E8%AF%BB/">mybatisæœ¬åœ°ç¼“å­˜é˜…è¯»</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">å‘è¡¨äº</span><span class="post-meta-item__value">2021-11-04</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">æ›´æ–°äº</span><span class="post-meta-item__value">2021-11-04</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">å­—æ•°ç»Ÿè®¡</span><span class="post-meta-item__value">2.8k</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="far fa-clock"></i></span><span class="post-meta-item__info">é˜…è¯»æ—¶é•¿</span><span class="post-meta-item__value">23åˆ†</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h4 id="é¢˜è®°"   >
          <a href="#é¢˜è®°" class="heading-link"><i class="fas fa-link"></i></a><a href="#é¢˜è®°" class="headerlink" title="é¢˜è®°"></a>é¢˜è®°</h4>
      
        <h4 id="ç¼“å­˜è¿™ä¸ªçŸ¥è¯†ç‚¹åœ¨è®¸å¤šåœ°æ–¹éƒ½æœ‰çš„ï¼Œåˆ©ç”¨åˆ°å¥½çš„è¯ï¼Œå¯¹ç³»ç»Ÿçš„å¾ˆå¤šåœ°æ–¹æŸ¥è¯¢æ˜¯æœ‰å¾ˆå¤§çš„æå‡çš„-å¯ä»¥çœ‹åˆ°-MyBatis-ä¹Ÿæ˜¯æœ‰-cache-çš„ï¼Œé‚£MyBatis-æ˜¯æ€ä¹ˆåˆ©ç”¨è¿™ä¸ªç¼“å­˜çš„å‘¢ï¼Ÿ-åœ¨-INSERT-UPDATE-DELETE-SELECTä¸­-æ˜¯ä¸æ˜¯åªæœ‰SELECTçš„æ—¶å€™ç”¨åˆ°äº†ç¼“å­˜ï¼Œå¦‚æœæ˜¯-INSERT-UPDATE-DELETE-æ˜¯å¦ä¼šå¯¹ç¼“å­˜æœ‰å½±å“ï¼Ÿ"   >
          <a href="#ç¼“å­˜è¿™ä¸ªçŸ¥è¯†ç‚¹åœ¨è®¸å¤šåœ°æ–¹éƒ½æœ‰çš„ï¼Œåˆ©ç”¨åˆ°å¥½çš„è¯ï¼Œå¯¹ç³»ç»Ÿçš„å¾ˆå¤šåœ°æ–¹æŸ¥è¯¢æ˜¯æœ‰å¾ˆå¤§çš„æå‡çš„-å¯ä»¥çœ‹åˆ°-MyBatis-ä¹Ÿæ˜¯æœ‰-cache-çš„ï¼Œé‚£MyBatis-æ˜¯æ€ä¹ˆåˆ©ç”¨è¿™ä¸ªç¼“å­˜çš„å‘¢ï¼Ÿ-åœ¨-INSERT-UPDATE-DELETE-SELECTä¸­-æ˜¯ä¸æ˜¯åªæœ‰SELECTçš„æ—¶å€™ç”¨åˆ°äº†ç¼“å­˜ï¼Œå¦‚æœæ˜¯-INSERT-UPDATE-DELETE-æ˜¯å¦ä¼šå¯¹ç¼“å­˜æœ‰å½±å“ï¼Ÿ" class="heading-link"><i class="fas fa-link"></i></a><a href="#ç¼“å­˜è¿™ä¸ªçŸ¥è¯†ç‚¹åœ¨è®¸å¤šåœ°æ–¹éƒ½æœ‰çš„ï¼Œåˆ©ç”¨åˆ°å¥½çš„è¯ï¼Œå¯¹ç³»ç»Ÿçš„å¾ˆå¤šåœ°æ–¹æŸ¥è¯¢æ˜¯æœ‰å¾ˆå¤§çš„æå‡çš„-å¯ä»¥çœ‹åˆ°-MyBatis-ä¹Ÿæ˜¯æœ‰-cache-çš„ï¼Œé‚£MyBatis-æ˜¯æ€ä¹ˆåˆ©ç”¨è¿™ä¸ªç¼“å­˜çš„å‘¢ï¼Ÿ-åœ¨-INSERT-UPDATE-DELETE-SELECTä¸­-æ˜¯ä¸æ˜¯åªæœ‰SELECTçš„æ—¶å€™ç”¨åˆ°äº†ç¼“å­˜ï¼Œå¦‚æœæ˜¯-INSERT-UPDATE-DELETE-æ˜¯å¦ä¼šå¯¹ç¼“å­˜æœ‰å½±å“ï¼Ÿ" class="headerlink" title="ç¼“å­˜è¿™ä¸ªçŸ¥è¯†ç‚¹åœ¨è®¸å¤šåœ°æ–¹éƒ½æœ‰çš„ï¼Œåˆ©ç”¨åˆ°å¥½çš„è¯ï¼Œå¯¹ç³»ç»Ÿçš„å¾ˆå¤šåœ°æ–¹æŸ¥è¯¢æ˜¯æœ‰å¾ˆå¤§çš„æå‡çš„. å¯ä»¥çœ‹åˆ°,MyBatis ä¹Ÿæ˜¯æœ‰ cache çš„ï¼Œé‚£MyBatis æ˜¯æ€ä¹ˆåˆ©ç”¨è¿™ä¸ªç¼“å­˜çš„å‘¢ï¼Ÿ åœ¨ INSERT/UPDATE/DELETE/SELECTä¸­,æ˜¯ä¸æ˜¯åªæœ‰SELECTçš„æ—¶å€™ç”¨åˆ°äº†ç¼“å­˜ï¼Œå¦‚æœæ˜¯ INSERT/UPDATE/DELETE æ˜¯å¦ä¼šå¯¹ç¼“å­˜æœ‰å½±å“ï¼Ÿ"></a>ç¼“å­˜è¿™ä¸ªçŸ¥è¯†ç‚¹åœ¨è®¸å¤šåœ°æ–¹éƒ½æœ‰çš„ï¼Œåˆ©ç”¨åˆ°å¥½çš„è¯ï¼Œå¯¹ç³»ç»Ÿçš„å¾ˆå¤šåœ°æ–¹æŸ¥è¯¢æ˜¯æœ‰å¾ˆå¤§çš„æå‡çš„. å¯ä»¥çœ‹åˆ°,MyBatis ä¹Ÿæ˜¯æœ‰ cache çš„ï¼Œé‚£MyBatis æ˜¯æ€ä¹ˆåˆ©ç”¨è¿™ä¸ªç¼“å­˜çš„å‘¢ï¼Ÿ åœ¨ INSERT/UPDATE/DELETE/SELECTä¸­,æ˜¯ä¸æ˜¯åªæœ‰SELECTçš„æ—¶å€™ç”¨åˆ°äº†ç¼“å­˜ï¼Œå¦‚æœæ˜¯ INSERT/UPDATE/DELETE æ˜¯å¦ä¼šå¯¹ç¼“å­˜æœ‰å½±å“ï¼Ÿ</h4>
      <p> å¯ä»¥çœ‹ç»“æœæ¥åˆ†æï¼Œç„¶åè·Ÿè¿›æºç æ¥ä»”ç»†åˆ†æ.</p>
<p> MyBatis æ˜¯åˆ†ä¸º ä¸€çº§ç¼“å­˜ å’Œ äºŒçº§ç¼“å­˜çš„. é‚£ä¹ˆï¼Œæˆ‘ä»¬å°±å…ˆä»ä¸€çº§ç¼“å­˜å¼€å§‹.</p>

        <h4 id="ä¸€çº§ç¼“å­˜"   >
          <a href="#ä¸€çº§ç¼“å­˜" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¸€çº§ç¼“å­˜" class="headerlink" title="ä¸€çº§ç¼“å­˜"></a>ä¸€çº§ç¼“å­˜</h4>
      <p> æ¡ˆä¾‹ä»£ç  :</p>
<p> è¿™é‡Œæˆ‘ä»¬æ˜¯æ‰“å°çš„æŸ¥è¯¢sqlçš„è¯­å¥ï¼Œå†ç¬¬äºŒæ¬¡å†æŸ¥è¯¢çš„æ—¶å€™ï¼Œæ˜¯</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">InputStream mybatisInputStream = Resources.getResourceAsStream(&quot;mybatis-config.xml&quot;);</span><br><span class="line"></span><br><span class="line">SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(mybatisInputStream);</span><br><span class="line">SqlSession session = sqlSessionFactory.openSession();</span><br><span class="line">BlogMapper blogMapper = session.getMapper(BlogMapper.class);</span><br><span class="line">TbBlog tbBlog = blogMapper.selectBlog(1);</span><br><span class="line">System.out.println(blogMapper.selectBlog(1));</span><br><span class="line">System.out.println(tbBlog);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// ç»“æœå¯ä»¥çœ‹åˆ°,ç¬¬äºŒæ¬¡å¹¶æ²¡æœ‰å†æ‰“å°å‡º sql è¯­å¥æ¥.</span><br><span class="line">==&gt;  Preparing: select * from tb_blog where id = ? </span><br><span class="line">==&gt; Parameters: 1(Integer)</span><br><span class="line">&lt;==    Columns: id, name</span><br><span class="line">&lt;==        Row: 1, 6565</span><br><span class="line">&lt;==      Total: 1</span><br><span class="line">TbBlog&#123;id=1, name=&#x27;6565&#x27;&#125;</span><br><span class="line">TbBlog&#123;id=1, name=&#x27;6565&#x27;&#125;</span><br></pre></td></tr></table></div></figure>

<p>æ¡ˆä¾‹äºŒ : æˆ‘ä»¬å†ç¬¬äºŒæ¬¡æŸ¥è¯¢ä¹‹å‰ åŠ å…¥ ä¸€ä¸ªadd æ–¹æ³•</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">InputStream mybatisInputStream = Resources.getResourceAsStream(&quot;mybatis-config.xml&quot;);</span><br><span class="line"></span><br><span class="line">SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(mybatisInputStream);</span><br><span class="line">SqlSession session = sqlSessionFactory.openSession();</span><br><span class="line">BlogMapper blogMapper = session.getMapper(BlogMapper.class);</span><br><span class="line">TbBlog tbBlog = blogMapper.selectBlog(1);</span><br><span class="line"></span><br><span class="line">System.out.println(blogMapper.addBlog(&quot;GavinYang&quot;));</span><br><span class="line">System.out.println(blogMapper.selectBlog(1));</span><br><span class="line">System.out.println(tbBlog);</span><br><span class="line"></span><br><span class="line">// çœ‹ç»“æœ,å¯ä»¥çœ‹åˆ°å½“ä¸­é—´ç©¿æ’ä¸€ä¸ª insert çš„sqlè¯­å¥,é‚£ä¹ˆåœ¨ç¬¬äºŒæ¬¡æŸ¥è¯¢çš„æ—¶å€™,å°±ä¼šæ‰§è¡Œsqlè¯­å¥.</span><br><span class="line">// é‚£ä¹ˆä¹Ÿå°±è¯´ï¼Œè¿™ä¸ªæ—¶å€™ç¼“å­˜æ˜¯å¤±æ•ˆäº†.</span><br><span class="line">==&gt;  Preparing: select * from tb_blog where id = ? </span><br><span class="line">==&gt; Parameters: 1(Integer)</span><br><span class="line">&lt;==    Columns: id, name</span><br><span class="line">&lt;==        Row: 1, 6565</span><br><span class="line">&lt;==      Total: 1</span><br><span class="line">==&gt;  Preparing: insert into tb_blog (name) values(?) </span><br><span class="line">==&gt; Parameters: GavinYang(String)</span><br><span class="line">&lt;==    Updates: 1</span><br><span class="line">1</span><br><span class="line">==&gt;  Preparing: select * from tb_blog where id = ? </span><br><span class="line">==&gt; Parameters: 1(Integer)</span><br><span class="line">&lt;==    Columns: id, name</span><br><span class="line">&lt;==        Row: 1, 6565</span><br><span class="line">&lt;==      Total: 1</span><br><span class="line">TbBlog&#123;id=1, name=&#x27;6565&#x27;&#125;</span><br><span class="line">TbBlog&#123;id=1, name=&#x27;6565&#x27;&#125;</span><br></pre></td></tr></table></div></figure>

<p>æ¡ˆä¾‹ä¸‰ : ä½¿ç”¨äºŒä¸ª SqlSession æ¡ˆä¾‹</p>
<p>å¯ä»¥å¾ˆæ˜æ˜¾çš„çœ‹åˆ° , åœ¨ç¬¬äºŒæ¬¡çš„æ—¶å€™è¿˜å‡ºç°äº†è„æ•°æ®.</p>
<p>è¿™é‡Œä¹Ÿå¯ä»¥çœ‹åˆ°ä¸€çº§ç¼“å­˜æ˜¯åªåœ¨ SqlSession ä¸­å­˜åœ¨çš„,ä¹Ÿå°±æ˜¯æ•°æ®åº“ä¼šè¯å†…éƒ¨å…±äº«çš„.</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">InputStream mybatisInputStream = Resources.getResourceAsStream(&quot;mybatis-config.xml&quot;);</span><br><span class="line">SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(mybatisInputStream);</span><br><span class="line"></span><br><span class="line">SqlSession openSession1 = sqlSessionFactory.openSession();</span><br><span class="line">SqlSession openSession2 = sqlSessionFactory.openSession();</span><br><span class="line">BlogMapper blogMapper1 = openSession1.getMapper(BlogMapper.class);</span><br><span class="line">BlogMapper blogMapper2 = openSession2.getMapper(BlogMapper.class);</span><br><span class="line"></span><br><span class="line">System.out.println(&quot;blogMapper1 è¯»å–æ•°æ® &quot; + blogMapper1.selectBlog(1));</span><br><span class="line">System.out.println(&quot;blogMapper2 è¯»å–æ•°æ®&quot; + blogMapper2.selectBlog(1));</span><br><span class="line"></span><br><span class="line">System.out.println(blogMapper1.updateHashCode(&quot;PeterWong&quot;));</span><br><span class="line"></span><br><span class="line">System.out.println(&quot;blogMapper1 è¯»å–æ•°æ® &quot; + blogMapper1.selectBlog(1));</span><br><span class="line">System.out.println(&quot;blogMapper2 è¯»å–æ•°æ®&quot; + blogMapper2.selectBlog(1));</span><br><span class="line"></span><br><span class="line">// ç„¶åæˆ‘ä»¬å¯ä»¥çœ‹åˆ° log æ‰“å°å‡ºæ¥çš„å†…å®¹</span><br><span class="line">==&gt;  Preparing: select * from tb_blog where id = ? </span><br><span class="line">==&gt; Parameters: 1(Integer)</span><br><span class="line">&lt;==    Columns: id, name</span><br><span class="line">&lt;==        Row: 1, 6565</span><br><span class="line">&lt;==      Total: 1</span><br><span class="line">blogMapper1 è¯»å–æ•°æ® TbBlog&#123;id=1, name=&#x27;6565&#x27;&#125;</span><br><span class="line">Created connection 433287555.</span><br><span class="line">Setting autocommit to false on JDBC Connection [com.mysql.jdbc.JDBC4Connection@19d37183]</span><br><span class="line">==&gt;  Preparing: select * from tb_blog where id = ? </span><br><span class="line">==&gt; Parameters: 1(Integer)</span><br><span class="line">&lt;==    Columns: id, name</span><br><span class="line">&lt;==        Row: 1, 6565</span><br><span class="line">&lt;==      Total: 1</span><br><span class="line">blogMapper2 è¯»å–æ•°æ®TbBlog&#123;id=1, name=&#x27;6565&#x27;&#125;</span><br><span class="line">==&gt;  Preparing: update tb_blog set name = ? where id = 1; </span><br><span class="line">==&gt; Parameters: PeterWong(String)</span><br><span class="line">&lt;==    Updates: 1</span><br><span class="line">1</span><br><span class="line">==&gt;  Preparing: select * from tb_blog where id = ? </span><br><span class="line">==&gt; Parameters: 1(Integer)</span><br><span class="line">&lt;==    Columns: id, name</span><br><span class="line">&lt;==        Row: 1, PeterWong</span><br><span class="line">&lt;==      Total: 1</span><br><span class="line">blogMapper1 è¯»å–æ•°æ® TbBlog&#123;id=1, name=&#x27;PeterWong&#x27;&#125;</span><br><span class="line">blogMapper2 è¯»å–æ•°æ®TbBlog&#123;id=1, name=&#x27;6565&#x27;&#125;</span><br></pre></td></tr></table></div></figure>

<p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬è¯´äº†ä¸‰é¢çš„è¿™ä¸‰ç§æƒ…å†µ, å…·ä½“çš„æ‰§è¡Œæµç¨‹å¯ä»¥æˆ‘ä»¬å¯ä»¥ç°åœ¨ æ¡ˆä¾‹ä¸€é‡Œé¢å¯¹ç¬¬äºŒæ¬¡ query è¿›è¡Œ debug åˆ†ææ“ä½œ. å½“æˆ‘ä»¬debugåˆ° org.apache.ibatis.executor.BaseExecutor#query(org.apache.ibatis.mapping.MappedStatement, java.lang.Object, org.apache.ibatis.session.RowBounds, org.apache.ibatis.session.ResultHandler, org.apache.ibatis.cache.CacheKey, org.apache.ibatis.mapping.BoundSql) çš„æ—¶å€™ï¼Œå¯ä»¥çœ‹åˆ° org.apache.ibatis.executor.BaseExecutor#localCache åªæœ‰ä¸€ä¸ª ç¼“å­˜çš„å€¼çš„ ï¼Œ æ ¹æ® getObject æ–¹æ³•å¯ä»¥è·Ÿè¿›åˆ° org.apache.ibatis.cache.impl.PerpetualCache#cache ä¸­æ¥,</p>
<p>ä¼ å…¥è¿›æ¥çš„ key å€¼æ˜¯ : -1896651191:1062027004:com.iyang.mybatis.mapper.BlogMapper.selectBlog:0:2147483647:select * from tb_blog where id = ?:1:development ç„¶åä» cache ä¸­è·å–å‡ºå€¼æ¥, æ‰€ä»¥è¿™é‡Œå°±æ²¡æœ‰èµ° query çš„æŸ¥è¯¢è¯­å¥.</p>
<p>è¿™æ˜¯å‘½ä¸­ç¼“å­˜çš„æƒ…å†µ.</p>
<p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸‹, åœ¨ç¬¬äºŒæ¬¡ query ä¹‹å‰å¦‚æœæ‰§è¡Œäº†ä¸€ä¸ª add æ–¹æ³•ï¼Œä¸ºä»€ä¹ˆå°±å‘½ä¸­ä¸äº†äº†å‘¢ï¼Ÿ</p>
<p>è¿™é‡Œå¯ä»¥å¤§è‡´çŒœæµ‹ä¸‹ï¼Œåœ¨æ‰§è¡Œå®Œ add æ–¹æ³•åï¼Œæ˜¯ä¸æ˜¯ç»™ cache ç»™æ¸…é™¤æ‰äº†ï¼Œç„¶åå†å»æŸ¥è¯¢çš„æ—¶å€™ï¼Œå°±æŸ¥è¯¢ä¸åˆ°äº†.</p>
<p>äºæ˜¯æˆ‘ä»¬åœ¨ add æ–¹æ³•ä¸Šè¿›è¡Œ debug æŸ¥çœ‹ä¸‹ :</p>
<p>æœ€åæˆ‘ä»¬ debug è·Ÿè¿›åˆ°è¿™é‡Œ : org.apache.ibatis.executor.BaseExecutor#clearLocalCache å°±å¯ä»¥å‘ç°</p>
<p>è¿™é‡Œæ˜¯æœ‰äºŒä¸ª clear æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯æ¸…é™¤æ–¹æ³•.</p>
<p>localCache.clear() â€”-&gt; org.apache.ibatis.cache.impl.PerpetualCache#clear å¯¹åº”çš„å°±æ˜¯è¿™é‡Œçš„æ¸…æ¥šæ–¹æ³•ï¼Œç›´æ¥è°ƒç”¨ HashMap çš„clear æ–¹æ³•è¿›è¡Œæ¸…é™¤.</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">localCache.clear();</span><br><span class="line">localOutputParameterCache.clear();</span><br></pre></td></tr></table></div></figure>

<p>æ‰€ä»¥è¿™é‡Œå¯ä»¥çœ‹å‡ºåœ¨ç¬¬äºŒæ¬¡è°ƒç”¨ query ä¹‹å‰ï¼Œå¦‚æœæ˜¯æœ‰ insert/update/delete ç­‰æ–¹æ³•çš„è¯ï¼Œå°±ä¼šå»é‡ç½®è¿™äºŒä¸ªåœ°æ–¹çš„ç¼“å­˜çš„.</p>
<p>MyBatis çš„ä¸€çº§ç¼“å­˜çš„æ˜¯è·Ÿéš SqlSession çš„ï¼Œè¿™é‡Œæ˜¯å¯ä»¥æ ¹æ®ç®€å•çš„æ¡ˆä¾‹æ•ˆæœçœ‹å‡ºæ¥çš„.</p>
<p>ä¸€çº§ç¼“å­˜åªæ˜¯ä½¿ç”¨äº†ä¸€ä¸ª HashMap , æœ€åæ¸…é™¤ç¼“å­˜çš„æ—¶å€™ï¼Œä¹Ÿæ˜¯è°ƒç”¨ HashMap çš„clear æ–¹æ³•</p>
<p>æœ€åä»æ¡ˆä¾‹ä¸‰å¯ä»¥çœ‹å‡ºæ¥ï¼Œå½“å¤šä¸ª SqlSession çš„æ—¶å€™ï¼Œç”±äºå„è‡ªæœ‰å­˜æœ‰å„è‡ªçš„ç¼“å­˜ï¼Œæ‰€ä»¥æ˜¯å¾ˆå®¹æ˜“å¼•èµ·è„æ•°æ®çš„, å°†ç¼“å­˜çº§åˆ«è®¾ç½®ä¸º Statement.</p>

        <h4 id="äºŒçº§ç¼“å­˜"   >
          <a href="#äºŒçº§ç¼“å­˜" class="heading-link"><i class="fas fa-link"></i></a><a href="#äºŒçº§ç¼“å­˜" class="headerlink" title="äºŒçº§ç¼“å­˜"></a>äºŒçº§ç¼“å­˜</h4>
      <p> å¯ä»¥çœ‹åˆ°ä¸€çº§ç¼“å­˜çš„è¯ï¼Œæ˜¯å±€é™äº SqlSession . å¦‚æœè¦å¤šä¸ª sqlSession ä¹‹é—´å…±äº«ç¼“å­˜çš„è¯ï¼Œå°±éœ€è¦å¼€å¯äºŒçº§ç¼“å­˜. å¼€å¯çš„è¯,æˆ‘ä»¬åœ¨ MyBatis é…ç½®æ–‡ä»¶ä¸­åŠ ä¸Š:</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;settings&gt;</span><br><span class="line">    &lt;setting name=&quot;logImpl&quot; value=&quot;STDOUT_LOGGING&quot;/&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- å¼€å¯äºŒçº§ç¼“å­˜ --&gt;</span><br><span class="line">    &lt;setting name=&quot;cacheEnabled&quot; value=&quot;true&quot;/&gt;</span><br><span class="line">&lt;/settings&gt;</span><br></pre></td></tr></table></div></figure>

<p> <strong>æ¡ˆä¾‹ä¸€ : æ˜¯å¦æäº¤äº‹åŠ¡</strong></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String[] args) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">    InputStream mybatisInputStream = Resources.getResourceAsStream(&quot;mybatis-config.xml&quot;);</span><br><span class="line">    SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(mybatisInputStream);</span><br><span class="line">    SqlSession sqlSession1 = sqlSessionFactory.openSession(true);</span><br><span class="line">    SqlSession sqlSession2 = sqlSessionFactory.openSession(true);</span><br><span class="line"></span><br><span class="line">    BlogMapper blogMapper1 = sqlSession1.getMapper(BlogMapper.class);</span><br><span class="line">    BlogMapper blogMapper2 = sqlSession2.getMapper(BlogMapper.class);</span><br><span class="line"></span><br><span class="line">    System.out.println(&quot;blogMapper1 è·å–æ•°æ®&quot; + blogMapper1.selectBlog(1));</span><br><span class="line">    </span><br><span class="line">    // sqlSession1.commit();</span><br><span class="line">    </span><br><span class="line">    System.out.println(&quot;blogMapper2 è·å–æ•°æ®&quot; + blogMapper2.selectBlog(1));</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//   ----------------   trueç»“æœ   -----------------------</span><br><span class="line"></span><br><span class="line">Created connection 492079624.</span><br><span class="line">==&gt;  Preparing: select * from tb_blog where id = ? </span><br><span class="line">==&gt; Parameters: 1(Integer)</span><br><span class="line">&lt;==    Columns: id, name</span><br><span class="line">&lt;==        Row: 1, 6565</span><br><span class="line">&lt;==      Total: 1</span><br><span class="line">blogMapper1 è·å–æ•°æ®TbBlog&#123;id=1, name=&#x27;6565&#x27;&#125;</span><br><span class="line">Opening JDBC Connection</span><br><span class="line">    </span><br><span class="line">Created connection 433287555.</span><br><span class="line">==&gt;  Preparing: select * from tb_blog where id = ? </span><br><span class="line">==&gt; Parameters: 1(Integer)</span><br><span class="line">&lt;==    Columns: id, name</span><br><span class="line">&lt;==        Row: 1, 6565</span><br><span class="line">&lt;==      Total: 1</span><br><span class="line">blogMapper2 è·å–æ•°æ®TbBlog&#123;id=1, name=&#x27;6565&#x27;&#125;    </span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">// ------------   åŠ ä¸Šcommit()æ–¹æ³•ç»“æœ   ---------------</span><br><span class="line"></span><br><span class="line">Created connection 630074945.</span><br><span class="line">==&gt;  Preparing: select * from tb_blog where id = ? </span><br><span class="line">==&gt; Parameters: 1(Integer)</span><br><span class="line">&lt;==    Columns: id, name</span><br><span class="line">&lt;==        Row: 1, 6565</span><br><span class="line">&lt;==      Total: 1</span><br><span class="line">blogMapper1 è·å–æ•°æ®TbBlog&#123;id=1, name=&#x27;6565&#x27;&#125;</span><br><span class="line">Cache Hit Ratio [com.iyang.mybatis.mapper.BlogMapper]: 0.5</span><br><span class="line">blogMapper2 è·å–æ•°æ®TbBlog&#123;id=1, name=&#x27;6565&#x27;&#125;</span><br></pre></td></tr></table></div></figure>

<p> ä»è¿™é‡Œçœ‹, æ˜¯å¦æäº¤äº‹åŠ¡å¯ä»¥çœ‹å‡ºæ¥ï¼Œæ˜¯ä¼šå½±å“äºŒçº§ç¼“å­˜çš„.</p>
<p><strong>æ¡ˆä¾‹äºŒ : ä¸­é—´ç©¿æ’æ›´æ–°è¯­å¥</strong></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String[] args)  throws Exception &#123;</span><br><span class="line"></span><br><span class="line">    InputStream mybatisInputStream = Resources.getResourceAsStream(&quot;mybatis-config.xml&quot;);</span><br><span class="line">    SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(mybatisInputStream);</span><br><span class="line">    SqlSession sqlSession1 = sqlSessionFactory.openSession(false);</span><br><span class="line">    SqlSession sqlSession2 = sqlSessionFactory.openSession(false);</span><br><span class="line">    SqlSession sqlSession3 = sqlSessionFactory.openSession(false);</span><br><span class="line"></span><br><span class="line">    BlogMapper blogMapper1 = sqlSession1.getMapper(BlogMapper.class);</span><br><span class="line">    BlogMapper blogMapper2 = sqlSession2.getMapper(BlogMapper.class);</span><br><span class="line">    BlogMapper blogMapper3 = sqlSession3.getMapper(BlogMapper.class);</span><br><span class="line"></span><br><span class="line">    System.out.println(&quot; blogMapper1 æŸ¥è¯¢å‡ºæ¥çš„æ•°æ® : &quot; + blogMapper1.selectBlog(1));</span><br><span class="line">    sqlSession1.commit();</span><br><span class="line"></span><br><span class="line">    System.out.println(&quot; blogMapper2 æŸ¥è¯¢å‡ºæ¥çš„ç»“æœ : &quot; + blogMapper2.selectBlog(1));</span><br><span class="line"></span><br><span class="line">    System.out.println(blogMapper3.updateHashCode(&quot;GavinYang&quot;));</span><br><span class="line">    sqlSession3.commit();</span><br><span class="line"></span><br><span class="line">    System.out.println(&quot; blogMapper2 æŸ¥è¯¢å‡ºæ¥çš„ç»“æœ : &quot; + blogMapper2.selectBlog(1));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//  ------------------  æ‰“å°ç»“æœ ------</span><br><span class="line"></span><br><span class="line">Created connection 630074945.</span><br><span class="line">Setting autocommit to false on JDBC Connection [com.mysql.jdbc.JDBC4Connection@258e2e41]</span><br><span class="line">==&gt;  Preparing: select * from tb_blog where id = ? </span><br><span class="line">==&gt; Parameters: 1(Integer)</span><br><span class="line">&lt;==    Columns: id, name</span><br><span class="line">&lt;==        Row: 1, 6565</span><br><span class="line">&lt;==      Total: 1</span><br><span class="line"> blogMapper1 æŸ¥è¯¢å‡ºæ¥çš„æ•°æ® : TbBlog&#123;id=1, name=&#x27;6565&#x27;&#125;</span><br><span class="line">Cache Hit Ratio [com.iyang.mybatis.mapper.BlogMapper]: 0.5</span><br><span class="line"> blogMapper2 æŸ¥è¯¢å‡ºæ¥çš„ç»“æœ : TbBlog&#123;id=1, name=&#x27;6565&#x27;&#125;</span><br><span class="line"></span><br><span class="line">Created connection 603443293.</span><br><span class="line">Setting autocommit to false on JDBC Connection [com.mysql.jdbc.JDBC4Connection@23f7d05d]</span><br><span class="line">==&gt;  Preparing: update tb_blog set name = ? where id = 1; </span><br><span class="line">==&gt; Parameters: GavinYang(String)</span><br><span class="line">&lt;==    Updates: 1</span><br><span class="line">1</span><br><span class="line">Committing JDBC Connection [com.mysql.jdbc.JDBC4Connection@23f7d05d]</span><br><span class="line">Cache Hit Ratio [com.iyang.mybatis.mapper.BlogMapper]: 0.3333333333333333</span><br><span class="line">Opening JDBC Connection</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">Created connection 707976812.</span><br><span class="line">Setting autocommit to false on JDBC Connection [com.mysql.jdbc.JDBC4Connection@2a32de6c]</span><br><span class="line">==&gt;  Preparing: select * from tb_blog where id = ? </span><br><span class="line">==&gt; Parameters: 1(Integer)</span><br><span class="line">&lt;==    Columns: id, name</span><br><span class="line">&lt;==        Row: 1, GavinYang</span><br><span class="line">&lt;==      Total: 1</span><br><span class="line"> blogMapper2 æŸ¥è¯¢å‡ºæ¥çš„ç»“æœ : TbBlog&#123;id=1, name=&#x27;GavinYang&#x27;&#125;</span><br></pre></td></tr></table></div></figure>

<p>è¿™é‡Œæ˜¯å¯ä»¥çœ‹åˆ°åœ¨æ›´æ–°ä¹‹åå¹¶ä¸” commit äº†äº‹åŠ¡ä¹‹åï¼Œåé¢ç´§è·Ÿçš„ sql æ˜¯å»æŸ¥è¯¢ æ•°æ®åº“äº†çš„. æ‰€ä»¥è¿™é‡Œæ˜¯å¯ä»¥çœ‹å‡ºæ¥ï¼Œupdateç­‰æ“ä½œæ˜¯ä¼šå» æ¸…ç©ºå¯¹åº”çš„ç¼“å­˜çš„ã€‚</p>
<p>è¿™é‡Œæˆ‘ä»¬æ ¹æ® æ¡ˆä¾‹ä¸€ çš„æƒ…å†µæ¥åˆ†æï¼Œåœ¨å¼€å¯äº† äºŒçº§ç¼“å­˜ çš„æ—¶å€™ï¼Œæ˜¯ä»å“ªé‡Œè·å–å‡ºæ¥çš„æ•°æ®çš„å‘¢ï¼Ÿ</p>
<p>debug è·Ÿè¿›æ¥ : org.apache.ibatis.executor.CachingExecutor#query(org.apache.ibatis.mapping.MappedStatement, java.lang.Object, org.apache.ibatis.session.RowBounds, org.apache.ibatis.session.ResultHandler, org.apache.ibatis.cache.CacheKey, org.apache.ibatis.mapping.BoundSql)</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public &lt;E&gt; List&lt;E&gt; query(MappedStatement ms, Object parameterObject, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql)</span><br><span class="line">    throws SQLException &#123;</span><br><span class="line">  Cache cache = ms.getCache();</span><br><span class="line">  if (cache != null) &#123;</span><br><span class="line">    flushCacheIfRequired(ms);</span><br><span class="line">    if (ms.isUseCache() &amp;&amp; resultHandler == null) &#123;</span><br><span class="line">      ensureNoOutParams(ms, boundSql);</span><br><span class="line">      @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">// debug åˆ°è¿™é‡Œï¼Œå¯ä»¥çœ‹åˆ°,å°±å·²ç»è¿”å›äº†æˆ‘ä»¬éœ€è¦çš„æ•°æ®.        </span><br><span class="line">      List&lt;E&gt; list = (List&lt;E&gt;) tcm.getObject(cache, key);</span><br><span class="line">      if (list == null) &#123;</span><br><span class="line">        list = delegate.query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);</span><br><span class="line">        tcm.putObject(cache, key, list); // issue #578 and #116</span><br><span class="line">      &#125;</span><br><span class="line">      return list;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return delegate.query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>org.apache.ibatis.executor.CachingExecutor#tcm è°ƒç”¨è¿™ä¸ªå¯¹è±¡çš„ getObject æ–¹æ³•è·å–åˆ°äº†æˆ‘ä»¬éœ€è¦çš„å€¼, è·Ÿè¿›æ¥åˆä» org.apache.ibatis.cache.decorators.TransactionalCache çš„ getObject è·å–å‡ºæˆ‘ä»¬çš„å€¼, æœ€åä» org.apache.ibatis.cache.decorators.TransactionalCache#delegate è·å–å‡ºå€¼, è¿”å›å›æ¥çš„.</p>
<p>org.apache.ibatis.cache.decorators.TransactionalCache#getObject</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Object getObject(Object key) &#123;</span><br><span class="line">  // issue #116</span><br><span class="line">// ä»ç¼“å­˜ä¸­è·å–å‡ºå€¼.    </span><br><span class="line">  Object object = delegate.getObject(key);</span><br><span class="line">  if (object == null) &#123;</span><br><span class="line">// å¦‚æœè·å–å‡ºæ¥æ˜¯null,ä¹Ÿå°±æ˜¯ç¼“å­˜ä¸­æ²¡æœ‰çš„è¯,org.apache.ibatis.cache.decorators.TransactionalCache#entriesMissedInCache å°±æ·»åŠ åˆ°è¿™ä¸ªé›†åˆä¸­æ¥.      </span><br><span class="line">    entriesMissedInCache.add(key);</span><br><span class="line">  &#125;</span><br><span class="line">  // issue #146</span><br><span class="line">// commit åéœ€è¦ clear çš„è¯ï¼Œå°±ä¼šè¿”å› null.</span><br><span class="line">// è¿™é‡Œæƒ³ä¸‹è¿™ä¸ªå˜é‡ä¼šä¸ä¼šå’Œæˆ‘é—¨æ¡ˆä¾‹äºŒä¸­çš„ update æ“ä½œæœ‰å…³ç³»å‘¢ï¼Ÿ</span><br><span class="line">// è¿™é‡Œå† updateåå† debug å‘ç°,  delegate ä¸­è·å–å‡ºæ¥çš„æ˜¯ null ,ä¹Ÿå°±æ˜¯ç¡®å®æ˜¯è·å–ä¸åˆ°ç¼“å­˜äº†</span><br><span class="line">// å’Œè¿™ä¸ªå‚æ•°æ²¡å…³ç³».    </span><br><span class="line">  if (clearOnCommit) &#123;</span><br><span class="line">    return null;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    return object;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>MyBatis äºŒçº§ç¼“å­˜ä¸é€‚åº”äºé…ç½®æ–‡ä»¶ä¸­å­˜åœ¨å¤šè¡¨æŸ¥è¯¢çš„æƒ…å†µ. ä¸€èˆ¬æˆ‘ä»¬æ˜¯å•è¡¨çš„ cache, ç”±äº mybatis çš„äºŒçº§ç¼“å­˜æ˜¯åŸºäº namespace çš„, å¤šè¡¨æŸ¥è¯¢è¯­å¥æ‰€åœ¨çš„ namespace æ— æ³•æ„Ÿåº”åˆ°å…¶ä»–çš„ namespace ä¸­çš„è¯­å¥å¯¹å¤šè¡¨ä¸­è®¾è®¡ä¿®æ”¹ï¼Œå°±ä¼šå¼•å‘è„æ•°æ®. è¿™ä¸ªæ—¶å€™ï¼Œå¯ä»¥é‡‡ç”¨ cache-ref æ¥åšå¤„ç†ï¼Œä½†æ˜¯è¿™æ ·çš„è¯,ç¼“å­˜çš„é¢—ç²’åº¦å°±å˜ç²—äº†.</p>
<p>æ‰§è¡Œæµç¨‹ : å¦‚æœå¼€å¯äº†äºŒçº§ç¼“å­˜çš„è¯ï¼Œ MyBatis ä¼šå…ˆèµ°äºŒçº§ç¼“å­˜ï¼Œå¦‚æœäºŒçº§ç¼“å­˜æ²¡æœ‰çš„è¯ï¼Œå°±ä¼šå»ä¸€çº§ç¼“å­˜çœ‹çœ‹ï¼Œå¦‚æœéƒ½æ²¡æœ‰çš„è¯ï¼Œå°±å»æŸ¥è¯¢æ•°æ®åº“.</p>
<p>äºŒçº§ç¼“å­˜ : ç”¨ org.apache.ibatis.executor.CachingExecutor è£…é¥°äº† org.apache.ibatis.executor.BaseExecutor çš„å­ç±», å§”æ‰˜å…·ä½“èŒè´£ç»™ delegate ä¹‹å‰ï¼Œå®ç°äº†äºŒçº§ç¼“å­˜çš„æŸ¥è¯¢å’Œå†™å…¥åŠŸèƒ½.</p>

        <h4 id="æ€»ç»“"   >
          <a href="#æ€»ç»“" class="heading-link"><i class="fas fa-link"></i></a><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4>
      <p>æœ€åçœ‹ ä¸€çº§ç¼“å­˜å’ŒäºŒçº§ç¼“å­˜ï¼Œéƒ½æ˜¯åˆ©ç”¨çš„ HashMap è¿™ç§æ¥åšåˆ°æœ¬åœ°ç¼“å­˜ï¼Œ åªæ˜¯äºŒçº§ç¼“å­˜çš„ä½œç”¨èŒƒå›´æ¯”èµ·ä¸€çº§ç¼“å­˜çš„è¯ï¼Œæ˜¯è¦å¤§çš„ï¼Œå¹¶ä¸”ä¹Ÿåˆ©ç”¨äº†ä¸€äº› è£…é¥°è€… ç­‰è®¾è®¡æ¨¡å¼æ¥è®¾è®¡äºŒçº§ç¼“å­˜çš„.</p>
<p>å¦‚æœæ˜¯éƒ¨ç½²çš„åˆ†å¸ƒå¼é¡¹ç›®çš„è¯ï¼Œé‚£ä¹ˆè¿˜æ˜¯ å¾—åˆ‡æ¢åˆ° redis è¿™ç§ç¼“å­˜æ¥äº†ï¼Œ æœ¬åœ°åˆ©ç”¨ HashMap è¿™ç§ç¼“å­˜æ»¡è¶³ä¸äº†çš„.</p>
<p>æ–‡çŒ®å‚è€ƒåœ°å€ : <span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://tech.meituan.com/2018/01/19/mybatis-cache.html" >https://tech.meituan.com/2018/01/19/mybatis-cache.html</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/11/04/mybatis/mybatis%E4%B8%ADconfig-xml%E4%BB%A3%E7%A0%81%E9%98%85%E8%AF%BB/">mybatisä¸­config-xmlä»£ç é˜…è¯»</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">å‘è¡¨äº</span><span class="post-meta-item__value">2021-11-04</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">æ›´æ–°äº</span><span class="post-meta-item__value">2021-11-04</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">å­—æ•°ç»Ÿè®¡</span><span class="post-meta-item__value">4.1k</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="far fa-clock"></i></span><span class="post-meta-item__info">é˜…è¯»æ—¶é•¿</span><span class="post-meta-item__value">34åˆ†</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h4 id="é¢˜è®°"   >
          <a href="#é¢˜è®°" class="heading-link"><i class="fas fa-link"></i></a><a href="#é¢˜è®°" class="headerlink" title="é¢˜è®°"></a>é¢˜è®°</h4>
      <p>å¯¹äºé…ç½®æ–‡ä»¶çš„è§£æ, è¿˜æ˜¯ç›¸å¯¹æ¯”è¾ƒå¥½ç†è§£çš„, å°±æ˜¯è¯»å–é…ç½®æ–‡ä»¶, ç„¶ååœ¨ä»£ç éœ€è¦çš„åœ°æ–¹ç»™ä½¿ç”¨åˆ°.</p>
<p>è¿™é‡Œ,å¯ä»¥æ‰©å±•ä¸‹, Spring / SpringBoot ç­‰æ˜¯æ€ä¹ˆè¯»å–é…ç½®æ–‡ä»¶å‘¢ ? å¹¶ä¸”é…ç½®æ–‡ä»¶è¿˜æ˜¯æœ‰ xml / properties/yaml ç­‰æ ¼å¼çš„ ï¼Œ å…¶è¯»å–ä»£ç æ˜¯æ€ä¹ˆå†™çš„ ? ç„¶ååŸºäº é˜¿æ³¢ç½—(æºç¨‹å¼€æº) çš„é…ç½®ä¸­å¿ƒ , å…¶å®ç°é…ç½®åˆæ˜¯æ€ä¹ˆå®ç°çš„å‘¢ ? ç„¶åè¿™é‡Œï¼Œçœ‹äº† Mybatis è¯»å–é…ç½®æ–‡ä»¶, åç»­å†å‡º Spring é…ç½®æ–‡ä»¶çš„æ—¶å€™ï¼Œå¦‚æœäºŒè€…è¯»å–é…ç½®è¿›è¡Œå¯¹æ¯”, ä½ ä¸ªäººæ›´å€¾å‘ä½¿ç”¨ä»£ç å‘¢ ?</p>
<p>æ‰€ä»¥,è¿™é‡Œå°±å¼€å¯è¯»å– Mybatis æ˜¯å¦‚ä½•è§£æé…ç½®æ–‡ä»¶çš„æ“ä½œ.</p>

        <h4 id="é…ç½®æ–‡ä»¶"   >
          <a href="#é…ç½®æ–‡ä»¶" class="heading-link"><i class="fas fa-link"></i></a><a href="#é…ç½®æ–‡ä»¶" class="headerlink" title="é…ç½®æ–‡ä»¶"></a>é…ç½®æ–‡ä»¶</h4>
      <p>è¿™é‡Œçš„é…ç½®æ–‡ä»¶è§£è¯»,æ˜¯æ ¹æ® MyBatiså®˜ç½‘æ¥ä¸€æ­¥ä¸€æ­¥çš„è§£æé˜…è¯». å¦‚æœæœ‰å®˜ç½‘æ²¡æœ‰æ¶‰åŠåˆ°çš„,å‘ç°äº†ä¹Ÿä¼šåœ¨åç»­åŠ ä¸Šå»çš„. è§£æå¤šè¡Œä»£ç , æ‰èƒ½ç†è§£ ä½•ä¸ºä¼˜ç§€.</p>
<p><strong>æ ‡ç­¾ä¸€ : properties</strong></p>
<p>org.apache.ibatis.builder.xml.XMLConfigBuilder#parseConfiguration â€”&gt; propertiesElement(root.evalNode(â€œpropertiesâ€)) æ–¹æ³•ä¸­æ¥.</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">// è¿™é‡Œä¼ å…¥è¿›æ¥çš„ XNode çš„å€¼,å°±æ˜¯æˆ‘ä»¬å†™çš„ properties æ ‡ç­¾.</span><br><span class="line">// å¯ä»¥çœ‹åˆ° XNodeçš„å±æ€§,nameæ ‡ç­¾çš„åå­—,attributeså°±æ˜¯key/valueå±æ€§</span><br><span class="line">// æ¯”å¦‚è¿™é‡Œ: key å°±æ˜¯ resource , value å°±æ˜¯ ./db.properties.</span><br><span class="line">private void propertiesElement(XNode context) throws Exception &#123;</span><br><span class="line">  if (context != null) &#123;</span><br><span class="line">// è¿™é‡Œè°ƒç”¨çš„node.getChildNodes(),å¦‚æœæœ‰ç‚¹è¯,ä¼šéå†æŒ¨ä¸ªè§£æ,æœ€åå°è£…æˆä¸ºkey/valueç»“æ„.      </span><br><span class="line">    Properties defaults = context.getChildrenAsProperties();</span><br><span class="line">// è·å– resource / url äºŒè€…çš„å€¼.      </span><br><span class="line">    String resource = context.getStringAttribute(&quot;resource&quot;);</span><br><span class="line">    String url = context.getStringAttribute(&quot;url&quot;);</span><br><span class="line">// å¦‚æœäºŒè€…éƒ½æ˜¯null,å°±ä¼šæŠ›å‡ºå¼‚å¸¸æ¥.      </span><br><span class="line">    if (resource != null &amp;&amp; url != null) &#123;</span><br><span class="line">      throw new BuilderException(&quot;The properties element cannot specify both a URL and a resource based property file reference.  Please specify one or the other.&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">      </span><br><span class="line"> // è¿™é‡Œå…ˆå¤„ç†resource,å†å¤„ç†url,ä¹Ÿå°±æ˜¯æœ‰å¯èƒ½urlä¼šè¦†ç›–æ‰resourceçš„å†…å®¹.</span><br><span class="line"> // äºŒè€…è¯»å–çš„æ–¹å¼ä¸ä¸€æ ·,å‰è€…æ˜¯æ ¹æ® resourceå¼€å§‹è¯»,urlæ˜¯æ ¹æ®ç»å¯¹è·¯å¾„å¼€å§‹è¯».</span><br><span class="line"> // æœ€å defaults é‡Œé¢æ”¾å…¥çš„å…¨éƒ¨æ˜¯ key/value å¯¹åº”çš„é”®å€¼å¯¹</span><br><span class="line"> // ä¹Ÿå°±æ˜¯db.propertiesä¸­çš„ key / value ç›¸å¯¹åº”ièµ·æ¥.     </span><br><span class="line">    if (resource != null) &#123;</span><br><span class="line">      defaults.putAll(Resources.getResourceAsProperties(resource));</span><br><span class="line">    &#125; else if (url != null) &#123;</span><br><span class="line">      defaults.putAll(Resources.getUrlAsProperties(url));</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">// è¿™é‡Œçœ‹çš„æ˜¯ xml é‡Œé¢æ˜¯ä¸æ˜¯ç›´æ¥æœ‰ porperties é…ç½®.     </span><br><span class="line">// å¦‚æœæœ‰çš„è¯,å°±ä¼šputAllè¿›å».      </span><br><span class="line">    Properties vars = configuration.getVariables();</span><br><span class="line">    if (vars != null) &#123;</span><br><span class="line">      defaults.putAll(vars);</span><br><span class="line">    &#125;</span><br><span class="line">// æœ€åå§ defaults,ä¹Ÿå°±æ˜¯propertiesç»™æ”¾å…¥åˆ° BaseBuilder å’Œ Confifurationä¸­å».      </span><br><span class="line">    parser.setVariables(defaults);</span><br><span class="line">    configuration.setVariables(defaults);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-----------------------------</span><br><span class="line">//  å¦‚ä½•è®© Properties vars = configuration.getVariables(); æœ‰å€¼å‘¢ ?</span><br><span class="line">//  å¦‚æœåªæ˜¯å•ä¸ªçš„ MyBatis é¡¹ç›®çš„è¯, å°±è‡ªå·±æ‰‹åŠ¨newä¸€ä¸ªpropertieså¯¹è±¡</span><br><span class="line">//  ç„¶åkeyè¾“å…¥è‡ªå·±è¦è¦†ç›–æ‰çš„keyå°±å¯ä»¥äº†</span><br><span class="line">        Properties dbConfigProperties = new Properties();</span><br><span class="line">        dbConfigProperties.setProperty(&quot;jdbc.password&quot;,&quot;GavinYang&quot;);</span><br><span class="line"></span><br><span class="line">        SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(mybatisInputStream,dbConfigProperties);</span><br></pre></td></tr></table></div></figure>

<p><strong>æ ‡ç­¾äºŒ : settings</strong></p>
<p>è¿™æ˜¯ MyBatiså¯¹ settings çš„æ“ä½œ.</p>
<p>å…·ä½“çš„ settings ä¸­æ¯é¡¹é…ç½®å‚è€ƒå®˜ç½‘é“¾æ¥ : <span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://mybatis.org/mybatis-3/configuration.html#properties" >https://mybatis.org/mybatis-3/configuration.html#properties</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// è§£æ setting ---&gt; è½¬åŒ–ä¸º key /value</span><br><span class="line">Properties settings = settingsAsProperties(root.evalNode(&quot;settings&quot;));</span><br><span class="line">// </span><br><span class="line">loadCustomVfs(settings);</span><br><span class="line">loadCustomLogImpl(settings);</span><br></pre></td></tr></table></div></figure>

<p>settingsAsProperties æ–¹æ³•</p>
<p>å¯ä»¥çœ‹åˆ°, è¯¥æ–¹æ³•å°±æ˜¯è¿›è¡ŒåŠ è½½,è½¬åŒ–ä¸ºkey/valueé”®å€¼å¯¹ç±»å‹, ç„¶åå¯¹å…¶keyæ£€éªŒæ˜¯å¦åœ¨</p>
<p>Configuration ä¸­éƒ½æœ‰ set æ–¹æ³•.</p>
<p>Notes : ä¸ºäº†éªŒè¯ä¸‹, æˆ‘ä»¬åŠ ä¸Šä¸€ä¸ªæ²¡æœ‰çš„æ ‡ç­¾, å¯ä»¥çœ‹åˆ°ä¸‹é¢çš„å¼‚å¸¸. æ‰€ä»¥æˆ‘ä»¬çœ‹åˆ°è¿™ç§å¼‚å¸¸çš„æ—¶å€™ï¼Œæ˜¯å¯ä»¥å»æ£€æŸ¥ä¸‹æ˜¯ä¸æ˜¯åå­—ä»€ä¹ˆæœ‰é—®é¢˜.</p>

        <h3 id="Cause-org-apache-ibatis-builder-BuilderException-Error-parsing-SQL-Mapper-Configuration-Cause-org-apache-ibatis-builder-BuilderException-The-setting-nnnnn-is-not-known-Make-sure-you-spelled-it-correctly-case-sensitive"   >
          <a href="#Cause-org-apache-ibatis-builder-BuilderException-Error-parsing-SQL-Mapper-Configuration-Cause-org-apache-ibatis-builder-BuilderException-The-setting-nnnnn-is-not-known-Make-sure-you-spelled-it-correctly-case-sensitive" class="heading-link"><i class="fas fa-link"></i></a><a href="#Cause-org-apache-ibatis-builder-BuilderException-Error-parsing-SQL-Mapper-Configuration-Cause-org-apache-ibatis-builder-BuilderException-The-setting-nnnnn-is-not-known-Make-sure-you-spelled-it-correctly-case-sensitive" class="headerlink" title="Cause: org.apache.ibatis.builder.BuilderException: Error parsing SQL Mapper Configuration. Cause: org.apache.ibatis.builder.BuilderException: The setting nnnnn is not known. Make sure you spelled it correctly (case sensitive)."></a>Cause: org.apache.ibatis.builder.BuilderException: Error parsing SQL Mapper Configuration. Cause: org.apache.ibatis.builder.BuilderException: The setting nnnnn is not known. Make sure you spelled it correctly (case sensitive).</h3>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">private Properties settingsAsProperties(XNode context) &#123;</span><br><span class="line">  if (context == null) &#123;</span><br><span class="line">    return new Properties();</span><br><span class="line">  &#125;</span><br><span class="line"> // å¯¹ settings ä¸‹çš„ setting è¿›è¡Œè§£æ å¹¶ä¸” è½¬åŒ–ä¸º key / value æ“ä½œ.   </span><br><span class="line">  Properties props = context.getChildrenAsProperties();</span><br><span class="line">  // Check that all settings are known to the configuration class</span><br><span class="line"> // å¯¹ Configuration è¿›è¡Œæ ¡éªŒ, ç¡®è®¤ä¸Šé¢çš„ props ä¸­çš„key åœ¨ Configuration</span><br><span class="line">// ä¸­æ˜¯éƒ½æœ‰set æ–¹æ³•çš„,ç›®æµ‹æ˜¯åé¢åå°„éœ€è¦ä½¿ç”¨åˆ°.    </span><br><span class="line">  MetaClass metaConfig = MetaClass.forClass(Configuration.class, localReflectorFactory);</span><br><span class="line">  for (Object key : props.keySet()) &#123;</span><br><span class="line">    if (!metaConfig.hasSetter(String.valueOf(key))) &#123;</span><br><span class="line">      throw new BuilderException(&quot;The setting &quot; + key + &quot; is not known.  Make sure you spelled it correctly (case sensitive).&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return props;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>loadCustomVfs(settings) æ–¹æ³•</p>
<p>è¯¥æ–¹æ³•,ä¸»è¦å°±æ˜¯è¯»å– vfsImpl å¯¹ç”¨çš„value,åˆ‡å‰²ä¸‹,ç„¶åç”¨ classForName æ¥è·å– class,</p>
<p>æœ€åèµ‹å€¼åˆ° configuration ä¸­å». è¿™é‡Œç®—æ˜¯å¯¹ vfs çš„ä¸€ç§è‡ªå®šä¹‰çš„æ‰©å±•,è™½ç„¶ç›®å‰è¿˜ä¸å¤ªæ¸…æ¥švfså…·ä½“ä½œç”¨.</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">private void loadCustomVfs(Properties props) throws ClassNotFoundException &#123;</span><br><span class="line">  // è·å– vfsImpl çš„ value.  </span><br><span class="line">  String value = props.getProperty(&quot;vfsImpl&quot;);</span><br><span class="line">  if (value != null) &#123;</span><br><span class="line">   // æ ¹æ® , è¿›è¡Œåˆ‡å‰².   </span><br><span class="line">    String[] clazzes = value.split(&quot;,&quot;);</span><br><span class="line">    for (String clazz : clazzes) &#123;</span><br><span class="line">      if (!clazz.isEmpty()) &#123;</span><br><span class="line">        @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">        // åå°„,è·å–å‡º Class , æœ€åèµ‹å€¼åˆ° configuration ä¸­å».  </span><br><span class="line">        Class&lt;? extends VFS&gt; vfsImpl = (Class&lt;? extends VFS&gt;)Resources.classForName(clazz);</span><br><span class="line">        configuration.setVfsImpl(vfsImpl);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>loadCustomLogImpl(settings) æ–¹æ³•</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">private void loadCustomLogImpl(Properties props) &#123;</span><br><span class="line">  Class&lt;? extends Log&gt; logImpl = resolveClass(props.getProperty(&quot;logImpl&quot;));</span><br><span class="line">  // å°† log set åˆ° configuration ä¸­å».  </span><br><span class="line">  configuration.setLogImpl(logImpl);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-----------------------</span><br><span class="line">// resolve æœ€åå¦‚æœä¸æ˜¯ null çš„è¯,</span><br><span class="line">org.apache.ibatis.type.TypeAliasRegistry#resolveAlias</span><br><span class="line"></span><br><span class="line"> // å°±ä¼šèµ°åˆ°è¿™é‡Œ,è¿™é‡Œå¯ä»¥çœ‹å…ˆæ˜¯åœ¨ typeAliases(HashMap) ä¸­åˆ¤æ–­ä¸‹,å¦‚æœå­˜åœ¨å°±ç›´æ¥è·å–</span><br><span class="line">// å¦‚æœä¸å­˜åœ¨å°±ç”¨ Resources.ClassForNameæ¥æ“ä½œ</span><br><span class="line">// è¿™é‡Œçš„ HashMapå°±ç±»ä¼¼äº,è®°å½•ä¹‹å‰æ˜¯å¦å·²ç»åŠ è½½äº†æˆ–è€…é¢„çƒ­.</span><br><span class="line">// å¦‚æœæ˜¯ç”¨æ¥åšcacheçš„è¯, é‚£å°±åº”è¯¥æœ€åä¼šåœ¨ return ä¹‹å‰ç»§ç»­æŠŠå€¼ç»™æ”¾å…¥è¿›å».    </span><br><span class="line">  public &lt;T&gt; Class&lt;T&gt; resolveAlias(String string) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">      if (string == null) &#123;</span><br><span class="line">        return null;</span><br><span class="line">      &#125;</span><br><span class="line">      // issue #748</span><br><span class="line">      String key = string.toLowerCase(Locale.ENGLISH);</span><br><span class="line">      Class&lt;T&gt; value;</span><br><span class="line">      if (typeAliases.containsKey(key)) &#123;</span><br><span class="line">        value = (Class&lt;T&gt;) typeAliases.get(key);</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        value = (Class&lt;T&gt;) Resources.classForName(string);</span><br><span class="line">      &#125;</span><br><span class="line">      return value;</span><br><span class="line">    &#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">      throw new TypeException(&quot;Could not resolve type alias &#x27;&quot; + string + &quot;&#x27;.  Cause: &quot; + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">------------</span><br><span class="line">// å¦‚æœæˆ‘ä»¬åœ¨é…ç½®æ–‡ä»¶ä¸­æ²¡æœ‰å®šä¹‰çš„è¯,è¿™é‡Œé»˜è®¤æ˜¯null,ä¹Ÿå°±æ˜¯è¯´ä¸ä¼šsetè¿›å».    </span><br><span class="line">  public void setLogImpl(Class&lt;? extends Log&gt; logImpl) &#123;</span><br><span class="line">    if (logImpl != null) &#123;</span><br><span class="line">      this.logImpl = logImpl;</span><br><span class="line">      LogFactory.useCustomLogging(this.logImpl);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></div></figure>

<p><strong>æ ‡ç­¾ä¸‰ :</strong></p>
<p>å…³äºåˆ«åçš„é…ç½®.</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">typeAliasesElement(root.evalNode(&quot;typeAliases&quot;));</span><br><span class="line">private void typeAliasesElement(XNode parent) &#123;</span><br><span class="line">  if (parent != null) &#123;</span><br><span class="line">   // å¯¹ typeAliases ä¸‹çš„å­æ ‡ç­¾è¿›è¡Œè¿­ä»£.</span><br><span class="line">   // åˆ†ä¸ºæ˜¯ package å’Œé package   </span><br><span class="line">    for (XNode child : parent.getChildren()) &#123;</span><br><span class="line">      if (&quot;package&quot;.equals(child.getName())) &#123;</span><br><span class="line">       // è·å–ä½ è¾“å…¥çš„åŒ…   </span><br><span class="line">        String typeAliasPackage = child.getStringAttribute(&quot;name&quot;);</span><br><span class="line">        configuration.getTypeAliasRegistry().registerAliases(typeAliasPackage);</span><br><span class="line">      &#125; else &#123;</span><br><span class="line"> // &lt;typeAlias type=&quot;com.iyang.mybatis.pojo.TbBlog&quot; alias=&quot;TbBlog&quot; /&gt;</span><br><span class="line"> // è¿™é‡Œå°±æ˜¯å¯¹è¿™ç§è¿›è¡Œè§£æçš„         </span><br><span class="line">        String alias = child.getStringAttribute(&quot;alias&quot;);</span><br><span class="line">        String type = child.getStringAttribute(&quot;type&quot;);</span><br><span class="line">        try &#123;</span><br><span class="line">          Class&lt;?&gt; clazz = Resources.classForName(type);</span><br><span class="line">   // å¦‚æœæ²¡å†™åˆ«å,å°±åªä¼ å…¥ clazz.         </span><br><span class="line">          if (alias == null) &#123;</span><br><span class="line">            typeAliasRegistry.registerAlias(clazz);</span><br><span class="line">          &#125; else &#123;</span><br><span class="line">   // å†™äº†åˆ«å,å°±åˆ«åå’Œclazzä¸€èµ·ä¼ å…¥è¿›æ¥.           </span><br><span class="line">            typeAliasRegistry.registerAlias(alias, clazz);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">          throw new BuilderException(&quot;Error registering typeAlias for &#x27;&quot; + alias + &quot;&#x27;. Cause: &quot; + e, e);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">----------------</span><br><span class="line">// è¿™é‡Œå¯ä»¥çœ‹åˆ°æ˜¯æ ¹æ® packageName æ¥ registerè¿›æ¥çš„.    </span><br><span class="line">  public void registerAliases(String packageName, Class&lt;?&gt; superType) &#123;</span><br><span class="line">    // new ä¸€ä¸ªè§£æå™¨å·¥å…·ç±»</span><br><span class="line">    ResolverUtil&lt;Class&lt;?&gt;&gt; resolverUtil = new ResolverUtil&lt;&gt;();</span><br><span class="line">    // è·å–åŒ…çš„path,ç„¶åè·å–è¯¥åŒ…ä¸‹çš„æ–‡ä»¶,å¦‚æœæ–‡ä»¶æ˜¯.classç»“å°¾çš„è¯</span><br><span class="line">    // æœ€ååœ¨ ResolverUtil ä¸­matchessæ˜¯æœ‰è¯¥åŒ…ä¸‹çš„å…¨åç§°.</span><br><span class="line">    resolverUtil.find(new ResolverUtil.IsA(superType), packageName);</span><br><span class="line">    // è¿™é‡Œè¿”å›çš„æ˜¯ä¸Šä¸€æ­¥è¯´çš„ matches</span><br><span class="line">    Set&lt;Class&lt;? extends Class&lt;?&gt;&gt;&gt; typeSet = resolverUtil.getClasses();</span><br><span class="line">    for (Class&lt;?&gt; type : typeSet) &#123;</span><br><span class="line">      // Ignore inner classes and interfaces (including package-info.java)</span><br><span class="line">      // Skip also inner classes. See issue #6</span><br><span class="line">      // å¦‚æœä¸æ˜¯æ¥å£,ä¸æ˜¯å†…éƒ¨ç±»ç­‰æ¡ä»¶çš„è¯,å°±èµ°  registerAlias æ–¹æ³•</span><br><span class="line">      if (!type.isAnonymousClass() &amp;&amp; !type.isInterface() &amp;&amp; !type.isMemberClass()) &#123;</span><br><span class="line"> // å…ˆè·å–ç±»åå­—,åˆ¤æ–­è¯¥ç±»ä¸Šæœ‰æ²¡æœ‰ @Alias æ³¨è§£,å¦‚æœæœ‰æ³¨è§£çš„è¯,å°±ç”¨æ³¨è§£çš„å€¼ä½œä¸ºç¼©å†™çš„.</span><br><span class="line"> // æœ€ååˆ¤æ–­æ˜¯ä¸æ˜¯null,æ˜¯nullå°±ä¼šæŠ›å‡ºå¼‚å¸¸æ¥.æœ€åå°†ä¸Šé¢è·å–å‡ºæ¥çš„ç¼©å†™åå­—,è½¬åŒ–ä¸ºå¤§å†™.</span><br><span class="line"> // å¦‚æœæ­¤æ—¶ typeAliases æ˜¯å·²ç»æœ‰äº†è¯¥å€¼çš„è¯,å°±ä¼šæŠ›å‡ºå¼‚å¸¸æ¥.å¦åˆ™å°±æ”¾å…¥åˆ°typeAliasesæ¥</span><br><span class="line"> // private final Map&lt;String, Class&lt;?&gt;&gt; typeAliases = new HashMap&lt;&gt;();</span><br><span class="line"> // å¯ä»¥çœ‹åˆ° typeAliases æ˜¯ä¸€ä¸ªHashMap,å¹¶ä¸”å…¶å­˜å‚¨çš„Key/Valueè¿˜æ˜¯è›®æ˜æ˜¾çš„.         </span><br><span class="line">        registerAlias(type);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></div></figure>

<p><strong>æ ‡ç­¾å››</strong></p>
<p>æ‰©å±•çš„ demo å¯ä»¥å‚è€ƒ MyBatiså®˜ç½‘ : <span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://mybatis.org/mybatis-3/configuration.html" >https://mybatis.org/mybatis-3/configuration.html</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>ç„¶åçœ‹ MyBatis æ˜¯å¦‚ä½•å°†æ’ä»¶ç»™åˆ©ç”¨ä¸Šçš„å‘¢ ?</p>
<p>é¦–å…ˆåœ¨ mybatis-config.xml ä¸­é…ç½®å¥½æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„ plugin</p>
<p>è¿™é‡Œä»¥æˆ‘é…ç½®äº†äºŒä¸ªæ’ä»¶</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;plugins&gt;</span><br><span class="line">    &lt;plugin interceptor=&quot;com.iyang.mybatis.plugins.ExamplePlugin&quot;&gt;</span><br><span class="line">        &lt;property name=&quot;name&quot; value=&quot;GavinYang&quot;/&gt;</span><br><span class="line">        &lt;property name=&quot;age&quot; value=&quot;22&quot;/&gt;</span><br><span class="line">        &lt;property name=&quot;hobby&quot; value=&quot;lwf&quot;/&gt;</span><br><span class="line">    &lt;/plugin&gt;</span><br><span class="line"></span><br><span class="line">    &lt;plugin interceptor=&quot;com.iyang.mybatis.plugins.QuerySqlPlugin&quot;&gt;</span><br><span class="line"></span><br><span class="line">        &lt;property name=&quot;name&quot; value=&quot;GavinYang&quot;/&gt;</span><br><span class="line">    &lt;/plugin&gt;</span><br><span class="line">&lt;/plugins&gt;</span><br></pre></td></tr></table></div></figure>

<p>// å¤„ç† plugin çš„ä»£ç </p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">private void pluginElement(XNode parent) throws Exception &#123;</span><br><span class="line">  // è¿™é‡Œä¼ å…¥è¿›æ¥çš„å°±æ˜¯ &lt;plugins&gt;æ•´ä¸ªæ ‡ç­¾å†…å®¹.  </span><br><span class="line">  if (parent != null) &#123;</span><br><span class="line">   // è·å– &lt;plugins&gt; ä¸‹çš„ &lt;plugin&gt; é›†åˆ,è¿›è¡Œè¿­ä»£å¤„ç†.   </span><br><span class="line">    for (XNode child : parent.getChildren()) &#123;</span><br><span class="line">     // è·å–æ’ä»¶çš„ å…¨é™å®šåå­—.   </span><br><span class="line">      String interceptor = child.getStringAttribute(&quot;interceptor&quot;);</span><br><span class="line">     // è·å–æˆ‘ä»¬å®šä¹‰åœ¨ plugin ä¸‹çš„ properties.   </span><br><span class="line">      Properties properties = child.getChildrenAsProperties();</span><br><span class="line">// resolveClassæ˜¯æœ€åæ³¨å†Œåˆ°typeAliasRegistryæ¥.    </span><br><span class="line">// å®ä¾‹åŒ–,è¿™é‡Œå°±å¯ä»¥çœ‹åˆ°æˆ‘ä»¬åœ¨å®šä¹‰çš„Pluginä¸­,æ— å‚æ„é€ å‡½æ•°æ‰“å°å‡ºæ¥çš„å†…å®¹äº†.        </span><br><span class="line">      Interceptor interceptorInstance = (Interceptor) resolveClass(interceptor).getDeclaredConstructor().newInstance();</span><br><span class="line">// å°† properties èµ‹å€¼ç»™  interceptorInstance</span><br><span class="line">// ä¹Ÿå°±æ˜¯æ”¾å…¥åˆ° interceptorInstance æ¥.        </span><br><span class="line">      interceptorInstance.setProperties(properties);</span><br><span class="line">// org.apache.ibatis.plugin.InterceptorChain</span><br><span class="line">// è¿™æ˜¯æ˜¯å°†interceptorInstanceæ·»åŠ åˆ°InterceptorChainçš„interceptorsä¸­æ¥.        </span><br><span class="line">      configuration.addInterceptor(interceptorInstance);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>å¯ä»¥çœ‹åˆ° MyBatisåœ¨åŠ è½½pluginçš„æ—¶å€™,æ˜¯åˆ©ç”¨äº†åå°„æ¥newå‡ºä¸€ä¸ªå¯¹è±¡æ¥,å¹¶ä¸”æ³¨å†Œåˆ° typeAliasRegistry ä¸­æ¥. è¿™é‡Œä¸»è¦æ˜¯è§£æ plugin çš„é…ç½®, åé¢åœ¨æ‰§è¡Œsqlçš„æ—¶å€™,éƒ½æ˜¯å¦‚ä½•ä½¿ç”¨åˆ°è¿™äº› plugin çš„å‘¢ ? è‚¯å®šæ˜¯æœ‰ä¸€ä¸ªä»InterceptorChainä¸­è·å–interceptorsæ¥,ç„¶åè¿›è¡Œå¤„ç†.</p>
<p><strong>æ ‡ç­¾äº” : &lt; objectFactory &gt;</strong></p>
<p>objectFactory çš„å¤„ç†æ–¹å¼æ˜¯å’Œ æ ‡ç­¾å››ç›¸ä¼¼çš„,åªæ˜¯æœ€ååœ¨ä½¿ç”¨åœºæ™¯æ˜¯æœ‰ç‚¹ä¸åŒçš„.</p>
<p>ä»£ç ä¸Šçš„æ“ä½œä¹Ÿæ˜¯ç±»ä¼¼çš„.</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">private void objectFactoryElement(XNode context) throws Exception &#123;</span><br><span class="line">  if (context != null) &#123;</span><br><span class="line">    String type = context.getStringAttribute(&quot;type&quot;);</span><br><span class="line">    Properties properties = context.getChildrenAsProperties();</span><br><span class="line">    ObjectFactory factory = (ObjectFactory) resolveClass(type).getDeclaredConstructor().newInstance();</span><br><span class="line">    factory.setProperties(properties);</span><br><span class="line">    configuration.setObjectFactory(factory);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p><strong>æ ‡ç­¾äº” :</strong></p>
<p>è¯¥æ ‡ç­¾åœ¨ MyBatis å®˜ç½‘æ˜¯æ²¡æœ‰demo, æˆ‘æ˜¯æ ¹æ®ä»£ç æ¥é¡ºè—¤æ‘¸ç“œå†™çš„ä¸€ä¸ª.</p>
<p>å‚è€ƒ : org.apache.ibatis.reflection.wrapper.DefaultObjectWrapperFactory è¿™ä¸ªæºç ,æ¥æ¨¡ä»¿å†™çš„ä¸€ä¸ª.</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">objectWrapperFactoryElement(root.evalNode(&quot;objectWrapperFactory&quot;));</span><br><span class="line">private void objectWrapperFactoryElement(XNode context) throws Exception &#123;</span><br><span class="line">  if (context != null) &#123;</span><br><span class="line">   // è·å– é…ç½®æ–‡ä»¶ä¸­çš„typeå€¼   </span><br><span class="line">    String type = context.getStringAttribute(&quot;type&quot;);</span><br><span class="line"> // å…ˆæ³¨å†Œåˆ°  typeAliasRegistry æ¥,ç„¶åå®ä¾‹åŒ–è¿™ä¸ªç±».</span><br><span class="line"> // æˆ‘ä»¬åœ¨è‡ªå·±å®šä¹‰çš„ç±»ä¸­,å†™ä¸€ä¸ªæ— å‚æ„é€ å‡½æ•°,å°±å¯ä»¥çœ‹åˆ°æˆ‘ä»¬æ‰“å°çš„å†…å®¹äº†.     </span><br><span class="line">    ObjectWrapperFactory factory = (ObjectWrapperFactory) resolveClass(type).getDeclaredConstructor().newInstance();</span><br><span class="line">// æœ€åèµ‹å€¼åˆ° confifuration ä¸­æ¥.      </span><br><span class="line">    configuration.setObjectWrapperFactory(factory);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p><strong>æ ‡ç­¾å…­ : &lt; reflectorFactory &gt;</strong></p>
<p>å¤„ç†æ–¹å¼å’Œä¸Šé¢ç±»ä¼¼.</p>
<p>è¿™é‡Œæˆ‘ä»¬è‡ªå·±å†™ä¸€ä¸ª com.iyang.mybatis.factory.GavinReflectorFactory æ¥ç»§æ‰¿DefaultReflectorFactory,åœ¨æ— å‚æ•°æ„é€ å‡½æ•°ä¸­æ‰“å°ä¸‹å†…å®¹, ç„¶ådebugè·Ÿè¿›.</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">private void reflectorFactoryElement(XNode context) throws Exception &#123;</span><br><span class="line">  if (context != null) &#123;</span><br><span class="line">    String type = context.getStringAttribute(&quot;type&quot;);</span><br><span class="line">    ReflectorFactory factory = (ReflectorFactory) resolveClass(type).getDeclaredConstructor().newInstance();</span><br><span class="line">    configuration.setReflectorFactory(factory);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p><strong>æ ‡ç­¾ä¸ƒ :</strong></p>
<p>environments æ ‡ç­¾éƒ½æ˜¯æ”¾å…¥ä¸€äº› db çš„é…ç½®ä¿¡æ¯ç­‰.</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">&lt;environments default=&quot;development&quot;&gt;</span><br><span class="line">    &lt;environment id=&quot;development&quot;&gt;</span><br><span class="line">        &lt;!-- äº‹åŠ¡ --&gt;</span><br><span class="line">        &lt;transactionManager type=&quot;JDBC&quot;/&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- DB è¿æ¥é…ç½® --&gt;</span><br><span class="line">        &lt;dataSource type=&quot;POOLED&quot;&gt;</span><br><span class="line">            &lt;property name=&quot;driver&quot; value=&quot;$&#123;jdbc.driver&#125;&quot; /&gt;</span><br><span class="line">            &lt;property name=&quot;url&quot; value=&quot;$&#123;jdbc.url&#125;&quot; /&gt;</span><br><span class="line">            &lt;property name=&quot;username&quot; value = &quot;$&#123;jdbc.username&#125;&quot; /&gt;</span><br><span class="line">            &lt;property name=&quot;password&quot; value=&quot;$&#123;jdbc.password&#125;&quot; /&gt;</span><br><span class="line">        &lt;/dataSource&gt;</span><br><span class="line">    &lt;/environment&gt;</span><br><span class="line">&lt;/environments&gt;</span><br><span class="line">private void environmentsElement(XNode context) throws Exception &#123;</span><br><span class="line">  if (context != null) &#123;</span><br><span class="line">    if (environment == null) &#123;</span><br><span class="line">// è·å– default å¯¹åº”å­—æ®µçš„å€¼         </span><br><span class="line">      environment = context.getStringAttribute(&quot;default&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">// è¿™é‡Œçš„ getChildren è·å–çš„æ˜¯ &lt;environments&gt; --&gt; &lt;environment&gt;ä¸‹çš„å­æ ‡ç­¾      </span><br><span class="line">    for (XNode child : context.getChildren()) &#123;</span><br><span class="line">      String id = child.getStringAttribute(&quot;id&quot;);</span><br><span class="line">// ç¡®ä¿ id å’Œ  ä¸Šä¸€æ­¥çš„environment çš„å€¼æ˜¯ç›¸åŒçš„,å°±ä¼šè¿”å›true.      </span><br><span class="line">      if (isSpecifiedEnvironment(id)) &#123;</span><br><span class="line">/**</span><br><span class="line">*  è·å–å‡º transactionManager å¯¹åº”çš„æ ‡ç­¾.</span><br><span class="line">*  ç„¶åæ ¹æ® JBDC(é…ç½®æ–‡ä»¶ä¸­çš„å€¼),ç„¶åä» typeAliasRegistryä¸­è·å–å‡ºæ¥ï¼Œ</span><br><span class="line">*  è°ƒç”¨åå°„æ¥ å®ä¾‹åŒ– è¿™ä¸ªå¯¹è±¡. </span><br><span class="line">*  æœ€åè¿˜æ˜¯å¯ä»¥é…ç½® properties,ä¼šè¢«setåˆ°txFactoryä¸­å»çš„.</span><br><span class="line">*  ä½†æ˜¯ JdbcTransactionFactory å¥½åƒæ²¡æœ‰é‡å†™ setProperties æ–¹æ³•.</span><br><span class="line">*/          </span><br><span class="line">        TransactionFactory txFactory = transactionManagerElement(child.evalNode(&quot;transactionManager&quot;));</span><br><span class="line">// å…ˆè·å–  dataSource å­—æ®µ</span><br><span class="line">/**</span><br><span class="line">*  å…ˆè·å–typeçš„å€¼,ç„¶åå†è·å– propertiesçš„æ ‡ç­¾å­—æ®µå€¼.</span><br><span class="line">*  æ ¹æ®æˆ‘ä»¬çš„é…ç½® : org.apache.ibatis.datasource.pooled.PooledDataSourceFactory,åº”è¯¥ä¼šè·å–å‡ºè¿™ä¸ªå¯¹è±¡.è¯¥å¯¹è±¡å…¶å†…éƒ¨æ˜¯æœ‰ä¸€ä¸ª,org.apache.ibatis.datasource.pooled.PooledDataSourceçš„,é‡Œé¢æœ‰éƒ¨åˆ†é»˜è®¤å€¼çš„.</span><br><span class="line">*æœ€åå°†  properties è°ƒç”¨ org.apache.ibatis.datasource.unpooled.UnpooledDataSourceFactory#setPropertiesæ–¹æ³•,</span><br><span class="line">æœ€åæ˜¯å°† properties é‡Œé¢çš„key/value éƒ½è®¾ç½®åˆ° MetaObject metaDataSource = SystemMetaObject.forObject(dataSource);æ¥äº†.</span><br><span class="line">*/</span><br><span class="line">        DataSourceFactory dsFactory = dataSourceElement(child.evalNode(&quot;dataSource&quot;));</span><br><span class="line">// ä»  PooledDataSourceFactory ä¸­è·å– datasource å±æ€§.         </span><br><span class="line">        DataSource dataSource = dsFactory.getDataSource();</span><br><span class="line">// è¿™é‡Œé‡‡ç”¨é“¾å¼ç¼–ç¨‹,ä¹Ÿå°±æ˜¯å°†id/txFactory/dataSource éƒ½ç»™setåˆ° Environment.Builderæ¥äº†.         </span><br><span class="line">        Environment.Builder environmentBuilder = new Environment.Builder(id)</span><br><span class="line">            .transactionFactory(txFactory)</span><br><span class="line">            .dataSource(dataSource);</span><br><span class="line">  //    environmentBuilder.build() ä¹Ÿå°±æ˜¯new äº†ä¸€ä¸ª Environment </span><br><span class="line">  // æœ€å èµ‹å€¼åˆ° configuration ä¸­æ¥äº†.        </span><br><span class="line">        configuration.setEnvironment(environmentBuilder.build());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>è§£æ environments ,åˆ©ç”¨ typeAliasRegistry ä¸­å·²ç»æ³¨å†Œå¥½äº†çš„ä¿¡æ¯,ç„¶åæ ¹æ®åå­—ç¼©å†™(æ¯”å¦‚JDBC)è¿™ç§,æ¥è·å–classå¯¹è±¡, ç”¨ åå°„æ¥ new ä¸€æ³¢å¯¹è±¡å‡ºæ¥,çœŸæ˜¯ç¾æ»‹æ»‹. æ¥ç€å°±æ˜¯è§£æ äº‹åŠ¡/JDBCè¿æ¥é…ç½®ä¿¡æ¯ç­‰, æœ€åå°†ä¿¡æ¯ä¿å­˜åˆ° DataSource ä¸­æ¥. åæ‰‹å†æ¥ä¸€æ³¢ é“¾å¼ç¼–ç¨‹ æ¥newå¯¹è±¡å‡ºæ¥, æœ€åå°±æ˜¯ä¸€ä¸ª Environment å¯¹è±¡å‡ºæ¥,ç»™set åˆ° configuration ä¸­æ¥.</p>
<p><strong>æ ‡ç­¾å…«</strong></p>
<p>åˆ°è¿™é‡Œ,å¯ä»¥çœ‹åˆ°å¯¹xmlçš„è§£ææ“ä½œ. å…ˆè§£æ æ ‡ç­¾ çš„å€¼å‡ºæ¥,ç„¶åæ ¹æ®å€¼è¿›è¡Œåˆ†ç±»å¤„ç†æˆ–è€…æ ¹æ®è‡ªå·±çš„éœ€æ±‚æ¥è¿›è¡Œå¤„ç†.</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">private void typeHandlerElement(XNode parent) &#123;</span><br><span class="line">  if (parent != null) &#123;</span><br><span class="line">    for (XNode child : parent.getChildren()) &#123;</span><br><span class="line">      // å¦‚æœå­æ ‡ç­¾æ˜¯ package   </span><br><span class="line">      if (&quot;package&quot;.equals(child.getName())) &#123;</span><br><span class="line">       // è·å–å‡º name å¯¹åº”çš„å€¼.   </span><br><span class="line">        String typeHandlerPackage = child.getStringAttribute(&quot;name&quot;);</span><br><span class="line">      // æ³¨å†Œåˆ°   typeHandlerRegistry ä¸­æ¥.  </span><br><span class="line">        typeHandlerRegistry.register(typeHandlerPackage);</span><br><span class="line">      &#125; else &#123;</span><br><span class="line"> // è¿™é‡Œè·å–å‡ºä¸‰ç§å€¼æ¥,   javaType/jdbcType/  handler    </span><br><span class="line">        String javaTypeName = child.getStringAttribute(&quot;javaType&quot;);</span><br><span class="line">        String jdbcTypeName = child.getStringAttribute(&quot;jdbcType&quot;);</span><br><span class="line">        String handlerTypeName = child.getStringAttribute(&quot;handler&quot;);</span><br><span class="line">        Class&lt;?&gt; javaTypeClass = resolveClass(javaTypeName);</span><br><span class="line">        JdbcType jdbcType = resolveJdbcType(jdbcTypeName);</span><br><span class="line">        Class&lt;?&gt; typeHandlerClass = resolveClass(handlerTypeName);</span><br><span class="line">  // åˆ†ä¸º  javaTypeClass æ˜¯ä¸æ˜¯ null çš„æƒ…å†µ       </span><br><span class="line">        if (javaTypeClass != null) &#123;</span><br><span class="line">         // åŸºäº javaTypeClass æ˜¯ä¸æ˜¯ nullçš„æƒ…å†µ,å†åˆ¤æ–­ jdbcType æ˜¯ä¸æ˜¯null  </span><br><span class="line">          if (jdbcType == null) &#123;</span><br><span class="line">            typeHandlerRegistry.register(javaTypeClass, typeHandlerClass);</span><br><span class="line">          &#125; else &#123;</span><br><span class="line">            typeHandlerRegistry.register(javaTypeClass, jdbcType, typeHandlerClass);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">// è¿™æ˜¯æ ¹æ®   handlerTypeName æ³¨å†Œåˆ° typeHandlerRegistry ä¸­æ¥.           </span><br><span class="line">          typeHandlerRegistry.register(typeHandlerClass);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p><strong>æ ‡ç­¾ä¹ :</strong></p>
<p>è¯¥æ ‡ç­¾æ˜¯å¯¹æˆ‘ä»¬å¯¹åº”çš„å¯¹è±¡,å…¶sqlè¯­å¥å­˜æ”¾çš„åœ°å€. ä¹Ÿå°±æ˜¯é‡Œé¢æ”¾å…¥çš„æ˜¯äºmapperæ¥å£å¯¹åº”çš„æ–¹æ³•,æŸ¥è¯¢çš„sqlè¯­å¥.</p>
<p>æ¥ä¸‹æ¥çœ‹ä¸‹ MyBatis æ˜¯å¯¹ mappers æ ‡ç­¾çš„å†…å®¹è¿›è¡Œäº†è¯´æ˜è§£æå’Œå¤„ç†.</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">mapperElement</span><span class="params">(XNode parent)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">      </span><br><span class="line"> <span class="comment">// getChildren è·å–çš„æ˜¯ mappers ä¸‹çš„ mapper æ ‡ç­¾</span></span><br><span class="line">    <span class="keyword">for</span> (XNode child : parent.getChildren()) &#123;</span><br><span class="line"><span class="comment">// å¦‚æœé…ç½®çš„æ˜¯ package.        </span></span><br><span class="line">      <span class="keyword">if</span> (<span class="string">&quot;package&quot;</span>.equals(child.getName())) &#123;</span><br><span class="line">        String mapperPackage = child.getStringAttribute(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">        configuration.addMappers(mapperPackage);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// è·å–å‡º    resource/url/class è¿™ä¸‰ç±»çš„å€¼.       </span></span><br><span class="line">        String resource = child.getStringAttribute(<span class="string">&quot;resource&quot;</span>);</span><br><span class="line">        String url = child.getStringAttribute(<span class="string">&quot;url&quot;</span>);</span><br><span class="line">        String mapperClass = child.getStringAttribute(<span class="string">&quot;class&quot;</span>);</span><br><span class="line"> <span class="comment">// å¯¹ resource å¤„ç†         </span></span><br><span class="line">        <span class="keyword">if</span> (resource != <span class="keyword">null</span> &amp;&amp; url == <span class="keyword">null</span> &amp;&amp; mapperClass == <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="comment">// å°† resource èµ‹å€¼ç»™ ErrorContext ä¸­  </span></span><br><span class="line">          ErrorContext.instance().resource(resource);</span><br><span class="line">     <span class="comment">// è¯»å–æ–‡ä»¶.       </span></span><br><span class="line">          InputStream inputStream = Resources.getResourceAsStream(resource);</span><br><span class="line"><span class="comment">// ä½¿ç”¨ XMLMapperBuilder æ¥å¯¹è§£æxmlå†…å®¹.            </span></span><br><span class="line">          XMLMapperBuilder mapperParser = <span class="keyword">new</span> XMLMapperBuilder(inputStream, configuration, resource, configuration.getSqlFragments());</span><br><span class="line">          mapperParser.parse();</span><br><span class="line"><span class="comment">// url å¤„ç†            </span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (resource == <span class="keyword">null</span> &amp;&amp; url != <span class="keyword">null</span> &amp;&amp; mapperClass == <span class="keyword">null</span>) &#123;</span><br><span class="line">          ErrorContext.instance().resource(url);</span><br><span class="line">          InputStream inputStream = Resources.getUrlAsStream(url);</span><br><span class="line">          XMLMapperBuilder mapperParser = <span class="keyword">new</span> XMLMapperBuilder(inputStream, configuration, url, configuration.getSqlFragments());</span><br><span class="line">          mapperParser.parse();</span><br><span class="line"><span class="comment">// mapperClass å¤„ç†            </span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (resource == <span class="keyword">null</span> &amp;&amp; url == <span class="keyword">null</span> &amp;&amp; mapperClass != <span class="keyword">null</span>) &#123;</span><br><span class="line">          Class&lt;?&gt; mapperInterface = Resources.classForName(mapperClass);</span><br><span class="line">          configuration.addMapper(mapperInterface);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> BuilderException(<span class="string">&quot;A mapper element may only specify a url, resource or class, but not more than one.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-----------------------</span><br><span class="line"><span class="comment">// è¿™é‡Œæˆ‘ä»¬è·Ÿè¿› mapperParser.parse() æ–¹æ³•æ¥</span></span><br><span class="line"><span class="comment">// org.apache.ibatis.builder.xml.XMLMapperBuilder</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parse</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// åˆ¤æ–­ configuration çš„ loadedResources æ˜¯å¦å«æœ‰è¯¥å€¼,å¦‚æœä¸å«æœ‰çš„è¯,å°±ä¼šå»è§£æ.  </span></span><br><span class="line">    <span class="keyword">if</span> (!configuration.isResourceLoaded(resource)) &#123;</span><br><span class="line"><span class="comment">// å¯¹mapper æ ‡ç­¾è¿›è¡Œè§£æ        </span></span><br><span class="line">      configurationElement(parser.evalNode(<span class="string">&quot;/mapper&quot;</span>));</span><br><span class="line">      configuration.addLoadedResource(resource);</span><br><span class="line">      bindMapperForNamespace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    parsePendingResultMaps();</span><br><span class="line">    parsePendingCacheRefs();</span><br><span class="line">    parsePendingStatements();</span><br><span class="line">  &#125;    </span><br><span class="line"></span><br><span class="line">-----------------------------------</span><br><span class="line"><span class="comment">//   configurationElement æ–¹æ³•</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">configurationElement</span><span class="params">(XNode context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"> <span class="comment">// è·å– namespace       </span></span><br><span class="line">      String namespace = context.getStringAttribute(<span class="string">&quot;namespace&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> (namespace == <span class="keyword">null</span> || namespace.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BuilderException(<span class="string">&quot;Mapper&#x27;s namespace cannot be empty&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line"><span class="comment">//  MapperBuilderAssistant å°† namespace ç»‘å®šåˆ°è¯¥ç±»çš„å‚æ•°ä¸­æ¥.        </span></span><br><span class="line">      builderAssistant.setCurrentNamespace(namespace);</span><br><span class="line">  </span><br><span class="line">   <span class="comment">// è¿™é‡Œçš„ cache-ref / cache éƒ½æ˜¯æš‚æ—¶æ²¡æœ‰é…ç½®çš„.     </span></span><br><span class="line">      cacheRefElement(context.evalNode(<span class="string">&quot;cache-ref&quot;</span>));</span><br><span class="line">      cacheElement(context.evalNode(<span class="string">&quot;cache&quot;</span>));</span><br><span class="line">        </span><br><span class="line"> <span class="comment">//  /mapper/parameterMap ä¹Ÿæ˜¯æš‚æ—¶æ²¡æœ‰é…ç½®çš„  </span></span><br><span class="line">      parameterMapElement(context.evalNodes(<span class="string">&quot;/mapper/parameterMap&quot;</span>));</span><br><span class="line">        </span><br><span class="line"><span class="comment">// resultMap æ˜¯å¯¹å¯¹è±¡å­—æ®µçš„æ˜ å°„</span></span><br><span class="line"><span class="comment">// mapper/sql æ˜¯å¯¹ä¸€äº›å…¬ç”¨çš„sqlè¿›è¡ŒæŠ½å–</span></span><br><span class="line"><span class="comment">// äºŒè€…æš‚æ—¶éƒ½æ²¡æœ‰é…ç½®        </span></span><br><span class="line">      resultMapElements(context.evalNodes(<span class="string">&quot;/mapper/resultMap&quot;</span>));</span><br><span class="line">      sqlElement(context.evalNodes(<span class="string">&quot;/mapper/sql&quot;</span>));</span><br><span class="line"><span class="comment">// è·å– select / insert / update / delete ç­‰ æ ‡ç­¾.        </span></span><br><span class="line">      buildStatementFromContext(context.evalNodes(<span class="string">&quot;select|insert|update|delete&quot;</span>));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BuilderException(<span class="string">&quot;Error parsing Mapper XML. The XML location is &#x27;&quot;</span> + resource + <span class="string">&quot;&#x27;. Cause: &quot;</span> + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;    </span><br><span class="line"></span><br><span class="line"><span class="comment">// å¾€ä¸‹è·Ÿæ–¹æ³•</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">buildStatementFromContext</span><span class="params">(List&lt;XNode&gt; list, String requiredDatabaseId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (XNode context : list) &#123;</span><br><span class="line">      <span class="keyword">final</span> XMLStatementBuilder statementParser = <span class="keyword">new</span> XMLStatementBuilder(configuration, builderAssistant, context, requiredDatabaseId);</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        statementParser.parseStatementNode();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IncompleteElementException e) &#123;</span><br><span class="line">        configuration.addIncompleteStatement(statementParser);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></div></figure>

</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/11/04/spring/SpringBoot%E5%8A%A8%E6%80%81%E6%B7%BB%E5%8A%A0%E6%8E%A5%E5%8F%A3/">SpringBootåŠ¨æ€æ·»åŠ æ¥å£</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">å‘è¡¨äº</span><span class="post-meta-item__value">2021-11-04</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">æ›´æ–°äº</span><span class="post-meta-item__value">2021-11-04</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">å­—æ•°ç»Ÿè®¡</span><span class="post-meta-item__value">1.4k</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="far fa-clock"></i></span><span class="post-meta-item__info">é˜…è¯»æ—¶é•¿</span><span class="post-meta-item__value">11åˆ†</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h2 id="èƒŒæ™¯"   >
          <a href="#èƒŒæ™¯" class="heading-link"><i class="fas fa-link"></i></a><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2>
      <p>æœ€è¿‘çœ‹äº†å…¬å¸çš„äº§å“,æœ‰ä¸€ä¸ªè¿™æ ·çš„åŠ¨æ€,å°±æ˜¯æ ¹æ®inputè¾“å…¥çš„å†…å®¹,è¿›è¡ŒåŠ¨æ€æ¥å£çš„æ·»åŠ .</p>
<p>æ¯”å¦‚ æˆ‘åœ¨æ²¡æœ‰æ·»åŠ ä¹‹å‰,è®¿é—® <span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://localhost:8080/test" >http://localhost:8080/test</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> è¯¥åœ°å€æ˜¯404, äºæ˜¯é€šè¿‡inputçš„è¾“å…¥åˆ›å»º,å°±ç›¸å½“äºåŠ¨æ€æ·»åŠ äº†ä¸€ä¸ªæ¥å£,äºæ˜¯å°±å¯ä»¥è®¿é—®äº†.</p>
<p>å®ç°çš„æ–¹å¼æœ‰å¾ˆå¤šç§, å…·ä½“çš„æƒ³è¦çš„æ•ˆæœè‚¯å®šæ˜¯éœ€è¦æ ¹æ®è‡ªå·±çš„ä¸šåŠ¡è§’åº¦æ¥.</p>

        <h2 id="å®ç°æ€è·¯"   >
          <a href="#å®ç°æ€è·¯" class="heading-link"><i class="fas fa-link"></i></a><a href="#å®ç°æ€è·¯" class="headerlink" title="å®ç°æ€è·¯"></a>å®ç°æ€è·¯</h2>
      <p>è¿™é‡Œæ˜¯è¯´ä¸‹ä¸ªäººçš„å®ç°æ€è·¯ :</p>
<ul>
<li>æ–¹æ¡ˆä¸€ : å…ˆå®šä¹‰å¥½ç±»,ç„¶åä½¿ç”¨åå°„æ ¹æ®å®šä¹‰çš„ç±»,åˆ›å»ºå¥½ä¸€ä¸ªå¯¹è±¡å‡ºæ¥,ç„¶åå°†è¿™ä¸ªå¯¹è±¡ç»™æ³¨å…¥åˆ°Springå®¹å™¨ä¸­æ¥,è¿™é‡Œä¸ä»…ä»…æ˜¯æ³¨å…¥è¿›æ¥è¿™ä¹ˆç®€å•,è¿˜æ˜¯éœ€è¦ç»è¿‡ MVC(ä¹Ÿå°±æ˜¯Controllerç­‰æ³¨è§£çš„åŒ¹é…æ“ä½œ)æ¥å®ç°</li>
<li>æ–¹æ¡ˆäºŒ : åŸºäºè¯·æ±‚404çš„æ‹¦æˆªæ¥ç°å®. æ¯”å¦‚ä½ æ–°æ·»åŠ çš„æ¥å£è®¿é—®è‚¯å®šæ˜¯404,äºæ˜¯æˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªæ‹¦æˆª,ç„¶åè·å–å‡ºè¯·æ±‚çš„è·¯å¾„,æ ¹æ®æå‰å®šå¥½çš„ä¸€äº›è®¾ç½®,è¿›è¡Œé€»è¾‘çš„å¤„ç†.</li>
</ul>
<p>è¿™é‡Œè‚¯å®šè¿˜ä¼šæœ‰å¾ˆå¤šå¥½çš„å®ç°æ€è·¯,å¹¶ä¸”åŸºäºæ¯ä¸ªæ¡†æ¶éƒ½æ˜¯ä¸ä¸€æ ·çš„,è¿™é‡Œæ›´å¤šçš„æ˜¯åŸºäº SpringBootæ¡†æ¶æ¥å®ç°è¿™ä¸ªæ€è·¯çš„.</p>

        <h2 id="ä»£ç å®ç°"   >
          <a href="#ä»£ç å®ç°" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h2>
      
        <h3 id="åŸºäºåå°„åˆ›å»ºbeanæ³¨å…¥ä»£ç å®ç°"   >
          <a href="#åŸºäºåå°„åˆ›å»ºbeanæ³¨å…¥ä»£ç å®ç°" class="heading-link"><i class="fas fa-link"></i></a><a href="#åŸºäºåå°„åˆ›å»ºbeanæ³¨å…¥ä»£ç å®ç°" class="headerlink" title="åŸºäºåå°„åˆ›å»ºbeanæ³¨å…¥ä»£ç å®ç°"></a>åŸºäºåå°„åˆ›å»ºbeanæ³¨å…¥ä»£ç å®ç°</h3>
      <p>å®šä¹‰ä¸€ä¸ªç±»çš„æ¨¡æ¿</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String templateValue = <span class="string">&quot;import org.springframework.web.bind.annotation.GetMapping;\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;import org.springframework.web.bind.annotation.RequestMapping;\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;import org.springframework.web.bind.annotation.RestController;\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;@RestController\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;@RequestMapping(\&quot;/test\&quot;)\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;public class TestController &#123;\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;    @GetMapping(\&quot;/test\&quot;)\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;    public String test()&#123;\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;        return \&quot;æµ‹è¯•Testæ¥å£\&quot;;\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;    &#125;\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;&#125;&quot;</span>;</span><br></pre></td></tr></table></div></figure>

<p>æä¾›ä¸€ä¸ªæ¥å£æ¥åå°„åˆ›å»ºå¯¹è±¡å¹¶ä¸”æ³¨å…¥åˆ°springå®¹å™¨ä¸­æ¥:</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/create&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createTemplate</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        Map&lt;String, <span class="keyword">byte</span>[]&gt; bytecode = DynamicLoader.compile(<span class="string">&quot;TestController.java&quot;</span>, templateValue);</span><br><span class="line">        MemoryClassLoader classLoader = <span class="keyword">new</span> MemoryClassLoader(bytecode);</span><br><span class="line">        Class clazz = classLoader.loadClass(<span class="string">&quot;TestController&quot;</span>);</span><br><span class="line">        Object object = clazz.newInstance();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ³¨å…¥ bean å®¹å™¨çš„ä»£ç  : å®¹å™¨ä¸­æ˜¯å­˜åœ¨è¿™ä¸ª bean å¯¹è±¡çš„,ä½†æ˜¯Controllerå´æ²¡æœ‰è®¿é—®åˆ°.</span></span><br><span class="line">        BeanDefinitionBuilder builder = BeanDefinitionBuilder.genericBeanDefinition(object.getClass());</span><br><span class="line">        ConfigurableApplicationContext context = springUtils.getContext();</span><br><span class="line">        DefaultListableBeanFactory beanFactory = (DefaultListableBeanFactory) context.getBeanFactory();</span><br><span class="line">        beanFactory.registerBeanDefinition(<span class="string">&quot;testController&quot;</span>,builder.getBeanDefinition());</span><br><span class="line"></span><br><span class="line">        RequestMappingHandlerMapping mappingHandlerMapping = context.getBean(RequestMappingHandlerMapping.class);</span><br><span class="line">        Object oj = context.getBean(<span class="string">&quot;testController&quot;</span>);</span><br><span class="line">        Map&lt;Method, RequestMappingInfo&gt; methods = MethodIntrospector.selectMethods(oj.getClass(),(MethodIntrospector.MetadataLookup&lt;RequestMappingInfo&gt;) method -&gt;&#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                RequestMapping requestMapping = AnnotatedElementUtils.findMergedAnnotation(method, RequestMapping.class);</span><br><span class="line">                RequestMappingInfo.Builder mappping = RequestMappingInfo.paths(requestMapping.path())</span><br><span class="line">                                  .methods(requestMapping.method())</span><br><span class="line">                                  .params(requestMapping.params())</span><br><span class="line">                                  .headers(requestMapping.headers())</span><br><span class="line">                                  .consumes(requestMapping.consumes())</span><br><span class="line">                                  .produces(requestMapping.produces())</span><br><span class="line">                                  .mappingName(requestMapping.name());</span><br><span class="line">                <span class="keyword">return</span> mappping.build();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        Method rmhmMethod = mappingHandlerMapping.getClass()</span><br><span class="line">                            .getDeclaredMethod(<span class="string">&quot;registerHandlerMethod&quot;</span>,<span class="keyword">new</span> Class[]&#123;Object.class, Method.class, Object.class&#125;);</span><br><span class="line"></span><br><span class="line">        rmhmMethod.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        methods.forEach((method,mapping) -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                rmhmMethod.invoke(mappingHandlerMapping,<span class="keyword">new</span> Object[]&#123;oj,method,mapping&#125; );</span><br><span class="line">            &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>

<p>Springå·¥å…·ç±»</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringUtils</span> <span class="keyword">implements</span> <span class="title">ApplicationContextAware</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ApplicationContext context;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        context = applicationContext;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ConfigurableApplicationContext <span class="title">getContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (ConfigurableApplicationContext)context;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContext</span><span class="params">(ApplicationContext context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.context = context;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>åˆ°æ­¤,å°±å¯ä»¥åŠ¨æ€çš„åˆ›å»ºå‡ºä¸€ä¸ªæ¥å£æ¥äº†ã€‚</p>
<p>å½“ç„¶äº†,è¿™é‡Œçš„ä»£ç éƒ½æ˜¯å†™å›ºå®šåœ¨ä»£ç é‡Œé¢çš„,å¯ä»¥æä¾› template æˆ–è€… é€šè¿‡é¡µé¢å®šä¹‰ç»™æ·»åŠ è¿›æ¥, ç„¶åè°ƒç”¨ åå°„/æ³¨å…¥åˆ°Springå®¹å™¨ä¸­ç­‰æ“ä½œå³å¯.</p>

        <h3 id="åŸºäº-404-æ‹¦æˆªè¯·æ±‚"   >
          <a href="#åŸºäº-404-æ‹¦æˆªè¯·æ±‚" class="heading-link"><i class="fas fa-link"></i></a><a href="#åŸºäº-404-æ‹¦æˆªè¯·æ±‚" class="headerlink" title="åŸºäº 404 æ‹¦æˆªè¯·æ±‚"></a>åŸºäº 404 æ‹¦æˆªè¯·æ±‚</h3>
      <p>è¿™æ˜¯ SpringBoot æœ¬æ¥å°±æœ‰çš„ 404 æ‹¦æˆªå®ç°, å¦‚æœä¸åšä»€ä¹ˆå¤„ç†çš„è¯,é‚£ä¹ˆè¿›å…¥åˆ°è¿™é‡Œæ¥çš„urlåœ°å€å°±ä¼šæ˜¯/error,æ˜¯æ— æ³•æ»¡è¶³å®ç°çš„.</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SelfErrorController</span> <span class="keyword">implements</span> <span class="title">ErrorController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String ERROR_PATH = <span class="string">&quot;/error&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Supports the HTML Error View</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(value = ERROR_PATH)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">errorHtml</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        Integer statusCode = (Integer) request.getAttribute(<span class="string">&quot;javax.servlet.error.status_code&quot;</span>);</span><br><span class="line">        String requestURI = request.getRequestURI();</span><br><span class="line">        log.info(<span class="string">&quot;åœ¨SelfErrorControllerä¸­è¯·æ±‚çš„è·¯å¾„ : &#123;&#125; &quot;</span> ,requestURI);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ‹¿åˆ°è·¯å¾„åå°±å¯ä»¥æ‰§è¡Œç›¸åº”çš„ä»£ç é€»è¾‘.</span></span><br><span class="line">        String realUrlName = request.getAttribute(<span class="string">&quot;realName&quot;</span>).toString();</span><br><span class="line">        log.info(<span class="string">&quot;åœ¨SelfErrorControllerä¸­çœŸå®å­˜åœ¨çš„è¯·æ±‚è·¯å¾„æ˜¯ : --&gt; &#123;&#125; &quot;</span> , realUrlName);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(statusCode == <span class="number">401</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span>  <span class="string">&quot;&#123; \&quot;code\&quot;: \&quot;401\&quot;&#125;&quot;</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(statusCode == <span class="number">404</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&#123; \&quot;code\&quot;: \&quot;404\&quot;&#125;&quot;</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(statusCode == <span class="number">403</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&#123; \&quot;code\&quot;: \&quot;403\&quot;&#125;&quot;</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&#123; \&quot;code\&quot;: \&quot;500\&quot;&#125;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getErrorPath</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>å› ä¸ºä¸Šé¢æ— æ³•æ»¡è¶³çš„å‰æä¸‹,æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ‹¦æˆªæ¥é…ç½®åŸæ¥çš„è·¯å¾„.</p>
<p>é…ç½®ç±»:</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyWebAppConfigurer</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> </span>&#123;</span><br><span class="line">        registry.addInterceptor(<span class="keyword">new</span> SelfInterceptor()).addPathPatterns(<span class="string">&quot;/**&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>è‡ªå®šä¹‰æ‹¦æˆªå™¨:</p>
<p>è¿™é‡Œå¯ä»¥çœ‹åˆ°å°†åŸæœ‰çš„è·¯å¾„ç»™setå­—æ®µrealNameäº†.</p>
<p>æ‰€ä»¥åœ¨ä¸Šé¢çš„erroræ¥å£,æˆ‘ä»¬è°ƒç”¨è¿™ä¸ªrealNameå­—æ®µå°±å¯ä»¥è·å–åˆ°äº†åŸæœ‰çš„è·¯å¾„.</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SelfInterceptor</span> <span class="keyword">implements</span> <span class="title">HandlerInterceptor</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span></span><br><span class="line"><span class="params"><span class="function">                             Object handler)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// å‰ç½®æ‹¦æˆªå™¨</span></span><br><span class="line">        log.info(<span class="string">&quot;å‰ç½®æ‹¦æˆªå™¨è°ƒç”¨ : com.iyang.hello.boot.config.SelfInterceptor.preHandle ä¸­æ¥.&quot;</span> );</span><br><span class="line">        String requestURI = request.getRequestURI();</span><br><span class="line">        log.info(<span class="string">&quot;åœ¨preHandleæ–¹æ³•ä¸­æ•æ‰åˆ°çš„è¯·æ±‚è·¯å¾„ : ---&gt; &#123;&#125; &quot;</span> , requestURI);</span><br><span class="line">        <span class="comment">// handler æ˜¯ ResourceHttpRequestHandler</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span></span><br><span class="line"><span class="params"><span class="function">                           Object handler, ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String requestURI = request.getRequestURI();</span><br><span class="line">        request.setAttribute(<span class="string">&quot;realName&quot;</span>,requestURI);</span><br><span class="line">        <span class="keyword">if</span>(response.getStatus() == <span class="number">404</span>)&#123;</span><br><span class="line">            log.info(<span class="string">&quot;çŠ¶æ€æ˜¯404æ­£å¸¸æ“ä½œ&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">&quot;è¯·æ±‚çš„urlè·¯å¾„æ˜¯ ---&gt; &#123;&#125; &quot;</span> , requestURI);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span></span><br><span class="line"><span class="params"><span class="function">                                Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="æ€»ç»“"   >
          <a href="#æ€»ç»“" class="heading-link"><i class="fas fa-link"></i></a><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2>
      <p>è¯¥æŠ€èƒ½çœ‹åˆ°æ¯”è¾ƒæœ‰æ„æ€,å…·ä½“çš„å®ç°å’Œè®¾è®¡æ€è·¯å…¶å®æ˜¯æœ‰å¾ˆå¤šç§çš„,å…·ä½“å¾—çœ‹é¡¹ç›®çš„ä¸šåŠ¡æ˜¯ä¸æ˜¯éœ€è¦ä½¿ç”¨.</p>
<p>å¹¶ä¸”å®ç°çš„æ€è·¯å¹¶ä¸æ˜¯åªæœ‰è¿™ä¸€ç§,è‚¯å®šæ˜¯è¿˜æœ‰å¾ˆå¤šç§çš„.</p>
<p>é€‚åˆè‡ªå·±çš„ä¸šåŠ¡æ˜¯æœ€å¥½çš„.</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/11/04/spring/spring%E7%9A%84refresh%E6%96%B9%E6%B3%95%E9%98%85%E8%AF%BB/">springçš„refreshæ–¹æ³•é˜…è¯»</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">å‘è¡¨äº</span><span class="post-meta-item__value">2021-11-04</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">æ›´æ–°äº</span><span class="post-meta-item__value">2021-11-04</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">å­—æ•°ç»Ÿè®¡</span><span class="post-meta-item__value">9k</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="far fa-clock"></i></span><span class="post-meta-item__info">é˜…è¯»æ—¶é•¿</span><span class="post-meta-item__value">78åˆ†</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h4 id="å‰è¨€"   >
          <a href="#å‰è¨€" class="heading-link"><i class="fas fa-link"></i></a><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h4>
      <p>è¿™é‡Œæ˜¯ç›¸å¯¹ä¸Šä¸€æ¬¡å†æ¬¡çš„é˜…è¯»å’Œè®°å½•,æ¯”ä¸Šæ¬¡æœ‰äº†æ›´æ·±å…¥çš„ç†è§£.</p>
<p>è¿™é‡Œæ˜¯å†æ¬¡æ•´ç†çš„é˜…è¯» Spring çš„æºç , ç›¸å¯¹æ¯”ä¸Šæ¬¡çš„é˜…è¯»ï¼Œæˆ‘å¸Œæœ›è¿™æ¬¡å¯ä»¥æ›´æ¸…æ™°&amp;æ›´æ·±åˆ»çš„ç†è§£Spring,ä¹Ÿä¸ä»…ä»…ä¼šä»ä¸€ä¸ªæ¡ˆä¾‹æ¥è¿›è¡Œåˆ†æï¼Œä¼šç»“åˆå¤šæ–¹é¢çš„çŸ¥è¯†æ¥è¿›è¡Œæ•´ç†åˆ†æ.</p>
<p> è¿™é‡Œæ”¾ä¸Šä¹‹å‰é˜…è¯»çš„æ¯”ä¾‹ : <span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/baoyang23/source-notes/tree/master/java/spring_bean" >https://github.com/baoyang23/source-notes/tree/master/java/spring_bean</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p> è¯¥ç›®å½•ä¸‹é¢æœ‰ : bean/get/extend ä¸‰ä¸ªä¸»è¦åœ°æ–¹çš„åˆ†æ.</p>
<p> æ­¤æ¨¡å—è¿˜æ˜¯è®²è¿° æ•´ä½“çš„ flow,åé¢ä¼šå¯¹å•ä¸ªè¿›è¡Œåˆ†æ&amp;Springæä¾›æ€ä¹ˆæ ·çš„æ‰©å±•æ–¹å¼æ¥è¿›è¡Œå¢å¼ºæ‰©å±•ç­‰.</p>
<p>æ¡ˆä¾‹å…¥é—¨æ“ä½œçš„è¯,å¯ä»¥å‚è€ƒä¹‹å‰çš„åšå®¢.</p>

        <h4 id="åˆ†æ"   >
          <a href="#åˆ†æ" class="heading-link"><i class="fas fa-link"></i></a><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h4>
      <p> è¿™é‡Œæˆ‘ä»¬å…ˆä¸å¿™è¿™å…¶ä»–ç±»å‹çš„beanåˆ†æ, å°±å¯¹æˆ‘ä»¬ä½œä¸º config çš„ bean è¿›è¡Œåˆ†æ. å…ˆå•ä¸ªåˆ†æå®¹æ˜“ç†è§£äº›.</p>
<p> å…¥å£ç±» :</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InitWorkFlowSpring</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        AnnotationConfigApplicationContext context =</span><br><span class="line">                <span class="keyword">new</span> AnnotationConfigApplicationContext(YangBeanScannerConfig.class);</span><br><span class="line">        YangBeanScannerConfig yangBeanScannerConfig = context.getBean(YangBeanScannerConfig.class);</span><br><span class="line">        yangBeanScannerConfig.say();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p> é…ç½®ç±»:</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ComponentScan(basePackages = &quot;com.iyang.spring&quot;)</span></span><br><span class="line"><span class="meta">@Description(value = &quot;This is GavinYang DemoWorld.&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">YangBeanScannerConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">YangBeanScannerConfig</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;é…ç½®æ‰«æåˆå§‹åŒ–æ‰“å°&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">say</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;æˆ‘æ˜¯ä»Springå®¹å™¨ä¸­è·å–å‡ºæ¥çš„&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>å¯ä»¥çœ‹åˆ°ï¼Œå½“æˆ‘ä»¬å¯åŠ¨ main æ–¹æ³•çš„æ—¶å€™ï¼Œæ˜¯å¯ä»¥çœ‹åˆ° YangBeanScannerConfig ä¸­æ„é€ å‡½æ•°æ‰“å°çš„å†…å®¹å’Œè°ƒç”¨sayæ–¹æ³•æ‰“å°å‡ºæ¥çš„å†…å®¹.</p>
<p>åŸºäºè¿™ä¸ªåŸºç¡€ä¸Š,æˆ‘ä»¬debugä¸€å±‚ä¸€å±‚çš„èµ°è¿›å»çœ‹,Springåšäº†ä»€ä¹ˆäº‹æƒ….</p>
<p>å…ˆè¿›å…¥åˆ°æˆ‘ä»¬newå‡ºæ¥çš„AnnotationConfigApplicationContextä¸­æ¥</p>
<p>è°ƒç”¨è‡ªèº«çš„æ— å‚æ„é€ å‡½æ•°</p>
<p>è°ƒç”¨ register æ³¨å†Œæ–¹æ³•</p>
<p>æœ€åè°ƒç”¨ä¸€ä¸ª refresh, refresh æ–¹æ³•ä¸­æ˜¯åšäº†å¾ˆå¤šäº‹çš„.</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">AnnotationConfigApplicationContext</span><span class="params">(Class&lt;?&gt;... componentClasses)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">this</span>();</span><br><span class="line">   register(componentClasses);</span><br><span class="line">   refresh();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>é‚£ä¹ˆæœ‰äº†å…¥å£ï¼Œæˆ‘ä»¬å°±æ ¹æ®è¿™äº›æ–¹æ³•æ¥ä¸€ä¸ªä¸€ä¸ªçš„åˆ†æ.</p>

        <h4 id="this-æ–¹æ³•-â€”-gt-org-springframework-context-annotation-AnnotationConfigApplicationContext-AnnotationConfigApplicationContext"   >
          <a href="#this-æ–¹æ³•-â€”-gt-org-springframework-context-annotation-AnnotationConfigApplicationContext-AnnotationConfigApplicationContext" class="heading-link"><i class="fas fa-link"></i></a><a href="#this-æ–¹æ³•-â€”-gt-org-springframework-context-annotation-AnnotationConfigApplicationContext-AnnotationConfigApplicationContext" class="headerlink" title="this() æ–¹æ³• â€”&gt; org.springframework.context.annotation.AnnotationConfigApplicationContext#AnnotationConfigApplicationContext()"></a>this() æ–¹æ³• â€”&gt; org.springframework.context.annotation.AnnotationConfigApplicationContext#AnnotationConfigApplicationContext()</h4>
      <p>å…ˆæ¥çœ‹ this æ–¹æ³•åšäº†ä»€ä¹ˆäº‹æƒ….</p>
<p>åˆ›å»ºäº†äºŒä¸ªå¯¹è±¡ï¼Œåˆ†åˆ«æ˜¯ æ³¨è§£bdè¯»å–/ç±»è·¯å£dbæ‰«æ.</p>
<p>æ¯”å¦‚æœ‰æ„æ€çš„æ˜¯,ä¼ å…¥this(AnnotationConfigApplicationContext), ç„¶åè¿”å›æ¥çš„reader/scanneråˆå±äºthis.ä¹Ÿæ˜¯ç›¸äº’ä¹‹é—´å„è‡ªéƒ½æŒæœ‰å„è‡ªçš„å¼•ç”¨.</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">AnnotationConfigApplicationContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">this</span>.reader = <span class="keyword">new</span> AnnotatedBeanDefinitionReader(<span class="keyword">this</span>);</span><br><span class="line">   <span class="keyword">this</span>.scanner = <span class="keyword">new</span> ClassPathBeanDefinitionScanner(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="new-AnnotatedBeanDefinitionReader"   >
          <a href="#new-AnnotatedBeanDefinitionReader" class="heading-link"><i class="fas fa-link"></i></a><a href="#new-AnnotatedBeanDefinitionReader" class="headerlink" title="new AnnotatedBeanDefinitionReader"></a>new AnnotatedBeanDefinitionReader</h5>
      <p>æ¥ï¼Œçœ‹ä¸‹newä¸€ä¸ªå¯¹è±¡åšäº†ä»€ä¹ˆäº‹æƒ….</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">AnnotatedBeanDefinitionReader</span><span class="params">(BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line"><span class="comment">// è¿™é‡Œçš„ getOrCreateEnvironment æ–¹æ³•ä¸­,AnnotationConfigApplicationContextæ˜¯EnvironmentCapableçš„å­ç±»,</span></span><br><span class="line"><span class="comment">// æ‰€ä»¥Environmentä¹Ÿæ˜¯ä»AnnotationConfigApplicationContextä¸­è·å–å‡ºæ¥çš„.    </span></span><br><span class="line">   <span class="keyword">this</span>(registry, getOrCreateEnvironment(registry));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">--------------</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">AnnotatedBeanDefinitionReader</span><span class="params">(BeanDefinitionRegistry registry, Environment environment)</span> </span>&#123;</span><br><span class="line"> <span class="comment">// æ£€éªŒ registry/environmentéƒ½ä¸èƒ½ä¸ºnull.   </span></span><br><span class="line">		Assert.notNull(registry, <span class="string">&quot;BeanDefinitionRegistry must not be null&quot;</span>);</span><br><span class="line">		Assert.notNull(environment, <span class="string">&quot;Environment must not be null&quot;</span>);</span><br><span class="line">		<span class="keyword">this</span>.registry = registry;</span><br><span class="line"><span class="comment">// è¿™é‡Œå°† registry/environment ç»™ä¼ å…¥æ„é€ åˆ° org.springframework.context.annotation.ConditionEvaluator ä¸­æ¥.</span></span><br><span class="line"><span class="comment">// ConditionEvaluatoråˆå€ŸåŠ©org.springframework.context.annotation.ConditionEvaluator.ConditionContextImpl#ConditionContextImpl æ¥å­˜å‚¨è¿™äº›ä¿¡æ¯,æ‰€ä»¥è¿™é‡Œæœ€åçš„ä¿¡æ¯æ˜¯åœ¨ConditionContextImplä¸­æ¥äº†.    </span></span><br><span class="line">		<span class="keyword">this</span>.conditionEvaluator = <span class="keyword">new</span> ConditionEvaluator(registry, environment, <span class="keyword">null</span>);</span><br><span class="line"><span class="comment">// org.springframework.context.annotation.AnnotationConfigUtils#registerAnnotationConfigProcessors(org.springframework.beans.factory.support.BeanDefinitionRegistry, java.lang.Object)</span></span><br><span class="line"><span class="comment">// ä»è¯¥æ–¹æ³•çš„åå­—ä¸Šçœ‹,æ˜¯å¯¹æ³¨å†Œæ³¨è§£é…ç½®è¿›è¡Œå¤„ç†.    </span></span><br><span class="line">		AnnotationConfigUtils.registerAnnotationConfigProcessors(<span class="keyword">this</span>.registry);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h6 id="org-springframework-context-annotation-AnnotationConfigUtils-registerAnnotationConfigProcessors-org-springframework-beans-factory-support-BeanDefinitionRegistry-java-lang-Object-åˆ†æ"   >
          <a href="#org-springframework-context-annotation-AnnotationConfigUtils-registerAnnotationConfigProcessors-org-springframework-beans-factory-support-BeanDefinitionRegistry-java-lang-Object-åˆ†æ" class="heading-link"><i class="fas fa-link"></i></a><a href="#org-springframework-context-annotation-AnnotationConfigUtils-registerAnnotationConfigProcessors-org-springframework-beans-factory-support-BeanDefinitionRegistry-java-lang-Object-åˆ†æ" class="headerlink" title="org.springframework.context.annotation.AnnotationConfigUtils#registerAnnotationConfigProcessors(org.springframework.beans.factory.support.BeanDefinitionRegistry, java.lang.Object) åˆ†æ"></a>org.springframework.context.annotation.AnnotationConfigUtils#registerAnnotationConfigProcessors(org.springframework.beans.factory.support.BeanDefinitionRegistry, java.lang.Object) åˆ†æ</h6>
      <p>è¿™é‡Œæ ¹æ®æˆ‘ä»¬çš„æ¡ˆåˆ—ï¼Œä¼ å…¥è¿›æ¥çš„sourceæ˜¯null.</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Set&lt;BeanDefinitionHolder&gt; <span class="title">registerAnnotationConfigProcessors</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">      BeanDefinitionRegistry registry, <span class="meta">@Nullable</span> Object source)</span> </span>&#123;</span><br><span class="line"><span class="comment">// æ ¹æ® registry çš„ç±»å‹æ¥è·å– DefaultListableBeanFactory.</span></span><br><span class="line"><span class="comment">// è¿™é‡Œçš„registryå±äºGenericApplicationContext,è°ƒç”¨å…¶getDefaultListableBeanFactoryæ¥è·å–.    </span></span><br><span class="line">   DefaultListableBeanFactory beanFactory = unwrapDefaultListableBeanFactory(registry);</span><br><span class="line">   <span class="keyword">if</span> (beanFactory != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="comment">// beanFactory.getDependencyComparator() è¿”å›çš„æ˜¯null,æ»¡è¶³æ¡ä»¶.       </span></span><br><span class="line">      <span class="keyword">if</span> (!(beanFactory.getDependencyComparator() <span class="keyword">instanceof</span> AnnotationAwareOrderComparator)) &#123;</span><br><span class="line"><span class="comment">// è®¾ç½® AnnotationAwareOrderComparator åˆ°beanFactoryä¸­æ¥          </span></span><br><span class="line">         beanFactory.setDependencyComparator(AnnotationAwareOrderComparator.INSTANCE);</span><br><span class="line">      &#125;</span><br><span class="line"><span class="comment">// getæ–¹æ³•è·å–å‡ºæ¥çš„æ˜¯SimpleAutowireCandidateResolver,       </span></span><br><span class="line">      <span class="keyword">if</span> (!(beanFactory.getAutowireCandidateResolver() <span class="keyword">instanceof</span> ContextAnnotationAutowireCandidateResolver)) &#123;</span><br><span class="line"><span class="comment">// è®¾ç½®ContextAnnotationAutowireCandidateResolveråˆ°beanFactoryä¸­æ¥.          </span></span><br><span class="line">         beanFactory.setAutowireCandidateResolver(<span class="keyword">new</span> ContextAnnotationAutowireCandidateResolver());</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   Set&lt;BeanDefinitionHolder&gt; beanDefs = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(<span class="number">8</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯ä»¥çœ‹åˆ°æ¯ä¸ªéƒ½æœ‰ internal æ¥ç‰¹æ„è¡¨æ˜å†…éƒ¨çš„æ„æ€.    </span></span><br><span class="line"><span class="comment">// org.springframework.context.annotation.internalConfigurationAnnotationProcessor ---&gt;  ConfigurationClassPostProcessor</span></span><br><span class="line"><span class="comment">// org.springframework.context.annotation.internalAutowiredAnnotationProcessor  --&gt; AutowiredAnnotationBeanPostProcessor</span></span><br><span class="line"><span class="comment">// org.springframework.context.annotation.internalCommonAnnotationProcessor   ---&gt; CommonAnnotationBeanPostProcessor </span></span><br><span class="line"><span class="comment">// org.springframework.context.annotation.internalPersistenceAnnotationProcessor  ---&gt; PersistenceAnnotationBeanPostProcessor</span></span><br><span class="line"><span class="comment">// org.springframework.context.event.internalEventListenerProcessor   ---&gt; EventListenerMethodProcessor</span></span><br><span class="line"><span class="comment">// org.springframework.context.event.internalEventListenerFactory  --- &gt; DefaultEventListenerFactory</span></span><br><span class="line">   <span class="keyword">if</span> (!registry.containsBeanDefinition(CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME)) &#123;</span><br><span class="line">      RootBeanDefinition def = <span class="keyword">new</span> RootBeanDefinition(ConfigurationClassPostProcessor.class);</span><br><span class="line">      def.setSource(source);</span><br><span class="line">      beanDefs.add(registerPostProcessor(registry, def, CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (!registry.containsBeanDefinition(AUTOWIRED_ANNOTATION_PROCESSOR_BEAN_NAME)) &#123;</span><br><span class="line">      RootBeanDefinition def = <span class="keyword">new</span> RootBeanDefinition(AutowiredAnnotationBeanPostProcessor.class);</span><br><span class="line">      def.setSource(source);</span><br><span class="line">      beanDefs.add(registerPostProcessor(registry, def, AUTOWIRED_ANNOTATION_PROCESSOR_BEAN_NAME));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Check for JSR-250 support, and if present add the CommonAnnotationBeanPostProcessor.</span></span><br><span class="line">   <span class="keyword">if</span> (jsr250Present &amp;&amp; !registry.containsBeanDefinition(COMMON_ANNOTATION_PROCESSOR_BEAN_NAME)) &#123;</span><br><span class="line">      RootBeanDefinition def = <span class="keyword">new</span> RootBeanDefinition(CommonAnnotationBeanPostProcessor.class);</span><br><span class="line">      def.setSource(source);</span><br><span class="line">      beanDefs.add(registerPostProcessor(registry, def, COMMON_ANNOTATION_PROCESSOR_BEAN_NAME));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Check for JPA support, and if present add the PersistenceAnnotationBeanPostProcessor.</span></span><br><span class="line">   <span class="keyword">if</span> (jpaPresent &amp;&amp; !registry.containsBeanDefinition(PERSISTENCE_ANNOTATION_PROCESSOR_BEAN_NAME)) &#123;</span><br><span class="line">      RootBeanDefinition def = <span class="keyword">new</span> RootBeanDefinition();</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         def.setBeanClass(ClassUtils.forName(PERSISTENCE_ANNOTATION_PROCESSOR_CLASS_NAME,</span><br><span class="line">               AnnotationConfigUtils.class.getClassLoader()));</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (ClassNotFoundException ex) &#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">               <span class="string">&quot;Cannot load optional framework class: &quot;</span> + PERSISTENCE_ANNOTATION_PROCESSOR_CLASS_NAME, ex);</span><br><span class="line">      &#125;</span><br><span class="line">      def.setSource(source);</span><br><span class="line">      beanDefs.add(registerPostProcessor(registry, def, PERSISTENCE_ANNOTATION_PROCESSOR_BEAN_NAME));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (!registry.containsBeanDefinition(EVENT_LISTENER_PROCESSOR_BEAN_NAME)) &#123;</span><br><span class="line">      RootBeanDefinition def = <span class="keyword">new</span> RootBeanDefinition(EventListenerMethodProcessor.class);</span><br><span class="line">      def.setSource(source);</span><br><span class="line">      beanDefs.add(registerPostProcessor(registry, def, EVENT_LISTENER_PROCESSOR_BEAN_NAME));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (!registry.containsBeanDefinition(EVENT_LISTENER_FACTORY_BEAN_NAME)) &#123;</span><br><span class="line">      RootBeanDefinition def = <span class="keyword">new</span> RootBeanDefinition(DefaultEventListenerFactory.class);</span><br><span class="line">      def.setSource(source);</span><br><span class="line">      beanDefs.add(registerPostProcessor(registry, def, EVENT_LISTENER_FACTORY_BEAN_NAME));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> beanDefs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>è¿™é‡Œéƒ½æ˜¯å…ˆåˆ¤æ–­è¿™äº›å†…éƒ¨çš„bean,æ˜¯ä¸æ˜¯å·²ç»åœ¨ registry ä¸­å·²ç»å­˜åœ¨äº†,å¦‚æœæ²¡æœ‰å­˜åœ¨çš„è¯ï¼Œå°±ä¼šåˆ©ç”¨ç±»ä¿¡æ¯æ¥æ„é€ å‡ºä¸€ä¸ªRootBeanDefinitionæ¥,æ¥ç€å°±æ˜¯è°ƒç”¨ registerPostProcessor æ–¹æ³•ç»™æ³¨å†Œåˆ° registry ä¸­æ¥.</p>
<p>æœ€åè¿”å›ä¸€ä¸ªæ³¨å†Œè¿‡çš„ bean çš„ Set é›†åˆå›å».</p>
<p>æ€»ç»“ä¸‹è¿™é‡Œå°±æ˜¯ä¸ºäº†ç»™springå®¹å™¨ä¸­æ³¨å†Œä¸€äº›å†…éƒ¨çš„ bean è¿›å». è¿™äº›æ³¨å†Œè¿›å»çš„bean,éƒ½æ˜¯åœ¨åé¢åˆå§‹åŒ–bean&amp;è§£æbeanç­‰æƒ…å†µæœ‰ä½¿ç”¨åˆ°çš„.</p>

        <h5 id="new-ClassPathBeanDefinitionScanner-æ–¹æ³•"   >
          <a href="#new-ClassPathBeanDefinitionScanner-æ–¹æ³•" class="heading-link"><i class="fas fa-link"></i></a><a href="#new-ClassPathBeanDefinitionScanner-æ–¹æ³•" class="headerlink" title="new ClassPathBeanDefinitionScanner() æ–¹æ³•"></a>new ClassPathBeanDefinitionScanner() æ–¹æ³•</h5>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ClassPathBeanDefinitionScanner</span><span class="params">(BeanDefinitionRegistry registry, <span class="keyword">boolean</span> useDefaultFilters)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">this</span>(registry, useDefaultFilters, getOrCreateEnvironment(registry));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-----------------------------------------------------</span><br><span class="line"><span class="comment">// æœ€åèµ°åˆ° org.springframework.context.annotation.ClassPathBeanDefinitionScanner#ClassPathBeanDefinitionScanner(org.springframework.beans.factory.support.BeanDefinitionRegistry, boolean, org.springframework.core.env.Environment, org.springframework.core.io.ResourceLoader) æ„é€ å‡½æ•°æ¥.    </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ClassPathBeanDefinitionScanner</span><span class="params">(BeanDefinitionRegistry registry, <span class="keyword">boolean</span> useDefaultFilters,</span></span></span><br><span class="line"><span class="params"><span class="function">			Environment environment, <span class="meta">@Nullable</span> ResourceLoader resourceLoader)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		Assert.notNull(registry, <span class="string">&quot;BeanDefinitionRegistry must not be null&quot;</span>);</span><br><span class="line"><span class="comment">// èµ‹å€¼ registry æ¥.    </span></span><br><span class="line">		<span class="keyword">this</span>.registry = registry;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (useDefaultFilters) &#123;</span><br><span class="line"><span class="comment">// æ·»åŠ  filter åˆ° includeFilters ä¸­æ¥.</span></span><br><span class="line"><span class="comment">// AnnotationTypeFilter(Component.class)</span></span><br><span class="line"><span class="comment">// AnnotationTypeFilter(((Class&lt;? extends Annotation&gt;) ClassUtils.forName(&quot;javax.annotation.ManagedBean&quot;, cl)     </span></span><br><span class="line"><span class="comment">// ç­‰ä¿¡æ¯è¿›æ¥      </span></span><br><span class="line">			registerDefaultFilters();</span><br><span class="line">		&#125;</span><br><span class="line"><span class="comment">// org.springframework.context.annotation.ClassPathScanningCandidateComponentProvider#setEnvironment</span></span><br><span class="line"><span class="comment">// è®¾ç½® enviornmentåˆ°çˆ¶ç±»ä¸­æ¥.    </span></span><br><span class="line">		setEnvironment(environment);</span><br><span class="line"><span class="comment">// è¿™é‡Œä¹Ÿæ˜¯è¿™æ˜¯åˆ°çˆ¶ç±»æ¥äº†.</span></span><br><span class="line"><span class="comment">// è¿”å›çš„resourcePatternResolveræ˜¯AnnotationConfigApplicationContext.</span></span><br><span class="line"><span class="comment">// metadataReaderFactory æ˜¯ CachingMetadataReaderFactory å¯¹è±¡æ¥.</span></span><br><span class="line"><span class="comment">// componentsIndex æ˜¯ null.    </span></span><br><span class="line">		setResourceLoader(resourceLoader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>è¯¥æ–¹æ³•å¯ä»¥çœ‹åˆ°,æ·»åŠ äº†ä¸‰ä¸ª filter åˆ° includeFilters ä¸­æ¥.</p>
<p>è®¾ç½®environment / resource åˆ° å…¶çˆ¶ç±»org.springframework.context.annotation.ClassPathScanningCandidateComponentProvider ä¸­æ¥.</p>
<p>ä¹Ÿå°±æ˜¯setXXXæ–¹æ³•æ˜¯è°ƒç”¨çš„çˆ¶ç±».</p>

        <h4 id="register-componentClasses-æ–¹æ³•"   >
          <a href="#register-componentClasses-æ–¹æ³•" class="heading-link"><i class="fas fa-link"></i></a><a href="#register-componentClasses-æ–¹æ³•" class="headerlink" title="register(componentClasses) æ–¹æ³•"></a>register(componentClasses) æ–¹æ³•</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(Class&lt;?&gt;... componentClasses)</span> </span>&#123;</span><br><span class="line">   <span class="comment">//  æ£€éªŒä¼ å…¥è¿›æ¥çš„ comonpentClassesæ˜¯ä¸€å®šè¦æœ‰å€¼çš„. </span></span><br><span class="line">   Assert.notEmpty(componentClasses, <span class="string">&quot;At least one component class must be specified&quot;</span>);</span><br><span class="line">   <span class="keyword">this</span>.reader.register(componentClasses);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-------------------------</span><br><span class="line"><span class="comment">// è¿™é‡Œä»åå­—ä¸Šå°±å¯ä»¥å¾ˆå®¹æ˜“çœ‹å‡ºæ˜¯æ³¨å†Œ bean çš„    </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(Class&lt;?&gt;... componentClasses)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (Class&lt;?&gt; componentClass : componentClasses) &#123;</span><br><span class="line">			registerBean(componentClass);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">-----------------------------</span><br><span class="line"><span class="keyword">private</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">doRegisterBean</span><span class="params">(Class&lt;T&gt; beanClass, <span class="meta">@Nullable</span> String name,</span></span></span><br><span class="line"><span class="params"><span class="function">			<span class="meta">@Nullable</span> Class&lt;? extends Annotation&gt;[] qualifiers, <span class="meta">@Nullable</span> Supplier&lt;T&gt; supplier,</span></span></span><br><span class="line"><span class="params"><span class="function">			<span class="meta">@Nullable</span> BeanDefinitionCustomizer[] customizers)</span> </span>&#123;</span><br><span class="line"><span class="comment">// new ä¸€ä¸ª bd å‡ºæ¥.</span></span><br><span class="line">		AnnotatedGenericBeanDefinition abd = <span class="keyword">new</span> AnnotatedGenericBeanDefinition(beanClass);</span><br><span class="line"><span class="comment">// è¿™é‡Œæ²¡æœ‰ @Conditional æ³¨è§£å’Œ metadata æ˜¯ null å°±ä¼šç›´æ¥è¿”å› false æ¥.    </span></span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.conditionEvaluator.shouldSkip(abd.getMetadata())) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		abd.setInstanceSupplier(supplier);</span><br><span class="line"> </span><br><span class="line"><span class="comment">// åœ¨å¯¹è±¡ä¸Šè·å– @Scope æ³¨è§£,è¿™é‡Œæ²¡æœ‰,æ‰€ä»¥å°±ä¸ä¼šå¾€ä¸‹èµ°.</span></span><br><span class="line"><span class="comment">// è¿™é‡Œè¿”å›çš„ ScopeMetadataåº”è¯¥æ˜¯é»˜è®¤çš„,scopeNameæ˜¯singleton,scopedProxyModeæ˜¯No/1    </span></span><br><span class="line">		ScopeMetadata scopeMetadata = <span class="keyword">this</span>.scopeMetadataResolver.resolveScopeMetadata(abd);</span><br><span class="line">		abd.setScope(scopeMetadata.getScopeName());</span><br><span class="line"><span class="comment">// è·å– beanName æ¥    </span></span><br><span class="line">		String beanName = (name != <span class="keyword">null</span> ? name : <span class="keyword">this</span>.beanNameGenerator.generateBeanName(abd, <span class="keyword">this</span>.registry));</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯¹ä¸€äº›æ³¨è§£çš„å¤„ç†.</span></span><br><span class="line"><span class="comment">// @Lazy , @Primary , @DependsOn , @Role , @Description å¦‚æœæœ‰è¿™äº›æ³¨è§£çš„è¯,å°±ä¼šè¿›è¡Œå¤„ç†.</span></span><br><span class="line"><span class="comment">// æ ¹æ®æ³¨è§£çš„åå­—,æ¥è°ƒç”¨ç›¸åº”çš„setæ–¹æ³•.    </span></span><br><span class="line">		AnnotationConfigUtils.processCommonDefinitionAnnotations(abd);</span><br><span class="line">    </span><br><span class="line"> <span class="comment">// è¿™é‡Œæ˜¯å¯¹æ˜¯å¦æœ‰ @Primary / @Lazy /   @Qualifier æ³¨è§£è¿›è¡Œåˆ¤æ–­.</span></span><br><span class="line">		<span class="keyword">if</span> (qualifiers != <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">for</span> (Class&lt;? extends Annotation&gt; qualifier : qualifiers) &#123;</span><br><span class="line">				<span class="keyword">if</span> (Primary.class == qualifier) &#123;</span><br><span class="line">					abd.setPrimary(<span class="keyword">true</span>);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span> <span class="keyword">if</span> (Lazy.class == qualifier) &#123;</span><br><span class="line">					abd.setLazyInit(<span class="keyword">true</span>);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span> &#123;</span><br><span class="line">					abd.addQualifier(<span class="keyword">new</span> AutowireCandidateQualifier(qualifier));</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"><span class="comment">//è¿™é‡Œ BeanDefinitionCustomizer[] customizers æ•°ç»„å¦‚æœæœ‰å€¼çš„è¯,</span></span><br><span class="line"><span class="comment">// ä¼šè°ƒç”¨ customizer çš„ customize æ–¹æ³•ä¼ å…¥ bd.</span></span><br><span class="line"><span class="comment">// TODO , è¿™é‡Œç”±äºæ²¡æœ‰å…·ä½“çš„å€¼,ä¹Ÿä¸æ˜¯å¾ˆæ¸…æ¥šåšäº†ä»€ä¹ˆäº‹æƒ….    </span></span><br><span class="line">		<span class="keyword">if</span> (customizers != <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">for</span> (BeanDefinitionCustomizer customizer : customizers) &#123;</span><br><span class="line">				customizer.customize(abd);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”¨ bd å’Œ beançš„åå­—ï¼Œåˆ›å»ºå‡ºä¸€ä¸ª bd çš„æŒæœ‰è€….    </span></span><br><span class="line">		BeanDefinitionHolder definitionHolder = <span class="keyword">new</span> BeanDefinitionHolder(abd, beanName);</span><br><span class="line"><span class="comment">// è¿™é‡Œç”±äºä¼ å…¥è¿›æ¥çš„ scopeMetadataçš„å€¼æ˜¯NO,æ‰€ä»¥å°±ç›´æ¥è¿”å›bdHolderçš„æŒæœ‰è€…äº†.</span></span><br><span class="line"><span class="comment">// å¯ä»¥çœ‹åˆ°è¿”å›ä¸‹é¢çš„ä»£ç ,æ˜¯æ»¡è¶³ä¸€ä¸ªå¢å¼ºç±»çš„æ¦‚å¿µçš„.    </span></span><br><span class="line">		definitionHolder = AnnotationConfigUtils.applyScopedProxyMode(scopeMetadata, definitionHolder, <span class="keyword">this</span>.registry); </span><br><span class="line"><span class="comment">// org.springframework.beans.factory.support.DefaultListableBeanFactory#registerBeanDefinition</span></span><br><span class="line"><span class="comment">//èµ°åˆ°beanFactoryä¸­çš„registerBeanDefinitionæ–¹æ³•æ¥,å…ˆæ˜¯å¯¹bdè¿›è¡Œæ ¡éªŒ,ç„¶ååˆ©ç”¨org.springframework.beans.factory.support.DefaultListableBeanFactory#beanDefinitionMap+beaNameæ¥åˆ¤æ–­æ˜¯ä¸æ˜¯å·²ç»åŒ…å«äº†è¯¥bean</span></span><br><span class="line"><span class="comment">// æ­¤æ—¶å¦‚æœä½ æ˜¯debugçš„è¯,ä½ ä¼šå‘ç°æœ‰äº”ä¸ªå†…ç½®çš„beanå·²ç»åœ¨è¯¥beanDefinitionMapä¸­äº†.è¿™ä¹Ÿæ˜¯å¯¹åº”äº†AnnotatedBeanDefinitionReaderä¸­å¤„ç†çš„å†…ç½®çš„bean.</span></span><br><span class="line"><span class="comment">//å¦‚æœbeanDefinitionMapä¸­æ²¡æœ‰çš„è¯,å°±åˆ†ä¸ºæ˜¯ä¸æ˜¯å·²ç»å¼€å§‹åˆ›å»ºbeanäº†.</span></span><br><span class="line"><span class="comment">//å¦‚æœæ²¡æœ‰å·²ç»å¼€å§‹åˆ›å»ºäº†,å°±æ·»åŠ åˆ°beanDefinitionMapä¸­æ¥,beanNameä¹Ÿä¼šæ·»åŠ åˆ°beanDefinitionNames,å…¶å®è¿™é‡Œæœ‰ä¸ªé—®é¢˜, beanDefinitionMapçš„keyé›†åˆå°±å·²ç»æ˜¯beanNameé›†åˆäº†,ä¸ºä»€ä¹ˆè¿˜å•ç‹¬ä½¿ç”¨ä¸€ä¸ªé›†åˆæ¥ç»´æŠ¤å‘¢ï¼Ÿ</span></span><br><span class="line"><span class="comment">// è¿™æ ·è¿™ä¸ªbeançš„ä¿¡æ¯å’Œbdå°±æ”¾å…¥åˆ° BeanFactoryä¸­æ¥äº†.    </span></span><br><span class="line"><span class="comment">// å¦‚æœæœ‰åˆ«åçš„æ³¨è§£æˆ–è€…é…ç½®çš„è¯,å°±ä¼šèµ°åˆ°registry.registerAlias(beanName, alias);æ¥è¿›è¡Œåˆ«åçš„æ³¨å†Œ. </span></span><br><span class="line">		BeanDefinitionReaderUtils.registerBeanDefinition(definitionHolder, <span class="keyword">this</span>.registry);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></div></figure>

<p>è¿™é‡Œå¯ä»¥æ€»ç»“ä¸‹çœ‹åˆ° register æ–¹æ³•å°±æ˜¯å¯¹æˆ‘ä»¬çš„é…ç½®ç±»è¿›è¡Œæ‰«æ, ç„¶åå¯¹æ˜¯å¦æœ‰ä¸€äº›æ³¨è§£è¿›è¡Œåˆ¤æ–­ç­‰. æœ€åä½¿ç”¨ BeanDefinitionReaderUtils å·¥å…·ç±»çš„æ–¹æ³•å°† bd ç»™ æ³¨å†Œåˆ° Spring å®¹å™¨ä¸­æ¥, æ³¨æ„è¿™æ—¶å€™æ˜¯æ²¡æœ‰å®ä¾‹åŒ–æˆ‘ä»¬çš„ YangBeanScannerConfig,åªæ˜¯å°è£…æˆ bd + beanName ç»™æ³¨å†Œåˆ° BeanFactory çš„ beanDefinitionMap ä¸­æ¥äº†.</p>

        <h4 id="refresh-æ–¹æ³•"   >
          <a href="#refresh-æ–¹æ³•" class="heading-link"><i class="fas fa-link"></i></a><a href="#refresh-æ–¹æ³•" class="headerlink" title="refresh() æ–¹æ³•"></a>refresh() æ–¹æ³•</h4>
      <p> æ›´æ–°æ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ°è¿™ä¸ªæ–¹æ³•å†…éƒ¨æ˜¯èµ°äº†å¾ˆå¤šæ–¹æ³•,å…¶é€»è¾‘ä¹Ÿæ˜¯æ¯”è¾ƒç»•çš„. ä¸è¿‡æ²¡äº‹ï¼Œæˆ‘ä»¬ä¸€ä¸ªä¸€ä¸ªæ–¹æ³•çš„æ¥çœ‹.</p>
<p>org.springframework.context.support.AbstractApplicationContext#refresh()</p>
<p>å¯ä»¥çœ‹åˆ°å…¶å†…éƒ¨çš„æ¯ä¸ªæ–¹æ³•ä¸Šé¢éƒ½æ˜¯æœ‰ä¸€è¡Œæ³¨é‡Šçš„.</p>
<p>äºæ˜¯æˆ‘ä»¬æŒ¨ä¸ªæ–¹æ³•æ¥debugè¿›æ¥åˆ†æ.</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ©ç”¨ Object æ¥å½“é”å¯¹è±¡,é¿å…å¤šä¸ªçº¿ç¨‹åŒæ—¶è°ƒç”¨åˆ° refresh æ–¹æ³•æ¥.</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Object startupShutdownMonitor = <span class="keyword">new</span> Object();</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException </span>&#123;</span><br><span class="line">   <span class="keyword">synchronized</span> (<span class="keyword">this</span>.startupShutdownMonitor) &#123;</span><br><span class="line">      <span class="comment">// Prepare this context for refreshing.</span></span><br><span class="line">  </span><br><span class="line">      prepareRefresh();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Tell the subclass to refresh the internal bean factory.</span></span><br><span class="line">      ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Prepare the bean factory for use in this context.</span></span><br><span class="line">      prepareBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="comment">// Allows post-processing of the bean factory in context subclasses.</span></span><br><span class="line">         postProcessBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Invoke factory processors registered as beans in the context.</span></span><br><span class="line">         invokeBeanFactoryPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Register bean processors that intercept bean creation.</span></span><br><span class="line">         registerBeanPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Initialize message source for this context.</span></span><br><span class="line">         initMessageSource();</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Initialize event multicaster for this context.</span></span><br><span class="line">         initApplicationEventMulticaster();</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Initialize other special beans in specific context subclasses.</span></span><br><span class="line">         onRefresh();</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Check for listener beans and register them.</span></span><br><span class="line">         registerListeners();</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Instantiate all remaining (non-lazy-init) singletons.</span></span><br><span class="line">         finishBeanFactoryInitialization(beanFactory);</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Last step: publish corresponding event.</span></span><br><span class="line">         finishRefresh();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">         <span class="keyword">if</span> (logger.isWarnEnabled()) &#123;</span><br><span class="line">            logger.warn(<span class="string">&quot;Exception encountered during context initialization - &quot;</span> +</span><br><span class="line">                  <span class="string">&quot;cancelling refresh attempt: &quot;</span> + ex);</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Destroy already created singletons to avoid dangling resources.</span></span><br><span class="line">         destroyBeans();</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Reset &#x27;active&#x27; flag.</span></span><br><span class="line">         cancelRefresh(ex);</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Propagate exception to caller.</span></span><br><span class="line">         <span class="keyword">throw</span> ex;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">finally</span> &#123;</span><br><span class="line">         <span class="comment">// Reset common introspection caches in Spring&#x27;s core, since we</span></span><br><span class="line">         <span class="comment">// might not ever need metadata for singleton beans anymore...</span></span><br><span class="line">         resetCommonCaches();</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="prepareRefresh-æ–¹æ³•"   >
          <a href="#prepareRefresh-æ–¹æ³•" class="heading-link"><i class="fas fa-link"></i></a><a href="#prepareRefresh-æ–¹æ³•" class="headerlink" title="prepareRefresh() æ–¹æ³•"></a>prepareRefresh() æ–¹æ³•</h5>
      <p>ä»æ³¨é‡Šæ¥çœ‹, è®¾ç½®startupæ•°æ® &amp; æ ‡è¯†activeæ¥è¡¨ç¤ºçŠ¶æ€,åŒæ—¶ä¹Ÿä¼šåˆå§‹åŒ–ä¸€äº›èµ„æº.</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Prepare this context for refreshing, setting its startup date and</span></span><br><span class="line"><span class="comment"> * active flag as well as performing any initialization of property sources.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">prepareRefresh</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="comment">// Switch to active.</span></span><br><span class="line">   <span class="keyword">this</span>.startupDate = System.currentTimeMillis();</span><br><span class="line"><span class="comment">// å¯¹çŠ¶æ€æ ‡è¯†çš„è®¾ç½®.    </span></span><br><span class="line">   <span class="keyword">this</span>.closed.set(<span class="keyword">false</span>);</span><br><span class="line">   <span class="keyword">this</span>.active.set(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">      <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">         logger.trace(<span class="string">&quot;Refreshing &quot;</span> + <span class="keyword">this</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">         logger.debug(<span class="string">&quot;Refreshing &quot;</span> + getDisplayName());</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Initialize any placeholder property sources in the context environment.</span></span><br><span class="line"><span class="comment">// è¿™é‡Œæš‚æ—¶æ²¡æœ‰å®ç°æ¥åšäº‹æƒ….    </span></span><br><span class="line">   initPropertySources();</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Validate that all properties marked as required are resolvable:</span></span><br><span class="line">   <span class="comment">// see ConfigurablePropertyResolver#setRequiredProperties</span></span><br><span class="line"><span class="comment">// org.springframework.core.env.AbstractEnvironment#validateRequiredProperties</span></span><br><span class="line"><span class="comment">// å¯¹ org.springframework.core.env.AbstractPropertyResolver#requiredProperties è¿›è¡Œæ£€éªŒ,å¦‚æœæ£€éªŒåˆ°æœ‰é—®é¢˜çš„è¯,å°±ä¼šæŠ›å‡ºå¼‚å¸¸æ¥.</span></span><br><span class="line"><span class="comment">// è¿™é‡Œæ˜¯å¯¹ properties è¿›è¡Œæ£€éªŒ.    </span></span><br><span class="line">   getEnvironment().validateRequiredProperties();</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Store pre-refresh ApplicationListeners...</span></span><br><span class="line"><span class="comment">// earlyApplicationListenersæ˜¯nullçš„è¯,åˆ©ç”¨applicationListenersæ¥åˆå§‹åŒ–.   </span></span><br><span class="line">   <span class="keyword">if</span> (<span class="keyword">this</span>.earlyApplicationListeners == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.earlyApplicationListeners = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(<span class="keyword">this</span>.applicationListeners);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// å¦‚æœå·²ç»å­˜åœ¨å€¼äº†,å°±å¯¹  applicationListeners æ¸…ç©ºï¼Œç„¶åå…¨éƒ¨æ·»åŠ applicationListenersæ¥.     </span></span><br><span class="line">      <span class="comment">// Reset local application listeners to pre-refresh state.</span></span><br><span class="line">      <span class="keyword">this</span>.applicationListeners.clear();</span><br><span class="line">      <span class="keyword">this</span>.applicationListeners.addAll(<span class="keyword">this</span>.earlyApplicationListeners);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Allow for the collection of early ApplicationEvents,</span></span><br><span class="line">   <span class="comment">// to be published once the multicaster is available...</span></span><br><span class="line">   <span class="keyword">this</span>.earlyApplicationEvents = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>å¯ä»¥çœ‹åˆ°è¯¥æ–¹æ³•çš„è¯,å¯¹çŠ¶æ€æ ‡è¯†è¿›è¡Œè®¾ç½®. æ¥ç€åœ° propertySources èµ„æºæ¥è¿›è¡Œåˆå§‹åŒ–, äºæ˜¯å°±å¯¹propertyæ¥è¿›è¡Œæ£€éªŒ. æ¥ä¸‹æ¥æ˜¯å¯¹ earlyApplicationListeners/earlyApplicationEventsæ ¹æ®æ¡ä»¶æ¥åˆå§‹åŒ–æ“ä½œ.</p>

        <h5 id="obtainFreshBeanFactroy"   >
          <a href="#obtainFreshBeanFactroy" class="heading-link"><i class="fas fa-link"></i></a><a href="#obtainFreshBeanFactroy" class="headerlink" title="obtainFreshBeanFactroy()"></a>obtainFreshBeanFactroy()</h5>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">protected ConfigurableListableBeanFactory obtainFreshBeanFactory() &#123;</span><br><span class="line">   refreshBeanFactory();</span><br><span class="line">   return getBeanFactory();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">---------------------------</span><br><span class="line">org.springframework.context.support.GenericApplicationContext#refreshBeanFactory</span><br><span class="line">  </span><br><span class="line">// çœ‹åˆ° compareAndSet æœ‰ç‚¹cas çš„å‘³é“.    </span><br><span class="line">protected final void refreshBeanFactory() throws IllegalStateException &#123;    </span><br><span class="line">		if (!this.refreshed.compareAndSet(false, true)) &#123;</span><br><span class="line">			throw new IllegalStateException(</span><br><span class="line">					&quot;GenericApplicationContext does not support multiple refresh attempts: just call &#x27;refresh&#x27; once&quot;);</span><br><span class="line">		&#125;</span><br><span class="line">// private String id = ObjectUtils.identityToString(this);</span><br><span class="line">// è¿™é‡Œè·å–å‡ºæ¥çš„idåœ¨è¿™ä¸ªç±»è¢«newæˆ–è€…å­ç±»è°ƒç”¨çˆ¶ç±»çš„super()æ„é€ æ–¹æ³•çš„æ—¶å€™,å°±å·²ç»è¢«åˆå§‹åŒ–å€¼äº†çš„.    </span><br><span class="line">		this.beanFactory.setSerializationId(getId());</span><br><span class="line">	&#125;    </span><br><span class="line">    </span><br><span class="line">-----------------</span><br><span class="line">org.springframework.context.support.GenericApplicationContext#getBeanFactory</span><br><span class="line"></span><br><span class="line">// è¿™é‡Œå°±ç›´æ¥è¿”å›äº† DefaultListableBeanFactory.   </span><br><span class="line">	@Override</span><br><span class="line">	public final ConfigurableListableBeanFactory getBeanFactory() &#123;</span><br><span class="line">		return this.beanFactory;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></div></figure>

<p>è¯¥æ–¹æ³• è®¾ç½®äº†ä¸€ä¸ª SerializationId åˆ° beanFactory ä¸­æ¥. æœ€åä¹Ÿæ˜¯è¿”å›äº†ä¸€ä¸ª DefaultListableBeanFactory æ¥.</p>

        <h5 id="prepareBeanFactory-æ–¹æ³•"   >
          <a href="#prepareBeanFactory-æ–¹æ³•" class="heading-link"><i class="fas fa-link"></i></a><a href="#prepareBeanFactory-æ–¹æ³•" class="headerlink" title="prepareBeanFactory() æ–¹æ³•"></a>prepareBeanFactory() æ–¹æ³•</h5>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Configure the factory&#x27;s standard context characteristics,</span></span><br><span class="line"><span class="comment"> * such as the context&#x27;s ClassLoader and post-processors.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> beanFactory the BeanFactory to configure</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">prepareBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">   <span class="comment">// Tell the internal bean factory to use the context&#x27;s class loader etc.</span></span><br><span class="line"><span class="comment">// org.springframework.core.io.DefaultResourceLoader#getClassLoader   </span></span><br><span class="line"><span class="comment">// è®¾ç½® class åŠ è½½å™¨&amp;èµ‹å€¼è¿›å».    </span></span><br><span class="line">   beanFactory.setBeanClassLoader(getClassLoader());</span><br><span class="line"><span class="comment">// å°† beanClassLoaderæ”¾å…¥SpelParserConfigurationä¸­æ¥,SpelExpressionParserä¸­æœ‰å«æœ‰SpelParserConfigurationä½œä¸ºconfiguration,StandardBeanExpressionResolverå±æ€§åˆå«æœ‰SpelExpressionParser. è¿™ä¹Ÿå°±å¯ä»¥ç†è§£ä¸ºbeanClassLoaderæœ€åæ˜¯æ”¾å…¥åˆ°SpelParserConfigurationæ¥.</span></span><br><span class="line">   beanFactory.setBeanExpressionResolver(<span class="keyword">new</span> StandardBeanExpressionResolver(beanFactory.getBeanClassLoader()));</span><br><span class="line">    </span><br><span class="line"><span class="comment">// ä¼ å…¥applicationContextå’Œenvironmentåˆ°ResourceEditorRegistrarå¯¹è±¡æ¥.</span></span><br><span class="line"><span class="comment">//ç„¶åæ·»åŠ åˆ°beanFactoryä¸­æ¥.    </span></span><br><span class="line">   beanFactory.addPropertyEditorRegistrar(<span class="keyword">new</span> ResourceEditorRegistrar(<span class="keyword">this</span>, getEnvironment()));</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Configure the bean factory with context callbacks.</span></span><br><span class="line"><span class="comment">// æ·»åŠ ApplicationContextAwareProcessoråç½®å¤„ç†å™¨åˆ°org.springframework.beans.factory.support.AbstractBeanFactory#beanPostProcessorsä¸­æ¥.</span></span><br><span class="line"><span class="comment">// åœ¨æ·»åŠ åç½®å¤„ç†å™¨åˆ°Springå®¹å™¨ä¹‹å‰,ä¼šåˆ¤æ–­è¿™ä¸ªåç½®å¤„ç†èµ·æ˜¯ä¸æ˜¯InstantiationAwareBeanPostProcessor/DestructionAwareBeanPostProcessor è¿™äºŒç§æƒ…å†µ.</span></span><br><span class="line"><span class="comment">// æœ€åæ·»åŠ åˆ° beanPostProcessors ä¸­æ¥.    </span></span><br><span class="line">   beanFactory.addBeanPostProcessor(<span class="keyword">new</span> ApplicationContextAwareProcessor(<span class="keyword">this</span>));</span><br><span class="line"><span class="comment">// ç„¶åè¿™é‡Œå¿½ç•¥äº†å…­ç§æƒ…å†µçš„æ¥å£. ä¸ºä»€ä¹ˆè¦å¿½ç•¥å‘¢? çœ‹ä¸€ä¸ªåœ°æ–¹.</span></span><br><span class="line"><span class="comment">// org.springframework.context.support.ApplicationContextAwareProcessor#postProcessBeforeInitialization &amp;  org.springframework.context.support.ApplicationContextAwareProcessor#invokeAwareInterfaces ç»“åˆè¿™äºŒä¸ªæ–¹æ³•æ¥çœ‹,æ˜¯å·²ç»å¯¹è¿™å…­ç§æƒ…å†µçš„æ¥å£åšäº†å¤„ç†çš„.    </span></span><br><span class="line">   beanFactory.ignoreDependencyInterface(EnvironmentAware.class);</span><br><span class="line">   beanFactory.ignoreDependencyInterface(EmbeddedValueResolverAware.class);</span><br><span class="line">   beanFactory.ignoreDependencyInterface(ResourceLoaderAware.class);</span><br><span class="line">   beanFactory.ignoreDependencyInterface(ApplicationEventPublisherAware.class);</span><br><span class="line">   beanFactory.ignoreDependencyInterface(MessageSourceAware.class);</span><br><span class="line">   beanFactory.ignoreDependencyInterface(ApplicationContextAware.class);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// BeanFactory interface not registered as resolvable type in a plain factory.</span></span><br><span class="line">   <span class="comment">// MessageSource registered (and found for autowiring) as a bean.</span></span><br><span class="line"><span class="comment">// private final Map&lt;Class&lt;?&gt;, Object&gt; resolvableDependencies = new ConcurrentHashMap&lt;&gt;(16);    </span></span><br><span class="line"><span class="comment">// org.springframework.beans.factory.support.DefaultListableBeanFactory#resolvableDependencies,è¿™é‡Œå°† BeanFactory.classå’ŒbeanFactoryç»™æ·»åŠ åˆ° resolvableDependenciesä¸­æ¥äº†,è¿™é‡Œå¯ä»¥çœ‹åˆ°resolvableDependenciesçš„keyæ˜¯ä¸€ä¸ªClassç±»å‹.</span></span><br><span class="line">   beanFactory.registerResolvableDependency(BeanFactory.class, beanFactory);</span><br><span class="line">   beanFactory.registerResolvableDependency(ResourceLoader.class, <span class="keyword">this</span>);</span><br><span class="line">   beanFactory.registerResolvableDependency(ApplicationEventPublisher.class, <span class="keyword">this</span>);</span><br><span class="line">   beanFactory.registerResolvableDependency(ApplicationContext.class, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Register early post-processor for detecting inner beans as ApplicationListeners.</span></span><br><span class="line"><span class="comment">// è¿™é‡Œåˆæ·»åŠ äº†ä¸€ä¸ªåç½®å¤„ç†å™¨.</span></span><br><span class="line"><span class="comment">// ä¼ å…¥ä¸€ä¸ª ApplicationContext ç»™åç½®å¤„ç†å™¨,ç„¶åæ·»åŠ åˆ°BeanFactoryä¸­æ¥.</span></span><br><span class="line"><span class="comment">// org.springframework.beans.factory.support.AbstractBeanFactory#beanPostProcessors,ä¹Ÿå³æ˜¯æ·»åŠ åˆ°ä¸“é—¨å­˜æ”¾ åç½®å¤„ç†å™¨çš„é›†åˆä¸­æ¥äº†.    </span></span><br><span class="line">   beanFactory.addBeanPostProcessor(<span class="keyword">new</span> ApplicationListenerDetector(<span class="keyword">this</span>));</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Detect a LoadTimeWeaver and prepare for weaving, if found.</span></span><br><span class="line"><span class="comment">// beanFactoryå¦‚æœæœ‰loadTimeWeaver,é‚£ä¹ˆå°±æ·»åŠ  LoadTimeWeaverAwareProcessor åç½®å¤„ç†å™¨è¿›æ¥   </span></span><br><span class="line">   <span class="keyword">if</span> (beanFactory.containsBean(LOAD_TIME_WEAVER_BEAN_NAME)) &#123;</span><br><span class="line">      beanFactory.addBeanPostProcessor(<span class="keyword">new</span> LoadTimeWeaverAwareProcessor(beanFactory));</span><br><span class="line">      <span class="comment">// Set a temporary ClassLoader for type matching.</span></span><br><span class="line">      beanFactory.setTempClassLoader(<span class="keyword">new</span> ContextTypeMatchClassLoader(beanFactory.getBeanClassLoader()));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Register default environment beans.</span></span><br><span class="line"><span class="comment">// ä¸åŒ…å«environment/systemProperties/systemEnvironmentï¼Œå°±ä¼šæ·»åŠ åˆ°org.springframework.beans.factory.support.DefaultSingletonBeanRegistry#singletonObjectsä¸­æ¥.    </span></span><br><span class="line">   <span class="keyword">if</span> (!beanFactory.containsLocalBean(ENVIRONMENT_BEAN_NAME)) &#123;</span><br><span class="line">      beanFactory.registerSingleton(ENVIRONMENT_BEAN_NAME, getEnvironment());</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (!beanFactory.containsLocalBean(SYSTEM_PROPERTIES_BEAN_NAME)) &#123;</span><br><span class="line">      beanFactory.registerSingleton(SYSTEM_PROPERTIES_BEAN_NAME, getEnvironment().getSystemProperties());</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (!beanFactory.containsLocalBean(SYSTEM_ENVIRONMENT_BEAN_NAME)) &#123;</span><br><span class="line">      beanFactory.registerSingleton(SYSTEM_ENVIRONMENT_BEAN_NAME, getEnvironment().getSystemEnvironment());</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>è¿™é‡Œå¯ä»¥çœ‹åˆ°,prepareBeanFactory ä¸­åšäº†è¿™äº›äº‹æƒ… : æ·»åŠ äº† beanClassLoader,æ·»åŠ äº†äºŒä¸ªåç½®å¤„ç†å™¨,ç„¶åæ³¨å†Œäº†å››ä¸ª BeanFactory/ResourceLoader/ApplicationEventPublisher/ApplicationContext åˆ°DefaultListableBeanFactory#resolvableDependenciesä¸­æ¥äº†.</p>
<p>æœ€ååˆ¤æ–­beanFactoryæ˜¯ä¸æ˜¯ä¸åŒ…å«ä¸€äº›å…³äºç¯å¢ƒçš„bean,å¦‚æœæ˜¯çš„è¯,é‚£å°±è°ƒç”¨registerSingletonæ–¹æ³•ç»™æ³¨å†Œè¿›æ¥.</p>
<p>è¿˜æ˜¯å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œéƒ½æ˜¯åœ¨ä¸ºç¯å¢ƒåšå‡†å¤‡å·¥ä½œ.</p>

        <h5 id="postProcessBeanFactory-æ–¹æ³•"   >
          <a href="#postProcessBeanFactory-æ–¹æ³•" class="heading-link"><i class="fas fa-link"></i></a><a href="#postProcessBeanFactory-æ–¹æ³•" class="headerlink" title="postProcessBeanFactory() æ–¹æ³•"></a>postProcessBeanFactory() æ–¹æ³•</h5>
      <p>ç•¥ç•¥ç•¥, è¯¥æ–¹æ³•æš‚æ— å®ç°ç±»æ¥æäº‹æƒ…â€¦..</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Modify the application context&#x27;s internal bean factory after its standard</span></span><br><span class="line"><span class="comment"> * initialization. All bean definitions will have been loaded, but no beans</span></span><br><span class="line"><span class="comment"> * will have been instantiated yet. This allows for registering special</span></span><br><span class="line"><span class="comment"> * BeanPostProcessors etc in certain ApplicationContext implementations.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> beanFactory the bean factory used by the application context</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="invokeBeanFactoryPostProcessors-æ–¹æ³•"   >
          <a href="#invokeBeanFactoryPostProcessors-æ–¹æ³•" class="heading-link"><i class="fas fa-link"></i></a><a href="#invokeBeanFactoryPostProcessors-æ–¹æ³•" class="headerlink" title="invokeBeanFactoryPostProcessors æ–¹æ³•"></a>invokeBeanFactoryPostProcessors æ–¹æ³•</h5>
      <p>è¿™äº›æ˜¯å¯¹beanFactoryPostProcessorsè¿›è¡Œå¤„ç†. æ˜¯å€Ÿç”¨äº† PostProcessorRegistrationDelegate.</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Instantiate and invoke all registered BeanFactoryPostProcessor beans,</span></span><br><span class="line"><span class="comment"> * respecting explicit order if given.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;Must be called before singleton instantiation.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">invokeBeanFactoryPostProcessors</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line"><span class="comment">// getBeanFactoryPostProcessors() è·å–å‡ºæ¥çš„æ˜¯ç©ºé›†åˆ.    </span></span><br><span class="line">   PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors(beanFactory, getBeanFactoryPostProcessors());</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Detect a LoadTimeWeaver and prepare for weaving, if found in the meantime</span></span><br><span class="line">   <span class="comment">// (e.g. through an @Bean method registered by ConfigurationClassPostProcessor)</span></span><br><span class="line">   <span class="keyword">if</span> (beanFactory.getTempClassLoader() == <span class="keyword">null</span> &amp;&amp; beanFactory.containsBean(LOAD_TIME_WEAVER_BEAN_NAME)) &#123;</span><br><span class="line">      beanFactory.addBeanPostProcessor(<span class="keyword">new</span> LoadTimeWeaverAwareProcessor(beanFactory));</span><br><span class="line">      beanFactory.setTempClassLoader(<span class="keyword">new</span> ContextTypeMatchClassLoader(beanFactory.getBeanClassLoader()));</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h6 id="org-springframework-context-support-PostProcessorRegistrationDelegate-invokeBeanFactoryPostProcessors-org-springframework-beans-factory-config-ConfigurableListableBeanFactory-java-util-List-lt-org-springframework-beans-factory-config-BeanFactoryPostProcessor-gt"   >
          <a href="#org-springframework-context-support-PostProcessorRegistrationDelegate-invokeBeanFactoryPostProcessors-org-springframework-beans-factory-config-ConfigurableListableBeanFactory-java-util-List-lt-org-springframework-beans-factory-config-BeanFactoryPostProcessor-gt" class="heading-link"><i class="fas fa-link"></i></a><a href="#org-springframework-context-support-PostProcessorRegistrationDelegate-invokeBeanFactoryPostProcessors-org-springframework-beans-factory-config-ConfigurableListableBeanFactory-java-util-List-lt-org-springframework-beans-factory-config-BeanFactoryPostProcessor-gt" class="headerlink" title="org.springframework.context.support.PostProcessorRegistrationDelegate#invokeBeanFactoryPostProcessors(org.springframework.beans.factory.config.ConfigurableListableBeanFactory, java.util.List&lt;org.springframework.beans.factory.config.BeanFactoryPostProcessor&gt;)"></a>org.springframework.context.support.PostProcessorRegistrationDelegate#invokeBeanFactoryPostProcessors(org.springframework.beans.factory.config.ConfigurableListableBeanFactory, java.util.List&lt;org.springframework.beans.factory.config.BeanFactoryPostProcessor&gt;)</h6>
      <p>è¯¥æ–¹æ³•ä»ä»£ç ä¸Šæ¥çœ‹,è¿˜æ˜¯åšäº†è›®å¤šçš„äº‹æƒ….</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">invokeBeanFactoryPostProcessors</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">      ConfigurableListableBeanFactory beanFactory, List&lt;BeanFactoryPostProcessor&gt; beanFactoryPostProcessors)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Invoke BeanDefinitionRegistryPostProcessors first, if any.</span></span><br><span class="line">   Set&lt;String&gt; processedBeans = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿™é‡Œæ˜¯æ»¡è¶³æ¡ä»¶çš„    </span></span><br><span class="line">   <span class="keyword">if</span> (beanFactory <span class="keyword">instanceof</span> BeanDefinitionRegistry) &#123;</span><br><span class="line">      BeanDefinitionRegistry registry = (BeanDefinitionRegistry) beanFactory;</span><br><span class="line">      List&lt;BeanFactoryPostProcessor&gt; regularPostProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">      List&lt;BeanDefinitionRegistryPostProcessor&gt; registryProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯¹ beanFactoryçš„åç½®å¤„ç†å™¨è¿›è¡Œè¿­ä»£å¤„ç†æ“ä½œ.       </span></span><br><span class="line">      <span class="keyword">for</span> (BeanFactoryPostProcessor postProcessor : beanFactoryPostProcessors) &#123;</span><br><span class="line">         <span class="keyword">if</span> (postProcessor <span class="keyword">instanceof</span> BeanDefinitionRegistryPostProcessor) &#123;</span><br><span class="line">            BeanDefinitionRegistryPostProcessor registryProcessor =</span><br><span class="line">                  (BeanDefinitionRegistryPostProcessor) postProcessor;</span><br><span class="line">            registryProcessor.postProcessBeanDefinitionRegistry(registry);</span><br><span class="line">            registryProcessors.add(registryProcessor);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">else</span> &#123;</span><br><span class="line">            regularPostProcessors.add(postProcessor);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Do not initialize FactoryBeans here: We need to leave all regular beans</span></span><br><span class="line">      <span class="comment">// uninitialized to let the bean factory post-processors apply to them!</span></span><br><span class="line">      <span class="comment">// Separate between BeanDefinitionRegistryPostProcessors that implement</span></span><br><span class="line">      <span class="comment">// PriorityOrdered, Ordered, and the rest.</span></span><br><span class="line">      List&lt;BeanDefinitionRegistryPostProcessor&gt; currentRegistryProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// First, invoke the BeanDefinitionRegistryPostProcessors that implement PriorityOrdered.</span></span><br><span class="line"><span class="comment">// æ ¹æ® BeanDefinitionRegistryPostProcessor.class æ¥è·å–beanNamesæ•°ç»„,</span></span><br><span class="line"><span class="comment">// org.springframework.context.annotation.internalConfigurationAnnotationProcessor è¿™é‡Œæ˜¯è·å–åˆ°äº†ä¸€ä¸ªå†…ç½®çš„BeanFactroyPostProcessor.      </span></span><br><span class="line">      String[] postProcessorNames =</span><br><span class="line">            beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">      <span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line"> <span class="comment">// åˆ¤æ–­æ˜¯ä¸æ˜¯æœ‰PriorityOrdered,         </span></span><br><span class="line">         <span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;</span><br><span class="line"> <span class="comment">// è¿™é‡Œçš„getBeanå°±å·²ç»å¯¹beanè¿›è¡Œåˆå§‹åŒ–ï¼Œæ˜¯çœŸæ­£çš„èµ°åå°„æ„é€ å‡½æ•°æ‹¿å‡ºæ¥çš„å®ä¾‹å¯¹è±¡.</span></span><br><span class="line"> <span class="comment">// getBeanéœ€è¦ä»”ç»†åˆ†æä¸‹ï¼Œå› ä¸ºå…¶å†…éƒ¨åœ¨ createBeanæ˜¯èµ°äº†å¾ˆå¤šåç½®å¤„ç†èµ·æ¥è¿›è¡Œå¢å¼ºçš„. </span></span><br><span class="line"><span class="comment">// ConfigurationClassPostProcessor ç»™æ·»åŠ è¿›æ¥.             </span></span><br><span class="line">            currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));</span><br><span class="line"><span class="comment">// beanName æ·»åŠ åˆ° processedBeansé›†åˆä¸­æ¥äº†.             </span></span><br><span class="line">            processedBeans.add(ppName);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line"><span class="comment">// å¯¹é›†åˆè¿›è¡Œæ’åº,ä»beanFactoryä¸­è·å–å‡ºdependencyComparatoræ¥,å¦‚æœæ²¡æœ‰çš„è¯,å°±ç”¨OrderComparator.INSTANCEé»˜è®¤çš„</span></span><br><span class="line">      sortPostProcessors(currentRegistryProcessors, beanFactory);</span><br><span class="line"><span class="comment">// å…¨éƒ¨æ·»åŠ åˆ° registryProcessors ä¸­æ¥.       </span></span><br><span class="line">      registryProcessors.addAll(currentRegistryProcessors);</span><br><span class="line"><span class="comment">// org.springframework.context.annotation.ConfigurationClassPostProcessor#postProcessBeanDefinitionRegistry</span></span><br><span class="line"><span class="comment">//è¿™é‡Œæ˜¯è¿›å…¥åˆ°ConfigurationClassPostProcessorä¸­æ¥äº†,å¯ä»¥çœ‹åˆ°å…¶æ¥å£ BeanDefinitionRegistryPostProcessor,æ˜¯é‡å†™äº†æ¥å£çš„æ–¹æ³•. </span></span><br><span class="line"><span class="comment">// ConfigurationClassPostProcessor#postProcessBeanDefinitionRegistry åšäº†ä»€ä¹ˆäº‹æƒ…å‘¢?</span></span><br><span class="line"><span class="comment">// ç”¨System.identityHashCode(registry);è®¡ç®—å‡ºregistryIdæ¥,å¦‚æœåœ¨org.springframework.context.annotation.ConfigurationClassPostProcessor#registriesPostProcessed/factoriesPostProcessed(äºŒä¸ªé›†åˆ)ä¸­å·²ç»åŒ…å«äº†çš„è¯,å°±ä¼šæŠ›å‡ºå·²ç»è¢«è°ƒç”¨è¿‡çš„å¼‚å¸¸æ¥.å¦‚æœæ²¡æœ‰çš„è¯,å°±ä¼šæ·»åŠ åˆ°registriesPostProcessedä¸­æ¥</span></span><br><span class="line"><span class="comment">// ç»§ç»­çœ‹ org.springframework.context.annotation.ConfigurationClassPostProcessor#processConfigBeanDefinitions æ–¹æ³•,</span></span><br><span class="line"><span class="comment">//å…ˆä»registryä¸­è·å–beanNamesæ¥,è¿™å…¶ä¸­å°±æœ‰Springå†…ç½®çš„å’Œæˆ‘ä»¬è‡ªå·±å®šä¹‰çš„yangBeanScannerConfig</span></span><br><span class="line"><span class="comment">//å¯¹beanNamesè¿­ä»£å¤„ç†,æ¥ç€å°±ç”¨ConfigurationClassUtils.checkConfigurationClassCandidate(beanDef, this.metadataReaderFactory)æ¥åˆ¤æ–­è¦ä¸è¦æ·»åŠ åˆ°List&lt;BeanDefinitionHolder&gt; configCandidatesé›†åˆä¸­æ¥,æœ€åæ˜¯æˆ‘ä»¬å®šä¹‰çš„beanNameç»™æ·»åŠ è¿›æ¥äº†.</span></span><br><span class="line"><span class="comment">// å¯¹configCandidatesé›†åˆè¿›è¡Œæ’åº,</span></span><br><span class="line"><span class="comment">// åˆ›å»ºä¸€ä¸ªConfigurationClassParserå¯¹è±¡æ¥è§£ææ¯ä¸ª@Configurationæ³¨è§£ç±».è°ƒç”¨å…¶parseå’Œvalidateæ–¹æ³•,è§£æå®Œåå°±æ˜¯ä¸€ä¸ªConfigurationClassçš„Seté›†åˆ,æ¥ç€å°±æ˜¯newäº†ä¸€ä¸ªConfigurationClassBeanDefinitionReaderå¯¹è±¡æ¥,</span></span><br><span class="line"><span class="comment">// this.reader.loadBeanDefinitions(configClasses); è¿™è¡Œä»£ç æœ‰ç‚¹æ ¹æ®Configå»è§£æbeançš„æ„æ€.    </span></span><br><span class="line"><span class="comment">// å…·ä½“è¦ç­‰åˆ°åé¢æ·±åº¦è§£æå†åè¿‡æ¥å®šä½æ¯è¡Œä»£ç çš„æ„æ€.</span></span><br><span class="line"><span class="comment">// æœ€åå†æ¸…é™¤ä¸‹ç¼“å­˜.       </span></span><br><span class="line">      invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry);</span><br><span class="line"><span class="comment">// æ¸…ç©º currentRegistryProcessors é›†åˆ      </span></span><br><span class="line">      currentRegistryProcessors.clear();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Next, invoke the BeanDefinitionRegistryPostProcessors that implement Ordered.</span></span><br><span class="line">      postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">      <span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line"><span class="comment">// å¦‚æœprocessedBeansé›†åˆä¸­ä¸åŒ…å«å¹¶ä¸”typeæ˜¯Ordered.classæ‰æ»¡è¶³è¿›æ¥çš„æ¡ä»¶.          </span></span><br><span class="line">         <span class="keyword">if</span> (!processedBeans.contains(ppName) &amp;&amp; beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;</span><br><span class="line">            currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));</span><br><span class="line">            processedBeans.add(ppName);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line"><span class="comment">// æ‰€ä»¥è¿™é‡Œçš„currentRegistryProcessorsé›†åˆæ˜¯ç©ºé›†åˆ.       </span></span><br><span class="line">      sortPostProcessors(currentRegistryProcessors, beanFactory);</span><br><span class="line">      registryProcessors.addAll(currentRegistryProcessors);</span><br><span class="line">      invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry);</span><br><span class="line">      currentRegistryProcessors.clear();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Finally, invoke all other BeanDefinitionRegistryPostProcessors until no further ones appear.</span></span><br><span class="line"><span class="comment">// è¿™é‡Œç”¨ while å¾ªç¯æ¥æœ€åè§£æ,åˆ¤æ–­ä»getBeanNamesForTypeè·å–å‡ºæ¥çš„beanæ˜¯ä¸æ˜¯è¢«è§£æè¿‡äº†çš„. </span></span><br><span class="line"><span class="comment">// ä¹Ÿæ˜¯ç”¨ processedBeans é›†åˆæ¥è¿›è¡Œæ§åˆ¶çš„. </span></span><br><span class="line">      <span class="keyword">boolean</span> reiterate = <span class="keyword">true</span>;</span><br><span class="line">      <span class="keyword">while</span> (reiterate) &#123;</span><br><span class="line">         reiterate = <span class="keyword">false</span>;</span><br><span class="line">         postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">         <span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!processedBeans.contains(ppName)) &#123;</span><br><span class="line">               currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));</span><br><span class="line">               processedBeans.add(ppName);</span><br><span class="line">               reiterate = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         sortPostProcessors(currentRegistryProcessors, beanFactory);</span><br><span class="line">         registryProcessors.addAll(currentRegistryProcessors);</span><br><span class="line">         invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry);</span><br><span class="line">         currentRegistryProcessors.clear();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Now, invoke the postProcessBeanFactory callback of all processors handled so far.</span></span><br><span class="line"><span class="comment">// org.springframework.context.annotation.ConfigurationClassPostProcessor#postProcessBeanFactory,è¿™é‡Œæ˜¯èµ°åˆ°äº†postProcessBeanFactoryå›è°ƒæ–¹æ³•æ¥äº†.ç”¨org.springframework.context.annotation.ConfigurationClassPostProcessor#factoriesPostProcessedé›†åˆæ¥æ§åˆ¶æ˜¯å¦è§£æè¿‡äº†.ç”¨registriesPostProcessedé›†åˆæ¥åˆ¤æ–­ä¸Šæ¬¡æ˜¯å¦è¿›å…¥åˆ°postProcessBeanDefinitionRegistryæ–¹æ³•ä¸­æ¥. å¦‚æœæ²¡æœ‰çš„è¯,å°±ä¼šå†èµ°ä¸€è¾¹processConfigBeanDefinitions,å¯ä»¥çœ‹åˆ° postProcessBeanDefinitionRegistry æ–¹æ³•æœ€åä¹Ÿæ˜¯èµ°åˆ°äº†processConfigBeanDefinitionsä¸­æ¥äº†.</span></span><br><span class="line"><span class="comment">//org.springframework.context.annotation.ConfigurationClassPostProcessor#enhanceConfigurationClasses è¯¥æ–¹æ³•åˆ¤æ–­æ˜¯ä¸æ˜¯éœ€è¦ä»£ç†æ¥å¢å¼º,è¿™é‡Œæ˜¯æ²¡æœ‰çš„,æ‰€ä»¥å°±ç›´æ¥returnæ‰äº†.</span></span><br><span class="line"><span class="comment">// æœ€åæ·»åŠ ä¸€ä¸ª ImportAwareBeanPostProcessor åç½®å¤„ç†å™¨è¿›æ¥.       </span></span><br><span class="line">      invokeBeanFactoryPostProcessors(registryProcessors, beanFactory);</span><br><span class="line"><span class="comment">// è¿™é‡Œçš„regularPostProcessors é›†åˆæ˜¯empty.       </span></span><br><span class="line">      invokeBeanFactoryPostProcessors(regularPostProcessors, beanFactory);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// Invoke factory processors registered with the context instance.</span></span><br><span class="line">      invokeBeanFactoryPostProcessors(beanFactoryPostProcessors, beanFactory);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Do not initialize FactoryBeans here: We need to leave all regular beans</span></span><br><span class="line">   <span class="comment">// uninitialized to let the bean factory post-processors apply to them!</span></span><br><span class="line"> <span class="comment">// org.springframework.context.annotation.internalConfigurationAnnotationProcessorå’Œorg.springframework.context.event.internalEventListenerProcessorè¿™é‡Œè·å–å‡ºæ¥çš„æ˜¯äºŒä¸ª.   </span></span><br><span class="line">   String[] postProcessorNames =</span><br><span class="line">         beanFactory.getBeanNamesForType(BeanFactoryPostProcessor.class, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Separate between BeanFactoryPostProcessors that implement PriorityOrdered,</span></span><br><span class="line">   <span class="comment">// Ordered, and the rest.</span></span><br><span class="line">   List&lt;BeanFactoryPostProcessor&gt; priorityOrderedPostProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">   List&lt;String&gt; orderedPostProcessorNames = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">   List&lt;String&gt; nonOrderedPostProcessorNames = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">   <span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line"> <span class="comment">// è¿™é‡Œæ˜¯å¯¹ä¸Šé¢å·²ç»å¤„ç†è¿‡äº†çš„è¿›è¡Œè¿‡æ»¤å¤„ç†.      </span></span><br><span class="line">      <span class="keyword">if</span> (processedBeans.contains(ppName)) &#123;</span><br><span class="line">         <span class="comment">// skip - already processed in first phase above</span></span><br><span class="line">      &#125;</span><br><span class="line">       </span><br><span class="line"><span class="comment">// è¿™é‡Œåˆ†ä¸º PriorityOrdered&amp;Ordered&amp;éå‰äºŒè€…,åˆ†è¿™ä¸‰ç§æƒ…å†µåˆ†åˆ«æ”¾å…¥åˆ°ä¸‰ä¸ªä¸åŒçš„é›†åˆä¸­.</span></span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;</span><br><span class="line">         priorityOrderedPostProcessors.add(beanFactory.getBean(ppName, BeanFactoryPostProcessor.class));</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;</span><br><span class="line">         orderedPostProcessorNames.add(ppName);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">         nonOrderedPostProcessorNames.add(ppName);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿™é‡Œæ˜¯å¯ä»¥çœ‹åˆ°å…ˆæ˜¯å¯¹PriorityOrderedè¿›è¡Œå¤„ç†,å†å¯¹Orderedå¤„ç†,æœ€åå¯¹éå‰äºŒè€…è¿›è¡Œå¤„ç†.    </span></span><br><span class="line">   <span class="comment">// First, invoke the BeanFactoryPostProcessors that implement PriorityOrdered.</span></span><br><span class="line">   sortPostProcessors(priorityOrderedPostProcessors, beanFactory);</span><br><span class="line">   invokeBeanFactoryPostProcessors(priorityOrderedPostProcessors, beanFactory);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Next, invoke the BeanFactoryPostProcessors that implement Ordered.</span></span><br><span class="line">   List&lt;BeanFactoryPostProcessor&gt; orderedPostProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;(orderedPostProcessorNames.size());</span><br><span class="line">   <span class="keyword">for</span> (String postProcessorName : orderedPostProcessorNames) &#123;</span><br><span class="line"> <span class="comment">// æ³¨æ„è¿™é‡Œæ˜¯è°ƒç”¨äº†getBeanæ–¹æ³•.      </span></span><br><span class="line">      orderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class));</span><br><span class="line">   &#125;</span><br><span class="line"><span class="comment">// æ’åº    </span></span><br><span class="line">   sortPostProcessors(orderedPostProcessors, beanFactory);</span><br><span class="line">   invokeBeanFactoryPostProcessors(orderedPostProcessors, beanFactory);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Finally, invoke all other BeanFactoryPostProcessors.</span></span><br><span class="line">   List&lt;BeanFactoryPostProcessor&gt; nonOrderedPostProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;(nonOrderedPostProcessorNames.size());</span><br><span class="line">   <span class="keyword">for</span> (String postProcessorName : nonOrderedPostProcessorNames) &#123;</span><br><span class="line"> <span class="comment">// æ³¨æ„è¿™é‡Œä¹Ÿæ˜¯è°ƒç”¨äº† getBean æ–¹æ³•çš„.      </span></span><br><span class="line">      nonOrderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class));</span><br><span class="line">   &#125;</span><br><span class="line"><span class="comment">// org.springframework.context.event.EventListenerMethodProcessor#postProcessBeanFactory</span></span><br><span class="line"><span class="comment">// è¿™é‡Œç”±äºåªæœ‰ä¸€ä¸ªEventListenerMethodProcessorå¤„ç†å™¨,æ‰€ä»¥å¯¹åº”èµ·æ¥çš„èµ°åˆ°å…¶postProcessBeanFactoryæ–¹æ³•ä¸­æ¥.</span></span><br><span class="line"><span class="comment">// è¿™é‡Œä¹Ÿæ˜¯è°ƒç”¨ postProcessBeanFactory æ–¹æ³•çš„æ„æ€,ä¹Ÿå°±æ˜¯å›è°ƒæ–¹æ³•.    </span></span><br><span class="line">   invokeBeanFactoryPostProcessors(nonOrderedPostProcessors, beanFactory);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Clear cached merged bean definitions since the post-processors might have</span></span><br><span class="line">   <span class="comment">// modified the original metadata, e.g. replacing placeholders in values...</span></span><br><span class="line"><span class="comment">// org.springframework.beans.factory.support.DefaultListableBeanFactory#clearMetadataCache</span></span><br><span class="line"><span class="comment">// å¯¹ ä¸€äº›é›†åˆç­‰è¿›è¡Œæ¸…é™¤.    </span></span><br><span class="line">   beanFactory.clearMetadataCache();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>è‡³æ­¤å°±å¯ä»¥çœ‹åˆ°,è¯¥æ–¹æ³•ä¸»è¦æ˜¯å¯¹BeanDefinitionRegistryPostProcessor.classå’ŒBeanFactoryPostProcessor.classæ¥è¿›è¡Œå¤„ç†.</p>
<p>BeanDefinitionRegistryPostProcessor åˆæ˜¯å…ˆå¤„ç†PriorityOrdered,ç„¶åä¼šå°†å¤„ç†è¿‡çš„æ”¾å…¥processedBeansé›†åˆä¸­åšä¸€ä¸ªæ€»çš„è®°å½•ï¼Œå†å¤„ç†éå†processedBeansé›†åˆè®°å½•ä¸­çš„å’Œæ˜¯Orderedçš„,æœ€åç”¨whileå¾ªç¯æ¥å†ç¡®è®¤ä¸€éæ˜¯ä¸æ˜¯æœ‰è¿˜æ²¡å¤„ç†çš„,è¿™ä¸ªæ—¶å€™æ§åˆ¶æ¡ä»¶ä¹Ÿæ˜¯é€šè¿‡ processedBeansæ¥æ§åˆ¶æ˜¯ä¸æ˜¯å¤„ç†è¿‡äº†çš„. è¿™é‡Œæ³¨æ„, å®ä¾‹åŒ–æ˜¯é€šè¿‡è°ƒç”¨ getBeanæ–¹æ³•æ¥å®ç°çš„,æ‰€ä»¥ä½ ä¼šå‘ç°å†è°ƒç”¨invokeBeanDefinitionRegistryPostProcessorsæ–¹æ³•ä¹‹å‰,éƒ½æ˜¯ä¼šæœ‰è°ƒç”¨getBeanæ–¹æ³•çš„.</p>
<p>BeanFactoryPostProcessor çš„å¤„ç†,è¿™é‡Œæ˜¯ä¸€æ¬¡è·å–å‡º,ç„¶ååˆ†ä¸º PriorityOrdered/Ordered/éå‰äºŒè€…ï¼Œåˆ†åˆ«æ”¾å…¥ä¸‰ä¸ªé›†åˆä¸­è¿›è¡Œå¤„ç†,å‰ææ˜¯éƒ½æ²¡å† processedBeans é›†åˆä¸­. è¿™é‡Œå¯ä»¥çœ‹åˆ°,å¦‚æœæ˜¯PriorityOrderedç±»å‹çš„è¯ï¼Œé‚£ä¹ˆåœ¨åˆ†ç±»çš„æ—¶å€™å°±å·²ç»è°ƒç”¨getBeanæ–¹æ³•æ¥å®ä¾‹åŒ–è¿™ä¸ªå¯¹è±¡äº†ï¼Œå…¶ä»–äºŒè€…éƒ½æ˜¯æœ€åè¿­ä»£éå†çš„æ—¶å€™è°ƒç”¨getBeanæ–¹æ³•çš„. æœ€åéƒ½æ˜¯sortPostProcessorsèµ°ä¸‹æ’åºï¼Œç„¶åè°ƒç”¨invokeBeanFactoryPostProcessorsæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•çš„æ„æ€ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨ é‡å†™çš„ postProcessBeanFactory çš„æ–¹æ³•.</p>

        <h5 id="registerBeanPostProcessors-æ–¹æ³•"   >
          <a href="#registerBeanPostProcessors-æ–¹æ³•" class="heading-link"><i class="fas fa-link"></i></a><a href="#registerBeanPostProcessors-æ–¹æ³•" class="headerlink" title="registerBeanPostProcessors æ–¹æ³•"></a>registerBeanPostProcessors æ–¹æ³•</h5>
      <p>è¯¥æ–¹æ³•ä¼ å…¥ beanFactoryè¿›æ¥,ç„¶åç›´æ¥å€ŸåŠ© PostProcessorRegistrationDelegate æ¥å®ç°.</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">registerBeanPostProcessors</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">   PostProcessorRegistrationDelegate.registerBeanPostProcessors(beanFactory, <span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h6 id="registerBeanPostProcessors-æ–¹æ³•-1"   >
          <a href="#registerBeanPostProcessors-æ–¹æ³•-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#registerBeanPostProcessors-æ–¹æ³•-1" class="headerlink" title="registerBeanPostProcessors æ–¹æ³•"></a>registerBeanPostProcessors æ–¹æ³•</h6>
      <p>ä»åå­—ä¸Šä¸éš¾ç†è§£ï¼Œæ³¨å†Œ Beançš„åç½®å¤„ç†å™¨è¿›æ¥.</p>
<p>è¿™é‡Œä¼ å…¥è¿›æ¥çš„ beanFactory æ˜¯ DefaultListableBeanFactory , applicationContextæ˜¯AnnotationConfigApplicationContext</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">registerBeanPostProcessors</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">      ConfigurableListableBeanFactory beanFactory, AbstractApplicationContext applicationContext)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–å‡º BeanPostProcessor çš„åå­—.</span></span><br><span class="line"><span class="comment">// org.springframework.context.annotation.internalAutowiredAnnotationProcessor</span></span><br><span class="line"><span class="comment">// org.springframework.context.annotation.internalCommonAnnotationProcessor</span></span><br><span class="line"><span class="comment">// è¿™é‡Œè·å–å‡ºæ¥çš„æ˜¯äºŒä¸ªå†…éƒ¨çš„åç½®å¤„ç†å™¨,å› ä¸ºæˆ‘è¿™é‡Œå¹¶æ²¡æœ‰æ‰©å±•,åªæ˜¯ç®€å•çš„è¿›è¡Œè¯´æ˜äº†ä¸‹,åé¢ä¼šè¯¦ç»†åˆ†æã€‚</span></span><br><span class="line"><span class="comment">// å°±æ˜¯è¿™è¡Œä»£ç è·å–çš„æ˜¯ä»€ä¹ˆ.    </span></span><br><span class="line">   String[] postProcessorNames = beanFactory.getBeanNamesForType(BeanPostProcessor.class, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Register BeanPostProcessorChecker that logs an info message when</span></span><br><span class="line">   <span class="comment">// a bean is created during BeanPostProcessor instantiation, i.e. when</span></span><br><span class="line">   <span class="comment">// a bean is not eligible for getting processed by all BeanPostProcessors.</span></span><br><span class="line"> <span class="comment">// 6   </span></span><br><span class="line">   <span class="keyword">int</span> beanProcessorTargetCount = beanFactory.getBeanPostProcessorCount() + <span class="number">1</span> + postProcessorNames.length;</span><br><span class="line"><span class="comment">// ä¼ å…¥beanFactoryå’Œä¸ªæ•°,åˆ›å»ºå‡ºä¸€ä¸ªæ£€æŸ¥beançš„åç½®å¤„ç†å™¨æ¥.</span></span><br><span class="line"><span class="comment">// org.springframework.context.support.PostProcessorRegistrationDelegate.BeanPostProcessorChecker</span></span><br><span class="line"><span class="comment">// æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥çœ‹åˆ°è¯¥åç½®å¤„ç†å™¨é‡å†™çš„æ–¹æ³•åšäº†ä»€ä¹ˆäº‹æƒ….</span></span><br><span class="line"><span class="comment">// æœ€åæ·»åŠ åˆ° beanFactory ä¸­æ¥.    </span></span><br><span class="line">   beanFactory.addBeanPostProcessor(<span class="keyword">new</span> BeanPostProcessorChecker(beanFactory, beanProcessorTargetCount));</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Separate between BeanPostProcessors that implement PriorityOrdered,</span></span><br><span class="line">   <span class="comment">// Ordered, and the rest.</span></span><br><span class="line">   List&lt;BeanPostProcessor&gt; priorityOrderedPostProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">   List&lt;BeanPostProcessor&gt; internalPostProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">   List&lt;String&gt; orderedPostProcessorNames = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">   List&lt;String&gt; nonOrderedPostProcessorNames = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    </span><br><span class="line"> <span class="comment">// å¯¹åç½®å¤„ç†å™¨è¿›è¡Œè¿­ä»£   </span></span><br><span class="line">   <span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line">      <span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;</span><br><span class="line">   <span class="comment">// æ³¨æ„è¿™é‡Œè°ƒç”¨ getBean æ–¹æ³•æ˜¯å·²ç»å®ä¾‹åŒ–è¿™ä¸ªåç½®å¤„ç†èµ·äº†.</span></span><br><span class="line"><span class="comment">// AutowiredAnnotationBeanPostProcessor</span></span><br><span class="line"><span class="comment">// CommonAnnotationBeanPostProcessor</span></span><br><span class="line"> <span class="comment">// è¿™é‡Œå®ä¾‹åŒ–çš„æ˜¯Springå†…ç½®çš„äºŒä¸ª         </span></span><br><span class="line">         BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class);</span><br><span class="line">         priorityOrderedPostProcessors.add(pp);</span><br><span class="line">      <span class="comment">// å†…éƒ¨çš„äºŒä¸ªåç½®å¤„ç†å™¨éƒ½æ˜¯æœ‰å®ç°   MergedBeanDefinitionPostProcessor çš„. </span></span><br><span class="line">         <span class="keyword">if</span> (pp <span class="keyword">instanceof</span> MergedBeanDefinitionPostProcessor) &#123;</span><br><span class="line">            internalPostProcessors.add(pp);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;</span><br><span class="line">         orderedPostProcessorNames.add(ppName);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">         nonOrderedPostProcessorNames.add(ppName);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// First, register the BeanPostProcessors that implement PriorityOrdered.</span></span><br><span class="line"><span class="comment">// æ’åº    </span></span><br><span class="line">   sortPostProcessors(priorityOrderedPostProcessors, beanFactory);</span><br><span class="line"><span class="comment">// æ·»åŠ åˆ° org.springframework.beans.factory.support.AbstractBeanFactory#beanPostProcessors,ä¹Ÿå°±æ˜¯æ·»åŠ åˆ°Springçš„BanFactoryä¸­æ¥.    </span></span><br><span class="line">   registerBeanPostProcessors(beanFactory, priorityOrderedPostProcessors);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Next, register the BeanPostProcessors that implement Ordered.</span></span><br><span class="line"><span class="comment">// è¿™é‡Œæ˜¯å¯¹å®ç°äº† Ordered ç±»å‹çš„å¤„ç†ï¼Œå¾ˆæ˜¾ç„¶æˆ‘è¿™é‡Œæ˜¯æ²¡æœ‰çš„.    </span></span><br><span class="line">   List&lt;BeanPostProcessor&gt; orderedPostProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;(orderedPostProcessorNames.size());</span><br><span class="line">   <span class="keyword">for</span> (String ppName : orderedPostProcessorNames) &#123;</span><br><span class="line">      BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class);</span><br><span class="line">      orderedPostProcessors.add(pp);</span><br><span class="line">      <span class="keyword">if</span> (pp <span class="keyword">instanceof</span> MergedBeanDefinitionPostProcessor) &#123;</span><br><span class="line">         internalPostProcessors.add(pp);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   sortPostProcessors(orderedPostProcessors, beanFactory);</span><br><span class="line">   registerBeanPostProcessors(beanFactory, orderedPostProcessors);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Now, register all regular BeanPostProcessors.</span></span><br><span class="line"><span class="comment">// æœ€åæ˜¯å¯¹é PriorityOrderedå’ŒOrderedçš„å¤„ç†ï¼Œ    </span></span><br><span class="line">   List&lt;BeanPostProcessor&gt; nonOrderedPostProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;(nonOrderedPostProcessorNames.size());</span><br><span class="line">   <span class="keyword">for</span> (String ppName : nonOrderedPostProcessorNames) &#123;</span><br><span class="line">      BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class);</span><br><span class="line">      nonOrderedPostProcessors.add(pp);</span><br><span class="line">      <span class="keyword">if</span> (pp <span class="keyword">instanceof</span> MergedBeanDefinitionPostProcessor) &#123;</span><br><span class="line">         internalPostProcessors.add(pp);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   registerBeanPostProcessors(beanFactory, nonOrderedPostProcessors);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Finally, re-register all internal BeanPostProcessors.</span></span><br><span class="line"><span class="comment">// è¿™é‡Œå¯ä»¥çœ‹åˆ°,æœ€åå¯¹å†…éƒ¨çš„åç½®å¤„ç†å™¨åˆé‡æ–°æ³¨å†Œäº†ä¸€é.    </span></span><br><span class="line">   sortPostProcessors(internalPostProcessors, beanFactory);</span><br><span class="line">   registerBeanPostProcessors(beanFactory, internalPostProcessors);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Re-register post-processor for detecting inner beans as ApplicationListeners,</span></span><br><span class="line">   <span class="comment">// moving it to the end of the processor chain (for picking up proxies etc).</span></span><br><span class="line"><span class="comment">// ApplicationListenerDetector è¿™é‡Œä¹Ÿæ˜¯å¯¹  ApplicationListenerDetector ä¹Ÿæ˜¯é‡æ–°æ³¨å†Œä¸€é.   </span></span><br><span class="line">   beanFactory.addBeanPostProcessor(<span class="keyword">new</span> ApplicationListenerDetector(applicationContext));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>è¯¥æ–¹æ³• å€ŸåŠ© org.springframework.context.support.PostProcessorRegistrationDelegate#registerBeanPostProcessors(org.springframework.beans.factory.config.ConfigurableListableBeanFactory, org.springframework.context.support.AbstractApplicationContext) æ¥ï¼Œè·å–BeanPostProcessorçš„åç½®å¤„ç†å™¨,ä¹Ÿæ˜¯åˆ†ä¸º PriorityOrdered / Ordered/ å‰äºŒè€…éƒ½æ²¡æœ‰ï¼Œåœ¨ PriorityOrdered åˆ†ç±»çš„æ—¶å€™ï¼Œå°±å·²ç»è°ƒç”¨äº† getBeanæ–¹æ³•æ¥è·å–å‡º bean å¯¹è±¡æ¥(è¿™é‡Œä¾ç„¶æ˜¯åˆ†ä¸ºäº†ä¸‰ä¸ªé›†åˆæ¥è£…æ•°æ®&amp;å¤„ç†). ç„¶åè°ƒç”¨getBeanæ–¹æ³•å,å°±è°ƒç”¨registerBeanPostProcessorsæ–¹æ³•ï¼Œå°†åç½®å¤„ç†å™¨ç»™æ³¨å†Œåˆ° Spring çš„BeanFactory ä¸­æ¥.</p>
<p>æœ€åè¿˜ä¼šæœ€å†…éƒ¨çš„ BeanPoståç½®å¤„ç†å™¨ &amp; ApplicationListenerDetector å†é‡æ–°æ³¨å†Œä¸€é.</p>
<p>å¯èƒ½ä¼šæ¯”è¾ƒå¥½å¥‡è¿™ä¸ªåç½®å¤„ç†å™¨æ˜¯å¹²ä»€ä¹ˆç”¨çš„ ï¼Ÿ åœ¨åé¢å®ä¾‹åŒ– bean çš„æ—¶å€™ï¼Œå°±å¯ä»¥çœ‹åˆ°æ˜¯æœ‰èµ°å¾ˆå¤šåç½®å¤„ç†å™¨çš„.</p>
<p>æ‰€ä»¥è¯¥æ–¹æ³•æ˜¯å¯¹ beanPostçš„åç½®å¤„ç†å™¨è¿›è¡Œå®ä¾‹åŒ–å¹¶ä¸”æ³¨å†Œåˆ° Spring çš„ BeanFactory ä¸­æ¥çš„.</p>

        <h5 id="initMessageSource-æ–¹æ³•"   >
          <a href="#initMessageSource-æ–¹æ³•" class="heading-link"><i class="fas fa-link"></i></a><a href="#initMessageSource-æ–¹æ³•" class="headerlink" title="initMessageSource () æ–¹æ³•"></a>initMessageSource () æ–¹æ³•</h5>
      <p>åˆå§‹åŒ– messageSource .</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Initialize the MessageSource.</span></span><br><span class="line"><span class="comment"> * Use parent&#x27;s if none defined in this context.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initMessageSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line"> <span class="comment">// è·å–å‡º beanFactory   </span></span><br><span class="line">   ConfigurableListableBeanFactory beanFactory = getBeanFactory();</span><br><span class="line"><span class="comment">// å¦‚æœ beanFactory åŒ…å«äº†åå­—æ˜¯messageSourceçš„æœ¬åœ°bean.    </span></span><br><span class="line">   <span class="keyword">if</span> (beanFactory.containsLocalBean(MESSAGE_SOURCE_BEAN_NAME)) &#123;</span><br><span class="line">  <span class="comment">// ä» beanFactory ä¸­è·å–å‡ºæ¥.     </span></span><br><span class="line">      <span class="keyword">this</span>.messageSource = beanFactory.getBean(MESSAGE_SOURCE_BEAN_NAME, MessageSource.class);</span><br><span class="line">      <span class="comment">// Make MessageSource aware of parent MessageSource.</span></span><br><span class="line"><span class="comment">// this.parentä¸æ˜¯nullå¹¶ä¸”   messageSourceæ˜¯   HierarchicalMessageSourceç±»å‹ </span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.parent != <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.messageSource <span class="keyword">instanceof</span> HierarchicalMessageSource) &#123;</span><br><span class="line">  <span class="comment">// å¼ºè½¬,åˆ¤æ–­  getParentMessageSource æ˜¯ä¸æ˜¯null,å¦‚æœæ˜¯nullçš„è¯,å°±è°ƒç”¨ getInternalParentMessageSource() å°†è·å–å‡ºæ¥çš„å€¼ç»™setè¿›å».     </span></span><br><span class="line">         HierarchicalMessageSource hms = (HierarchicalMessageSource) <span class="keyword">this</span>.messageSource;</span><br><span class="line">         <span class="keyword">if</span> (hms.getParentMessageSource() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Only set parent context as parent MessageSource if no parent MessageSource</span></span><br><span class="line">            <span class="comment">// registered already.</span></span><br><span class="line">            hms.setParentMessageSource(getInternalParentMessageSource());</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">         logger.trace(<span class="string">&quot;Using MessageSource [&quot;</span> + <span class="keyword">this</span>.messageSource + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// è¿™é‡Œæ˜¯ä¸åŒ…å«çš„æƒ…å†µ.       </span></span><br><span class="line">      <span class="comment">// Use empty MessageSource to be able to accept getMessage calls.</span></span><br><span class="line">      DelegatingMessageSource dms = <span class="keyword">new</span> DelegatingMessageSource();</span><br><span class="line"><span class="comment">// getInternalParentMessageSource() è¿”å›çš„æ˜¯null       </span></span><br><span class="line">      dms.setParentMessageSource(getInternalParentMessageSource());</span><br><span class="line">      <span class="keyword">this</span>.messageSource = dms;</span><br><span class="line"><span class="comment">// æ³¨å†Œåˆ° beanFactory ä¸­æ¥       </span></span><br><span class="line">      beanFactory.registerSingleton(MESSAGE_SOURCE_BEAN_NAME, <span class="keyword">this</span>.messageSource);</span><br><span class="line">      <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">         logger.trace(<span class="string">&quot;No &#x27;&quot;</span> + MESSAGE_SOURCE_BEAN_NAME + <span class="string">&quot;&#x27; bean, using [&quot;</span> + <span class="keyword">this</span>.messageSource + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>è¯¥æ–¹æ³•å¯ä»¥çœ‹åˆ°æ˜¯å¯¹ messageSource çš„åˆå§‹åŒ–è¿›è¡Œæ“ä½œ.</p>

        <h5 id="initApplicationEventMulticaster-æ–¹æ³•"   >
          <a href="#initApplicationEventMulticaster-æ–¹æ³•" class="heading-link"><i class="fas fa-link"></i></a><a href="#initApplicationEventMulticaster-æ–¹æ³•" class="headerlink" title="initApplicationEventMulticaster æ–¹æ³•"></a>initApplicationEventMulticaster æ–¹æ³•</h5>
      <p>è¿™é‡Œå¦‚æœäº†è§£è¿‡ Spring çš„Event æœºåˆ¶çš„è¯,æ˜¯å¯ä»¥æ¯”è¾ƒæ¸…æ™°çš„æ„Ÿè§‰åˆ°,æ˜¯å¯¹ ApplicationEventMulticaster çš„åˆå§‹åŒ–.</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Initialize the ApplicationEventMulticaster.</span></span><br><span class="line"><span class="comment"> * Uses SimpleApplicationEventMulticaster if none defined in the context.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> org.springframework.context.event.SimpleApplicationEventMulticaster</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initApplicationEventMulticaster</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// è·å–å‡º beanFactory æ¥.  </span></span><br><span class="line">   ConfigurableListableBeanFactory beanFactory = getBeanFactory();</span><br><span class="line"><span class="comment">// åˆ¤æ–­ beanFactory æ˜¯å¦åŒ…å«  applicationEventMulticaster    </span></span><br><span class="line">   <span class="keyword">if</span> (beanFactory.containsLocalBean(APPLICATION_EVENT_MULTICASTER_BEAN_NAME)) &#123;</span><br><span class="line"><span class="comment">// å¦‚æœåŒ…å«çš„è¯ï¼Œå°±ç›´æ¥ä»beanFactroyä¸­è·å–å‡ºæ¥,å¹¶ä¸”èµ‹å€¼ç»™  applicationEventMulticaster  </span></span><br><span class="line">      <span class="keyword">this</span>.applicationEventMulticaster =</span><br><span class="line">            beanFactory.getBean(APPLICATION_EVENT_MULTICASTER_BEAN_NAME, ApplicationEventMulticaster.class);</span><br><span class="line">      <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">         logger.trace(<span class="string">&quot;Using ApplicationEventMulticaster [&quot;</span> + <span class="keyword">this</span>.applicationEventMulticaster + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line"> <span class="comment">// å¦‚æœä¸åŒ…å«çš„è¯,ä¼ å…¥beanFactoryæ¥ç€å°±æ˜¯newä¸€ä¸ªSimpleApplicationEventMulticasterå‡ºæ¥      </span></span><br><span class="line">      <span class="keyword">this</span>.applicationEventMulticaster = <span class="keyword">new</span> SimpleApplicationEventMulticaster(beanFactory);</span><br><span class="line"><span class="comment">// ç„¶åæ³¨å†Œåˆ° beanFactory ä¸­æ¥.      </span></span><br><span class="line">      beanFactory.registerSingleton(APPLICATION_EVENT_MULTICASTER_BEAN_NAME, <span class="keyword">this</span>.applicationEventMulticaster);</span><br><span class="line">      <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">         logger.trace(<span class="string">&quot;No &#x27;&quot;</span> + APPLICATION_EVENT_MULTICASTER_BEAN_NAME + <span class="string">&quot;&#x27; bean, using &quot;</span> +</span><br><span class="line">               <span class="string">&quot;[&quot;</span> + <span class="keyword">this</span>.applicationEventMulticaster.getClass().getSimpleName() + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>è¿™é‡Œå¯ä»¥çœ‹åˆ°, ä¸»è¦æ˜¯å¯¹ applicationEventMulticaster çš„åˆå§‹åŒ–.</p>
<p>å¦‚æœbeanFactoryæœ‰çš„è¯ï¼Œå°±ä»å…¶ä¸­æ‹¿ï¼Œå¦‚æœæ²¡æœ‰å°±è‡ªå·±newä¸€ä¸ª,æœ€åæ³¨å†Œåˆ°beanFactoryä¸­æ¥.</p>

        <h5 id="onRefresh-æ–¹æ³•"   >
          <a href="#onRefresh-æ–¹æ³•" class="heading-link"><i class="fas fa-link"></i></a><a href="#onRefresh-æ–¹æ³•" class="headerlink" title="onRefresh() æ–¹æ³•"></a>onRefresh() æ–¹æ³•</h5>
      <p>è¿™é‡Œæ˜¯æ²¡æœ‰åšä»»ä½•äº‹æƒ…çš„ï¼Œå¦‚æœæ˜¯SpringBootçš„æºç çš„ï¼Œè¿™é‡Œå°±æ˜¯å¯åŠ¨tomcatçš„.</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Template method which can be overridden to add context-specific refresh work.</span></span><br><span class="line"><span class="comment"> * Called on initialization of special beans, before instantiation of singletons.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;This implementation is empty.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> BeansException in case of errors</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #refresh()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onRefresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">   <span class="comment">// For subclasses: do nothing by default.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="registerListeners-æ–¹æ³•"   >
          <a href="#registerListeners-æ–¹æ³•" class="heading-link"><i class="fas fa-link"></i></a><a href="#registerListeners-æ–¹æ³•" class="headerlink" title="registerListeners() æ–¹æ³•"></a>registerListeners() æ–¹æ³•</h5>
      <p>ä»åå­—æ¥çœ‹,è¿™é‡Œæ˜¯æ³¨å†Œç›‘å¬å™¨çš„æ„æ€.</p>
<p>org.springframework.context.event.AbstractApplicationEventMulticaster.ListenerRetriever#applicationListeners è¿™é‡Œæ˜¯å­˜æ”¾ç›‘å¬å™¨çš„åœ°æ–¹ã€‚</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Add beans that implement ApplicationListener as listeners.</span></span><br><span class="line"><span class="comment"> * Doesn&#x27;t affect other listeners, which can be added without being beans.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">registerListeners</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="comment">// Register statically specified listeners first.</span></span><br><span class="line"><span class="comment">// getApplicationListeners() è·å–å‡ºæ¥çš„æ˜¯ç©ºé›†åˆ.    </span></span><br><span class="line">   <span class="keyword">for</span> (ApplicationListener&lt;?&gt; listener : getApplicationListeners()) &#123;</span><br><span class="line">      getApplicationEventMulticaster().addApplicationListener(listener);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Do not initialize FactoryBeans here: We need to leave all regular beans</span></span><br><span class="line">   <span class="comment">// uninitialized to let post-processors apply to them!</span></span><br><span class="line"><span class="comment">// æ ¹æ®ApplicationListeneræ¥è·å–å‡ºç›‘å¬å™¨ï¼Œè¿™ä¹Ÿä¹Ÿæ˜¯æ²¡æœ‰çš„.     </span></span><br><span class="line">   String[] listenerBeanNames = getBeanNamesForType(ApplicationListener.class, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">   <span class="keyword">for</span> (String listenerBeanName : listenerBeanNames) &#123;</span><br><span class="line">      getApplicationEventMulticaster().addApplicationListenerBean(listenerBeanName);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Publish early application events now that we finally have a multicaster...</span></span><br><span class="line"><span class="comment">// è¿™é‡Œä¹Ÿæ˜¯è·å–æ—©åˆå§‹çš„ ApplicationEvent.    </span></span><br><span class="line">   Set&lt;ApplicationEvent&gt; earlyEventsToProcess = <span class="keyword">this</span>.earlyApplicationEvents;</span><br><span class="line">   <span class="keyword">this</span>.earlyApplicationEvents = <span class="keyword">null</span>;</span><br><span class="line">   <span class="keyword">if</span> (earlyEventsToProcess != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span> (ApplicationEvent earlyEvent : earlyEventsToProcess) &#123;</span><br><span class="line">         getApplicationEventMulticaster().multicastEvent(earlyEvent);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>org.springframework.context.event.SimpleApplicationEventMulticaster#multicastEvent(org.springframework.context.ApplicationEvent, org.springframework.core.ResolvableType) å¯ä»¥çœ‹ä¸‹è¿™ä¸ªæ–¹æ³•æˆ–è€…åç»­æˆ‘ä»¬å†è¯¦ç»†çš„çœ‹ï¼ŒSpringæ˜¯å¦‚ä½•å‘é€eventçš„ï¼Œä»¥åŠé‚£äº›ç›‘å¬å™¨æ˜¯æ€ä¹ˆè·å–åˆ° event çš„.</p>
<p>TODO : è¿™é‡Œåé¢æ˜¯æœ‰å¾…è¯¦ç»†çš„è®²è§£çš„.</p>

        <h5 id="finishBeanFactoryInitialization-æ–¹æ³•"   >
          <a href="#finishBeanFactoryInitialization-æ–¹æ³•" class="heading-link"><i class="fas fa-link"></i></a><a href="#finishBeanFactoryInitialization-æ–¹æ³•" class="headerlink" title="finishBeanFactoryInitialization() æ–¹æ³•"></a>finishBeanFactoryInitialization() æ–¹æ³•</h5>
      <p>ä»åå­—ç†è§£ä¸Š,è¿™é‡Œæ˜¯å¯¹ beanFactoryçš„åˆå§‹åŒ–ç»“æŸ.</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Finish the initialization of this context&#x27;s bean factory,</span></span><br><span class="line"><span class="comment"> * initializing all remaining singleton beans.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finishBeanFactoryInitialization</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">   <span class="comment">// Initialize conversion service for this context.</span></span><br><span class="line"> <span class="comment">// å¦‚æœbeanFactroyåŒ…å«conversionServiceå¹¶ä¸”typeæ˜¯ConversionService.classçš„è¯ï¼Œ</span></span><br><span class="line">   <span class="keyword">if</span> (beanFactory.containsBean(CONVERSION_SERVICE_BEAN_NAME) &amp;&amp;</span><br><span class="line">         beanFactory.isTypeMatch(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class)) &#123;</span><br><span class="line"><span class="comment">// å°±ä¼šä»beanFactoryä¸­è·å–å‡ºå¯¹è±¡è®¾ç½®åˆ°beanFactoryçš„ConversionServiceæ¥.       </span></span><br><span class="line">      beanFactory.setConversionService(</span><br><span class="line">            beanFactory.getBean(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Register a default embedded value resolver if no bean post-processor</span></span><br><span class="line">   <span class="comment">// (such as a PropertyPlaceholderConfigurer bean) registered any before:</span></span><br><span class="line">   <span class="comment">// at this point, primarily for resolution in annotation attribute values.</span></span><br><span class="line">   <span class="keyword">if</span> (!beanFactory.hasEmbeddedValueResolver()) &#123;</span><br><span class="line"><span class="comment">//org.springframework.beans.factory.support.AbstractBeanFactory#addEmbeddedValueResolver //æ·»åŠ åˆ°org.springframework.beans.factory.support.AbstractBeanFactory#embeddedValueResolversä¸­æ¥.      </span></span><br><span class="line">      beanFactory.addEmbeddedValueResolver(strVal -&gt; getEnvironment().resolvePlaceholders(strVal));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Initialize LoadTimeWeaverAware beans early to allow for registering their transformers early.</span></span><br><span class="line"><span class="comment">// æ ¹æ®  LoadTimeWeaverAware.class æ¥è·å–ä¿¡æ¯.   </span></span><br><span class="line"><span class="comment">// å¾ˆæ˜æ˜¾è¿™é‡Œæˆ‘ä»¬æ˜¯æ²¡æœ‰é…ç½®çš„,æ‰€ä»¥ä¹Ÿå°±æ˜¯æ²¡æœ‰çš„.    </span></span><br><span class="line">   String[] weaverAwareNames = beanFactory.getBeanNamesForType(LoadTimeWeaverAware.class, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">   <span class="keyword">for</span> (String weaverAwareName : weaverAwareNames) &#123;</span><br><span class="line">      getBean(weaverAwareName);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Stop using the temporary ClassLoader for type matching.</span></span><br><span class="line">   beanFactory.setTempClassLoader(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Allow for caching all bean definition metadata, not expecting further changes.</span></span><br><span class="line"><span class="comment">//org.springframework.beans.factory.support.DefaultListableBeanFactory#freezeConfiguration</span></span><br><span class="line"><span class="comment">// è®¾ç½®configurationFrozenæ˜¯true,</span></span><br><span class="line"><span class="comment">// å°†beanDefinitionNamesé›†åˆè½¬å“ˆä¸ºStringç±»å‹çš„æ•°ç»„. StringUtils.toStringArray(this.beanDefinitionNames);ä½¿ç”¨è¿™ä¸ªæ–¹æ³•å³å¯.    </span></span><br><span class="line">   beanFactory.freezeConfiguration();</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Instantiate all remaining (non-lazy-init) singletons.</span></span><br><span class="line">   beanFactory.preInstantiateSingletons();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h6 id="preInstantiateSingletons-æ–¹æ³•"   >
          <a href="#preInstantiateSingletons-æ–¹æ³•" class="heading-link"><i class="fas fa-link"></i></a><a href="#preInstantiateSingletons-æ–¹æ³•" class="headerlink" title="preInstantiateSingletons æ–¹æ³•"></a>preInstantiateSingletons æ–¹æ³•</h6>
      <p>è¿™é‡Œå°±æ˜¯å¯¹ å•ä¾‹æ±  é‡Œé¢çš„å¯¹è±¡è¿›è¡Œåˆå§‹åŒ–,å¯ä»¥çœ‹åˆ°æ˜¯æœ‰ getBean æ–¹æ³•çš„.</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">preInstantiateSingletons</span><span class="params">()</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">      logger.trace(<span class="string">&quot;Pre-instantiating singletons in &quot;</span> + <span class="keyword">this</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Iterate over a copy to allow for init methods which in turn register new bean definitions.</span></span><br><span class="line">   <span class="comment">// While this may not be part of the regular factory bootstrap, it does otherwise work fine.</span></span><br><span class="line"><span class="comment">// è¿™é‡Œè·å–å‡ºæ¥çš„ beanNames æ˜¯æœ‰6ä¸ªçš„,å…¶ä¸­äº”ä¸ªæ˜¯åŒ…å«äº†å†…éƒ¨çš„</span></span><br><span class="line"><span class="comment">//org.springframework.context.annotation.internalConfigurationAnnotationProcessor</span></span><br><span class="line"><span class="comment">//org.springframework.context.annotation.internalAutowiredAnnotationProcessor</span></span><br><span class="line"><span class="comment">//org.springframework.context.annotation.internalCommonAnnotationProcessor</span></span><br><span class="line"><span class="comment">//org.springframework.context.event.internalEventListenerProcessor</span></span><br><span class="line"><span class="comment">//org.springframework.context.event.internalEventListenerFactory</span></span><br><span class="line"><span class="comment">//yangBeanScannerConfig    </span></span><br><span class="line">   List&lt;String&gt; beanNames = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="keyword">this</span>.beanDefinitionNames);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Trigger initialization of all non-lazy singleton beans...</span></span><br><span class="line">   <span class="keyword">for</span> (String beanName : beanNames) &#123;</span><br><span class="line">      RootBeanDefinition bd = getMergedLocalBeanDefinition(beanName);</span><br><span class="line">       </span><br><span class="line">  <span class="comment">// bd ä¸æ˜¯æŠ½è±¡çš„&amp;æ˜¯å•ä¾‹çš„&amp;ä¸æ˜¯èµ–åŠ è½½çš„     </span></span><br><span class="line">      <span class="keyword">if</span> (!bd.isAbstract() &amp;&amp; bd.isSingleton() &amp;&amp; !bd.isLazyInit()) &#123;</span><br><span class="line">  <span class="comment">// åˆ¤æ–­æ˜¯ä¸æ˜¯ FactroyBean        </span></span><br><span class="line">         <span class="keyword">if</span> (isFactoryBean(beanName)) &#123;</span><br><span class="line">            Object bean = getBean(FACTORY_BEAN_PREFIX + beanName);</span><br><span class="line">            <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> FactoryBean) &#123;</span><br><span class="line">               <span class="keyword">final</span> FactoryBean&lt;?&gt; factory = (FactoryBean&lt;?&gt;) bean;</span><br><span class="line">               <span class="keyword">boolean</span> isEagerInit;</span><br><span class="line">               <span class="keyword">if</span> (System.getSecurityManager() != <span class="keyword">null</span> &amp;&amp; factory <span class="keyword">instanceof</span> SmartFactoryBean) &#123;</span><br><span class="line">                  isEagerInit = AccessController.doPrivileged((PrivilegedAction&lt;Boolean&gt;)</span><br><span class="line">                              ((SmartFactoryBean&lt;?&gt;) factory)::isEagerInit,</span><br><span class="line">                        getAccessControlContext());</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">else</span> &#123;</span><br><span class="line">                  isEagerInit = (factory <span class="keyword">instanceof</span> SmartFactoryBean &amp;&amp;</span><br><span class="line">                        ((SmartFactoryBean&lt;?&gt;) factory).isEagerInit());</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">if</span> (isEagerInit) &#123;</span><br><span class="line">                  getBean(beanName);</span><br><span class="line">               &#125;</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// è¿™é‡Œä¸æ˜¯ FactoryBean  </span></span><br><span class="line"><span class="comment">// å¯ä»¥çœ‹åˆ°å½“æˆ‘èµ°åˆ°yangBeanScannerConfig,æˆ‘ä»¬å®šä¹‰çš„ç±»çš„æ—¶å€™,èµ°å®Œè¿™ä¸ªæ–¹æ³•ï¼Œå°±å¯ä»¥çœ‹åˆ°com.iyang.spring.config.YangBeanScannerConfig#YangBeanScannerConfigä¸­æ‰“å°çš„è¯­å¥äº†,ä¹Ÿå°±æ˜¯è¯´èµ°å®Œè¿™é‡Œï¼Œæˆ‘ä»¬å®šä¹‰çš„beanå°±å·²ç»è¢«Springè¢«å®ä¾‹åŒ–äº†.             </span></span><br><span class="line">            getBean(beanName);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Trigger post-initialization callback for all applicable beans...</span></span><br><span class="line"><span class="comment">// è¿™é‡Œå†å¯¹ beanNames è¿›è¡Œè¿­ä»£,å¦‚æœæ˜¯ SmartInitializingSingleton çš„è¯ï¼Œå°±ä¼šå†è°ƒç”¨    afterSingletonsInstantiated æ–¹æ³•.</span></span><br><span class="line">   <span class="keyword">for</span> (String beanName : beanNames) &#123;</span><br><span class="line">      Object singletonInstance = getSingleton(beanName);</span><br><span class="line">      <span class="keyword">if</span> (singletonInstance <span class="keyword">instanceof</span> SmartInitializingSingleton) &#123;</span><br><span class="line">         <span class="keyword">final</span> SmartInitializingSingleton smartSingleton = (SmartInitializingSingleton) singletonInstance;</span><br><span class="line">         <span class="keyword">if</span> (System.getSecurityManager() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            AccessController.doPrivileged((PrivilegedAction&lt;Object&gt;) () -&gt; &#123;</span><br><span class="line">               smartSingleton.afterSingletonsInstantiated();</span><br><span class="line">               <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;, getAccessControlContext());</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">else</span> &#123;</span><br><span class="line">            smartSingleton.afterSingletonsInstantiated();</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>å¯ä»¥å¯¹æˆ‘ä»¬å®šä¹‰çš„ bean è¿›è¡Œå®ä¾‹åŒ–ï¼Œæœ€åæ˜¯è°ƒç”¨äº† getBean æ–¹æ³•ï¼Œ getBean æ–¹æ³•è¡¨é¢çœ‹ä¸Šå»æ˜¯è·å–ï¼Œå…¶å®å¦‚æœæ²¡æœ‰çš„è¯ï¼Œè°ƒç”¨çš„æ˜¯createBeanæ–¹æ³•, ä¹Ÿå°±æ˜¯ä¼šå®ä¾‹åŒ–æˆ‘ä»¬çš„beanã€‚å½“ç„¶å®ƒè‚¯å®šä¸ä¼šå¾ˆç®€å•çš„å»è°ƒç”¨åå°„å°±å®ä¾‹åŒ–å®Œä¸€ä¸ªæˆ‘ä»¬çš„bean,è‚¯å®šæ˜¯æœ‰ä¸€ç³»åˆ—çš„èµ°Springå†…ç½®çš„æˆ–è€…æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„åç½®å¤„ç†å™¨ç­‰æ“ä½œ.</p>
<p>getBean æ–¹æ³•éœ€è¦åé¢ä¸“é—¨é¢†å‡ºæ¥åˆ†æï¼Œä¸èƒ½ç®€å•çš„è¿‡ï¼Œè¿™é‡Œå¯¹ Spring å®¹å™¨è¿›è¡Œå¤§è‡´çš„flowè¿‡,æ‰€ä»¥è¿˜æ˜¯æ¯”è¾ƒè½»ææ·¡å†™çš„å†™è¿‡å».</p>

        <h5 id="finishRefresh-æ–¹æ³•"   >
          <a href="#finishRefresh-æ–¹æ³•" class="heading-link"><i class="fas fa-link"></i></a><a href="#finishRefresh-æ–¹æ³•" class="headerlink" title="finishRefresh æ–¹æ³•"></a>finishRefresh æ–¹æ³•</h5>
      <p>ä¸­æ–‡å¼çš„è‹±è¯­ : ç»“æŸåˆ·æ–°æ–¹æ³•.</p>
<p>æ˜¾ç¤ºæ¸…é™¤ç¼“å­˜,å†æ˜¯initäº†LifecycleProcessor,è°ƒç”¨å…¶onRefresh()æ–¹æ³•,æ¥è¿‘å°±æ˜¯å‘é€ä¸€ä¸ªContextRefreshedEventäº‹ä»¶å‡ºæ¥.</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Finish the refresh of this context, invoking the LifecycleProcessor&#x27;s</span></span><br><span class="line"><span class="comment"> * onRefresh() method and publishing the</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> org.springframework.context.event.ContextRefreshedEvent&#125;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finishRefresh</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="comment">// Clear context-level resource caches (such as ASM metadata from scanning).</span></span><br><span class="line"><span class="comment">//å¯¹org.springframework.core.io.DefaultResourceLoader#resourceCachesè¿›è¡Œæ¸…é™¤.    </span></span><br><span class="line">   clearResourceCaches();</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Initialize lifecycle processor for this context.</span></span><br><span class="line">   initLifecycleProcessor();</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Propagate refresh to lifecycle processor first.</span></span><br><span class="line"><span class="comment">//org.springframework.context.support.DefaultLifecycleProcessor</span></span><br><span class="line"><span class="comment">//org.springframework.context.support.DefaultLifecycleProcessor#startBeans</span></span><br><span class="line">    </span><br><span class="line">   getLifecycleProcessor().onRefresh();</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Publish the final event.</span></span><br><span class="line"><span class="comment">// æ¨é€Event,è¿™é‡Œçš„Eventæ˜¯ ContextRefreshedEvent.    </span></span><br><span class="line">   publishEvent(<span class="keyword">new</span> ContextRefreshedEvent(<span class="keyword">this</span>));</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Participate in LiveBeansView MBean, if active.</span></span><br><span class="line"><span class="comment">//org.springframework.context.support.LiveBeansView#registerApplicationContext</span></span><br><span class="line"><span class="comment">//å…ˆæ ¹æ®key:spring.liveBeansView.mbeanDomainè·å–value,è¿™é‡Œè·å–å‡ºæ¥çš„æ˜¯null,</span></span><br><span class="line"><span class="comment">// æ‰€ä»¥ä¹Ÿå°±æ˜¯æ²¡æœ‰ä¸‹æ–‡äº†.    </span></span><br><span class="line">   LiveBeansView.registerApplicationContext(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h6 id="initLifecycleProcessor-æ–¹æ³•"   >
          <a href="#initLifecycleProcessor-æ–¹æ³•" class="heading-link"><i class="fas fa-link"></i></a><a href="#initLifecycleProcessor-æ–¹æ³•" class="headerlink" title="initLifecycleProcessor æ–¹æ³• ()"></a>initLifecycleProcessor æ–¹æ³• ()</h6>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Initialize the LifecycleProcessor.</span><br><span class="line"> * Uses DefaultLifecycleProcessor if none defined in the context.</span><br><span class="line"> * @see org.springframework.context.support.DefaultLifecycleProcessor</span><br><span class="line"> */</span><br><span class="line">protected void initLifecycleProcessor() &#123;</span><br><span class="line">  // è·å–å‡º beanFactory æ¥.  </span><br><span class="line">   ConfigurableListableBeanFactory beanFactory = getBeanFactory();</span><br><span class="line">// åˆ¤æ–­beanFactoryä¸­æ˜¯å¦åŒ…å«lifecycleProcessor    </span><br><span class="line">   if (beanFactory.containsLocalBean(LIFECYCLE_PROCESSOR_BEAN_NAME)) &#123;</span><br><span class="line">// åŒ…å«çš„è¯,å°±ä¼šè·å–å‡ºæ¥,æŒ‡å‘this.lifecycleProcessor       </span><br><span class="line">      this.lifecycleProcessor =</span><br><span class="line">            beanFactory.getBean(LIFECYCLE_PROCESSOR_BEAN_NAME, LifecycleProcessor.class);</span><br><span class="line">      if (logger.isTraceEnabled()) &#123;</span><br><span class="line">         logger.trace(&quot;Using LifecycleProcessor [&quot; + this.lifecycleProcessor + &quot;]&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   else &#123;</span><br><span class="line">   // å¦‚æœä¸åŒ…å«çš„è¯ï¼Œå°±è‡ªå·±newä¸€ä¸ª,ç„¶åæ³¨å†Œåˆ°Springå®¹å™¨ä¸­æ¥.    </span><br><span class="line">      DefaultLifecycleProcessor defaultProcessor = new DefaultLifecycleProcessor();</span><br><span class="line">      defaultProcessor.setBeanFactory(beanFactory);</span><br><span class="line">      this.lifecycleProcessor = defaultProcessor;</span><br><span class="line">      beanFactory.registerSingleton(LIFECYCLE_PROCESSOR_BEAN_NAME, this.lifecycleProcessor);</span><br><span class="line">      if (logger.isTraceEnabled()) &#123;</span><br><span class="line">         logger.trace(&quot;No &#x27;&quot; + LIFECYCLE_PROCESSOR_BEAN_NAME + &quot;&#x27; bean, using &quot; +</span><br><span class="line">               &quot;[&quot; + this.lifecycleProcessor.getClass().getSimpleName() + &quot;]&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h6 id="publishEvent-æ–¹æ³•"   >
          <a href="#publishEvent-æ–¹æ³•" class="heading-link"><i class="fas fa-link"></i></a><a href="#publishEvent-æ–¹æ³•" class="headerlink" title="publishEvent æ–¹æ³•"></a>publishEvent æ–¹æ³•</h6>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Publish the given event to all listeners.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> event the event to publish (may be an &#123;<span class="doctag">@link</span> ApplicationEvent&#125;</span></span><br><span class="line"><span class="comment"> * or a payload object to be turned into a &#123;<span class="doctag">@link</span> PayloadApplicationEvent&#125;)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> eventType the resolved event type, if known</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 4.2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">publishEvent</span><span class="params">(Object event, <span class="meta">@Nullable</span> ResolvableType eventType)</span> </span>&#123;</span><br><span class="line">   Assert.notNull(event, <span class="string">&quot;Event must not be null&quot;</span>);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Decorate event as an ApplicationEvent if necessary</span></span><br><span class="line">   ApplicationEvent applicationEvent;</span><br><span class="line">    </span><br><span class="line"><span class="comment">// å¯¹ä¼ å…¥è¿›æ¥çš„ event è¿›è¡Œç±»å‹çš„åˆ¤æ–­.    </span></span><br><span class="line">   <span class="keyword">if</span> (event <span class="keyword">instanceof</span> ApplicationEvent) &#123;</span><br><span class="line">      applicationEvent = (ApplicationEvent) event;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line">      applicationEvent = <span class="keyword">new</span> PayloadApplicationEvent&lt;&gt;(<span class="keyword">this</span>, event);</span><br><span class="line">      <span class="keyword">if</span> (eventType == <span class="keyword">null</span>) &#123;</span><br><span class="line">         eventType = ((PayloadApplicationEvent&lt;?&gt;) applicationEvent).getResolvableType();</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Multicast right now if possible - or lazily once the multicaster is initialized</span></span><br><span class="line">   <span class="keyword">if</span> (<span class="keyword">this</span>.earlyApplicationEvents != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.earlyApplicationEvents.add(applicationEvent);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">//org.springframework.context.event.SimpleApplicationEventMulticaster#multicastEvent(org.springframework.context.ApplicationEvent, org.springframework.core.ResolvableType)</span></span><br><span class="line"><span class="comment">//èµ°åˆ°äº†è¿™é‡Œæ¥å‘é€eventçš„,       </span></span><br><span class="line">      getApplicationEventMulticaster().multicastEvent(applicationEvent, eventType);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Publish event via parent context as well...</span></span><br><span class="line"><span class="comment">// è¿™é‡Œçš„ parentæ˜¯null.    </span></span><br><span class="line">   <span class="keyword">if</span> (<span class="keyword">this</span>.parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.parent <span class="keyword">instanceof</span> AbstractApplicationContext) &#123;</span><br><span class="line">         ((AbstractApplicationContext) <span class="keyword">this</span>.parent).publishEvent(event, eventType);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="keyword">this</span>.parent.publishEvent(event);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>è¿™é‡Œæ˜¯å‘é€ContextRefreshedEventäº‹ä»¶å‡ºæ¥.</p>

        <h5 id="resetCommonCaches-æ–¹æ³•"   >
          <a href="#resetCommonCaches-æ–¹æ³•" class="heading-link"><i class="fas fa-link"></i></a><a href="#resetCommonCaches-æ–¹æ³•" class="headerlink" title="resetCommonCaches æ–¹æ³•()"></a>resetCommonCaches æ–¹æ³•()</h5>
      <p>å¯ä»¥çœ‹åˆ° finally ä»£ç å—ä¸­æ˜¯ç–¯ç‹‚çš„æ¸…é™¤å„ç§ç¼“å­˜.</p>
<p>å¯ä»¥å¤§å®¶å¯ä»¥ç‚¹è¿›å»è¯¦ç»†çš„çœ‹ä¸‹ï¼Œå…·ä½“å°±ä¸ä»”ç»†æè¿°äº†.</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Reset Spring&#x27;s common reflection metadata caches, in particular the</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> ReflectionUtils&#125;, &#123;<span class="doctag">@link</span> AnnotationUtils&#125;, &#123;<span class="doctag">@link</span> ResolvableType&#125;</span></span><br><span class="line"><span class="comment"> * and &#123;<span class="doctag">@link</span> CachedIntrospectionResults&#125; caches.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 4.2</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> ReflectionUtils#clearCache()</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> AnnotationUtils#clearCache()</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> ResolvableType#clearCache()</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> CachedIntrospectionResults#clearClassLoader(ClassLoader)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">resetCommonCaches</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   ReflectionUtils.clearCache();</span><br><span class="line">   AnnotationUtils.clearCache();</span><br><span class="line">   ResolvableType.clearCache();</span><br><span class="line">   CachedIntrospectionResults.clearClassLoader(getClassLoader());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="æ€»ç»“"   >
          <a href="#æ€»ç»“" class="heading-link"><i class="fas fa-link"></i></a><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4>
      <p>æœ€åæ€»ç»“ä¸‹,Springåœ¨åŠ è½½ bean &amp; å¤„ç†å†…ç½®çš„ä¸€äº›é…ç½® &amp; å†…éƒ¨å¤„ç†å™¨çš„æ—¶å€™,æ˜¯ä¸‹äº†å¾ˆå¤šçš„åŠŸå¤«ã€‚å¯ä»¥çœ‹ç€è¿™äº›æ–¹æ³•ä¸€æ­¥ä¸€æ­¥çš„åˆ†æä¸‹å»,ç†è§£èµ·æ¥ï¼Œä¸ªäººæ„Ÿè§‰è¿™é‡Œè¿˜ä¸æ˜¯ç‰¹åˆ«æ·±å…¥çš„è·Ÿè¿›å»äº†ä»£ç ï¼Œåªæ˜¯ä¸€ä¸ªç®€å•çš„å¤§æ¦‚æè¿°ï¼Œæ›´æ·±å…¥çš„çŸ¥è¯†éœ€è¦æ›´åŠ è¯¦ç»†çš„ç†è§£ç­‰äº†.</p>
<p>è¿™é‡Œåªæ˜¯ç®€å•çš„å¯¹è¿™ä¸ªæ•´ä¸ªflowæ¥è¿›è¡Œæè¿°ï¼Œè¿˜ä¸æ˜¯ç‰¹åˆ«æœ‰è¯¦ç»†çš„é‚£ç§.</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/11/04/spring/spring%E5%88%9D%E5%A7%8B%E5%8C%96-%E4%B8%89/">springåˆå§‹åŒ–(ä¸‰)</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">å‘è¡¨äº</span><span class="post-meta-item__value">2021-11-04</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">æ›´æ–°äº</span><span class="post-meta-item__value">2021-11-04</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">å­—æ•°ç»Ÿè®¡</span><span class="post-meta-item__value">2.2k</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="far fa-clock"></i></span><span class="post-meta-item__info">é˜…è¯»æ—¶é•¿</span><span class="post-meta-item__value">16åˆ†</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h4 id="é¢˜è®°"   >
          <a href="#é¢˜è®°" class="heading-link"><i class="fas fa-link"></i></a><a href="#é¢˜è®°" class="headerlink" title="é¢˜è®°"></a>é¢˜è®°</h4>
      <p> å‰é¢è®²åˆ°äº†è¿™ä¹ˆå¤šçš„ä»€ä¹ˆBeanPostProcessor,äº‹ä»¶ä»€ä¹ˆçš„. å¦‚æœä¸å†™å‡ ä¸‹ä»£ç è¿™é‡Œæ€•æ˜¯å¾ˆéš¾å¼„æ¸…æ¥šæ˜¯ä¸ªæ€ä¹ˆå›äº‹. æ‰€ä»¥åªæœ‰çœ‹åˆ°ä»£ç è·‘,å°±å¤§è‡´å¯ä»¥çœ‹åˆ°å…¶æ•ˆæœè¿˜æ˜¯å¾ˆæ˜æ˜¾çš„.</p>

        <h4 id="BeanDefinitionRegistryPostProcessor"   >
          <a href="#BeanDefinitionRegistryPostProcessor" class="heading-link"><i class="fas fa-link"></i></a><a href="#BeanDefinitionRegistryPostProcessor" class="headerlink" title="BeanDefinitionRegistryPostProcessor"></a>BeanDefinitionRegistryPostProcessor</h4>
      <p> å…ˆå†™ä¸€ä¸ªç±»ç®€å•å®ç°ä¸‹ BeanDefinitionRegistryPostProcessor è¿™ä¸ªæ¥å£ :</p>
<p> è¿è¡Œåçš„ç»“æœæ˜¯å¯ä»¥å¾ˆæ˜æ˜¾çš„çœ‹åˆ°æˆ‘ä»¬çš„æ‰“å°æ•°æ®è¾“å‡ºç»“æœçš„.</p>
<p> ç¨‹åºæ˜¯æ€ä¹ˆè¿è¡Œåˆ°è¿™ä¸ªåœ°æ–¹æ¥çš„å‘¢ï¼Ÿ</p>
<p>org.springframework.context.support.PostProcessorRegistrationDelegate#invokeBeanFactoryPostProcessors(org.springframework.beans.factory.config.ConfigurableListableBeanFactory, java.util.List&lt;org.springframework.beans.factory.config.BeanFactoryPostProcessor&gt;) èµ°åˆ°è¿™ä¸ªæ–¹æ³•çš„</p>
<p>beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.classâ€¦..),ä»è¿™ä¸ªç±»ä¸­è·å–å‡ºæ¥çš„postProcessorNames,å°±æœ‰åŒ…å«æˆ‘ä»¬çš„è‡ªå·±å®šä¹‰çš„ä¸€ä¸ª.</p>
<p>ç”±äºæˆ‘ä»¬è‡ªå·±æ‰©å±•çš„è¿™ä¸ªç±»,æ˜¯æ²¡æœ‰å®ç° PriorityOrdered/Orderedçš„,æ‰€ä»¥å°±æ”¾åˆ°æœ€åæ¥å¤„ç†äº†.</p>
<p>ä¹Ÿå°±æ˜¯åœ¨è¿™ä¸ªæ–¹æ³•,while (reiterate) { â€¦ invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry);}</p>
<p>èµ°çš„è¿™ä¸ªæ–¹æ³•çš„æ—¶å€™,æ‰ä¼šå»èµ°åˆ°æˆ‘ä»¬å®šä¹‰çš„ç±»ã€‚</p>
<p>é‚£æ˜¯å› ä¸ºè¿™ä¸ªåœ°æ–¹ Springæ˜¯æœ‰å¤„ç†é¡ºåºçš„ã€‚ å…ˆå¤„ç† PriorityOrdered.class , å†å¤„ç† Ordered.class , æœ€åå¤„ç†æ—¢æ²¡æœ‰PriorityOrdered,ä¹Ÿæ²¡æœ‰Orderedçš„.</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GavinYangRegistryPostProcessor</span> <span class="keyword">implements</span> <span class="title">BeanDefinitionRegistryPostProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GavinYangRegistryPostProcessor</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;GavinYangRegistryPostProcessor æ„é€ æ–¹æ³•æ‰§è¡Œ&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessBeanDefinitionRegistry</span><span class="params">(BeanDefinitionRegistry registry)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;è°ƒç”¨åˆ° GavinYangRegistryPostProcessor#postProcessBeanDefinitionRegistryæ–¹æ³•&quot;</span>);</span><br><span class="line">        String[] beanDefinitionNames = registry.getBeanDefinitionNames();</span><br><span class="line">        String bdNamesString = Arrays.toString(beanDefinitionNames);</span><br><span class="line">        System.out.println(<span class="string">&quot;GavinYangRegistryPostProcessor ç±»ä¸­&quot;</span> + bdNamesString);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="BeanFactoryPostProcessor"   >
          <a href="#BeanFactoryPostProcessor" class="heading-link"><i class="fas fa-link"></i></a><a href="#BeanFactoryPostProcessor" class="headerlink" title="BeanFactoryPostProcessor"></a>BeanFactoryPostProcessor</h4>
      <p> ç®€å•å®ç°ä¸€ä¸‹ BeanFactoryPostProcessor è¿™ä¸ªæ¥å£æ¥çœ‹ä¸€ä¸‹æ•ˆæœ.</p>
<p> å…ˆå†™ä¸€ä¸ªç±» : ç„¶åå®ç°ä¸€ä¸‹è¿™ä¸ªæ¥å£ BeanFactoryPostProcessor , æˆ‘ä»¬è¿™é‡Œå°±è·å–ä¸‹beanFactoryä¸­çš„æ‰€æœ‰beanDefinitionNamesçš„æ•°ç»„, ç„¶åæ‰“å°å‡ºæ¥çœ‹ä¸‹æ•ˆæœ. æ‰“å°ç»“æœä¹Ÿæ˜¯è´´åœ¨ä¸‹é¢çš„. æ¥ç€æˆ‘ä»¬çœ‹ä¸‹å…¶æºç æ˜¯ä¸€ä¸ªæ€ä¹ˆæ ·çš„èµ°å‘.</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GavinYangBeanFactoryPostProcessor</span> <span class="keyword">implements</span> <span class="title">BeanFactoryPostProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        String[] beanDefinitionNames = beanFactory.getBeanDefinitionNames();</span><br><span class="line">        System.out.println(Arrays.toString(beanDefinitionNames));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//[org.springframework.context.annotation.internalConfigurationAnnotationProcessor, org.springframework.context.annotation.internalAutowiredAnnotationProcessor, org.springframework.context.annotation.internalCommonAnnotationProcessor, org.springframework.context.event.internalEventListenerProcessor, org.springframework.context.event.internalEventListenerFactory, yangBeanOne, gavinYangBeanFactoryPostProcessor, yangBeanPostProcessor, gavinYangLifeImpl]</span></span><br></pre></td></tr></table></div></figure>

<p>ç›´æ¥çœ‹è¿™ä¸ªç±»çš„è¿™ä¸ªæ–¹æ³•ï¼Œæˆ‘è¿™é‡Œåªæˆªå–äº†ä¸€éƒ¨åˆ†ä»£ç ,ä¹Ÿå°±æ˜¯å’Œ BeanFactoryPostProcessor æœ‰å…³çš„ä»£ç .</p>
<p>å’Œå®ƒæ²¡å…³ç³»çš„ä»£ç ,è¿™é‡Œå°±æ²¡æœ‰å»æˆªå–äº†.</p>
<p>org.springframework.context.support.PostProcessorRegistrationDelegate#invokeBeanFactoryPostProcessors(org.springframework.beans.factory.config.ConfigurableListableBeanFactory, java.util.List&lt;org.springframework.beans.factory.config.BeanFactoryPostProcessor&gt;) .</p>
<p>çœ‹æºç çœ‹æ˜¯å¦‚ä½•è°ƒç”¨åˆ°è¿™ä¸ªæ–¹æ³•çš„,è¿˜æ˜¯æ¯”è¾ƒå¥½ç†è§£ã€‚å…ˆæ˜¯æ ¹æ® BeanFactoryPostProcessor.classè·å–å‡ºbeanNameçš„é›†åˆ,ç„¶åè€è§„çŸ©è¿›è¡Œä¸€äº›ç‰¹å®šçš„æ’åº,å½“ç„¶æˆ‘è¿™é‡Œä»€ä¹ˆéƒ½æ²¡åš,ä¹Ÿå°±æ˜¯æœ€åå¤„ç†å“¦ã€‚</p>
<p>ç„¶åè·Ÿåˆ°invokeBeanFactoryPostProcessors(nonOrderedPostProcessors, beanFactory);è¿™ä¸ªæ–¹æ³•é‡Œé¢,å¯ä»¥çœ‹åˆ°å®ƒè¿­ä»£è¿™ä¸ªé›†åˆçš„å…ƒç´ ,å½“ç„¶äº†,æˆ‘ä»¬åªéœ€è¦å…³æ³¨æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„å“ªä¸ªå°±å¯ä»¥äº†,ç„¶åå°±ä¼šèµ°å…¶postProcessBeanFactoryæ–¹æ³•,ä¹Ÿå°±æ˜¯èµ°åˆ°äº†æˆ‘ä»¬å®šä¹‰çš„ç±»çš„è¿™ä¸ªæ–¹æ³•ä¸Šæ¥äº†.</p>
<p>OKå•¦ã€‚å¤§è‡´æµç¨‹å°±æ˜¯è¿™ä¸ªæ ·å­çš„,è¿˜æ˜¯æ¯”è¾ƒå¥½ç†è§£çš„.</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Do not initialize FactoryBeans here: We need to leave all regular beans</span></span><br><span class="line"><span class="comment">// uninitialized to let the bean factory post-processors apply to them!</span></span><br><span class="line"><span class="comment">// è¿™ä¸ªåœ°æ–¹è·å–å‡ºæ¥çš„æ•°ç»„é‡Œé¢çš„å€¼,å°±æœ‰æˆ‘ä»¬æƒ³çœ‹åˆ°çš„.</span></span><br><span class="line"><span class="comment">//org.springframework.context.annotation.internalConfigurationAnnotationProcessor</span></span><br><span class="line"><span class="comment">//org.springframework.context.event.internalEventListenerProcessor</span></span><br><span class="line"><span class="comment">//gavinYangBeanFactoryPostProcessor</span></span><br><span class="line"><span class="comment">//å½“çœ‹åˆ°ç¬¬ä¸‰ä¸ªæ˜¯ä¸æ˜¯éå¸¸çš„ç†Ÿæ‚‰.æ²¡é”™,è¿™å°±æ˜¯æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„.</span></span><br><span class="line">String[] postProcessorNames =</span><br><span class="line">      beanFactory.getBeanNamesForType(BeanFactoryPostProcessor.class, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Separate between BeanFactoryPostProcessors that implement PriorityOrdered,</span></span><br><span class="line"><span class="comment">// Ordered, and the rest.</span></span><br><span class="line">List&lt;BeanFactoryPostProcessor&gt; priorityOrderedPostProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">List&lt;String&gt; orderedPostProcessorNames = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">List&lt;String&gt; nonOrderedPostProcessorNames = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"><span class="comment">// ç„¶åå…ˆç»è¿‡ä¸€è½®æ’åº,å°±å¯ä»¥çœ‹åˆ° æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„å°±æ”¾å…¥åˆ°äº†nonOrderedPostProcessorNamesè¿™ä¸ªé›†åˆä¸­,</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line">   <span class="keyword">if</span> (processedBeans.contains(ppName)) &#123;</span><br><span class="line">      <span class="comment">// skip - already processed in first phase above</span></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> <span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;</span><br><span class="line">      priorityOrderedPostProcessors.add(beanFactory.getBean(ppName, BeanFactoryPostProcessor.class));</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> <span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;</span><br><span class="line">      orderedPostProcessorNames.add(ppName);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line">      nonOrderedPostProcessorNames.add(ppName);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// First, invoke the BeanFactoryPostProcessors that implement PriorityOrdered.</span></span><br><span class="line">sortPostProcessors(priorityOrderedPostProcessors, beanFactory);</span><br><span class="line">invokeBeanFactoryPostProcessors(priorityOrderedPostProcessors, beanFactory);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Next, invoke the BeanFactoryPostProcessors that implement Ordered.</span></span><br><span class="line">List&lt;BeanFactoryPostProcessor&gt; orderedPostProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;(orderedPostProcessorNames.size());</span><br><span class="line"><span class="keyword">for</span> (String postProcessorName : orderedPostProcessorNames) &#123;</span><br><span class="line">   orderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class));</span><br><span class="line">&#125;</span><br><span class="line">sortPostProcessors(orderedPostProcessors, beanFactory);</span><br><span class="line">invokeBeanFactoryPostProcessors(orderedPostProcessors, beanFactory);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Finally, invoke all other BeanFactoryPostProcessors.</span></span><br><span class="line">List&lt;BeanFactoryPostProcessor&gt; nonOrderedPostProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;(nonOrderedPostProcessorNames.size());</span><br><span class="line"><span class="keyword">for</span> (String postProcessorName : nonOrderedPostProcessorNames) &#123;</span><br><span class="line">   nonOrderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ç„¶åæˆ‘ä»¬ç›´æ¥çœ‹åˆ°å¤„ç†nonOrderedPostProcessorsè¿™ä¸ªé›†åˆçš„æ–¹æ³•,</span></span><br><span class="line"><span class="comment">//å› ä¸ºè¿™ä¸ªæ–¹æ³•ä¹Ÿä¼šèµ°åˆ°æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„ç±»ä¸­å»</span></span><br><span class="line"><span class="comment">//æ–¹æ³•é‡Œé¢å¯¹nonOrderedPostProcessorsè¿›è¡Œè¿­ä»£,ç„¶åä¸€æ¬¡è°ƒç”¨å…¶postProcessBeanFactoryæ–¹æ³•,åŒæ—¶ä¹Ÿä¼ å…¥äº†beanFactoryåˆ°é‡Œé¢å».</span></span><br><span class="line">invokeBeanFactoryPostProcessors(nonOrderedPostProcessors, beanFactory);</span><br></pre></td></tr></table></div></figure>


        <h4 id="BeanPostProcessor"   >
          <a href="#BeanPostProcessor" class="heading-link"><i class="fas fa-link"></i></a><a href="#BeanPostProcessor" class="headerlink" title="BeanPostProcessor"></a>BeanPostProcessor</h4>
      <p>æˆ‘ä»¬å…ˆå†™ä¸€ä¸ª Bean. ç„¶åå¯ä»¥é‡Œé¢å†™ä¸€ä¸ªå±æ€§,æ–¹ä¾¿æ ‡è¯†.</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">YangBeanOne</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ— å‚æ„é€ å‡½æ•°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">YangBeanOne</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;YangBeanOneæ— å‚æ•°æ„é€ å‡½æ•°&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>ç„¶åæˆ‘ä»¬è‡ªå®šä¹‰ä¸€ä¸ªBeanPostProcessor,å…¶å®ç°äº†BeanPostProcessoræ¥å£.</p>
<p>å¯ä»¥çœ‹åˆ°çš„æ˜¯,æˆ‘ä»¬åœ¨ifä¸­åšäº†beanNameçš„åˆ¤æ–­,å¦‚æœæ˜¯çš„è¯,é‚£ä¹ˆæˆ‘ä»¬å°±ä¼šå¼ºè½¬,ç„¶åç»™nameå­—æ®µèµ‹å€¼ä¸ŠGavinYangçš„å€¼.</p>
<p>æˆ‘ä»¬ç»™æ–­ç‚¹æ‰“åˆ° ifè¿™é‡Œï¼Œç„¶åçœ‹è¿›æ¥çš„å †æ ˆä¿¡æ¯,å‘ç°å…¶æ˜¯åœ¨åˆå§‹åŒ–beanä¸­,ç„¶åè°ƒç”¨beanPostProcessorçš„postProcessAfterInitializationçš„æ–¹æ³•æ‰ä¼šèµ°åˆ°è¿™é‡Œ,ä¹Ÿå°±æ˜¯åœ¨doCreateBeanè¿™ä¸ªæ–¹æ³•é‡Œé¢.</p>
<p>ç„¶åè¿™ä¸ª YangBeanPostProcessor æ˜¯ä»€ä¹ˆæ—¶å€™ç»™æ·»åŠ åˆ° beanFactoryä¸­å»çš„å‘¢ï¼Ÿ</p>
<p>org.springframework.context.support.PostProcessorRegistrationDelegate#registerBeanPostProcessors(org.springframework.beans.factory.config.ConfigurableListableBeanFactory, org.springframework.context.support.AbstractApplicationContext)åœ¨è¿™ä¸ªæ–¹æ³•æ‰“ä¸Šæ–­ç‚¹,ç„¶åä½ ä¼šå‘ç°å…¶getå‡ºæ¥çš„postProcessorNamesæ•°ç»„,å°±æœ‰æˆ‘ä»¬çš„è¿™ä¸ªYangBeanPostProcessorï¼Œç„¶åèµ°registerBeanPostProcessorsæ–¹æ³•çš„æ—¶å€™,å°±ä¼šç»™æ·»åŠ åˆ°beanFactoryä¸­å».</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">YangBeanPostProcessor</span> <span class="keyword">implements</span> <span class="title">BeanPostProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&quot;yangBeanOne&quot;</span>.equalsIgnoreCase(beanName))&#123;</span><br><span class="line">            ((YangBeanOne) bean).setName(<span class="string">&quot;GavinYang&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>å¯åŠ¨ç±» :</p>
<p>è¿™å°±æ‰“å°å‡ºæ¥çš„ç»“æœå°±å¯ä»¥çœ‹åˆ°çš„æ˜¯GavinYang,ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬åˆå§‹åŒ–è¿™ä¸ªbeanä¹‹å,ç„¶åç»™å…¶nameå±æ€§èµ‹å€¼ä¸Šäº†GavinYangè¿™ä¸ªå€¼.</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringStartMain</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AnnotationConfigApplicationContext context = <span class="keyword">new</span> AnnotationConfigApplicationContext(<span class="string">&quot;com.iyang.spring&quot;</span>);</span><br><span class="line">        YangBeanOne yangBeanOne = context.getBean(YangBeanOne.class);</span><br><span class="line">        System.out.println(yangBeanOne.getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="Lifecycle-æ‰©å±•"   >
          <a href="#Lifecycle-æ‰©å±•" class="heading-link"><i class="fas fa-link"></i></a><a href="#Lifecycle-æ‰©å±•" class="headerlink" title="Lifecycle æ‰©å±•"></a>Lifecycle æ‰©å±•</h4>
      <p>Lifecycle æ‰©å±•è¦æ¯”èµ· BeanPostProcessorè¦å¥½ç†è§£å¾—å¤š,å› ä¸ºä½ åªç”¨å»å®ç°è¿™ä¸ªæ¥å£(SmartLifecycle),ç„¶ååœ¨org.springframework.context.support.AbstractApplicationContext#finishRefreshåˆ°è¿™ä¸ªæ–¹æ³•çš„æ—¶å€™,å°±ä¼šå»è°ƒç”¨å®ç°è¿™ä¸ªæ¥å£çš„å¯¹ç”¨çš„æ–¹æ³•.</p>
<p>è¿™é‡Œæˆ‘ä»¬è‡ªå·±å†™ä¸€ä¸ªç±»,ç„¶åå®ç° SmartLifecycle æ¥å£å³å¯ã€‚</p>
<p>å¯ä»¥çœ‹åˆ°ä¸‹é¢çš„æ‰“å°å‚æ•°.è¿˜æ˜¯å¾ˆæ¸…æ¥šçš„æ˜ç™½.</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GavinYangLifeImpl</span> <span class="keyword">implements</span> <span class="title">SmartLifecycle</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPhase</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Integer.MAX_VALUE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;è°ƒç”¨åˆ°äº†GavinYangLifeImpl.start()æ–¹æ³•&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isRunning</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//YangBeanOneæ— å‚æ•°æ„é€ å‡½æ•°</span></span><br><span class="line"><span class="comment">//è°ƒç”¨åˆ°äº†GavinYangLifeImpl.start()æ–¹æ³•</span></span><br><span class="line"><span class="comment">//GavinYang</span></span><br></pre></td></tr></table></div></figure>

<p>ç„¶åæˆ‘ä»¬å†çœ‹ä¸‹æºç ,ä¸ºä»€ä¹ˆè¦å®ç° SmartLifecycle è¿™ä¸ªæ¥å£å‘¢ï¼Ÿ</p>
<p>org.springframework.context.support.DefaultLifecycleProcessor</p>
<p>è¿™é‡Œæˆ‘ä»¬å…ˆçœ‹åˆ° phases ,ä¹Ÿå°±æ˜¯æœ€åº•ä¸‹çš„ä»£ç , è¿™ä¸ªé›†åˆæ˜¯æœ‰å€¼çš„æƒ…å†µä¸‹å…ˆæ’åº,ç„¶åå†è¿­ä»£,ç„¶åè°ƒç”¨åˆ° start()æ–¹æ³•, è¿™ä¸ªstartæ–¹æ³•æ˜¯ä¸æ˜¯åœ¨æˆ‘ä»¬çš„å®ç°ç±»ä¸­å¯ä»¥çœ‹åˆ°,æ˜¯ä¸æ˜¯éå¸¸çš„ç†Ÿæ‚‰æ„Ÿè§‰.</p>
<p>ç„¶åæˆ‘ä»¬åœ¨çœ‹ä¸‹,æ€ä¹ˆæ ·è®©è¿™ä¸ªé›†åˆèƒ½æœ‰å€¼å‘¢ï¼Ÿ</p>
<p>phases.put(phase, group); å¯ä»¥çœ‹åˆ° putæ–¹æ³•è¿™é‡Œ, autoStartupOnly æ˜¯false æˆ–è€…beanæ˜¯SmartLifecycleçš„å­ç±»,å¹¶ä¸”å…¶isAutoStartupæ–¹æ³•çš„æ˜¯true. ç‚¹åˆ°SmartLifecycleæºç ä¸­å»çœ‹,å¯ä»¥å‘ç°è¿™ä¸ªæ–¹æ³•é»˜è®¤æ˜¯è¿”å›çš„true.</p>
<p>æ¥ç€åœ¨è°ƒç”¨getPhaseæ–¹æ³•, è¯¥æ–¹æ³•ä¹Ÿå°±æ˜¯åˆ¤æ–­.æœ€æœ€å…³é”®çš„phasesé›†åˆæ¥äº†,å…ˆä»é‡Œé¢getå‡ºæ•°æ®,ç„¶ååˆ¤æ–­æ•°æ®æ˜¯ä¸æ˜¯null,å¦‚æœæ˜¯nullçš„è¯,å°±å…ˆnewä¸€ä¸ªGroupå‡ºæ¥,ç„¶åè°ƒç”¨phasesçš„putæ–¹æ³•,ä¹Ÿå°±æ˜¯æ”¾å…¥åˆ°è¿™ä¸ªé›†åˆä¸­å»äº†</p>
<p>æ‰€ä»¥è¿™é‡Œå°±æ˜¯æˆ‘ä»¬ä¸ºä»€ä¹ˆè¦å®ç° SmartLifecycle è¿™ä¸ªæ¥å£,å°±ä¼šæœ‰å¯åŠ¨çš„æ•ˆæœäº†çš„åŸå› .</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Internal helpers</span></span><br><span class="line"><span class="comment">// ä¼ å…¥è¿›æ¥çš„  autoStartupOnly å‚æ•°æ˜¯true.</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startBeans</span><span class="params">(<span class="keyword">boolean</span> autoStartupOnly)</span> </span>&#123;</span><br><span class="line">   Map&lt;String, Lifecycle&gt; lifecycleBeans = getLifecycleBeans();</span><br><span class="line">   Map&lt;Integer, LifecycleGroup&gt; phases = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">   lifecycleBeans.forEach((beanName, bean) -&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (!autoStartupOnly || (bean <span class="keyword">instanceof</span> SmartLifecycle &amp;&amp; ((SmartLifecycle) bean).isAutoStartup())) &#123;</span><br><span class="line">         <span class="keyword">int</span> phase = getPhase(bean);</span><br><span class="line">         LifecycleGroup group = phases.get(phase);</span><br><span class="line">         <span class="keyword">if</span> (group == <span class="keyword">null</span>) &#123;</span><br><span class="line">            group = <span class="keyword">new</span> LifecycleGroup(phase, <span class="keyword">this</span>.timeoutPerShutdownPhase, lifecycleBeans, autoStartupOnly);</span><br><span class="line">            phases.put(phase, group);</span><br><span class="line">         &#125;</span><br><span class="line">         group.add(beanName, bean);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;);</span><br><span class="line">   <span class="keyword">if</span> (!phases.isEmpty()) &#123;</span><br><span class="line">      List&lt;Integer&gt; keys = <span class="keyword">new</span> ArrayList&lt;&gt;(phases.keySet());</span><br><span class="line">      Collections.sort(keys);</span><br><span class="line">      <span class="keyword">for</span> (Integer key : keys) &#123;</span><br><span class="line">         phases.get(key).start();</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="æ€»ç»“"   >
          <a href="#æ€»ç»“" class="heading-link"><i class="fas fa-link"></i></a><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4>
      <p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬åŸºäºæ¥å£æ‰©å±•çš„,è¿˜æ˜¯å¾ˆå¥½ç†è§£çš„ã€‚ è·Ÿç€æºç ä¸­çš„åˆå§‹åŒ–ä¸€äº›ç±»,çœ‹å“ªä¸ªç±»æ˜¯æ€ä¹ˆå†™çš„ï¼Œç„¶åæˆ‘ä»¬è·Ÿç€å†™ä¸€ä¸ªã€‚ å‰ææ˜¯,ä½ è¦å¼„å¾—æ˜ç™½ Spring è¿™ä¸ªæ‰§è¡Œè¿‡ç¨‹çš„. ä¸ç„¶ä½ è·Ÿç€å†™,ä¸æ˜¯å¾ˆæ˜ç™½çš„è¯,å°±å¯èƒ½ä¸æ˜¯å¾ˆå®¹æ˜“çœ‹æ˜ç™½æˆ–è€…çœ‹æ‡‚ä½ è¿™ä¸ªæ•ˆæœçš„.</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/11/04/spring/spring%E5%88%9D%E5%A7%8B%E5%8C%96-%E4%BA%8C/">springåˆå§‹åŒ–(äºŒ)</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">å‘è¡¨äº</span><span class="post-meta-item__value">2021-11-04</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">æ›´æ–°äº</span><span class="post-meta-item__value">2021-11-04</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">å­—æ•°ç»Ÿè®¡</span><span class="post-meta-item__value">5.2k</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="far fa-clock"></i></span><span class="post-meta-item__info">é˜…è¯»æ—¶é•¿</span><span class="post-meta-item__value">42åˆ†</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h4 id="é¢˜è®°"   >
          <a href="#é¢˜è®°" class="heading-link"><i class="fas fa-link"></i></a><a href="#é¢˜è®°" class="headerlink" title="é¢˜è®°"></a>é¢˜è®°</h4>
      <p> æ˜¨å¤©è®°å½•äº†this()å’Œ register() è¿™äºŒä¸ªæ–¹æ³•, è¿™äºŒä¸ªæ–¹æ³•éƒ½æ˜¯ä¸ºåé¢çš„åšé“ºå«,ä¹Ÿå°±æ˜¯æå‰åˆå§‹åŒ–äº†ä¸€äº›ç¯å¢ƒå’Œè¯»å–classæ–‡ä»¶. refresh() è¿™ä¸ªæ–¹æ³•æ‰æ˜¯æœ€é‡è¦çš„,å…¶ä¸­åŒ…å«çš„å†…å®¹æ˜¯éå¸¸å¤šçš„. æ‰€ä»¥è¿™é‡Œæ…¢æ…¢è¿›è¡Œæ›´æ–°å…¶æ–¹æ³•çš„å†…å®¹.</p>

        <h4 id="refresh-æ–¹æ³•"   >
          <a href="#refresh-æ–¹æ³•" class="heading-link"><i class="fas fa-link"></i></a><a href="#refresh-æ–¹æ³•" class="headerlink" title="refresh æ–¹æ³•"></a>refresh æ–¹æ³•</h4>
      <p>è¿™é‡Œå¯ä»¥çœ‹åˆ°çš„æ˜¯, refresh()è¯¥æ–¹æ³•é‡Œé¢,åŸºæœ¬éƒ½æ˜¯èµ°äº†å¾ˆå¤šæ–¹æ³•çš„. æ‰€ä»¥æŒ¨ä¸ªçœ‹æ–¹æ³•,æœ‰äº›æ–¹æ³•æ˜¯ç•™ç»™å­ç±»çš„,ä¹Ÿå°±æ˜¯è¿›è¡Œæ‰©å±•çš„. ä»synchronizedè¿™ä¸ªå…³é”®å­—æ¥çœ‹,è¿™é‡Œåªå®¹è®¸ä¸€æ¬¡åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ¥æ‰§è¡Œè¿™ä¸ªæ–¹æ³•.</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException </span>&#123;</span><br><span class="line">   <span class="keyword">synchronized</span> (<span class="keyword">this</span>.startupShutdownMonitor) &#123;</span><br><span class="line">      <span class="comment">// Prepare this context for refreshing.</span></span><br><span class="line">      prepareRefresh();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Tell the subclass to refresh the internal bean factory.</span></span><br><span class="line"></span><br><span class="line">      ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Prepare the bean factory for use in this context.</span></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * org.springframework.beans.factory.support.DefaultListableBeanFactory</span></span><br><span class="line"><span class="comment">       *</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      prepareBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="comment">// Allows post-processing of the bean factory in context subclasses.</span></span><br><span class="line">         postProcessBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Invoke factory processors registered as beans in the context.</span></span><br><span class="line">         invokeBeanFactoryPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Register bean processors that intercept bean creation.</span></span><br><span class="line">         registerBeanPostProcessors(beanFactory);</span><br><span class="line">         <span class="comment">// Initialize message source for this context.</span></span><br><span class="line">         initMessageSource();</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Initialize event multicaster for this context.</span></span><br><span class="line">         initApplicationEventMulticaster();</span><br><span class="line">         <span class="comment">// Initialize other special beans in specific context subclasses.</span></span><br><span class="line">         onRefresh();</span><br><span class="line">         <span class="comment">// Check for listener beans and register them.</span></span><br><span class="line">         registerListeners();</span><br><span class="line">         <span class="comment">// Instantiate all remaining (non-lazy-init) singletons.</span></span><br><span class="line">         <span class="comment">/**</span></span><br><span class="line"><span class="comment">          */</span></span><br><span class="line">         finishBeanFactoryInitialization(beanFactory);</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Last step: publish corresponding event.</span></span><br><span class="line">         finishRefresh();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">         <span class="keyword">if</span> (logger.isWarnEnabled()) &#123;</span><br><span class="line">            logger.warn(<span class="string">&quot;Exception encountered during context initialization - &quot;</span> +</span><br><span class="line">                  <span class="string">&quot;cancelling refresh attempt: &quot;</span> + ex);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="comment">// Destroy already created singletons to avoid dangling resources.</span></span><br><span class="line">         destroyBeans();</span><br><span class="line">         <span class="comment">// Reset &#x27;active&#x27; flag.</span></span><br><span class="line">         cancelRefresh(ex);</span><br><span class="line">         <span class="comment">// Propagate exception to caller.</span></span><br><span class="line">         <span class="keyword">throw</span> ex;</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">         <span class="comment">// Reset common introspection caches in Spring&#x27;s core, since we</span></span><br><span class="line">         <span class="comment">// might not ever need metadata for singleton beans anymore...</span></span><br><span class="line">         resetCommonCaches();</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="refresh-prepareRefresh-æ–¹æ³•"   >
          <a href="#refresh-prepareRefresh-æ–¹æ³•" class="heading-link"><i class="fas fa-link"></i></a><a href="#refresh-prepareRefresh-æ–¹æ³•" class="headerlink" title="refresh.prepareRefresh() æ–¹æ³•"></a>refresh.prepareRefresh() æ–¹æ³•</h4>
      <p>prepareRefresh() æ–¹æ³•: å¯ä»¥çœ‹åˆ°è¯¥æ–¹æ³•å…ˆæ˜¯å¯¹closed/activeå‚æ•°è¿›è¡Œè®¾ç½®,ç„¶åå¯¹Enviornmentè¿›è¡Œè°ƒç”¨æ£€éªŒæ–¹æ³•,æ¥ç€åˆ¤æ–­this.earlyApplicationListenersæ˜¯å¦æœ‰å€¼æ¥æ“ä½œthis.applicationListeners. æœ€ååˆå§‹åŒ–earlyApplicationEventsè¿™ä¸ªé›†åˆ. è¿™é‡Œå¤§æ¦‚è¿˜æ˜¯è¿›è¡Œä¸€äº›åˆå§‹åŒ–æ“ä½œ.</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Prepare this context for refreshing, setting its startup date and</span></span><br><span class="line"><span class="comment"> * active flag as well as performing any initialization of property sources.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">prepareRefresh</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="comment">// Switch to active.</span></span><br><span class="line">   <span class="keyword">this</span>.startupDate = System.currentTimeMillis();</span><br><span class="line">  <span class="comment">// closedè®¾ç½®ä¸ºfalse,activeè®¾ç½®ä¸ºtrue.  </span></span><br><span class="line">   <span class="keyword">this</span>.closed.set(<span class="keyword">false</span>);</span><br><span class="line">   <span class="keyword">this</span>.active.set(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// æ ¹æ®logçº§åˆ«æ¥è¿›è¡Œè¾“å‡º </span></span><br><span class="line">   <span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class="line">      logger.info(<span class="string">&quot;Refreshing &quot;</span> + <span class="keyword">this</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Initialize any placeholder property sources in the context environment.</span></span><br><span class="line">   <span class="comment">// ç›®å‰è¯¥æ–¹æ³•æ²¡æœ‰è°ƒç”¨;ç›®å‰æ²¡æœ‰åšä»»ä½•äº‹æƒ…. ç›®æµ‹æ˜¯åº”è¯¥ç•™ç»™å­ç±»ä¹‹ç±»çš„è¿›è¡Œæ‰©å±•çš„.</span></span><br><span class="line">   initPropertySources();</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Validate that all properties marked as required are resolvable:</span></span><br><span class="line">   <span class="comment">// see ConfigurablePropertyResolver#setRequiredProperties</span></span><br><span class="line"><span class="comment">//å…ˆè°ƒç”¨getEnvironment()è·å–this()æ–¹æ³•ä¸­åˆ›å»ºå‡ºæ¥çš„Environmentæ¥,ç„¶åèµ°validateRequiredPropertiesæ–¹æ³•æ¥è¿›è¡Œä¸€äº›æ£€éªŒ,</span></span><br><span class="line"><span class="comment">//org.springframework.core.env.AbstractPropertyResolver#validateRequiredProperties</span></span><br><span class="line"><span class="comment">//æœ€åæ˜¯èµ°åˆ°äº†è¿™ä¸ªæ–¹æ³•,å¦‚æœthis.requiredPropertiesä¸­æ˜¯æœ‰å€¼çš„è¯,é‚£ä¹ˆè¿™é‡Œå°±ä¼šæŠ›å‡ºä¸€ä¸ªå¼‚å¸¸æ¥    </span></span><br><span class="line">   getEnvironment().validateRequiredProperties();</span><br><span class="line">    </span><br><span class="line">   <span class="comment">// Store pre-refresh ApplicationListeners...</span></span><br><span class="line"><span class="comment">// è¿™é‡Œæ˜¯å¯¹ earlyApplicationListeners è¿›è¡Œåˆ¤æ–­,å¦‚æœæœ‰å€¼çš„è¯,å°±å…ˆä¼šclearæ‰,ç„¶åå†addAll</span></span><br><span class="line"><span class="comment">//å¦‚æœæ˜¯æ²¡æœ‰å€¼çš„è¯,å°±ä¼šnewä¸€ä¸ªé›†åˆ,ç„¶åèµ‹å€¼ç»™this.earlyApplicationListenerså‚æ•°   </span></span><br><span class="line">   <span class="keyword">if</span> (<span class="keyword">this</span>.earlyApplicationListeners == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.earlyApplicationListeners = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(<span class="keyword">this</span>.applicationListeners);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// Reset local application listeners to pre-refresh state.</span></span><br><span class="line">      <span class="keyword">this</span>.applicationListeners.clear();</span><br><span class="line">      <span class="keyword">this</span>.applicationListeners.addAll(<span class="keyword">this</span>.earlyApplicationListeners);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Allow for the collection of early ApplicationEvents,</span></span><br><span class="line">   <span class="comment">// to be published once the multicaster is available...</span></span><br><span class="line"><span class="comment">// æœ€ååˆå§‹åŒ–ä¸€ä¸‹ this.earlyApplicationEvents è¿™ä¸ªå‚æ•°</span></span><br><span class="line">   <span class="keyword">this</span>.earlyApplicationEvents = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="refresh-obtainFreshBeanFactory-æ–¹æ³•"   >
          <a href="#refresh-obtainFreshBeanFactory-æ–¹æ³•" class="heading-link"><i class="fas fa-link"></i></a><a href="#refresh-obtainFreshBeanFactory-æ–¹æ³•" class="headerlink" title="refresh.obtainFreshBeanFactory()æ–¹æ³•"></a>refresh.obtainFreshBeanFactory()æ–¹æ³•</h4>
      <p>è¿™ä¸ªæ–¹æ³•æ˜¯æœ‰æ–¹æ³•ä¸€ä¸ªBeanFactoryå›å»çš„.</p>
<p>è¯¥æ–¹æ³•å¯¹beanFactoryè¿›è¡ŒSerializationId,ç„¶åè·å–BeanFactory,æœ€åè¿”å›è¿™ä¸ªBeanFactory.</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Tell the subclass to refresh the internal bean factory.</span></span><br><span class="line"><span class="comment"> *  å‘Šè¯‰å­ç±»åˆ·æ–°å†…éƒ¨Beanå·¥å‚</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the fresh BeanFactory instance</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #refreshBeanFactory()</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #getBeanFactory()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> ConfigurableListableBeanFactory <span class="title">obtainFreshBeanFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">//this.refreshed.compareAndSet(false, true)è¯¥æ–¹æ³•å¦‚æœè¿”å›çš„æ˜¯falseçš„è¯,å°±ä¼šæœ‰å¼‚å¸¸ç»™æŠ›å‡ºæ¥</span></span><br><span class="line"><span class="comment">//ä¸æ˜¯falseçš„è¯,æ¥ç€å°±æ˜¯å¯¹beanFactoryè®¾ç½®SerializationId    </span></span><br><span class="line">   refreshBeanFactory();</span><br><span class="line"><span class="comment">// org.springframework.context.support.GenericApplicationContext#getBeanFactory</span></span><br><span class="line"><span class="comment">//è¯¥æ–¹æ³•ç›´æ¥è¿”å›DefaultListableBeanFactory    </span></span><br><span class="line">   ConfigurableListableBeanFactory beanFactory = getBeanFactory();</span><br><span class="line">   <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">      logger.debug(<span class="string">&quot;Bean factory for &quot;</span> + getDisplayName() + <span class="string">&quot;: &quot;</span> + beanFactory);</span><br><span class="line">   &#125;</span><br><span class="line"><span class="comment">//è¿”å›è·å–çš„beanFactory.    </span></span><br><span class="line">   <span class="keyword">return</span> beanFactory;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="refresh-prepareBeanFactory-æ–¹æ³•"   >
          <a href="#refresh-prepareBeanFactory-æ–¹æ³•" class="heading-link"><i class="fas fa-link"></i></a><a href="#refresh-prepareBeanFactory-æ–¹æ³•" class="headerlink" title="refresh.prepareBeanFactory() æ–¹æ³•"></a>refresh.prepareBeanFactory() æ–¹æ³•</h4>
      <p>ä»è¿™ä¸ªæ–¹æ³•æ¥çœ‹,æ˜¯å¯¹BeanFactoryçš„å‡†å¤‡.</p>
<p>è¯¥æ–¹æ³•å¯ä»¥å…ˆæ˜¯å¯¹classLoader,expressionResolver,propertyEditorRegistraræ·»åŠ åˆ°beanFactoryä¸­å». ç„¶åæ·»åŠ ApplicationContextAwareProcessor(BeanPostProcessor)åˆ°BeanFactory,ç„¶åå¿½ç•¥åˆ°ä¸€äº›æ¥å£çš„æ³¨å…¥åˆ°beanFactoryä¸­å».</p>
<p>è®¾ç½® BeanFactory , ResourceLoader , ApplicationEventPublisher, ApplicationContextç­‰beanåˆ°BeanFactoryä¸­å».</p>
<p>æœ€åå°±æ˜¯ä¸€äº›environment,systemProperties,systemEnvironmentç­‰æ³¨å…¥åˆ°BeanFactoryä¸­å».</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Configure the factory&#x27;s standard context characteristics,</span></span><br><span class="line"><span class="comment"> * such as the context&#x27;s ClassLoader and post-processors.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> beanFactory the BeanFactory to configure</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">prepareBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">   <span class="comment">// Tell the internal bean factory to use the context&#x27;s class loader etc.</span></span><br><span class="line"><span class="comment">//ç»™beanFactoryè®¾ç½®classLoader(åŠ è½½bean) </span></span><br><span class="line">   beanFactory.setBeanClassLoader(getClassLoader());</span><br><span class="line"><span class="comment">//è¿™é‡Œæ ¹æ®classLoaderæ¥è·å–è§£æå™¨,ç„¶åsetåˆ°BeanFactoryä¸­å».(è§£æbeanå®šä¹‰çš„è¡¨è¾¾å¼)</span></span><br><span class="line">   beanFactory.setBeanExpressionResolver(<span class="keyword">new</span> StandardBeanExpressionResolver(beanFactory.getBeanClassLoader()));</span><br><span class="line"><span class="comment">//å±æ€§ç¼–è¾‘æ³¨å†Œå™¨,setåˆ°BeanFactoryä¸­</span></span><br><span class="line">   beanFactory.addPropertyEditorRegistrar(<span class="keyword">new</span> ResourceEditorRegistrar(<span class="keyword">this</span>, getEnvironment()));</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Configure the bean factory with context callbacks.</span></span><br><span class="line"><span class="comment">//æ·»åŠ ApplicationContextAwareProcessoråˆ°BeanFactoryä¸­.è¯¥ç±»æ˜¯æœ‰å®ç°BeanPostProcessorçš„</span></span><br><span class="line"><span class="comment">//BeanPostProcessoræ˜¯åœ¨beanåˆå§‹åŒ–å®Œå,è°ƒç”¨BeanPostProcessorè¿›è¡Œæ‰©å±•.</span></span><br><span class="line">   beanFactory.addBeanPostProcessor(<span class="keyword">new</span> ApplicationContextAwareProcessor(<span class="keyword">this</span>));</span><br><span class="line"><span class="comment">//å¿½ç•¥æ‰EnvironmentAware/EmbeddedValueResolverAware....ApplicationContextAware</span></span><br><span class="line"><span class="comment">//è¿™å…­ä¸ªæ¥å£çš„æ³¨å…¥(ä¾èµ–). å› ä¸ºApplicationContextAwareProcessorä¸­æœ‰åšäº†è¿™äº›äº‹</span></span><br><span class="line">   beanFactory.ignoreDependencyInterface(EnvironmentAware.class);</span><br><span class="line">   beanFactory.ignoreDependencyInterface(EmbeddedValueResolverAware.class);</span><br><span class="line">   beanFactory.ignoreDependencyInterface(ResourceLoaderAware.class);</span><br><span class="line">   beanFactory.ignoreDependencyInterface(ApplicationEventPublisherAware.class);</span><br><span class="line">   beanFactory.ignoreDependencyInterface(MessageSourceAware.class);</span><br><span class="line">   beanFactory.ignoreDependencyInterface(ApplicationContextAware.class);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// BeanFactory interface not registered as resolvable type in a plain factory.</span></span><br><span class="line">   <span class="comment">// MessageSource registered (and found for autowiring) as a bean.</span></span><br><span class="line"><span class="comment">// BeanFactory,ResourceLoader,ApplicationEventPublisher,ApplicationContextè¿™å››ä¸ªæ¥å£</span></span><br><span class="line"><span class="comment">//å¯¹åº”çš„beanéƒ½setåˆ°beanFactoryä¸­å».    </span></span><br><span class="line">   beanFactory.registerResolvableDependency(BeanFactory.class, beanFactory);</span><br><span class="line">   beanFactory.registerResolvableDependency(ResourceLoader.class, <span class="keyword">this</span>);</span><br><span class="line">   beanFactory.registerResolvableDependency(ApplicationEventPublisher.class, <span class="keyword">this</span>);</span><br><span class="line">   beanFactory.registerResolvableDependency(ApplicationContext.class, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Register early post-processor for detecting inner beans as ApplicationListeners.</span></span><br><span class="line"><span class="comment">//æ·»åŠ ApplicationListenerDetector(BeanPostProcessor)åˆ°beanFactoryä¸­å».</span></span><br><span class="line">   beanFactory.addBeanPostProcessor(<span class="keyword">new</span> ApplicationListenerDetector(<span class="keyword">this</span>));</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Detect a LoadTimeWeaver and prepare for weaving, if found.</span></span><br><span class="line">   <span class="keyword">if</span> (beanFactory.containsBean(LOAD_TIME_WEAVER_BEAN_NAME)) &#123;</span><br><span class="line">      beanFactory.addBeanPostProcessor(<span class="keyword">new</span> LoadTimeWeaverAwareProcessor(beanFactory));</span><br><span class="line">      <span class="comment">// Set a temporary ClassLoader for type matching.</span></span><br><span class="line">      beanFactory.setTempClassLoader(<span class="keyword">new</span> ContextTypeMatchClassLoader(beanFactory.getBeanClassLoader()));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Register default environment beans.</span></span><br><span class="line"><span class="comment">//å¦‚æœbeanFactoryä¸­æ²¡æœ‰ENVIRONMENT_BEAN_NAMEè¿™ä¸ªbeançš„è¯,å°±æ³¨å…¥ä¸€ä¸ªè¿›å»</span></span><br><span class="line">   <span class="keyword">if</span> (!beanFactory.containsLocalBean(ENVIRONMENT_BEAN_NAME)) &#123;</span><br><span class="line">      beanFactory.registerSingleton(ENVIRONMENT_BEAN_NAME, getEnvironment());</span><br><span class="line">   &#125;</span><br><span class="line"><span class="comment">// SYSTEM_PROPERTIES_BEAN_NAMEä¹Ÿæ˜¯ä¸€æ ·,æ³¨å…¥åˆ°beanFactoryä¸­å»</span></span><br><span class="line">   <span class="keyword">if</span> (!beanFactory.containsLocalBean(SYSTEM_PROPERTIES_BEAN_NAME)) &#123;</span><br><span class="line">      beanFactory.registerSingleton(SYSTEM_PROPERTIES_BEAN_NAME, getEnvironment().getSystemProperties());</span><br><span class="line">   &#125;</span><br><span class="line"><span class="comment">//SYSTEM_ENVIRONMENT_BEAN_NAMEåŒä¸Š    </span></span><br><span class="line">   <span class="keyword">if</span> (!beanFactory.containsLocalBean(SYSTEM_ENVIRONMENT_BEAN_NAME)) &#123;</span><br><span class="line">      beanFactory.registerSingleton(SYSTEM_ENVIRONMENT_BEAN_NAME, getEnvironment().getSystemEnvironment());</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="refresh-postProcessBeanFactory-æ–¹æ³•"   >
          <a href="#refresh-postProcessBeanFactory-æ–¹æ³•" class="heading-link"><i class="fas fa-link"></i></a><a href="#refresh-postProcessBeanFactory-æ–¹æ³•" class="headerlink" title="refresh.postProcessBeanFactory() æ–¹æ³•"></a>refresh.postProcessBeanFactory() æ–¹æ³•</h4>
      <p>è¯¥æ–¹æ³•ç›®å‰åœ¨å•ä¸ª Springä¸­æ˜¯æ²¡æœ‰åšä»»ä½•äº‹æƒ…çš„ã€‚ ç­‰åˆ°çœ‹SpringBootæºç çš„æ—¶å€™,è¿™é‡Œå°±ä¼šæœ‰ä»£ç èµ°è¿›æ¥,æ˜¯è¿›è¡Œæ ¹æ®åŒ…æ¥æ‰«ææ¥è·å–classç­‰ä¿¡æ¯çš„. æ»¡è¶³æ¡ä»¶çš„class,å°±ä¼šå½“ä¸ºbdç»™æ³¨å†Œåˆ°beanFactoryä¸­å».</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Modify the application context&#x27;s internal bean factory after its standard</span></span><br><span class="line"><span class="comment"> * initialization. All bean definitions will have been loaded, but no beans</span></span><br><span class="line"><span class="comment"> * will have been instantiated yet. This allows for registering special</span></span><br><span class="line"><span class="comment"> * BeanPostProcessors etc in certain ApplicationContext implementations.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> beanFactory the bean factory used by the application context</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="refresh-invokeBeanFactoryPostProcessors-æ–¹æ³•"   >
          <a href="#refresh-invokeBeanFactoryPostProcessors-æ–¹æ³•" class="heading-link"><i class="fas fa-link"></i></a><a href="#refresh-invokeBeanFactoryPostProcessors-æ–¹æ³•" class="headerlink" title="refresh.invokeBeanFactoryPostProcessors() æ–¹æ³•"></a>refresh.invokeBeanFactoryPostProcessors() æ–¹æ³•</h4>
      <p>å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ–¹æ³•,å€ŸåŠ©PostProcessorRegistrationDelegateæ¥å¯¹PostProcessorè¿›è¡Œå¤„ç†ã€‚</p>
<p>å…ˆæ˜¯å¯¹BeanDefinitionRegistryPostProcessorè¿›è¡Œä»beanFactoryä¸­è·å–å‡ºç›¸åº”çš„åå­—æ•°ç»„,ç„¶åè¿­ä»£è¿™ä¸ªæ•°ç»„,ç„¶åå¤„ç†PriorityOrderedâ€”&gt;Orderedâ€”&gt; æ²¡æœ‰,è¿™ä¸ªé¡ºåº,æœ€åè¿˜æœ‰ä¸€ä¸ªwhileå¾ªç¯è¿­ä»£æ¥æ£€æŸ¥BeanDefinitionRegistryPostProcessoræ˜¯å¦éƒ½å¤„ç†å®Œäº†.</p>
<p>å†æ¥ç€å°±æ˜¯å¤„ç†BeanFactoryPostProcessor,å¤„ç†æ–¹å¼æ˜¯å’ŒBeanDefinitionRegistryPostProcessorä¸€æ ·çš„,é¡ºåºä¹Ÿæ˜¯ä¸€æ ·çš„.</p>
<p>æœ€åå°±æ˜¯è°ƒç”¨beanFactory.clearMetadataCache()æ¸…é™¤.</p>
<p>å½“ç„¶,è¿™ä¸ªé‡Œé¢æœ‰äº›ä¸Šé¢ PostProcessorç­‰å¾…é˜…è¯»SpringBootçš„æ—¶å€™ç»™è¡¥ä¸Šæ¥,å› ä¸ºåˆ°æ—¶å€™SpringBootè¿™é‡Œä¼šæœ‰å¾ˆå¤šPostProcessor,è¿™é‡Œç›®å‰æ˜¯æ²¡æœ‰çš„.</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Instantiate and invoke all registered BeanFactoryPostProcessor beans,</span></span><br><span class="line"><span class="comment"> * respecting explicit order if given.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;Must be called before singleton instantiation.</span></span><br><span class="line"><span class="comment">BeanFactoryPostProcessor: ç”¨æ¥ä¿®æ”¹Springå®¹å™¨ä¸­å·²ç»å­˜åœ¨çš„beanå®šä¹‰.</span></span><br><span class="line"><span class="comment">BeanDefinitionRegistryPostProcessor: æ˜¯BeanFactoryPostProcessorçš„å­ç±»,ä½œç”¨å’Œçˆ¶ç±»æ˜¯ä¸€æ ·çš„,ä¸åŒçš„æ˜¯,è¯¥ä½¿ç”¨çš„æ˜¯BeanDefinitionRegistryå¯¹beanè¿›è¡Œå¤„ç†</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">invokeBeanFactoryPostProcessors</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line"><span class="comment">//org.springframework.context.support.AbstractApplicationContext#getBeanFactoryPostProcessors,ç”±äºè¿™é‡Œåªæ˜¯å¯åŠ¨äº†å•ä¸ªSpring,è¿”å›çš„é›†åˆæ˜¯æ²¡æœ‰å€¼çš„.</span></span><br><span class="line">   List&lt;BeanFactoryPostProcessor&gt; postProcessorsList = getBeanFactoryPostProcessors();</span><br><span class="line">   <span class="comment">//System.out.println(&quot;postProcessorsList value ---&gt; &quot; + postProcessorsList);</span></span><br><span class="line">   <span class="comment">// System.out.println(&quot;beanFactory  value 111111 ---&gt; &quot; + beanFactory);</span></span><br><span class="line"><span class="comment">//å€ŸåŠ©PostProcessorRegistrationDelegateæ¥å¤„ç†PostProcessors.</span></span><br><span class="line"><span class="comment">//å¯¹ä¼ å…¥postProcessorsListè¿›è¡Œè¿­ä»£,å¦‚æœPostProcessoræ˜¯BeanDefinitionRegistryPostProcessorçš„è¯,å°±ä¼šå¼ºè½¬ç„¶åè°ƒç”¨postProcessBeanDefinitionRegistryæ–¹æ³•(ä¼ å…¥å‚æ•°æ˜¯beanFacotry),æ·»åŠ åˆ°registryProcessorsé›†åˆä¸­.å¦‚æœä¸æ˜¯çš„è¯,å°±ä¼šæ·»åŠ åˆ°regularPostProcessorsé›†åˆä¸­.</span></span><br><span class="line"><span class="comment">//æ ¹æ®BeanDefinitionRegistryPostProcessor,ä»beanFactoryä¸­è·å–postProcessorNames,</span></span><br><span class="line"><span class="comment">//è¿›è¡Œè¿­ä»£,å¦‚æœæ˜¯æœ‰PriorityOrderedæ¥å£çš„å­ç±»çš„è¯,å°±ä¼šä»beanFactoryä¸­æ ¹æ®beanåå­—,ç±».classæ¥è·å–BeanDefinitionRegistryPostProcessor,å¹¶ä¸”æ·»åŠ åˆ°currentRegistryProcessorsé›†åˆä¸­,ppName(åå­—çš„å€¼)ä¹Ÿä¼šæ·»åŠ åˆ°processedBeansè¯¥é›†åˆä¸­</span></span><br><span class="line"><span class="comment">//å¯¹currentRegistryProcessorsè¿›è¡Œæ’åº,å…¨éƒ¨æ·»åŠ åˆ°registryProcessorsé›†åˆä¸­,invokeBeanDefinitionRegistryPostProcessors()è¯¥æ–¹æ³•æ˜¯è°ƒç”¨BeanDefinitionRegistryPostProcessorsçš„,è°ƒç”¨å®Œäº†ç„¶åæ¸…ç©ºcurrentRegistryProcessorsè¿™ä¸ªé›†åˆ.</span></span><br><span class="line"><span class="comment">//åŒæ ·æ–¹æ³•è·å–postProcessorNames,processedBeansé›†åˆä¸­ä¸åŒ…å«å¹¶ä¸”æ˜¯Orderedçš„å­ç±»,ç„¶åæ·»åŠ åˆ°currentRegistryProcessorsé›†åˆä¸­,ppNameä¹Ÿä¼šæ·»åŠ åˆ°processedBeansé›†åˆä¸­,åŒæ ·çš„æ’åºæ–¹å¼,æ·»åŠ åˆ°registryProcessorsä¸­,å†è°ƒç”¨invokeBeanDefinitionRegistryPostProcessors()æ–¹æ³•,currentRegistryProcessorsæ¸…ç©ºè¯¥é›†åˆ.</span></span><br><span class="line"><span class="comment">// ä¹Ÿå°±æ˜¯åˆ°è¿™é‡Œ,å¯ä»¥çœ‹å‡ºæ¥,å¤„ç†çš„é¡ºåº,å…ˆæ˜¯å¤„ç†PriorityOrdered,å†å¤„ç†Ordered.</span></span><br><span class="line"><span class="comment">// ç„¶åä½¿ç”¨ä¸€ä¸ªwhileå¾ªç¯,ç»§ç»­è·å–BeanDefinitionRegistryPostProcessorå¯¹åº”çš„postProcessorNames,è¿™ä¸ªåœ°æ–¹æ˜¯ä¸ºäº†é˜²æ­¢æœ‰äº›æ²¡æœ‰è°ƒç”¨åˆ°çš„,å¹¶ä¸”æ˜¯processedBeansé›†åˆä¸­ä¸åŒ…å«çš„,ç„¶åå°±ä¼šæ”¾å…¥åˆ°currentRegistryProcessorsè¿™ä¸ªé›†åˆä¸­,æ’åºcurrentRegistryProcessorsé›†åˆ,å…¨éƒ¨æ·»åŠ åˆ°registryProcessorsä¸­,è°ƒç”¨invokeBeanDefinitionRegistryPostProcessors,ä¹Ÿå°±æ˜¯è°ƒç”¨å…·ä½“çš„PostProcessors.</span></span><br><span class="line"><span class="comment">//invokeBeanFactoryPostProcessors(registryProcessors, beanFactory);</span></span><br><span class="line"><span class="comment">//invokeBeanFactoryPostProcessors(regularPostProcessors, beanFactory);</span></span><br><span class="line"><span class="comment">// ä¹‹å‰çš„äºŒä¸ªé›†åˆ,registryProcessorså’ŒregularPostProcessors,åœ¨è¿™é‡Œè¿˜æ˜¯ä¼šç»§ç»­è°ƒç”¨.</span></span><br><span class="line"><span class="comment">//ç„¶åæ ¹æ®BeanFactoryPostProcessor.classè·å–postProcessorNamesæ•°ç»„,ä¸ä¸Šé¢çš„ä¹Ÿæ˜¯åŒæ ·çš„æ–¹æ³•,</span></span><br><span class="line"><span class="comment">//å¯¹postProcessorNamesè¿›è¡Œè¿­ä»£,å¦‚æœæ˜¯processedBeans(ä¸Šé¢è£…çš„åå­—)å¦‚æœåŒ…å«äº†,å°±ä¼šè·³è¿‡.</span></span><br><span class="line"><span class="comment">/** å¦‚æœppName,ä¹Ÿå°±æ˜¯è¿­ä»£çš„å€¼,æ˜¯æœ‰PriorityOrderedçš„å­ç±»çš„è¯,å°±ä¼šä»èµ°beanFactory.getBean(ppName, BeanFactoryPostProcessor.class)è·å–å‡ºBeanFactoryPostProcessoræ”¾å…¥åˆ°priorityOrderedPostProcessorsé›†åˆä¸­.  å¦‚æœæ˜¯Orderedçš„å­ç±»,å°±å°†åå­—æ”¾å…¥åˆ°orderedPostProcessorNamesé›†åˆä¸­,å¦‚æœä¸Šé¢ä¸‰ç§éƒ½ä¸æ»¡è¶³çš„è¯,å°±ä¼šæ”¾å…¥åˆ°nonOrderedPostProcessorNamesé›†åˆä¸­.</span></span><br><span class="line"><span class="comment">ç„¶åå…ˆæ’åºpriorityOrderedPostProcessors,å†èµ°invokeBeanFactoryPostProcessors(priorityOrderedPostProcessors, beanFactory);</span></span><br><span class="line"><span class="comment">æ¥ç€è¿­ä»£orderedPostProcessorNamesé›†åˆ,ç„¶åä»beanFactoryä¸­è·å–BeanFactoryPostProcessor,å†å°±åšä¸priorityOrderedPostProcessorsä¸€æ ·çš„æ“ä½œ.</span></span><br><span class="line"><span class="comment">æœ€ååœ¨åšnonOrderedPostProcessorsè¿™ä¸ªé›†åˆçš„,æ“ä½œæ˜¯ä¸orderedPostProcessorNamesä¸€æ‘¸ä¸€æ ·çš„.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">æœ€ååœ¨è°ƒç”¨ä¸€ä¸ªbeanFactoryçš„clearMetadataCacheæ–¹æ³•.</span></span><br><span class="line"><span class="comment">å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ–¹æ³•æ˜¯å…ˆå¯¹BeanDefinitionRegistryPostProcessor.classè¿›è¡Œå¤„ç†,ç„¶åæ ¹æ®é¡ºåºPriorityOrdered--&gt;Ordered---&gt;æ²¡æœ‰, è¿™æ ·çš„é¡ºåºæ‰§è¡Œçš„.</span></span><br><span class="line"><span class="comment">ç„¶åå†å¤„ç†BeanFactoryPostProcessor.class,å¤„ç†æ–¹å¼æ˜¯å’ŒBeanDefinitionRegistryPostProcessor.classä¹Ÿæ˜¯ä¸€æ ·çš„,æ ¹æ®é¡ºåºæ¥è¿›è¡Œå¤„ç†.</span></span><br><span class="line"><span class="comment">*/</span>    </span><br><span class="line">   PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors(beanFactory, postProcessorsList);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Detect a LoadTimeWeaver and prepare for weaving, if found in the meantime</span></span><br><span class="line">   <span class="comment">// (e.g. through an @Bean method registered by ConfigurationClassPostProcessor)</span></span><br><span class="line"><span class="comment">// è·å–beanFactoryçš„tempClassLoaderåŠ è½½,å¹¶ä¸”beanFactoryæ˜¯åŒ…å«äº†loadTimeWeaverè¿™ä¸ªbeançš„,</span></span><br><span class="line"><span class="comment">//å°±ä¼šèµ°ifæ–¹æ³•,å¯ä»¥çœ‹åˆ°æ˜¯æ·»åŠ LoadTimeWeaverAwareProcessoråˆ°beanFactoryçš„postProcessorä¸­,</span></span><br><span class="line"><span class="comment">//ç„¶åæ·»åŠ ä¸€ä¸ªClassLoaderåˆ°beanFactoryä¸­   </span></span><br><span class="line">   <span class="keyword">if</span> (beanFactory.getTempClassLoader() == <span class="keyword">null</span> &amp;&amp; beanFactory.containsBean(LOAD_TIME_WEAVER_BEAN_NAME)) &#123;</span><br><span class="line">      beanFactory.addBeanPostProcessor(<span class="keyword">new</span> LoadTimeWeaverAwareProcessor(beanFactory));</span><br><span class="line">      beanFactory.setTempClassLoader(<span class="keyword">new</span> ContextTypeMatchClassLoader(beanFactory.getBeanClassLoader()));</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="refresh-registerBeanPostProcessors-æ–¹æ³•"   >
          <a href="#refresh-registerBeanPostProcessors-æ–¹æ³•" class="heading-link"><i class="fas fa-link"></i></a><a href="#refresh-registerBeanPostProcessors-æ–¹æ³•" class="headerlink" title="refresh.registerBeanPostProcessors() æ–¹æ³•"></a>refresh.registerBeanPostProcessors() æ–¹æ³•</h4>
      <p>ä»”ç»†çœ‹ä¸­è¿™ä¸ªæ–¹æ³•,å…¶å®å’Œä¸Šä¸€ä¸ªæ–¹æ³•èµ°çš„é€»è¾‘å¥½åƒæ˜¯æœ‰ç‚¹ç±»ä¼¼çš„. ä¹Ÿæ˜¯å€ŸåŠ©PostProcessorRegistrationDelegateæ¥å®Œæˆå…¶é€»è¾‘çš„.</p>
<p>å…ˆæ˜¯ä»BeanFactoryä¸­è·å–BeanPostProcessorå¯¹ç”¨çš„postProcessorNamesæ•°ç»„ã€‚</p>
<p>ç„¶ååˆ†ä¸º PriorityOrdered â€“&gt; Ordered â€“&gt; æ—¢ä¸æ˜¯PriorityOrdered ,ä¹Ÿä¸æ˜¯Ordered â€“&gt; MergedBeanDefinitionPostProcessorå­ç±», è¿™æ ·çš„å…ˆåé¡ºåº,èµ°registerBeanPostProcessors,è¿™ä¸ªæ˜¯å°†PostProcessrosæ³¨å†Œåˆ°Springçš„beanFactoryä¸­(Springå®¹å™¨).</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Instantiate and register all BeanPostProcessor beans,</span></span><br><span class="line"><span class="comment"> * respecting explicit order if given.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;Must be called before any instantiation of application beans.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">registerBeanPostProcessors</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">   PostProcessorRegistrationDelegate.registerBeanPostProcessors(beanFactory, <span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-------------------</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">registerBeanPostProcessors</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">			ConfigurableListableBeanFactory beanFactory, AbstractApplicationContext applicationContext)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å…ˆæ˜¯æ ¹æ®BeanPostProcessorè·å–å‡ºpostProcessorNamesæ•°ç»„,è¿™ä¸ªæ ¹æ®å’Œä¸Šé¢çš„æ–¹æ³•å¾ˆç›¸ä¼¼.    </span></span><br><span class="line">		String[] postProcessorNames = beanFactory.getBeanNamesForType(BeanPostProcessor.class,</span><br><span class="line">				<span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Register BeanPostProcessorChecker that logs an info message when</span></span><br><span class="line">		<span class="comment">// a bean is created during BeanPostProcessor instantiation, i.e. when</span></span><br><span class="line">		<span class="comment">// a bean is not eligible for getting processed by all BeanPostProcessors.</span></span><br><span class="line"><span class="comment">//ç„¶åä»beanFactoryä¸­è·å–å‡ºä¸ªæ•° + postProcessorNamesæ•°ç»„é•¿åº¦å†åŠ ä¸Šä¸€ä¸ª1.     </span></span><br><span class="line">		<span class="keyword">int</span> beanProcessorTargetCount = beanFactory.getBeanPostProcessorCount() + <span class="number">1</span> + postProcessorNames.length;</span><br><span class="line"><span class="comment">//æ·»åŠ ä¸€ä¸ªBeanPostProcessorCheckeråˆ°beanFactoryä¸­.ä»åå­—ä¸Šæ¥,è¿™ä¸ªPostProcessoråº”è¯¥æ˜¯è¿›è¡Œæ£€æŸ¥çš„æ“ä½œ.</span></span><br><span class="line">		beanFactory.addBeanPostProcessor(<span class="keyword">new</span> BeanPostProcessorChecker(beanFactory, beanProcessorTargetCount));</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Separate between BeanPostProcessors that implement PriorityOrdered,</span></span><br><span class="line">		<span class="comment">// Ordered, and the rest.</span></span><br><span class="line">		List&lt;BeanPostProcessor&gt; priorityOrderedPostProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		List&lt;BeanPostProcessor&gt; internalPostProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		List&lt;String&gt; orderedPostProcessorNames = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		List&lt;String&gt; nonOrderedPostProcessorNames = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">		<span class="comment">// å¯¹ postProcessorNames è¿›è¡Œéå†;åŒæ—¶ä½¿ç”¨ä¸åŒç±»å‹çš„é›†åˆæ¥å­˜å‚¨æ•°æ®</span></span><br><span class="line"><span class="comment">//ä¸»è¦æ˜¯æ ¹æ®æ˜¯å¦æ˜¯PriorityOrderedçš„å­ç±»,æ˜¯çš„è¯å°±ä¼šæ”¾å…¥åˆ°priorityOrderedPostProcessorsé›†åˆä¸­,æ¥ç€åœ¨åˆ¤æ–­æ˜¯å¦æ˜¯MergedBeanDefinitionPostProcessor,å¦‚æœæ˜¯çš„è¯,å°±ä¼šæ”¾å…¥åˆ°internalPostProcessorsé›†åˆä¸­</span></span><br><span class="line"><span class="comment">//æ˜¯ä¸æ˜¯orderdçš„å­ç±»,æ˜¯çš„è¯,å°±ä¼šæ”¾å…¥åˆ°orderedPostProcessorNamesé›†åˆä¸­,</span></span><br><span class="line"><span class="comment">//å¦‚æœä¸Šé¢äºŒè€…éƒ½ä¸çš„è¯,å°±ä¼šæ”¾å…¥åˆ°nonOrderedPostProcessorNamesé›†åˆä¸­  </span></span><br><span class="line">		<span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line">			<span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;</span><br><span class="line">				BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class);</span><br><span class="line">				priorityOrderedPostProcessors.add(pp);</span><br><span class="line">				<span class="keyword">if</span> (pp <span class="keyword">instanceof</span> MergedBeanDefinitionPostProcessor) &#123;</span><br><span class="line">					internalPostProcessors.add(pp);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;</span><br><span class="line">				orderedPostProcessorNames.add(ppName);</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				nonOrderedPostProcessorNames.add(ppName);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// First, register the BeanPostProcessors that implement PriorityOrdered.</span></span><br><span class="line"><span class="comment">//å…ˆå¤„ç†priorityOrderedPostProcessorsè¿™ä¸ªé›†åˆä¸­çš„æ•°æ®.å…ˆæ’åº,ç„¶åè°ƒç”¨registerBeanPostPtocessorsæ–¹æ³•.</span></span><br><span class="line">		sortPostProcessors(priorityOrderedPostProcessors, beanFactory);</span><br><span class="line">		registerBeanPostProcessors(beanFactory, priorityOrderedPostProcessors);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Next, register the BeanPostProcessors that implement Ordered.</span></span><br><span class="line"><span class="comment">//åœ¨å¤„ç†orderedPostProcessorNamesé›†åˆä¸­çš„æ•°æ®,å‘ç°å¦‚æœä¹Ÿæ˜¯MergedBeanDefinitionPostProcessoræˆ–è€…å…¶å­ç±»çš„è¯,ä¹Ÿå°±æ”¾å…¥åˆ°internalPostProcessorsé›†åˆä¸­,ä¹Ÿå°±æ˜¯è¿™é‡Œå…ˆä¸å¤„ç†.</span></span><br><span class="line">		List&lt;BeanPostProcessor&gt; orderedPostProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		<span class="keyword">for</span> (String ppName : orderedPostProcessorNames) &#123;</span><br><span class="line">			BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class);</span><br><span class="line">			orderedPostProcessors.add(pp);</span><br><span class="line">			<span class="keyword">if</span> (pp <span class="keyword">instanceof</span> MergedBeanDefinitionPostProcessor) &#123;</span><br><span class="line">				internalPostProcessors.add(pp);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"><span class="comment">//æ’åº,å¤„ç†ä¸Šé¢ä¸æ˜¯MergedBeanDefinitionPostProcessorçš„æˆ–å…¶å­ç±»,å¹¶ä¸”æ˜¯ orderedPostProcessorNamesé›†åˆä¸­çš„æ•°æ®</span></span><br><span class="line">		sortPostProcessors(orderedPostProcessors, beanFactory);</span><br><span class="line">		registerBeanPostProcessors(beanFactory, orderedPostProcessors);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Now, register all regular BeanPostProcessors.</span></span><br><span class="line"><span class="comment">//æœ€åå°±å¤„ç†æ—¢ä¸æ˜¯PriorityOrdered,ä¹Ÿä¸æ˜¯Orderedçš„,å¦‚æœä¹Ÿæ˜¯MergedBeanDefinitionPostProcessoræˆ–è€…å…¶å­ç±»çš„è¯,è¿™é‡Œä¹Ÿä¼šæ”¾å…¥åˆ°internalPostProcessorsé›†åˆä¸­ </span></span><br><span class="line">		List&lt;BeanPostProcessor&gt; nonOrderedPostProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		<span class="keyword">for</span> (String ppName : nonOrderedPostProcessorNames) &#123;</span><br><span class="line">			BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class);</span><br><span class="line">			nonOrderedPostProcessors.add(pp);</span><br><span class="line">			<span class="keyword">if</span> (pp <span class="keyword">instanceof</span> MergedBeanDefinitionPostProcessor) &#123;</span><br><span class="line">				internalPostProcessors.add(pp);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"><span class="comment">//è¿™é‡Œå…ˆå¤„ç†nonOrderedPostProcessorNamesä¸­çš„æ•°æ®å¹¶ä¸”ä¸æ˜¯ MergedBeanDefinitionPostProcessorçš„å­ç±».</span></span><br><span class="line">		registerBeanPostProcessors(beanFactory, nonOrderedPostProcessors);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Finally, re-register all internal BeanPostProcessors.</span></span><br><span class="line"><span class="comment">//æœ€åæ’åºä¸‹ MergedBeanDefinitionPostProcessorå­ç±»çš„é›†åˆ,è°ƒç”¨registerBeanPostProcessorsæ–¹æ³•,æ³¨å†Œåˆ°BeanFactoryä¸­å».   </span></span><br><span class="line">		sortPostProcessors(internalPostProcessors, beanFactory);</span><br><span class="line">		registerBeanPostProcessors(beanFactory, internalPostProcessors);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Re-register post-processor for detecting inner beans as ApplicationListeners,</span></span><br><span class="line">		<span class="comment">// moving it to the end of the processor chain (for picking up proxies etc).</span></span><br><span class="line"><span class="comment">//æœ€åæ·»åŠ ä¸€ä¸ªApplicationListenerDetectoråˆ°beanFactoryä¸­å»,å¹¶ä¸”ApplicationListenerDetectoræ˜¯æœ‰å®ç°MergedBeanDefinitionPostProcessoræ¥å£çš„.</span></span><br><span class="line">		beanFactory.addBeanPostProcessor(<span class="keyword">new</span> ApplicationListenerDetector(applicationContext));</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="refersh-initMessageSource-æ–¹æ³•"   >
          <a href="#refersh-initMessageSource-æ–¹æ³•" class="heading-link"><i class="fas fa-link"></i></a><a href="#refersh-initMessageSource-æ–¹æ³•" class="headerlink" title="refersh.initMessageSource() æ–¹æ³•"></a>refersh.initMessageSource() æ–¹æ³•</h4>
      <p>è¿™ä¸ªæ–¹æ³•ä¸»è¦æ˜¯å¯¹ MESSAGE_SOURCE_BEAN_NAME æ˜¯å¦åœ¨beanFactoryä¸­è¿›è¡Œåˆ¤æ–­.å¦‚æœå·²ç»åœ¨äº†çš„è¯,å°±ä¼šåˆ¤æ–­æ˜¯ä¸æ˜¯HierarchicalMessageSourceç±»å‹,ç»§ç»­åˆ¤æ–­å…¶ParentMessageSourceæ˜¯ä¸æ˜¯null,å¦‚æœæ˜¯nullçš„è¯,å°±ä¼šgetInternalParentMessageSourceè°ƒç”¨åˆå§‹åŒ–è·å–ä¸€äº›å€¼ç»™èµ‹å€¼è¿›å».</p>
<p>å¦‚æœbeanFactoryä¸­æ²¡æœ‰çš„è¯,å°±ä¼šå…ˆnewä¸€ä¸ª,ç„¶åä¹Ÿä¼šsetParentMessageSourceå€¼è¿›å»,æœ€åæ³¨å†Œåˆ°beanFactoryä¸­å».</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Initialize the MessageSource.</span></span><br><span class="line"><span class="comment"> * Use parent&#x27;s if none defined in this context.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initMessageSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">//å…ˆè·å–BeanFactory.  </span></span><br><span class="line">   ConfigurableListableBeanFactory beanFactory = getBeanFactory();</span><br><span class="line"><span class="comment">// beanFactoryä¸­åŒ…å«MESSAGE_SOURCE_BEAN_NAME</span></span><br><span class="line">   <span class="keyword">if</span> (beanFactory.containsLocalBean(MESSAGE_SOURCE_BEAN_NAME)) &#123;</span><br><span class="line"> <span class="comment">//è·å–å‡ºå‡ºæ¥çš„beanèµ‹å€¼ç»™this.messageSource      </span></span><br><span class="line">      <span class="keyword">this</span>.messageSource = beanFactory.getBean(MESSAGE_SOURCE_BEAN_NAME, MessageSource.class);</span><br><span class="line">      <span class="comment">// Make MessageSource aware of parent MessageSource.</span></span><br><span class="line"><span class="comment">//this.parentä¸æ˜¯nullå¹¶ä¸”beanæ˜¯HierarchicalMessageSource</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.parent != <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.messageSource <span class="keyword">instanceof</span> HierarchicalMessageSource) &#123;</span><br><span class="line">        <span class="comment">//å¼ºè½¬  </span></span><br><span class="line">         HierarchicalMessageSource hms = (HierarchicalMessageSource) <span class="keyword">this</span>.messageSource;</span><br><span class="line">  <span class="comment">// hmsè·å–å‡ºæ¥çš„parentMessageSourceæ˜¯nullæƒ…å†µä¸‹,getInternalParentMessageSource()è¿”å›çš„å€¼èµ‹å€¼ç»™hmsçš„ParentMessageSourceå±æ€§  </span></span><br><span class="line">         <span class="keyword">if</span> (hms.getParentMessageSource() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Only set parent context as parent MessageSource if no parent MessageSource</span></span><br><span class="line">            <span class="comment">// registered already.</span></span><br><span class="line">            hms.setParentMessageSource(getInternalParentMessageSource());</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">         logger.debug(<span class="string">&quot;Using MessageSource [&quot;</span> + <span class="keyword">this</span>.messageSource + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"><span class="comment">// beanFactoryä¸­ä¸åŒ…å«MESSAGE_SOURCE_BEAN_NAME    </span></span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// Use empty MessageSource to be able to accept getMessage calls.</span></span><br><span class="line"><span class="comment">//è‡ªå·±newä¸€ä¸ªDelegatingMessageSource,dms    </span></span><br><span class="line">      DelegatingMessageSource dms = <span class="keyword">new</span> DelegatingMessageSource();</span><br><span class="line"><span class="comment">//è°ƒç”¨getInternalParentMessageSource()æ–¹æ³•çš„è¿”å›å€¼ç»™setè¿›å».  </span></span><br><span class="line">      dms.setParentMessageSource(getInternalParentMessageSource());</span><br><span class="line">      <span class="keyword">this</span>.messageSource = dms;</span><br><span class="line"><span class="comment">// æ³¨å…¥åˆ° beanFactroyä¸­å»       </span></span><br><span class="line">      beanFactory.registerSingleton(MESSAGE_SOURCE_BEAN_NAME, <span class="keyword">this</span>.messageSource);</span><br><span class="line"><span class="comment">// æ ¹æ®logçš„çº§åˆ«æ¥æ‰“å°.       </span></span><br><span class="line">      <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">         logger.debug(<span class="string">&quot;Unable to locate MessageSource with name &#x27;&quot;</span> + MESSAGE_SOURCE_BEAN_NAME +</span><br><span class="line">               <span class="string">&quot;&#x27;: using default [&quot;</span> + <span class="keyword">this</span>.messageSource + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="refresh-initApplicationEventMulticaster-æ–¹æ³•"   >
          <a href="#refresh-initApplicationEventMulticaster-æ–¹æ³•" class="heading-link"><i class="fas fa-link"></i></a><a href="#refresh-initApplicationEventMulticaster-æ–¹æ³•" class="headerlink" title="refresh.initApplicationEventMulticaster() æ–¹æ³•"></a>refresh.initApplicationEventMulticaster() æ–¹æ³•</h4>
      <p>è¯¥æ–¹æ³•å¯ä»¥çœ‹åˆ°ä¹Ÿæ˜¯å¯¹APPLICATION_EVENT_MULTICASTER_BEAN_NAMEæ˜¯å¦åœ¨beançš„åˆ¤æ–­ï¼Œå¦‚æœæœ‰çš„è¯,å°±ä¼šgetå‡ºæ¥,æ²¡æœ‰çš„è¯,å°±ä¼šnewä¸€ä¸ªå‡ºæ¥,ç„¶åæ³¨å†Œåˆ°beanFactoryä¸­å».</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Initialize the ApplicationEventMulticaster.</span></span><br><span class="line"><span class="comment"> * Uses SimpleApplicationEventMulticaster if none defined in the context.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> org.springframework.context.event.SimpleApplicationEventMulticaster</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initApplicationEventMulticaster</span><span class="params">()</span> </span>&#123;</span><br><span class="line"> <span class="comment">// å…ˆè·å–beanFactory   </span></span><br><span class="line">   ConfigurableListableBeanFactory beanFactory = getBeanFactory();</span><br><span class="line"> <span class="comment">//åˆ¤æ–­beanFactoryæ˜¯ä¸æ˜¯æœ‰APPLICATION_EVENT_MULTICASTER_BEAN_NAMEè¿™ä¸ªbean,</span></span><br><span class="line"> <span class="comment">//å¦‚æœæ˜¯æœ‰çš„è¯,å°±ä¼šè·å–å‡ºæ¥.ç„¶åè¿›è¡Œlogçš„çº§åˆ«,åˆ¤æ–­è¦ä¸è¦æ‰“å°</span></span><br><span class="line">   <span class="keyword">if</span> (beanFactory.containsLocalBean(APPLICATION_EVENT_MULTICASTER_BEAN_NAME)) &#123;</span><br><span class="line">      <span class="keyword">this</span>.applicationEventMulticaster =</span><br><span class="line">            beanFactory.getBean(APPLICATION_EVENT_MULTICASTER_BEAN_NAME, ApplicationEventMulticaster.class);</span><br><span class="line">      <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">         logger.debug(<span class="string">&quot;Using ApplicationEventMulticaster [&quot;</span> + <span class="keyword">this</span>.applicationEventMulticaster + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line"> <span class="comment">//å¦‚æœbeanFactoryæ˜¯ä¸åŒ…å«çš„è¯,é‚£ä¹ˆä¹…newä¸€ä¸ªSimpleApplicationEventMulticasterå‡ºæ¥,</span></span><br><span class="line"> <span class="comment">//ç„¶åæ³¨å†Œåˆ°beanFactoryä¸­å»,æœ€åæ ¹æ®logçš„çº§åˆ«æ¥åˆ¤æ–­æ‰“å°</span></span><br><span class="line">  </span><br><span class="line">      <span class="keyword">this</span>.applicationEventMulticaster = <span class="keyword">new</span> SimpleApplicationEventMulticaster(beanFactory);</span><br><span class="line">      beanFactory.registerSingleton(APPLICATION_EVENT_MULTICASTER_BEAN_NAME, <span class="keyword">this</span>.applicationEventMulticaster);</span><br><span class="line">      <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">         logger.debug(<span class="string">&quot;Unable to locate ApplicationEventMulticaster with name &#x27;&quot;</span> +</span><br><span class="line">               APPLICATION_EVENT_MULTICASTER_BEAN_NAME +</span><br><span class="line">               <span class="string">&quot;&#x27;: using default [&quot;</span> + <span class="keyword">this</span>.applicationEventMulticaster + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="refresh-onRefresh-æ–¹æ³•"   >
          <a href="#refresh-onRefresh-æ–¹æ³•" class="heading-link"><i class="fas fa-link"></i></a><a href="#refresh-onRefresh-æ–¹æ³•" class="headerlink" title="refresh.onRefresh() æ–¹æ³•"></a>refresh.onRefresh() æ–¹æ³•</h4>
      <p>è¯¥æ–¹æ³•æ—¶ç•™ç»™å­ç±»çš„ã€‚ å¦‚æœæ˜¯SpringBootå¯åŠ¨çš„è¯,è¿™é‡Œå°±ä¼šå»new Tomcat,ç„¶åå¯åŠ¨webç›¸åº”çš„ç¯å¢ƒ.</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Template method which can be overridden to add context-specific refresh work.</span></span><br><span class="line"><span class="comment"> * Called on initialization of special beans, before instantiation of singletons.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;This implementation is empty.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> BeansException in case of errors</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #refresh()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onRefresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">   <span class="comment">// For subclasses: do nothing by default.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="refresh-registerListeners-æ–¹æ³•"   >
          <a href="#refresh-registerListeners-æ–¹æ³•" class="heading-link"><i class="fas fa-link"></i></a><a href="#refresh-registerListeners-æ–¹æ³•" class="headerlink" title="refresh.registerListeners() æ–¹æ³•"></a>refresh.registerListeners() æ–¹æ³•</h4>
      <p>è¯¥æ–¹æ³•æ˜¯å…ˆè·å– ApplicationListeners,å¦‚æœæ˜¯æœ‰å€¼çš„è¯,å°±ä¼šæ·»åŠ åˆ°AbstractApplicationEventMulticasterçš„ListenerRetrieverçš„applicationListenersé›†åˆä¸­å».</p>
<p>æ ¹æ®ApplicationListener.classè·å–å¯¹åº”çš„beanä¿¡æ¯,ç„¶åè¿­ä»£,æœ€åä¼šæ·»åŠ åˆ°AbstractApplicationEventMulticasterçš„ListenerRetrieverçš„applicationListenerBeanså±æ€§ä¸­å»</p>
<p>æœ€åæ˜¯å¯¹this.earlyApplicationEventsä¸­çš„äº‹ä»¶è¿›è¡Œå‘å¸ƒ</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Add beans that implement ApplicationListener as listeners.</span></span><br><span class="line"><span class="comment"> * Doesn&#x27;t affect other listeners, which can be added without being beans.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">registerListeners</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="comment">// Register statically specified listeners first.</span></span><br><span class="line"><span class="comment">//getApplicationListeners()è·å–AbstractApplicationContextä¸­çš„applicationListeners</span></span><br><span class="line"><span class="comment">//getApplicationEventMulticaster()æ–¹æ³•è·å–çš„applicationEventMulticaster,æ˜¯åœ¨</span></span><br><span class="line"><span class="comment">//initApplicationEventMulticasteræ–¹æ³•ä¸­æœ‰åˆå§‹åŒ–çš„.    </span></span><br><span class="line"><span class="comment">//org.springframework.context.event.AbstractApplicationEventMulticaster#addApplicationListener,æœ€åæ˜¯èµ°åˆ°äº†è¿™é‡Œ, </span></span><br><span class="line"><span class="comment">//this.defaultRetriever.applicationListeners.add(listener);æœ€ålisteneræ˜¯æ·»åŠ åˆ°</span></span><br><span class="line"><span class="comment">//å…¶å†…éƒ¨å†…ListenerRetrieverçš„applicationListenerså‚æ•°ä¸­å»äº†.    </span></span><br><span class="line">   <span class="keyword">for</span> (ApplicationListener&lt;?&gt; listener : getApplicationListeners()) &#123;</span><br><span class="line">      getApplicationEventMulticaster().addApplicationListener(listener);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Do not initialize FactoryBeans here: We need to leave all regular beans</span></span><br><span class="line">   <span class="comment">// uninitialized to let post-processors apply to them!</span></span><br><span class="line"><span class="comment">//æ ¹æ®ApplicationListenerè·å–ç›¸åº”çš„beanNamesæ•°ç»„,è¿™é‡Œå¯ä»¥çœ‹åˆ°å’Œä¹‹å‰è·å–PostProcessoræ˜¯ä¸€æ ·çš„</span></span><br><span class="line">   String[] listenerBeanNames = getBeanNamesForType(ApplicationListener.class, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line"><span class="comment">//ç„¶åè¿­ä»£, getApplicationListenerBeanæ˜¯èµ°åˆ°äº†</span></span><br><span class="line"><span class="comment">//org.springframework.context.event.AbstractApplicationEventMulticaster#addApplicationListenerBean,ä¹Ÿå°±æ˜¯æ·»åŠ åˆ°äº†å…¶å†…éƒ¨ç±»ListenerRetrieverçš„applicationListenerBeanså±æ€§é‡Œé¢    </span></span><br><span class="line">   <span class="keyword">for</span> (String listenerBeanName : listenerBeanNames) &#123;</span><br><span class="line">      getApplicationEventMulticaster().addApplicationListenerBean(listenerBeanName);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Publish early application events now that we finally have a multicaster...</span></span><br><span class="line"><span class="comment">//ä½¿ç”¨this.earlyApplicationEventsçš„é›†åˆçš„å€¼,èµ‹å€¼ç»™å˜é‡earlyEventsToProcess,</span></span><br><span class="line"><span class="comment">//ç„¶åç»™this.earlyApplicationEventsé‡ç½®ä¸ºnull   </span></span><br><span class="line">   Set&lt;ApplicationEvent&gt; earlyEventsToProcess = <span class="keyword">this</span>.earlyApplicationEvents;</span><br><span class="line">   <span class="keyword">this</span>.earlyApplicationEvents = <span class="keyword">null</span>;</span><br><span class="line"> <span class="comment">//é›†åˆä¸æ˜¯nullå¹¶ä¸”æ˜¯æœ‰å€¼çš„è¯,   </span></span><br><span class="line">   <span class="keyword">if</span> (earlyEventsToProcess != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span> (ApplicationEvent earlyEvent : earlyEventsToProcess) &#123;</span><br><span class="line">  <span class="comment">//org.springframework.context.event.SimpleApplicationEventMulticaster#invokeListener,è¿™é‡Œæ˜¯èµ°åˆ°äº†è¿™é‡Œ,å¯ä»¥çœ‹åˆ°æ˜¯å¯¹è¿™ä¸ªäº‹ä»¶è¿›è¡Œå‘å¸ƒ.</span></span><br><span class="line"> <span class="comment">// ç„¶åä¼šæ ¹æ®ApplicationListenerå»èµ°onApplicationEventæ–¹æ³•         </span></span><br><span class="line">         getApplicationEventMulticaster().multicastEvent(earlyEvent);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="refresh-finishBeanFactoryInitialization-æ–¹æ³•"   >
          <a href="#refresh-finishBeanFactoryInitialization-æ–¹æ³•" class="heading-link"><i class="fas fa-link"></i></a><a href="#refresh-finishBeanFactoryInitialization-æ–¹æ³•" class="headerlink" title="refresh.finishBeanFactoryInitialization() æ–¹æ³•"></a>refresh.finishBeanFactoryInitialization() æ–¹æ³•</h4>
      <p>è¯¥æ–¹æ³•ä»åå­—ä¸Šæ¥,å°±æ˜¯ç»“æŸbeanFactoryçš„åˆå§‹åŒ–,ä¹Ÿå°±æ˜¯æˆ‘ä»¬å‰é¢å‡†å¤‡çš„bd,postProcessorç­‰ä¿¡æ¯,åœ¨è¿™é‡Œéƒ½ä¼šä½¿ç”¨åˆ°çš„.</p>
<p>å¯ä»¥çœ‹åˆ°è¯¥æ–¹æ³•å°±æ˜¯çœŸæ­£çš„å®ä¾‹åŒ–beançš„æ–¹æ³•ã€‚ å¤§è‡´å°±æ˜¯getBeanå¾€ä¸‹èµ°,getBeanå¦‚æœæ˜¯æ²¡æœ‰çš„è¯,å°±ä¼šèµ°createBean,ä¹Ÿå°±æ˜¯æ²¡æœ‰å°±å»åˆ›å»ºå˜›ï¼Œå°±æ˜¯è¿™ä¸ªæ„æ€ã€‚ç„¶åå…¶åˆ›å»ºçš„æ¡ä»¶,æ˜¯èµ°å„ç§beanPostProcessorsæ¥è¿›è¡Œæ‰©å±•bean.</p>
<p>beanFactory.preInstantiateSingletons() æ˜¯éœ€è¦å»é˜…è¯»å¾ˆå¤šéçš„. ä¸æ˜¯ä¸€éæˆ–è€…ç®€å•çš„å‡ éå°±okäº†çš„.</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Finish the initialization of this context&#x27;s bean factory,</span></span><br><span class="line"><span class="comment"> * initializing all remaining singleton beans.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finishBeanFactoryInitialization</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">   <span class="comment">// Initialize conversion service for this context.</span></span><br><span class="line"><span class="comment">//å¦‚æœbeanFactoryåŒ…å«CONVERSION_SERVICE_BEAN_NAME,å¹¶ä¸”è¯¥CONVERSION_SERVICE_BEAN_NAMEæ˜¯</span></span><br><span class="line"><span class="comment">//ConversionServiceçš„å­ç±»çš„è¯,ä¹…æ»¡è¶³æ¡ä»¶,ç„¶åå…ˆä»beanFactoryä¸­è·å–å‡ºbean,setç»™beanFactoryä¸­çš„conversionServiceå±æ€§    </span></span><br><span class="line">   <span class="keyword">if</span> (beanFactory.containsBean(CONVERSION_SERVICE_BEAN_NAME) &amp;&amp;</span><br><span class="line">         beanFactory.isTypeMatch(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class)) &#123;</span><br><span class="line">      beanFactory.setConversionService(</span><br><span class="line">            beanFactory.getBean(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Register a default embedded value resolver if no bean post-processor</span></span><br><span class="line">   <span class="comment">// (such as a PropertyPlaceholderConfigurer bean) registered any before:</span></span><br><span class="line">   <span class="comment">// at this point, primarily for resolution in annotation attribute values.</span></span><br><span class="line"><span class="comment">// beanFactoryä¸­æ²¡æœ‰EmbeddedValueResolver,ä¹Ÿå°±æ˜¯è¯¥æ–¹æ³•è¿”å›çš„æ˜¯false,ç„¶åå°±ä»environmentä¸­è·å–å‡ºæ¥ä¸€ä¸ªç»™addåˆ°beanFactoryä¸­å».    </span></span><br><span class="line">   <span class="keyword">if</span> (!beanFactory.hasEmbeddedValueResolver()) &#123;</span><br><span class="line">      beanFactory.addEmbeddedValueResolver(strVal -&gt; getEnvironment().resolvePlaceholders(strVal));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Initialize LoadTimeWeaverAware beans early to allow for registering their transformers early.</span></span><br><span class="line"><span class="comment">//æ ¹æ®LoadTimeWeaverAwareè·å–å‡ºå¯¹ç”¨çš„namesæ•°ç»„</span></span><br><span class="line">   String[] weaverAwareNames = beanFactory.getBeanNamesForType(LoadTimeWeaverAware.class,</span><br><span class="line">         <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç„¶åè¿­ä»£ä¸Šé¢è·å–å‡ºæ¥çš„æ•°ç»„,æŒ¨ä¸ªè°ƒç”¨getBeanæ–¹æ³•    </span></span><br><span class="line">   <span class="keyword">for</span> (String weaverAwareName : weaverAwareNames) &#123;      </span><br><span class="line">      getBean(weaverAwareName);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Stop using the temporary ClassLoader for type matching.</span></span><br><span class="line"><span class="comment">// tempClassLoader,tempçš„ClassLoaderè®¾ç½®ä¸ºnull    </span></span><br><span class="line">   beanFactory.setTempClassLoader(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Allow for caching all bean definition metadata, not expecting further changes.</span></span><br><span class="line"><span class="comment">//org.springframework.beans.factory.support.DefaultListableBeanFactory#freezeConfiguration,è¯¥æ–¹æ³•æ—¶èµ°çš„è¿™é‡Œ. å…¶ä¸­å¯ä»¥çœ‹åˆ°æ˜¯ç»™configurationFrozenè®¾ç½®ä¸ºtrue,ç„¶åbeanNameçš„é›†åˆè½¬åŒ–ä¸ºæ•°ç»„,å¹¶ä¸”èµ‹å€¼ç»™this.frozenBeanDefinitionNamesè¿™ä¸ªæ•°ç»„    </span></span><br><span class="line">   beanFactory.freezeConfiguration();</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Instantiate all remaining (non-lazy-init) singletons.</span></span><br><span class="line"><span class="comment">//è¿™é‡Œé¢åˆå§‹åŒ–bean,ç®€å•è¯´ä¸€ä¸‹é€»è¾‘. org.springframework.beans.factory.support.AbstractBeanFactory#getBean(java.lang.String)</span></span><br><span class="line"><span class="comment">//getBean() ---&gt; doGetBean() ---&gt;   createBean() ---&gt;  doCreateBean() </span></span><br><span class="line"><span class="comment">//ç„¶åå†createBeanå’ŒdoCreateBean()æ–¹æ³•ä¹‹ä¸­,ä¼šæ ¹æ®æ¡ä»¶ä¸Šé¢çš„,è·å–BeanPostProcessors,ç„¶ååˆ¤æ–­èµ°å“¦ä¸èµ°å…¶å„ç§BeanPostProceesorsæä¾›çš„æ–¹æ³•.æ»¡è¶³æ¡ä»¶å°±ä¼šèµ°,ä¸æ»¡è¶³ä¹Ÿå°±è‡ªç„¶ä¸ä¼šèµ°äº†.</span></span><br><span class="line"><span class="comment">//å½“ç„¶äº†è¿™ä¸ªæ–¹æ³•çš„å¤æ‚ç¨‹åº¦æ˜¯æ¯”è¾ƒé«˜çš„ï¼Œæ˜¯éœ€è¦å¥½å¥½ç†è§£çš„ã€‚ä¸æ˜¯è¿™ä¸ªç®€ç®€å•å•çš„å‡ å¥è¯,è¿˜éœ€è¦è‡ªå·±å»è¯».</span></span><br><span class="line"><span class="comment">//èµ·å¤§è‡´æ‰“ä»£ç èµ°å‘å°±æ˜¯è¿™æ ·,ç„¶åå…¶ä¸­ä¼šèµ°å¾ˆå¤šè°ƒç”¨beanæ‰©å±•çš„BeanPostProcessorsï¼Œè¿˜æœ‰å®ç°Init...æ¥å£åæä¾›çš„afterS...ç­‰æ–¹æ³•.    </span></span><br><span class="line">   beanFactory.preInstantiateSingletons();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<h4 id=""><a href="#" class="headerlink" title=""></a></h4>
        <h4 id="refresh-finishRefresh-æ–¹æ³•"   >
          <a href="#refresh-finishRefresh-æ–¹æ³•" class="heading-link"><i class="fas fa-link"></i></a><a href="#refresh-finishRefresh-æ–¹æ³•" class="headerlink" title="refresh.finishRefresh() æ–¹æ³•"></a>refresh.finishRefresh() æ–¹æ³•</h4>
      <p>å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ–¹æ³•æ˜¯æ¸…é™¤äº†èµ„æºç¼“å­˜, ç„¶å å®ç°Lifecycleæ¥å£çš„å­ç±»,è¿™é‡Œå°±ä¼šå¯åŠ¨å…¶startæ–¹æ³•</p>
<p>å‘é€ä¸€ä¸ªContextRefreshedEventäº‹ä»¶å‡ºå»</p>
<p>æœ€åå°†å½“å‰çš„ AbstractApplicationContext æ·»åŠ åˆ° LiveBeansViewçš„applicationContextsé›†åˆä¸­æ¥</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Finish the refresh of this context, invoking the LifecycleProcessor&#x27;s</span></span><br><span class="line"><span class="comment"> * onRefresh() method and publishing the</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> org.springframework.context.event.ContextRefreshedEvent&#125;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finishRefresh</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="comment">// Clear context-level resource caches (such as ASM metadata from scanning).</span></span><br><span class="line">  <span class="comment">//æ¸…é™¤èµ„æºç¼“å­˜  </span></span><br><span class="line">   clearResourceCaches();</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Initialize lifecycle processor for this context.</span></span><br><span class="line"><span class="comment">// è¿™ä¸ªæ–¹æ³•å°±ä¼šè°ƒç”¨å®ç°äº† Lifecycle æ¥å£çš„å­ç±»,å¹¶ä¸”æ‰§è¡Œå…¶startæ–¹æ³•    </span></span><br><span class="line">   initLifecycleProcessor();</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Propagate refresh to lifecycle processor first.</span></span><br><span class="line">   getLifecycleProcessor().onRefresh();</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Publish the final event.</span></span><br><span class="line"> <span class="comment">//å‘é€ä¸€ä¸ªåˆ·æ–°ä¸Šä¸‹æ–‡çš„Eventå‡ºå»   </span></span><br><span class="line">   publishEvent(<span class="keyword">new</span> ContextRefreshedEvent(<span class="keyword">this</span>));</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Participate in LiveBeansView MBean, if active.</span></span><br><span class="line"><span class="comment">//org.springframework.context.support.LiveBeansView#applicationContexts</span></span><br><span class="line"><span class="comment">//å°†AbstractApplicationContextæ·»åŠ åˆ°liveBeançš„applicationContextsé›†åˆä¸­    </span></span><br><span class="line">   LiveBeansView.registerApplicationContext(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="refresh-resetCommonCaches"   >
          <a href="#refresh-resetCommonCaches" class="heading-link"><i class="fas fa-link"></i></a><a href="#refresh-resetCommonCaches" class="headerlink" title="refresh.resetCommonCaches()"></a>refresh.resetCommonCaches()</h4>
      <p>å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ–¹æ³•æ‰æ˜¯çœŸæ­£çš„æ¸…é™¤å„ç§é›†åˆç¼“å­˜å•¥çš„æ“ä½œ. æ˜¯åœ¨finallyä»£ç å¿«ä¸­,ä¹Ÿå°±æ˜¯è¯´æ˜¯å¿…é¡»è¦æ‰§è¡Œçš„ä»£ç </p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Reset Spring&#x27;s common reflection metadata caches, in particular the</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> ReflectionUtils&#125;, &#123;<span class="doctag">@link</span> AnnotationUtils&#125;, &#123;<span class="doctag">@link</span> ResolvableType&#125;</span></span><br><span class="line"><span class="comment"> * and &#123;<span class="doctag">@link</span> CachedIntrospectionResults&#125; caches.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 4.2</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> ReflectionUtils#clearCache()</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> AnnotationUtils#clearCache()</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> ResolvableType#clearCache()</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> CachedIntrospectionResults#clearClassLoader(ClassLoader)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">resetCommonCaches</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   ReflectionUtils.clearCache();</span><br><span class="line">   AnnotationUtils.clearCache();</span><br><span class="line">   ResolvableType.clearCache();</span><br><span class="line">   CachedIntrospectionResults.clearClassLoader(getClassLoader());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

</div></div></article></section><nav class="paginator"><div class="paginator-inner"><span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fas fa-angle-right"></i></a></div></nav></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><section class="sidebar-toc hide"></section><!-- ov = overview--><section class="sidebar-ov"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="/images/icons/xiaoxin_toouxiang.jpg" alt="avatar"></div><p class="sidebar-ov-author__text">coding</p></div><div class="sidebar-ov-social"><a class="sidebar-ov-social-item" href="https://github.com/ruY9527/" target="_blank" rel="noopener" data-popover="Github" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-github"></i></span></a></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">20</div><div class="sidebar-ov-state-item__name">å½’æ¡£</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">8</div><div class="sidebar-ov-state-item__name">åˆ†ç±»</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--tags" href="/tags/"><div class="sidebar-ov-state-item__count">8</div><div class="sidebar-ov-state-item__name">æ ‡ç­¾</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" data-popover="çŸ¥è¯†å…±äº«è®¸å¯åè®®" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright Â© 2021</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>luohong All Rights Reserved</span></div><div><span>ç”± <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a> å¼ºåŠ›é©±åŠ¨</span><span> v5.4.0</span><span class="footer__devider">|</span><span>ä¸»é¢˜ - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.6.2</span></div><div class="busuanzi"><span class="busuanzi-siteuv"><span class="busuanzi-siteuv__icon"><i class="fas fa-user"></i></span><span class="busuanzi-siteuv__info">è®¿é—®äººæ•°</span><span class="busuanzi-siteuv__value" id="busuanzi_value_site_uv"></span></span><span class="busuanzi-sitepv"><span class="busuanzi-siteuv__icon"><i class="fas fa-eye"></i></span><span class="busuanzi-siteuv__info">æµè§ˆæ€»é‡</span><span class="busuanzi-siteuv__value" id="busuanzi_value_site_pv"></span></span></div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><div class="search-mask"></div><div class="search-popup"><span class="search-close"></span><div class="search-input"><input placeholder="æœç´¢æ–‡ç« ï¼ˆæ”¯æŒå¤šå…³é”®è¯ï¼Œè¯·ç”¨ç©ºæ ¼åˆ†éš”ï¼‰"></div><div class="search-results"></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script src="https://cdn.jsdelivr.net/npm/canvas-nest.js@1.0.1/dist/canvas-nest.min.js" color="0,0,0" opacity="0.6" count="99" zIndex="-1"></script><script>function initSearch() {
  var isXML = true;
  var search_path = 'search.json';

  if (!search_path) {
    search_path = 'search.xml';
  } else if (/json$/i.test(search_path)) {
    isXML = false;
  }

  var path = '/' + search_path;
  $.ajax({
    url: path,
    dataType: isXML ? 'xml' : 'json',
    async: true,
    success: function (res) {
      var datas = isXML ? $('entry', res).map(function () {
        // å°† XML è½¬ä¸º JSON
        return {
          title: $('title', this).text(),
          content: $('content', this).text(),
          url: $('url', this).text()
        };
      }).get() : res;
      var $input = $('.search-input input');
      var $result = $('.search-results');
      // æœç´¢å¯¹è±¡ï¼ˆæ ‡é¢˜ã€å†…å®¹ï¼‰çš„æƒé‡ï¼Œå½±å“æ˜¾ç¤ºé¡ºåº
      var WEIGHT = { title: 100, content: 1 };
      var searchPost = function () {
        var searchText = $input.val().toLowerCase().trim();
        // æ ¹æ®ç©ºç™½å­—ç¬¦åˆ†éš”å…³é”®å­—
        var keywords = searchText.split(/[\s]+/);
        // æœç´¢ç»“æœ
        var matchPosts = [];

        // æœ‰å¤šä¸ªå…³é”®å­—æ—¶ï¼Œå°†åŸæ–‡å­—æ•´ä¸ªä¿å­˜ä¸‹æ¥
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        // é˜²æ­¢æœªè¾“å…¥å­—ç¬¦æ—¶æœç´¢
        if (searchText.length > 0) {
          datas.forEach(function (data) {
            var isMatch  = false;
            // æ²¡æœ‰æ ‡é¢˜çš„æ–‡ç« ä½¿ç”¨é¢„è®¾çš„ i18n å˜é‡ä»£æ›¿
            var title = (data.title && data.title.trim()) || '[ æ–‡ç« æ— æ ‡é¢˜ ]';
            var titleLower = title && title.toLowerCase();
            // åˆ é™¤ HTML æ ‡ç­¾ å’Œ æ‰€æœ‰ç©ºç™½å­—ç¬¦
            var content = data.content && data.content.replace(/<[^>]+>/g, '');
            var contentLower = content && content.toLowerCase();
            // åˆ é™¤é‡å¤çš„ /
            var postURL = data.url && decodeURI(data.url).replace(/\/{2,}/g, '/');
            // æ ‡é¢˜ä¸­åŒ¹é…åˆ°çš„å…³é”®è¯
            var titleHitSlice = [];
            // å†…å®¹ä¸­åŒ¹é…åˆ°çš„å…³é”®è¯
            var contentHitSlice = [];

            keywords.forEach(function (keyword) {
              /**
              * è·å–åŒ¹é…çš„å…³é”®è¯çš„ç´¢å¼•
              * @param {String} keyword è¦åŒ¹é…çš„å…³é”®å­—
              * @param {String} text åŸæ–‡å­—
              * @param {Boolean} caseSensitive æ˜¯å¦åŒºåˆ†å¤§å°å†™
              * @param {Number} weight åŒ¹é…å¯¹è±¡çš„æƒé‡ã€‚æƒé‡å¤§çš„ä¼˜å…ˆæ˜¾ç¤º
              * @return {Array}
              */
              function getIndexByword (word, text, caseSensitive, weight) {
                if (!word || !text) {
                  return [];
                };

                var startIndex = 0; // æ¯æ¬¡åŒ¹é…çš„å¼€å§‹ç´¢å¼•
                var index = -1;     // åŒ¹é…åˆ°çš„ç´¢å¼•å€¼
                var result = [];    // åŒ¹é…ç»“æœ

                if (!caseSensitive) {
                  word = word.toLowerCase();
                  text = text.toLowerCase();
                }

                while((index = text.indexOf(word, startIndex)) !== -1) {
                  var hasMatch = false;
                  // ç´¢å¼•ä½ç½®ç›¸åŒçš„å…³é”®è¯ï¼Œä¿ç•™é•¿åº¦è¾ƒé•¿çš„
                  titleHitSlice.forEach(function (hit) {
                    if (hit.index === index && hit.word.length < word.length) {
                      hit.word = word;
                      hasMatch = true;
                    }
                  });
                  startIndex = index + word.length;
                  !hasMatch && result.push({ index: index, word: word, weight: weight });
                }
                return result;
              }
              titleHitSlice = titleHitSlice.concat(getIndexByword(keyword, titleLower, false, WEIGHT.title));
              contentHitSlice = contentHitSlice.concat(getIndexByword(keyword, contentLower, false, WEIGHT.content));
            });

            var hitTitle = titleHitSlice.length;
            var hitContent = contentHitSlice.length;

            if (hitTitle > 0 || hitContent > 0) {
              isMatch = true;
            }
            if (isMatch) {
              ;[titleHitSlice, contentHitSlice].forEach(function (hit) {
                // æŒ‰ç…§åŒ¹é…æ–‡å­—çš„ç´¢å¼•çš„é€’å¢é¡ºåºæ’åº
                hit.sort(function (left, right) {
                  return left.index - right.index;
                });
              });
              /**
              * ç»™æ–‡æœ¬ä¸­åŒ¹é…åˆ°çš„å…³é”®è¯æ·»åŠ æ ‡è®°ï¼Œä»è€Œè¿›è¡Œé«˜äº®æ˜¾ç¤º
              * @param {String} text åŸæ–‡æœ¬
              * @param {Array} hitSlice åŒ¹é…é¡¹çš„ç´¢å¼•ä¿¡æ¯
              * @param {Number} start å¼€å§‹ç´¢å¼•
              * @param {Number} end ç»“æŸç´¢å¼•
              * @return {String}
              */
              function highlightKeyword (text, hitSlice, start, end) {
                if (!text || !hitSlice || !hitSlice.length) {
                  return;
                }

                var result = '';
                var startIndex = start;
                var endIndex = end;
                hitSlice.forEach(function (hit) {
                  if (hit.index < startIndex) {
                    return;
                  }

                  var hitWordEnd = hit.index + hit.word.length;
                  result += text.slice(startIndex, hit.index);
                  result += '<b>' + text.slice(hit.index, hitWordEnd) + '</b>';
                  startIndex = hitWordEnd;
                });
                result += text.slice(startIndex, endIndex);
                return result;
              }

              var postData = {};
              // æ–‡ç« æ€»çš„æœç´¢æƒé‡
              var postWeight = titleHitSlice.length * WEIGHT.title + contentHitSlice.length * WEIGHT.content;
              // æ ‡è®°åŒ¹é…å…³é”®è¯åçš„æ ‡é¢˜
              var postTitle = highlightKeyword(title, titleHitSlice, 0, title.length) || title;
              // æ ‡è®°åŒ¹é…å…³é”®è¯åçš„å†…å®¹
              var postContent;
              // æ˜¾ç¤ºå†…å®¹çš„é•¿åº¦
              var SHOW_WORD_LENGTH = 200;
              // å‘½ä¸­å…³é”®è¯å‰çš„å­—ç¬¦æ˜¾ç¤ºé•¿åº¦
              var SHOW_WORD_FRONT_LENGTH = 20;
              var SHOW_WORD_END_LENGTH = SHOW_WORD_LENGTH - SHOW_WORD_FRONT_LENGTH;

              // æˆªå–åŒ¹é…çš„ç¬¬ä¸€ä¸ªå­—ç¬¦ï¼Œå‰åå…± 200 ä¸ªå­—ç¬¦æ¥æ˜¾ç¤º
              if (contentHitSlice.length > 0) {
                var firstIndex = contentHitSlice[0].index;
                var start = firstIndex > SHOW_WORD_FRONT_LENGTH ? firstIndex - SHOW_WORD_FRONT_LENGTH : 0;
                var end = firstIndex + SHOW_WORD_END_LENGTH;
                postContent = highlightKeyword(content, contentHitSlice, start, end);
              } else { // æœªåŒ¹é…åˆ°å†…å®¹ï¼Œç›´æ¥æˆªå–å‰ 200 ä¸ªå­—ç¬¦æ¥æ˜¾ç¤º
                postContent = content.slice(0, SHOW_WORD_LENGTH);
              }
              postData.title = postTitle;
              postData.content = postContent;
              postData.url = postURL;
              postData.weight = postWeight;
              matchPosts.push(postData);
            }
          });
        }

        var resultInnerHtml = '';
        if (matchPosts.length) {
          // æŒ‰æƒé‡é€’å¢çš„é¡ºåºæ’åºï¼Œä½¿æƒé‡å¤§çš„ä¼˜å…ˆæ˜¾ç¤º
          matchPosts.sort(function (left, right) {
            return right.weight - left.weight;
          });
          resultInnerHtml += '<ul>';
          matchPosts.forEach(function (post) {
            resultInnerHtml += '<li><a class="search-results-title" href="' + post.url + '">';
            resultInnerHtml += post.title;
            resultInnerHtml += '</a><div class="search-results-content">';
            resultInnerHtml += post.content;
            resultInnerHtml += '</div></li>';
          });
          resultInnerHtml += '</ul>';
        } else {
          resultInnerHtml += '<div class="search-results-none"><i class="far fa-meh"></i></div>';
        }
        $result.html(resultInnerHtml);
      };
      $input.on('input', searchPost);
      $input.on('keyup', function (e) {
        if (e.keyCode === Stun.utils.codeToKeyCode('Enter')) {
          searchPost();
        }
      });
    }
  });
}

function closeSearch () {
  $('body').css({ overflow: 'auto' });
  $('.search-popup').css({ display: 'none' });
  $('.search-mask').css({ display: 'none' });
}

window.addEventListener('DOMContentLoaded', function () {
  Stun.utils.pjaxReloadLocalSearch = function () {
    $('.header-nav-search').on('click', function (e) {
      e.stopPropagation();
      $('body').css('overflow', 'hidden');
      $('.search-popup')
        .velocity('stop')
        .velocity('transition.expandIn', {
          duration: 300,
          complete: function () {
            $('.search-popup input').focus();
          }
        });
      $('.search-mask')
        .velocity('stop')
        .velocity('transition.fadeIn', {
          duration: 300
        });

      initSearch();
    });
    $('.search-mask, .search-close').on('click', function () {
      closeSearch();
    });
    $(document).on('keydown', function (e) {
      // Escape <=> 27
      if (e.keyCode === Stun.utils.codeToKeyCode('Escape')) {
        closeSearch();
      }
    });
  };

  Stun.utils.pjaxReloadLocalSearch();
}, false);

function safeOpenUrl(url) {
  var newTab = window.open();
  newTab.opener = null;
  newTab.location = url;
}

function extSearch(engine) {
  var engines = {
    google: 'https://www.google.com/search?q=',
    bing: 'https://cn.bing.com/search?q=',
    baidu: 'https://www.baidu.com/s?ie=UTF-8&wd=',
  };
  var host = window.location.host;
  var query = $('.search-input input').val().toLowerCase().trim();
  var uri = engines[engine] + query + ' site:' + host;

  if (query) {
    safeOpenUrl(uri);
  } else {
    Stun.utils.popAlert('warning', 'è¯·è¾“å…¥å­—ç¬¦');
  }
}

var assistSearchList = window.CONFIG.assistSearch;

if (Array.isArray(assistSearchList)) {
  assistSearchList.forEach(function (name) {
    document.querySelector('.search-btns-item--' + name).addEventListener('click', function () {
      extSearch(name);
    }, false);
  });
}</script><script src="https://cdn.jsdelivr.net/gh/sukkaw/busuanzi@latest/bsz.pure.mini.js" async></script><script src="/js/utils.js?v=2.6.2"></script><script src="/js/stun-boot.js?v=2.6.2"></script><script src="/js/scroll.js?v=2.6.2"></script><script src="/js/header.js?v=2.6.2"></script><script src="/js/sidebar.js?v=2.6.2"></script><script type="application/json" src="/search.json"></script></body></html>