<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha256-AbA177XfpSnFEvgpYu1jMygiLabzPCJCRIBtR5jGc0k=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"ruy9527.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.13.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script><meta name="description" content="çŸ¥è¯†ç¬”è®°"><meta property="og:type" content="website"><meta property="og:title" content="YangBao"><meta property="og:url" content="https://ruy9527.github.io/index.html"><meta property="og:site_name" content="YangBao"><meta property="og:description" content="çŸ¥è¯†ç¬”è®°"><meta property="og:locale" content="en_US"><meta property="article:author" content="YangBao"><meta property="article:tag" content="çŸ¥è¯†ç¬”è®°"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://ruy9527.github.io/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"index.html","title":""}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>YangBao</title><script async defer data-website-id="" src=""></script><script defer data-domain="" src=""></script><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><link rel="alternate" href="/atom.xml" title="YangBao" type="application/atom+xml">
</head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="Toggle navigation bar" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><h1 class="site-title">YangBao</h1><i class="logo-line"></i></a></div><div class="site-nav-right"><div class="toggle popup-trigger"></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li></ul></nav></div><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div><aside class="sidebar"><div class="sidebar-inner sidebar-overview-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc">Table of Contents</li><li class="sidebar-nav-overview">Overview</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="YangBao" src="/images/touxiang.jpg"><p class="site-author-name" itemprop="name">YangBao</p><div class="site-description" itemprop="description">çŸ¥è¯†ç¬”è®°</div></div><div class="site-state-wrap site-overview-item animated"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">23</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">10</span> <span class="site-state-item-name">categories</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">10</span> <span class="site-state-item-name">tags</span></a></div></nav></div><div class="links-of-author site-overview-item animated"><span class="links-of-author-item"><a href="https://github.com/ruY9527" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;ruY9527" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:1411091515@qq.com" title="E-Mail â†’ mailto:1411091515@qq.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a></span></div></div></div></div></aside><div class="sidebar-dimmer"></div></header><div class="back-to-top" role="button" aria-label="Back to top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner index posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://ruy9527.github.io/2021/12/30/data_article/flink%E6%9C%AC%E5%9C%B0%E7%BC%96%E8%AF%91/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/touxiang.jpg"><meta itemprop="name" content="YangBao"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="YangBao"><meta itemprop="description" content="çŸ¥è¯†ç¬”è®°"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | YangBao"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2021/12/30/data_article/flink%E6%9C%AC%E5%9C%B0%E7%BC%96%E8%AF%91/" class="post-title-link" itemprop="url">flinkæœ¬åœ°ç¼–è¯‘</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Created: 2021-12-30 20:41:44" itemprop="dateCreated datePublished" datetime="2021-12-30T20:41:44+08:00">2021-12-30</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">Edited on</span> <time title="Modified: 2022-11-04 21:46:13" itemprop="dateModified" datetime="2022-11-04T21:46:13+08:00">2022-11-04</time> </span><span class="post-meta-break"></span> <span class="post-meta-item" title="Symbols count in article"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">Symbols count in article: </span><span>0</span> </span><span class="post-meta-item" title="Reading time"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">Reading time &asymp;</span> <span>1 mins.</span></span></div></div></header><div class="post-body" itemprop="articleBody"></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://ruy9527.github.io/2021/11/20/data_article/%E6%95%B0%E6%8D%AE%E7%BB%8F%E5%8E%86-%E4%BA%8C/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/touxiang.jpg"><meta itemprop="name" content="YangBao"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="YangBao"><meta itemprop="description" content="çŸ¥è¯†ç¬”è®°"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | YangBao"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2021/11/20/data_article/%E6%95%B0%E6%8D%AE%E7%BB%8F%E5%8E%86-%E4%BA%8C/" class="post-title-link" itemprop="url">æ•°æ®ç»å†(äºŒ)</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Created: 2021-11-20 11:39:41" itemprop="dateCreated datePublished" datetime="2021-11-20T11:39:41+08:00">2021-11-20</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">Edited on</span> <time title="Modified: 2022-11-04 21:46:13" itemprop="dateModified" datetime="2022-11-04T21:46:13+08:00">2022-11-04</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/" itemprop="url" rel="index"><span itemprop="name">å¤§æ•°æ®</span></a> </span>, <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/%E6%95%B0%E6%8D%AE%E6%88%90%E9%95%BF/" itemprop="url" rel="index"><span itemprop="name">æ•°æ®æˆé•¿</span></a> </span></span><span class="post-meta-break"></span> <span class="post-meta-item" title="Symbols count in article"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">Symbols count in article: </span><span>1.6k</span> </span><span class="post-meta-item" title="Reading time"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">Reading time &asymp;</span> <span>1 mins.</span></span></div></div></header><div class="post-body" itemprop="articleBody"><h2 id="æ•°æ®å¼€å‘æµç¨‹"><a href="#æ•°æ®å¼€å‘æµç¨‹" class="headerlink" title="æ•°æ®å¼€å‘æµç¨‹"></a>æ•°æ®å¼€å‘æµç¨‹</h2><p>â€‹ å…¶å®æ•°æ®å¼€å‘ä¸­é‡è§çš„é—®é¢˜å’Œæˆ‘ä»¬åº”ç”¨å±‚é¢çš„é—®é¢˜å­˜åœ¨éƒ¨åˆ†çš„ç›¸ä¼¼ä¹‹å¤„ï¼Œä½†æ˜¯åœ¨è¿›è¡Œæ•°æ®é—®é¢˜æ’é”™çš„æ—¶å€™ï¼Œåˆå­˜åœ¨äº›è®¸çš„ä¸ç›¸ä¼¼ã€‚æ€»ä½“ä¸Šçš„æ„Ÿè§‰,å¾—å»åšè¿‡å’Œæ’æŸ¥è¿‡,è‡ªèº«æ‰èƒ½å¯¹é—®é¢˜ç†è§£åˆ°æ¯”è¾ƒæ¸…æ™°ã€‚</p><h2 id="ä»»åŠ¡è°ƒåº¦"><a href="#ä»»åŠ¡è°ƒåº¦" class="headerlink" title="ä»»åŠ¡è°ƒåº¦"></a>ä»»åŠ¡è°ƒåº¦</h2><p>â€‹ ä»»åŠ¡è°ƒåº¦,è¿™ä¸ªæ˜¯æœ‰æ—¶åºçš„,ä¹Ÿæ˜¯å­˜åœ¨å…ˆåé¡ºåºçš„ã€‚ ä¸€èˆ¬æœ€æ™šçš„æ—¶é—´ç‚¹å°±æ˜¯æˆ‘ä»¬æ‹‰å–æœ€æ™šé‚£æ‰¹æ•°æ®çš„æ—¶é—´äº†ã€‚</p><p>â€‹ ç†æƒ³æƒ…å†µä¸‹(åŸºäºç¦»çº¿æ•°ä»“): æ¯”è¾ƒç†æƒ³çš„æƒ…å†µä¸‹,å°±æ˜¯æˆ‘ä»¬æœ€å¥½æ¯ä¸€å±‚çš„å¤„ç†æ—¶é—´é¢„ç®—éƒ½æ˜¯åœç•™åœ¨ä¸€ä¸ªå°æ—¶å·¦å³,ä½†æ˜¯å…·ä½“çš„æ—¶é—´é‡ç­‰æƒ…å†µï¼Œå¾—çœ‹æ•°æ®é‡å’Œå…·ä½“çš„ä¸šåŠ¡éœ€è¦äº†.</p><p>â€‹ 0ç‚¹1ç‚¹: æ‰§è¡Œodsçš„æ•°æ®,å…·ä½“çš„è°ƒåº¦å‘¨æœŸå°±è·Ÿä½ ä¸šåŠ¡ä¸Šçš„æ•°æ®å˜åŒ–æˆ–è€…æ•°ä»“ä¸­çš„æ•°æ®éœ€è¦,æ¥è¿›è¡Œè°ƒåº¦å‘¨æœŸæ˜¯å¤©&#x2F;å‘¨&#x2F;æœˆç­‰æƒ…å†µçš„è°ƒåº¦å¤„ç†.</p><p>â€‹ 1ç‚¹åˆ°2ç‚¹: æ‰§è¡Œdimæˆ–è€…dwdçš„æ•°æ®,è¿™ä¸ªç»„ç»‡ç»´åº¦çš„æ•°æ®,çœ‹æ˜¯å¦æœ‰å˜åŒ–çš„è°ƒæ•´(ä¸€èˆ¬å…¬å¸çš„äººå‘˜ç»„ç»‡æˆ–è€…é›†å›¢ä¸‹çš„é¢„å–,åŸå¸‚,é¡¹ç›®ä¹‹ç±»çš„ä¼šå­˜åœ¨æœ‰å˜åŒ–çš„è°ƒæ•´).</p><p>â€‹ 2ç‚¹åˆ°3ç‚¹: dws å±‚çš„æ•°æ®å¤„ç†,ä¸€èˆ¬dwsçš„æ•°æ®å¯ä»¥æ˜¯ç”±dimå’Œdwdè¿›è¡Œè½»åº¦æ±‡æ€»è·å–å‡ºæ¥çš„. å…¶å®åˆ°äº†è¿™å±‚çš„è¯,éœ€è¦çš„æŒ‡æ ‡å¯¹åº”çš„æœ€å°ç»´åº¦åŸºæœ¬å·²ç»å¯ä»¥çœ‹åˆ°æ•°æ®äº†ã€‚åªæ˜¯è¿™ä¸ªç»´åº¦çš„æ•°æ®,æ˜¯æœ€å°çš„æ—¶é—´ç»´åº¦å’Œç»„ç»‡ç»´åº¦æ±‡èšå‡ºæ¥çš„ã€‚</p><p>â€‹ 3ç‚¹åˆ°4ç‚¹: admå±‚çš„æ•°æ®æ±‡æ€»,ä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„æ•°ä»“æœ€ç»ˆç»™è¾“å‡ºå‡ºæ¥çš„å¤§å®½è¡¨æ•°æ®.</p><p>â€‹ æœ‰äº†å¤§å®½è¡¨å,çœ‹ä¸‹æ•°æ®è¿˜éœ€ä¸éœ€è¦åŒæ­¥åˆ°mmpè¿™ç±»çš„æ•°æ®åº“ä¸­,æ¥è¿›è¡Œä¸€ä¸ªé«˜æ•ˆç‡çš„æŸ¥è¯¢(æ¯”å¦‚clickhouse,driosç­‰).</p><h2 id="è¡¨çš„è®¾è®¡"><a href="#è¡¨çš„è®¾è®¡" class="headerlink" title="è¡¨çš„è®¾è®¡"></a>è¡¨çš„è®¾è®¡</h2><p>â€‹ è¡¨çš„è®¾è®¡ä¹Ÿæ˜¯å¾ˆå…³é”®çš„,ç›®å‰è™½ç„¶æˆ‘ä»¬çš„æ•°æ®è®¾è®¡æ¥æºäºä¸šåŠ¡éœ€æ±‚&#x2F;æŠ¥è¡¨éœ€æ±‚&#x2F;å•†ä¸šæŠ¥è¡¨éœ€æ±‚ç­‰åœºæ™¯,ä½†æ˜¯æ›´å¥½çš„è”ç³»èµ·å®é™…çš„è®¾è®¡ä¹Ÿå¾ˆé‡è¦çš„ã€‚</p><p>â€‹ ä¸¾ä¸ªä¾‹å­: æˆ‘ä»¬çš„ç»„ç»‡ç»´åº¦, å­˜åœ¨ ç»„ç»‡1 , ç»„ç»‡2 ï¼Œ ç»„ç»‡3 (è¿™ä¸‰è€…çš„å…³ç³»å°±æ˜¯æˆ‘ä»¬å¹³å¸¸çœ‹åˆ°çš„æ ‘çš„æ¦‚å¿µ,1æ˜¯2çš„ä¸Šçº§,2æ˜¯3çš„ä¸Šçº§),åŒæ—¶è¿˜å­˜åœ¨æ—¶é—´ç»´åº¦çš„(æœˆ,å­£åº¦,å¹´). æ­¤æ—¶,æ¢³ç†å®ŒæŒ‡æ ‡çš„è®¡ç®—å£å¾„,æˆ‘ä»¬å‘ç°,1çš„æ•°æ®ç”±2æ±‡èš,2çš„æ•°æ®ç”±3è¿›è¡Œæ±‡èš, å¹´ç”±æœˆæ±‡èš,å­£åº¦ä¹Ÿæ˜¯æœˆæ±‡èšå‡ºæ¥çš„, äºæ˜¯æˆ‘ä»¬è®¾è®¡dwsæˆ–è€…admæœ€åæ±‡æ€»çš„è¡¨æ ·æ—¶å€™,å¯ä»¥å†—ä½™ ç»„ç»‡2å’Œç»„ç»‡1å¯¹åº”åˆ°ç»„ç»‡3,æ—¶é—´ç»´åº¦å†—ä½™æœ€å°çš„æœˆä»½ï¼Œäºæ˜¯åœ¨ç»„ç»‡è¿™ä¸ªç»´åº¦å°±å¯ä»¥æ¸…æ™°çš„çœ‹åˆ°ï¼Œæ ¹æ®ç»„ç»‡1å’Œç»„ç»‡2è¿›è¡Œsumå’Œgroupçš„æ—¶å€™,å°±è·å–åˆå¯¹åº”ç»„ç»‡çš„å€¼äº†(å†—ä½™ç»„ç»‡çš„å…³ç³»,èšåˆçš„æ—¶å€™å°±å¯ä»¥å‡å°‘å»éœ€è¦ä¸Šä¸‹çº§ä¹‹é—´çš„å…³ç³»äº†).</p><p>â€‹ å‰ç½®æ¡ä»¶: æ•°æ®æ±‡èšçš„è®¡ç®—å£å¾„å¾—æ¸…æ™°å’Œæ˜ç™½,æ–¹æ¡ˆå¹¶ä¸èƒ½é€‚åº”æ‰€æœ‰çš„åœºæ™¯. æ¯”å¦‚è¿™é‡Œçš„ç»„ç»‡å¾—æ˜ç¡®æœ€å¤šå¤šå°‘å±‚,ä¸€èˆ¬ä¸€ä¸ªé›†å›¢æˆ–è€…ä¸€ä¸ªå…¬å¸,ä¸ä¼šå‡ºç°å¾ˆå¤šçº§å¾—æ¦‚å¿µ.</p><h2 id="æ•°æ®é‡å¤"><a href="#æ•°æ®é‡å¤" class="headerlink" title="æ•°æ®é‡å¤"></a>æ•°æ®é‡å¤</h2><p>â€‹ æ•°æ®é‡å¤è¿™ä¸ªé—®é¢˜ä¹Ÿæ˜¯å¾ˆå¸¸è§çš„è¯,æ¯”å¦‚ä½ æ‹‰å–è¿‡æ¥çš„ç»„ç»‡æ€ä¹ˆé‡å¤äº†å‘€? æˆ‘è¿™ä¸ªæŒ‡æ ‡çš„å­—æ®µæ€ä¹ˆåœ¨å¸†è½¯æŠ¥è¡¨ä¸Šä¹Ÿæ˜¯é‡å¤çš„äº†å•Š? æ¯”å¦‚æœ‰æ—¶å€™æˆ‘ä»¬ä¸ºäº†å»å†—ä½™ä¸€äº›å¤šä½™çš„å­—æ®µè¿›æ¥çš„æ—¶å€™,å¹¶æ²¡æœ‰å¾ˆæ˜ç™½è¯¥å­—æ®µå¯¹åº”çš„åœºæ™¯æˆ–è€…è¯´æ˜¯ä¸šåŠ¡å˜åŒ–çš„åœºæ™¯,å¯¼è‡´é‡å¤çš„é—®é¢˜</p><p>â€‹ ä¸¾ä¸ªä¾‹å­: æ›´æ–°æ—¶é—´å­—æ®µ, æˆ‘ä»¬èšåˆsumæ•°æ®çš„æ—¶å€™,å¯èƒ½ä¼šè€ƒè™‘åˆ°å†—ä½™è¯¥å­—æ®µè¿›æ¥,äºæ˜¯å¹¶æ²¡æœ‰è€ƒè™‘åˆ°æ—¶é—´å˜åŒ–å¯èƒ½ä¼šæœ‰ä¸åŒçš„æ—¥æœŸçš„æ—¶å€™çš„åœºæ™¯,groupå°±ä¼šå‡ºç°å¤šæ¡æ•°æ®çš„æƒ…å†µ</p><p>â€‹</p><p>â€‹ ä»»åŠ¡é‡è·‘å¯¼è‡´çš„æ•°æ®é‡å¤é—®é¢˜:</p><p>â€‹ ä¸€èˆ¬hiveä¸­,æˆ‘ä»¬éƒ½ä¼šå¯¹è¡¨è¿›è¡Œåˆ†åŒºä¹‹ç±»çš„æ“ä½œ. æˆ‘ä»¬åœ¨æ’å…¥æ•°æ®ä¹‹å‰,ä¼šè¦†ç›–æ•°æ®çš„. ä»€ä¹ˆæ„æ€å‘¢? å°±æ˜¯insert overwrite ä¼šåœ¨æ’å…¥ä¹‹å‰,åˆ é™¤å¯¹åº”åˆ†åŒºçš„æ•°æ®,å†è¿›è¡Œæ•°æ®çš„æ’å…¥. ä½†æ˜¯æœ‰æ—¶å€™å†™æ¼æ‰äº†æˆ–è€…jobè·‘çš„æ—¶å€™å‡ºç°åŒæ—¶å¤šè·‘çš„æƒ…å†µ,å°±æœ‰å¯èƒ½å‡ºç°æ•°æ®é‡å¤çš„é—®é¢˜</p><h2 id="å®æ—¶æ•°æ®æ¥å…¥"><a href="#å®æ—¶æ•°æ®æ¥å…¥" class="headerlink" title="å®æ—¶æ•°æ®æ¥å…¥"></a>å®æ—¶æ•°æ®æ¥å…¥</h2><p>â€‹ flink cdc : å¾…ä½¿ç”¨</p><p>â€‹ canal: æ­£å¸¸æƒ…å†µä¸‹,æˆ‘ä»¬ä¼šä½¿ç”¨canal+kafkaæ¥è¿›è¡Œä¸ç¨‹åºçš„ç»“æ„,æ„æ€å°±æ˜¯canalå‡è£…æˆmysqlçš„é‡èŠ‚ç‚¹,è·å–mysqlçš„binlogå˜åŒ–çš„æ•°æ®,ç„¶åå†å¯¹å…¶è¿›è¡Œè§£æ,å†™å…¥åˆ°kafkaä¸­. æ•°æ®åˆ°äº†kafka,åé¢çš„ç¨‹åºè¦æ€ä¹ˆæ¶ˆè´¹å°±æ€ä¹ˆæ¶ˆè´¹.</p><p>â€‹ åé¢å¾…æ›´æ–°</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>â€‹ ä¸è®ºå»åšä»€ä¹ˆé™Œç”Ÿçš„é¢†åŸŸä¹Ÿå¥½,æˆ‘ä»¬ä¸€å®šè¦æœ‰è‡ªå·±çš„ç†è§£å’Œåˆ†ææŠ€å·§. è¦æœ‰è‡ªå·±çš„éŸ§æ€§å’Œè€å¿ƒ,å»é¢å¯¹åœ¨ä½ ä¸çŸ¥é“çš„é¢†åŸŸä¸Šçš„é—®é¢˜å’Œéš¾ç‚¹.</p><p>â€‹ ä¿æŒå†·é™çš„æ€ç»´,æ˜¯é¢å¯¹æœªçŸ¥çš„åœºæ™¯å’Œéš¾é¢˜.</p><p>â€‹ ä¿æŒå¥½å¥‡å’ŒåšæŒçš„å¿ƒæ€å’Œè¡Œä¸º,å»æŒç»­å­¦ä¹ å’Œæˆé•¿.</p></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://ruy9527.github.io/2021/11/12/data_article/%E6%95%B0%E6%8D%AE%E7%BB%8F%E5%8E%86-%E4%B8%80/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/touxiang.jpg"><meta itemprop="name" content="YangBao"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="YangBao"><meta itemprop="description" content="çŸ¥è¯†ç¬”è®°"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | YangBao"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2021/11/12/data_article/%E6%95%B0%E6%8D%AE%E7%BB%8F%E5%8E%86-%E4%B8%80/" class="post-title-link" itemprop="url">æ•°æ®ç»å†(ä¸€)</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Created: 2021-11-12 13:12:18" itemprop="dateCreated datePublished" datetime="2021-11-12T13:12:18+08:00">2021-11-12</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">Edited on</span> <time title="Modified: 2022-11-04 21:46:13" itemprop="dateModified" datetime="2022-11-04T21:46:13+08:00">2022-11-04</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/" itemprop="url" rel="index"><span itemprop="name">å¤§æ•°æ®</span></a> </span>, <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/%E6%95%B0%E6%8D%AE%E6%88%90%E9%95%BF/" itemprop="url" rel="index"><span itemprop="name">æ•°æ®æˆé•¿</span></a> </span></span><span class="post-meta-break"></span> <span class="post-meta-item" title="Symbols count in article"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">Symbols count in article: </span><span>1.6k</span> </span><span class="post-meta-item" title="Reading time"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">Reading time &asymp;</span> <span>1 mins.</span></span></div></div></header><div class="post-body" itemprop="articleBody"><h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>â€‹ åœ¨å…¬å¸çš„æ•°æ®å¹³å°ä¸Š,è¿›è¡Œä¸€äº›ç®€å•çš„æŒ‡æ ‡å¼€å‘ä¹Ÿæœ‰ä¸€æ®µæ—¶é—´äº†,å¯¹äºæ˜¯å¦æœ‰é¢„æœŸçš„æˆé•¿çš„è¿˜æ˜¯å–å†³äºä¸ªäººçš„æ¬²æœ›ä»¥åŠè¡ŒåŠ¨,ä¸æ’é™¤æˆ‘æ˜¯è¡ŒåŠ¨çš„å·¨å©´.</p><p>â€‹ ä¹Ÿç®€å•çš„è®°å½•ä¸‹è‡ªå·±è¿™æ®µæ—¶é—´çš„ä¸€äº›æ€»ç»“è¯­å½•ä»¥åŠå¦‚æœæˆ‘ä¸‹æ¬¡è¿˜åœ¨æ•°æ®æ–¹é¢çš„é¡¹ç›®ä¸Šæ€ä¹ˆå¤„ç†?</p><h2 id="éœ€æ±‚å’Œè°ƒç ”"><a href="#éœ€æ±‚å’Œè°ƒç ”" class="headerlink" title="éœ€æ±‚å’Œè°ƒç ”"></a>éœ€æ±‚å’Œè°ƒç ”</h2><p>â€‹ ç”±äºç›®å‰çš„é¡¹ç›®éƒ½æ˜¯åœ¨ä¹™æ–¹çš„åœºæ™¯,æ‰€ä»¥éœ€è¦å»ä¸ç”²æ–¹è¿›è¡Œæ²Ÿé€šäº†è§£ä»–ä»¬çš„éœ€æ±‚ä»¥åŠç³»ç»Ÿ,å¹¶ä¸”åŒæ—¶è¿˜è¦å»æ¨åŠ¨ç›¸å…³éœ€æ±‚æŒ‡æ ‡çš„è¿›åº¦ã€‚è¿™é‡Œæ¶‰åŠåˆ°çš„ä¸œè¥¿å…¶å®å¾ˆå¤šã€‚</p><p>â€‹ éœ€æ±‚ä»¥åŠè°ƒç ”: è¿™ä¸ªé˜¶æ®µä¸€å®šè¦å¥½å¥½æ¢³ç†è¯¥å¯¹è¡Œä¸šæˆ–è€…åŒæ ·ç±»ä¼¼çš„ç³»ç»Ÿ,è¿›è¡Œæ¢³ç†ï¼Œæœ€å¥½æ˜¯èƒ½æ˜ç™½ä¸šåŠ¡åœºæ™¯ã€‚ å°±ä¸¾ä¸ªä¾‹å­: è´¢åŠ¡ç³»ç»Ÿ,è¿™æ˜¯ç›®å‰å¤§å…¬å¸éƒ½ä¼šå…·å¤‡çš„å§,é‚£æ¢ä¸ªè§’åº¦å»æ€è€ƒçš„è¯,å¦‚æœæˆ‘åªæ™“å¾—äº†è´¢åŠ¡ç³»ç»Ÿçš„è¯ï¼Œé‚£æˆ‘æ˜¯ä¸æ˜¯åœ¨æ¢³ç†ç›¸å…³åœºæ™¯æˆ–è€…ç›¸å…³æŒ‡æ ‡çš„æƒ…å†µä¸‹ï¼Œæ˜¯ä¸æ˜¯å°±è½»æ¾å¾ˆå¤šäº†å‘¢ï¼Ÿ ç„¶ååœ¨æ•´ç†éœ€æ±‚å’Œè°ƒç ”é˜¶æ®µçš„è¯ï¼Œå¯¹åº”çš„å‘ä»¥åŠå®¢æˆ·çš„ä¸šåŠ¡ç—›ç‚¹å°±ä¼šå¾ˆæ¸…æ™°å’Œæ˜ç™½äº†ã€‚</p><p>â€‹ ä¹Ÿå°±æ˜¯è¯´å¥ç›´ç™½çš„è¯: å¯¹åº”ä¸šåŠ¡åœºæ™¯å’Œéœ€æ±‚ç—›ç‚¹,ä¸è®ºæ˜¯ä¸æ˜¯ç«™åœ¨äº§å“çš„è§’åº¦æˆ–è€…å¼€å‘çš„è§’åº¦è§†è§’ï¼Œä¸€å®šè¦å¯¹å…¶è¿›è¡Œåƒé€ï¼Œè€Œä¸èƒ½æ¨¡ç³ŠäºŒå£ï¼Œç‰¹åˆ«æ˜¯åœ¨è°ƒç ”é˜¶æ®µï¼Œå¦‚æœä½ å­˜åœ¨å¾ˆå¤šä¸šåŠ¡åœºæ™¯ä¸æ˜¯å¾ˆæ¸…æ™°çš„æƒ…å†µ,å°±ä¼šéå¸¸å®¹æ˜“å‡ºç°ä½ åœ¨æ¢³ç†éœ€æ±‚çš„æ—¶å€™,åƒä¸é€ä¸šåŠ¡ç—›ç‚¹,å¯¹åº”å®¢æˆ·éœ€è¦çš„çœŸæ˜¯ä¸œè¥¿å¾ˆéš¾æŠŠæ¡ï¼Œç”šè‡³è¯´ï¼Œä½ å¯èƒ½å°±æŠŠæ¡ä¸ä½ã€‚</p><h2 id="æŒ‡æ ‡æ¢³ç†"><a href="#æŒ‡æ ‡æ¢³ç†" class="headerlink" title="æŒ‡æ ‡æ¢³ç†"></a>æŒ‡æ ‡æ¢³ç†</h2><p>â€‹ æŒ‡æ ‡æ¢³ç†è¿™æ­¥å¾ˆå…³é”®çš„,æ ¹æ®ä½ ç›®å‰çš„éœ€æ±‚ç­‰åœºæ™¯è¿›è¡ŒæŒ‡æ ‡çš„æ¢³ç†,æ¢³ç†å‡ºæ¥çš„ç»“æœå°±æ˜¯ä½ æƒ³è¦çš„æˆ–è€…ä¸šåŠ¡æ–¹æƒ³è¦çš„.</p><p>â€‹ æŒ‡æ ‡æ¢³ç†è¿™ä¸ªæ­¥éª¤ä¸­,æˆ‘ä»¬ä¸€å®šè¦åƒé€æˆ–è€…ç†è§£é€ç›®å‰ä¸šåŠ¡æ–¹æˆ–è€…éœ€è¦æ¢³ç†çš„æŒ‡æ ‡çš„ç³»ç»Ÿé‡Œé¢çš„ä¸€å®šä¸šåŠ¡åœºæ™¯,è¿™ä¼šå…³ç³»åˆ°ä½ æ¥ä¸‹æ¥çš„å–æ•°ä»¥åŠæ•°æ®è¦æ€ä¹ˆèšåˆçš„æ“ä½œå’Œè®¾è®¡è¿™å—.</p><p>â€‹ ç»´åº¦æ¢³ç†: æœ€åŸºæœ¬çš„ç»´åº¦æ¢³ç†,ä¹Ÿå°±æ˜¯ä¸šåŠ¡åœºæ™¯ä¸‹,éœ€è¦æ¢³ç†çš„ç»´åº¦æ˜¯æœ‰é‚£äº›åœºæ™¯çš„. æ¯”å¦‚:æ—¶é—´ç»´åº¦,æ±‡æ€»ç»´åº¦,ç»„ç»‡ç»´åº¦ç­‰.</p><p>â€‹ æ¯ç§ä¸åŒçš„ç»´åº¦,éƒ½ä¼šå¯¹ä½ çš„sqläº§ç”Ÿå¾ˆå¤§çš„å½±å“,æ¯”å¦‚ä½ çš„ç»„ç»‡ç»´åº¦æ˜¯ä¸€å±‚ä¸€å±‚çš„,é‚£ä½ åœ¨ç»„ç»‡ç»´åº¦è¿›è¡Œæ±‡æ€»çš„æ—¶å€™,ä½ æ˜¯ä¸æ˜¯è¿˜è¦è€ƒè™‘åˆ°æ—¶é—´çš„ç»´åº¦? æœˆåˆ°å­£åº¦?æœˆåˆ°å¹´ç­‰è¿™ç§æ—¶é—´ç»´åº¦çš„æ¦‚å¿µæ±‡æ€».</p><p>â€‹ åŸºäºä¸Šé¢,ä¸šåŠ¡éœ€æ±‚+æŒ‡æ ‡çš„æ¢³ç†,è¿™äº›éƒ½æ˜¨å®Œäº†çš„è¯,é‚£å…¶å®ä¸šåŠ¡è°ƒç ”å’ŒæŒ‡æ ‡æ¢³ç†è¦åšçš„äº‹æƒ…,å°±å·²ç»åšå®Œäº†ï¼Œäºæ˜¯å°±å¯ä»¥æ”¾å¼€äº†çš„å»è®¾è®¡æ¥å…¥æ•°æ®æºçš„æ—¶é—´ç»´åº¦ï¼Œsqlè¿›è¡Œæ±‡æ€»çš„é€»è¾‘æ“ä½œ.</p><p>â€‹ å…¶å®,ä½ çš„æŒ‡æ ‡æ¢³ç†åˆ°å¥½çš„è¯,ä½ å¼€å‘åçš„å·¥ä½œä¼šèˆ’æœå¾ˆå¤š</p><p>â€‹ æŒ‡æ ‡æ–‡æ¡£: è¿™é‡Œçš„è°ƒç ”,å¯¹åº”è¦è¾“å‡ºå‡ºæ¥çš„,ä½ æ¯ä¸ªæŒ‡æ ‡å¯¹åº”çš„æ—¶é—´ç»´åº¦æˆ–è€…æ˜¯å…¶ä»–çš„ç»´åº¦,åŒæ—¶ä¹Ÿè¦ä¸€å¹¶è¾“å‡ºå‡ºæ¥çš„æ˜¯:ä¸šåŠ¡å£å¾„å’Œè®¡ç®—å£å¾„</p><h2 id="æ•°æ®æ ¸ç®—-amp-æ•°æ®å­—å…¸è¾“å‡º"><a href="#æ•°æ®æ ¸ç®—-amp-æ•°æ®å­—å…¸è¾“å‡º" class="headerlink" title="æ•°æ®æ ¸ç®— &amp; æ•°æ®å­—å…¸è¾“å‡º"></a>æ•°æ®æ ¸ç®— &amp; æ•°æ®å­—å…¸è¾“å‡º</h2><p>â€‹ å†æ ¹æ®éœ€æ±‚æˆ–è€…ä¸šåŠ¡æ–¹æä¾›äº†ç›¸åº”çš„æŒ‡æ ‡ä¹‹å,é‚£ä¹ˆæˆ‘ä»¬ç´§æ¥ç€è¦å»åšçš„äº‹æƒ…å°±æ˜¯,é€šè¿‡æ•°æ®æºå»æŸ¥çœ‹,å»æŸ¥çœ‹æ•°æ®ä¹‹ç±»çš„ä¸œè¥¿æ˜¯å¦ç¬¦åˆé¢„æœŸã€‚ æ¯”å¦‚è´¢åŠ¡æŒ‡æ ‡: ä¸åŒçš„è®°è´¦ç§‘ç›®ç¼–ç ,é‚£ä½ å°±è¦å»æ¢³ç†ä¸‹æ˜¯å¦æœ‰ç§‘ç›®ç¼–ç è¿™ä¸ªå­—å…¸è¡¨ã€‚</p><p>â€‹ ç„¶åä½ åœ¨æ ¸ç®—æ•°æ®çš„åŒæ—¶ï¼Œè¿˜è¦å»è¾“å‡ºä¸€ä¸ªæ¯”è¾ƒå…³é”®çš„æ–‡æ¡£.</p><p>â€‹ æ•°æ®å­—æ®µæ–‡æ¡£: è¿™ä¸ªæ•°æ®å­—æ®µæ–‡æ¡£çš„è¯,å…¶å®å°±æ˜¯å·²ç»è®¾è®¡åˆ°æ•°ä»“æ–¹é¢çš„æ•°æ®ã€‚</p><p>â€‹ ods &#x2F; dwd &#x2F; dws &#x2F; dim &#x2F; adm</p><p>â€‹ è®¾è®¡åˆ°è¿™äº”å±‚çš„æ•°ä»“å»ºæ¨¡çš„å­—å…¸è¡¨çš„è¾“å‡º,æ¯ä¸€å±‚çš„è¡¨æ€ä¹ˆæ¥å…¥,å…¨é‡è¿˜æ˜¯å¢é‡? è§¦å‘æ—¶é—´æ˜¯ä»€ä¹ˆæ—¶å€™(ä¹Ÿå°±æ˜¯è°ƒåº¦å‘¨æœŸ)ï¼Ÿå¦‚æœæ˜¯å¢é‡çš„è¯,ä¾èµ–çš„å¢é‡å­—æ®µæ˜¯ä»€ä¹ˆï¼Ÿè¿˜æ˜¯åˆ©ç”¨ç±»ä¼¼flink cdcè¿™ç±»çš„æ¡†æ¶æ¥è¿›è¡Œå®æ—¶æ•°æ®çš„æ¥å…¥?</p><p>â€‹ è¿™ä¸ªæ–‡æ¡£è¾“å‡ºå,è¿˜è¦ä¸å®¢æˆ·è¿›è¡Œç¡®è®¤.</p><h2 id="å¼€å‘æ³¨æ„ç‚¹"><a href="#å¼€å‘æ³¨æ„ç‚¹" class="headerlink" title="å¼€å‘æ³¨æ„ç‚¹"></a>å¼€å‘æ³¨æ„ç‚¹</h2><p>â€‹ å…¨é‡: å¦‚æœæ•°æ®æ˜¯å…¨é‡æ¯å¤©æˆ–è€…æ¯æœˆæ‹‰å…¥è¿›æ¥çš„è¯,è¦æ¶‰åŠè€ƒè™‘çš„é—®é¢˜æ˜¯æ•°æ®é‡çš„å¤§å°(é¿å…æ•°æ®é‡å¤ªå¤§å½±å“åˆ°å¯èƒ½åœ¨å‡Œæ™¨è¿è¡Œçš„job).</p><p>â€‹ ä¼ªå¢é‡: æ˜¯å¦æœ‰å¯ä¿¡çš„æ›´æ–°å­—æ®µ,æ¥è¿›è¡Œä¼ªå¢é‡çš„è·å–. æ¯”å¦‚æ›´æ–°æ—¶é—´, æˆ‘æ¯å¤©æˆ–è€…å¤šä¹…çš„æ—¶é—´èŒƒå›´å†…,æˆ‘å°±å»æ›´æ–°æ—¶é—´æ˜¯åœ¨è¿™ä¸ªèŒƒå›´çš„æ•°æ®.</p><p>â€‹ å®æ—¶å¢é‡: ç±»ä¼¼flick cdc æˆ–è€… canclå»ç›‘å¬mysqlçš„binlogè¿™æ ·çš„åŠŸèƒ½æ¥å®ç°å®æ—¶å¢é‡çš„åŠŸèƒ½.</p><h2 id="å¼€å‘è§„èŒƒ"><a href="#å¼€å‘è§„èŒƒ" class="headerlink" title="å¼€å‘è§„èŒƒ"></a>å¼€å‘è§„èŒƒ</h2><p>â€‹ è¿™ä¸ªåœ°æ–¹å…¶å®å¯¹åº”çš„å°±æ˜¯æ— è§„çŸ©ä¸æ–¹åœ†, ä¹Ÿå°±æ˜¯å¼€å‘ä¹‹å‰è¦å®šä¹‰å¥½è§„çŸ©,è¿™æ ·ä¸ä»…ä»…å¯¹ç¨‹åºå¾ˆæœ‰ç›Š,å¯¹åé¢æ¥çš„åŒäº‹æˆ–è€…éšæ—¶çœ‹ä½ ç¨‹åºçš„æ¶‰åŠç­‰æ–¹æ¡ˆçš„æ—¶å€™,ä¹Ÿæ˜¯ä¸€ç›®äº†ç„¶çš„.</p></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://ruy9527.github.io/2021/11/04/mybatis/mybatis%E4%B8%8Espringboot%E6%95%B4%E5%90%88%E9%98%85%E8%AF%BB/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/touxiang.jpg"><meta itemprop="name" content="YangBao"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="YangBao"><meta itemprop="description" content="çŸ¥è¯†ç¬”è®°"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | YangBao"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2021/11/04/mybatis/mybatis%E4%B8%8Espringboot%E6%95%B4%E5%90%88%E9%98%85%E8%AF%BB/" class="post-title-link" itemprop="url">mybatisä¸springbootæ•´åˆé˜…è¯»</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Created: 2021-11-04 00:29:43" itemprop="dateCreated datePublished" datetime="2021-11-04T00:29:43+08:00">2021-11-04</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">Edited on</span> <time title="Modified: 2022-11-04 21:46:13" itemprop="dateModified" datetime="2022-11-04T21:46:13+08:00">2022-11-04</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/java%E6%A1%86%E6%9E%B6/" itemprop="url" rel="index"><span itemprop="name">javaæ¡†æ¶</span></a> </span>, <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/java%E6%A1%86%E6%9E%B6/mybatis/" itemprop="url" rel="index"><span itemprop="name">mybatis</span></a> </span></span><span class="post-meta-break"></span> <span class="post-meta-item" title="Symbols count in article"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">Symbols count in article: </span><span>15k</span> </span><span class="post-meta-item" title="Reading time"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">Reading time &asymp;</span> <span>14 mins.</span></span></div></div></header><div class="post-body" itemprop="articleBody"><h4 id="å‰æ"><a href="#å‰æ" class="headerlink" title="å‰æ"></a>å‰æ</h4><p>MyBatis ä¸ SpringBoot æ•´åˆæ“ä½œ. åœ¨è¿™æ¬¡æ•´åˆçš„è¿‡ç¨‹ä¸­,å†æ¬¡æ˜ç™½è‡ªå·±æ¯«æ— ç–‘é—®çš„æ˜¯ä¸€ä¸ªæ¯”è¾ƒæ‰‹æ®‹çš„åŒå­¦äº†.</p><p>è¿™é‡Œæˆ‘ä»¬æ˜¯åŸºäº sql è¯­å¥å†™åœ¨ xml é‡Œé¢è¿›è¡Œæ•´åˆçš„æ“ä½œ.</p><h4 id="å…¥é—¨"><a href="#å…¥é—¨" class="headerlink" title="å…¥é—¨"></a>å…¥é—¨</h4><p>è¿™é‡Œè¯´ä¸‹åˆ›å»ºä¸€ä¸ª å…¥é—¨ é¡¹ç›®çš„å¤§è‡´æµç¨‹.</p><p>å…ˆåˆ›å»ºä¸€ä¸ª SpringBoot é¡¹ç›® , å¼•å…¥ä¾èµ– : <a target="_blank" rel="noopener" href="https://github.com/baoyang23/mybtatis-analysis/blob/master/mybatis-spring-boot-hello/pom.xml">https://github.com/baoyang23/mybtatis-analysis/blob/master/mybatis-spring-boot-hello/pom.xml</a></p><p>åˆ›å»º MyBatis çš„é…ç½®æ–‡ä»¶ä¿¡æ¯ : <a target="_blank" rel="noopener" href="https://github.com/baoyang23/mybtatis-analysis/blob/master/mybatis-spring-boot-hello/src/main/resources/mybatis-config.xml">https://github.com/baoyang23/mybtatis-analysis/blob/master/mybatis-spring-boot-hello/src/main/resources/mybatis-config.xml</a></p><p>åˆ›å»ºæŸ¥è¯¢çš„ sql è¯­å¥ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„ mapper æ–‡ä»¶ : <a target="_blank" rel="noopener" href="https://github.com/baoyang23/mybtatis-analysis/tree/master/mybatis-spring-boot-hello/src/main/resources/mapper">https://github.com/baoyang23/mybtatis-analysis/tree/master/mybatis-spring-boot-hello/src/main/resources/mapper</a></p><p>application.properties : <a target="_blank" rel="noopener" href="https://github.com/baoyang23/mybtatis-analysis/blob/master/mybatis-spring-boot-hello/src/main/resources/application.properties">https://github.com/baoyang23/mybtatis-analysis/blob/master/mybatis-spring-boot-hello/src/main/resources/application.properties</a></p><p>æ‰«æ mapper æ¥å£ : @MapperScan(basePackages &#x3D; {â€œcom.iyang.mybatis.springboot.hello.mapperâ€}) <a target="_blank" rel="noopener" href="https://github.com/baoyang23/mybtatis-analysis/blob/master/mybatis-spring-boot-hello/src/main/java/com/iyang/mybatis/springboot/hello/MybatisSpringBootHelloApplication.java">https://github.com/baoyang23/mybtatis-analysis/blob/master/mybatis-spring-boot-hello/src/main/java/com/iyang/mybatis/springboot/hello/MybatisSpringBootHelloApplication.java</a></p><p>è¿™é‡Œæ˜¯æ²¡æœ‰å¼•å…¥ web ä¾èµ–çš„ , ç›´æ¥å¯åŠ¨ main æ–¹æ³• , ç„¶åå°±å¯ä»¥çœ‹åˆ°æˆ‘ä»¬æŸ¥è¯¢å‡ºæ¥çš„ç»“æœäº†.</p><p>å¦‚æœä½ ç†Ÿæ‚‰ SpringBoot æºç çš„è¯ï¼Œå°±ä¼šæ™“å¾—æœ‰ä¸€ä¸ªè‡ªåŠ¨è£…é…çš„æ“ä½œ.</p><p>å¦‚æœä¸ç†Ÿæ‚‰çš„è¯ï¼Œé‚£ä¹ˆå°±åªèƒ½é€šè¿‡ @MapperScan(basePackages &#x3D; {â€œcom.iyang.mybatis.springboot.hello.mapperâ€}) å»çœ‹ , è¿™æ ·æœ‰äº›æ˜¯ä¾èµ–è‡ªåŠ¨è£…é…ï¼ˆspring.factoriesï¼‰ ä¸­çš„é…ç½®åŠ è½½çš„, æ‰€ä»¥è¿™é‡Œå»ºè®®åœ¨çœ‹ä¹‹å‰ï¼Œå¦‚æœæ˜¯æœ‰ä¸€ç‚¹ SpringBoot æ‰©å±•çš„çŸ¥è¯†äº†è§£æ˜¯å¾ˆå¥½çš„ã€‚å¦‚æœæ²¡æœ‰æ€ä¹ˆåŠå‘¢ï¼Ÿæ²¡æœ‰å°±æ¥çœ‹æˆ‘æ¥ä¸‹æ¥çš„å†…å®¹ã€‚</p><p>å…¶å®è¿™ä¸ªåœ°æ–¹ä½ ä»”ç»†æƒ³ä¸‹ï¼Œåœ¨ MyBatis ä¸ Spring æ•´åˆçš„æ—¶å€™ï¼Œé€šè¿‡ xml çš„æ–¹å¼ç»™ MyBatis çš„bean å·²ç» mybatis-spring ä¸­è‡ªå·±å†™çš„æ‰«æç±»ï¼Œæœ€åå°†æ‰«æå‡ºæ¥çš„ bd åœ¨è¿˜æ²¡åˆå§‹åŒ–ä¹‹å‰ï¼Œå°†bd çš„beanClass æ›¿æ¢ä¸ºæˆ‘ä»¬çš„ä»£ç†ç±».</p><p>é‚£ä¹ˆï¼ŒSpringBoot ä¸ MyBatis æ•´åˆçš„æ—¶å€™ï¼Œæœ€åè¦åšçš„äº‹æƒ…æ˜¯ä¸æ˜¯ä¹Ÿæ˜¯å°† MyBatis çš„ä¿¡æ¯æ³¨å…¥åˆ° SpringBoot æ¥å‘¢ï¼Ÿåªä¸è¿‡ï¼ŒSpringBoot å°±ä¸åƒ Spring ä¸€æ ·äº†ï¼Œè¿˜å°† bean çš„ä¿¡æ¯é…ç½®åˆ° xml æ–‡ä»¶ä¸­.</p><p>äºæ˜¯ï¼Œæ¥ä¸‹æ¥è·Ÿæˆ‘çš„é˜…è¯»&amp;åˆ†ææ¥ä¸€æ­¥ä¸€æ­¥çš„å¾€ä¸‹çœ‹.</p><h4 id="æ–¹æ³•åˆ†æ"><a href="#æ–¹æ³•åˆ†æ" class="headerlink" title="æ–¹æ³•åˆ†æ"></a>æ–¹æ³•åˆ†æ</h4><p><strong>å…³æ³¨ç‚¹ä¸€</strong> : è¿™é‡Œæˆ‘ä»¬ç‚¹å…¥åˆ° org.mybatis.spring.annotation.MapperScan æ³¨è§£é‡Œé¢æ¥ï¼Œå¯ä»¥çœ‹åˆ°æœ‰ä¸€ä¸ª @Import(MapperScannerRegistrar.class) , äºæ˜¯æˆ‘ä»¬é¡ºæ‰‹è·Ÿè¿›æ¥ : org.mybatis.spring.annotation.MapperScannerRegistrar , ä»åå­—ä¸Šæ¥ï¼Œè¿™ä¸ªç±»å°±åšäº†ä¸€ä¸ªæ‰«æmapperå¹¶ä¸”å°†mapperæ³¨å…¥åˆ°Springå®¹å™¨ä¸­æ¥çš„äº‹æƒ….</p><p><strong>å…³æ³¨ç‚¹äºŒ</strong> : æˆ‘ä»¬ä»å¼•å…¥è¿›æ¥çš„ä¾èµ–æ¥çœ‹, mybatis-spring-boot-starter-2.1.2.jar è·Ÿè¿›åˆ° è¿™ä¸ªåŒ…æ¥ï¼Œå¯ä»¥çœ‹åˆ°è¿™ä¸ªåŒ…ä¹Ÿæ˜¯å¼•å…¥ä¸€äº›è¿›æ¥. mybatis&#x2F;mybatis-spring&#x2F;spring-boot-starter-jdbc è¿™ä¸‰ä¸ªä¾èµ–æˆ‘ä»¬åº”è¯¥ä¸æ˜¯å¾ˆé™Œç”Ÿçš„ï¼Œmybatis-spring-boot-autoconfigureä¸»è¦æ¥çœ‹è¿™ä¸ªã€‚ spring.factories çš„ä½œç”¨å¤§å®¶å¯ä»¥å»äº†è§£ä¸‹ï¼ŒSpringBootå¾ˆå¤š EnableAutoConfiguration çš„é…ç½®éƒ½æ˜¯æ”¾å…¥åœ¨è¿™ä¸ªé‡Œé¢çš„ï¼Œåœ¨å¯åŠ¨çš„æ—¶å€™ï¼Œä¼šå»ä¸€å±‚ä¸€å±‚çš„å»è¯»å– spring.factories æ–‡ä»¶çš„å†…å®¹ã€‚ è¿™é‡Œæˆ‘ä»¬ä¸»è¦æ¥çœ‹ : org.mybatis.spring.boot.autoconfigure.MybatisAutoConfiguration è¿™ä¸ªç±»çš†å¯.</p><p>MyBatis åœ¨ properties ä¸­çš„é…ç½®æ–‡ä»¶è¯»å– : org.mybatis.spring.boot.autoconfigure.MybatisProperties</p><p>å¯ä»¥çœ‹åˆ°è¯¥ç±»ä¸Šæ˜¯æœ‰: @ConfigurationProperties(prefix &#x3D; MybatisProperties.MYBATIS_PREFIX)</p><p>äºæ˜¯æˆ‘ä»¬ä¸€ä¸‹å­å°±å¤šäº†äºŒä¸ªå…³æ³¨ç‚¹, è¿™é‡Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨ä¹‹å‰çš„ ç¬¨æ–¹æ³•ï¼Œ å½“ä½ å¯¹æ•´åˆæµç¨‹æ‰§è¡Œä¸æ˜¯å¾ˆç†Ÿæ‚‰çš„è¯ï¼Œå¯ä»¥åœ¨è¿™äºŒä¸ªå…³æ³¨ç‚¹çš„é‡å†™æ–¹æ³•ä¸Šéƒ½æ‰“ç®—æ–­ç‚¹ï¼Œçœ‹ä¸‹å…¶æ‰§è¡Œé¡ºåºæ˜¯æ€ä¹ˆæ‰§è¡Œçš„. å¼„æ¸…æ¥šäº†æ‰§è¡Œæµç¨‹,å°±å¯ä»¥è·Ÿç€æµç¨‹æ¥ä¸€æ­¥ä¸€æ­¥çš„åˆ†æ. ä»æˆ‘ä»¬æ‰“ä¸Š debug å¼€å§‹ï¼Œå¾€ä¸‹çš„æ‰§è¡Œæµç¨‹å°±æ˜¯ä¸€æ­¥ä¸€æ­¥æ¥çš„ï¼Œé‚£ä¹ˆå°±è·Ÿç€æˆ‘ä»¬debug çš„æ–¹æ³•æ¥ä¸€æ­¥ä¸€æ­¥çš„åˆ†æ.</p><p>org.mybatis.spring.annotation.MapperScannerRegistrar#registerBeanDefinitions() â€”&gt; org.mybatis.spring.boot.autoconfigure.MybatisAutoConfiguration#MybatisAutoConfiguration â€”&gt; org.mybatis.spring.boot.autoconfigure.MybatisAutoConfiguration#afterPropertiesSet â€”-&gt; org.mybatis.spring.boot.autoconfigure.MybatisAutoConfiguration#sqlSessionFactory â€”&gt; org.mybatis.spring.boot.autoconfigure.MybatisAutoConfiguration#sqlSessionTemplate() â€”-&gt;</p><p><strong>org.mybatis.spring.annotation.MapperScannerRegistrar#registerBeanDefinitions() æ–¹æ³•</strong> :</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * &#123;@inheritDoc&#125;</span><br><span class="line"> */</span><br><span class="line">@Override</span><br><span class="line">public void registerBeanDefinitions(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry) &#123;</span><br><span class="line">/***</span><br><span class="line">*  è¿™é‡Œæ˜¯è·å–å‡ºäº†æ³¨è§£é‡Œé¢å±æ€§çš„å€¼. </span><br><span class="line">*/   </span><br><span class="line">  AnnotationAttributes mapperScanAttrs = </span><br><span class="line">  AnnotationAttributes.fromMap(importingClassMetadata.getAnnotationAttributes(MapperScan.class.getName()));</span><br><span class="line"></span><br><span class="line">// èƒ½è·å–åˆ°æœ‰æ³¨è§£,ä¸æ˜¯null,å°±ä¼šèµ°åˆ°ä¸‹é¢çš„ä»£ç ä¸­æ¥.    </span><br><span class="line">  if (mapperScanAttrs != null) &#123;</span><br><span class="line">    registerBeanDefinitions(importingClassMetadata, mapperScanAttrs, registry,</span><br><span class="line">        generateBaseBeanName(importingClassMetadata, 0));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line">* </span><br><span class="line">*/</span><br><span class="line">  void registerBeanDefinitions(AnnotationMetadata annoMeta, AnnotationAttributes annoAttrs,</span><br><span class="line">      BeanDefinitionRegistry registry, String beanName) &#123;</span><br><span class="line"></span><br><span class="line">// åˆ©ç”¨ BeanDefinitionBuilder æ„é€ è€…,ä¼ å…¥äº†ä¸€ä¸ª MapperScannerConfigurer.class</span><br><span class="line">// è¿™é‡Œçš„ builderé‡Œé¢æ˜¯æœ‰ä¸€ä¸ª bd çš„,é‡Œé¢çš„beanClasså°±æ˜¯ MapperScannerConfigurer      </span><br><span class="line">    BeanDefinitionBuilder builder = BeanDefinitionBuilder.genericBeanDefinition(MapperScannerConfigurer.class);</span><br><span class="line">    builder.addPropertyValue(&quot;processPropertyPlaceHolders&quot;, true);</span><br><span class="line"></span><br><span class="line">// è¿™é‡Œè·å– @MapperScan æ³¨è§£çš„å±æ€§, å¦‚æœå±æ€§æ˜¯æœ‰å€¼çš„è¯,å°±ä¼šè®¾ç½®åˆ° builder ä¸­æ¥. </span><br><span class="line">    Class&lt;? extends Annotation&gt; annotationClass = annoAttrs.getClass(&quot;annotationClass&quot;);</span><br><span class="line">    if (!Annotation.class.equals(annotationClass)) &#123;</span><br><span class="line">      builder.addPropertyValue(&quot;annotationClass&quot;, annotationClass);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Class&lt;?&gt; markerInterface = annoAttrs.getClass(&quot;markerInterface&quot;);</span><br><span class="line">    if (!Class.class.equals(markerInterface)) &#123;</span><br><span class="line">      builder.addPropertyValue(&quot;markerInterface&quot;, markerInterface);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Class&lt;? extends BeanNameGenerator&gt; generatorClass = annoAttrs.getClass(&quot;nameGenerator&quot;);</span><br><span class="line">    if (!BeanNameGenerator.class.equals(generatorClass)) &#123;</span><br><span class="line">      builder.addPropertyValue(&quot;nameGenerator&quot;, BeanUtils.instantiateClass(generatorClass));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Class&lt;? extends MapperFactoryBean&gt; mapperFactoryBeanClass = annoAttrs.getClass(&quot;factoryBean&quot;);</span><br><span class="line">    if (!MapperFactoryBean.class.equals(mapperFactoryBeanClass)) &#123;</span><br><span class="line">      builder.addPropertyValue(&quot;mapperFactoryBeanClass&quot;, mapperFactoryBeanClass);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String sqlSessionTemplateRef = annoAttrs.getString(&quot;sqlSessionTemplateRef&quot;);</span><br><span class="line">    if (StringUtils.hasText(sqlSessionTemplateRef)) &#123;</span><br><span class="line">      builder.addPropertyValue(&quot;sqlSessionTemplateBeanName&quot;, annoAttrs.getString(&quot;sqlSessionTemplateRef&quot;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String sqlSessionFactoryRef = annoAttrs.getString(&quot;sqlSessionFactoryRef&quot;);</span><br><span class="line">    if (StringUtils.hasText(sqlSessionFactoryRef)) &#123;</span><br><span class="line">      builder.addPropertyValue(&quot;sqlSessionFactoryBeanName&quot;, annoAttrs.getString(&quot;sqlSessionFactoryRef&quot;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// ä¸‹é¢æ˜¯æ ¹æ® value/basePackages/basePackageClasses æ¥è·å–åŒ…çš„ä¿¡æ¯,</span><br><span class="line">// è¿™é‡Œä¹Ÿå°±è¯´, æˆ‘ä»¬å¯ä»¥è·Ÿç€è¿™ä¸‰ä¸ªå±æ€§æ¥é…ç½®åŒ…ä¿¡æ¯.      </span><br><span class="line">    List&lt;String&gt; basePackages = new ArrayList&lt;&gt;();</span><br><span class="line">    basePackages.addAll(</span><br><span class="line">        Arrays.stream(annoAttrs.getStringArray(&quot;value&quot;)).filter(StringUtils::hasText).collect(Collectors.toList()));</span><br><span class="line"></span><br><span class="line">    basePackages.addAll(Arrays.stream(annoAttrs.getStringArray(&quot;basePackages&quot;)).filter(StringUtils::hasText)</span><br><span class="line">        .collect(Collectors.toList()));</span><br><span class="line"></span><br><span class="line">    basePackages.addAll(Arrays.stream(annoAttrs.getClassArray(&quot;basePackageClasses&quot;)).map(ClassUtils::getPackageName)</span><br><span class="line">        .collect(Collectors.toList()));</span><br><span class="line"></span><br><span class="line">// å¦‚æœæ²¡æœ‰è·å–åˆ°åŒ…çš„ä¿¡æ¯,é‚£å°±æ ¹æ®æ³¨è§£æ‰€åœ¨çš„è·¯å¾„æ¥è·å–é»˜è®¤çš„è·¯å¾„.      </span><br><span class="line">    if (basePackages.isEmpty()) &#123;</span><br><span class="line">      basePackages.add(getDefaultBasePackage(annoMeta));</span><br><span class="line">    &#125;</span><br><span class="line">// å¦‚æœæœ‰lazyInitializationå±æ€§çš„å€¼,å°±è®¾ç½®åˆ° builder ä¸­æ¥. </span><br><span class="line">    String lazyInitialization = annoAttrs.getString(&quot;lazyInitialization&quot;);</span><br><span class="line">    if (StringUtils.hasText(lazyInitialization)) &#123;</span><br><span class="line">      builder.addPropertyValue(&quot;lazyInitialization&quot;, lazyInitialization);</span><br><span class="line">    &#125;</span><br><span class="line">// æ·»åŠ åŒ…çš„å±æ€§</span><br><span class="line">    builder.addPropertyValue(&quot;basePackage&quot;, StringUtils.collectionToCommaDelimitedString(basePackages));</span><br><span class="line"></span><br><span class="line">//  getBeanDefinition() åœ¨è¿”å› bd ä¹‹å‰ï¼Œä¼šèµ°ä¸€ä¸ª validate æ–¹æ³•.</span><br><span class="line">// org.springframework.beans.factory.support.DefaultListableBeanFactory#registerBeanDefinition</span><br><span class="line">// èµ°è¿™ä¸ªæ–¹æ³•æ¥å°† bd ç»™æ³¨å…¥åˆ° Spring å®¹å™¨ä¸­æ¥.</span><br><span class="line">// è¿™é‡Œæ³¨å…¥è¿›å»çš„ beanName çš„å€¼æ˜¯ :  com.iyang.mybatis.springboot.hello.MybatisSpringBootHelloApplication#MapperScannerRegistrar#0</span><br><span class="line">// æ³¨å…¥è¿›å»çš„ bd çš„ beanClass : class org.mybatis.spring.mapper.MapperScannerConfigurer </span><br><span class="line">    registry.registerBeanDefinition(beanName, builder.getBeanDefinition());</span><br><span class="line"></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p><strong>è¿™é‡Œå¯ä»¥æ€»ç»“ä¸‹ registerBeanDefinitions æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å°±æ˜¯å°† @MapperScan çš„æ³¨è§£å±æ€§çš„å€¼ç»™åˆ° : BeanDefinitionBuilder builder, è¯¥builder é‡Œé¢æœ‰bd,bdçš„beanClassæ˜¯MapperScannerConfigurerï¼Œæœ€åå°†MapperScannerConfigureræ³¨å…¥åˆ° Spring å®¹å™¨ä¸­æ¥.</strong></p><hr><p><strong>MyBatisAutoConfiguration() æœ‰å‚æ„é€ å‡½æ•°</strong></p><p>è¿™é‡Œæˆ‘ä»¬åœ¨ MybatisAutoConfiguration æ„é€ å‡½æ•°ä¸Šæ‰“ä¸Šæ–­ç‚¹, å¯ä»¥æ ¹æ® æ–­ç‚¹æ¥åˆ†æï¼Œèµ°å®ŒğŸ‘†é¢çš„æ–¹æ³•ï¼Œç„¶åæˆ‘ä»¬ç‚¹å‡»èµ°åˆ°ä¸‹ä¸€ä¸ªæ–­ç‚¹æ¥ï¼Œå°±ä¼šèµ°åˆ° è¿™ä¸ª æœ‰å‚æ„é€ å‡½æ•°.</p><p>å¦‚æœå¥½å¥‡çš„è¯ï¼Œå¯ä»¥è·Ÿè¸ªdebug çš„å †æ ˆä¿¡æ¯ï¼Œæ˜¯æ€ä¹ˆèµ°åˆ°è¿™æ­¥æ¥çš„. èµ°åˆ°è¿™ä¸ªæ–¹æ³•æ¥ : finishBeanFactoryInitialization(beanFactory) è¿™æ˜¯æœ€åˆçš„å…¥å£.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public MybatisAutoConfiguration(MybatisProperties properties, ObjectProvider&lt;Interceptor[]&gt; interceptorsProvider,</span><br><span class="line">    ObjectProvider&lt;TypeHandler[]&gt; typeHandlersProvider, ObjectProvider&lt;LanguageDriver[]&gt; languageDriversProvider,</span><br><span class="line">    ResourceLoader resourceLoader, ObjectProvider&lt;DatabaseIdProvider&gt; databaseIdProvider,</span><br><span class="line">    ObjectProvider&lt;List&lt;ConfigurationCustomizer&gt;&gt; configurationCustomizersProvider) &#123;</span><br><span class="line">// è¿™é‡Œéƒ½æ˜¯èµ‹å€¼    </span><br><span class="line">  this.properties = properties;</span><br><span class="line">  this.interceptors = interceptorsProvider.getIfAvailable();</span><br><span class="line">  this.typeHandlers = typeHandlersProvider.getIfAvailable();</span><br><span class="line">  this.languageDrivers = languageDriversProvider.getIfAvailable();</span><br><span class="line">  this.resourceLoader = resourceLoader;</span><br><span class="line">  this.databaseIdProvider = databaseIdProvider.getIfAvailable();</span><br><span class="line">  this.configurationCustomizers = configurationCustomizersProvider.getIfAvailable();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>org.mybatis.spring.boot.autoconfigure.MybatisAutoConfiguration#afterPropertiesSet()æ–¹æ³•</strong></p><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°æ˜¯å¯¹é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨è¿›è¡Œæ£€éªŒ.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void afterPropertiesSet() &#123;</span><br><span class="line">  checkConfigFileExists();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// æ£€éªŒé…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨</span><br><span class="line">  private void checkConfigFileExists() &#123;</span><br><span class="line">    if (this.properties.isCheckConfigLocation() &amp;&amp; StringUtils.hasText(this.properties.getConfigLocation())) &#123;</span><br><span class="line">      Resource resource = this.resourceLoader.getResource(this.properties.getConfigLocation());</span><br><span class="line">      Assert.state(resource.exists(),</span><br><span class="line">          &quot;Cannot find config location: &quot; + resource + &quot; (please add config file or check your Mybatis configuration)&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p><strong>org.mybatis.spring.boot.autoconfigure.MybatisAutoConfiguration#sqlSessionFactory æ–¹æ³•</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">// è¿™é‡Œè¯´ä¸‹ @ConditionalOnMissingBean çš„ä½œç”¨,å½“beanä¸å­˜åœ¨çš„æ—¶å€™ï¼Œåˆ™å®ä¾‹åŒ–è¿™ä¸ªbean.</span><br><span class="line">// è¿™é‡Œä¼šä¼ å…¥ dataSource è¿›æ¥.</span><br><span class="line">@Bean</span><br><span class="line">@ConditionalOnMissingBean</span><br><span class="line">public SqlSessionFactory sqlSessionFactory(DataSource dataSource) throws Exception &#123;</span><br><span class="line">// åˆ›å»º sqlSessionBean å¯¹è±¡.    </span><br><span class="line">  SqlSessionFactoryBean factory = new SqlSessionFactoryBean();</span><br><span class="line">// è®¾ç½® dataSource &amp; SpringBootVFS.class      </span><br><span class="line">  factory.setDataSource(dataSource);</span><br><span class="line">  factory.setVfs(SpringBootVFS.class);</span><br><span class="line">// è·å–åˆ° MyBatis çš„é…ç½®æ–‡ä»¶å±æ€§,å¦‚æœæœ‰çš„è¯,å°±ä¼šè®¾ç½®åˆ° configLocationå±æ€§æ¥.    </span><br><span class="line">  if (StringUtils.hasText(this.properties.getConfigLocation())) &#123;</span><br><span class="line">    factory.setConfigLocation(this.resourceLoader.getResource(this.properties.getConfigLocation()));</span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line">// è¿™é‡Œä» properties ä¸­è·å– configuration,æ²¡æœ‰å€¼å°±ä¼šæ˜¯null.    </span><br><span class="line">  applyConfiguration(factory);</span><br><span class="line">  if (this.properties.getConfigurationProperties() != null) &#123;</span><br><span class="line">    factory.setConfigurationProperties(this.properties.getConfigurationProperties());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">// å¦‚æœæœ‰æ’ä»¶,å°±ä¼šè®¾ç½®æ’ä»¶.    </span><br><span class="line">  if (!ObjectUtils.isEmpty(this.interceptors)) &#123;</span><br><span class="line">    factory.setPlugins(this.interceptors);</span><br><span class="line">  &#125;</span><br><span class="line">  if (this.databaseIdProvider != null) &#123;</span><br><span class="line">    factory.setDatabaseIdProvider(this.databaseIdProvider);</span><br><span class="line">  &#125;</span><br><span class="line">// åŒ…çš„ååˆ«è®¾ç½®    </span><br><span class="line">  if (StringUtils.hasLength(this.properties.getTypeAliasesPackage())) &#123;</span><br><span class="line">    factory.setTypeAliasesPackage(this.properties.getTypeAliasesPackage());</span><br><span class="line">  &#125;</span><br><span class="line">  if (this.properties.getTypeAliasesSuperType() != null) &#123;</span><br><span class="line">    factory.setTypeAliasesSuperType(this.properties.getTypeAliasesSuperType());</span><br><span class="line">  &#125;</span><br><span class="line">  if (StringUtils.hasLength(this.properties.getTypeHandlersPackage())) &#123;</span><br><span class="line">    factory.setTypeHandlersPackage(this.properties.getTypeHandlersPackage());</span><br><span class="line">  &#125;</span><br><span class="line">  if (!ObjectUtils.isEmpty(this.typeHandlers)) &#123;</span><br><span class="line">    factory.setTypeHandlers(this.typeHandlers);</span><br><span class="line">  &#125;</span><br><span class="line">  if (!ObjectUtils.isEmpty(this.properties.resolveMapperLocations())) &#123;</span><br><span class="line">    factory.setMapperLocations(this.properties.resolveMapperLocations());</span><br><span class="line">  &#125;</span><br><span class="line">// è¿™é‡Œéƒ½æ˜¯é…ç½®å±æ€§çš„è®¾ç½®.    </span><br><span class="line"></span><br><span class="line">// è·å– propert å­—æ®µå±æ€§çš„åå­—.    </span><br><span class="line">  Set&lt;String&gt; factoryPropertyNames = Stream</span><br><span class="line">      .of(new BeanWrapperImpl(SqlSessionFactoryBean.class).getPropertyDescriptors()).map(PropertyDescriptor::getName)</span><br><span class="line">      .collect(Collectors.toSet());</span><br><span class="line">  Class&lt;? extends LanguageDriver&gt; defaultLanguageDriver = this.properties.getDefaultScriptingLanguageDriver();</span><br><span class="line">  if (factoryPropertyNames.contains(&quot;scriptingLanguageDrivers&quot;) &amp;&amp; !ObjectUtils.isEmpty(this.languageDrivers)) &#123;</span><br><span class="line">    // Need to mybatis-spring 2.0.2+</span><br><span class="line">    factory.setScriptingLanguageDrivers(this.languageDrivers);</span><br><span class="line">    if (defaultLanguageDriver == null &amp;&amp; this.languageDrivers.length == 1) &#123;</span><br><span class="line">      defaultLanguageDriver = this.languageDrivers[0].getClass();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">// è®¾ç½®é»˜è®¤çš„è„šæœ¬è¯­è¨€è§£æå™¨. è¿™é‡Œæ²¡æœ‰,è®¾ç½®çš„æ˜¯é»˜è®¤çš„null.    </span><br><span class="line">  if (factoryPropertyNames.contains(&quot;defaultScriptingLanguageDriver&quot;)) &#123;</span><br><span class="line">    // Need to mybatis-spring 2.0.2+</span><br><span class="line">    factory.setDefaultScriptingLanguageDriver(defaultLanguageDriver);</span><br><span class="line">  &#125;</span><br><span class="line">// org.mybatis.spring.SqlSessionFactoryBean#getObject,è¿™é‡Œèµ°åˆ°äº† SqlSessionBean.</span><br><span class="line">// è¿™ä¸ªSqlSessionFactoryBeanæ˜¯åœ¨æœ‰ä¹‹å‰ mybatiså’ŒSpring æ•´åˆåˆ†ææœ‰æè¿‡åˆ°çš„,å¯ä»¥å‚è€ƒgetObjectæ–¹æ³•: https://github.com/baoyang23/mybtatis-analysis/tree/master/mybatis-spring-hello    </span><br><span class="line">// è¿™é‡Œä¼šèµ° org.mybatis.spring.SqlSessionFactoryBean#getObject çš„ afterPropertiesSet æ–¹æ³•æ¥åˆ›å»ºä¸€ä¸ª SqlSessionFactory , è¿™é‡Œè¿”å›çš„ SqlSessionFactory å°±æ³¨å…¥åˆ° Spring å®¹å™¨ä¸­æ¥.    </span><br><span class="line">  return factory.getObject();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ‰€ä»¥è¿™ä¸ªæ–¹æ³• ï¼š å…ˆæ˜¯newäº†ä¸€ä¸ªSqlSessionFactoryBeanå¯¹è±¡ï¼Œå¦‚æœä½ ä»”ç»†çœ‹çš„è¯ï¼Œä½ ä¼šå‘ç°è¿™ä¸ªå¯¹è±¡åœ¨ä¹‹å‰ mybatis-spring æ•´åˆçš„æ—¶å€™ï¼Œæˆ‘ä»¬é€šè¿‡ xml é…ç½®æ–‡ä»¶é…ç½®è¿›æ¥çš„ï¼Œå¹¶ä¸”åŒæ—¶é€šè¿‡æ ‡ç­¾ç»™èµ‹å€¼äº†datasourceç­‰ä¿¡æ¯ï¼Œ è€Œè¿™é‡Œæ˜¯é€šè¿‡ä»£ç ï¼Œifç­‰åˆ¤æ–­ï¼Œæ¥å¯¹ SqlSessionFactoryBean çš„å±æ€§è¿›è¡Œsetå€¼çš„. æœ€åä¹Ÿæ˜¯åˆ›å»ºå‡ºä¸€ä¸ª SqlSessionFactory ç»™æ³¨å…¥åˆ° Spring å®¹å™¨ä¸­æ¥.</strong></p><hr><p><strong>org.mybatis.spring.boot.autoconfigure.MybatisAutoConfiguration#sqlSessionTemplate æ–¹æ³•</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">@Bean</span><br><span class="line">@ConditionalOnMissingBean</span><br><span class="line">public SqlSessionTemplate sqlSessionTemplate(SqlSessionFactory sqlSessionFactory) &#123;</span><br><span class="line">// è¿™é‡Œæ ¹æ® executorType æ˜¯å¦æœ‰å€¼æ¥åˆ¤æ–­è¦èµ°çš„æ„é€ å‡½æ•°æ–¹æ³•.    </span><br><span class="line">  ExecutorType executorType = this.properties.getExecutorType();</span><br><span class="line">  if (executorType != null) &#123;</span><br><span class="line">    return new SqlSessionTemplate(sqlSessionFactory, executorType);</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">// è¿™é‡Œé»˜è®¤çš„è·å–æ˜¯ SIMPLE è¿™ä¸ª ExecutorType.      </span><br><span class="line">    return new SqlSessionTemplate(sqlSessionFactory);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// org.mybatis.spring.SqlSessionTemplate#SqlSessionTemplate(org.apache.ibatis.session.SqlSessionFactory, org.apache.ibatis.session.ExecutorType, org.springframework.dao.support.PersistenceExceptionTranslator),æœ€åå¯ä»¥è·Ÿè¿›åˆ°è¿™ä¸ªæ–¹æ³•ä¸­æ¥.</span><br><span class="line"></span><br><span class="line">  public SqlSessionTemplate(SqlSessionFactory sqlSessionFactory, ExecutorType executorType,</span><br><span class="line">      PersistenceExceptionTranslator exceptionTranslator) &#123;</span><br><span class="line">// å¯¹sqlSessionFactory å’Œ executorType è¿›è¡Œæ ¡éªŒ</span><br><span class="line">    notNull(sqlSessionFactory, &quot;Property &#x27;sqlSessionFactory&#x27; is required&quot;);</span><br><span class="line">    notNull(executorType, &quot;Property &#x27;executorType&#x27; is required&quot;);</span><br><span class="line"></span><br><span class="line">    this.sqlSessionFactory = sqlSessionFactory;</span><br><span class="line">    this.executorType = executorType;</span><br><span class="line">    this.exceptionTranslator = exceptionTranslator;</span><br><span class="line">// è¿™é‡Œé€šè¿‡ JDK çš„ä»£ç æ¥ç”Ÿæˆäº†ä¸€ä¸ª sqlSessionProxy ä»£ç†çš„å¯¹è±¡.      </span><br><span class="line">    this.sqlSessionProxy = (SqlSession) newProxyInstance(SqlSessionFactory.class.getClassLoader(),</span><br><span class="line">        new Class[] &#123; SqlSession.class &#125;, new SqlSessionInterceptor());</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•æ˜¯å°† SqlSessionTemplate ç»™æ³¨å…¥åˆ° Spring å®¹å™¨ä¸­å•¦.</p><h4 id="ç–‘æƒ‘ç‚¹"><a href="#ç–‘æƒ‘ç‚¹" class="headerlink" title="ç–‘æƒ‘ç‚¹"></a>ç–‘æƒ‘ç‚¹</h4><p>å¤§å®¶æœ‰æ²¡æœ‰ç–‘æƒ‘æˆ‘ä»¬å®šä¹‰çš„ mapper æ¥å£ å¥½åƒä»è¿™ä¸ªæµç¨‹åˆ†æä¸‹æ¥ï¼Œå¹¶æ²¡æœ‰æåˆ° ï¼Œé‚£ä¹ˆæ˜¯åœ¨ä¸Šé¢æ—¶å€™è¢«æ³¨å…¥åˆ° Spring å®¹å™¨ä¸­æ¥çš„å‘¢ï¼Ÿ</p><p>registerBeanDefinitions() è¿™ä¸ªæ–¹æ³• , æ³¨å…¥äº†MapperScannerConfigurer åˆ° Spring å®¹å™¨ä¸­æ¥äº†ï¼Œå¯ä»¥å›é¡¾ä¸‹ä¹‹å‰ mybatis æ•´åˆ Spring çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ˜¯é€šè¿‡ xml é…ç½®äº†è¿™ä¸ªå¯¹è±¡æ³¨å…¥åˆ° spring å®¹å™¨ä¸­æ¥çš„ã€‚ é‚£ä¹ˆæ³¨å…¥è¿›æ¥çš„,å›è°ƒåˆ° org.mybatis.spring.mapper.MapperScannerConfigurer#postProcessBeanDefinitionRegistry è¿™ä¸ªæ–¹æ³•çš„æ—¶å€™ï¼Œå°±ä¼šå°†æ‰«æå¹¶ä¸”å°†æˆ‘ä»¬çš„mapperæ¥å£æ–‡ä»¶ï¼Œç»™æ³¨å…¥åˆ° Spring å®¹å™¨ä¸­æ¥çš„. ç„¶åæ‰«æçš„åŒ…ï¼Œæ˜¯æ ¹æ®@MapperScan è§£ææ³¨è§£çš„æ—¶å€™ï¼Œæ˜¯æœ‰å¯¹æ‰«æçš„åŒ…è¿›è¡Œè§£æçš„.</p><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>å…¶å® SpringBoot æ•´åˆ MyBatis , æˆ‘ä»¬ä»äºŒä¸ªåˆ‡å…¥ç‚¹æ¥åˆ†ææ˜¯æ€ä¹ˆæ•´åˆè¿›æ¥çš„.<br>â€‹ ä¸€æ˜¯ @MapperScan æ³¨è§£ä¸­çš„ @Import(MapperScannerRegistrar.class) å°† MapperScannerRegistrar ç»™å¯¼å…¥åˆ° Spring å®¹å™¨ä¸­æ¥, ç„¶åMapperSacnnerRegistrar æ¥è®² org.mybatis.spring.mapper.MapperScannerConfigurer ç»™æ³¨å…¥åˆ° Springä¸­æ¥ï¼Œæ›¿æ¢äº†æˆ‘ä»¬ä¹‹å‰ç”¨ Spring æ•´åˆ Mybatis çš„æ—¶å€™ï¼Œé€šè¿‡xmlé…ç½®æ–‡ä»¶æ•´åˆè¿›æ¥.</p><p>äºŒæ˜¯åˆ©ç”¨ SpringBoot æä¾›çš„ spring-boot-autoconfigure + spring.factories() æ¥ é…ç½®è‡ªåŠ¨æ³¨å…¥, è¿™é‡Œæ³¨å…¥äº† MybatisAutoConfiguration é…ç½®ç±». ç„¶åæ³¨å…¥è¿›æ¥çš„ MyBatis é…ç½®ç±»åšäº†ä»€ä¹ˆäº‹æƒ…å‘¢ï¼Ÿ å¯ä»¥çœ‹åˆ°è¿™ä¸ªç±»ä¸­æ˜¯æœ‰åš: æ³¨å…¥äº† SqlSessionFactory. SqlSessionFactory åˆæ˜¯æ€ä¹ˆæ³¨å…¥è¿›æ¥çš„å‘¢ï¼Ÿ å¯ä»¥çœ‹åˆ° org.mybatis.spring.boot.autoconfigure.MybatisAutoConfiguration#sqlSessionFactory æ–¹æ³•æ˜¯æœ‰å…ˆåˆ›å»ºä¸€ä¸ª org.mybatis.spring.SqlSessionFactoryBean çš„ï¼Œ çœ‹åˆ° SqlSessionFactoryBean è¿™ä¸ªå¯¹è±¡ï¼Œæˆ‘ä»¬å°±ä¸éš¾æƒ³èµ· Spring + Mybatis é‡Œé¢çš„ beans.xml æ˜¯å°†è¯¥å¯¹è±¡æ³¨å…¥åˆ° Spring å®¹å™¨ä¸­æ¥. è¿™é‡Œæ˜¯ç›´æ¥newçš„ï¼Œç„¶åå°†ä¸€äº›é…ç½®å±æ€§å¹¶æ»¡è¶³æ¡ä»¶,ç»™setåˆ° SqlSessionFactoryBean ä¸­æ¥ï¼Œæœ€åè°ƒç”¨ org.mybatis.spring.SqlSessionFactoryBean#getObject æ–¹æ³•æ¥è·å– SqlSessionFactory.</p><p>spring.factories æ–‡ä»¶å†…å®¹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># Auto Configure</span><br><span class="line">org.springframework.boot.autoconfigure.EnableAutoConfiguration=\</span><br><span class="line">org.mybatis.spring.boot.autoconfigure.MybatisLanguageDriverAutoConfiguration,\</span><br><span class="line">org.mybatis.spring.boot.autoconfigure.MybatisAutoConfiguration</span><br></pre></td></tr></table></figure><p>æœ€åä»å†™çš„æ¡ˆä¾‹é‡Œé¢çœ‹, MyBatis æ•´åˆ SpringBoot å…¶å®éƒ½æ˜¯åœ¨ mybatis â€”&gt; MyBatis + Spring ç­‰ä¸€æ­¥ä¸€æ­¥æ¨å¯¼ä¸Šæ¥çš„ï¼Œæ‰€ä»¥è¿™é‡Œä¸éš¾ç†è§£ï¼Œå¥½çš„æŠ€æœ¯éƒ½æ˜¯åœ¨æœ‰éœ€è¦å’Œæ—¶é—´çš„æ²‰æ·€ä¸‹ä¸€æ­¥ä¸€æ­¥æˆé•¿èµ·æ¥çš„.</p></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://ruy9527.github.io/2021/11/04/mybatis/mybatis%E4%B8%8Espring%E6%95%B4%E5%90%88%E9%98%85%E8%AF%BB/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/touxiang.jpg"><meta itemprop="name" content="YangBao"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="YangBao"><meta itemprop="description" content="çŸ¥è¯†ç¬”è®°"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | YangBao"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2021/11/04/mybatis/mybatis%E4%B8%8Espring%E6%95%B4%E5%90%88%E9%98%85%E8%AF%BB/" class="post-title-link" itemprop="url">mybatisä¸springæ•´åˆé˜…è¯»</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Created: 2021-11-04 00:29:31" itemprop="dateCreated datePublished" datetime="2021-11-04T00:29:31+08:00">2021-11-04</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">Edited on</span> <time title="Modified: 2022-11-04 21:46:13" itemprop="dateModified" datetime="2022-11-04T21:46:13+08:00">2022-11-04</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/java%E6%A1%86%E6%9E%B6/" itemprop="url" rel="index"><span itemprop="name">javaæ¡†æ¶</span></a> </span>, <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/java%E6%A1%86%E6%9E%B6/mybatis/" itemprop="url" rel="index"><span itemprop="name">mybatis</span></a> </span></span><span class="post-meta-break"></span> <span class="post-meta-item" title="Symbols count in article"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">Symbols count in article: </span><span>16k</span> </span><span class="post-meta-item" title="Reading time"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">Reading time &asymp;</span> <span>14 mins.</span></span></div></div></header><div class="post-body" itemprop="articleBody"><h4 id="é¢˜è®°"><a href="#é¢˜è®°" class="headerlink" title="é¢˜è®°"></a>é¢˜è®°</h4><p>MyBatis ä¸ Spring æ•´åˆæ“ä½œ. åœ¨æˆ‘ä»¬å…¥é—¨å­¦ä¹  SSM ç­‰ä¸œè¥¿çš„æ—¶å€™ï¼Œå°±å‘ç°äº†ä»»ä½•ä¸œè¥¿ï¼Œæœ€åéƒ½æ˜¯é€ƒä¸è¿‡ä¸Springæ•´åˆèµ·æ¥çš„é“è·¯. ç„¶åè¿™é‡Œçœ‹å®Œ MyBatis æ•´åˆå®Œ Spring ä¹‹åï¼Œé‚£ä¹ˆä¹‹åä¸€äº›å…¶ä»–çš„ç¬¬ä¸‰æ–¹ï¼Œæ¯”å¦‚axon&#x2F;redis&#x2F;apollo&#x2F;shiro ç­‰è¿™äº›ä¸œè¥¿ï¼Œå¦‚æœè¦æ•´åˆ Spring çš„æ—¶å€™ï¼Œæ˜¯ä¸æ˜¯ä¹Ÿæ˜¯ç›¸ä¼¼çš„æ•´åˆæ–¹å¼å‘¢ï¼Ÿ</p><p>è¿™ä¸ªéœ€è¦æˆ‘ä»¬çœ‹å®Œ MyBatis ä¸ Spring ä¹‹åï¼Œæ¢ç©¶å…¶æ•´åˆçš„æ“ä½œ.</p><h4 id="å…¥é—¨"><a href="#å…¥é—¨" class="headerlink" title="å…¥é—¨"></a>å…¥é—¨</h4><p>åˆ†å‡ ä¸ªæ­¥éª¤ï¼Œæ“ä½œä¸€æŠŠå³å¯,å¸¦ä½ å›åˆ°å“ªä¸ª SM æ—¶ä»£ï¼Œä¸è¿‡è¿™å›æ˜¯æ²¡æœ‰äº† tomcat çš„.</p><p>å…ˆæ”¾ä¸Šä¸€ä¸ªå®Œæˆçš„æ•´åˆåœ°å€ : <a target="_blank" rel="noopener" href="https://github.com/baoyang23/mybtatis-analysis/tree/master/mybatis-spring-hello">https://github.com/baoyang23/mybtatis-analysis/tree/master/mybatis-spring-hello</a> å¦‚æœä¸è¦çœ‹ä¸‹é¢æµç¨‹çš„,ä¸€æ­¥è·³è¿‡å³å¯.</p><ol><li>å…ˆåˆ›å»ºä¸€ä¸ª maven é¡¹ç›®ï¼Œå¼•å…¥ä¾èµ–. ä¾èµ–å‚è€ƒåœ°å€ : <a target="_blank" rel="noopener" href="https://github.com/baoyang23/mybtatis-analysis/blob/master/mybatis-spring-hello/pom.xml">https://github.com/baoyang23/mybtatis-analysis/blob/master/mybatis-spring-hello/pom.xml</a></li><li>dbé…ç½® : <a target="_blank" rel="noopener" href="https://github.com/baoyang23/mybtatis-analysis/blob/master/mybatis-spring-hello/src/main/resources/db.properties">https://github.com/baoyang23/mybtatis-analysis/blob/master/mybatis-spring-hello/src/main/resources/db.properties</a></li><li>MyBatisé…ç½®: <a target="_blank" rel="noopener" href="https://github.com/baoyang23/mybtatis-analysis/tree/master/mybatis-spring-hello/src/main/resources/mybatis">https://github.com/baoyang23/mybtatis-analysis/tree/master/mybatis-spring-hello/src/main/resources/mybatis</a></li><li>Spring é…ç½®: <a target="_blank" rel="noopener" href="https://github.com/baoyang23/mybtatis-analysis/blob/master/mybatis-spring-hello/src/main/resources/spring-beans.xml">https://github.com/baoyang23/mybtatis-analysis/blob/master/mybatis-spring-hello/src/main/resources/spring-beans.xml</a></li><li>æœ€å,æ¥ä»½æˆ‘ä»¬ç†Ÿæ‚‰çš„ <a target="_blank" rel="noopener" href="https://github.com/baoyang23/mybtatis-analysis/tree/master/mybatis-spring-hello/src/main/resources/sql">https://github.com/baoyang23/mybtatis-analysis/tree/master/mybatis-spring-hello/src/main/resources/sql</a> mapper.xml æ–‡ä»¶.</li><li>ä¸å¿˜è®°å†æ¥ä¸€ä»½ä»£ç  : <a target="_blank" rel="noopener" href="https://github.com/baoyang23/mybtatis-analysis/tree/master/mybatis-spring-hello/src">https://github.com/baoyang23/mybtatis-analysis/tree/master/mybatis-spring-hello/src</a> è¿™äº›ç›´æ¥è·‘æµ‹è¯•ç±»å³å¯.</li></ol><p>è·Ÿç€è¿™ä¸Šé¢çš„å‡ ä¸ªæ­¥éª¤ï¼Œå°±å¯ä»¥æ­å»ºå®Œä¸€ä¸ªé¡¹ç›®. ç„¶åå–Šä¸Šæˆ‘ä»¬çš„ æ°¸å“¥ï¼Œ æ‰“ä¸Šä¼ è¯´ä¸­çš„ debug , ç–¯ç‹‚çš„è°ƒè¯•çœ‹æ¯æ­¥å¹²äº†ä»€ä¹ˆäº‹.</p><p>è¿™ä¸ªçš„æ—¶å€™ï¼Œå¯ä»¥è·‘ä¸‹æµ‹è¯•ç±»ï¼Œæ˜¯okçš„.</p><h4 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h4><p>è¿™é‡Œæˆ‘ä»¬é¦–å…ˆæƒ³åˆ°çš„æ˜¯æˆ‘ä»¬å¼•å…¥çš„ä¾èµ–,æ˜¯ä¸æ˜¯æœ‰ä¸ª mybatis-spring çš„ä¾èµ–. ä»è¿™ä¸ªä¾èµ–ï¼Œå¯ä»¥å¾ˆæ˜æ˜¾çš„çœ‹å‡ºæ¥ï¼Œå°±æ˜¯é€šè¿‡è¿™ä¸ªä¾èµ–ï¼Œå°† MyBatis å’Œ Spring æ•´åˆèµ·æ¥çš„ã€‚</p><p>ç„¶åå†æƒ³æƒ³ï¼Œæˆ‘ä»¬é™¤äº†è¿™ä¸ªä¾èµ–çš„è¯ï¼Œè¿˜å†å“ªé‡Œæœ‰ä½¿ç”¨åˆ°ä¸€äº› Spring å’Œ MyBatis çš„ä¸œè¥¿å‘¢ï¼Ÿ ç„¶åçœ‹åˆ° spring-beans.xml è¿™ä¸ªxmlé…ç½®, å¯ä»¥çœ‹åˆ° org.mybatis.spring.SqlSessionFactoryBean ç»™æ³¨å…¥åˆ° bean é‡Œé¢æ¥äº†.org.mybatis.spring.mapper.MapperScannerConfigurerä¹Ÿæ˜¯ç»™æ³¨å…¥åˆ° bean é‡Œé¢æ¥äº†. å¹¶ä¸”äºŒè€…éƒ½æœ‰é€šè¿‡æ¥è¿›è¡Œå±æ€§è®¾ç½®å€¼æ“ä½œ.</p><p>é‚£ä¹ˆ,æˆ‘ä»¬å°±åŸºäºè¿™äºŒä¸ªç±»çš„æºç å¼€å§‹é˜…è¯».</p><p><strong>SqlSessionFactoryBean (org.mybatis.spring.SqlSessionFactoryBean)</strong></p><p>è¿™é‡Œ SqlSessionFactoryBean æ˜¯å®ç°äº†å¾ˆå¤šæ¥å£,è¿™äº›æ¥å£éƒ½æ˜¯Springçš„.</p><p>FactoryBean å·¥å‚bean,ç‚¹è¿›å»å¯ä»¥çœ‹åˆ°,å…¶æœ‰æ–¹æ³•getObject()&#x2F;getObjectTypeç­‰æ–¹æ³•è·å–beançš„,ç„¶ååŠ ä¸Šæ³›å‹,ä¹Ÿå°±æ˜¯è¿™é‡Œè·å–çš„ getObjectå°±æ˜¯æ³›å‹.</p><p>InitializingBean: afterPropertiesSet åˆå§‹åŒ– bean çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨è¯¥æ–¹æ³•.</p><p>ApplicationEvent: Springçš„äº‹ä»¶ä¼ æ’­æœºåˆ¶ï¼Œå°±æ˜¯ä½¿ç”¨çš„è¿™ç§æ–¹å¼.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">/**  å¯ä»¥çœ‹åˆ°è¿™ä¸ªç±»å®ç°äº† Spring è¿™ä¸ªå¤šæ¥å£,é‚£ä¹ˆå°±æœ‰ä¸ªé—®é¢˜,å®ç°äº†è¿™ä¹ˆå¤šæ¥å£çš„æ–¹æ³•,åˆ°åº•æ˜¯å“ªä¸ªæ–¹æ³•å…ˆæ‰§è¡Œçš„å‘¢ï¼Ÿ å¦‚æœä½ å¯¹Springæºç å¾ˆç†Ÿæ‚‰çš„è¯,æ˜¯æœ‰å¯èƒ½æ¸…æ¥šçš„,ä½†æ˜¯è¿˜æ˜¯ä¼šæœ‰ç‚¹ç»•çš„. </span><br><span class="line">è¿™é‡Œæˆ‘ä»¬ç»™ getObject/afterPropertiesSet/onApplicationEventè¿™ä¸‰ä¸ªæ–¹æ³•æ‰“ä¸Šæ–­ç‚¹æ¥è¿›è¡Œdebug,</span><br><span class="line">debugæ¯èµ°çš„ä¸€æ­¥,å°±æ˜¯æ‰§è¡Œçš„å…ˆåé¡ºåºã€‚å¦‚æœä¸æ˜¯ç‰¹åˆ«ç†Ÿæ‚‰æºç çš„æ‰§è¡Œé¡ºåº,è¿™ç§ç¬¨æ–¹æ³•å…¶å®ä¹Ÿæ˜¯å¯ä»¥çš„.</span><br><span class="line">*</span><br><span class="line">* æ‰€ä»¥è¿™é‡Œdebugçš„æ‰§è¡Œé¡ºåºæ˜¯ : afterPropertiesSet --&gt; getObject  ---&gt; onApplicationEvent</span><br><span class="line">* äºæ˜¯æˆ‘ä»¬å°±è·Ÿç€è¿™ä¸ªé¡ºåºæ¥é˜…è¯».</span><br><span class="line">* æ³¨æ„åœ¨è°ƒç”¨è¿™äº›æ–¹æ³•ä¹‹å‰,&lt;property&gt;æ ‡ç­¾çš„å€¼éƒ½æ˜¯å·²ç»èµ‹å€¼è¿›æ¥äº†çš„,æ˜¯é€šè¿‡åå°„èµ°çš„set æ–¹æ³•è¿›æ¥çš„.</span><br><span class="line">*/</span><br><span class="line">public class SqlSessionFactoryBean</span><br><span class="line">    implements FactoryBean&lt;SqlSessionFactory&gt;, InitializingBean, ApplicationListener&lt;ApplicationEvent&gt; &#123;&#125;</span><br><span class="line"></span><br><span class="line">// å®ç°FactoryBean æ–¹æ³•,è¿™é‡Œæ˜¯å®ç°äº†è¯¥æ¥å£çš„ä¸‰ä¸ªæ–¹æ³•. å…¶å®è¿™é‡Œçš„ isSingleæ˜¯å¯ä»¥ä¸ç”¨å®ç°çš„</span><br><span class="line">// å› ä¸ºæ¥å£æ˜¯ç”¨ default æ¥ä¿®é¥°çš„.</span><br><span class="line">  /**</span><br><span class="line">   * è¯¥æ–¹æ³•æ˜¯åˆ¤æ–­å¹¶ä¸”å†æ¬¡ç¡®è®¤ SqlSessionFactoryæ˜¯ä¸æ˜¯æœ‰äº†. å¦‚æœæ²¡æœ‰çš„è¯,å°±ä¼šè°ƒç”¨afterPropertiesæ¥åˆå§‹åŒ–.</span><br><span class="line">   * &#123;@inheritDoc&#125;</span><br><span class="line">   */</span><br><span class="line">  @Override</span><br><span class="line">  public SqlSessionFactory getObject() throws Exception &#123;</span><br><span class="line">    if (this.sqlSessionFactory == null) &#123;</span><br><span class="line">      afterPropertiesSet();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return this.sqlSessionFactory;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public Class&lt;? extends SqlSessionFactory&gt; getObjectType() &#123;</span><br><span class="line">    return this.sqlSessionFactory == null ? SqlSessionFactory.class : this.sqlSessionFactory.getClass();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public boolean isSingleton() &#123;</span><br><span class="line">    return true;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// InitializingBean å®ç°çš„æ–¹æ³•</span><br><span class="line">  @Override</span><br><span class="line">  public void afterPropertiesSet() throws Exception &#123;</span><br><span class="line">// å…ˆå¯¹ dataSource/sqlSessionFactoryBuilderè¿›è¡Œénullçš„åˆ¤æ–­.</span><br><span class="line">    notNull(dataSource, &quot;Property &#x27;dataSource&#x27; is required&quot;);</span><br><span class="line">    notNull(sqlSessionFactoryBuilder, &quot;Property &#x27;sqlSessionFactoryBuilder&#x27; is required&quot;);</span><br><span class="line">    state((configuration == null &amp;&amp; configLocation == null) || !(configuration != null &amp;&amp; configLocation != null),</span><br><span class="line">        &quot;Property &#x27;configuration&#x27; and &#x27;configLocation&#x27; can not specified with together&quot;);</span><br><span class="line">// è¿™é‡Œæ„å»ºå‡º ä¸€ä¸ª sqlSessionFactoryå·¥å‚æ¥,æƒ³æƒ³æˆ‘ä»¬æœ€åˆå†çœ‹å•ä¸ªMyBatisé¡¹ç›®çš„æ—¶å€™,æ˜¯ä¸æ˜¯ä¹Ÿæœ‰ä¸€ä¸ªè·å–SqlSessionFactroyçš„æ–¹æ³•,ç„¶åä»sqlSessionFactoryä¼šè¯ä¸­è·å–å‡ºSqlSessionæ¥.</span><br><span class="line">    this.sqlSessionFactory = buildSqlSessionFactory();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">// ApplicationListenerå®ç°æ–¹æ³•</span><br><span class="line">  /**</span><br><span class="line">   * failFast æ—¶ture å¹¶ä¸”ä¼ è¿‡æ¥çš„ eventæ˜¯ ContextRefreshedEventçš„è¯,å°±ä¼šè¿›æ¥.</span><br><span class="line">   *  è¿™é‡Œç›®å‰éƒ½æ˜¯è°ƒç”¨getæ–¹æ³•,æ²¡æœ‰å¾ˆä»”ç»†çœ‹å‡ºå…¶ä½œç”¨.</span><br><span class="line">   * &#123;@inheritDoc&#125;</span><br><span class="line">   */</span><br><span class="line">  @Override</span><br><span class="line">  public void onApplicationEvent(ApplicationEvent event) &#123;</span><br><span class="line">    if (failFast &amp;&amp; event instanceof ContextRefreshedEvent) &#123;</span><br><span class="line">      // fail-fast -&gt; check all statements are completed</span><br><span class="line">      this.sqlSessionFactory.getConfiguration().getMappedStatementNames();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p><strong>org.mybatis.spring.SqlSessionFactoryBean#buildSqlSessionFactory</strong></p><p>è¯¥æ–¹æ³•éœ€è¦å•ç‹¬æ‹¿å‡ºæ¥è¯´ä¸‹,å› ä¸ºå†…å®¹è¿˜æ˜¯æ¯”è¾ƒå¤šçš„.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Build a &#123;@code SqlSessionFactory&#125; instance.</span><br><span class="line"> *</span><br><span class="line"> * The default implementation uses the standard MyBatis &#123;@code XMLConfigBuilder&#125; API to build a</span><br><span class="line"> * &#123;@code SqlSessionFactory&#125; instance based on a Reader. Since 1.3.0, it can be specified a &#123;@link Configuration&#125;</span><br><span class="line"> * instance directly(without config file).</span><br><span class="line"> *</span><br><span class="line"> * @return SqlSessionFactory</span><br><span class="line"> * @throws Exception</span><br><span class="line"> *           if configuration is failed</span><br><span class="line"> */</span><br><span class="line">protected SqlSessionFactory buildSqlSessionFactory() throws Exception &#123;</span><br><span class="line"></span><br><span class="line">  final Configuration targetConfiguration;</span><br><span class="line"></span><br><span class="line">  XMLConfigBuilder xmlConfigBuilder = null;</span><br><span class="line">    </span><br><span class="line"> // è¿™é‡Œåˆ†ä¸ºconfiguration/ configLocation / éå‰äºŒè€…(å¯ä»¥ç†è§£ä¸ºé»˜è®¤çš„).</span><br><span class="line"> // ä¸‰ç§å¤„ç†æ–¹å¼.   </span><br><span class="line">  if (this.configuration != null) &#123;</span><br><span class="line">    targetConfiguration = this.configuration;</span><br><span class="line">    if (targetConfiguration.getVariables() == null) &#123;</span><br><span class="line">      targetConfiguration.setVariables(this.configurationProperties);</span><br><span class="line">    &#125; else if (this.configurationProperties != null) &#123;</span><br><span class="line">      targetConfiguration.getVariables().putAll(this.configurationProperties);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; else if (this.configLocation != null) &#123;</span><br><span class="line">// è¿™é‡Œå°±æ˜¯æˆ‘ä»¬é…ç½®çš„æƒ…å†µ </span><br><span class="line">// org.apache.ibatis.builder.xml.XMLConfigBuilder#XMLConfigBuilder(java.io.InputStream, java.lang.String, java.util.Properties),å¯ä»¥çœ‹åˆ°è¿™ä¸ªç†Ÿæ‚‰çš„æ“ä½œ,ä¹Ÿå°±æ˜¯æˆ‘ä»¬å•ä¸ªè§£æ MyBatisçš„æ—¶å€™æœ‰è¿›è¡Œåˆ†æè¿‡çš„.      </span><br><span class="line">    xmlConfigBuilder = new XMLConfigBuilder(this.configLocation.getInputStream(), null, this.configurationProperties);</span><br><span class="line">// è·å–å‡º configuration é…ç½®ä¿¡æ¯.      </span><br><span class="line">    targetConfiguration = xmlConfigBuilder.getConfiguration();</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    LOGGER.debug(</span><br><span class="line">        () -&gt; &quot;Property &#x27;configuration&#x27; or &#x27;configLocation&#x27; not specified, using default MyBatis Configuration&quot;);</span><br><span class="line">    targetConfiguration = new Configuration();</span><br><span class="line">    Optional.ofNullable(this.configurationProperties).ifPresent(targetConfiguration::setVariables);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// è¿™é‡Œé‡‡ç”¨ Optional,å¦‚æœobjectFactoryä¸æ˜¯nullçš„è¯,å°±ä¼šè°ƒç”¨targetConfigurationçš„ setObjectFactoryæ–¹æ³•.ä¸‹é¢è¿™äºŒä¸ªæ˜¯åŒç†.</span><br><span class="line">  Optional.ofNullable(this.objectFactory).ifPresent(targetConfiguration::setObjectFactory);</span><br><span class="line">  Optional.ofNullable(this.objectWrapperFactory).ifPresent(targetConfiguration::setObjectWrapperFactory);</span><br><span class="line">  Optional.ofNullable(this.vfs).ifPresent(targetConfiguration::setVfsImpl);</span><br><span class="line"></span><br><span class="line">// è¿™é‡Œå¦‚æœæœ‰é…ç½®typeAliasesPackageè¿™ä¸ªå‚æ•°çš„è¯,å°±ä¼šå¯¹è¯¥åŒ…ä¸‹è¿›è¡Œæ‰«æ,è¿›è¡Œä¸€ç³»åˆ—çš„è¿‡æ»¤,</span><br><span class="line">// å¦‚æœéƒ½æ»¡è¶³æ¡ä»¶çš„è¯,targetConfiguration.getTypeAliasRegistry()::registerAliaså°±ä¼šæ³¨å†Œåˆ°è¿™é‡Œ. </span><br><span class="line">  if (hasLength(this.typeAliasesPackage)) &#123;</span><br><span class="line">    scanClasses(this.typeAliasesPackage, this.typeAliasesSuperType).stream()</span><br><span class="line">        .filter(clazz -&gt; !clazz.isAnonymousClass()).filter(clazz -&gt; !clazz.isInterface())</span><br><span class="line">        .filter(clazz -&gt; !clazz.isMemberClass()).forEach(targetConfiguration.getTypeAliasRegistry()::registerAlias);</span><br><span class="line">  &#125;</span><br><span class="line">// æ˜¯å¦æœ‰typeAliasesè¿™ä¸ªå‚æ•°,å¦‚æœæœ‰çš„è¯,ä¹Ÿæ˜¯å¯ä»¥çœ‹åˆ°æ˜¯æ³¨å†Œåˆ°ä¸Šé¢å“ªä¸€æ­¥çš„é‡Œé¢æ¥.</span><br><span class="line">  if (!isEmpty(this.typeAliases)) &#123;</span><br><span class="line">    Stream.of(this.typeAliases).forEach(typeAlias -&gt; &#123;</span><br><span class="line">      targetConfiguration.getTypeAliasRegistry().registerAlias(typeAlias);</span><br><span class="line">      LOGGER.debug(() -&gt; &quot;Registered type alias: &#x27;&quot; + typeAlias + &quot;&#x27;&quot;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">//åˆ¤æ–­æ˜¯å¦æœ‰æ’ä»¶,å¦‚æœæœ‰æ’ä»¶çš„è¯,ä¹Ÿä¼šæ·»åŠ åˆ°configurationä¸­æ¥.    </span><br><span class="line">  if (!isEmpty(this.plugins)) &#123;</span><br><span class="line">    Stream.of(this.plugins).forEach(plugin -&gt; &#123;</span><br><span class="line">      targetConfiguration.addInterceptor(plugin);</span><br><span class="line">      LOGGER.debug(() -&gt; &quot;Registered plugin: &#x27;&quot; + plugin + &quot;&#x27;&quot;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (hasLength(this.typeHandlersPackage)) &#123;</span><br><span class="line">    scanClasses(this.typeHandlersPackage, TypeHandler.class).stream().filter(clazz -&gt; !clazz.isAnonymousClass())</span><br><span class="line">        .filter(clazz -&gt; !clazz.isInterface()).filter(clazz -&gt; !Modifier.isAbstract(clazz.getModifiers()))</span><br><span class="line">        .forEach(targetConfiguration.getTypeHandlerRegistry()::register);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (!isEmpty(this.typeHandlers)) &#123;</span><br><span class="line">    Stream.of(this.typeHandlers).forEach(typeHandler -&gt; &#123;</span><br><span class="line">      targetConfiguration.getTypeHandlerRegistry().register(typeHandler);</span><br><span class="line">      LOGGER.debug(() -&gt; &quot;Registered type handler: &#x27;&quot; + typeHandler + &quot;&#x27;&quot;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  targetConfiguration.setDefaultEnumTypeHandler(defaultEnumTypeHandler);</span><br><span class="line"></span><br><span class="line">  if (!isEmpty(this.scriptingLanguageDrivers)) &#123;</span><br><span class="line">    Stream.of(this.scriptingLanguageDrivers).forEach(languageDriver -&gt; &#123;</span><br><span class="line">      targetConfiguration.getLanguageRegistry().register(languageDriver);</span><br><span class="line">      LOGGER.debug(() -&gt; &quot;Registered scripting language driver: &#x27;&quot; + languageDriver + &quot;&#x27;&quot;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  Optional.ofNullable(this.defaultScriptingLanguageDriver)</span><br><span class="line">      .ifPresent(targetConfiguration::setDefaultScriptingLanguage);</span><br><span class="line"></span><br><span class="line">  if (this.databaseIdProvider != null) &#123;// fix #64 set databaseId before parse mapper xmls</span><br><span class="line">    try &#123;</span><br><span class="line">      targetConfiguration.setDatabaseId(this.databaseIdProvider.getDatabaseId(this.dataSource));</span><br><span class="line">    &#125; catch (SQLException e) &#123;</span><br><span class="line">      throw new NestedIOException(&quot;Failed getting a databaseId&quot;, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Optional.ofNullable(this.cache).ifPresent(targetConfiguration::addCache);</span><br><span class="line">// è¿™è¿™ä¹‹å‰,éƒ½æ˜¯å¯¹ä¸€äº›é…ç½®ä¿¡æ¯çš„è¯»å–,å¦‚æœæœ‰çš„è¯,å°±ä¼šè¿›è¡Œç›¸åº”çš„èµ‹å€¼ä¹‹ç±»çš„æ“ä½œ.</span><br><span class="line">    </span><br><span class="line">  if (xmlConfigBuilder != null) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">// æœ€åè¿™é‡Œçš„ parse è§£ææ–¹æ³•,æ˜¯å’Œå•ä¸ª Mybatisçš„è§£è¯»æ˜¯ä¸€æ ·çš„.        </span><br><span class="line">      xmlConfigBuilder.parse();</span><br><span class="line">      LOGGER.debug(() -&gt; &quot;Parsed configuration file: &#x27;&quot; + this.configLocation + &quot;&#x27;&quot;);</span><br><span class="line">    &#125; catch (Exception ex) &#123;</span><br><span class="line">      throw new NestedIOException(&quot;Failed to parse config resource: &quot; + this.configLocation, ex);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">      ErrorContext.instance().reset();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">//è¿™é‡Œå¯ä»¥çœ‹äº‹åŠ¡å·¥å‚,æ˜¯ä½¿ç”¨äº†mybatis-springåŒ…ä¸‹çš„.</span><br><span class="line">  targetConfiguration.setEnvironment(new Environment(this.environment,</span><br><span class="line">      this.transactionFactory == null ? new SpringManagedTransactionFactory() : this.transactionFactory,</span><br><span class="line">      this.dataSource));</span><br><span class="line"></span><br><span class="line">// è¿™é‡Œæ˜¯å¤„ç† mapper.xml æ–‡ä»¶çš„é…ç½®,å¦‚æœåœ¨è¿™é‡Œæ˜¯æœ‰é…ç½®çš„è¯,é‚£ä¹ˆä¹Ÿæ˜¯ä¼šè¢«è§£æåˆ°çš„.    </span><br><span class="line">  if (this.mapperLocations != null) &#123;</span><br><span class="line">    if (this.mapperLocations.length == 0) &#123;</span><br><span class="line">      LOGGER.warn(() -&gt; &quot;Property &#x27;mapperLocations&#x27; was specified but matching resources are not found.&quot;);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      for (Resource mapperLocation : this.mapperLocations) &#123;</span><br><span class="line">        if (mapperLocation == null) &#123;</span><br><span class="line">          continue;</span><br><span class="line">        &#125;</span><br><span class="line">        try &#123;</span><br><span class="line">          XMLMapperBuilder xmlMapperBuilder = new XMLMapperBuilder(mapperLocation.getInputStream(),</span><br><span class="line">              targetConfiguration, mapperLocation.toString(), targetConfiguration.getSqlFragments());</span><br><span class="line">          xmlMapperBuilder.parse();</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">          throw new NestedIOException(&quot;Failed to parse mapping resource: &#x27;&quot; + mapperLocation + &quot;&#x27;&quot;, e);</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">          ErrorContext.instance().reset();</span><br><span class="line">        &#125;</span><br><span class="line">        LOGGER.debug(() -&gt; &quot;Parsed mapper file: &#x27;&quot; + mapperLocation + &quot;&#x27;&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    LOGGER.debug(() -&gt; &quot;Property &#x27;mapperLocations&#x27; was not specified.&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">//org.apache.ibatis.session.defaults.DefaultSqlSessionFactory,æœ€ååˆ°è¿™é‡Œä¹Ÿæ˜¯newäº†ä¸€ä¸ªmybatisåŒ…ä¸‹çš„é»˜è®¤SqlSessionFactoryç±».</span><br><span class="line">  return this.sqlSessionFactoryBuilder.build(targetConfiguration);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¯¥æ–¹æ³•ç»™äººæ„Ÿè§‰, å…ˆæ˜¯åˆ¤æ–­ä¸€äº›é…ç½®ä¿¡æ¯æ˜¯ä¸æ˜¯æœ‰å€¼ï¼Œå¦‚æœæ˜¯æœ‰å€¼çš„è¯ï¼Œå°±ä¼šè¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚æœ€åè°ƒç”¨æˆ‘ä»¬åœ¨çœ‹å•ä¸ª mybatis çš„ parse è§£ææ–¹æ³•,æœ€ånewäº†ä¸€ä¸ªé»˜è®¤çš„sqlSessionFactoryå·¥å‚ç±»å‡ºæ¥.</p><p><strong>MapperScannerConfigurer(org.mybatis.spring.mapper.MapperScannerConfigurer)</strong></p><p>æ¥ç€çœ‹,spring-beans.xml é‡Œé¢çš„ç¬¬äºŒä¸ªé…ç½®.</p><p>å¯ä»¥çœ‹åˆ°è¯¥ç±»ï¼Œä¹Ÿæ˜¯å®ç°äº† spring çš„å¾ˆå¤šæ¥å£.</p><p>BeanDefinitionRegistryPostProcessor : æ³¨å†ŒBeanDefinitionåˆ°Springå®¹å™¨ä¸­æ¥.</p><p>ApplicationContextAware : è·å– ApplicationContext</p><p>BeanNameAware : è®¾ç½® beanNameåå­—.</p><p>è¿™é‡Œä¹Ÿå¯ä»¥æŒ‰ç…§ä¸Šé¢çš„ç¬¨æ–¹æ³•ï¼Œä¸€æ¬¡å¯¹é‡å†™çš„æ–¹æ³•æ‰“ä¸Šæ–­ç‚¹. ç„¶åå¼€å¯æˆ‘ä»¬çš„debugæ¥çœ‹çœ‹æ–¹æ³•çš„æ‰§è¡Œé¡ºåº.</p><p>å…¶æ‰§è¡Œé¡ºåº : setBeanName â€”&gt; setApplicationContext â€”&gt; afterPropertiesSet â€”&gt; postProcessBeanDefinitionRegistry , è·Ÿç€è¿™å››ä¸ªæ–¹æ³•æ‰§è¡Œçš„é¡ºåºæ¥çœ‹.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">public class MapperScannerConfigurer</span><br><span class="line">    implements BeanDefinitionRegistryPostProcessor, InitializingBean, ApplicationContextAware, BeanNameAware &#123; &#125;</span><br></pre></td></tr></table></figure><p>èµ‹å€¼ç»™ beanName å€¼. org.mybatis.spring.mapper.MapperScannerConfigurer#0</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void setBeanName(String name) &#123;</span><br><span class="line">  this.beanName = name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// ç„¶åè¿™é‡Œæ˜¯ç»™åˆ° ApplicationContext. è¿™ä¹Ÿå°±è¯´è¿™ä¸ªç±»ç°åœ¨æœ‰äº† ApplicationContext,å¯ä»¥æ ¹æ®contextæä¾›çš„apiæ¥è¿›è¡Œç›¸åº”çš„æ“ä½œ.</span><br><span class="line">  @Override</span><br><span class="line">  public void setApplicationContext(ApplicationContext applicationContext) &#123;</span><br><span class="line">    this.applicationContext = applicationContext;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">// æ£€éªŒé…ç½®åŒ…çš„å€¼ä¸èƒ½ä¸ºnull.</span><br><span class="line">  @Override</span><br><span class="line">  public void afterPropertiesSet() throws Exception &#123;</span><br><span class="line">    notNull(this.basePackage, &quot;Property &#x27;basePackage&#x27; is required&quot;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * &#123;@inheritDoc&#125;</span><br><span class="line">   * å¯ä»¥æ„Ÿå—åˆ°è¿™ä¸ªæ–¹æ³•, åœ¨æ‹¿åˆ°äº†BeanDefinitionRegistryçš„æƒ…å†µä¸‹,å¾€é‡Œé¢æ³¨å†Œbd.</span><br><span class="line">   * @since 1.0.2</span><br><span class="line">   */</span><br><span class="line">  @Override</span><br><span class="line">  public void postProcessBeanDefinitionRegistry(BeanDefinitionRegistry registry) &#123;</span><br><span class="line">    if (this.processPropertyPlaceHolders) &#123;</span><br><span class="line">      processPropertyPlaceHolders();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">// è¿™æ®µæ˜¯åˆ›å»ºäº†ä¸€ä¸ª ClassPathMapperScanner å¯¹è±¡,ç„¶åå¾€é‡Œé¢setå±æ€§.      </span><br><span class="line">    ClassPathMapperScanner scanner = new ClassPathMapperScanner(registry);</span><br><span class="line">    scanner.setAddToConfig(this.addToConfig);</span><br><span class="line">    scanner.setAnnotationClass(this.annotationClass);</span><br><span class="line">    scanner.setMarkerInterface(this.markerInterface);</span><br><span class="line">    scanner.setSqlSessionFactory(this.sqlSessionFactory);</span><br><span class="line">    scanner.setSqlSessionTemplate(this.sqlSessionTemplate);</span><br><span class="line">    scanner.setSqlSessionFactoryBeanName(this.sqlSessionFactoryBeanName);</span><br><span class="line">    scanner.setSqlSessionTemplateBeanName(this.sqlSessionTemplateBeanName);</span><br><span class="line">    scanner.setResourceLoader(this.applicationContext);</span><br><span class="line">    scanner.setBeanNameGenerator(this.nameGenerator);</span><br><span class="line">    scanner.setMapperFactoryBeanClass(this.mapperFactoryBeanClass);</span><br><span class="line">      </span><br><span class="line">    if (StringUtils.hasText(lazyInitialization)) &#123;</span><br><span class="line">      scanner.setLazyInitialization(Boolean.valueOf(lazyInitialization));</span><br><span class="line">    &#125;</span><br><span class="line">    if (StringUtils.hasText(defaultScope)) &#123;</span><br><span class="line">      scanner.setDefaultScope(defaultScope);</span><br><span class="line">    &#125;</span><br><span class="line">      </span><br><span class="line">// å¯¹registeré‡Œçš„ä¿¡æ¯è¿›è¡Œè¿‡æ»¤      </span><br><span class="line">    scanner.registerFilters();</span><br><span class="line">// org.springframework.context.annotation.ClassPathBeanDefinitionScanner#scan</span><br><span class="line">// è¿™é‡Œä¸»è¦çœ‹æ‰«æçš„æ–¹æ³•. æ ¹æ®,æ¥åˆ‡å‰²æˆ‘ä»¬å†™çš„ basePackage ä¿¡æ¯.æ‰«æç±»çš„ä¿¡æ¯,æœ€åè¿˜æ˜¯å€Ÿç”¨äº† org.springframework.context.annotation.ClassPathBeanDefinitionScanner#doScan æ¥è¿›è¡Œæ‰«æçš„. //  doScan(basePackages) æ˜¯å¯¹ xml è¿›è¡Œæ‰«æçš„.</span><br><span class="line">// AnnotationConfigUtils.registerAnnotationConfigProcessors(this.registry); æ˜¯å¯¹æ³¨è§£è¿›è¡Œæ‰«æçš„.</span><br><span class="line">// æœ€åè¿”å›æ³¨å†Œåˆ° Spring å®¹å™¨ä¸­çš„ bean ä¸ªæ•°</span><br><span class="line">// æ‰€ä»¥å¦‚æœæˆ‘ä»¬é…ç½®äº†ä¸‹é¢çš„æ ‡ç­¾,é‚£ä¹ˆåœ¨è¿™é‡Œéƒ½ä¼šè¢«æ‰«æåˆ°å¹¶ä¸”æ³¨å†Œåˆ°Springå®¹å™¨ä¸­.</span><br><span class="line">//     &lt;bean class=&quot;org.mybatis.spring.mapper.MapperScannerConfigurer&quot;&gt;</span><br><span class="line">//        &lt;property name=&quot;basePackage&quot; value=&quot;com.iyang.sm.mapper&quot; &gt;&lt;/property&gt;</span><br><span class="line">//    &lt;/bean&gt;</span><br><span class="line">// è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯:  org.mybatis.spring.mapper.ClassPathMapperScanner#processBeanDefinitions</span><br><span class="line">//   definition.setBeanClass(this.mapperFactoryBeanClass);  è¿™é‡Œçš„è¿™è¡Œä»£ç ,æ˜¯ç»™bdçš„beanClassç»™æ¢æˆäº† MapperFactoryBean.class , </span><br><span class="line">//  definition.getConstructorArgumentValues().addGenericArgumentValue(beanClassName);     // è¿™å¥ä»£ç ,å°† beanClassName ç»™åˆ° dbä¹‹å, ç„¶åå°±æ‰ç”¨ beanClassNameæ¥newä¸€ä¸ª MapperFactoryBean å¯¹è±¡æ¥, æ‰€ä»¥è¿™é‡Œå¹¶ä¸æ˜¯ä½¿ç”¨æ— å‚æ„é€ å‡½æ•°.</span><br><span class="line">// ä¹Ÿè®¸ä¼šé—®,æ€ä¹ˆè¯å®æ²¡æœ‰èµ°æ— å‚æ•°æ„é€ å‡½æ•°å‘¢ ? è€Œæ˜¯å»èµ°çš„ set æ–¹æ³•å‘¢ ? </span><br><span class="line">// å†ä¸èƒ½åŠ¨æºç çš„æƒ…å†µä¸‹, é¢å¯¹è¿™ç§æƒ…å†µæƒ…å†µæœ€å¥½çš„åŠæ³•å°±æ˜¯, åœ¨æ— å‚æ„é€ å‡½æ•°ä¸Šæ‰“ä¸Šæ–­ç‚¹.</span><br><span class="line">// å¦‚æœæ²¡èµ°åˆ°æ–­ç‚¹ä¸Š,é‚£å°±è¯´æ˜ä¸æ˜¯èµ°çš„æ— å‚æ„é€ å‡½æ•°æ¥åˆå§‹åŒ–çš„.      </span><br><span class="line">    scanner.scan(</span><br><span class="line">        StringUtils.tokenizeToStringArray(this.basePackage, ConfigurableApplicationContext.CONFIG_LOCATION_DELIMITERS));</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥åˆ°è¿™é‡Œ, å¯ä»¥çœ‹åˆ° MyBatis ä¸ Spring æ•´åˆçš„è¿‡ç¨‹å°±å·²ç»å®Œæˆäº†.</p><p>æˆ‘ä»¬è¿™é‡Œæ˜¯ä¸»è¦å¯¹ SqlSessionFactoryBean å’Œ MapperScannerConfigurer æ¥è¿›è¡Œåˆ†æçš„, å¯ä»¥å¾ˆæ˜æ˜¾çš„æ„Ÿè§‰åˆ°,æˆ‘ä»¬æ˜¯é…ç½®å¥½è¿™äºŒä¸ªbeanå,å°±å¯ä»¥ä½¿ç”¨äº†. ç€é‡çœ‹ç¬¬äºŒä¸ª, org.mybatis.spring.mapper.MapperScannerConfigurer è¿™ä¸ªbean,å°±æ˜¯åšäº†å¦‚ä½•å°† MyBatis çš„ mapperæ¥å£æ–‡ä»¶ç»™åŠ è½½åˆ° Spring ä¸­æ¥çš„. <strong>é‚£ä¹ˆè¿™é‡Œæˆ‘åœ¨æƒ³, å¦‚æœæœ‰å¤©æˆ‘è‡ªå·±å¼€å‘å‡ºä¸€ä¸ªå¥½ç”¨çš„æ¡†æ¶æ¥,è¦ä¸ Spring è¿›è¡Œæ•´åˆçš„è¯,æ˜¯ä¸æ˜¯ä¹Ÿè¿™æ ·æ•´åˆå°±å¯ä»¥äº†ï¼Ÿ</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- é…ç½®sqlSessionFactoryï¼ŒSqlSessionFactoryBeanæ˜¯ç”¨æ¥äº§ç”ŸsqlSessionFactoryçš„ --&gt;</span><br><span class="line">&lt;bean id=&quot;sqlSessionFactory&quot; class=&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;&gt;</span><br><span class="line">    &lt;!-- åŠ è½½mybatisçš„å…¨å±€é…ç½®æ–‡ä»¶ï¼Œæ”¾åœ¨classpathä¸‹çš„mybatisæ–‡ä»¶å¤¹ä¸­äº† --&gt;</span><br><span class="line">    &lt;property name=&quot;configLocation&quot; value=&quot;mybatis/SqlMapConfig.xml&quot; /&gt;</span><br><span class="line">    &lt;!-- åŠ è½½æ•°æ®æºï¼Œä½¿ç”¨ä¸Šé¢é…ç½®å¥½çš„æ•°æ®æº --&gt;</span><br><span class="line">    &lt;property name=&quot;dataSource&quot; ref=&quot;dataSource&quot; /&gt;</span><br><span class="line">&lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">&lt;!--  é…ç½®æ‰«æ MyBatis æ¥å£çš„åŒ… --&gt;</span><br><span class="line">&lt;bean class=&quot;org.mybatis.spring.mapper.MapperScannerConfigurer&quot;&gt;</span><br><span class="line">    &lt;property name=&quot;basePackage&quot; value=&quot;com.iyang.sm.mapper&quot; &gt;&lt;/property&gt;</span><br><span class="line">&lt;/bean&gt;</span><br></pre></td></tr></table></figure><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>å¯ä»¥çœ‹åˆ° MyBatis ä¸ Spring æ•´åˆå, å¯¹äºè§£æ MyBatis çš„ mapper é…ç½®æ–‡ä»¶ç­‰ï¼Œéƒ½æ˜¯èµ°çš„ä¹‹å‰å•ä¸ª mybatis çš„é€»è¾‘, æ˜¯æ²¡æœ‰ä»€ä¹ˆå˜åŒ–çš„. ä¸»è¦çš„æ˜¯å°† , SqlSessionFactory å’Œ Mapper.class(æ¥å£ç±») ç»™æ³¨å…¥åˆ° Spring å®¹å™¨ä¸­.ç„¶åæ¥å£çš„è¯, æ˜¯æ€ä¹ˆä½¿ç”¨çš„ä»£ç†ç±»æ¥è¿›è¡Œå®ä¾‹åŒ–å®Œå, å°†å¯¹è±¡ç»™æ³¨å…¥åˆ° Spring å®¹å™¨ä¸­çš„å‘¢ ï¼Ÿ è¿™é‡Œçœ‹ org.mybatis.spring.mapper.MapperScannerConfigurer åšçš„äº‹æƒ…å°±æ˜ç™½äº†.</p><p>ä¸è¿‡åœ¨çœ‹ mybatis ä¸ Spring æ•´åˆçš„æ—¶å€™, è¿˜æ˜¯å»ºè®®è¦æœ‰å¯¹ BeanDefinitionRegistryPostProcessor &#x2F; InitializingBean &#x2F; ApplicationContextAware &#x2F; BeanNameAware æœ‰ä¸€å®šçš„äº†æ¥. å°±æ˜¯æœ‰äº†äº†è§£å, ä½ å°±ä¼šå¾ˆæ˜æ˜¾çš„æ„Ÿå—åˆ°ï¼Œ mybatis ä¸ºä»€ä¹ˆæ˜¯å®ç°è¿™ä¸ªæ¥å£ï¼Œå®ç°è¿™ä¸ªæ¥å£å¹¶ä¸”é‡å†™è¿™ä¸ªæ–¹æ³•ï¼Œåœ¨åé¢æ˜¯ä»€ä¹ˆæ—¶å€™è¢«è°ƒç”¨çš„. æ„æ€ä¹Ÿå°±æ˜¯ï¼Œä½ è‡³å°‘å¾—æ˜ç™½ç‚¹ Spring å¯¹å¤–æä¾›çš„ä¸€äº›æ‰©å±•ç‚¹ï¼Œæ‰èƒ½å¾ˆå¥½çš„ç†è§£è¿™äº›ä¸œè¥¿.</p></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://ruy9527.github.io/2021/11/04/mybatis/mybatis%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B%E9%98%85%E8%AF%BB/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/touxiang.jpg"><meta itemprop="name" content="YangBao"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="YangBao"><meta itemprop="description" content="çŸ¥è¯†ç¬”è®°"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | YangBao"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2021/11/04/mybatis/mybatis%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B%E9%98%85%E8%AF%BB/" class="post-title-link" itemprop="url">mybatiså·¥ä½œæµç¨‹é˜…è¯»</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Created: 2021-11-04 00:29:16" itemprop="dateCreated datePublished" datetime="2021-11-04T00:29:16+08:00">2021-11-04</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">Edited on</span> <time title="Modified: 2022-11-04 21:46:13" itemprop="dateModified" datetime="2022-11-04T21:46:13+08:00">2022-11-04</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/java%E6%A1%86%E6%9E%B6/" itemprop="url" rel="index"><span itemprop="name">javaæ¡†æ¶</span></a> </span>, <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/java%E6%A1%86%E6%9E%B6/mybatis/" itemprop="url" rel="index"><span itemprop="name">mybatis</span></a> </span></span><span class="post-meta-break"></span> <span class="post-meta-item" title="Symbols count in article"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">Symbols count in article: </span><span>18k</span> </span><span class="post-meta-item" title="Reading time"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">Reading time &asymp;</span> <span>17 mins.</span></span></div></div></header><div class="post-body" itemprop="articleBody"><h4 id="MyBatis-çš„å·¥ç¨‹æµç¨‹åˆ†æ"><a href="#MyBatis-çš„å·¥ç¨‹æµç¨‹åˆ†æ" class="headerlink" title="MyBatis çš„å·¥ç¨‹æµç¨‹åˆ†æ"></a>MyBatis çš„å·¥ç¨‹æµç¨‹åˆ†æ</h4><p>MyBatis æ˜¯æˆ‘ä»¬åœ¨å­¦ä¹ Javaæ¡†æ¶ï¼Œä¹Ÿå°±æ˜¯å­¦ä¹ å®ŒJavaWebçš„çŸ¥è¯†å,è¦å­¦ä¹ åˆ°çš„ä¸€ä¸ªORMçš„æ¡†æ¶. æˆ‘ä¹Ÿæ˜¯å­¦ä¹ &amp;ä½¿ç”¨è¿‡åï¼Œå†æ¬¡å¯¹æºç è¿›è¡Œé˜…è¯»çš„. æ‰€ä»¥è¿™ç¯‡æ–‡ç« è®°å½• MyBatis çš„ä¸€ä¸ª work flow.</p><p>å…ˆæ”¾ä¸Šé¡¹ç›®åœ°å€ : <a target="_blank" rel="noopener" href="https://github.com/baoyang23/mybtatis-analysis/tree/master/mybatis-work-flow">https://github.com/baoyang23/mybtatis-analysis/tree/master/mybatis-work-flow</a></p><p>æœ‰å…´è¶£çš„åŒå­¦,å¯ä»¥cloneä¸‹æ¥çœ‹çœ‹.</p><h4 id="æ¡ˆä¾‹ä»£ç "><a href="#æ¡ˆä¾‹ä»£ç " class="headerlink" title="æ¡ˆä¾‹ä»£ç "></a>æ¡ˆä¾‹ä»£ç </h4><p>å…ˆæ”¾ä¸Šæ¡ˆåˆ—çš„ä»£ç , ç„¶åæˆ‘ä»¬å¯ä»¥æŒ¨ä¸ªçš„åˆ†æ.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">public class InitHelloMyBatis &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws IOException &#123;</span><br><span class="line">        // è¯»å–é…ç½®æ–‡ä»¶.</span><br><span class="line">        InputStream mybatisInputStream = Resources.getResourceAsStream(&quot;mybatis-config.xml&quot;);</span><br><span class="line">        // ä¼ å…¥è¯»å–é…ç½®æ–‡ä»¶çš„æµ,ä½¿ç”¨SqlSessionFactoryBuilderæ¥</span><br><span class="line">        // æ„å»º SqlSessionFactory.</span><br><span class="line">        SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(mybatisInputStream);</span><br><span class="line">        // ä» SqlSessionFactory ä¸­è·å–SqlSessionä¼šè¯.</span><br><span class="line">        SqlSession session = sqlSessionFactory.openSession();</span><br><span class="line"></span><br><span class="line">        // ä»ä¼šè¯ä¸­è·å– Mapper.</span><br><span class="line">        BlogMapper blogMapper = session.getMapper(BlogMapper.class);</span><br><span class="line">        </span><br><span class="line">        // è°ƒç”¨æŸ¥è¯¢æ–¹æ³•.</span><br><span class="line">        TbBlog tbBlog = blogMapper.selectBlog(1);</span><br><span class="line">        System.out.println(tbBlog);</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè¯´ä¸‹å¤§è‡´æµç¨‹ :</p><ul><li>ä½¿ç”¨ Resources æ¥è¯»å– mybatis-config.xmlé…ç½®æ–‡ä»¶, å¦‚æœè¯¥æ–‡ä»¶ä¸å­˜åœ¨æˆ–è€…è¯»å–å‡ºæ¥ InputStream æ˜¯ null çš„è¯,ç¨‹åºå°±ä¼šæŠ›å‡º IOException çš„é”™è¯¯æ¥.</li><li>è¯»å–é…ç½®æ²¡æœ‰é—®é¢˜,æ¥åˆ° new SqlSessionFactoryBuilder().build(io) æ¥æ„å»ºå‡ºä¸€ä¸ª SqlSessionFactory æ¥, è¿™é‡Œæ„å»ºå‡ºæ¥çš„ SqlSessionFactory è‚¯å®šæ˜¯æœ‰å·²ç»è®²é…ç½®æ–‡ä»¶ç»™å…¨éƒ¨åŠ è½½è¿›å»äº†çš„.</li><li>SqlSessionFactory.openSession() ä» SqlSessionFactory ä¸­è·å–ä¸€æ¬¡ä¼šè¯, ç„¶åå¯ä»¥ä»ä¼šè¯ä¸­è·å–å‡ºæ¥å£(BlogMapper)æ¥,è¿™é‡Œæ˜¯ä¸æ˜¯æœ‰ç‚¹å¥½å¥‡,æ˜æ˜è¿™å°±æ˜¯ä¸€ä¸ªæ¥å£,ä¹Ÿæ²¡æœ‰å®ç°ç±»,æ€ä¹ˆå°±å¯ä»¥getå‡ºä¸€ä¸ªæ¥å£å¯¹è±¡æ¥?è·å–å‡ºæ¥å£æ¥,ç„¶åå°±å¯ä»¥è°ƒç”¨æ¥å£ä¸­çš„æ–¹æ³•, æ ¹æ®idæŸ¥è¯¢å‡ºæ•°æ®æ¥.</li></ul><p>å¯ä»¥çœ‹åˆ°,æ ¹æ®ä»å®˜ç½‘å†™çš„ä¸€ä¸ªåˆ—å­,ä»è¡¨é¢æ¥çœ‹,ä»£ç é‡å¹¶ä¸æ˜¯å¾ˆå¤š. æ‰€ä»¥æ¥ä¸‹æ¥ç‚¹å»æºç ,å»è·Ÿè¿›æºç ä¸­çš„æ¯ä¸ªæ–¹æ³•,åˆ°åº•åšäº†äº›ä»€ä¹ˆäº‹æƒ….</p><p><strong>è¯»å–é…ç½®æ–‡ä»¶</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">InputStream mybatisInputStream = Resources.getResourceAsStream(&quot;mybatis-config.xml&quot;);</span><br></pre></td></tr></table></figure><p>org.apache.ibatis.io.Resources (Class).</p><p>å¯ä»¥çœ‹åˆ°MyBatisæºç è¿˜å†™äº†ä¸€ä¸ª ClassLoaderçš„åŒ…è£…ç±»ï¼Œé€šè¿‡ClassLoaderWrapperåŒ…è£…ç±»æ¥è®²é…ç½®æ–‡ä»¶è½¬åŒ–ä¸ºInputSream.</p><p>å¦‚æœè¿”å›çš„InputStreamæ˜¯nullï¼Œå°±ä¼šæŠ›å‡ºIOExceptionæ¥.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Returns a resource on the classpath as a Stream object</span><br><span class="line"> *</span><br><span class="line"> * @param loader   The classloader used to fetch the resource</span><br><span class="line"> * @param resource The resource to find</span><br><span class="line"> * @return The resource</span><br><span class="line"> * @throws java.io.IOException If the resource cannot be found or read</span><br><span class="line"> */</span><br><span class="line">private static ClassLoaderWrapper classLoaderWrapper = new ClassLoaderWrapper();</span><br><span class="line"></span><br><span class="line">public static InputStream getResourceAsStream(ClassLoader loader, String resource) throws IOException &#123;</span><br><span class="line">  // åˆ©ç”¨ ClasssLoaderWrapper.  </span><br><span class="line">  InputStream in = classLoaderWrapper.getResourceAsStream(resource, loader);</span><br><span class="line">  if (in == null) &#123;</span><br><span class="line">    throw new IOException(&quot;Could not find resource &quot; + resource);</span><br><span class="line">  &#125;</span><br><span class="line">  return in;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>äºæ˜¯æˆ‘ä»¬æ¥ç€çœ‹ ClassLoaderWrapper æ˜¯æ€ä¹ˆ è¯»å–é…ç½®æ–‡ä»¶ &amp; è½¬åŒ–ä¸º InputStream æµçš„.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">// è¿™é‡Œè¿”å›çš„æ˜¯ ClassLoaderçš„æ•°ç»„,å¦‚æœå¯¹ClassLoaderä¸æ˜¯å¾ˆäº†è§£çš„è¯,å¯ä»¥å…ˆå»ç™¾åº¦äº†è§£ä¸‹.</span><br><span class="line">ClassLoader[] getClassLoaders(ClassLoader classLoader) &#123;</span><br><span class="line">  return new ClassLoader[]&#123;</span><br><span class="line">      // ä¼ é€’è¿›æ¥çš„ </span><br><span class="line">      classLoader,</span><br><span class="line">      // é»˜è®¤çš„ ClassLoader</span><br><span class="line">      defaultClassLoader,</span><br><span class="line">      // æ ¹æ®å½“å‰çº¿ç¨‹è·å–å‡ºæ¥çš„</span><br><span class="line">      Thread.currentThread().getContextClassLoader(),</span><br><span class="line">      // æ ¹æ®å½“å‰ Class è·å–å‡ºæ¥çš„.</span><br><span class="line">      getClass().getClassLoader(),</span><br><span class="line">      // ç³»ç»Ÿçš„ClassLoader.</span><br><span class="line">      systemClassLoader&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// è·å–åˆ°äº† classLoaderçš„æ•°ç»„,ç„¶åå¯¹å…¶è¿›è¡Œè¿­ä»£.</span><br><span class="line">// ä¹Ÿå°±æ˜¯ä½¿ç”¨ ClassLoaderçš„  getResourceAsStream æ–¹æ³•,æ¥è®² mybatis-config.xml</span><br><span class="line">// é…ç½®æ–‡ä»¶è½¬åŒ–ä¸º InputStream.</span><br><span class="line">// æœ€åå¦‚æœè·å–åˆ°InputStreaméƒ½æ˜¯nullçš„è¯,é‚£ä¹ˆè¿”å›çš„ä¹Ÿå°±æ˜¯nulläº†.</span><br><span class="line">// æ ¹æ®ä¸Šé¢çš„è¯´æ³•,è¿”å›çš„å¦‚æœæ˜¯nullçš„è¯,å°±ä¼šå‡º IOExceptionæ¥.</span><br><span class="line">InputStream getResourceAsStream(String resource, ClassLoader[] classLoader) &#123;</span><br><span class="line">    for (ClassLoader cl : classLoader) &#123;</span><br><span class="line">      if (null != cl) &#123;</span><br><span class="line"></span><br><span class="line">        // try to find the resource as passed</span><br><span class="line">        InputStream returnValue = cl.getResourceAsStream(resource);</span><br><span class="line"></span><br><span class="line">        // now, some class loaders want this leading &quot;/&quot;, so we&#x27;ll add it and try again if we didn&#x27;t find the resource</span><br><span class="line">        if (null == returnValue) &#123;</span><br><span class="line">          returnValue = cl.getResourceAsStream(&quot;/&quot; + resource);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (null != returnValue) &#123;</span><br><span class="line">          return returnValue;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return null;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p><strong>è‡³æ­¤,MyBatisè¯»å– mybatis-config.xml é…ç½®æ–‡ä»¶ä¹Ÿå°±æ˜¯è§£æå®Œæ¯•,å¯ä»¥çœ‹åˆ°é‡‡ç”¨äº†è‡ªå·±å†™çš„ ClassLoaderWrapperæ¥æ“ä½œçš„, ä¼ é€’ä¸€ç§ ClassLoaderè¿›æ¥,å…¶é»˜è®¤çš„&amp;ç³»ç»Ÿ&amp;çº¿ç¨‹çš„,åŠ ä¸€èµ·ä¹Ÿæ˜¯æœ‰å››ç§. æœ€åæŒ¨ä¸ªè¿›æ¥è¿­ä»£ï¼Œæ»¡è¶³æ¡ä»¶çš„ä¼šè¯»å–æ–‡ä»¶è½¬åŒ–ä¸ºInputStream,å¦‚æœéƒ½æ˜¯nullçš„è¯,ä¹Ÿä¼šè¿”å›null.</strong></p><hr><p><strong>è·å–SqlSessionFactory &amp; è§£æé…ç½®æ–‡ä»¶</strong></p><p>new SqlSessionFactoryBuilder() ä¹Ÿæ˜¯newäº†ä¸€ä¸ª SqlSessionFactoryBuild,ä¸ªäººç†è§£ SqlSessionFactoryBuilder å°±æ˜¯ä¸“ç¨‹ç”¨æ¥æ„å»ºå‡º SqlSessionFactory æ¥çš„,æ¯•ç«Ÿå…¶åé¢æœ‰ä¸€ä¸ª build æ–¹æ³•.</p><p>Problem ? è¿™é‡Œæœ‰ä¸ªé—®é¢˜,ä¸ºä»€ä¹ˆä¸å°† SqlSessionFactoryBuilder çš„build æ–¹æ³•,ä¿®æ”¹ä¸ºé™æ€çš„ ? å¦‚æœä¿®æ”¹ä¸ºé™æ€çš„è¯ï¼Œé‚£å°±ä¸ç”¨newäº†,å°±å¯ä»¥ç›´æ¥ SqlSessionFactoryBuilder.build(mybatisInputStream);</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SqlSessionFactory sqlSessionFactory = new                     SqlSessionFactoryBuilder().build(mybatisInputStream);</span><br></pre></td></tr></table></figure><p><strong>SqlSessionFactory</strong></p><p>æ¥ç€æˆ‘ä»¬æ¥åˆ° SqlSessionFactory çš„ build æ–¹æ³•.</p><p>è¿™é‡Œåœ¨ finnaly ä¸­, å¯ä»¥çœ‹åˆ° ErrorContext åˆ©ç”¨äº† ThreadLocal , åˆšå¥½è¿™å‘¨å‡ºäº† ThreadLocal çš„è§†é¢‘.</p><p>è§†é¢‘åœ°å€ : <a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1Ga4y1W72w">https://www.bilibili.com/video/BV1Ga4y1W72w</a></p><p>æœ‰å…´è¶£&amp;ä¹äºå­¦ä¹ &amp;åˆ†äº«çš„,å¯ä»¥å…±åŒè¿›æ­¥.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public SqlSessionFactory build(InputStream inputStream, String environment, Properties properties) &#123;</span><br><span class="line">  try &#123;</span><br><span class="line">    // åˆ©ç”¨ä¼ å…¥è¿›æ¥çš„å‚æ•°,newå‡ºæ¥äº†ä¸€ä¸ª XMLConfigBuilder.</span><br><span class="line">    XMLConfigBuilder parser = new XMLConfigBuilder(inputStream, environment, properties);</span><br><span class="line">    return build(parser.parse());</span><br><span class="line">  &#125; catch (Exception e) &#123;</span><br><span class="line">    throw ExceptionFactory.wrapException(&quot;Error building SqlSession.&quot;, e);</span><br><span class="line">  &#125; finally &#123;</span><br><span class="line">    // è¿™é‡Œå¯¹ ThreadLocal ä¸­è¿›è¡Œ remove() æ“ä½œ   </span><br><span class="line">    ErrorContext.instance().reset();</span><br><span class="line">    try &#123;</span><br><span class="line">      // å…³é—­æµ.  </span><br><span class="line">      inputStream.close();</span><br><span class="line">    &#125; catch (IOException e) &#123;</span><br><span class="line">      // Intentionally ignore. Prefer previous error.</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>new XmlConfigBuilder() æ–¹æ³•:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line">public XMLConfigBuilder(InputStream inputStream, String environment, Properties props) &#123;</span><br><span class="line">  // å…ˆnewä¸€ä¸ªXMLMapperEntityResolver,å†newä¸€ä¸ªXPathParser,ç„¶åå°±èµ°åˆ°ä¸‹é¢çš„æ„é€ å‡½æ•°.</span><br><span class="line">  this(new XPathParser(inputStream, true, props, new XMLMapperEntityResolver()), environment, props);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// æœ€åè¿˜æ˜¯èµ°åˆ°è¿™ä¸ªæ„é€ æ–¹æ³•ä¸­æ¥.</span><br><span class="line">private XMLConfigBuilder(XPathParser parser, String environment, Properties props) &#123;</span><br><span class="line">  super(new Configuration());</span><br><span class="line">  ErrorContext.instance().resource(&quot;SQL Mapper Configuration&quot;);</span><br><span class="line">  this.configuration.setVariables(props);</span><br><span class="line">  this.parsed = false;</span><br><span class="line">  this.environment = environment;</span><br><span class="line">  this.parser = parser;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">----------------------------------------</span><br><span class="line">// new XPathParserä»£ç :</span><br><span class="line">    </span><br><span class="line">  public XPathParser(InputStream inputStream, boolean validation, Properties variables, EntityResolver entityResolver) &#123;</span><br><span class="line">    // æ™®é€šçš„æ„é€ æ–¹æ³•.</span><br><span class="line">    // å¯¹ XPathParserçš„validation/entityResolver/variables/xpath</span><br><span class="line">    // çš„å±æ€§è¿›è¡Œèµ‹å€¼æ“ä½œ.</span><br><span class="line">    commonConstructor(validation, variables, entityResolver);</span><br><span class="line">    this.document = createDocument(new InputSource(inputStream));</span><br><span class="line">  &#125;    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// createDocument æ–¹æ³•</span><br><span class="line">  private Document createDocument(InputSource inputSource) &#123;</span><br><span class="line">    // important: this must only be called AFTER common constructor</span><br><span class="line">    try &#123;</span><br><span class="line">      // è¿™é‡Œé€šè¿‡debugçœ‹,è¿”å›çš„å¯¹è±¡æ˜¯DocumentBuilderFactoryImpl</span><br><span class="line">      // ä¹Ÿå°±æ˜¯å…¶å®ç°ç±».  </span><br><span class="line">      DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();</span><br><span class="line">     // å¯¹ factory çš„ features(HashMap) æ·»åŠ å€¼,   </span><br><span class="line">      factory.setFeature(XMLConstants.FEATURE_SECURE_PROCESSING, true);</span><br><span class="line">     // å¯¹ factory çš„ validating è¿›è¡Œèµ‹å€¼  </span><br><span class="line">      factory.setValidating(validation);</span><br><span class="line">	 // è¿™ä¸‹é¢éƒ½æ˜¯å¯¹ factoryçš„å±æ€§è¿›è¡Œèµ‹å€¼æ“ä½œ.	</span><br><span class="line">      factory.setNamespaceAware(false);</span><br><span class="line">      factory.setIgnoringComments(true);</span><br><span class="line">      factory.setIgnoringElementContentWhitespace(false);</span><br><span class="line">      factory.setCoalescing(false);</span><br><span class="line">      factory.setExpandEntityReferences(true);</span><br><span class="line">		</span><br><span class="line">      // å¯ä»¥çœ‹åˆ° return new DocumentBuilderImpl</span><br><span class="line">      // æœ€åè¿”å›çš„ä¹Ÿæ˜¯å…¶å®ç°ç±». </span><br><span class="line">      DocumentBuilder builder = factory.newDocumentBuilder();</span><br><span class="line">      builder.setEntityResolver(entityResolver);</span><br><span class="line">      // è®¾ç½®é”™è¯¯çš„handler,å¯ä»¥çœ‹åˆ°ErrorHandleræ˜¯æ¥å£,è¿™é‡Œæ˜¯åŒ¿åå®ç°çš„</span><br><span class="line">      // ä¹Ÿå°±æ˜¯ç›´æ¥newäº†æ¥å£,ç„¶åé‡å†™å…¶æ–¹æ³•.  </span><br><span class="line">      builder.setErrorHandler(new ErrorHandler() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void error(SAXParseException exception) throws SAXException &#123;</span><br><span class="line">          throw exception;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void fatalError(SAXParseException exception) throws SAXException &#123;</span><br><span class="line">          throw exception;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void warning(SAXParseException exception) throws SAXException &#123;</span><br><span class="line">          // NOP</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">      //   DocumentBuilderImpl çš„ parse è§£ææ–¹æ³•</span><br><span class="line">      return builder.parse(inputSource);</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">      throw new BuilderException(&quot;Error creating document instance.  Cause: &quot; + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">-------------</span><br><span class="line">//   builder.parse(inputSource)</span><br><span class="line"></span><br><span class="line">    public Document parse(InputSource is) throws SAXException, IOException &#123;</span><br><span class="line">        if (is == null) &#123;</span><br><span class="line">            throw new IllegalArgumentException(</span><br><span class="line">                DOMMessageFormatter.formatMessage(DOMMessageFormatter.DOM_DOMAIN,</span><br><span class="line">                &quot;jaxp-null-input-source&quot;, null));</span><br><span class="line">        &#125;</span><br><span class="line">    // fSchemaValidator æ˜¯ null ,è·³è¿‡.</span><br><span class="line">        if (fSchemaValidator != null) &#123;</span><br><span class="line">            if (fSchemaValidationManager != null) &#123;</span><br><span class="line">                fSchemaValidationManager.reset();</span><br><span class="line">                fUnparsedEntityHandler.reset();</span><br><span class="line">            &#125;</span><br><span class="line">            resetSchemaValidator();</span><br><span class="line">        &#125;</span><br><span class="line">  // ä½¿ç”¨ xml çš„ç›¸å…³ç±»å¯¹ is è¿›è¡Œè§£æ  </span><br><span class="line">        domParser.parse(is);</span><br><span class="line"> //  ?   </span><br><span class="line">        Document doc = domParser.getDocument();</span><br><span class="line"> // ? è¿™äº›è§£æ Document çš„åœ°æ–¹.....   </span><br><span class="line">        domParser.dropDocumentReferences();</span><br><span class="line">        return doc;</span><br><span class="line">    &#125;    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">---------------</span><br><span class="line">// æœ€åçœ‹åˆ° this æ„é€ å‡½æ•°.</span><br><span class="line"></span><br><span class="line">  private XMLConfigBuilder(XPathParser parser, String environment, Properties props) &#123;</span><br><span class="line">    /** new Configuration() ä¸­,TypeAliasRegistry typeAliasRegistryä¸­çš„ typeAliases,</span><br><span class="line">    *   åœ¨åˆå§‹åŒ–è¿™ä¸ªå¯¹è±¡çš„æ—¶å€™,å°±é»˜è®¤è®¾ç½®äº†ä¸€äº›åˆ«åé…ç½®.</span><br><span class="line">    *   åˆå§‹åŒ–çš„æ—¶å€™,è¿˜æœ‰å¯¹ LanguageDriverRegistry çš„ LANGUAGE_DRIVER_MAP èµ‹å€¼.</span><br><span class="line">    *  çˆ¶ç±» :  BaseBuilderæŠ½è±¡ç±».</span><br><span class="line">    *  ç„¶åè°ƒç”¨superæ–¹æ³•,å°†configurationèµ‹å€¼çˆ¶ç±»çš„configuration</span><br><span class="line">    *  åŒæ—¶å°† configurationçš„typeAliasRegistryå’ŒtypeHandlerRegistryä¹Ÿèµ‹å€¼</span><br><span class="line">    *  ç»™å½“å‰çš„è¿™ä¸ªå¯¹è±¡.</span><br><span class="line">    *   </span><br><span class="line">    */</span><br><span class="line">    super(new Configuration());</span><br><span class="line">    // instance() æ–¹æ³•æ˜¯å¾€ ThreadLocalé‡Œé¢å»setäº†ä¸€ä¸ªErrorContext</span><br><span class="line">    // æœ€åä¼šåœ¨finnalyä¸­è¿›è¡Œremoveæ‰.</span><br><span class="line">    ErrorContext.instance().resource(&quot;SQL Mapper Configuration&quot;);</span><br><span class="line">    // å°† props èµ‹å€¼åˆ° configuration çš„ variable å‚æ•°.</span><br><span class="line">    this.configuration.setVariables(props);</span><br><span class="line">    // è¡¨ç¤ºè¿˜æ²¡æœ‰è¢«è§£æ</span><br><span class="line">    this.parsed = false;</span><br><span class="line">    this.environment = environment;</span><br><span class="line">    this.parser = parser;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œ,å°±å¯ä»¥çœ‹åˆ° thisæ„é€ æ–¹æ³•ä»¥åŠå…¶ä¹‹å‰è¿˜æœ‰newå¯¹è±¡çš„æ–¹æ³•,éƒ½å·²ç»èµ°å®Œäº†. è¿™ä¸Šé¢çš„æ–¹æ³•,åŸºæœ¬éƒ½æ˜¯å†ä¸ºåé¢çš„è§£æxmlæ–‡ä»¶åšå‡†å¤‡, å¹¶ä¸”è¿˜æœ‰ä¸€äº›åˆå§‹åŒ–æ•°æ®çš„èµ‹å€¼æ“ä½œ.</p><p><strong>Note</strong> : æ³¨æ„è¿™é‡Œçš„ BaseBuilderæ˜¯æŠ½è±¡ç±»,å…¶å®ç°ç±»æ˜¯æœ‰å¥½å‡ ä¸ªçš„. è¿™ç§å†™æ³•,å…¶å®æ˜¯å°†å­ç±»çš„ä¸€äº›commonçš„æ–¹æ³•,å†™å…¥åˆ° BaseBuilderçˆ¶ç±»ä¸­,ç„¶åä¸åŒçš„æ–¹æ³•,éœ€è¦å­ç±»è‡ªå·±å»é‡å†™è¿™ä¸ªæ–¹æ³•å®ç°è‡ªå·±çš„ä¸šåŠ¡é€»è¾‘. å½“ç„¶ä¸€äº›å‚æ•°ä¹Ÿæ˜¯å¯ä»¥æ”¾åœ¨æŠ½è±¡ç±»ä¸­.</p><p><strong>build(parser.parse())</strong> : è§£æä»£ç .</p><p>parser.parse() æ–¹æ³• :</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">public Configuration parse() &#123;</span><br><span class="line">  // ç”¨ parsed æ¥æ§åˆ¶æ˜¯å¦è§£æè¿‡,å¦‚æœå·²ç»è§£æè¿‡äº†,é‚£å°±æŠ›å‡ºå¼‚å¸¸.  </span><br><span class="line">  if (parsed) &#123;</span><br><span class="line">    throw new BuilderException(&quot;Each XMLConfigBuilder can only be used once.&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">  parsed = true;</span><br><span class="line">  //   </span><br><span class="line">  parseConfiguration(parser.evalNode(&quot;/configuration&quot;));</span><br><span class="line">  return configuration;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">---------------------------------</span><br><span class="line">// parseConfiguration</span><br><span class="line">// è¿™é‡Œ debug å¯ä»¥çœ‹åˆ° root æ˜¯ configuration çš„é…ç½®æ–‡ä»¶ä¿¡æ¯.   </span><br><span class="line">// è¿™é‡Œå¯ä»¥åˆæ­¥çœ‹åˆ°å®å¯¹ æˆ‘ä»¬çš„é…ç½®æ–‡ä»¶mybatis-config.xmlè¿›è¡Œè§£æ,å¹¶ä¸”åŠ è½½åˆ° configurationä¸­.</span><br><span class="line">// åé¢æˆ‘ä»¬è·Ÿç€å®˜ç½‘æ–‡æ¡£ä¸€æ­¥ä¸€æ­¥çš„é˜…è¯»,ä¼šæœ‰ä¸“é—¨å¯¹è§£æé…ç½®çš„æºç è¿›è¡Œåˆ†æ.    </span><br><span class="line">  private void parseConfiguration(XNode root) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">      //issue #117 read properties first</span><br><span class="line">      //   </span><br><span class="line">      propertiesElement(root.evalNode(&quot;properties&quot;));</span><br><span class="line">      Properties settings = settingsAsProperties(root.evalNode(&quot;settings&quot;));</span><br><span class="line">      loadCustomVfs(settings);</span><br><span class="line">      loadCustomLogImpl(settings);</span><br><span class="line">      typeAliasesElement(root.evalNode(&quot;typeAliases&quot;));</span><br><span class="line">      pluginElement(root.evalNode(&quot;plugins&quot;));</span><br><span class="line">      objectFactoryElement(root.evalNode(&quot;objectFactory&quot;));</span><br><span class="line">      objectWrapperFactoryElement(root.evalNode(&quot;objectWrapperFactory&quot;));</span><br><span class="line">      reflectorFactoryElement(root.evalNode(&quot;reflectorFactory&quot;));</span><br><span class="line">      settingsElement(settings);</span><br><span class="line">      // read it after objectFactory and objectWrapperFactory issue #631</span><br><span class="line">      environmentsElement(root.evalNode(&quot;environments&quot;));</span><br><span class="line">      databaseIdProviderElement(root.evalNode(&quot;databaseIdProvider&quot;));</span><br><span class="line">      typeHandlerElement(root.evalNode(&quot;typeHandlers&quot;));</span><br><span class="line">      mapperElement(root.evalNode(&quot;mappers&quot;));</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">      throw new BuilderException(&quot;Error parsing SQL Mapper Configuration. Cause: &quot; + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p><strong>build(parser.parse()) æ–¹æ³•</strong></p><p>è¿™é‡Œæ˜¯å¯¹ parser.parse() è°ƒç”¨ç©è¿”å›çš„ Configuration ä¼ å…¥åˆ°æ–°åˆ›å»ºçš„ DefaultSqlSessionFactory å¯¹è±¡ä¸­.</p><p>ä¹Ÿå°±æ˜¯è¯´,æˆ‘ä»¬æ‹¿åˆ°çš„ SqlSessionFactory æ˜¯ DefaultSqlSessionFactory.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public SqlSessionFactory build(Configuration config) &#123;</span><br><span class="line">  return new DefaultSqlSessionFactory(config);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è·å– SqlSession</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">SqlSession session = sqlSessionFactory.openSession();</span><br><span class="line"></span><br><span class="line">// org.apache.ibatis.session.defaults.DefaultSqlSessionFactory#openSessionFromDataSource</span><br><span class="line">// çœ‹åˆ°è¿™ä¸ªæ–¹æ³•,ç›´æ¥è·Ÿè¿›åˆ°è¿™ä¸ªæ–¹æ³•æ¥.</span><br><span class="line"></span><br><span class="line">  private SqlSession openSessionFromDataSource(ExecutorType execType, TransactionIsolationLevel level, boolean autoCommit) &#123;</span><br><span class="line">    Transaction tx = null;</span><br><span class="line">    try &#123;</span><br><span class="line">        </span><br><span class="line">// ä» configurationä¸­è·å–å‡ºenvironmentæ¥,è¿™é‡Œçš„ getEnvironmentå¯¹åº”çš„æ˜¯</span><br><span class="line">// æ ‡ç­¾çš„ &lt;environment&gt;  é‡Œé¢çš„å†…å®¹</span><br><span class="line">// org.apache.ibatis.mapping.Environment</span><br><span class="line">// å¯ä»¥çœ‹åˆ°è¿™ä¸ªå¯¹è±¡,idå¯¹åº”mybatis-config.xmlä¸­çš„environment id</span><br><span class="line">// datasource å¯¹åº”  environment &gt; dataSource å­—æ®µ.</span><br><span class="line">      final Environment environment = configuration.getEnvironment();</span><br><span class="line">// æ ¹æ®    environment æ¥è·å– TransactionFactory,ä¹Ÿå°±æ˜¯MyBatisçš„äº‹åŠ¡å·¥å‚.</span><br><span class="line">// debug æ˜¯å¯ä»¥çœ‹åˆ°  environment ä¸­æ˜¯æœ‰ä¸€ä¸ªJdbcTransactionFactoryçš„,</span><br><span class="line">// å¦‚æœæ²¡ç”¨çš„è¯,å°±ä¼šè‡ªå·±newä¸€ä¸ª ManagedTransactionFactory æ¥.        </span><br><span class="line">      final TransactionFactory transactionFactory = getTransactionFactoryFromEnvironment(environment);</span><br><span class="line"></span><br><span class="line">// åœ¨ JdbcTransactionFactory ä¸­newå‡ºäº†ä¸€ä¸ª JdbcTransaction</span><br><span class="line">// ä¹Ÿå°±æ˜¯newäº†ä¸€ä¸ªJDBCäº‹åŠ¡.</span><br><span class="line">// org.apache.ibatis.transaction.jdbc.JdbcTransaction,</span><br><span class="line">// å¯ä»¥çœ‹åˆ° JdbcTransaction ä¸­æœ‰commit / rollbackçš„æ–¹æ³•,</span><br><span class="line">// ä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªåœ°æ–¹å°±æ˜¯å¯¹äº‹åŠ¡è¿›è¡Œæ“ä½œçš„åœ°æ–¹        </span><br><span class="line">      tx = transactionFactory.newTransaction(environment.getDataSource(), level, autoCommit);</span><br><span class="line">// è¿™é‡Œæ˜¯è·å–æ˜¯æ‰§è¡Œå™¨,</span><br><span class="line">// å…·ä½“ä»£ç : org.apache.ibatis.session.Configuration#newExecutor(org.apache.ibatis.transaction.Transaction, org.apache.ibatis.session.ExecutorType)</span><br><span class="line">// è¿™é‡Œæœ‰ SIMPLE, REUSE, BATCH ,CachingExecutor è¿˜å¯ä»¥åœ¨ plugin ä¸­è‡ªå·±å®šä¹‰.</span><br><span class="line">//executor = (Executor) interceptorChain.pluginAll(executor); ä»è¿™è¡Œä»£ç å¯ä»¥çœ‹åˆ°,</span><br><span class="line">// å…¶å®è¿˜æ˜¯å¯ä»¥è‡ªå·±æ‰©å±•çš„.        </span><br><span class="line">//org.apache.ibatis.plugin.InterceptorChain        </span><br><span class="line">      final Executor executor = configuration.newExecutor(tx, execType);</span><br><span class="line">// æœ€å new å‡ºäº†ä¸€ä¸ªé»˜è®¤çš„ SqlSession ä¼šè¯.</span><br><span class="line">// è¯¥ä¼šè¯ä¸­å­˜æœ‰ configuration / executor ç­‰æ ¸å¿ƒä¸œè¥¿.        </span><br><span class="line">      return new DefaultSqlSession(configuration, executor, autoCommit);</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">      closeTransaction(tx); // may have fetched a connection so lets call close()</span><br><span class="line">      throw ExceptionFactory.wrapException(&quot;Error opening session.  Cause: &quot; + e, e);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">// æœ€åè¿˜æ˜¯ä¸å¿˜è®°å¯¹ä½¿ç”¨è¿‡çš„ThreadLocal è¿›è¡Œremove æ“ä½œ.        </span><br><span class="line">      ErrorContext.instance().reset();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>è‡³æ­¤, å¯ä»¥çœ‹åˆ° MyBatis ä»SqlSessionFactoryä¸­è·å–å‡ºæ¥SqlSessionä¼šè¯, ä¹Ÿå¯ä»¥ç†è§£ä¸ºå‡ ä¸ªæ­¥éª¤.</p><p>é¦–å…ˆè·å–äº‹åŠ¡å·¥å‚, ç„¶åå†ä»äº‹åŠ¡å·¥å‚ä¸­è·å–ä¸€ä¸ªäº‹åŠ¡æ¥, JdbcTransaction æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥çœ‹ä¸‹è¿™ä¸ªç±»,é‡Œé¢ä¹Ÿæ˜¯å°è£…äº†å†™ commit &#x2F; rollbackç­‰æ–¹æ³•. å†æ¥ç€è·å–å‡º æ‰§è¡Œå™¨(Executor),è¿™é‡Œä»ä»£ç å“ªé‡Œçœ‹,æ‰§è¡Œå™¨è¿˜æ˜¯æœ‰å‡ ç§ç±»å‹çš„,ä¹Ÿæ‰§è¡Œè‡ªå®šä¹‰. æœ€ånewäº†ä¸€ä¸ª DefaultSqlSession å›å».</p><p><strong>session.getMapper(BlogMapper.class);</strong></p><p>æ¥ç€çœ‹,ä¸Šä¸€æ­¥è¿”å›çš„session,æ˜¯æ€ä¹ˆè·å–åˆ°æˆ‘ä»¬å†™çš„Mapperæ¥å£æ–‡ä»¶(Mapperè¿™ç§æ–‡ä»¶,åœ¨è§£æé…ç½®æ–‡ä»¶çš„æ—¶å€™,å…¶å®å°±å·²ç»è§£æåˆ°MyBatisçš„configurationé‡Œé¢å»äº†).</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">@SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">public &lt;T&gt; T getMapper(Class&lt;T&gt; type, SqlSession sqlSession) &#123;</span><br><span class="line"> // knownMappers  ä¸­ key æ˜¯æˆ‘ä»¬å®šä¹‰æ¥å£çš„Class,valueæ˜¯MapperProxyFactory,</span><br><span class="line">// MapperProxyFactoryä¸­çš„mapperInterfaceä¸­å­˜æ”¾äº†æˆ‘ä»¬çš„æ¥å£class    </span><br><span class="line">  final MapperProxyFactory&lt;T&gt; mapperProxyFactory = (MapperProxyFactory&lt;T&gt;) knownMappers.get(type);</span><br><span class="line">    </span><br><span class="line">// å¦‚æœè·å–å‡ºæ¥çš„æ˜¯null,é‚£ä¹ˆMyBatiså°±è®¤ä¸ºä½ ä¼ å…¥è¿›æ¥çš„æ¥å£æ˜¯ä¸å­˜åœ¨çš„,å°±ä¼šæŠ›å‡ºå¼‚å¸¸æ¥.    </span><br><span class="line">  if (mapperProxyFactory == null) &#123;</span><br><span class="line">    throw new BindingException(&quot;Type &quot; + type + &quot; is not known to the MapperRegistry.&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">  try &#123;</span><br><span class="line">// æ»¡è¶³æ¡ä»¶çš„è¯,è°ƒç”¨newInstanceæ–¹æ³•,ä»æ–¹æ³•åå­—ä¸Šçœ‹,æ˜¯åˆ›å»ºä¸€ä¸ªinstanceçš„å®ä¾‹.      </span><br><span class="line">    return mapperProxyFactory.newInstance(sqlSession);</span><br><span class="line">  &#125; catch (Exception e) &#123;</span><br><span class="line">    throw new BindingException(&quot;Error getting mapper instance. Cause: &quot; + e, e);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-------------------------------------------</span><br><span class="line">// mapperProxyFactory.newInstance(sqlSession) ä»£ç </span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">  public T newInstance(SqlSession sqlSession) &#123;</span><br><span class="line">    // new äº†ä¸€ä¸ª MapperProxyå¯¹è±¡.</span><br><span class="line">    final MapperProxy&lt;T&gt; mapperProxy = new MapperProxy&lt;&gt;(sqlSession, mapperInterface, methodCache);</span><br><span class="line">    return newInstance(mapperProxy);</span><br><span class="line">  &#125;    </span><br><span class="line"></span><br><span class="line">// æœ€åå¯ä»¥çœ‹åˆ°ä½¿ç”¨ Proxy.newProxyInstanceæ–¹æ³•æ¥åˆ›å»ºçš„ä¸€ä¸ªå¯¹è±¡.</span><br><span class="line">  @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">  protected T newInstance(MapperProxy&lt;T&gt; mapperProxy) &#123;</span><br><span class="line">    return (T) Proxy.newProxyInstance(mapperInterface.getClassLoader(), new Class[] &#123; mapperInterface &#125;, mapperProxy);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-------</span><br><span class="line">// å¦‚æœä½ æ˜¯debugæ¨¡å¼çš„è¯,é‚£ä¹ˆä½ å¯ä»¥çœ‹åˆ°BlogMapperçš„å¯¹è±¡åœ°å€æ± åœ¨ debug ä¸­æ˜¾ç¤ºçš„å€¼.</span><br><span class="line">// org.apache.ibatis.binding.MapperProxy@ef9296d    </span><br><span class="line">BlogMapper blogMapper = session.getMapper(BlogMapper.class);</span><br></pre></td></tr></table></figure><p>ä»SqlSession ä¸­è·å– BlogMapperæˆ‘ä»¬å†™çš„mapperæµç¨‹, å…ˆä» knownMappers ä¸­æ ¹æ®keyè·å–å‡ºæ¥ä¹‹å‰åŠ è½½é…ç½®å·²ç»åŠ è½½å®Œæ¯•çš„ä¿¡æ¯,å¦‚æœæ²¡ç”¨çš„è¯,å°±ä¼šæŠ›å‡ºæ²¡æœ‰çš„å¼‚å¸¸. æœ€åä½¿ç”¨ Proxy.newProxyIntsanceæ¥ç”Ÿæˆçš„ä¸€ä¸ªç±»ä¼¼æ¥å£å®ç°ç±»çš„ä»£ç ,ä¸åŒçš„æ˜¯, åœ¨ new MapperProxy çš„æ—¶å€™,å°±å·²ç»å°†æ¥ä¸‹æ¥éœ€è¦çš„ä¿¡æ¯å…¨éƒ¨ä¼ å…¥è¿›å».</p><p><strong>blogMapper.selectBlog(1) æ–¹æ³•</strong></p><p>ç«Ÿç„¶ BlogMapperæ˜¯é€šè¿‡Proxy.newInstanceè·å–å‡ºæ¥çš„,é‚£å®ƒæ˜¯æ€ä¹ˆæŸ¥è¯¢çš„æ•°æ®åº“? åˆæ˜¯æ€ä¹ˆå°†å­—æ®µç»™æ˜ å°„åˆ° Objectä¸€ä¸€å¯¹åº”çš„å‘¢ ?</p><p>debugä¼šèµ°åˆ° MapperProxyçš„invokeæ–¹æ³•æ¥</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123;</span><br><span class="line">  try &#123;</span><br><span class="line">    if (Object.class.equals(method.getDeclaringClass())) &#123;</span><br><span class="line">      return method.invoke(this, args);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      return cachedInvoker(method).invoke(proxy, method, args, sqlSession);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; catch (Throwable t) &#123;</span><br><span class="line">    throw ExceptionUtil.unwrapThrowable(t);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">------------------</span><br><span class="line">// é€šè¿‡ invoke æ–¹æ³•, èµ° mapperMethodçš„executeæ–¹æ³•,æ¥åˆ°äº†è¿™é‡Œ.</span><br><span class="line">// switch æœ‰ INSERT/UPDATE/DELETE/SELECT/FLUSH,å¦‚æœè¿™å‡ ç§æ²¡æœ‰åŒ¹é…åˆ°çš„è¯,å°±ä¼šæŠ›å‡ºå¼‚å¸¸æ¥.    </span><br><span class="line">  public Object execute(SqlSession sqlSession, Object[] args) &#123;</span><br><span class="line">    Object result;</span><br><span class="line">    switch (command.getType()) &#123;</span><br><span class="line">            </span><br><span class="line">// ä¸éš¾çœ‹åˆ° INSERT/UPDATE/DELETEéƒ½æ˜¯å…ˆè°ƒç”¨ convertArgsToSqlCommandParam æ–¹æ³•,</span><br><span class="line">// ä¹Ÿå°±æ˜¯å…ˆå°†å‚æ•°è½¬åŒ–ä¸ºsql,ç„¶åå°†æ‰§è¡Œçš„ç»“æœ èµ‹å€¼ ç»™ result å‚æ•°.            </span><br><span class="line">      case INSERT: &#123;</span><br><span class="line">        Object param = method.convertArgsToSqlCommandParam(args);</span><br><span class="line">        result = rowCountResult(sqlSession.insert(command.getName(), param));</span><br><span class="line">        break;</span><br><span class="line">      &#125;</span><br><span class="line">      case UPDATE: &#123;</span><br><span class="line">        Object param = method.convertArgsToSqlCommandParam(args);</span><br><span class="line">        result = rowCountResult(sqlSession.update(command.getName(), param));</span><br><span class="line">        break;</span><br><span class="line">      &#125;</span><br><span class="line">      case DELETE: &#123;</span><br><span class="line">        Object param = method.convertArgsToSqlCommandParam(args);</span><br><span class="line">        result = rowCountResult(sqlSession.delete(command.getName(), param));</span><br><span class="line">        break;</span><br><span class="line">      &#125;</span><br><span class="line">// å¦‚æœæ˜¯ select è¯­å¥,å¯ä»¥æ ¹æ®è¿”å›å€¼æ¥åˆ†ç±»,å¦‚æœæ˜¯void&amp;&amp;method.hasResultHandler,å°±ä¼šè¿”å›null</span><br><span class="line">// å¤šä¸ª / Mapç±»å‹  /    Cursor ç±»å‹   /  æœ€åæŸ¥è¯¢ä¸€ä¸ª        </span><br><span class="line">      case SELECT:</span><br><span class="line">        if (method.returnsVoid() &amp;&amp; method.hasResultHandler()) &#123;</span><br><span class="line">          executeWithResultHandler(sqlSession, args);</span><br><span class="line">          result = null;</span><br><span class="line">        &#125; else if (method.returnsMany()) &#123;</span><br><span class="line">          result = executeForMany(sqlSession, args);</span><br><span class="line">        &#125; else if (method.returnsMap()) &#123;</span><br><span class="line">          result = executeForMap(sqlSession, args);</span><br><span class="line">        &#125; else if (method.returnsCursor()) &#123;</span><br><span class="line">          result = executeForCursor(sqlSession, args);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          Object param = method.convertArgsToSqlCommandParam(args);</span><br><span class="line">          result = sqlSession.selectOne(command.getName(), param);</span><br><span class="line">          if (method.returnsOptional()</span><br><span class="line">              &amp;&amp; (result == null || !method.getReturnType().equals(result.getClass()))) &#123;</span><br><span class="line">            result = Optional.ofNullable(result);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        break;</span><br><span class="line"> // åˆ·æ–°ä¼šè¯.           </span><br><span class="line">      case FLUSH:</span><br><span class="line">        result = sqlSession.flushStatements();</span><br><span class="line">        break;</span><br><span class="line">      default:</span><br><span class="line">        throw new BindingException(&quot;Unknown execution method for: &quot; + command.getName());</span><br><span class="line">    &#125;</span><br><span class="line">// å¦‚æœresult æ˜¯ null, æ–¹æ³•è¿”å›çš„ä¿®é¥°ç¬¦æ˜¯privateå¹¶ä¸” è¿”å›å€¼ä¸æ˜¯voidçš„è¯,å°±ä¼šæŠ›å‡ºå¼‚å¸¸.    </span><br><span class="line">    if (result == null &amp;&amp; method.getReturnType().isPrimitive() &amp;&amp; !method.returnsVoid()) &#123;</span><br><span class="line">      throw new BindingException(&quot;Mapper method &#x27;&quot; + command.getName()</span><br><span class="line">          + &quot; attempted to return null from a method with a primitive return type (&quot; + method.getReturnType() + &quot;).&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    return result;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°,å…ˆæ˜¯å¯¹ INSERT &#x2F; UPDATE &#x2F; DELETE &#x2F; SELECT è¿›è¡Œåˆ†ç±»å¤„ç†, ç„¶åå¯¹å†åˆ†åˆ«æ ¹æ®ä¸åŒçš„ç±»å‹è¿›è¡Œå¤„ç†. éƒ½æ˜¯å…ˆæœ‰è½¬åŒ–ä¸ºsql,ç„¶åå°†æ‰§è¡Œç»“æœèµ‹å€¼ç»™result.</p><p>è‡³äºé‡Œé¢è¯¦ç»†çš„æŸ¥è¯¢æ‰§è¡Œsql,è¿˜æœ‰åŠ¨æ€sql,æ¯æ¬¡ä¼šè¯ç¼“å­˜ç­‰,åé¢çœ‹åˆ°è¯¦ç»†çš„æƒ…å†µå†ä¸€ä¸€è¯´æ˜. è¿™é‡Œåªæ˜¯å¯¹MyBatisçš„åŸºæœ¬å·¥ä½œè¿›è¡Œäº†ä¸€ä¸ªæ¢³ç†. ç„¶ååé¢å†æ ¹æ®åŸºç¡€æ¢³ç†,å†æ¥æŒ¨ä¸ªå‡»ç¢ä»–ä»¬.</p><p>è‡³æ­¤, MyBatisçš„å…¥é—¨åˆ†ææµç¨‹æ˜¯ç»“æŸçš„. ç†è§£èµ·æ¥,åº”è¯¥è¿˜ä¸æ˜¯é‚£ä¹ˆéš¾.</p><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>æ ¹æ® com.iyang.mybatis.InitHelloMyBatis , ä¹Ÿå°±æ˜¯å…¥é—¨çš„demoæ¥æ¢³ç†ä¸‹æµç¨‹.</p><ol><li>è¯»å–é…ç½®æ–‡ä»¶,ä¹Ÿå°±æ˜¯å°†é…ç½®æ–‡ä»¶è¯»å–,è½¬åŒ–ä¸ºinptStreamæµ.</li><li>åˆ©ç”¨ SqlSessionFactoryBuilder æ¥ è§£ææµ, èµ·å†…éƒ¨åˆåˆ©ç”¨ BaseBuilder(å…¶åˆå¾ˆå¤šå®ç°ç±»,è¿™é‡Œç”¨çš„XMLConfigBuilder)ä¹Ÿè§£æxmlé…ç½®æ–‡ä»¶. Configuration configuration è¯¥ç±»ä¸­æ˜¯ä¿å­˜ç€xmlé…ç½®æ–‡ä»¶çš„å¾ˆå¤šä¿¡æ¯. ç„¶å DefaultSqlSessionFactory ä¸­æœ‰configurationå­—æ®µ,ä¹Ÿå°±æ˜¯å±æ€§.</li><li>ç„¶åä» DefaultSqlSessionFactory ä¸­è·å– SqlSessionæ¥, å¹¶ä¸”ä¹Ÿä¼šæ˜¯å¦å¼€å¯äº‹åŠ¡(å‚è€ƒ:org.apache.ibatis.transaction.jdbc.JdbcTransaction)ç±»,ç„¶åè·å– Executor,Executorä¹Ÿæ˜¯æœ‰å‡ ç§ç§ç±»çš„,ä¹Ÿå¯ä»¥è‡ªå·±è‡ªå®šä¹‰,æœ€åè¿”å›ä¸€ä¸ª DefaultSqlSession æ¥.</li><li>ç„¶åä» SqlSession ä¸­è·å–æˆ‘ä»¬çš„æ¥å£Mapper, æœ€åä¹Ÿæ˜¯åˆ©ç”¨ Proxy.newProxyInstance æ¥ç”Ÿæˆçš„æ¥å£,ä¹Ÿå°±æ˜¯ä»£ç†(è¿™é‡Œæ‰“å°å‡ºåœ°å€æ± æˆ–è€…debugçœ‹åœ°å€æ± ,å°±ä¼šå¾ˆæ˜æ˜¾çš„çœ‹åˆ°æ˜¯ä»£ç†å¯¹è±¡).</li><li>æœ€åèµ°æŸ¥è¯¢çš„æ–¹æ³•, ä¹Ÿå°±æ˜¯èµ°åˆ°äº† MapperProxy æ¥. å¯ä»¥çœ‹åˆ°MapperProxyé‡Œé¢æ˜¯æœ‰sqlSessionçš„,è€ŒSqlSessionæ˜¯æœ‰ Executor&#x2F;configuration&#x2F;autoCommitç­‰ä¿¡æ¯çš„, æœ‰äº†sqlSession,å°±å‰©ä¸‹æ‰§è¡Œsqlå’Œæ˜ å°„sqlæŸ¥è¯¢å‡ºæ¥çš„ç»“æœæ¥äº†(è¿™é‡Œæ˜¯ mapperMethod.execute(sqlSession, args) â€”&gt; org.apache.ibatis.binding.MapperMethod#execute èµ°åˆ°è¿™é‡Œæ¥äº†,è¿™é‡Œä¹‹åå°±ä¼šåˆ†ç±»è¿›è¡Œå¤„ç†,ç„¶åæ˜ å°„sqlè¯­å¥).</li><li>è‡³æ­¤,ä¸€ä¸ª MyBatis çš„ HelloWorldåˆ†ææµç¨‹æ˜¯å®Œæ¯•çš„.</li></ol></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://ruy9527.github.io/2021/11/04/mybatis/mybatis%E4%B8%ADmapper%E6%96%87%E4%BB%B6%E9%98%85%E8%AF%BB/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/touxiang.jpg"><meta itemprop="name" content="YangBao"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="YangBao"><meta itemprop="description" content="çŸ¥è¯†ç¬”è®°"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | YangBao"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2021/11/04/mybatis/mybatis%E4%B8%ADmapper%E6%96%87%E4%BB%B6%E9%98%85%E8%AF%BB/" class="post-title-link" itemprop="url">mybatisä¸­mapperæ–‡ä»¶é˜…è¯»</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Created: 2021-11-04 00:28:59" itemprop="dateCreated datePublished" datetime="2021-11-04T00:28:59+08:00">2021-11-04</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">Edited on</span> <time title="Modified: 2022-11-04 21:46:13" itemprop="dateModified" datetime="2022-11-04T21:46:13+08:00">2022-11-04</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/java%E6%A1%86%E6%9E%B6/" itemprop="url" rel="index"><span itemprop="name">javaæ¡†æ¶</span></a> </span>, <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/java%E6%A1%86%E6%9E%B6/mybatis/" itemprop="url" rel="index"><span itemprop="name">mybatis</span></a> </span></span><span class="post-meta-break"></span> <span class="post-meta-item" title="Symbols count in article"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">Symbols count in article: </span><span>15k</span> </span><span class="post-meta-item" title="Reading time"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">Reading time &asymp;</span> <span>13 mins.</span></span></div></div></header><div class="post-body" itemprop="articleBody"><h4 id="é¢˜è®°"><a href="#é¢˜è®°" class="headerlink" title="é¢˜è®°"></a>é¢˜è®°</h4><p>MyBatisæ˜¯å¦‚ä½•å¯¹ Mapper æ–‡ä»¶ä¸­çš„sqlè¿›è¡Œå¤„ç†å‘¢ï¼Ÿ è™½ç„¶ä¸Šç¯‡è§£æ mybatis-config.xml æ˜¯æœ‰è¿›è¡Œè¯´æ˜çš„, ä½†æ˜¯åº”è¯¥æ‹¿å‡ºæ¥å•ç‹¬ä»”ç»†è§£æä¸‹. å› ä¸ºè¿™ä¸ªé‡Œé¢æ¶‰åŠåˆ°åŠ¨æ€sql, åŠ ä¸Šmapperæ–‡ä»¶è‡ªèº«ä¹Ÿæœ‰å¾ˆå¤šæ ‡ç­¾å†…å®¹,ç„¶åMyBatisæ˜¯æ€ä¹ˆè¯»å–å‡ºè¿™äº›å†…å®¹çš„å‘¢ï¼Ÿè¯»å–å‡ºæ¥å,åˆæ˜¯åšäº†æ€ä¹ˆæ ·çš„å¤„ç†, ç„¶åè¾¾åˆ°äº†sqlé‚£ç§æ‰§è¡Œæ•ˆæœçš„å‘¢ï¼Ÿ</p><p>æ„æ€ä¹Ÿå°±æ˜¯,Mapper + åŠ¨æ€sql , å†…å®¹è¿˜æ˜¯æœ‰ç‚¹å¤šçš„, å¹¶ä¸”ä¹Ÿå¾ˆé‡è¦, æ˜¯éå¸¸æœ‰å¿…è¦æ‹¿å‡ºæ¥å•ç‹¬çš„ä»”ç»†è®²è§£ä¸‹çš„.</p><h4 id="Target"><a href="#Target" class="headerlink" title="Target"></a>Target</h4><p>åœ¨ä¹‹å‰å¯¹æ ‡ç­¾çš„è¿›è¡Œè§£æçš„æ—¶å€™,æ˜¯æœ‰å¯¹ æ ‡ç­¾è¿›è¡Œä¸€ä¸ªåˆæ­¥çš„è§£æ. ç„¶åé‡Œé¢å…¶å®æ˜¯å¾ˆå¤šå†…å®¹è¿˜æ²¡å¡«è¡¥å¾ˆè¯¦ç»†,æ‰€ä»¥ç‰¹æ„è®°å½•ä¸‹å¯¹ è¯¦ç»†æ“ä½œçš„. é‚£ä¹ˆï¼Œä¸‹æ–‡å°±å¼€å§‹æ“ä½œå§.</p><p><strong>org.apache.ibatis.builder.xml.XMLMapperBuilder#parse</strong></p><p>ä¸»è¦æ¥çœ‹è¿™æ®µè§£æçš„ä»£ç  :</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">public void parse() &#123;</span><br><span class="line">    </span><br><span class="line">// åˆ©ç”¨ org.apache.ibatis.session.Configuration çš„ loadedResources</span><br><span class="line">// æ¥åˆ¤æ–­æ˜¯ä¸æ˜¯å·²ç»åŠ è½½è¿‡äº†çš„.    </span><br><span class="line">  if (!configuration.isResourceLoaded(resource)) &#123;</span><br><span class="line">    configurationElement(parser.evalNode(&quot;/mapper&quot;));</span><br><span class="line">// è¿™é‡Œæ·»åŠ åˆ° loadedResources ä¸­æ¥,ä¹Ÿå°±æ˜¯ç”¨æ¥æ§åˆ¶æ˜¯ä¸æ˜¯å·²ç»è§£æè¿‡äº†çš„.      </span><br><span class="line">    configuration.addLoadedResource(resource);</span><br><span class="line">    bindMapperForNamespace();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">// è¿™ä¸‰ä¸ªæ–¹æ³•ç»™æˆ‘ä¸€ç§å¥½åƒè§£æé‚£ç§æ²¡æœ‰è¿˜æ²¡è§£æå®Œçš„ ? è¿™ä¸ªåœ°æ–¹æœ‰å¾…å®Œå–„.    </span><br><span class="line">  parsePendingResultMaps();</span><br><span class="line">  parsePendingCacheRefs();</span><br><span class="line">  parsePendingStatements();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// configurationElement æ–¹æ³•,</span><br><span class="line">// å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ–¹æ³•ä¸­,å¾ˆå¤šæ ‡ç­¾(namespace/parameterMa/resultMap/sql)</span><br><span class="line">// è¿˜æœ‰ä¸‹é¢çš„select/insert/update/delete</span><br><span class="line">// è¿™äº›ç†Ÿæ‚‰çš„æ ‡ç­¾</span><br><span class="line">  private void configurationElement(XNode context) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">      String namespace = context.getStringAttribute(&quot;namespace&quot;);</span><br><span class="line">      if (namespace == null || namespace.equals(&quot;&quot;)) &#123;</span><br><span class="line">        throw new BuilderException(&quot;Mapper&#x27;s namespace cannot be empty&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">// å°† namespace èµ‹å€¼è¿›å»,ä¹Ÿå°±æ˜¯å½“å‰æ­£åœ¨è§£æçš„ namespace.        </span><br><span class="line">      builderAssistant.setCurrentNamespace(namespace);</span><br><span class="line">        </span><br><span class="line">// è¿™é‡Œæ˜¯å¯¹ç¼“å­˜æ ‡ç­¾è¿›è¡Œè§£æ.        </span><br><span class="line">      cacheRefElement(context.evalNode(&quot;cache-ref&quot;));</span><br><span class="line">      cacheElement(context.evalNode(&quot;cache&quot;));</span><br><span class="line"> </span><br><span class="line">// è§£æ parameterMapæ ‡ç­¾        </span><br><span class="line">      parameterMapElement(context.evalNodes(&quot;/mapper/parameterMap&quot;));</span><br><span class="line">        </span><br><span class="line">//         </span><br><span class="line">      resultMapElements(context.evalNodes(&quot;/mapper/resultMap&quot;));</span><br><span class="line">      sqlElement(context.evalNodes(&quot;/mapper/sql&quot;));</span><br><span class="line">      buildStatementFromContext(context.evalNodes(&quot;select|insert|update|delete&quot;));</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">      throw new BuilderException(&quot;Error parsing Mapper XML. The XML location is &#x27;&quot; + resource + &quot;&#x27;. Cause: &quot; + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p><strong>resultMapElements æ–¹æ³• :</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">// è¿™é‡Œçš„ list æ˜¯ xml æ–‡ä»¶ä¸­çš„æ‰€æœ‰ &lt;resultMap&gt; æ ‡ç­¾æ–‡ä»¶.</span><br><span class="line">private void resultMapElements(List&lt;XNode&gt; list) &#123;</span><br><span class="line">  for (XNode resultMapNode : list) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">//  æœ‰ç‚¹å¥½å¥‡,è¯¥æ–¹æ³•è¿”å›çš„ ResultMap è¿™è¾¹å¥½åƒå¹¶æ²¡æœ‰å‚æ•°,æœ‰ç‚¹å°´å°¬.</span><br><span class="line">//  ä¸è¿‡æ˜¯å·²ç»å­˜å‚¨åœ¨ org.apache.ibatis.session.Configuration#resultMaps ä¸­.       </span><br><span class="line">      resultMapElement(resultMapNode);</span><br><span class="line">    &#125; catch (IncompleteElementException e) &#123;</span><br><span class="line">      // ignore, it will be retried</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">----------</span><br><span class="line">// æœ€åè·Ÿè¿›åˆ°è¿™ä¸ªæ–¹æ³•ä¸­æ¥.</span><br><span class="line">  private ResultMap resultMapElement(XNode resultMapNode, List&lt;ResultMapping&gt; additionalResultMappings, Class&lt;?&gt; enclosingType) &#123;</span><br><span class="line">    ErrorContext.instance().activity(&quot;processing &quot; + resultMapNode.getValueBasedIdentifier());</span><br><span class="line"> </span><br><span class="line">// è·å–å‡º type , è¿™é‡Œæˆ‘ä»¬è·å–å‡ºæ¥çš„ type æ˜¯ TbBlog.    </span><br><span class="line">    String type = resultMapNode.getStringAttribute(&quot;type&quot;,</span><br><span class="line">        resultMapNode.getStringAttribute(&quot;ofType&quot;,</span><br><span class="line">            resultMapNode.getStringAttribute(&quot;resultType&quot;,</span><br><span class="line">                resultMapNode.getStringAttribute(&quot;javaType&quot;))));</span><br><span class="line">// å…ˆåˆ¤æ–­ org.apache.ibatis.type.TypeAliasRegistry#typeAliases ä¸­æœ‰æ²¡æœ‰,</span><br><span class="line">// å¦‚æœæ²¡æœ‰çš„è¯,å°±ä¼šè‡ªå·±newä¸€ä¸ªå‡ºæ¥.    </span><br><span class="line">    Class&lt;?&gt; typeClass = resolveClass(type);</span><br><span class="line">    if (typeClass == null) &#123;</span><br><span class="line">// TODO,å¦‚æœæ²¡æœ‰è¯?        </span><br><span class="line">      typeClass = inheritEnclosingType(resultMapNode, enclosingType);</span><br><span class="line">    &#125;</span><br><span class="line">    Discriminator discriminator = null;</span><br><span class="line">    List&lt;ResultMapping&gt; resultMappings = new ArrayList&lt;&gt;(additionalResultMappings);</span><br><span class="line">    </span><br><span class="line"> // è·å–è¯¥ &lt;resultMap&gt; ä¸‹çš„å­æ ‡ç­¾</span><br><span class="line">// é‚£ä¹ˆè¿™é‡Œä¹Ÿå°±æ˜¯è·å– &lt;id&gt; å’Œ &lt;result&gt; è¿™äºŒä¸ª.    </span><br><span class="line">    List&lt;XNode&gt; resultChildren = resultMapNode.getChildren();</span><br><span class="line">    for (XNode resultChild : resultChildren) &#123;</span><br><span class="line">// åˆ†ä¸º constructor / discriminator / å…¶ä»– è¿™ä¸‰ç±»æƒ…å†µ        </span><br><span class="line">      if (&quot;constructor&quot;.equals(resultChild.getName())) &#123;</span><br><span class="line">        processConstructorElement(resultChild, typeClass, resultMappings);</span><br><span class="line">      &#125; else if (&quot;discriminator&quot;.equals(resultChild.getName())) &#123;</span><br><span class="line">        discriminator = processDiscriminatorElement(resultChild, typeClass, resultMappings);</span><br><span class="line">      &#125; else &#123;</span><br><span class="line"> // éå‰äºŒè€…æƒ…å†µ.         </span><br><span class="line">        List&lt;ResultFlag&gt; flags = new ArrayList&lt;&gt;();</span><br><span class="line">        if (&quot;id&quot;.equals(resultChild.getName())) &#123;</span><br><span class="line">         // å¦‚æœæ ‡ç­¾æ˜¯idçš„è¯,å°±ä¼šç»™flagsæ·»åŠ ResultFlag.ID.</span><br><span class="line">          flags.add(ResultFlag.ID);</span><br><span class="line">        &#125;</span><br><span class="line">  //  å°†è¿”å›å›æ¥çš„ ResultMapping æ·»åŠ è¿›æ¥.       </span><br><span class="line">        resultMappings.add(buildResultMappingFromContext(resultChild, typeClass, flags));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">// è¿™é‡Œè·å–çš„æ˜¯ &lt;resultMap&gt; æ ‡ç­¾çš„ id å­—æ®µ.    </span><br><span class="line">    String id = resultMapNode.getStringAttribute(&quot;id&quot;,</span><br><span class="line">            resultMapNode.getValueBasedIdentifier());</span><br><span class="line">// è¿™é‡Œè¿˜å¯ä»¥ä½¿ç”¨ extends å±æ€§, ä¸æ˜¯çœ‹åˆ°è¿™é‡Œ, éƒ½å¥½å¥‡è¿˜æœ‰è¿™ç§æ ‡ç­¾.    </span><br><span class="line">    String extend = resultMapNode.getStringAttribute(&quot;extends&quot;);</span><br><span class="line">    Boolean autoMapping = resultMapNode.getBooleanAttribute(&quot;autoMapping&quot;);</span><br><span class="line">// è¿™é‡Œ new äº†ä¸€ä¸ª ResultMapResolver å¯¹è±¡.   </span><br><span class="line">    ResultMapResolver resultMapResolver = new ResultMapResolver(builderAssistant, id, typeClass, extend, discriminator, resultMappings, autoMapping);</span><br><span class="line">    try &#123;</span><br><span class="line">// è¿™é‡Œæœ€åå°±æ˜¯ new äº†ä¸€ä¸ª ResultMap å¯¹è±¡, è¯¥å¯¹è±¡çš„ id æ˜¯ namespace + æ–¹æ³•ID æ‹¼æ¥.</span><br><span class="line">// ç„¶åå°†è¯¥å¯¹è±¡ç»™æ·»åŠ åˆ°  org.apache.ibatis.session.Configuration#resultMaps ä¸­æ¥,</span><br><span class="line">// key å°±æ˜¯å…¶id, æœ€åå°±æ˜¯æ ¹æ® local / global æ¥åˆ†åˆ«è¿›è¡ŒäºŒç§æƒ…å†µæ£€æŸ¥.        </span><br><span class="line">      return resultMapResolver.resolve();</span><br><span class="line">    &#125; catch (IncompleteElementException  e) &#123;</span><br><span class="line">      configuration.addIncompleteResultMap(resultMapResolver);</span><br><span class="line">      throw e;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//  buildResultMappingFromContext æ–¹æ³•</span><br><span class="line">// è¯¥æ–¹æ³•æ˜¯å¯¹ resultMap ä¸­çš„å­—æ®µè¿›è¡Œè§£æ.</span><br><span class="line">  private ResultMapping buildResultMappingFromContext(XNode context, Class&lt;?&gt; resultType, List&lt;ResultFlag&gt; flags) &#123;</span><br><span class="line">    String property;</span><br><span class="line">    if (flags.contains(ResultFlag.CONSTRUCTOR)) &#123;</span><br><span class="line">      property = context.getStringAttribute(&quot;name&quot;);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      property = context.getStringAttribute(&quot;property&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    String column = context.getStringAttribute(&quot;column&quot;);</span><br><span class="line">    String javaType = context.getStringAttribute(&quot;javaType&quot;);</span><br><span class="line">    String jdbcType = context.getStringAttribute(&quot;jdbcType&quot;);</span><br><span class="line">    String nestedSelect = context.getStringAttribute(&quot;select&quot;);</span><br><span class="line">    String nestedResultMap = context.getStringAttribute(&quot;resultMap&quot;, () -&gt;</span><br><span class="line">      processNestedResultMappings(context, Collections.emptyList(), resultType));</span><br><span class="line">    String notNullColumn = context.getStringAttribute(&quot;notNullColumn&quot;);</span><br><span class="line">    String columnPrefix = context.getStringAttribute(&quot;columnPrefix&quot;);</span><br><span class="line">    String typeHandler = context.getStringAttribute(&quot;typeHandler&quot;);</span><br><span class="line">    String resultSet = context.getStringAttribute(&quot;resultSet&quot;);</span><br><span class="line">    String foreignColumn = context.getStringAttribute(&quot;foreignColumn&quot;);</span><br><span class="line">    boolean lazy = &quot;lazy&quot;.equals(context.getStringAttribute(&quot;fetchType&quot;, configuration.isLazyLoadingEnabled() ? &quot;lazy&quot; : &quot;eager&quot;));</span><br><span class="line">      </span><br><span class="line">// è·å– javaType , typeHandler , jdbcType ç­‰å¯¹è±¡.      </span><br><span class="line">    Class&lt;?&gt; javaTypeClass = resolveClass(javaType);</span><br><span class="line">    Class&lt;? extends TypeHandler&lt;?&gt;&gt; typeHandlerClass = resolveClass(typeHandler);</span><br><span class="line">    JdbcType jdbcTypeEnum = resolveJdbcType(jdbcType);</span><br><span class="line">// org.apache.ibatis.builder.MapperBuilderAssistant#buildResultMapping(java.lang.Class&lt;?&gt;, java.lang.String, java.lang.String, java.lang.Class&lt;?&gt;, org.apache.ibatis.type.JdbcType, java.lang.String, java.lang.String, java.lang.String, java.lang.String, java.lang.Class&lt;? extends org.apache.ibatis.type.TypeHandler&lt;?&gt;&gt;, java.util.List&lt;org.apache.ibatis.mapping.ResultFlag&gt;, java.lang.String, java.lang.String, boolean)</span><br><span class="line">// å¯ä»¥çœ‹åˆ°è¿™é‡Œä¼ é€’è¿›æ¥çš„å‚æ•°è¿˜æ˜¯å¾ˆå¤šçš„.</span><br><span class="line">// æœ€åè¿”å› ResultMapping å¯¹è±¡,ä¹Ÿå°±æ˜¯è¯´è¿™ä¹ˆå¤šå‚æ•°&amp;buildResultMappingæ–¹æ³•ä¸­çš„å‚æ•°,</span><br><span class="line">//éƒ½è®¾ç½®åˆ°è¯¥å¯¹è±¡ä¸­æ¥äº†.     </span><br><span class="line">    return builderAssistant.buildResultMapping(resultType, property, column, javaTypeClass, jdbcTypeEnum, nestedSelect, nestedResultMap, notNullColumn, columnPrefix, typeHandlerClass, flags, resultSet, foreignColumn, lazy);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p><strong>SqlElement æ–¹æ³•</strong></p><p>è¯¥æ–¹æ³•å¯ä»¥å¾ˆæ˜æ˜¾çš„æ„Ÿå—åˆ°æ˜¯å¯¹ æ ‡ç­¾è¿›è¡Œè§£æçš„.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">private void sqlElement(List&lt;XNode&gt; list) &#123;</span><br><span class="line"> // configuration è·å–å‡ºæ¥ dataBaseIdæ˜¯null,è·³è¿‡æ­¤æ–¹æ³•  </span><br><span class="line">  if (configuration.getDatabaseId() != null) &#123;</span><br><span class="line">    sqlElement(list, configuration.getDatabaseId());</span><br><span class="line">  &#125;</span><br><span class="line">//    </span><br><span class="line">  sqlElement(list, null);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// æœ‰ç‚¹å¥½å¥‡å†™ä»£ç é£æ ¼:  sqlElement(list,configuration.getDatabaseId());</span><br><span class="line">------------------------</span><br><span class="line"></span><br><span class="line">//  sqlElement æ–¹æ³•</span><br><span class="line">  private void sqlElement(List&lt;XNode&gt; list, String requiredDatabaseId) &#123;</span><br><span class="line">    for (XNode context : list) &#123;</span><br><span class="line">        </span><br><span class="line"> // è·å– databaseId å’Œ id è¿™äºŒä¸ªå±æ€§çš„å€¼.       </span><br><span class="line">      String databaseId = context.getStringAttribute(&quot;databaseId&quot;);</span><br><span class="line">      String id = context.getStringAttribute(&quot;id&quot;);</span><br><span class="line"> //  org.apache.ibatis.builder.MapperBuilderAssistant#applyCurrentNamespace   </span><br><span class="line"> // è¯¥æ–¹æ³•æœ€åè¿”å›çš„idçš„å€¼æ˜¯: namespace + id       </span><br><span class="line">      id = builderAssistant.applyCurrentNamespace(id, false);</span><br><span class="line">//sqlFragments ä¸åŒ…å«è¯¥idå°±è¿”å›true,ä¹Ÿå°±è¯´è¯¥Mapæ˜¯ç¡®å®šæ˜¯å¦å·²ç»è§£æè¿‡äº†çš„.         </span><br><span class="line">      if (databaseIdMatchesCurrent(id, databaseId, requiredDatabaseId)) &#123;</span><br><span class="line">// æ·»åŠ åˆ° org.apache.ibatis.builder.xml.XMLMapperBuilder#sqlFragments ä¸­æ¥.          </span><br><span class="line">        sqlFragments.put(id, context);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>æœ€å è§£æåçš„å€¼,æ˜¯ä½¿ç”¨ namespace + id å­˜æ”¾åœ¨ org.apache.ibatis.builder.xml.XMLMapperBuilder#sqlFragments çš„å±æ€§ä¸­çš„.</p><p><strong>buildStatementFromContext() æ–¹æ³• :</strong></p><p>è¿™é‡Œæ˜¯å¯¹ select &#x2F; insert &#x2F; update &#x2F; delete æ ‡ç­¾è¿›è¡Œè§£æ.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line">buildStatementFromContext(context.evalNodes(&quot;select|insert|update|delete&quot;));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// å¯ä»¥çœ‹åˆ° databaseId çš„è·å–ä¸ sql æ ‡ç­¾æ˜¯ä¸€æ ·çš„æ“ä½œ</span><br><span class="line">private void buildStatementFromContext(List&lt;XNode&gt; list) &#123;</span><br><span class="line">  if (configuration.getDatabaseId() != null) &#123;</span><br><span class="line">    buildStatementFromContext(list, configuration.getDatabaseId());</span><br><span class="line">  &#125;</span><br><span class="line">  buildStatementFromContext(list, null);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// æ‰€ä»¥æˆ‘ä»¬å¯ä»¥è·Ÿè¿›åˆ°è¿™ä¸ªæ–¹æ³•æ¥.</span><br><span class="line">  private void buildStatementFromContext(List&lt;XNode&gt; list, String requiredDatabaseId) &#123;</span><br><span class="line">    for (XNode context : list) &#123;</span><br><span class="line">// å…ˆ new äº†ä¸€ä¸ª XMLStatementBuilder å¯¹è±¡, ç´§æ¥ç€å°±è°ƒç”¨è¯¥å¯¹è±¡çš„ è§£æ æ–¹æ³•.        </span><br><span class="line">      final XMLStatementBuilder statementParser = new XMLStatementBuilder(configuration, builderAssistant, context, requiredDatabaseId);</span><br><span class="line">      try &#123;</span><br><span class="line">        statementParser.parseStatementNode();</span><br><span class="line">      &#125; catch (IncompleteElementException e) &#123;</span><br><span class="line">        configuration.addIncompleteStatement(statementParser);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// è§£ææ–¹æ³•</span><br><span class="line">  public void parseStatementNode() &#123;</span><br><span class="line">    String id = context.getStringAttribute(&quot;id&quot;);</span><br><span class="line">    String databaseId = context.getStringAttribute(&quot;databaseId&quot;);</span><br><span class="line">// ç”¨ namespace + id ç»„åˆä¸º id</span><br><span class="line">// org.apache.ibatis.session.Configuration#mappedStatements</span><br><span class="line">// æ¥ç€å°±æ˜¯åˆ¤æ–­åœ¨ mappedStatements ä¸­æ˜¯ä¸æ˜¯æœ‰è¯¥id,å¦‚æœä¸å­˜åœ¨å°±è¿”å›ture,</span><br><span class="line">// å­˜åœ¨å°±è¿”å›false,è¿™é‡Œä¹Ÿå°±ä¼šç›´æ¥returnå‡ºå»,ä¹Ÿå°±æ˜¯ä¸ä¼šå¾€åé¢æ‰§è¡Œäº†.      </span><br><span class="line">    if (!databaseIdMatchesCurrent(id, databaseId, this.requiredDatabaseId)) &#123;</span><br><span class="line">      return;</span><br><span class="line">    &#125;</span><br><span class="line">// è·å–æ ‡ç­¾åå­—,  select / insert/ update /delete.</span><br><span class="line">    String nodeName = context.getNode().getNodeName();</span><br><span class="line">// è½¬åŒ–ä¸ºå¤§å†™çš„ SELECT      </span><br><span class="line">    SqlCommandType sqlCommandType = SqlCommandType.valueOf(nodeName.toUpperCase(Locale.ENGLISH));</span><br><span class="line">    boolean isSelect = sqlCommandType == SqlCommandType.SELECT;</span><br><span class="line">// æ˜¯å¦åˆ·æ–° cache,ä¹Ÿå°±æ˜¯selectæ˜¯ä¸åˆ·æ–°çš„,é‚£ä¹ˆå…¶ä»–çš„å°±åº”è¯¥æ˜¯è¦åˆ·æ–°çš„.      </span><br><span class="line">    boolean flushCache = context.getBooleanAttribute(&quot;flushCache&quot;, !isSelect);</span><br><span class="line">// ä½¿ç”¨ä½¿ç”¨ cache,è¿™é‡Œåº”è¯¥æ˜¯ä¸€çº§ç¼“å­˜ï¼Œé»˜è®¤å¼€å¯çš„.      </span><br><span class="line">    boolean useCache = context.getBooleanAttribute(&quot;useCache&quot;, isSelect);</span><br><span class="line">// ç»“æœæ’åº, å¦‚æœæ²¡æœ‰é…ç½®çš„è¯,é»˜è®¤å°±æ˜¯false.      </span><br><span class="line">    boolean resultOrdered = context.getBooleanAttribute(&quot;resultOrdered&quot;, false);</span><br><span class="line"></span><br><span class="line">    // Include Fragments before parsing</span><br><span class="line">// åˆ›å»ºäº†ä¸€ä¸ª XMLIncludeTransformer å¯¹è±¡,è¯¥å¯¹è±¡åº”è¯¥æ˜¯è¿›è¡Œè½¬åŒ–çš„.      </span><br><span class="line">    XMLIncludeTransformer includeParser = new XMLIncludeTransformer(configuration, builderAssistant);</span><br><span class="line"> //  TODO ? è¯¥æ–¹æ³•æœ‰å¾…æ›´æ–°     </span><br><span class="line">    includeParser.applyIncludes(context.getNode());</span><br><span class="line"></span><br><span class="line">//è·å– parameterType å±æ€§,å¦‚æœæœ‰çš„è¯,ä¹Ÿä¼šè·å–å‡ºè¯¥å±æ€§å¯¹åº”çš„ Class.    </span><br><span class="line">    String parameterType = context.getStringAttribute(&quot;parameterType&quot;);</span><br><span class="line">    Class&lt;?&gt; parameterTypeClass = resolveClass(parameterType);</span><br><span class="line"></span><br><span class="line">// lang : null,è¿™é‡Œæ˜¯æ²¡æœ‰è®¾ç½®çš„.      </span><br><span class="line">    String lang = context.getStringAttribute(&quot;lang&quot;);</span><br><span class="line">    LanguageDriver langDriver = getLanguageDriver(lang);</span><br><span class="line"></span><br><span class="line">    // Parse selectKey after includes and remove them.</span><br><span class="line">// è¿™é‡Œå¯¹æ˜¯å¦æœ‰ selectKey è¿›è¡Œå¤„ç†.æˆ‘ä»¬è¿™é‡Œç›®å‰æ²¡æœ‰ä½¿ç”¨ selectKey</span><br><span class="line">    processSelectKeyNodes(id, parameterTypeClass, langDriver);</span><br><span class="line"></span><br><span class="line">    // Parse the SQL (pre: &lt;selectKey&gt; and &lt;include&gt; were parsed and removed)</span><br><span class="line">    KeyGenerator keyGenerator;</span><br><span class="line"> // selectBlog!selectKey     </span><br><span class="line">    String keyStatementId = id + SelectKeyGenerator.SELECT_KEY_SUFFIX;</span><br><span class="line">// è¿™é‡Œæ‹¼æ¥ä¸Š namespace :  com.iyang.mybatis.mapper.BlogMapper.selectBlog!selectKey      </span><br><span class="line">    keyStatementId = builderAssistant.applyCurrentNamespace(keyStatementId, true);</span><br><span class="line"></span><br><span class="line">// è¿™é‡Œæ˜¯åˆ¤æ–­æ˜¯å¦æœ‰ ä¸»é”®è‡ªåŠ¨ç”Ÿæˆ. è¿™é‡Œæ˜¯æŸ¥è¯¢è¯­å¥,åº”è¯¥æ˜¯æ²¡æœ‰çš„. </span><br><span class="line">    if (configuration.hasKeyGenerator(keyStatementId)) &#123;</span><br><span class="line">      keyGenerator = configuration.getKeyGenerator(keyStatementId);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      keyGenerator = context.getBooleanAttribute(&quot;useGeneratedKeys&quot;,</span><br><span class="line">          configuration.isUseGeneratedKeys() &amp;&amp; SqlCommandType.INSERT.equals(sqlCommandType))</span><br><span class="line">          ? Jdbc3KeyGenerator.INSTANCE : NoKeyGenerator.INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">// åˆ›å»ºä¸€ä¸ª XMLScriptBuilder å¯¹è±¡,ä½¿ç”¨è¯¥å¯¹è±¡çš„parseScriptNodeæ–¹æ³•æ¥è§£æ</span><br><span class="line">// org.apache.ibatis.scripting.xmltags.XMLScriptBuilder#parseScriptNode</span><br><span class="line">// è·å–å‡ºsql, æœ‰ä¸ª isDynamic å‚æ•°,æ¥åˆ¤æ–­æ˜¯ä¸æ˜¯åŠ¨æ€sqlè¯­å¥.</span><br><span class="line">// è¿™é‡Œä¸æ˜¯åŠ¨æ€sql,æœ€ånewäº†ä¸€ä¸ªRawSqlSource.</span><br><span class="line">// org.apache.ibatis.builder.SqlSourceBuilder#parse,æˆ‘ä»¬çš„#&#123;id&#125; æ›¿æ¢æˆ ? å°±æ˜¯åœ¨</span><br><span class="line">// è¿™é‡Œè¿›è¡Œæ›¿æ¢çš„.</span><br><span class="line">// å¦‚æœæ˜¯åŠ¨æ€ sql çš„è¯,å°±ä¼šåˆ›å»ºå‡º DynamicSqlSource è¯¥å¯¹è±¡æ¥.</span><br><span class="line">// å¯ä»¥çœ‹åˆ° SqlSource ä¸‹é¢æ˜¯æœ‰ å››ä¸ªå®ç°ç±»çš„.</span><br><span class="line">// è¿™é‡Œè¿”å›çš„ SqlSourceé‡Œé¢æœ‰sqlè¯­å¥çš„,å’Œè¿”å›ç±»å‹çš„.      </span><br><span class="line">    SqlSource sqlSource = langDriver.createSqlSource(configuration, context, parameterTypeClass);</span><br><span class="line"> </span><br><span class="line">// è·å–å±æ€§.      </span><br><span class="line">    StatementType statementType = StatementType.valueOf(context.getStringAttribute(&quot;statementType&quot;, StatementType.PREPARED.toString()));</span><br><span class="line">    Integer fetchSize = context.getIntAttribute(&quot;fetchSize&quot;);</span><br><span class="line">    Integer timeout = context.getIntAttribute(&quot;timeout&quot;);</span><br><span class="line">    String parameterMap = context.getStringAttribute(&quot;parameterMap&quot;);</span><br><span class="line">// è·å–è¿”å›ç±»å‹. è·å–å‡ºæ¥çš„ resultTypeClass æ˜¯ class com.iyang.mybatis.pojo.TbBlog      </span><br><span class="line">    String resultType = context.getStringAttribute(&quot;resultType&quot;);</span><br><span class="line">    Class&lt;?&gt; resultTypeClass = resolveClass(resultType);</span><br><span class="line">    String resultMap = context.getStringAttribute(&quot;resultMap&quot;);      </span><br><span class="line">    String resultSetType = context.getStringAttribute(&quot;resultSetType&quot;);</span><br><span class="line">    ResultSetType resultSetTypeEnum = resolveResultSetType(resultSetType);</span><br><span class="line">    if (resultSetTypeEnum == null) &#123;</span><br><span class="line">      resultSetTypeEnum = configuration.getDefaultResultSetType();</span><br><span class="line">    &#125;</span><br><span class="line">// è·å–å±æ€§çš„å€¼      </span><br><span class="line">    String keyProperty = context.getStringAttribute(&quot;keyProperty&quot;);</span><br><span class="line">    String keyColumn = context.getStringAttribute(&quot;keyColumn&quot;);</span><br><span class="line">    String resultSets = context.getStringAttribute(&quot;resultSets&quot;);</span><br><span class="line"></span><br><span class="line">// åˆ›å»ºä¸€ä¸ª MappedStatement.Builder å¯¹è±¡å‡ºæ¥.</span><br><span class="line">// å†é€šè¿‡ builder æ„å»ºå‡ºä¸€ä¸ª MappedStatement å¯¹è±¡æ¥.</span><br><span class="line">// æœ€åæ”¾å…¥åˆ° org.apache.ibatis.session.Configuration#mappedStatements ä¸­æ¥.      </span><br><span class="line">    builderAssistant.addMappedStatement(id, sqlSource, statementType, sqlCommandType,</span><br><span class="line">        fetchSize, timeout, parameterMap, parameterTypeClass, resultMap, resultTypeClass,</span><br><span class="line">        resultSetTypeEnum, flushCache, useCache, resultOrdered,</span><br><span class="line">        keyGenerator, keyProperty, keyColumn, databaseId, langDriver, resultSets);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  private void processSelectKeyNodes(String id, Class&lt;?&gt; parameterTypeClass, LanguageDriver langDriver) &#123;</span><br><span class="line">    List&lt;XNode&gt; selectKeyNodes = context.evalNodes(&quot;selectKey&quot;);</span><br><span class="line">    if (configuration.getDatabaseId() != null) &#123;</span><br><span class="line">      parseSelectKeyNodes(id, selectKeyNodes, parameterTypeClass, langDriver, configuration.getDatabaseId());</span><br><span class="line">    &#125;</span><br><span class="line">    parseSelectKeyNodes(id, selectKeyNodes, parameterTypeClass, langDriver, null);</span><br><span class="line">    removeSelectKeyNodes(selectKeyNodes);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>æ€»ç»“ä¸‹ MyBatis è§£æ Mapperçš„xml æ–‡ä»¶æµç¨‹ã€‚ å¯ä»¥æ„Ÿå—åˆ°,å¯¹äºMybatiså¤„ç†Mapper,å¯¹å…¶å­—æ®µå±æ€§éƒ½æ˜¯æŒ¨ä¸ªè§£æçš„,è¿˜æ˜¯ä¸‹äº†å¾ˆå¤§çš„åŠŸå¤«.</p><p>å…ˆæ˜¯æœ‰ä¸€ä¸ªé›†åˆæ¥æ§åˆ¶æ˜¯å¦å·²ç»è§£æè¿‡äº†,ç®—æ˜¯ä¸€ç§æ˜¯å¦è§£æçš„å¼€å…³é…ç½®. å¯ä»¥çœ‹åˆ°å…¶å…ˆåçš„è§£æé¡ºåº,</p><p>namespace â€“&gt; cache-ref â€“&gt; cache â€”&gt; mapper&#x2F;parameterMap â€”&gt; mapper&#x2F;resultMap â€”&gt; mapper&#x2F;sql â€”&gt; select&#x2F;insert&#x2F;update&#x2F;detele.</p><p>å½“è§£æè¿™äº›æ ‡ç­¾çš„æ—¶å€™, åˆä¼šå¯¹æ ‡ç­¾é‡Œé¢çš„å±æ€§è¿›è¡Œè§£æ. è¿™é‡Œ,ä¸»è¦çœ‹ä¸‹æˆ‘ä»¬å¹³å¸¸ä½¿ç”¨åˆ°æœ€å¤šçš„æ ‡ç­¾, MyBatis å¯¹è¿™äº›æ ‡ç­¾è§£æäº†å,å…¶åæœ‰æ˜¯æ€ä¹ˆåˆ©ç”¨çš„å‘¢ï¼Ÿå¯ä»¥çœ‹åˆ°ç›®å‰MyBatisæ˜¯å­˜æ”¾åœ¨ä¸€äº›configurationç­‰ç±»ä¿¡æ¯é‡Œé¢,é‚£ä¹ˆç­‰åˆ°çœŸæ­£å»æŸ¥è¯¢sqlè¯­å¥çš„æ—¶å€™, MyBatis åˆæ˜¯æ€ä¹ˆç”¨ä¸Šçš„å‘¢ï¼Ÿ è¿™é‡Œç›®å‰åªè®²äº†å¦‚ä½•è§£æ.</p><p>è§£æå®Œäº†ï¼Œæ²¡å¼‚å¸¸ï¼Œé‚£å°±æ˜¯è§£æéƒ½okäº†ï¼Œå‰©ä¸‹çš„å°±æ˜¯çœ‹å½“ MyBatis å»æŸ¥è¯¢çš„æ—¶å€™, æ˜¯æ€ä¹ˆåˆ©ç”¨ä¸Šè¿™äº›èµ„æºçš„å‘¢ï¼Ÿæ‰€ä»¥çœ‹æ¥ä¸‹æ¥çš„æ›´æ–°.</p></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://ruy9527.github.io/2021/11/04/mybatis/mybatis%E6%9C%AC%E5%9C%B0%E7%BC%93%E5%AD%98%E9%98%85%E8%AF%BB/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/touxiang.jpg"><meta itemprop="name" content="YangBao"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="YangBao"><meta itemprop="description" content="çŸ¥è¯†ç¬”è®°"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | YangBao"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2021/11/04/mybatis/mybatis%E6%9C%AC%E5%9C%B0%E7%BC%93%E5%AD%98%E9%98%85%E8%AF%BB/" class="post-title-link" itemprop="url">mybatisæœ¬åœ°ç¼“å­˜é˜…è¯»</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Created: 2021-11-04 00:28:33" itemprop="dateCreated datePublished" datetime="2021-11-04T00:28:33+08:00">2021-11-04</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">Edited on</span> <time title="Modified: 2022-11-04 21:46:13" itemprop="dateModified" datetime="2022-11-04T21:46:13+08:00">2022-11-04</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/java%E6%A1%86%E6%9E%B6/" itemprop="url" rel="index"><span itemprop="name">javaæ¡†æ¶</span></a> </span>, <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/java%E6%A1%86%E6%9E%B6/mybatis/" itemprop="url" rel="index"><span itemprop="name">mybatis</span></a> </span></span><span class="post-meta-break"></span> <span class="post-meta-item" title="Symbols count in article"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">Symbols count in article: </span><span>12k</span> </span><span class="post-meta-item" title="Reading time"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">Reading time &asymp;</span> <span>11 mins.</span></span></div></div></header><div class="post-body" itemprop="articleBody"><h4 id="é¢˜è®°"><a href="#é¢˜è®°" class="headerlink" title="é¢˜è®°"></a>é¢˜è®°</h4><h4 id="ç¼“å­˜è¿™ä¸ªçŸ¥è¯†ç‚¹åœ¨è®¸å¤šåœ°æ–¹éƒ½æœ‰çš„ï¼Œåˆ©ç”¨åˆ°å¥½çš„è¯ï¼Œå¯¹ç³»ç»Ÿçš„å¾ˆå¤šåœ°æ–¹æŸ¥è¯¢æ˜¯æœ‰å¾ˆå¤§çš„æå‡çš„-å¯ä»¥çœ‹åˆ°-MyBatis-ä¹Ÿæ˜¯æœ‰-cache-çš„ï¼Œé‚£MyBatis-æ˜¯æ€ä¹ˆåˆ©ç”¨è¿™ä¸ªç¼“å­˜çš„å‘¢ï¼Ÿ-åœ¨-INSERT-x2F-UPDATE-x2F-DELETE-x2F-SELECTä¸­-æ˜¯ä¸æ˜¯åªæœ‰SELECTçš„æ—¶å€™ç”¨åˆ°äº†ç¼“å­˜ï¼Œå¦‚æœæ˜¯-INSERT-x2F-UPDATE-x2F-DELETE-æ˜¯å¦ä¼šå¯¹ç¼“å­˜æœ‰å½±å“ï¼Ÿ"><a href="#ç¼“å­˜è¿™ä¸ªçŸ¥è¯†ç‚¹åœ¨è®¸å¤šåœ°æ–¹éƒ½æœ‰çš„ï¼Œåˆ©ç”¨åˆ°å¥½çš„è¯ï¼Œå¯¹ç³»ç»Ÿçš„å¾ˆå¤šåœ°æ–¹æŸ¥è¯¢æ˜¯æœ‰å¾ˆå¤§çš„æå‡çš„-å¯ä»¥çœ‹åˆ°-MyBatis-ä¹Ÿæ˜¯æœ‰-cache-çš„ï¼Œé‚£MyBatis-æ˜¯æ€ä¹ˆåˆ©ç”¨è¿™ä¸ªç¼“å­˜çš„å‘¢ï¼Ÿ-åœ¨-INSERT-x2F-UPDATE-x2F-DELETE-x2F-SELECTä¸­-æ˜¯ä¸æ˜¯åªæœ‰SELECTçš„æ—¶å€™ç”¨åˆ°äº†ç¼“å­˜ï¼Œå¦‚æœæ˜¯-INSERT-x2F-UPDATE-x2F-DELETE-æ˜¯å¦ä¼šå¯¹ç¼“å­˜æœ‰å½±å“ï¼Ÿ" class="headerlink" title="ç¼“å­˜è¿™ä¸ªçŸ¥è¯†ç‚¹åœ¨è®¸å¤šåœ°æ–¹éƒ½æœ‰çš„ï¼Œåˆ©ç”¨åˆ°å¥½çš„è¯ï¼Œå¯¹ç³»ç»Ÿçš„å¾ˆå¤šåœ°æ–¹æŸ¥è¯¢æ˜¯æœ‰å¾ˆå¤§çš„æå‡çš„. å¯ä»¥çœ‹åˆ°,MyBatis ä¹Ÿæ˜¯æœ‰ cache çš„ï¼Œé‚£MyBatis æ˜¯æ€ä¹ˆåˆ©ç”¨è¿™ä¸ªç¼“å­˜çš„å‘¢ï¼Ÿ åœ¨ INSERT&#x2F;UPDATE&#x2F;DELETE&#x2F;SELECTä¸­,æ˜¯ä¸æ˜¯åªæœ‰SELECTçš„æ—¶å€™ç”¨åˆ°äº†ç¼“å­˜ï¼Œå¦‚æœæ˜¯ INSERT&#x2F;UPDATE&#x2F;DELETE æ˜¯å¦ä¼šå¯¹ç¼“å­˜æœ‰å½±å“ï¼Ÿ"></a>ç¼“å­˜è¿™ä¸ªçŸ¥è¯†ç‚¹åœ¨è®¸å¤šåœ°æ–¹éƒ½æœ‰çš„ï¼Œåˆ©ç”¨åˆ°å¥½çš„è¯ï¼Œå¯¹ç³»ç»Ÿçš„å¾ˆå¤šåœ°æ–¹æŸ¥è¯¢æ˜¯æœ‰å¾ˆå¤§çš„æå‡çš„. å¯ä»¥çœ‹åˆ°,MyBatis ä¹Ÿæ˜¯æœ‰ cache çš„ï¼Œé‚£MyBatis æ˜¯æ€ä¹ˆåˆ©ç”¨è¿™ä¸ªç¼“å­˜çš„å‘¢ï¼Ÿ åœ¨ INSERT&#x2F;UPDATE&#x2F;DELETE&#x2F;SELECTä¸­,æ˜¯ä¸æ˜¯åªæœ‰SELECTçš„æ—¶å€™ç”¨åˆ°äº†ç¼“å­˜ï¼Œå¦‚æœæ˜¯ INSERT&#x2F;UPDATE&#x2F;DELETE æ˜¯å¦ä¼šå¯¹ç¼“å­˜æœ‰å½±å“ï¼Ÿ</h4><p>å¯ä»¥çœ‹ç»“æœæ¥åˆ†æï¼Œç„¶åè·Ÿè¿›æºç æ¥ä»”ç»†åˆ†æ.</p><p>MyBatis æ˜¯åˆ†ä¸º ä¸€çº§ç¼“å­˜ å’Œ äºŒçº§ç¼“å­˜çš„. é‚£ä¹ˆï¼Œæˆ‘ä»¬å°±å…ˆä»ä¸€çº§ç¼“å­˜å¼€å§‹.</p><h4 id="ä¸€çº§ç¼“å­˜"><a href="#ä¸€çº§ç¼“å­˜" class="headerlink" title="ä¸€çº§ç¼“å­˜"></a>ä¸€çº§ç¼“å­˜</h4><p>æ¡ˆä¾‹ä»£ç  :</p><p>è¿™é‡Œæˆ‘ä»¬æ˜¯æ‰“å°çš„æŸ¥è¯¢sqlçš„è¯­å¥ï¼Œå†ç¬¬äºŒæ¬¡å†æŸ¥è¯¢çš„æ—¶å€™ï¼Œæ˜¯</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">InputStream mybatisInputStream = Resources.getResourceAsStream(&quot;mybatis-config.xml&quot;);</span><br><span class="line"></span><br><span class="line">SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(mybatisInputStream);</span><br><span class="line">SqlSession session = sqlSessionFactory.openSession();</span><br><span class="line">BlogMapper blogMapper = session.getMapper(BlogMapper.class);</span><br><span class="line">TbBlog tbBlog = blogMapper.selectBlog(1);</span><br><span class="line">System.out.println(blogMapper.selectBlog(1));</span><br><span class="line">System.out.println(tbBlog);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// ç»“æœå¯ä»¥çœ‹åˆ°,ç¬¬äºŒæ¬¡å¹¶æ²¡æœ‰å†æ‰“å°å‡º sql è¯­å¥æ¥.</span><br><span class="line">==&gt;  Preparing: select * from tb_blog where id = ? </span><br><span class="line">==&gt; Parameters: 1(Integer)</span><br><span class="line">&lt;==    Columns: id, name</span><br><span class="line">&lt;==        Row: 1, 6565</span><br><span class="line">&lt;==      Total: 1</span><br><span class="line">TbBlog&#123;id=1, name=&#x27;6565&#x27;&#125;</span><br><span class="line">TbBlog&#123;id=1, name=&#x27;6565&#x27;&#125;</span><br></pre></td></tr></table></figure><p>æ¡ˆä¾‹äºŒ : æˆ‘ä»¬å†ç¬¬äºŒæ¬¡æŸ¥è¯¢ä¹‹å‰ åŠ å…¥ ä¸€ä¸ªadd æ–¹æ³•</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">InputStream mybatisInputStream = Resources.getResourceAsStream(&quot;mybatis-config.xml&quot;);</span><br><span class="line"></span><br><span class="line">SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(mybatisInputStream);</span><br><span class="line">SqlSession session = sqlSessionFactory.openSession();</span><br><span class="line">BlogMapper blogMapper = session.getMapper(BlogMapper.class);</span><br><span class="line">TbBlog tbBlog = blogMapper.selectBlog(1);</span><br><span class="line"></span><br><span class="line">System.out.println(blogMapper.addBlog(&quot;GavinYang&quot;));</span><br><span class="line">System.out.println(blogMapper.selectBlog(1));</span><br><span class="line">System.out.println(tbBlog);</span><br><span class="line"></span><br><span class="line">// çœ‹ç»“æœ,å¯ä»¥çœ‹åˆ°å½“ä¸­é—´ç©¿æ’ä¸€ä¸ª insert çš„sqlè¯­å¥,é‚£ä¹ˆåœ¨ç¬¬äºŒæ¬¡æŸ¥è¯¢çš„æ—¶å€™,å°±ä¼šæ‰§è¡Œsqlè¯­å¥.</span><br><span class="line">// é‚£ä¹ˆä¹Ÿå°±è¯´ï¼Œè¿™ä¸ªæ—¶å€™ç¼“å­˜æ˜¯å¤±æ•ˆäº†.</span><br><span class="line">==&gt;  Preparing: select * from tb_blog where id = ? </span><br><span class="line">==&gt; Parameters: 1(Integer)</span><br><span class="line">&lt;==    Columns: id, name</span><br><span class="line">&lt;==        Row: 1, 6565</span><br><span class="line">&lt;==      Total: 1</span><br><span class="line">==&gt;  Preparing: insert into tb_blog (name) values(?) </span><br><span class="line">==&gt; Parameters: GavinYang(String)</span><br><span class="line">&lt;==    Updates: 1</span><br><span class="line">1</span><br><span class="line">==&gt;  Preparing: select * from tb_blog where id = ? </span><br><span class="line">==&gt; Parameters: 1(Integer)</span><br><span class="line">&lt;==    Columns: id, name</span><br><span class="line">&lt;==        Row: 1, 6565</span><br><span class="line">&lt;==      Total: 1</span><br><span class="line">TbBlog&#123;id=1, name=&#x27;6565&#x27;&#125;</span><br><span class="line">TbBlog&#123;id=1, name=&#x27;6565&#x27;&#125;</span><br></pre></td></tr></table></figure><p>æ¡ˆä¾‹ä¸‰ : ä½¿ç”¨äºŒä¸ª SqlSession æ¡ˆä¾‹</p><p>å¯ä»¥å¾ˆæ˜æ˜¾çš„çœ‹åˆ° , åœ¨ç¬¬äºŒæ¬¡çš„æ—¶å€™è¿˜å‡ºç°äº†è„æ•°æ®.</p><p>è¿™é‡Œä¹Ÿå¯ä»¥çœ‹åˆ°ä¸€çº§ç¼“å­˜æ˜¯åªåœ¨ SqlSession ä¸­å­˜åœ¨çš„,ä¹Ÿå°±æ˜¯æ•°æ®åº“ä¼šè¯å†…éƒ¨å…±äº«çš„.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">InputStream mybatisInputStream = Resources.getResourceAsStream(&quot;mybatis-config.xml&quot;);</span><br><span class="line">SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(mybatisInputStream);</span><br><span class="line"></span><br><span class="line">SqlSession openSession1 = sqlSessionFactory.openSession();</span><br><span class="line">SqlSession openSession2 = sqlSessionFactory.openSession();</span><br><span class="line">BlogMapper blogMapper1 = openSession1.getMapper(BlogMapper.class);</span><br><span class="line">BlogMapper blogMapper2 = openSession2.getMapper(BlogMapper.class);</span><br><span class="line"></span><br><span class="line">System.out.println(&quot;blogMapper1 è¯»å–æ•°æ® &quot; + blogMapper1.selectBlog(1));</span><br><span class="line">System.out.println(&quot;blogMapper2 è¯»å–æ•°æ®&quot; + blogMapper2.selectBlog(1));</span><br><span class="line"></span><br><span class="line">System.out.println(blogMapper1.updateHashCode(&quot;PeterWong&quot;));</span><br><span class="line"></span><br><span class="line">System.out.println(&quot;blogMapper1 è¯»å–æ•°æ® &quot; + blogMapper1.selectBlog(1));</span><br><span class="line">System.out.println(&quot;blogMapper2 è¯»å–æ•°æ®&quot; + blogMapper2.selectBlog(1));</span><br><span class="line"></span><br><span class="line">// ç„¶åæˆ‘ä»¬å¯ä»¥çœ‹åˆ° log æ‰“å°å‡ºæ¥çš„å†…å®¹</span><br><span class="line">==&gt;  Preparing: select * from tb_blog where id = ? </span><br><span class="line">==&gt; Parameters: 1(Integer)</span><br><span class="line">&lt;==    Columns: id, name</span><br><span class="line">&lt;==        Row: 1, 6565</span><br><span class="line">&lt;==      Total: 1</span><br><span class="line">blogMapper1 è¯»å–æ•°æ® TbBlog&#123;id=1, name=&#x27;6565&#x27;&#125;</span><br><span class="line">Created connection 433287555.</span><br><span class="line">Setting autocommit to false on JDBC Connection [com.mysql.jdbc.JDBC4Connection@19d37183]</span><br><span class="line">==&gt;  Preparing: select * from tb_blog where id = ? </span><br><span class="line">==&gt; Parameters: 1(Integer)</span><br><span class="line">&lt;==    Columns: id, name</span><br><span class="line">&lt;==        Row: 1, 6565</span><br><span class="line">&lt;==      Total: 1</span><br><span class="line">blogMapper2 è¯»å–æ•°æ®TbBlog&#123;id=1, name=&#x27;6565&#x27;&#125;</span><br><span class="line">==&gt;  Preparing: update tb_blog set name = ? where id = 1; </span><br><span class="line">==&gt; Parameters: PeterWong(String)</span><br><span class="line">&lt;==    Updates: 1</span><br><span class="line">1</span><br><span class="line">==&gt;  Preparing: select * from tb_blog where id = ? </span><br><span class="line">==&gt; Parameters: 1(Integer)</span><br><span class="line">&lt;==    Columns: id, name</span><br><span class="line">&lt;==        Row: 1, PeterWong</span><br><span class="line">&lt;==      Total: 1</span><br><span class="line">blogMapper1 è¯»å–æ•°æ® TbBlog&#123;id=1, name=&#x27;PeterWong&#x27;&#125;</span><br><span class="line">blogMapper2 è¯»å–æ•°æ®TbBlog&#123;id=1, name=&#x27;6565&#x27;&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬è¯´äº†ä¸‰é¢çš„è¿™ä¸‰ç§æƒ…å†µ, å…·ä½“çš„æ‰§è¡Œæµç¨‹å¯ä»¥æˆ‘ä»¬å¯ä»¥ç°åœ¨ æ¡ˆä¾‹ä¸€é‡Œé¢å¯¹ç¬¬äºŒæ¬¡ query è¿›è¡Œ debug åˆ†ææ“ä½œ. å½“æˆ‘ä»¬debugåˆ° org.apache.ibatis.executor.BaseExecutor#query(org.apache.ibatis.mapping.MappedStatement, java.lang.Object, org.apache.ibatis.session.RowBounds, org.apache.ibatis.session.ResultHandler, org.apache.ibatis.cache.CacheKey, org.apache.ibatis.mapping.BoundSql) çš„æ—¶å€™ï¼Œå¯ä»¥çœ‹åˆ° org.apache.ibatis.executor.BaseExecutor#localCache åªæœ‰ä¸€ä¸ª ç¼“å­˜çš„å€¼çš„ ï¼Œ æ ¹æ® getObject æ–¹æ³•å¯ä»¥è·Ÿè¿›åˆ° org.apache.ibatis.cache.impl.PerpetualCache#cache ä¸­æ¥,</p><p>ä¼ å…¥è¿›æ¥çš„ key å€¼æ˜¯ : -1896651191:1062027004:com.iyang.mybatis.mapper.BlogMapper.selectBlog:0:2147483647:select * from tb_blog where id &#x3D; ?:1:development ç„¶åä» cache ä¸­è·å–å‡ºå€¼æ¥, æ‰€ä»¥è¿™é‡Œå°±æ²¡æœ‰èµ° query çš„æŸ¥è¯¢è¯­å¥.</p><p>è¿™æ˜¯å‘½ä¸­ç¼“å­˜çš„æƒ…å†µ.</p><p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸‹, åœ¨ç¬¬äºŒæ¬¡ query ä¹‹å‰å¦‚æœæ‰§è¡Œäº†ä¸€ä¸ª add æ–¹æ³•ï¼Œä¸ºä»€ä¹ˆå°±å‘½ä¸­ä¸äº†äº†å‘¢ï¼Ÿ</p><p>è¿™é‡Œå¯ä»¥å¤§è‡´çŒœæµ‹ä¸‹ï¼Œåœ¨æ‰§è¡Œå®Œ add æ–¹æ³•åï¼Œæ˜¯ä¸æ˜¯ç»™ cache ç»™æ¸…é™¤æ‰äº†ï¼Œç„¶åå†å»æŸ¥è¯¢çš„æ—¶å€™ï¼Œå°±æŸ¥è¯¢ä¸åˆ°äº†.</p><p>äºæ˜¯æˆ‘ä»¬åœ¨ add æ–¹æ³•ä¸Šè¿›è¡Œ debug æŸ¥çœ‹ä¸‹ :</p><p>æœ€åæˆ‘ä»¬ debug è·Ÿè¿›åˆ°è¿™é‡Œ : org.apache.ibatis.executor.BaseExecutor#clearLocalCache å°±å¯ä»¥å‘ç°</p><p>è¿™é‡Œæ˜¯æœ‰äºŒä¸ª clear æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯æ¸…é™¤æ–¹æ³•.</p><p>localCache.clear() â€”-&gt; org.apache.ibatis.cache.impl.PerpetualCache#clear å¯¹åº”çš„å°±æ˜¯è¿™é‡Œçš„æ¸…æ¥šæ–¹æ³•ï¼Œç›´æ¥è°ƒç”¨ HashMap çš„clear æ–¹æ³•è¿›è¡Œæ¸…é™¤.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">localCache.clear();</span><br><span class="line">localOutputParameterCache.clear();</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥è¿™é‡Œå¯ä»¥çœ‹å‡ºåœ¨ç¬¬äºŒæ¬¡è°ƒç”¨ query ä¹‹å‰ï¼Œå¦‚æœæ˜¯æœ‰ insert&#x2F;update&#x2F;delete ç­‰æ–¹æ³•çš„è¯ï¼Œå°±ä¼šå»é‡ç½®è¿™äºŒä¸ªåœ°æ–¹çš„ç¼“å­˜çš„.</p><p>MyBatis çš„ä¸€çº§ç¼“å­˜çš„æ˜¯è·Ÿéš SqlSession çš„ï¼Œè¿™é‡Œæ˜¯å¯ä»¥æ ¹æ®ç®€å•çš„æ¡ˆä¾‹æ•ˆæœçœ‹å‡ºæ¥çš„.</p><p>ä¸€çº§ç¼“å­˜åªæ˜¯ä½¿ç”¨äº†ä¸€ä¸ª HashMap , æœ€åæ¸…é™¤ç¼“å­˜çš„æ—¶å€™ï¼Œä¹Ÿæ˜¯è°ƒç”¨ HashMap çš„clear æ–¹æ³•</p><p>æœ€åä»æ¡ˆä¾‹ä¸‰å¯ä»¥çœ‹å‡ºæ¥ï¼Œå½“å¤šä¸ª SqlSession çš„æ—¶å€™ï¼Œç”±äºå„è‡ªæœ‰å­˜æœ‰å„è‡ªçš„ç¼“å­˜ï¼Œæ‰€ä»¥æ˜¯å¾ˆå®¹æ˜“å¼•èµ·è„æ•°æ®çš„, å°†ç¼“å­˜çº§åˆ«è®¾ç½®ä¸º Statement.</p><h4 id="äºŒçº§ç¼“å­˜"><a href="#äºŒçº§ç¼“å­˜" class="headerlink" title="äºŒçº§ç¼“å­˜"></a>äºŒçº§ç¼“å­˜</h4><p>å¯ä»¥çœ‹åˆ°ä¸€çº§ç¼“å­˜çš„è¯ï¼Œæ˜¯å±€é™äº SqlSession . å¦‚æœè¦å¤šä¸ª sqlSession ä¹‹é—´å…±äº«ç¼“å­˜çš„è¯ï¼Œå°±éœ€è¦å¼€å¯äºŒçº§ç¼“å­˜. å¼€å¯çš„è¯,æˆ‘ä»¬åœ¨ MyBatis é…ç½®æ–‡ä»¶ä¸­åŠ ä¸Š:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;settings&gt;</span><br><span class="line">    &lt;setting name=&quot;logImpl&quot; value=&quot;STDOUT_LOGGING&quot;/&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- å¼€å¯äºŒçº§ç¼“å­˜ --&gt;</span><br><span class="line">    &lt;setting name=&quot;cacheEnabled&quot; value=&quot;true&quot;/&gt;</span><br><span class="line">&lt;/settings&gt;</span><br></pre></td></tr></table></figure><p><strong>æ¡ˆä¾‹ä¸€ : æ˜¯å¦æäº¤äº‹åŠ¡</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String[] args) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">    InputStream mybatisInputStream = Resources.getResourceAsStream(&quot;mybatis-config.xml&quot;);</span><br><span class="line">    SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(mybatisInputStream);</span><br><span class="line">    SqlSession sqlSession1 = sqlSessionFactory.openSession(true);</span><br><span class="line">    SqlSession sqlSession2 = sqlSessionFactory.openSession(true);</span><br><span class="line"></span><br><span class="line">    BlogMapper blogMapper1 = sqlSession1.getMapper(BlogMapper.class);</span><br><span class="line">    BlogMapper blogMapper2 = sqlSession2.getMapper(BlogMapper.class);</span><br><span class="line"></span><br><span class="line">    System.out.println(&quot;blogMapper1 è·å–æ•°æ®&quot; + blogMapper1.selectBlog(1));</span><br><span class="line">    </span><br><span class="line">    // sqlSession1.commit();</span><br><span class="line">    </span><br><span class="line">    System.out.println(&quot;blogMapper2 è·å–æ•°æ®&quot; + blogMapper2.selectBlog(1));</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//   ----------------   trueç»“æœ   -----------------------</span><br><span class="line"></span><br><span class="line">Created connection 492079624.</span><br><span class="line">==&gt;  Preparing: select * from tb_blog where id = ? </span><br><span class="line">==&gt; Parameters: 1(Integer)</span><br><span class="line">&lt;==    Columns: id, name</span><br><span class="line">&lt;==        Row: 1, 6565</span><br><span class="line">&lt;==      Total: 1</span><br><span class="line">blogMapper1 è·å–æ•°æ®TbBlog&#123;id=1, name=&#x27;6565&#x27;&#125;</span><br><span class="line">Opening JDBC Connection</span><br><span class="line">    </span><br><span class="line">Created connection 433287555.</span><br><span class="line">==&gt;  Preparing: select * from tb_blog where id = ? </span><br><span class="line">==&gt; Parameters: 1(Integer)</span><br><span class="line">&lt;==    Columns: id, name</span><br><span class="line">&lt;==        Row: 1, 6565</span><br><span class="line">&lt;==      Total: 1</span><br><span class="line">blogMapper2 è·å–æ•°æ®TbBlog&#123;id=1, name=&#x27;6565&#x27;&#125;    </span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">// ------------   åŠ ä¸Šcommit()æ–¹æ³•ç»“æœ   ---------------</span><br><span class="line"></span><br><span class="line">Created connection 630074945.</span><br><span class="line">==&gt;  Preparing: select * from tb_blog where id = ? </span><br><span class="line">==&gt; Parameters: 1(Integer)</span><br><span class="line">&lt;==    Columns: id, name</span><br><span class="line">&lt;==        Row: 1, 6565</span><br><span class="line">&lt;==      Total: 1</span><br><span class="line">blogMapper1 è·å–æ•°æ®TbBlog&#123;id=1, name=&#x27;6565&#x27;&#125;</span><br><span class="line">Cache Hit Ratio [com.iyang.mybatis.mapper.BlogMapper]: 0.5</span><br><span class="line">blogMapper2 è·å–æ•°æ®TbBlog&#123;id=1, name=&#x27;6565&#x27;&#125;</span><br></pre></td></tr></table></figure><p>ä»è¿™é‡Œçœ‹, æ˜¯å¦æäº¤äº‹åŠ¡å¯ä»¥çœ‹å‡ºæ¥ï¼Œæ˜¯ä¼šå½±å“äºŒçº§ç¼“å­˜çš„.</p><p><strong>æ¡ˆä¾‹äºŒ : ä¸­é—´ç©¿æ’æ›´æ–°è¯­å¥</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String[] args)  throws Exception &#123;</span><br><span class="line"></span><br><span class="line">    InputStream mybatisInputStream = Resources.getResourceAsStream(&quot;mybatis-config.xml&quot;);</span><br><span class="line">    SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(mybatisInputStream);</span><br><span class="line">    SqlSession sqlSession1 = sqlSessionFactory.openSession(false);</span><br><span class="line">    SqlSession sqlSession2 = sqlSessionFactory.openSession(false);</span><br><span class="line">    SqlSession sqlSession3 = sqlSessionFactory.openSession(false);</span><br><span class="line"></span><br><span class="line">    BlogMapper blogMapper1 = sqlSession1.getMapper(BlogMapper.class);</span><br><span class="line">    BlogMapper blogMapper2 = sqlSession2.getMapper(BlogMapper.class);</span><br><span class="line">    BlogMapper blogMapper3 = sqlSession3.getMapper(BlogMapper.class);</span><br><span class="line"></span><br><span class="line">    System.out.println(&quot; blogMapper1 æŸ¥è¯¢å‡ºæ¥çš„æ•°æ® : &quot; + blogMapper1.selectBlog(1));</span><br><span class="line">    sqlSession1.commit();</span><br><span class="line"></span><br><span class="line">    System.out.println(&quot; blogMapper2 æŸ¥è¯¢å‡ºæ¥çš„ç»“æœ : &quot; + blogMapper2.selectBlog(1));</span><br><span class="line"></span><br><span class="line">    System.out.println(blogMapper3.updateHashCode(&quot;GavinYang&quot;));</span><br><span class="line">    sqlSession3.commit();</span><br><span class="line"></span><br><span class="line">    System.out.println(&quot; blogMapper2 æŸ¥è¯¢å‡ºæ¥çš„ç»“æœ : &quot; + blogMapper2.selectBlog(1));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//  ------------------  æ‰“å°ç»“æœ ------</span><br><span class="line"></span><br><span class="line">Created connection 630074945.</span><br><span class="line">Setting autocommit to false on JDBC Connection [com.mysql.jdbc.JDBC4Connection@258e2e41]</span><br><span class="line">==&gt;  Preparing: select * from tb_blog where id = ? </span><br><span class="line">==&gt; Parameters: 1(Integer)</span><br><span class="line">&lt;==    Columns: id, name</span><br><span class="line">&lt;==        Row: 1, 6565</span><br><span class="line">&lt;==      Total: 1</span><br><span class="line"> blogMapper1 æŸ¥è¯¢å‡ºæ¥çš„æ•°æ® : TbBlog&#123;id=1, name=&#x27;6565&#x27;&#125;</span><br><span class="line">Cache Hit Ratio [com.iyang.mybatis.mapper.BlogMapper]: 0.5</span><br><span class="line"> blogMapper2 æŸ¥è¯¢å‡ºæ¥çš„ç»“æœ : TbBlog&#123;id=1, name=&#x27;6565&#x27;&#125;</span><br><span class="line"></span><br><span class="line">Created connection 603443293.</span><br><span class="line">Setting autocommit to false on JDBC Connection [com.mysql.jdbc.JDBC4Connection@23f7d05d]</span><br><span class="line">==&gt;  Preparing: update tb_blog set name = ? where id = 1; </span><br><span class="line">==&gt; Parameters: GavinYang(String)</span><br><span class="line">&lt;==    Updates: 1</span><br><span class="line">1</span><br><span class="line">Committing JDBC Connection [com.mysql.jdbc.JDBC4Connection@23f7d05d]</span><br><span class="line">Cache Hit Ratio [com.iyang.mybatis.mapper.BlogMapper]: 0.3333333333333333</span><br><span class="line">Opening JDBC Connection</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">Created connection 707976812.</span><br><span class="line">Setting autocommit to false on JDBC Connection [com.mysql.jdbc.JDBC4Connection@2a32de6c]</span><br><span class="line">==&gt;  Preparing: select * from tb_blog where id = ? </span><br><span class="line">==&gt; Parameters: 1(Integer)</span><br><span class="line">&lt;==    Columns: id, name</span><br><span class="line">&lt;==        Row: 1, GavinYang</span><br><span class="line">&lt;==      Total: 1</span><br><span class="line"> blogMapper2 æŸ¥è¯¢å‡ºæ¥çš„ç»“æœ : TbBlog&#123;id=1, name=&#x27;GavinYang&#x27;&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ˜¯å¯ä»¥çœ‹åˆ°åœ¨æ›´æ–°ä¹‹åå¹¶ä¸” commit äº†äº‹åŠ¡ä¹‹åï¼Œåé¢ç´§è·Ÿçš„ sql æ˜¯å»æŸ¥è¯¢ æ•°æ®åº“äº†çš„. æ‰€ä»¥è¿™é‡Œæ˜¯å¯ä»¥çœ‹å‡ºæ¥ï¼Œupdateç­‰æ“ä½œæ˜¯ä¼šå» æ¸…ç©ºå¯¹åº”çš„ç¼“å­˜çš„ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬æ ¹æ® æ¡ˆä¾‹ä¸€ çš„æƒ…å†µæ¥åˆ†æï¼Œåœ¨å¼€å¯äº† äºŒçº§ç¼“å­˜ çš„æ—¶å€™ï¼Œæ˜¯ä»å“ªé‡Œè·å–å‡ºæ¥çš„æ•°æ®çš„å‘¢ï¼Ÿ</p><p>debug è·Ÿè¿›æ¥ : org.apache.ibatis.executor.CachingExecutor#query(org.apache.ibatis.mapping.MappedStatement, java.lang.Object, org.apache.ibatis.session.RowBounds, org.apache.ibatis.session.ResultHandler, org.apache.ibatis.cache.CacheKey, org.apache.ibatis.mapping.BoundSql)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public &lt;E&gt; List&lt;E&gt; query(MappedStatement ms, Object parameterObject, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql)</span><br><span class="line">    throws SQLException &#123;</span><br><span class="line">  Cache cache = ms.getCache();</span><br><span class="line">  if (cache != null) &#123;</span><br><span class="line">    flushCacheIfRequired(ms);</span><br><span class="line">    if (ms.isUseCache() &amp;&amp; resultHandler == null) &#123;</span><br><span class="line">      ensureNoOutParams(ms, boundSql);</span><br><span class="line">      @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">// debug åˆ°è¿™é‡Œï¼Œå¯ä»¥çœ‹åˆ°,å°±å·²ç»è¿”å›äº†æˆ‘ä»¬éœ€è¦çš„æ•°æ®.        </span><br><span class="line">      List&lt;E&gt; list = (List&lt;E&gt;) tcm.getObject(cache, key);</span><br><span class="line">      if (list == null) &#123;</span><br><span class="line">        list = delegate.query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);</span><br><span class="line">        tcm.putObject(cache, key, list); // issue #578 and #116</span><br><span class="line">      &#125;</span><br><span class="line">      return list;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return delegate.query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>org.apache.ibatis.executor.CachingExecutor#tcm è°ƒç”¨è¿™ä¸ªå¯¹è±¡çš„ getObject æ–¹æ³•è·å–åˆ°äº†æˆ‘ä»¬éœ€è¦çš„å€¼, è·Ÿè¿›æ¥åˆä» org.apache.ibatis.cache.decorators.TransactionalCache çš„ getObject è·å–å‡ºæˆ‘ä»¬çš„å€¼, æœ€åä» org.apache.ibatis.cache.decorators.TransactionalCache#delegate è·å–å‡ºå€¼, è¿”å›å›æ¥çš„.</p><p>org.apache.ibatis.cache.decorators.TransactionalCache#getObject</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Object getObject(Object key) &#123;</span><br><span class="line">  // issue #116</span><br><span class="line">// ä»ç¼“å­˜ä¸­è·å–å‡ºå€¼.    </span><br><span class="line">  Object object = delegate.getObject(key);</span><br><span class="line">  if (object == null) &#123;</span><br><span class="line">// å¦‚æœè·å–å‡ºæ¥æ˜¯null,ä¹Ÿå°±æ˜¯ç¼“å­˜ä¸­æ²¡æœ‰çš„è¯,org.apache.ibatis.cache.decorators.TransactionalCache#entriesMissedInCache å°±æ·»åŠ åˆ°è¿™ä¸ªé›†åˆä¸­æ¥.      </span><br><span class="line">    entriesMissedInCache.add(key);</span><br><span class="line">  &#125;</span><br><span class="line">  // issue #146</span><br><span class="line">// commit åéœ€è¦ clear çš„è¯ï¼Œå°±ä¼šè¿”å› null.</span><br><span class="line">// è¿™é‡Œæƒ³ä¸‹è¿™ä¸ªå˜é‡ä¼šä¸ä¼šå’Œæˆ‘é—¨æ¡ˆä¾‹äºŒä¸­çš„ update æ“ä½œæœ‰å…³ç³»å‘¢ï¼Ÿ</span><br><span class="line">// è¿™é‡Œå† updateåå† debug å‘ç°,  delegate ä¸­è·å–å‡ºæ¥çš„æ˜¯ null ,ä¹Ÿå°±æ˜¯ç¡®å®æ˜¯è·å–ä¸åˆ°ç¼“å­˜äº†</span><br><span class="line">// å’Œè¿™ä¸ªå‚æ•°æ²¡å…³ç³».    </span><br><span class="line">  if (clearOnCommit) &#123;</span><br><span class="line">    return null;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    return object;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>MyBatis äºŒçº§ç¼“å­˜ä¸é€‚åº”äºé…ç½®æ–‡ä»¶ä¸­å­˜åœ¨å¤šè¡¨æŸ¥è¯¢çš„æƒ…å†µ. ä¸€èˆ¬æˆ‘ä»¬æ˜¯å•è¡¨çš„ cache, ç”±äº mybatis çš„äºŒçº§ç¼“å­˜æ˜¯åŸºäº namespace çš„, å¤šè¡¨æŸ¥è¯¢è¯­å¥æ‰€åœ¨çš„ namespace æ— æ³•æ„Ÿåº”åˆ°å…¶ä»–çš„ namespace ä¸­çš„è¯­å¥å¯¹å¤šè¡¨ä¸­è®¾è®¡ä¿®æ”¹ï¼Œå°±ä¼šå¼•å‘è„æ•°æ®. è¿™ä¸ªæ—¶å€™ï¼Œå¯ä»¥é‡‡ç”¨ cache-ref æ¥åšå¤„ç†ï¼Œä½†æ˜¯è¿™æ ·çš„è¯,ç¼“å­˜çš„é¢—ç²’åº¦å°±å˜ç²—äº†.</p><p>æ‰§è¡Œæµç¨‹ : å¦‚æœå¼€å¯äº†äºŒçº§ç¼“å­˜çš„è¯ï¼Œ MyBatis ä¼šå…ˆèµ°äºŒçº§ç¼“å­˜ï¼Œå¦‚æœäºŒçº§ç¼“å­˜æ²¡æœ‰çš„è¯ï¼Œå°±ä¼šå»ä¸€çº§ç¼“å­˜çœ‹çœ‹ï¼Œå¦‚æœéƒ½æ²¡æœ‰çš„è¯ï¼Œå°±å»æŸ¥è¯¢æ•°æ®åº“.</p><p>äºŒçº§ç¼“å­˜ : ç”¨ org.apache.ibatis.executor.CachingExecutor è£…é¥°äº† org.apache.ibatis.executor.BaseExecutor çš„å­ç±», å§”æ‰˜å…·ä½“èŒè´£ç»™ delegate ä¹‹å‰ï¼Œå®ç°äº†äºŒçº§ç¼“å­˜çš„æŸ¥è¯¢å’Œå†™å…¥åŠŸèƒ½.</p><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>æœ€åçœ‹ ä¸€çº§ç¼“å­˜å’ŒäºŒçº§ç¼“å­˜ï¼Œéƒ½æ˜¯åˆ©ç”¨çš„ HashMap è¿™ç§æ¥åšåˆ°æœ¬åœ°ç¼“å­˜ï¼Œ åªæ˜¯äºŒçº§ç¼“å­˜çš„ä½œç”¨èŒƒå›´æ¯”èµ·ä¸€çº§ç¼“å­˜çš„è¯ï¼Œæ˜¯è¦å¤§çš„ï¼Œå¹¶ä¸”ä¹Ÿåˆ©ç”¨äº†ä¸€äº› è£…é¥°è€… ç­‰è®¾è®¡æ¨¡å¼æ¥è®¾è®¡äºŒçº§ç¼“å­˜çš„.</p><p>å¦‚æœæ˜¯éƒ¨ç½²çš„åˆ†å¸ƒå¼é¡¹ç›®çš„è¯ï¼Œé‚£ä¹ˆè¿˜æ˜¯ å¾—åˆ‡æ¢åˆ° redis è¿™ç§ç¼“å­˜æ¥äº†ï¼Œ æœ¬åœ°åˆ©ç”¨ HashMap è¿™ç§ç¼“å­˜æ»¡è¶³ä¸äº†çš„.</p><p>æ–‡çŒ®å‚è€ƒåœ°å€ : <a target="_blank" rel="noopener" href="https://tech.meituan.com/2018/01/19/mybatis-cache.html">https://tech.meituan.com/2018/01/19/mybatis-cache.html</a></p></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://ruy9527.github.io/2021/11/04/mybatis/mybatis%E4%B8%ADconfig-xml%E4%BB%A3%E7%A0%81%E9%98%85%E8%AF%BB/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/touxiang.jpg"><meta itemprop="name" content="YangBao"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="YangBao"><meta itemprop="description" content="çŸ¥è¯†ç¬”è®°"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | YangBao"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2021/11/04/mybatis/mybatis%E4%B8%ADconfig-xml%E4%BB%A3%E7%A0%81%E9%98%85%E8%AF%BB/" class="post-title-link" itemprop="url">mybatisä¸­config-xmlä»£ç é˜…è¯»</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Created: 2021-11-04 00:28:20" itemprop="dateCreated datePublished" datetime="2021-11-04T00:28:20+08:00">2021-11-04</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">Edited on</span> <time title="Modified: 2022-11-04 21:46:13" itemprop="dateModified" datetime="2022-11-04T21:46:13+08:00">2022-11-04</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/java%E6%A1%86%E6%9E%B6/" itemprop="url" rel="index"><span itemprop="name">javaæ¡†æ¶</span></a> </span>, <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/java%E6%A1%86%E6%9E%B6/mybatis/" itemprop="url" rel="index"><span itemprop="name">mybatis</span></a> </span></span><span class="post-meta-break"></span> <span class="post-meta-item" title="Symbols count in article"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">Symbols count in article: </span><span>19k</span> </span><span class="post-meta-item" title="Reading time"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">Reading time &asymp;</span> <span>17 mins.</span></span></div></div></header><div class="post-body" itemprop="articleBody"><h4 id="é¢˜è®°"><a href="#é¢˜è®°" class="headerlink" title="é¢˜è®°"></a>é¢˜è®°</h4><p>å¯¹äºé…ç½®æ–‡ä»¶çš„è§£æ, è¿˜æ˜¯ç›¸å¯¹æ¯”è¾ƒå¥½ç†è§£çš„, å°±æ˜¯è¯»å–é…ç½®æ–‡ä»¶, ç„¶ååœ¨ä»£ç éœ€è¦çš„åœ°æ–¹ç»™ä½¿ç”¨åˆ°.</p><p>è¿™é‡Œ,å¯ä»¥æ‰©å±•ä¸‹, Spring &#x2F; SpringBoot ç­‰æ˜¯æ€ä¹ˆè¯»å–é…ç½®æ–‡ä»¶å‘¢ ? å¹¶ä¸”é…ç½®æ–‡ä»¶è¿˜æ˜¯æœ‰ xml &#x2F; properties&#x2F;yaml ç­‰æ ¼å¼çš„ ï¼Œ å…¶è¯»å–ä»£ç æ˜¯æ€ä¹ˆå†™çš„ ? ç„¶ååŸºäº é˜¿æ³¢ç½—(æºç¨‹å¼€æº) çš„é…ç½®ä¸­å¿ƒ , å…¶å®ç°é…ç½®åˆæ˜¯æ€ä¹ˆå®ç°çš„å‘¢ ? ç„¶åè¿™é‡Œï¼Œçœ‹äº† Mybatis è¯»å–é…ç½®æ–‡ä»¶, åç»­å†å‡º Spring é…ç½®æ–‡ä»¶çš„æ—¶å€™ï¼Œå¦‚æœäºŒè€…è¯»å–é…ç½®è¿›è¡Œå¯¹æ¯”, ä½ ä¸ªäººæ›´å€¾å‘ä½¿ç”¨ä»£ç å‘¢ ?</p><p>æ‰€ä»¥,è¿™é‡Œå°±å¼€å¯è¯»å– Mybatis æ˜¯å¦‚ä½•è§£æé…ç½®æ–‡ä»¶çš„æ“ä½œ.</p><h4 id="é…ç½®æ–‡ä»¶"><a href="#é…ç½®æ–‡ä»¶" class="headerlink" title="é…ç½®æ–‡ä»¶"></a>é…ç½®æ–‡ä»¶</h4><p>è¿™é‡Œçš„é…ç½®æ–‡ä»¶è§£è¯»,æ˜¯æ ¹æ® MyBatiså®˜ç½‘æ¥ä¸€æ­¥ä¸€æ­¥çš„è§£æé˜…è¯». å¦‚æœæœ‰å®˜ç½‘æ²¡æœ‰æ¶‰åŠåˆ°çš„,å‘ç°äº†ä¹Ÿä¼šåœ¨åç»­åŠ ä¸Šå»çš„. è§£æå¤šè¡Œä»£ç , æ‰èƒ½ç†è§£ ä½•ä¸ºä¼˜ç§€.</p><p><strong>æ ‡ç­¾ä¸€ : properties</strong></p><p>org.apache.ibatis.builder.xml.XMLConfigBuilder#parseConfiguration â€”&gt; propertiesElement(root.evalNode(â€œpropertiesâ€)) æ–¹æ³•ä¸­æ¥.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">// è¿™é‡Œä¼ å…¥è¿›æ¥çš„ XNode çš„å€¼,å°±æ˜¯æˆ‘ä»¬å†™çš„ properties æ ‡ç­¾.</span><br><span class="line">// å¯ä»¥çœ‹åˆ° XNodeçš„å±æ€§,nameæ ‡ç­¾çš„åå­—,attributeså°±æ˜¯key/valueå±æ€§</span><br><span class="line">// æ¯”å¦‚è¿™é‡Œ: key å°±æ˜¯ resource , value å°±æ˜¯ ./db.properties.</span><br><span class="line">private void propertiesElement(XNode context) throws Exception &#123;</span><br><span class="line">  if (context != null) &#123;</span><br><span class="line">// è¿™é‡Œè°ƒç”¨çš„node.getChildNodes(),å¦‚æœæœ‰ç‚¹è¯,ä¼šéå†æŒ¨ä¸ªè§£æ,æœ€åå°è£…æˆä¸ºkey/valueç»“æ„.      </span><br><span class="line">    Properties defaults = context.getChildrenAsProperties();</span><br><span class="line">// è·å– resource / url äºŒè€…çš„å€¼.      </span><br><span class="line">    String resource = context.getStringAttribute(&quot;resource&quot;);</span><br><span class="line">    String url = context.getStringAttribute(&quot;url&quot;);</span><br><span class="line">// å¦‚æœäºŒè€…éƒ½æ˜¯null,å°±ä¼šæŠ›å‡ºå¼‚å¸¸æ¥.      </span><br><span class="line">    if (resource != null &amp;&amp; url != null) &#123;</span><br><span class="line">      throw new BuilderException(&quot;The properties element cannot specify both a URL and a resource based property file reference.  Please specify one or the other.&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">      </span><br><span class="line"> // è¿™é‡Œå…ˆå¤„ç†resource,å†å¤„ç†url,ä¹Ÿå°±æ˜¯æœ‰å¯èƒ½urlä¼šè¦†ç›–æ‰resourceçš„å†…å®¹.</span><br><span class="line"> // äºŒè€…è¯»å–çš„æ–¹å¼ä¸ä¸€æ ·,å‰è€…æ˜¯æ ¹æ® resourceå¼€å§‹è¯»,urlæ˜¯æ ¹æ®ç»å¯¹è·¯å¾„å¼€å§‹è¯».</span><br><span class="line"> // æœ€å defaults é‡Œé¢æ”¾å…¥çš„å…¨éƒ¨æ˜¯ key/value å¯¹åº”çš„é”®å€¼å¯¹</span><br><span class="line"> // ä¹Ÿå°±æ˜¯db.propertiesä¸­çš„ key / value ç›¸å¯¹åº”ièµ·æ¥.     </span><br><span class="line">    if (resource != null) &#123;</span><br><span class="line">      defaults.putAll(Resources.getResourceAsProperties(resource));</span><br><span class="line">    &#125; else if (url != null) &#123;</span><br><span class="line">      defaults.putAll(Resources.getUrlAsProperties(url));</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">// è¿™é‡Œçœ‹çš„æ˜¯ xml é‡Œé¢æ˜¯ä¸æ˜¯ç›´æ¥æœ‰ porperties é…ç½®.     </span><br><span class="line">// å¦‚æœæœ‰çš„è¯,å°±ä¼šputAllè¿›å».      </span><br><span class="line">    Properties vars = configuration.getVariables();</span><br><span class="line">    if (vars != null) &#123;</span><br><span class="line">      defaults.putAll(vars);</span><br><span class="line">    &#125;</span><br><span class="line">// æœ€åå§ defaults,ä¹Ÿå°±æ˜¯propertiesç»™æ”¾å…¥åˆ° BaseBuilder å’Œ Confifurationä¸­å».      </span><br><span class="line">    parser.setVariables(defaults);</span><br><span class="line">    configuration.setVariables(defaults);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-----------------------------</span><br><span class="line">//  å¦‚ä½•è®© Properties vars = configuration.getVariables(); æœ‰å€¼å‘¢ ?</span><br><span class="line">//  å¦‚æœåªæ˜¯å•ä¸ªçš„ MyBatis é¡¹ç›®çš„è¯, å°±è‡ªå·±æ‰‹åŠ¨newä¸€ä¸ªpropertieså¯¹è±¡</span><br><span class="line">//  ç„¶åkeyè¾“å…¥è‡ªå·±è¦è¦†ç›–æ‰çš„keyå°±å¯ä»¥äº†</span><br><span class="line">        Properties dbConfigProperties = new Properties();</span><br><span class="line">        dbConfigProperties.setProperty(&quot;jdbc.password&quot;,&quot;GavinYang&quot;);</span><br><span class="line"></span><br><span class="line">        SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(mybatisInputStream,dbConfigProperties);</span><br></pre></td></tr></table></figure><p><strong>æ ‡ç­¾äºŒ : settings</strong></p><p>è¿™æ˜¯ MyBatiså¯¹ settings çš„æ“ä½œ.</p><p>å…·ä½“çš„ settings ä¸­æ¯é¡¹é…ç½®å‚è€ƒå®˜ç½‘é“¾æ¥ : <a target="_blank" rel="noopener" href="https://mybatis.org/mybatis-3/configuration.html#properties">https://mybatis.org/mybatis-3/configuration.html#properties</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// è§£æ setting ---&gt; è½¬åŒ–ä¸º key /value</span><br><span class="line">Properties settings = settingsAsProperties(root.evalNode(&quot;settings&quot;));</span><br><span class="line">// </span><br><span class="line">loadCustomVfs(settings);</span><br><span class="line">loadCustomLogImpl(settings);</span><br></pre></td></tr></table></figure><p>settingsAsProperties æ–¹æ³•</p><p>å¯ä»¥çœ‹åˆ°, è¯¥æ–¹æ³•å°±æ˜¯è¿›è¡ŒåŠ è½½,è½¬åŒ–ä¸ºkey&#x2F;valueé”®å€¼å¯¹ç±»å‹, ç„¶åå¯¹å…¶keyæ£€éªŒæ˜¯å¦åœ¨</p><p>Configuration ä¸­éƒ½æœ‰ set æ–¹æ³•.</p><p>Notes : ä¸ºäº†éªŒè¯ä¸‹, æˆ‘ä»¬åŠ ä¸Šä¸€ä¸ªæ²¡æœ‰çš„æ ‡ç­¾, å¯ä»¥çœ‹åˆ°ä¸‹é¢çš„å¼‚å¸¸. æ‰€ä»¥æˆ‘ä»¬çœ‹åˆ°è¿™ç§å¼‚å¸¸çš„æ—¶å€™ï¼Œæ˜¯å¯ä»¥å»æ£€æŸ¥ä¸‹æ˜¯ä¸æ˜¯åå­—ä»€ä¹ˆæœ‰é—®é¢˜.</p><h3 id="Cause-org-apache-ibatis-builder-BuilderException-Error-parsing-SQL-Mapper-Configuration-Cause-org-apache-ibatis-builder-BuilderException-The-setting-nnnnn-is-not-known-Make-sure-you-spelled-it-correctly-case-sensitive"><a href="#Cause-org-apache-ibatis-builder-BuilderException-Error-parsing-SQL-Mapper-Configuration-Cause-org-apache-ibatis-builder-BuilderException-The-setting-nnnnn-is-not-known-Make-sure-you-spelled-it-correctly-case-sensitive" class="headerlink" title="Cause: org.apache.ibatis.builder.BuilderException: Error parsing SQL Mapper Configuration. Cause: org.apache.ibatis.builder.BuilderException: The setting nnnnn is not known. Make sure you spelled it correctly (case sensitive)."></a>Cause: org.apache.ibatis.builder.BuilderException: Error parsing SQL Mapper Configuration. Cause: org.apache.ibatis.builder.BuilderException: The setting nnnnn is not known. Make sure you spelled it correctly (case sensitive).</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">private Properties settingsAsProperties(XNode context) &#123;</span><br><span class="line">  if (context == null) &#123;</span><br><span class="line">    return new Properties();</span><br><span class="line">  &#125;</span><br><span class="line"> // å¯¹ settings ä¸‹çš„ setting è¿›è¡Œè§£æ å¹¶ä¸” è½¬åŒ–ä¸º key / value æ“ä½œ.   </span><br><span class="line">  Properties props = context.getChildrenAsProperties();</span><br><span class="line">  // Check that all settings are known to the configuration class</span><br><span class="line"> // å¯¹ Configuration è¿›è¡Œæ ¡éªŒ, ç¡®è®¤ä¸Šé¢çš„ props ä¸­çš„key åœ¨ Configuration</span><br><span class="line">// ä¸­æ˜¯éƒ½æœ‰set æ–¹æ³•çš„,ç›®æµ‹æ˜¯åé¢åå°„éœ€è¦ä½¿ç”¨åˆ°.    </span><br><span class="line">  MetaClass metaConfig = MetaClass.forClass(Configuration.class, localReflectorFactory);</span><br><span class="line">  for (Object key : props.keySet()) &#123;</span><br><span class="line">    if (!metaConfig.hasSetter(String.valueOf(key))) &#123;</span><br><span class="line">      throw new BuilderException(&quot;The setting &quot; + key + &quot; is not known.  Make sure you spelled it correctly (case sensitive).&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return props;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>loadCustomVfs(settings) æ–¹æ³•</p><p>è¯¥æ–¹æ³•,ä¸»è¦å°±æ˜¯è¯»å– vfsImpl å¯¹ç”¨çš„value,åˆ‡å‰²ä¸‹,ç„¶åç”¨ classForName æ¥è·å– class,</p><p>æœ€åèµ‹å€¼åˆ° configuration ä¸­å». è¿™é‡Œç®—æ˜¯å¯¹ vfs çš„ä¸€ç§è‡ªå®šä¹‰çš„æ‰©å±•,è™½ç„¶ç›®å‰è¿˜ä¸å¤ªæ¸…æ¥švfså…·ä½“ä½œç”¨.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">private void loadCustomVfs(Properties props) throws ClassNotFoundException &#123;</span><br><span class="line">  // è·å– vfsImpl çš„ value.  </span><br><span class="line">  String value = props.getProperty(&quot;vfsImpl&quot;);</span><br><span class="line">  if (value != null) &#123;</span><br><span class="line">   // æ ¹æ® , è¿›è¡Œåˆ‡å‰².   </span><br><span class="line">    String[] clazzes = value.split(&quot;,&quot;);</span><br><span class="line">    for (String clazz : clazzes) &#123;</span><br><span class="line">      if (!clazz.isEmpty()) &#123;</span><br><span class="line">        @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">        // åå°„,è·å–å‡º Class , æœ€åèµ‹å€¼åˆ° configuration ä¸­å».  </span><br><span class="line">        Class&lt;? extends VFS&gt; vfsImpl = (Class&lt;? extends VFS&gt;)Resources.classForName(clazz);</span><br><span class="line">        configuration.setVfsImpl(vfsImpl);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>loadCustomLogImpl(settings) æ–¹æ³•</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">private void loadCustomLogImpl(Properties props) &#123;</span><br><span class="line">  Class&lt;? extends Log&gt; logImpl = resolveClass(props.getProperty(&quot;logImpl&quot;));</span><br><span class="line">  // å°† log set åˆ° configuration ä¸­å».  </span><br><span class="line">  configuration.setLogImpl(logImpl);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-----------------------</span><br><span class="line">// resolve æœ€åå¦‚æœä¸æ˜¯ null çš„è¯,</span><br><span class="line">org.apache.ibatis.type.TypeAliasRegistry#resolveAlias</span><br><span class="line"></span><br><span class="line"> // å°±ä¼šèµ°åˆ°è¿™é‡Œ,è¿™é‡Œå¯ä»¥çœ‹å…ˆæ˜¯åœ¨ typeAliases(HashMap) ä¸­åˆ¤æ–­ä¸‹,å¦‚æœå­˜åœ¨å°±ç›´æ¥è·å–</span><br><span class="line">// å¦‚æœä¸å­˜åœ¨å°±ç”¨ Resources.ClassForNameæ¥æ“ä½œ</span><br><span class="line">// è¿™é‡Œçš„ HashMapå°±ç±»ä¼¼äº,è®°å½•ä¹‹å‰æ˜¯å¦å·²ç»åŠ è½½äº†æˆ–è€…é¢„çƒ­.</span><br><span class="line">// å¦‚æœæ˜¯ç”¨æ¥åšcacheçš„è¯, é‚£å°±åº”è¯¥æœ€åä¼šåœ¨ return ä¹‹å‰ç»§ç»­æŠŠå€¼ç»™æ”¾å…¥è¿›å».    </span><br><span class="line">  public &lt;T&gt; Class&lt;T&gt; resolveAlias(String string) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">      if (string == null) &#123;</span><br><span class="line">        return null;</span><br><span class="line">      &#125;</span><br><span class="line">      // issue #748</span><br><span class="line">      String key = string.toLowerCase(Locale.ENGLISH);</span><br><span class="line">      Class&lt;T&gt; value;</span><br><span class="line">      if (typeAliases.containsKey(key)) &#123;</span><br><span class="line">        value = (Class&lt;T&gt;) typeAliases.get(key);</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        value = (Class&lt;T&gt;) Resources.classForName(string);</span><br><span class="line">      &#125;</span><br><span class="line">      return value;</span><br><span class="line">    &#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">      throw new TypeException(&quot;Could not resolve type alias &#x27;&quot; + string + &quot;&#x27;.  Cause: &quot; + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">------------</span><br><span class="line">// å¦‚æœæˆ‘ä»¬åœ¨é…ç½®æ–‡ä»¶ä¸­æ²¡æœ‰å®šä¹‰çš„è¯,è¿™é‡Œé»˜è®¤æ˜¯null,ä¹Ÿå°±æ˜¯è¯´ä¸ä¼šsetè¿›å».    </span><br><span class="line">  public void setLogImpl(Class&lt;? extends Log&gt; logImpl) &#123;</span><br><span class="line">    if (logImpl != null) &#123;</span><br><span class="line">      this.logImpl = logImpl;</span><br><span class="line">      LogFactory.useCustomLogging(this.logImpl);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p><strong>æ ‡ç­¾ä¸‰ :</strong></p><p>å…³äºåˆ«åçš„é…ç½®.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">typeAliasesElement(root.evalNode(&quot;typeAliases&quot;));</span><br><span class="line">private void typeAliasesElement(XNode parent) &#123;</span><br><span class="line">  if (parent != null) &#123;</span><br><span class="line">   // å¯¹ typeAliases ä¸‹çš„å­æ ‡ç­¾è¿›è¡Œè¿­ä»£.</span><br><span class="line">   // åˆ†ä¸ºæ˜¯ package å’Œé package   </span><br><span class="line">    for (XNode child : parent.getChildren()) &#123;</span><br><span class="line">      if (&quot;package&quot;.equals(child.getName())) &#123;</span><br><span class="line">       // è·å–ä½ è¾“å…¥çš„åŒ…   </span><br><span class="line">        String typeAliasPackage = child.getStringAttribute(&quot;name&quot;);</span><br><span class="line">        configuration.getTypeAliasRegistry().registerAliases(typeAliasPackage);</span><br><span class="line">      &#125; else &#123;</span><br><span class="line"> // &lt;typeAlias type=&quot;com.iyang.mybatis.pojo.TbBlog&quot; alias=&quot;TbBlog&quot; /&gt;</span><br><span class="line"> // è¿™é‡Œå°±æ˜¯å¯¹è¿™ç§è¿›è¡Œè§£æçš„         </span><br><span class="line">        String alias = child.getStringAttribute(&quot;alias&quot;);</span><br><span class="line">        String type = child.getStringAttribute(&quot;type&quot;);</span><br><span class="line">        try &#123;</span><br><span class="line">          Class&lt;?&gt; clazz = Resources.classForName(type);</span><br><span class="line">   // å¦‚æœæ²¡å†™åˆ«å,å°±åªä¼ å…¥ clazz.         </span><br><span class="line">          if (alias == null) &#123;</span><br><span class="line">            typeAliasRegistry.registerAlias(clazz);</span><br><span class="line">          &#125; else &#123;</span><br><span class="line">   // å†™äº†åˆ«å,å°±åˆ«åå’Œclazzä¸€èµ·ä¼ å…¥è¿›æ¥.           </span><br><span class="line">            typeAliasRegistry.registerAlias(alias, clazz);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">          throw new BuilderException(&quot;Error registering typeAlias for &#x27;&quot; + alias + &quot;&#x27;. Cause: &quot; + e, e);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">----------------</span><br><span class="line">// è¿™é‡Œå¯ä»¥çœ‹åˆ°æ˜¯æ ¹æ® packageName æ¥ registerè¿›æ¥çš„.    </span><br><span class="line">  public void registerAliases(String packageName, Class&lt;?&gt; superType) &#123;</span><br><span class="line">    // new ä¸€ä¸ªè§£æå™¨å·¥å…·ç±»</span><br><span class="line">    ResolverUtil&lt;Class&lt;?&gt;&gt; resolverUtil = new ResolverUtil&lt;&gt;();</span><br><span class="line">    // è·å–åŒ…çš„path,ç„¶åè·å–è¯¥åŒ…ä¸‹çš„æ–‡ä»¶,å¦‚æœæ–‡ä»¶æ˜¯.classç»“å°¾çš„è¯</span><br><span class="line">    // æœ€ååœ¨ ResolverUtil ä¸­matchessæ˜¯æœ‰è¯¥åŒ…ä¸‹çš„å…¨åç§°.</span><br><span class="line">    resolverUtil.find(new ResolverUtil.IsA(superType), packageName);</span><br><span class="line">    // è¿™é‡Œè¿”å›çš„æ˜¯ä¸Šä¸€æ­¥è¯´çš„ matches</span><br><span class="line">    Set&lt;Class&lt;? extends Class&lt;?&gt;&gt;&gt; typeSet = resolverUtil.getClasses();</span><br><span class="line">    for (Class&lt;?&gt; type : typeSet) &#123;</span><br><span class="line">      // Ignore inner classes and interfaces (including package-info.java)</span><br><span class="line">      // Skip also inner classes. See issue #6</span><br><span class="line">      // å¦‚æœä¸æ˜¯æ¥å£,ä¸æ˜¯å†…éƒ¨ç±»ç­‰æ¡ä»¶çš„è¯,å°±èµ°  registerAlias æ–¹æ³•</span><br><span class="line">      if (!type.isAnonymousClass() &amp;&amp; !type.isInterface() &amp;&amp; !type.isMemberClass()) &#123;</span><br><span class="line"> // å…ˆè·å–ç±»åå­—,åˆ¤æ–­è¯¥ç±»ä¸Šæœ‰æ²¡æœ‰ @Alias æ³¨è§£,å¦‚æœæœ‰æ³¨è§£çš„è¯,å°±ç”¨æ³¨è§£çš„å€¼ä½œä¸ºç¼©å†™çš„.</span><br><span class="line"> // æœ€ååˆ¤æ–­æ˜¯ä¸æ˜¯null,æ˜¯nullå°±ä¼šæŠ›å‡ºå¼‚å¸¸æ¥.æœ€åå°†ä¸Šé¢è·å–å‡ºæ¥çš„ç¼©å†™åå­—,è½¬åŒ–ä¸ºå¤§å†™.</span><br><span class="line"> // å¦‚æœæ­¤æ—¶ typeAliases æ˜¯å·²ç»æœ‰äº†è¯¥å€¼çš„è¯,å°±ä¼šæŠ›å‡ºå¼‚å¸¸æ¥.å¦åˆ™å°±æ”¾å…¥åˆ°typeAliasesæ¥</span><br><span class="line"> // private final Map&lt;String, Class&lt;?&gt;&gt; typeAliases = new HashMap&lt;&gt;();</span><br><span class="line"> // å¯ä»¥çœ‹åˆ° typeAliases æ˜¯ä¸€ä¸ªHashMap,å¹¶ä¸”å…¶å­˜å‚¨çš„Key/Valueè¿˜æ˜¯è›®æ˜æ˜¾çš„.         </span><br><span class="line">        registerAlias(type);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p><strong>æ ‡ç­¾å››</strong></p><p>æ‰©å±•çš„ demo å¯ä»¥å‚è€ƒ MyBatiså®˜ç½‘ : <a target="_blank" rel="noopener" href="https://mybatis.org/mybatis-3/configuration.html">https://mybatis.org/mybatis-3/configuration.html</a></p><p>ç„¶åçœ‹ MyBatis æ˜¯å¦‚ä½•å°†æ’ä»¶ç»™åˆ©ç”¨ä¸Šçš„å‘¢ ?</p><p>é¦–å…ˆåœ¨ mybatis-config.xml ä¸­é…ç½®å¥½æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„ plugin</p><p>è¿™é‡Œä»¥æˆ‘é…ç½®äº†äºŒä¸ªæ’ä»¶</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;plugins&gt;</span><br><span class="line">    &lt;plugin interceptor=&quot;com.iyang.mybatis.plugins.ExamplePlugin&quot;&gt;</span><br><span class="line">        &lt;property name=&quot;name&quot; value=&quot;GavinYang&quot;/&gt;</span><br><span class="line">        &lt;property name=&quot;age&quot; value=&quot;22&quot;/&gt;</span><br><span class="line">        &lt;property name=&quot;hobby&quot; value=&quot;lwf&quot;/&gt;</span><br><span class="line">    &lt;/plugin&gt;</span><br><span class="line"></span><br><span class="line">    &lt;plugin interceptor=&quot;com.iyang.mybatis.plugins.QuerySqlPlugin&quot;&gt;</span><br><span class="line"></span><br><span class="line">        &lt;property name=&quot;name&quot; value=&quot;GavinYang&quot;/&gt;</span><br><span class="line">    &lt;/plugin&gt;</span><br><span class="line">&lt;/plugins&gt;</span><br></pre></td></tr></table></figure><p>&#x2F;&#x2F; å¤„ç† plugin çš„ä»£ç </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">private void pluginElement(XNode parent) throws Exception &#123;</span><br><span class="line">  // è¿™é‡Œä¼ å…¥è¿›æ¥çš„å°±æ˜¯ &lt;plugins&gt;æ•´ä¸ªæ ‡ç­¾å†…å®¹.  </span><br><span class="line">  if (parent != null) &#123;</span><br><span class="line">   // è·å– &lt;plugins&gt; ä¸‹çš„ &lt;plugin&gt; é›†åˆ,è¿›è¡Œè¿­ä»£å¤„ç†.   </span><br><span class="line">    for (XNode child : parent.getChildren()) &#123;</span><br><span class="line">     // è·å–æ’ä»¶çš„ å…¨é™å®šåå­—.   </span><br><span class="line">      String interceptor = child.getStringAttribute(&quot;interceptor&quot;);</span><br><span class="line">     // è·å–æˆ‘ä»¬å®šä¹‰åœ¨ plugin ä¸‹çš„ properties.   </span><br><span class="line">      Properties properties = child.getChildrenAsProperties();</span><br><span class="line">// resolveClassæ˜¯æœ€åæ³¨å†Œåˆ°typeAliasRegistryæ¥.    </span><br><span class="line">// å®ä¾‹åŒ–,è¿™é‡Œå°±å¯ä»¥çœ‹åˆ°æˆ‘ä»¬åœ¨å®šä¹‰çš„Pluginä¸­,æ— å‚æ„é€ å‡½æ•°æ‰“å°å‡ºæ¥çš„å†…å®¹äº†.        </span><br><span class="line">      Interceptor interceptorInstance = (Interceptor) resolveClass(interceptor).getDeclaredConstructor().newInstance();</span><br><span class="line">// å°† properties èµ‹å€¼ç»™  interceptorInstance</span><br><span class="line">// ä¹Ÿå°±æ˜¯æ”¾å…¥åˆ° interceptorInstance æ¥.        </span><br><span class="line">      interceptorInstance.setProperties(properties);</span><br><span class="line">// org.apache.ibatis.plugin.InterceptorChain</span><br><span class="line">// è¿™æ˜¯æ˜¯å°†interceptorInstanceæ·»åŠ åˆ°InterceptorChainçš„interceptorsä¸­æ¥.        </span><br><span class="line">      configuration.addInterceptor(interceptorInstance);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° MyBatisåœ¨åŠ è½½pluginçš„æ—¶å€™,æ˜¯åˆ©ç”¨äº†åå°„æ¥newå‡ºä¸€ä¸ªå¯¹è±¡æ¥,å¹¶ä¸”æ³¨å†Œåˆ° typeAliasRegistry ä¸­æ¥. è¿™é‡Œä¸»è¦æ˜¯è§£æ plugin çš„é…ç½®, åé¢åœ¨æ‰§è¡Œsqlçš„æ—¶å€™,éƒ½æ˜¯å¦‚ä½•ä½¿ç”¨åˆ°è¿™äº› plugin çš„å‘¢ ? è‚¯å®šæ˜¯æœ‰ä¸€ä¸ªä»InterceptorChainä¸­è·å–interceptorsæ¥,ç„¶åè¿›è¡Œå¤„ç†.</p><p><strong>æ ‡ç­¾äº” : &lt; objectFactory &gt;</strong></p><p>objectFactory çš„å¤„ç†æ–¹å¼æ˜¯å’Œ æ ‡ç­¾å››ç›¸ä¼¼çš„,åªæ˜¯æœ€ååœ¨ä½¿ç”¨åœºæ™¯æ˜¯æœ‰ç‚¹ä¸åŒçš„.</p><p>ä»£ç ä¸Šçš„æ“ä½œä¹Ÿæ˜¯ç±»ä¼¼çš„.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">private void objectFactoryElement(XNode context) throws Exception &#123;</span><br><span class="line">  if (context != null) &#123;</span><br><span class="line">    String type = context.getStringAttribute(&quot;type&quot;);</span><br><span class="line">    Properties properties = context.getChildrenAsProperties();</span><br><span class="line">    ObjectFactory factory = (ObjectFactory) resolveClass(type).getDeclaredConstructor().newInstance();</span><br><span class="line">    factory.setProperties(properties);</span><br><span class="line">    configuration.setObjectFactory(factory);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ ‡ç­¾äº” :</strong></p><p>è¯¥æ ‡ç­¾åœ¨ MyBatis å®˜ç½‘æ˜¯æ²¡æœ‰demo, æˆ‘æ˜¯æ ¹æ®ä»£ç æ¥é¡ºè—¤æ‘¸ç“œå†™çš„ä¸€ä¸ª.</p><p>å‚è€ƒ : org.apache.ibatis.reflection.wrapper.DefaultObjectWrapperFactory è¿™ä¸ªæºç ,æ¥æ¨¡ä»¿å†™çš„ä¸€ä¸ª.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">objectWrapperFactoryElement(root.evalNode(&quot;objectWrapperFactory&quot;));</span><br><span class="line">private void objectWrapperFactoryElement(XNode context) throws Exception &#123;</span><br><span class="line">  if (context != null) &#123;</span><br><span class="line">   // è·å– é…ç½®æ–‡ä»¶ä¸­çš„typeå€¼   </span><br><span class="line">    String type = context.getStringAttribute(&quot;type&quot;);</span><br><span class="line"> // å…ˆæ³¨å†Œåˆ°  typeAliasRegistry æ¥,ç„¶åå®ä¾‹åŒ–è¿™ä¸ªç±».</span><br><span class="line"> // æˆ‘ä»¬åœ¨è‡ªå·±å®šä¹‰çš„ç±»ä¸­,å†™ä¸€ä¸ªæ— å‚æ„é€ å‡½æ•°,å°±å¯ä»¥çœ‹åˆ°æˆ‘ä»¬æ‰“å°çš„å†…å®¹äº†.     </span><br><span class="line">    ObjectWrapperFactory factory = (ObjectWrapperFactory) resolveClass(type).getDeclaredConstructor().newInstance();</span><br><span class="line">// æœ€åèµ‹å€¼åˆ° confifuration ä¸­æ¥.      </span><br><span class="line">    configuration.setObjectWrapperFactory(factory);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ ‡ç­¾å…­ : &lt; reflectorFactory &gt;</strong></p><p>å¤„ç†æ–¹å¼å’Œä¸Šé¢ç±»ä¼¼.</p><p>è¿™é‡Œæˆ‘ä»¬è‡ªå·±å†™ä¸€ä¸ª com.iyang.mybatis.factory.GavinReflectorFactory æ¥ç»§æ‰¿DefaultReflectorFactory,åœ¨æ— å‚æ•°æ„é€ å‡½æ•°ä¸­æ‰“å°ä¸‹å†…å®¹, ç„¶ådebugè·Ÿè¿›.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">private void reflectorFactoryElement(XNode context) throws Exception &#123;</span><br><span class="line">  if (context != null) &#123;</span><br><span class="line">    String type = context.getStringAttribute(&quot;type&quot;);</span><br><span class="line">    ReflectorFactory factory = (ReflectorFactory) resolveClass(type).getDeclaredConstructor().newInstance();</span><br><span class="line">    configuration.setReflectorFactory(factory);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ ‡ç­¾ä¸ƒ :</strong></p><p>environments æ ‡ç­¾éƒ½æ˜¯æ”¾å…¥ä¸€äº› db çš„é…ç½®ä¿¡æ¯ç­‰.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">&lt;environments default=&quot;development&quot;&gt;</span><br><span class="line">    &lt;environment id=&quot;development&quot;&gt;</span><br><span class="line">        &lt;!-- äº‹åŠ¡ --&gt;</span><br><span class="line">        &lt;transactionManager type=&quot;JDBC&quot;/&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- DB è¿æ¥é…ç½® --&gt;</span><br><span class="line">        &lt;dataSource type=&quot;POOLED&quot;&gt;</span><br><span class="line">            &lt;property name=&quot;driver&quot; value=&quot;$&#123;jdbc.driver&#125;&quot; /&gt;</span><br><span class="line">            &lt;property name=&quot;url&quot; value=&quot;$&#123;jdbc.url&#125;&quot; /&gt;</span><br><span class="line">            &lt;property name=&quot;username&quot; value = &quot;$&#123;jdbc.username&#125;&quot; /&gt;</span><br><span class="line">            &lt;property name=&quot;password&quot; value=&quot;$&#123;jdbc.password&#125;&quot; /&gt;</span><br><span class="line">        &lt;/dataSource&gt;</span><br><span class="line">    &lt;/environment&gt;</span><br><span class="line">&lt;/environments&gt;</span><br><span class="line">private void environmentsElement(XNode context) throws Exception &#123;</span><br><span class="line">  if (context != null) &#123;</span><br><span class="line">    if (environment == null) &#123;</span><br><span class="line">// è·å– default å¯¹åº”å­—æ®µçš„å€¼         </span><br><span class="line">      environment = context.getStringAttribute(&quot;default&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">// è¿™é‡Œçš„ getChildren è·å–çš„æ˜¯ &lt;environments&gt; --&gt; &lt;environment&gt;ä¸‹çš„å­æ ‡ç­¾      </span><br><span class="line">    for (XNode child : context.getChildren()) &#123;</span><br><span class="line">      String id = child.getStringAttribute(&quot;id&quot;);</span><br><span class="line">// ç¡®ä¿ id å’Œ  ä¸Šä¸€æ­¥çš„environment çš„å€¼æ˜¯ç›¸åŒçš„,å°±ä¼šè¿”å›true.      </span><br><span class="line">      if (isSpecifiedEnvironment(id)) &#123;</span><br><span class="line">/**</span><br><span class="line">*  è·å–å‡º transactionManager å¯¹åº”çš„æ ‡ç­¾.</span><br><span class="line">*  ç„¶åæ ¹æ® JBDC(é…ç½®æ–‡ä»¶ä¸­çš„å€¼),ç„¶åä» typeAliasRegistryä¸­è·å–å‡ºæ¥ï¼Œ</span><br><span class="line">*  è°ƒç”¨åå°„æ¥ å®ä¾‹åŒ– è¿™ä¸ªå¯¹è±¡. </span><br><span class="line">*  æœ€åè¿˜æ˜¯å¯ä»¥é…ç½® properties,ä¼šè¢«setåˆ°txFactoryä¸­å»çš„.</span><br><span class="line">*  ä½†æ˜¯ JdbcTransactionFactory å¥½åƒæ²¡æœ‰é‡å†™ setProperties æ–¹æ³•.</span><br><span class="line">*/          </span><br><span class="line">        TransactionFactory txFactory = transactionManagerElement(child.evalNode(&quot;transactionManager&quot;));</span><br><span class="line">// å…ˆè·å–  dataSource å­—æ®µ</span><br><span class="line">/**</span><br><span class="line">*  å…ˆè·å–typeçš„å€¼,ç„¶åå†è·å– propertiesçš„æ ‡ç­¾å­—æ®µå€¼.</span><br><span class="line">*  æ ¹æ®æˆ‘ä»¬çš„é…ç½® : org.apache.ibatis.datasource.pooled.PooledDataSourceFactory,åº”è¯¥ä¼šè·å–å‡ºè¿™ä¸ªå¯¹è±¡.è¯¥å¯¹è±¡å…¶å†…éƒ¨æ˜¯æœ‰ä¸€ä¸ª,org.apache.ibatis.datasource.pooled.PooledDataSourceçš„,é‡Œé¢æœ‰éƒ¨åˆ†é»˜è®¤å€¼çš„.</span><br><span class="line">*æœ€åå°†  properties è°ƒç”¨ org.apache.ibatis.datasource.unpooled.UnpooledDataSourceFactory#setPropertiesæ–¹æ³•,</span><br><span class="line">æœ€åæ˜¯å°† properties é‡Œé¢çš„key/value éƒ½è®¾ç½®åˆ° MetaObject metaDataSource = SystemMetaObject.forObject(dataSource);æ¥äº†.</span><br><span class="line">*/</span><br><span class="line">        DataSourceFactory dsFactory = dataSourceElement(child.evalNode(&quot;dataSource&quot;));</span><br><span class="line">// ä»  PooledDataSourceFactory ä¸­è·å– datasource å±æ€§.         </span><br><span class="line">        DataSource dataSource = dsFactory.getDataSource();</span><br><span class="line">// è¿™é‡Œé‡‡ç”¨é“¾å¼ç¼–ç¨‹,ä¹Ÿå°±æ˜¯å°†id/txFactory/dataSource éƒ½ç»™setåˆ° Environment.Builderæ¥äº†.         </span><br><span class="line">        Environment.Builder environmentBuilder = new Environment.Builder(id)</span><br><span class="line">            .transactionFactory(txFactory)</span><br><span class="line">            .dataSource(dataSource);</span><br><span class="line">  //    environmentBuilder.build() ä¹Ÿå°±æ˜¯new äº†ä¸€ä¸ª Environment </span><br><span class="line">  // æœ€å èµ‹å€¼åˆ° configuration ä¸­æ¥äº†.        </span><br><span class="line">        configuration.setEnvironment(environmentBuilder.build());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è§£æ environments ,åˆ©ç”¨ typeAliasRegistry ä¸­å·²ç»æ³¨å†Œå¥½äº†çš„ä¿¡æ¯,ç„¶åæ ¹æ®åå­—ç¼©å†™(æ¯”å¦‚JDBC)è¿™ç§,æ¥è·å–classå¯¹è±¡, ç”¨ åå°„æ¥ new ä¸€æ³¢å¯¹è±¡å‡ºæ¥,çœŸæ˜¯ç¾æ»‹æ»‹. æ¥ç€å°±æ˜¯è§£æ äº‹åŠ¡&#x2F;JDBCè¿æ¥é…ç½®ä¿¡æ¯ç­‰, æœ€åå°†ä¿¡æ¯ä¿å­˜åˆ° DataSource ä¸­æ¥. åæ‰‹å†æ¥ä¸€æ³¢ é“¾å¼ç¼–ç¨‹ æ¥newå¯¹è±¡å‡ºæ¥, æœ€åå°±æ˜¯ä¸€ä¸ª Environment å¯¹è±¡å‡ºæ¥,ç»™set åˆ° configuration ä¸­æ¥.</p><p><strong>æ ‡ç­¾å…«</strong></p><p>åˆ°è¿™é‡Œ,å¯ä»¥çœ‹åˆ°å¯¹xmlçš„è§£ææ“ä½œ. å…ˆè§£æ æ ‡ç­¾ çš„å€¼å‡ºæ¥,ç„¶åæ ¹æ®å€¼è¿›è¡Œåˆ†ç±»å¤„ç†æˆ–è€…æ ¹æ®è‡ªå·±çš„éœ€æ±‚æ¥è¿›è¡Œå¤„ç†.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">private void typeHandlerElement(XNode parent) &#123;</span><br><span class="line">  if (parent != null) &#123;</span><br><span class="line">    for (XNode child : parent.getChildren()) &#123;</span><br><span class="line">      // å¦‚æœå­æ ‡ç­¾æ˜¯ package   </span><br><span class="line">      if (&quot;package&quot;.equals(child.getName())) &#123;</span><br><span class="line">       // è·å–å‡º name å¯¹åº”çš„å€¼.   </span><br><span class="line">        String typeHandlerPackage = child.getStringAttribute(&quot;name&quot;);</span><br><span class="line">      // æ³¨å†Œåˆ°   typeHandlerRegistry ä¸­æ¥.  </span><br><span class="line">        typeHandlerRegistry.register(typeHandlerPackage);</span><br><span class="line">      &#125; else &#123;</span><br><span class="line"> // è¿™é‡Œè·å–å‡ºä¸‰ç§å€¼æ¥,   javaType/jdbcType/  handler    </span><br><span class="line">        String javaTypeName = child.getStringAttribute(&quot;javaType&quot;);</span><br><span class="line">        String jdbcTypeName = child.getStringAttribute(&quot;jdbcType&quot;);</span><br><span class="line">        String handlerTypeName = child.getStringAttribute(&quot;handler&quot;);</span><br><span class="line">        Class&lt;?&gt; javaTypeClass = resolveClass(javaTypeName);</span><br><span class="line">        JdbcType jdbcType = resolveJdbcType(jdbcTypeName);</span><br><span class="line">        Class&lt;?&gt; typeHandlerClass = resolveClass(handlerTypeName);</span><br><span class="line">  // åˆ†ä¸º  javaTypeClass æ˜¯ä¸æ˜¯ null çš„æƒ…å†µ       </span><br><span class="line">        if (javaTypeClass != null) &#123;</span><br><span class="line">         // åŸºäº javaTypeClass æ˜¯ä¸æ˜¯ nullçš„æƒ…å†µ,å†åˆ¤æ–­ jdbcType æ˜¯ä¸æ˜¯null  </span><br><span class="line">          if (jdbcType == null) &#123;</span><br><span class="line">            typeHandlerRegistry.register(javaTypeClass, typeHandlerClass);</span><br><span class="line">          &#125; else &#123;</span><br><span class="line">            typeHandlerRegistry.register(javaTypeClass, jdbcType, typeHandlerClass);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">// è¿™æ˜¯æ ¹æ®   handlerTypeName æ³¨å†Œåˆ° typeHandlerRegistry ä¸­æ¥.           </span><br><span class="line">          typeHandlerRegistry.register(typeHandlerClass);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ ‡ç­¾ä¹ :</strong></p><p>è¯¥æ ‡ç­¾æ˜¯å¯¹æˆ‘ä»¬å¯¹åº”çš„å¯¹è±¡,å…¶sqlè¯­å¥å­˜æ”¾çš„åœ°å€. ä¹Ÿå°±æ˜¯é‡Œé¢æ”¾å…¥çš„æ˜¯äºmapperæ¥å£å¯¹åº”çš„æ–¹æ³•,æŸ¥è¯¢çš„sqlè¯­å¥.</p><p>æ¥ä¸‹æ¥çœ‹ä¸‹ MyBatis æ˜¯å¯¹ mappers æ ‡ç­¾çš„å†…å®¹è¿›è¡Œäº†è¯´æ˜è§£æå’Œå¤„ç†.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">mapperElement</span><span class="params">(XNode parent)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">  <span class="keyword">if</span> (parent != <span class="literal">null</span>) &#123;</span><br><span class="line">      </span><br><span class="line"> <span class="comment">// getChildren è·å–çš„æ˜¯ mappers ä¸‹çš„ mapper æ ‡ç­¾</span></span><br><span class="line">    <span class="keyword">for</span> (XNode child : parent.getChildren()) &#123;</span><br><span class="line"><span class="comment">// å¦‚æœé…ç½®çš„æ˜¯ package.        </span></span><br><span class="line">      <span class="keyword">if</span> (<span class="string">&quot;package&quot;</span>.equals(child.getName())) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">mapperPackage</span> <span class="operator">=</span> child.getStringAttribute(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">        configuration.addMappers(mapperPackage);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// è·å–å‡º    resource/url/class è¿™ä¸‰ç±»çš„å€¼.       </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">resource</span> <span class="operator">=</span> child.getStringAttribute(<span class="string">&quot;resource&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> child.getStringAttribute(<span class="string">&quot;url&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">mapperClass</span> <span class="operator">=</span> child.getStringAttribute(<span class="string">&quot;class&quot;</span>);</span><br><span class="line"> <span class="comment">// å¯¹ resource å¤„ç†         </span></span><br><span class="line">        <span class="keyword">if</span> (resource != <span class="literal">null</span> &amp;&amp; url == <span class="literal">null</span> &amp;&amp; mapperClass == <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="comment">// å°† resource èµ‹å€¼ç»™ ErrorContext ä¸­  </span></span><br><span class="line">          ErrorContext.instance().resource(resource);</span><br><span class="line">     <span class="comment">// è¯»å–æ–‡ä»¶.       </span></span><br><span class="line">          <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> Resources.getResourceAsStream(resource);</span><br><span class="line"><span class="comment">// ä½¿ç”¨ XMLMapperBuilder æ¥å¯¹è§£æxmlå†…å®¹.            </span></span><br><span class="line">          <span class="type">XMLMapperBuilder</span> <span class="variable">mapperParser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XMLMapperBuilder</span>(inputStream, configuration, resource, configuration.getSqlFragments());</span><br><span class="line">          mapperParser.parse();</span><br><span class="line"><span class="comment">// url å¤„ç†            </span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (resource == <span class="literal">null</span> &amp;&amp; url != <span class="literal">null</span> &amp;&amp; mapperClass == <span class="literal">null</span>) &#123;</span><br><span class="line">          ErrorContext.instance().resource(url);</span><br><span class="line">          <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> Resources.getUrlAsStream(url);</span><br><span class="line">          <span class="type">XMLMapperBuilder</span> <span class="variable">mapperParser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XMLMapperBuilder</span>(inputStream, configuration, url, configuration.getSqlFragments());</span><br><span class="line">          mapperParser.parse();</span><br><span class="line"><span class="comment">// mapperClass å¤„ç†            </span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (resource == <span class="literal">null</span> &amp;&amp; url == <span class="literal">null</span> &amp;&amp; mapperClass != <span class="literal">null</span>) &#123;</span><br><span class="line">          Class&lt;?&gt; mapperInterface = Resources.classForName(mapperClass);</span><br><span class="line">          configuration.addMapper(mapperInterface);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BuilderException</span>(<span class="string">&quot;A mapper element may only specify a url, resource or class, but not more than one.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-----------------------</span><br><span class="line"><span class="comment">// è¿™é‡Œæˆ‘ä»¬è·Ÿè¿› mapperParser.parse() æ–¹æ³•æ¥</span></span><br><span class="line"><span class="comment">// org.apache.ibatis.builder.xml.XMLMapperBuilder</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">parse</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">// åˆ¤æ–­ configuration çš„ loadedResources æ˜¯å¦å«æœ‰è¯¥å€¼,å¦‚æœä¸å«æœ‰çš„è¯,å°±ä¼šå»è§£æ.  </span></span><br><span class="line">    <span class="keyword">if</span> (!configuration.isResourceLoaded(resource)) &#123;</span><br><span class="line"><span class="comment">// å¯¹mapper æ ‡ç­¾è¿›è¡Œè§£æ        </span></span><br><span class="line">      configurationElement(parser.evalNode(<span class="string">&quot;/mapper&quot;</span>));</span><br><span class="line">      configuration.addLoadedResource(resource);</span><br><span class="line">      bindMapperForNamespace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    parsePendingResultMaps();</span><br><span class="line">    parsePendingCacheRefs();</span><br><span class="line">    parsePendingStatements();</span><br><span class="line">  &#125;    </span><br><span class="line"></span><br><span class="line">-----------------------------------</span><br><span class="line"><span class="comment">//   configurationElement æ–¹æ³•</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">configurationElement</span><span class="params">(XNode context)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"> <span class="comment">// è·å– namespace       </span></span><br><span class="line">      <span class="type">String</span> <span class="variable">namespace</span> <span class="operator">=</span> context.getStringAttribute(<span class="string">&quot;namespace&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> (namespace == <span class="literal">null</span> || namespace.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BuilderException</span>(<span class="string">&quot;Mapper&#x27;s namespace cannot be empty&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line"><span class="comment">//  MapperBuilderAssistant å°† namespace ç»‘å®šåˆ°è¯¥ç±»çš„å‚æ•°ä¸­æ¥.        </span></span><br><span class="line">      builderAssistant.setCurrentNamespace(namespace);</span><br><span class="line">  </span><br><span class="line">   <span class="comment">// è¿™é‡Œçš„ cache-ref / cache éƒ½æ˜¯æš‚æ—¶æ²¡æœ‰é…ç½®çš„.     </span></span><br><span class="line">      cacheRefElement(context.evalNode(<span class="string">&quot;cache-ref&quot;</span>));</span><br><span class="line">      cacheElement(context.evalNode(<span class="string">&quot;cache&quot;</span>));</span><br><span class="line">        </span><br><span class="line"> <span class="comment">//  /mapper/parameterMap ä¹Ÿæ˜¯æš‚æ—¶æ²¡æœ‰é…ç½®çš„  </span></span><br><span class="line">      parameterMapElement(context.evalNodes(<span class="string">&quot;/mapper/parameterMap&quot;</span>));</span><br><span class="line">        </span><br><span class="line"><span class="comment">// resultMap æ˜¯å¯¹å¯¹è±¡å­—æ®µçš„æ˜ å°„</span></span><br><span class="line"><span class="comment">// mapper/sql æ˜¯å¯¹ä¸€äº›å…¬ç”¨çš„sqlè¿›è¡ŒæŠ½å–</span></span><br><span class="line"><span class="comment">// äºŒè€…æš‚æ—¶éƒ½æ²¡æœ‰é…ç½®        </span></span><br><span class="line">      resultMapElements(context.evalNodes(<span class="string">&quot;/mapper/resultMap&quot;</span>));</span><br><span class="line">      sqlElement(context.evalNodes(<span class="string">&quot;/mapper/sql&quot;</span>));</span><br><span class="line"><span class="comment">// è·å– select / insert / update / delete ç­‰ æ ‡ç­¾.        </span></span><br><span class="line">      buildStatementFromContext(context.evalNodes(<span class="string">&quot;select|insert|update|delete&quot;</span>));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BuilderException</span>(<span class="string">&quot;Error parsing Mapper XML. The XML location is &#x27;&quot;</span> + resource + <span class="string">&quot;&#x27;. Cause: &quot;</span> + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;    </span><br><span class="line"></span><br><span class="line"><span class="comment">// å¾€ä¸‹è·Ÿæ–¹æ³•</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">buildStatementFromContext</span><span class="params">(List&lt;XNode&gt; list, String requiredDatabaseId)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (XNode context : list) &#123;</span><br><span class="line">      <span class="keyword">final</span> <span class="type">XMLStatementBuilder</span> <span class="variable">statementParser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XMLStatementBuilder</span>(configuration, builderAssistant, context, requiredDatabaseId);</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        statementParser.parseStatementNode();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IncompleteElementException e) &#123;</span><br><span class="line">        configuration.addIncompleteStatement(statementParser);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://ruy9527.github.io/2021/11/04/spring/SpringBoot%E5%8A%A8%E6%80%81%E6%B7%BB%E5%8A%A0%E6%8E%A5%E5%8F%A3/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/touxiang.jpg"><meta itemprop="name" content="YangBao"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="YangBao"><meta itemprop="description" content="çŸ¥è¯†ç¬”è®°"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | YangBao"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2021/11/04/spring/SpringBoot%E5%8A%A8%E6%80%81%E6%B7%BB%E5%8A%A0%E6%8E%A5%E5%8F%A3/" class="post-title-link" itemprop="url">SpringBootåŠ¨æ€æ·»åŠ æ¥å£</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Created: 2021-11-04 00:17:24" itemprop="dateCreated datePublished" datetime="2021-11-04T00:17:24+08:00">2021-11-04</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">Edited on</span> <time title="Modified: 2022-11-04 21:46:13" itemprop="dateModified" datetime="2022-11-04T21:46:13+08:00">2022-11-04</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a> </span>, <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/java/springBoot/" itemprop="url" rel="index"><span itemprop="name">springBoot</span></a> </span></span><span class="post-meta-break"></span> <span class="post-meta-item" title="Symbols count in article"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">Symbols count in article: </span><span>6.4k</span> </span><span class="post-meta-item" title="Reading time"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">Reading time &asymp;</span> <span>6 mins.</span></span></div></div></header><div class="post-body" itemprop="articleBody"><h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><p>æœ€è¿‘çœ‹äº†å…¬å¸çš„äº§å“,æœ‰ä¸€ä¸ªè¿™æ ·çš„åŠ¨æ€,å°±æ˜¯æ ¹æ®inputè¾“å…¥çš„å†…å®¹,è¿›è¡ŒåŠ¨æ€æ¥å£çš„æ·»åŠ .</p><p>æ¯”å¦‚ æˆ‘åœ¨æ²¡æœ‰æ·»åŠ ä¹‹å‰,è®¿é—® <a target="_blank" rel="noopener" href="http://localhost:8080/test">http://localhost:8080/test</a> è¯¥åœ°å€æ˜¯404, äºæ˜¯é€šè¿‡inputçš„è¾“å…¥åˆ›å»º,å°±ç›¸å½“äºåŠ¨æ€æ·»åŠ äº†ä¸€ä¸ªæ¥å£,äºæ˜¯å°±å¯ä»¥è®¿é—®äº†.</p><p>å®ç°çš„æ–¹å¼æœ‰å¾ˆå¤šç§, å…·ä½“çš„æƒ³è¦çš„æ•ˆæœè‚¯å®šæ˜¯éœ€è¦æ ¹æ®è‡ªå·±çš„ä¸šåŠ¡è§’åº¦æ¥.</p><h2 id="å®ç°æ€è·¯"><a href="#å®ç°æ€è·¯" class="headerlink" title="å®ç°æ€è·¯"></a>å®ç°æ€è·¯</h2><p>è¿™é‡Œæ˜¯è¯´ä¸‹ä¸ªäººçš„å®ç°æ€è·¯ :</p><ul><li>æ–¹æ¡ˆä¸€ : å…ˆå®šä¹‰å¥½ç±»,ç„¶åä½¿ç”¨åå°„æ ¹æ®å®šä¹‰çš„ç±»,åˆ›å»ºå¥½ä¸€ä¸ªå¯¹è±¡å‡ºæ¥,ç„¶åå°†è¿™ä¸ªå¯¹è±¡ç»™æ³¨å…¥åˆ°Springå®¹å™¨ä¸­æ¥,è¿™é‡Œä¸ä»…ä»…æ˜¯æ³¨å…¥è¿›æ¥è¿™ä¹ˆç®€å•,è¿˜æ˜¯éœ€è¦ç»è¿‡ MVC(ä¹Ÿå°±æ˜¯Controllerç­‰æ³¨è§£çš„åŒ¹é…æ“ä½œ)æ¥å®ç°</li><li>æ–¹æ¡ˆäºŒ : åŸºäºè¯·æ±‚404çš„æ‹¦æˆªæ¥ç°å®. æ¯”å¦‚ä½ æ–°æ·»åŠ çš„æ¥å£è®¿é—®è‚¯å®šæ˜¯404,äºæ˜¯æˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªæ‹¦æˆª,ç„¶åè·å–å‡ºè¯·æ±‚çš„è·¯å¾„,æ ¹æ®æå‰å®šå¥½çš„ä¸€äº›è®¾ç½®,è¿›è¡Œé€»è¾‘çš„å¤„ç†.</li></ul><p>è¿™é‡Œè‚¯å®šè¿˜ä¼šæœ‰å¾ˆå¤šå¥½çš„å®ç°æ€è·¯,å¹¶ä¸”åŸºäºæ¯ä¸ªæ¡†æ¶éƒ½æ˜¯ä¸ä¸€æ ·çš„,è¿™é‡Œæ›´å¤šçš„æ˜¯åŸºäº SpringBootæ¡†æ¶æ¥å®ç°è¿™ä¸ªæ€è·¯çš„.</p><h2 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h2><h3 id="åŸºäºåå°„åˆ›å»ºbeanæ³¨å…¥ä»£ç å®ç°"><a href="#åŸºäºåå°„åˆ›å»ºbeanæ³¨å…¥ä»£ç å®ç°" class="headerlink" title="åŸºäºåå°„åˆ›å»ºbeanæ³¨å…¥ä»£ç å®ç°"></a>åŸºäºåå°„åˆ›å»ºbeanæ³¨å…¥ä»£ç å®ç°</h3><p>å®šä¹‰ä¸€ä¸ªç±»çš„æ¨¡æ¿</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">String</span> <span class="variable">templateValue</span> <span class="operator">=</span> <span class="string">&quot;import org.springframework.web.bind.annotation.GetMapping;\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;import org.springframework.web.bind.annotation.RequestMapping;\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;import org.springframework.web.bind.annotation.RestController;\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;@RestController\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;@RequestMapping(\&quot;/test\&quot;)\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;public class TestController &#123;\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;    @GetMapping(\&quot;/test\&quot;)\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;    public String test()&#123;\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;        return \&quot;æµ‹è¯•Testæ¥å£\&quot;;\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;    &#125;\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;&#125;&quot;</span>;</span><br></pre></td></tr></table></figure><p>æä¾›ä¸€ä¸ªæ¥å£æ¥åå°„åˆ›å»ºå¯¹è±¡å¹¶ä¸”æ³¨å…¥åˆ°springå®¹å™¨ä¸­æ¥:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/create&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createTemplate</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        Map&lt;String, <span class="type">byte</span>[]&gt; bytecode = DynamicLoader.compile(<span class="string">&quot;TestController.java&quot;</span>, templateValue);</span><br><span class="line">        <span class="type">MemoryClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MemoryClassLoader</span>(bytecode);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> classLoader.loadClass(<span class="string">&quot;TestController&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> clazz.newInstance();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ³¨å…¥ bean å®¹å™¨çš„ä»£ç  : å®¹å™¨ä¸­æ˜¯å­˜åœ¨è¿™ä¸ª bean å¯¹è±¡çš„,ä½†æ˜¯Controllerå´æ²¡æœ‰è®¿é—®åˆ°.</span></span><br><span class="line">        <span class="type">BeanDefinitionBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> BeanDefinitionBuilder.genericBeanDefinition(object.getClass());</span><br><span class="line">        <span class="type">ConfigurableApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> springUtils.getContext();</span><br><span class="line">        <span class="type">DefaultListableBeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> (DefaultListableBeanFactory) context.getBeanFactory();</span><br><span class="line">        beanFactory.registerBeanDefinition(<span class="string">&quot;testController&quot;</span>,builder.getBeanDefinition());</span><br><span class="line"></span><br><span class="line">        <span class="type">RequestMappingHandlerMapping</span> <span class="variable">mappingHandlerMapping</span> <span class="operator">=</span> context.getBean(RequestMappingHandlerMapping.class);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">oj</span> <span class="operator">=</span> context.getBean(<span class="string">&quot;testController&quot;</span>);</span><br><span class="line">        Map&lt;Method, RequestMappingInfo&gt; methods = MethodIntrospector.selectMethods(oj.getClass(),(MethodIntrospector.MetadataLookup&lt;RequestMappingInfo&gt;) method -&gt;&#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                <span class="type">RequestMapping</span> <span class="variable">requestMapping</span> <span class="operator">=</span> AnnotatedElementUtils.findMergedAnnotation(method, RequestMapping.class);</span><br><span class="line">                RequestMappingInfo.<span class="type">Builder</span> <span class="variable">mappping</span> <span class="operator">=</span> RequestMappingInfo.paths(requestMapping.path())</span><br><span class="line">                                  .methods(requestMapping.method())</span><br><span class="line">                                  .params(requestMapping.params())</span><br><span class="line">                                  .headers(requestMapping.headers())</span><br><span class="line">                                  .consumes(requestMapping.consumes())</span><br><span class="line">                                  .produces(requestMapping.produces())</span><br><span class="line">                                  .mappingName(requestMapping.name());</span><br><span class="line">                <span class="keyword">return</span> mappping.build();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">Method</span> <span class="variable">rmhmMethod</span> <span class="operator">=</span> mappingHandlerMapping.getClass()</span><br><span class="line">                            .getDeclaredMethod(<span class="string">&quot;registerHandlerMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Method.class, Object.class&#125;);</span><br><span class="line"></span><br><span class="line">        rmhmMethod.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        methods.forEach((method,mapping) -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                rmhmMethod.invoke(mappingHandlerMapping,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;oj,method,mapping&#125; );</span><br><span class="line">            &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>Springå·¥å…·ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringUtils</span> <span class="keyword">implements</span> <span class="title class_">ApplicationContextAware</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ApplicationContext context;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        context = applicationContext;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ConfigurableApplicationContext <span class="title function_">getContext</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (ConfigurableApplicationContext)context;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setContext</span><span class="params">(ApplicationContext context)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.context = context;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ°æ­¤,å°±å¯ä»¥åŠ¨æ€çš„åˆ›å»ºå‡ºä¸€ä¸ªæ¥å£æ¥äº†ã€‚</p><p>å½“ç„¶äº†,è¿™é‡Œçš„ä»£ç éƒ½æ˜¯å†™å›ºå®šåœ¨ä»£ç é‡Œé¢çš„,å¯ä»¥æä¾› template æˆ–è€… é€šè¿‡é¡µé¢å®šä¹‰ç»™æ·»åŠ è¿›æ¥, ç„¶åè°ƒç”¨ åå°„&#x2F;æ³¨å…¥åˆ°Springå®¹å™¨ä¸­ç­‰æ“ä½œå³å¯.</p><h3 id="åŸºäº-404-æ‹¦æˆªè¯·æ±‚"><a href="#åŸºäº-404-æ‹¦æˆªè¯·æ±‚" class="headerlink" title="åŸºäº 404 æ‹¦æˆªè¯·æ±‚"></a>åŸºäº 404 æ‹¦æˆªè¯·æ±‚</h3><p>è¿™æ˜¯ SpringBoot æœ¬æ¥å°±æœ‰çš„ 404 æ‹¦æˆªå®ç°, å¦‚æœä¸åšä»€ä¹ˆå¤„ç†çš„è¯,é‚£ä¹ˆè¿›å…¥åˆ°è¿™é‡Œæ¥çš„urlåœ°å€å°±ä¼šæ˜¯&#x2F;error,æ˜¯æ— æ³•æ»¡è¶³å®ç°çš„.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SelfErrorController</span> <span class="keyword">implements</span> <span class="title class_">ErrorController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">ERROR_PATH</span> <span class="operator">=</span> <span class="string">&quot;/error&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Supports the HTML Error View</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(value = ERROR_PATH)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">errorHtml</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">statusCode</span> <span class="operator">=</span> (Integer) request.getAttribute(<span class="string">&quot;javax.servlet.error.status_code&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">requestURI</span> <span class="operator">=</span> request.getRequestURI();</span><br><span class="line">        log.info(<span class="string">&quot;åœ¨SelfErrorControllerä¸­è¯·æ±‚çš„è·¯å¾„ : &#123;&#125; &quot;</span> ,requestURI);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ‹¿åˆ°è·¯å¾„åå°±å¯ä»¥æ‰§è¡Œç›¸åº”çš„ä»£ç é€»è¾‘.</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">realUrlName</span> <span class="operator">=</span> request.getAttribute(<span class="string">&quot;realName&quot;</span>).toString();</span><br><span class="line">        log.info(<span class="string">&quot;åœ¨SelfErrorControllerä¸­çœŸå®å­˜åœ¨çš„è¯·æ±‚è·¯å¾„æ˜¯ : --&gt; &#123;&#125; &quot;</span> , realUrlName);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(statusCode == <span class="number">401</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span>  <span class="string">&quot;&#123; \&quot;code\&quot;: \&quot;401\&quot;&#125;&quot;</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(statusCode == <span class="number">404</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&#123; \&quot;code\&quot;: \&quot;404\&quot;&#125;&quot;</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(statusCode == <span class="number">403</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&#123; \&quot;code\&quot;: \&quot;403\&quot;&#125;&quot;</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&#123; \&quot;code\&quot;: \&quot;500\&quot;&#125;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getErrorPath</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› ä¸ºä¸Šé¢æ— æ³•æ»¡è¶³çš„å‰æä¸‹,æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ‹¦æˆªæ¥é…ç½®åŸæ¥çš„è·¯å¾„.</p><p>é…ç½®ç±»:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyWebAppConfigurer</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;</span><br><span class="line">        registry.addInterceptor(<span class="keyword">new</span> <span class="title class_">SelfInterceptor</span>()).addPathPatterns(<span class="string">&quot;/**&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è‡ªå®šä¹‰æ‹¦æˆªå™¨:</p><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°å°†åŸæœ‰çš„è·¯å¾„ç»™setå­—æ®µrealNameäº†.</p><p>æ‰€ä»¥åœ¨ä¸Šé¢çš„erroræ¥å£,æˆ‘ä»¬è°ƒç”¨è¿™ä¸ªrealNameå­—æ®µå°±å¯ä»¥è·å–åˆ°äº†åŸæœ‰çš„è·¯å¾„.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SelfInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span><br><span class="line"><span class="params">                             Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// å‰ç½®æ‹¦æˆªå™¨</span></span><br><span class="line">        log.info(<span class="string">&quot;å‰ç½®æ‹¦æˆªå™¨è°ƒç”¨ : com.iyang.hello.boot.config.SelfInterceptor.preHandle ä¸­æ¥.&quot;</span> );</span><br><span class="line">        <span class="type">String</span> <span class="variable">requestURI</span> <span class="operator">=</span> request.getRequestURI();</span><br><span class="line">        log.info(<span class="string">&quot;åœ¨preHandleæ–¹æ³•ä¸­æ•æ‰åˆ°çš„è¯·æ±‚è·¯å¾„ : ---&gt; &#123;&#125; &quot;</span> , requestURI);</span><br><span class="line">        <span class="comment">// handler æ˜¯ ResourceHttpRequestHandler</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span><br><span class="line"><span class="params">                           Object handler, ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">requestURI</span> <span class="operator">=</span> request.getRequestURI();</span><br><span class="line">        request.setAttribute(<span class="string">&quot;realName&quot;</span>,requestURI);</span><br><span class="line">        <span class="keyword">if</span>(response.getStatus() == <span class="number">404</span>)&#123;</span><br><span class="line">            log.info(<span class="string">&quot;çŠ¶æ€æ˜¯404æ­£å¸¸æ“ä½œ&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">&quot;è¯·æ±‚çš„urlè·¯å¾„æ˜¯ ---&gt; &#123;&#125; &quot;</span> , requestURI);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span><br><span class="line"><span class="params">                                Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è¯¥æŠ€èƒ½çœ‹åˆ°æ¯”è¾ƒæœ‰æ„æ€,å…·ä½“çš„å®ç°å’Œè®¾è®¡æ€è·¯å…¶å®æ˜¯æœ‰å¾ˆå¤šç§çš„,å…·ä½“å¾—çœ‹é¡¹ç›®çš„ä¸šåŠ¡æ˜¯ä¸æ˜¯éœ€è¦ä½¿ç”¨.</p><p>å¹¶ä¸”å®ç°çš„æ€è·¯å¹¶ä¸æ˜¯åªæœ‰è¿™ä¸€ç§,è‚¯å®šæ˜¯è¿˜æœ‰å¾ˆå¤šç§çš„.</p><p>é€‚åˆè‡ªå·±çš„ä¸šåŠ¡æ˜¯æœ€å¥½çš„.</p></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><nav class="pagination"><span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a></nav></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2022</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">YangBao</span></div><div class="wordcount"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i> </span><span>Symbols count total: </span><span title="Symbols count total">307k</span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span>Reading time total &asymp;</span> <span title="Reading time total">4:39</span></span></div><div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a></div></div></footer><script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script></body></html>